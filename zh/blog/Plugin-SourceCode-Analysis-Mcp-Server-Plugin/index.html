<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">McpServer 插件源码分析 | Apache ShenYu</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://shenyu.apache.org/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="McpServer 插件源码分析 | Apache ShenYu"><meta data-rh="true" name="description" content="在 shenyu 网关中，启动该插件，shenyu 将成为一个功能丰富的 mcpServer,"><meta data-rh="true" property="og:description" content="在 shenyu 网关中，启动该插件，shenyu 将成为一个功能丰富的 mcpServer,"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2026-01-20T02:32:33.000Z"><meta data-rh="true" property="article:author" content="https://github.com/478320"><meta data-rh="true" property="article:tag" content="plugin,mcp,Apache ShenYu"><link data-rh="true" rel="icon" href="/zh/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://shenyu.apache.org/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"><link data-rh="true" rel="alternate" href="https://shenyu.apache.org/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" hreflang="en"><link data-rh="true" rel="alternate" href="https://shenyu.apache.org/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" hreflang="zh"><link data-rh="true" rel="alternate" href="https://shenyu.apache.org/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://shenyu.apache.org/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin","mainEntityOfPage":"https://shenyu.apache.org/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin","url":"https://shenyu.apache.org/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin","headline":"McpServer 插件源码分析","name":"McpServer 插件源码分析","description":"在 shenyu 网关中，启动该插件，shenyu 将成为一个功能丰富的 mcpServer,","datePublished":"2026-01-20T02:32:33.000Z","author":{"@type":"Person","name":"yusiheng","description":"Apache ShenYu Contributor","url":"https://github.com/478320"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://shenyu.apache.org/zh/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Atom Feed">












<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Atom Feed">

<script src="/js/error-suppression.js"></script><link rel="stylesheet" href="/zh/assets/css/styles.5a6c781d.css">
<script src="/zh/assets/js/runtime~main.3bc2ec09.js" defer="defer"></script>
<script src="/zh/assets/js/main.ff52b9dc.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">下载</a><a class="navbar__item navbar__link" href="/zh/document">文档</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">社区</a><a class="navbar__item navbar__link" href="/zh/team">团队</a><a class="navbar__item navbar__link" href="/zh/event">事件</a><a class="navbar__item navbar__link" href="/zh/news">新闻</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a><a class="navbar__item navbar__link" href="/zh/users">用户</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">基金会</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">许可</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">活动</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">安全</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">赞助</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">隐私</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">致谢</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">简体中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class=""><header><h1 class="title_f1Hy">McpServer 插件源码分析</h1><div class="container_mt6G margin-vert--md"><time datetime="2026-01-20T02:32:33.000Z">2026年1月20日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/478320" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp" translate="no">yusiheng</span></a></div><small class="authorTitle_nd0D" title="Apache ShenYu Contributor">Apache ShenYu Contributor</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>在 shenyu 网关中，启动该插件，shenyu 将成为一个功能丰富的 mcpServer,
你可以通过简单配置来将一个服务作为 tool 注册到 shenyu 网关中，并使用网关提供的扩展功能。</p>
<blockquote>
<p>本文基于<code>shenyu-2.7.0.2</code>版本进行源码分析， 在本篇中我将追踪 Shenyu Mcp 插件链路，对 Mcp 插件的 sse 通信方式进行源码分析</p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="前言">前言<a href="#前言" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h3>
<blockquote>
<p>shenyu 网关的 mcp 插件基于 spring-ai-mcp 扩展而来，为了更好的了解 mcp 插件的工作原理
，我将简单介绍 mcp 官方提供的 jdk 中各个 java 类是如何协同运作的</p>
</blockquote>
<p>我想先简单介绍三个 Mcp 官方提供的 java 类</p>
<blockquote>
<ol>
<li class=""><code>McpServer</code></li>
</ol>
<p>该类负责管理，tool，Resource，promote 等资源</p>
<ol start="2">
<li class=""><code>TransportProvider</code></li>
</ol>
<p>根据客户端和服务端之间通信协议，提供之相对应的通讯方法</p>
<ol start="3">
<li class=""><code>Session</code></li>
</ol>
<p>处理请求数据、响应数据和通知数据，提供一些基本方法和其对应的处理器，查询工具，调用工具都在此处执行</p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-服务注册">1. 服务注册<a href="#1-服务注册" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h3>
<p>在 shenyu admin 的 McpServer 中插件填写 endpoint 和 tool 信息后，这些信息将自动注册到 shenyu bootstrap 中，
数据同步源码可以参考官网<a href="https://shenyu.incubator.apache.org/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync" target="_blank" rel="noopener noreferrer" class="">websocket数据同步</a></p>
<p>shenyu bootstrap 将在 <code>McpServerPluginDataHandler</code> 的 <code>handler()</code> 方法中接收到 admin 同步来的数据。</p>
<p><code>handlerSelector()</code> 方法接收 url 数据创建 McpServer</p>
<p><code>handlerRule()</code> 方法接收 tool 信息，注册 tool</p>
<p>这两个方法共同组成了 Shenyu Mcp 插件的服务注册部分，下面我将对这个两个方法，详细展开分析</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="11-transportmcpserver注册">1.1 Transport，McpServer注册<a href="#11-transportmcpserver注册" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h4>
<p>我们先来分析 <code>handlerSelector()</code> 方法，也就是 McpServer 的注册</p>
<ul>
<li class=""><code>handlerSelector()</code> 方法 工作内容如下</li>
</ul>
<ol>
<li class="">捕捉用户在 Selector 上的填写的 url，这个 url 将作为一个 key 存储 McpServer TransportProvider 等信息</li>
<li class="">序列化创建 <code>ShenyuMcpServer</code>，<code>ShenyuMcpServer</code> 将 SelectorId 和这些 url 也就是这些 key 绑定，以此来实现 selectorId 和 key 的绑定。</li>
</ol>
<blockquote>
<p>注意 <code>ShenyuMcpServer</code> 是 Shenyu 用于绑定 SelectorId 和 url 的对象，和 <code>McpServer</code> 没有继承关系，功能也完全不同</p>
</blockquote>
<ol start="3">
<li class="">调用 <code>ShenyuMcpServerManager</code> 的 <code>getOrCreateMcpServerTransport()</code> 方法注册 McpServer TransportProvider</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">McpServerPluginDataHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">PluginDataHandler</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handlerSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">SelectorData</span><span class="token plain"> selectorData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取URI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> selectorData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConditionList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Constants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">URI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getParamType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ConditionData</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getParamValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findFirst</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">orElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 构建McpServer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ShenyuMcpServer</span><span class="token plain"> shenyuMcpServer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">GsonUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromJson</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Objects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">selectorData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DEFAULT_MESSAGE_ENDPOINT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> selectorData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ShenyuMcpServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuMcpServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 缓存shenyuMcpServer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">CACHED_SERVER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cachedHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shenyuMcpServer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> messageEndpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shenyuMcpServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessageEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 尝试获取或者注册transportProvider</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuMcpServerManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getOrCreateMcpServerTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageEndpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<blockquote>
<p><code>ShenyuMcpServerManager</code> 该类是 ShenYu 中 McpServer 的管理中心，不仅储存了 <code>McpAsyncServer</code> <code>CompositeTransportProvider</code> 等内容，注册 Transport 和 McpServer
的方法也在其中</p>
</blockquote>
<ul>
<li class=""><code>getOrCreateMcpServerTransport()</code> 方法工作内容具体如下</li>
</ul>
<ol>
<li class="">处理传递来的 url 去除/streamablehttp 以及 /message后缀 使其恢复为原始的 url</li>
<li class="">尝试获取 <code>CompositeTransportProvider</code> 对象，该对象是 Transport 的复合对象，包含了多种协议对应的 Transport</li>
<li class="">如果没有获取到，则调用 <code>createSseTransport()</code> 方法创建 <code>CompositeTransportProvider</code> 对象</li>
<li class="">创建 <code>McpAsyncServer</code> 对象，保存 Transport 对象到 Map 中，将 Transport 注册到 <code>McpAsyncServer</code> 中</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShenyuMcpServerManager</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOrCreateMcpServerTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> messageEndPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 去除/streamablehttp 以及 /message后缀</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> normalizedPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOrCreateTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SSE_PROTOCOL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createSseTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageEndPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOrCreateTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> protocol</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name namespace" style="opacity:0.7">java</span><span class="token class-name namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token class-name namespace" style="opacity:0.7">util</span><span class="token class-name namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token class-name namespace" style="opacity:0.7">function</span><span class="token class-name namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token class-name">Supplier</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> transportFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取复合Transport实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CompositeTransportProvider</span><span class="token plain"> compositeTransport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOrCreateCompositeTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">T</span><span class="token plain"> transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SSE_PROTOCOL</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> compositeTransport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSseTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">STREAMABLE_HTTP_PROTOCOL</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> compositeTransport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStreamableHttpTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 如果缓存中没有该实例，则需要重新创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Objects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 调用createSseTransport()方法，创建一个新的transport并存储</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> transportFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 创建McpAsyncServer，并注册transport</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">addTransportToSharedServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> protocol</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transport</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="111-transport注册">1.1.1 Transport注册<a href="#111-transport注册" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h5>
<ul>
<li class=""><code>createSseTransport()</code> 方法</li>
</ul>
<blockquote>
<p>该方法在 <code>getOrCreateMcpServerTransport()</code> 方法被调用，用于创建 Transport</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShenyuMcpServerManager</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createSseTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> messageEndPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> messageEndpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> normalizedPath </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> messageEndPoint</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> transportProvider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">objectMapper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objectMapper</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sseEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">messageEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">messageEndpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 向Manager的routeMap中注册transportProvider的两个函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">registerRoutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageEndpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transportProvider</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">handleSseConnection</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transportProvider</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">handleMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="112-mcpserver注册">1.1.2 mcpServer注册<a href="#112-mcpserver注册" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h5>
<ul>
<li class=""><code>addTransportToSharedServer()</code> 方法</li>
</ul>
<blockquote>
<p>该方法在 <code>getOrCreateMcpServerTransport()</code> 方法被调用，用于创建 McpServer 并保存</p>
</blockquote>
<p>该方法创建了一个新的 McpServer并存储到 <code>sharedServerMap</code> 中，并将上一步得到的 TransportProvider 存入 <code>compositeTransportMap</code> 中</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShenyuMcpServerManager</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addTransportToSharedServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> protocol</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取或者创建并注册 McpServer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">getOrCreateSharedServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 将新增的传输协议存进compositeTransportMap中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        compositeTransport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">McpAsyncServer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOrCreateSharedServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> normalizedPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sharedServerMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 获取传输协议</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">CompositeTransportProvider</span><span class="token plain"> compositeTransport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOrCreateCompositeTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 选择Server拥有的能力</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> capabilities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">McpSchema</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">ServerCapabilities</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">tools</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">logging</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 创建McpServer并存储</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">McpAsyncServer</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">McpServer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compositeTransport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">serverInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;MCP Shenyu Server (Multi-Protocol)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1.0.0&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">capabilities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">capabilities</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">tools</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Lists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newArrayList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="12-tools注册">1.2 Tools注册<a href="#12-tools注册" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h4>
<ul>
<li class=""><code>handlerRule()</code> 方法 工作内容如下</li>
</ul>
<ol>
<li class="">捕捉用户在 Tool 上的填写的 tool 配置信息，这些信息 将全部用于 tool 的构建</li>
<li class="">序列化创建 <code>ShenyuMcpServerTool</code> 获取 tool 信息</li>
</ol>
<blockquote>
<p>注意 <code>ShenyuMcpServerTool</code> 也是 Shenyu 存储 tool 信息的工具，和 <code>McpServerTool</code> 没有继承关系</p>
</blockquote>
<ol start="3">
<li class="">调用 <code>addTool()</code> 方法， 利用该 tool 信息创建 tool，并根据 SelectorId 将 tool 注册到与之匹配的 McpServer 中</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">McpServerPluginDataHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">PluginDataHandler</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handlerRule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">RuleData</span><span class="token plain"> ruleData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Optional</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofNullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ruleData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ifPresent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 序列化一个新的 ShenyuMcpServerTool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ShenyuMcpServerTool</span><span class="token plain"> mcpServerTool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">GsonUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fromJson</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ShenyuMcpServerTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 缓存mcpServerTool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">CACHED_TOOL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cachedHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">CacheKeyUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INST</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ruleData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mcpServerTool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 获取并构建 mcp schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">McpServerToolParameter</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> parameters </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mcpServerTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getParameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">String</span><span class="token plain"> inputSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">JsonSchemaUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createParameterSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ShenyuMcpServer</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CACHED_SERVER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">obtainHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ruleData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSelectorId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Objects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nonNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 向Manager的sharedServerMap中存储Tool信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shenyuMcpServerManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addTool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">StringUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isBlank</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mcpServerTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> ruleData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> mcpServerTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mcpServerTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDescription</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mcpServerTool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRequestConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>addTool()</code>方法</li>
</ul>
<blockquote>
<p>该方法被 <code>handlerRule()</code> 方法调用，用于新增工具</p>
</blockquote>
<p>该方法做了下述工作</p>
<ol>
<li class="">将上一步传来的 tool 信息转换为 <code>shenyuToolDefinition</code> 对象</li>
<li class="">利用转换来的 <code>shenyuToolDefinition</code> 对象创建 <code>ShenyuToolCallback</code> 对象</li>
</ol>
<blockquote>
<p><code>ShenyuToolCallback</code> 重写了 <code>ToolCallBack</code> 的 <code>call()</code> 方法，并将该 <code>call()</code> 方法注册到了 <code>AsyncToolSpecification</code> 中，
此后调用 tool 的 <code>call()</code> 方法，则实际会调用这个重写的 <code>call()</code> 方法</p>
</blockquote>
<ol start="3">
<li class="">将 <code>ShenyuToolCallback</code> 转换为 <code>AsyncToolSpecification</code> 并注册到相关的 mcpServer 中</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">McpServerPluginDataHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">PluginDataHandler</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addTool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> serverPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> description</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> requestTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> inputSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> normalizedPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeServerPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serverPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 构建Definition对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ToolDefinition</span><span class="token plain"> shenyuToolDefinition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ShenyuToolDefinition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">description</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">requestConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestTemplate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">inputSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inputSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ShenyuToolCallback</span><span class="token plain"> shenyuToolCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ShenyuToolCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shenyuToolDefinition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取到先前注册的 McpServer， 并向其中注册Tool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">McpAsyncServer</span><span class="token plain"> sharedServer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sharedServerMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">normalizedPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">AsyncToolSpecification</span><span class="token plain"> asyncToolSpecification </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">McpToolUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toAsyncToolSpecifications</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shenyuToolCallback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sharedServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addTool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">asyncToolSpecification</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>到此为止，服务注册分析完毕</p>
<p>服务注册一图览
<img decoding="async" loading="lazy" src="/zh/assets/images/Mcp-server-register-zh-87a3e3bf2133de216e36e9609dcd5aad.png" width="1607" height="595" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-插件调用">2. 插件调用<a href="#2-插件调用" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h3>
<p>客户端先后会发送后缀为 <code>/sse</code> 和 <code>/message</code> 的两种消息，这两种消息都会被 <code>Shenyu McpServer plugin</code> 捕捉，<code>Shenyu McpServer plugin</code>
会对 <code>/sse</code> 消息和 <code>/message</code> 消息做不同处理。收到 <code>/sse</code> 消息时 plugin 会创建 session 对象并保存，最后返回 session id
供 message 消息使用。收到 <code>/message</code> 消息时，会根据 <code>/message</code> 消息携带的 method 信息，选择执行的方法
如：获取工作列表，工具调用，获取资源列表等等</p>
<ul>
<li class=""><code>doExecute()</code> 方法 工作内容如下</li>
</ul>
<ol>
<li class="">路径匹配，判断 mcp plugin 是否注册该路径</li>
<li class="">调用 <code>routeByProtocol()</code> 方法，根据请求协议选择合适的处理方案</li>
</ol>
<blockquote>
<p>本篇是对 sse 请求方式  的解析，因此接着进入 <code>handleSseRequest()</code> 方法</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">McpServerPlugin</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">AbstractShenyuPlugin</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Mono</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doExecute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShenyuPluginChain</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">SelectorData</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">RuleData</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getURI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRawPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 判断 Mcp 插件是否注册了该路由规则，没有则不执行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">shenyuMcpServerManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">canRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageReaders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 根据 uri 判断路由协议，选择对应的处理方案</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">routeByProtocol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Mono</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">routeByProtocol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShenyuPluginChain</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">SelectorData</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isStreamableHttpProtocol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleStreamableHttpRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isSseProtocol</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 处理sse请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleSseRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>handlerSseRequest()</code> 方法</p>
<blockquote>
<p>该方法由 <code>routeByProtocol()</code> 方法调用，根据请求后缀判断客户端是要创建 session 还是调用工具</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">McpServerPlugin</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">AbstractShenyuPlugin</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Mono</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleSseRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShenyuPluginChain</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">SelectorData</span><span class="token plain"> selector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ShenyuMcpServer</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">McpServerPluginDataHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">CACHED_SERVER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">obtainHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">selector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> messageEndpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessageEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取传输者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> transportProvider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shenyuMcpServerManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getOrCreateMcpServerTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> messageEndpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 根据请求的后缀判断是 sse 连接请求还是 message 调用请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">endsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">messageEndpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">setupSessionContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleMessageEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleSseEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="21-客户端发送-sse-请求">2.1 客户端发送 sse 请求<a href="#21-客户端发送-sse-请求" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h4>
<blockquote>
<p>如果我们客户端发送的是后缀为 <code>/sse</code> 的请求，那么将会执行 <code>handleSseEndpoint()</code> 方法</p>
</blockquote>
<ul>
<li class=""><code>handleSseEndpoint()</code> 方法主要做了如下工作</li>
</ul>
<ol>
<li class="">配置 sse 请求头</li>
<li class="">调用 <code>ShenyuSseServerTransportProvider</code> 的 <code>createSseFlux()</code> 创建 sse 流</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">McpServerPlugin</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">AbstractShenyuPlugin</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Mono</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleSseEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 配置 sse 请求头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">configureSseHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 创建 sse 流</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">writeWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transportProvider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createSseFlux</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>createSseFlux()</code> 方法</li>
</ul>
<blockquote>
<p>该方法被 <code>handleSseEndpoint()</code>调用 主要用于创建并保存 session</p>
</blockquote>
<ol>
<li class="">创建 session ，创建 session 的工厂在创建 session 时会将一系列 handler 注册到 session 中，这些 handler 是真正执行
callTool 的对象</li>
<li class="">将 session 保存，session复用</li>
<li class="">将 session id 作为 endpoint 的请求参数返回给客户端，在调用 message 方法时会使用该 endpoint</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">McpServerTransportProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Flux</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ServerSentEvent</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createSseFlux</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Flux</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">ServerSentEvent</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sink </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">WebFluxMcpSessionTransport</span><span class="token plain"> sessionTransport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WebFluxMcpSessionTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sink</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// 创建 McpServerSession 并暂存插件链信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">McpServerSession</span><span class="token plain"> session </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sessionFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sessionTransport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">String</span><span class="token plain"> sessionId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sessions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sessionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// 将 session id等信息传递回客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">String</span><span class="token plain"> endpointUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">baseUrl </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageEndpoint </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;?sessionId=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sessionId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">ServerSentEvent</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> endpointEvent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ServerSentEvent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ENDPOINT_EVENT_TYPE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endpointUrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doOnSubscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">subscription </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SSE Flux subscribed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">doOnRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SSE Flux requested {} items&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="22-客户端发送-message-请求">2.2 客户端发送 message 请求<a href="#22-客户端发送-message-请求" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h4>
<blockquote>
<p>如果我们客户端发送的是后缀为 <code>/message</code> 的请求，那么将会执行 把当前 <code>ShenyuPluginChain</code> 信息存入 session 中，并调用 <code>handleMessageEndpoint()</code> 方法，
后续工具调用时会继续执行该插件链，因此 mcp plugin 后的插件会对进入 tool 的请求造成影响</p>
</blockquote>
<ul>
<li class=""><code>handleMessageEndpoint()</code> 方法，调用 <code>ShenyuSseServerTransportProvider</code> 的 <code>handleMessageEndpoint()</code> 方法</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (uri.endsWith(messageEndpoint)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       setupSessionContext(exchange, chain);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       return handleMessageEndpoint(exchange, transportProvider, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">McpServerPlugin</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">AbstractShenyuPlugin</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Mono</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleMessageEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 处理message请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transportProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">handleMessageEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flatMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> exchange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">writeWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Mono</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">just</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exchange</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bufferFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">responseBody</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>handleMessageEndpoint()</code> 方法</li>
</ul>
<blockquote>
<p>该方法由 <code>McpServerPlugin.handleMessageEndpoint()</code> 调用，将请求交给 session 处理</p>
</blockquote>
<p>session 的 <code>handler()</code> 方法会对 message 的不同，而进行对应的操作
例如 ： 当 message 中 method 是 &quot;tools/call&quot; 时，则会使用工具调用的 handler() 执行 <code>call()</code> 方法调用工具
相关源码在此不过多赘述</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShenyuSseServerTransportProvider</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">McpServerTransportProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Mono</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">MessageHandlingResult</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleMessageEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取到session</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> sessionId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryParam</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sessionId&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">McpServerSession</span><span class="token plain"> session </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sessions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sessionId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">bodyToMono</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flatMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">McpSchema</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">JSONRPCMessage</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">McpSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">deserializeJsonRpcMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objectMapper</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>至此 <code>Shenyu Mcp Plugin</code> 服务调用源码分析完毕</p>
<p>流程图一览
<img decoding="async" loading="lazy" src="/zh/assets/images/Mcp-server-execute-zh-9cf2daaf68b9189ce0d70536f72f73b8.png" width="1038" height="648" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-工具调用">3. 工具调用<a href="#3-工具调用" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h3>
<blockquote>
<p>如果客户端传递的消息是调用工具的消息，那么 session 将使用工具调用的 handler() 并执行 tool 的 <code>call()</code> 方法，
在服务注册中，我们说明了 tool 在被调用时，实际执行的是 <code>ShenyuToolCallback()</code> 的 <code>call()</code> 方法</p>
</blockquote>
<p>因此执行工具调用时会执行以下方法</p>
<ul>
<li class=""><code>call()</code> 主要工作内容如下</li>
</ul>
<ol>
<li class="">获取 session id</li>
<li class="">获取 <code>requestTemplate</code> 即 shenyu 提供的额外功能的配置信息</li>
<li class="">获取上一步暂存的 shenyu 插件链，并将工具调用的信息交给插件链继续执行</li>
<li class="">异步等待工具响应</li>
</ol>
<p>插件链执行完成后，会将调用 tool 请求真正的发送到 tool 所在的服务之中</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShenyuToolCallback</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">ToolCallback</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">call</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ToolContext</span><span class="token plain"> toolContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 从 mcp 请求中提取 sessionId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">McpSyncServerExchange</span><span class="token plain"> mcpExchange </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">extractMcpExchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">toolContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> sessionId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">extractSessionId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mcpExchange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 提取requestTemplate信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> configStr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">extractRequestConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shenyuTool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 利用sessionId 获取到先前暂存的插件执行链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> originExchange </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOriginExchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sessionId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShenyuPluginChain</span><span class="token plain"> chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getPluginChain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">originExchange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 执行工具调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">executeToolCall</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">originExchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sessionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> configStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">executeToolCall</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> originExchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShenyuPluginChain</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> sessionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> configStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">CompletableFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> responseFuture </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CompletableFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ServerWebExchange</span><span class="token plain"> decoratedExchange </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildDecoratedExchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                originExchange</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> responseFuture</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sessionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> configStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 执行插件链，调用实际工具</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        chain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decoratedExchange</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 等待响应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> responseFuture</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">DEFAULT_TIMEOUT_SECONDS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>至此Shenyu MCP Plugin 工具调用分析完毕</p>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA1AAAACFCAYAAABVABkwAAAadElEQVR4Xu2cfbAkVXmH2Y+iqICFf0gwQbIYBcSkREUtKhXkQxNjPhRlgd27y5cKEi3LuCwfUQSUJAQTYEEIsSBEhDJ+VISwgElg9y7GuLtUAsVWqpKq/MH+EaGoEGB3pRJW2A5vyzv78vbpnjN9Z3rOmX6eqqfu9DmnT/d0n3Nmfnfm3n0KAAAAAAAAiGIfXwAAAAAAAABhCFAAAAAAAACREKAAAAAAAAAiIUABAAAAAABEQoACAAAAAACIhAAFAAAAAAAQCQEKAAAAAAAgEgIUAAAAAABAJAQoAAAAAACASAhQAAAAAAAAkRCgAAAAAAAAIiFAAQAAAAAAREKAAgAAAAAAiIQABQAAAAAAEAkBCgAAAAAAIBICFAAAAAAAQCQEKAAAAAAAgEgIUAAAAAAAAJEQoAAAAAAAACIhQAEAAAAAAERCgAIAAAAAAIgkiQC1efOW4qyzzymWLTusWLp0abFkyRLEiXngga8t3ve+9xe33vpXfihCxqy/997io6csLw4++PWVe47YtQcd9PPFhz58cvG9u+4q9uzZ44drb3jmmWeKS794efG2t7292G+//SrXCbFLZQzKWLz0i5eVYxOgLVMPUF+49LJin332QZyKJ554UvHEE0/4YQmZcfY5H6/cW8RUnFt1hh+yveDuu/+ueN3rDqpcD8QUlLF518tjFKANUw1Q8lspHci/8Zu/Vdx2+zeLH25+pPjnLY8iTsz19z9YfPoznxuMvWOOeXevf0OcO6tWnzG4l6evWFV86zt3V+45Ytd+52/XF3OrzxqMzVOWn+qH7kyzYcPGwXNfdtgbi6uuvqbY+NCWynVC7FIZgzIWZUzq+JSxCjAqUwtQWx9+eDB4L/n8ZcVzP3kRsVPv+/uN5cf5MgbXXnixH6KQAd+4487BOnLjX9xSuceI0/Zrt94+GKO33HKrH8Izy9FHv6N8ziee9P7iiad2VK4L4jSVMSljU8bo0W9/hx++AEOZWoD6xLnnDRZXP7ARu3LdDTeX4/CA17zGD1HIgOOOO768f+ee96nKvUVMxc989oJynMqn3X3gnnvWD0LjY//2n5XrgZiCMjZ1nMqYBRiFqQWoNx9+RDlo//KWr1cGNWJXPrvrp4NPoR57bJsfpp3wo81bi81btr6qzG9bpH1XNJ3HtHnhhRcGL37zP9haubeIqbjlX7YNxuqOHTv8UJ45PrdmbflcT/7I8sq1QExJGaMyVmXMAozC1ALUz+2/fzloN2zaXBnQiF165JFHlWNx4/y8H6adcPrcmcV119842JbHUhZCAs1pK8N140aOtexNRyUbop588snBm9IfP/Vc5b4ipuIzO3cPxurj27f7oTxzrFg5Vz7XNWsvqVwLxJSUMSpjdcXKVX4YAzRCgMLe+5a3vPVnY3HjdP6QdCEBStpOKuDkFKD4GwtMWfmkexCgHn/cD+WZY+XLb0bluV5w4R9WrgViSsoYlbEqYxZgFAhQ2HtzClBSbgPNJAMOAQpxPBKgENOUAAVtIUBh7x1HgJLQo8HH/42SBBCtD31iNEqAkkAjaJ+yrfv74zYdU7Hn7dsQoBDHIwEKMU0JUNAWAhT23oUGKA0yGkZWrDprEDo0hNigoiFIiQ1Q0peW62MNUDYA6TH1uHI++tii+9vzsm0IUIjjkQCFmKYEKGgLAQp770IClA1Isfj2sQEq9ClRKOBooLJoyKvbDpURoBDHIwEKMU0JUNAWAhT23oUEqFBYqUO+YqchpU2A8oFHy3zACZX5cuk/9N/8pM21675aPiZAIY5HAhRimhKgoC0EKOy9kw5QGpo0OLUJUPbrexYfcJpCjz2uDUoWOQYBCnG89ilAvfTSSwQozEYCFLSFAIW9dyEBKhR2LKH6NgFKtkNBJhRwfP+23H4CRYBC7Ma+BagVK+aKRYsWFWsv+kLlWiCmJAEK2kKAwt670AAlIaOOUJjxZTEBqu4Yvi/B9yf4MBQ6b9/Gb6cGAQpzkQCFmKYEKGgLAQp770IClCCBRYOGKOFEA4wGFS3XtsMClLTRf0su+/pApWif0kbb6/5arts+VIXa+OOE9ksFAhTmIgEKMU0JUNAWAhT23oUGKKEuHAm2XLWf6qy74abKV/Tstq+zaLjyx7Xl8m/M/Tkp0kYNtdFglSIEKMzFPgWoF198kQCF2UiAgrYQoLD3jiNATZKmANVnCFCYi30MUIsXLy4uvJgAhWlLgIK2EKCw96YcoJq+vtd3CFCYi30KUMKqVWcQoDALCVDQFgIU9t6UA5QQ+modEKAwH/sYoOQrfGvWXvLyc99duR6IqUiAgrYQoLD3ph6gIAwBCnOxbwFqbm41AQqzkAAFbSFAYe8lQOUJAQpzsd8B6qeV64GYigQoaAsBCnsvASpPCFCYi30LUPJmVJ4rAQpTlwAFbSFAYe8lQOUJAQpzsa8BSt6c+muBmJIEKGgLAQp7LwEqTwhQmIsEKMQ0JUBBWwhQ2HsJUHlCgMJcJEAhpikBCtpCgMLeS4DKEwIU5iIBCjFNCVDQFgIU9l4CVJ4QoDAXCVCIaUqAgrYQoLD3EqDyhACFuUiAQkxTAhS0hQCFvZcAlScEKMxFAhRimhKgoC0EKOy9BKg8IUBhLhKgENOUAAVtIUBh7yVA5QkBCnORAIWYpgQoaAsBCnsvASpPCFCYiwQoxDQlQEFbehGgduz632LnrucxQ/29nIQEqDxpClDMeZymMv7seCRAjdcdu/6vcs1xtpV77sfBOCRAQVsIUJi0/l5OQgJUnhCgMFUJUAQoHK8EKEgNAhQmrb+Xk5AAlQ6XX355eS/m5+d9VQUCFKbqrAUomY9y7jI/YyBA4bglQO1l1PkIk4EAhUnr7+UkJEClgwaomBBFgMJUnbUAZedlzJs2AhSOWwLUXkadjzAZCFCYtP5eTkICVFqccMIJUSFqGgFqw/wPKmWT0B6nq2P2QX9dx3FttQ/b16wFKGGUN22pBKhx3N/cHOdz9n357Qc3PlTZZxz644gEqFczynwcF8vedFSxecvWwfbpc2eWeq67/sZBufy8dt1XXYvZoDcBSibkn/7ZdZVJKUp5aMK2Vfobd5/jsotzk76Xn766Ut5Gfy8nIQEqPWyI2lhzX6YRoOQFZJS502a+Xf3n6141f+Sx3V/71H4n9SZmksp5h67JqNdqFKVfuX+6Lde17jUhVrvW2XOfxQAlXHHFFVFv2roMUHVzTMrG9To0Dnfs/Ek5V+389XPZ7zOqfoxb2xzHrne+b+nrlNNWVfZZqHX3jQBVJXY+jovYAGXbSZgiQI2ZrgOUTEq5qf4FUxcFX95Wmfj6wiw/6xazadjluY3revp7OQkJUGky7JOoYQHKvrkdl7EBSo9t51vsuQwLULpe2Xk8rvk2Kf1aU/cmSa+XLx+H/g3gOI5l743eE3k8qwFKiPnNd1cBys8x/wY/NMampQQoOadTV5wxOFdRn0PMujJMP8ZFOaauEYPr9ZVrK/uGtOud71v6I0BNn5j5OC7k/g8LUFLvy2S/WaT3AcouwH7CjqpfYLTMt5uGKZ9bk/5eTkICVLo0haiUA1RoTYnZT4wJUHZb2vu5nZr+/OreJIWu27j0a+BCjxUaX9r/LAcoYdibti4ClL+fek/0cd0Ym5QSkOzPUJ363I5dZZC6egHjL6S/Jhs3/VNlvRhFAlQeDJuPHgk5NghZtC5UHxOgZNvvu+6Gm8pPomaNXgUoDVF2Umqo8i+k2lbrpUxfMEN1Wu/799p97SLh+w6dq+9/lL6k3PfnrevP19nnXLePP5ZvZxd0PVdtY+v9vZyEdQFKFiKcvvrC4ENUU4DaMP/DwXjzY9OPRTtOfb0d6zqu/Zu0QdtXfqvr52lI2U+OHTrOqAEqVNb0HHydPVedi7odei5+f9vW1+n+Vu0jdO398W1/ol837DH9dfL76/WuO1bo/OuOZdv740l5bICS8ezHey7aX27ItmVaAcrfC73Hev/9113r7rc8VnVfeSxBSObnGw//lTIEaXsJKqetPHMQjL5yzfVlubR/YMOmsswety5ASfumcejP2df7ayLnHZpndf35tlKmc8r3LftJgKo7V/88fN++XveVn7atbncdoPx4T92m+ahIiNHrLUFHfjbV+a/eSdmwAOXbCBKgfLtZoFcBShdBnagygX2ZaF9Y7YukLiB12zrZfZlfCOx2U1/+Bd4uhjF9+QWr6dz0WoT6s8fy18OW60IrynFsX/a56HlovdTZ87LH9vdyEoYClCxA9o07pqF9YWgKUHbO6zjTsWbHbDkuzddZ/Nz3c1DGqY5zPy9C5XXaueLnw6gByh/PPwc/t/RNj85lPxft89X9bb19znau+uPqOfo+9Dz0vKyh49t9bJ209c/N19tz1fa23re35+/b+rXTH8+WxQaoWVpn7C83ughQcr3101d/H/Re+PFhPzGRbTtv7P0M7WvHgwSo8j6/8smShCcJSrItj696eU2Rx6MGKCmXc5IApmHKnod+oqTbg/qaX95IX3YOhbTXTq6n3Za+6uaxv0b+XO311Dp7Ln5frZMyvS/2cZcBatOmTZXxnZseCTVyze0nQTboSLmt00Blke2YAOXZsvXhSrtZoHqVO2JaAUpfSGVC6vawia7afVU7wX07u0DY4/l2/rHtu27/UF+6uNnH3lHOTfuw1872JeV118oeX/a1x9J6+1xsvT22v5eTMBSgBP8bHpyO9kUh9hOougDlx2to3th6HeOh/evGf+i4Tfr5GhOgpMzOY79+2f5tvT9f375pLob2t33bx1bfh7a1z8M/H9+H3Ue3/bn6en+u/jzs/lLn75l9Pnp+tt7fF7tPbIDK+RMoOy9l29JVgLL3zo8deezvWdP4sO3r9tX2GjQ0QP3yEb8aDFBSJ6EnJkBp2JK+bJkcR/rU4/rzknoNhn6M++c4TD/O7f6+b3tcu7+9B5W6V4Ken6tWvfZ6PD1+lwFKyG1uNs1HQQKMjKNRkOtvA5Pf9gFKgpK08dSV507vApRMRJ24+tO+UIYWTrXuRdaX2fZ2UZfHIev61n1sX7Y8ZKhtyFHOTdQFz79pqCu3+8pjv4jbhdYvuvb8/b2chHUBCqbPQv4Gys9N/e2tHYd2fDbNQR2/fizb8a9fD/LHDSl96L76U/v1b5JCc8uej/0ETeeOV46hdbYvO9f0WHVzsa5vf66+zB9DrLtG/vjyWNtq33VtQ+dq+/Zldn+9B966NUrL7LXUY0h5bIDKFfuGLfRmrcsA5e+vvad+jEm9tBs2lpv2tduvuufm0ygfoKTefuVv8FW/l+e6lkl72U/DkpZpqPJhStWxq+dSN8brtPNL/8GF1tnn7PuW/YYFKO178POVtUqP589F97H3RMu7DlA5MWw+CjEBSj+Fstd/1ABV90mT7Dtr9DJA2QVDt+2iayetVRdKW9a0EPi+pd+6xSzUt93f1w/rq+45hPoe1p/fJ9S3L/ePfd9SpguzX3Tt+ft7OQkJUGnSFJ6EUQOUH3d2rNk3Vba9L/P7q3b8+3289pihfkcJUH7eDTt2ORcDgUu37ZoQqvfnHVLq7Zz2fehx/L0R/X62je+nad0IXeOm/f119Ppj6T51ZbMcoGLerE0jQPl7EhpjdkyUc8HdP9tP0772WH5+SggZFqBEeTNrA5TUy37+EygJUNK2LkBJ33WfQPmv5Hn9HNNz1W37nH3f0m9TgPJzprxe5hMof31tO7039vwJUGFi5qMgwcb/TZNFg5P81JAk26MGKGnjqSvPnV4GKNEuDLoQ2jq7XbeADOtHtItrqN4eI7Sg6D5+kfbPx/flzzN0bLvADesv1LctF+218AutPbY8tvV+obXH8PdyEhKg0mNYeBKGBaiYeSCP7ZsAP/dlbNatG6Hxb/v180nKZB9/Xrqt/YUClD0n21bb+3o/1+052ADl56I/71B9Xd9+nfDXzbb1x1Gb1iR/Lv66+Ovqr8Ow/X17q2+r/fkyaSfnMasBKvbNWhcBqrz+7t9x6/XX++PHmJ07oftn723Tvnb/0Ni2/UrgkTUmFKCuuvqaQdASn31uZ/n3VfLVPimXbf2nFBqgpL4cY65e9vdzQM/bP0/7abmt88/bPmfft7T1f1Nm2/vjlnPIfYXPrxl15yBlBKgqsfNRCP1Nk0Xq/D9/8GV+2wcoIXSMpk+mcqa3ASq0EPqFQNrbRUDfFKh+gdD60L6qr7eLk1+wVW3vy5v6km3bdiHnVvec68r1nJv6riys7jrq/v5eTkICVFrEhCdhWIDScWjHl53DUmfHeaheftr6si/3NZTQmI4Z86quTXoc/cP4pjcU9py0LPQc9dh+bbDnpHPN79tUb/uoWyfsOepz0Ofhn5MqZX4d0f38ufi2dt3QY9jz1J++3m/b51B3LD2eL5N2Uj6LAWqUN2tdBCi5zhIe7L219yM0xvy49GOjbs6F9tUy386PO9kOBajykyoXoET5FEpCkuwvPzUcifo1v8Pe/NZgvRxD/8GFltk576+Tr/Nf4dNy3bb76vMK9av19jrIz9Avb/y+/tprOwLUqxllPgqhfyLhP23ydVLmA5Rv44OR30fgv/CNma4DlCwUfvFTY8v1zYM+9vW2XUx9qNyXNbVvqguV2fbD6sdRHiqrK68r8/dyEhKg0iE2PAkxAappzIXKY+pteVO7YfW+n7o6v+3rmspC5ba9/JQXvLp6/3hY33Xlvq6u3bCyusexZb7eb2uZL/fbqr120kZfH2YtQMlcHOXNWhcByt8vf4/qyvw9rGsXKvP7yv0Olfv2oTZS5sOTKuVSL1+pG1dd6DnZutBjv2378OW+T98+ZKi+rowAtZdR56OiIcqqYUcDkwQdDUry2IYh/ymW/dqfLbPbgu9nVuhNgPITt40yie1vRnDy+ns5CQlQ6aC/VRsWnoSYAIXNypoWClAYp/x2XH9zbt9Mz1qA0nkZ+2atywA1LXk/0K0EqL2MOh89EmbqAk1dueLr/Xbsp1KzAAFqBFkwu9ffy0lIgMoTAtTCJUAtXPvVIy2btQA1KrMeoPRrZ/6TEpycBKh8sJ9Kyc9h//0vVwhQI8qC2a3+Xk5CAlSeEKDGI2va+CVAzXaAYs50LwEqH+zfVtnHs0YvAhRikwSoPGkKUIgpSYBCTFMCFLSFAIW9lwCVJwQozEUCFGKaEqCgLQQo7L0EqDwhQGEuEqAQ05QABW0hQGHvJUDlCQEKc5EAhZimBChoCwEKey8BKk8IUJiLBCjENCVAQVsIUNh7CVB5QoDCXCRAIaYpAQraQoDC3kuAyhMCFOYiAQoxTQlQ0BYCFPZeAlSeEKAwFwlQiGlKgIK2EKCw9xKg8oQAhblIgEJMUwIUtIUAhb2XAJUnBCjMRQIUYpoSoKAtBCjsvQSoPCFAYS4SoBDTlAAFbSFAYe8lQOUJAQpzkQCFmKYEKGgLAQp7LwEqTwhQmIsEKMQ0JUBBWwhQ2HsJUHlCgMJcJEAhpikBCtpCgMLeS4DKEwIU5iIBCjFNCVDQFgIU9l4CVJ4QoDAXCVCIaUqAgrYQoLD3EqDyhACFuUiAQkxTAhS0hQCFvZcAlScEKMxFAhRimhKgoC0EKOy9BKg8IUBhLhKgENOUAAVtIUBh7yVA5QkBCnORAIWYpgQoaAsBCnsvASpPCFCYiwQoxDQlQEFbCFDYewlQeUKAwlwkQCGmKQEK2kKAwt5LgMoTAhTmIgEKMU0JUNAWAhT2XgJUnhCgMBcJUIjp+eyu3cWatZcQoKAVBCjsvQSoPCFAYS4SoBDTUwPUokWLilWrzvDDGKARAhT2XgJUnhCgMBcJUIjpSYCChUCAwt5LgMoTAhTmIgEKMT0JULAQphag9j/ggHKBfXD+R5VBjdilRx55VDkWN87P+2EKCWMD1I+feq5yXxFT8Zmduwdjdfv27X4ozxwrVs6Vz1XenPprgZiKMi//YM1FZYCaW7XaD2OARqYWoA4/4shygb35a7dVBjViV/7PjheKfffdtxyL27Zt88MUEmb37r1vSvkkG1N288OPDcbqzp07/VCeOdZcsLZ8rh/68Ecr1wIxFeX1/3d/7+Ri8eLFxYUXXeyHMUAjUwtQ55//qXKBfe/xJ1YGNWJXXrPuxnIcHnjga/0QhQw4/vgTyvv3sU98snJvEVPx9z/92XKcvuc9x/ohPJPce+99g8D4r4/9e+V6IKbgI9v+oxyjS5YsKe6///t+GAM0MrUA9cijjw4WWD7mx2l49/p/KJYuXVqOwYsv+bwfopABf/Otbw/WkWvX3VS5x4jT9qabbx2M0dv++ut+CM8sx7zr3eVz/vXjji+2/9d/V64L4jSVMfneE04qv773zne+yw9fgKFMLUAJX/rylYMXFvkkSr7OJ1/F2fjQFsSJ+d3v3Vuce97PPgEVjz321/zQhIw4+5yPD+7lyR9ZXtx+57cr9xyxa+/45neL5aeuGIxN+bugPrFp00OD5/4Lv3hIccWX/6T4/j9uqlwnxC6VMfilK68qDnnDoWV4kvG5YeN8sWfPHj+EARqZaoASbIhC7NoPfOCDxdNPP+2HJWTGeZ88v3JvEVPx7HM+5odsL5CvRR1yyBsq1wNxWkpo0uAkY/Oe9esJT9CKqQcoQb7OJ38TJf9YQv47n/yLc8RJefDBry8++Nu/U3zjjjv9UISMeeCBB4uVc6uLZcsOq9xzxK499NBfKk47fUVx3/33+6HaK55//vniyj/64/Lvv+RvTf11QuxSGYMyFmVM7tq1yw9XgGiSCFAAAAAAAAA5QIACAAAAAACIhAAFAAAAAAAQCQEKAAAAAAAgEgIUAAAAAABAJAQoAAAAAACASAhQAAAAAAAAkRCgAAAAAAAAIiFAAQAAAAAAREKAAgAAAAAAiIQABQAAAAAAEAkBCgAAAAAAIBICFAAAAAAAQCQEKAAAAAAAgEgIUAAAAAAAAJEQoAAAAAAAACIhQAEAAAAAAERCgAIAAAAAAIiEAAUAAAAAABAJAQoAAAAAACASAhQAAAAAAEAkBCgAAAAAAIBICFAAAAAAAACREKAAAAAAAAAi+X+qWpaxlGLVEwAAAABJRU5ErkJggg==" width="848" height="133" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-小结">4. 小结<a href="#4-小结" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading" translate="no">​</a></h3>
<p>本文源码分析从 mcp 服务注册开始，到 mcp 插件的服务调用，再到 tool 的调用。
mcpServer 插件让 shenyu 成为一个功能强大，集中管理的 mcpServer。</p>
<hr></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/plugin">plugin</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/mcp">mcp</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑本文档</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Dubbo插件源码分析</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Param-Mapping插件源码分析</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#1-服务注册" class="table-of-contents__link toc-highlight">1. 服务注册</a></li><li><a href="#2-插件调用" class="table-of-contents__link toc-highlight">2. 插件调用</a></li><li><a href="#3-工具调用" class="table-of-contents__link toc-highlight">3. 工具调用</a></li><li><a href="#4-小结" class="table-of-contents__link toc-highlight">4. 小结</a></li></ul></div></div></div></div></div></div>
</body>
</html>