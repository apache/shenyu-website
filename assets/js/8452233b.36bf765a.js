"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[98620],{11912:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var i=t(74848),r=t(28453);const a={title:"Code Analysis For Dubbo Plugin",author:"midnight2104",author_title:"Apache ShenYu Committer",author_url:"https://github.com/midnight2104",tags:["plugin","dubbo","Apache ShenYu"]},s=void 0,l={permalink:"/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin",editUrl:"https://github.com/apache/shenyu-website/edit/main/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin.md",source:"@site/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin.md",title:"Code Analysis For Dubbo Plugin",description:"Apache ShenYu is an asynchronous, high-performance, cross-language, responsive API gateway.",date:"2025-12-02T02:18:39.000Z",formattedDate:"December 2, 2025",tags:[{label:"plugin",permalink:"/blog/tags/plugin"},{label:"dubbo",permalink:"/blog/tags/dubbo"},{label:"Apache ShenYu",permalink:"/blog/tags/apache-shen-yu"}],readingTime:21.51,hasTruncateMarker:!1,authors:[{name:"midnight2104",title:"Apache ShenYu Committer",url:"https://github.com/midnight2104"}],frontMatter:{title:"Code Analysis For Dubbo Plugin",author:"midnight2104",author_title:"Apache ShenYu Committer",author_url:"https://github.com/midnight2104",tags:["plugin","dubbo","Apache ShenYu"]},unlisted:!1,prevItem:{title:"Code Analysis For Divide Plugin",permalink:"/blog/Plugin-SourceCode-Analysis-Divide-Plugin"},nextItem:{title:"McpServer Plugin Source Code Analysis",permalink:"/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"}},o={authorsImageUrls:[void 0]},c=[{value:"1. Service Registration",id:"1-service-registration",level:3},{value:"1.1  Declaration of registration interface",id:"11--declaration-of-registration-interface",level:4},{value:"1.2 Scan annotation information",id:"12-scan-annotation-information",level:4},{value:"1.3 Processing registration information",id:"13-processing-registration-information",level:4},{value:"1.3.1 Registration Service",id:"131-registration-service",level:5},{value:"1.3.1.1 Register Selector",id:"1311-register-selector",level:6},{value:"1.3.1.2 Registration Rules",id:"1312-registration-rules",level:6},{value:"1.3.1.3 Register Metadata",id:"1313-register-metadata",level:6},{value:"1.3.2 Register URI",id:"132-register-uri",level:5},{value:"2. Service Invocation",id:"2-service-invocation",level:3},{value:"2.1 Receive requests",id:"21-receive-requests",level:4},{value:"2.2 Match Rule",id:"22-match-rule",level:4},{value:"2.3 Execute GlobalPlugin",id:"23-execute-globalplugin",level:4},{value:"2.4 Execute RpcParamTransformPlugin",id:"24-execute-rpcparamtransformplugin",level:4},{value:"2.5 Execute DubboPlugin",id:"25-execute-dubboplugin",level:4},{value:"2.6 Execute ResponsePlugin",id:"26-execute-responseplugin",level:4},{value:"3. Summary",id:"3-summary",level:3}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",h5:"h5",h6:"h6",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/zh/docs/index",children:"Apache ShenYu"})," is an asynchronous, high-performance, cross-language, responsive ",(0,i.jsx)(n.code,{children:"API"})," gateway."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"Apache ShenYu"})," gateway uses the ",(0,i.jsx)(n.code,{children:"dubbo"})," plugin to make calls to the ",(0,i.jsx)(n.code,{children:"dubbo"})," service. You can see the official documentation ",(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/docs/quick-start/quick-start-dubbo",children:"Dubbo Quick Start"})," to learn how to use the plugin."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["This article is based on ",(0,i.jsx)(n.code,{children:"shenyu-2.4.3"})," version for source code analysis, please refer to ",(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/zh/docs/user-guide/proxy/dubbo-proxy/",children:"Dubbo Service Access"})," for the introduction of the official website."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"1-service-registration",children:"1. Service Registration"}),"\n",(0,i.jsxs)(n.p,{children:["Take the example provided on the official website ",(0,i.jsx)(n.a,{href:"https://github.com/apache/shenyu/tree/master/shenyu-examples/shenyu-examples-dubbo/shenyu-examples-apache-dubbo-service",children:"shenyu-examples-dubbo"}),". Suppose your ",(0,i.jsx)(n.code,{children:"dubbo"})," service is defined as follows (",(0,i.jsx)(n.code,{children:"spring-dubbo.xml"}),")."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:'<beans xmlns="http://www.springframework.org/schema/beans"\n       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"\n       xsi:schemaLocation="http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans.xsd\n       http://code.alibabatech.com/schema/dubbo\n       https://code.alibabatech.com/schema/dubbo/dubbo.xsd">\n\n    <dubbo:application name="test-dubbo-service"/>\n    <dubbo:registry address="${dubbo.registry.address}"/>\n    <dubbo:protocol name="dubbo" port="20888"/>\n\n    <dubbo:service timeout="10000" interface="org.apache.shenyu.examples.dubbo.api.service.DubboTestService" ref="dubboTestService"/>\n\n</beans>\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Declare the application service name, register the center address, use the ",(0,i.jsx)(n.code,{children:"dubbo"})," protocol, declare the service interface, and the corresponding interface implementation class."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'/**\n * DubboTestServiceImpl.\n */\n@Service("dubboTestService")\npublic class DubboTestServiceImpl implements DubboTestService {\n    \n    @Override\n    @ShenyuDubboClient(path = "/findById", desc = "Query by Id")\n    public DubboTest findById(final String id) {\n        return new DubboTest(id, "hello world shenyu Apache, findById");\n    }\n\n    //......\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In the interface implementation class, use the annotation ",(0,i.jsx)(n.code,{children:"@ShenyuDubboClient"})," to register the service with ",(0,i.jsx)(n.code,{children:"shenyu-admin"}),". The role of this annotation and its rationale will be analyzed later."]}),"\n",(0,i.jsxs)(n.p,{children:["The configuration information in the configuration file ",(0,i.jsx)(n.code,{children:"application.yml"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"server:\n  port: 8011\n  address: 0.0.0.0\n  servlet:\n    context-path: /\nspring:\n  main:\n    allow-bean-definition-overriding: true\ndubbo:\n  registry:\n    address: zookeeper://localhost:2181  # dubbo registry\n    \nshenyu:\n  register:\n    registerType: http \n    serverLists: http://localhost:9095 \n    props:\n      username: admin \n      password: 123456\n  client:\n    dubbo:\n      props:\n        contextPath: /dubbo  \n        appName: dubbo\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In the configuration file, declare the registry address used by ",(0,i.jsx)(n.code,{children:"dubbo"}),". The ",(0,i.jsx)(n.code,{children:"dubbo"})," service registers with ",(0,i.jsx)(n.code,{children:"shenyu-admin"}),", using the method ",(0,i.jsx)(n.code,{children:"http"}),", and the registration address is ",(0,i.jsx)(n.code,{children:"http://localhost:9095"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/docs/design/register-center-design/",children:"Application Client Access"})," for more information on the use of the registration method."]}),"\n",(0,i.jsx)(n.h4,{id:"11--declaration-of-registration-interface",children:"1.1  Declaration of registration interface"}),"\n",(0,i.jsxs)(n.p,{children:["Use the annotation ",(0,i.jsx)(n.code,{children:"@ShenyuDubboClient"})," to register the service to the gateway. The simple ",(0,i.jsx)(n.code,{children:"demo"})," is as follows."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// dubbo sevice\n@Service("dubboTestService")\npublic class DubboTestServiceImpl implements DubboTestService {\n    \n    @Override\n    @ShenyuDubboClient(path = "/findById", desc = "Query by Id") // need to be registered method\n    public DubboTest findById(final String id) {\n        return new DubboTest(id, "hello world shenyu Apache, findById");\n    }\n\n    //......\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"annotation definition:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'/**\n * Works on classes and methods\n */\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE, ElementType.METHOD})\n@Inherited\npublic @interface ShenyuDubboClient {\n    \n\t//path\n    String path();\n    \n    //rule name\n    String ruleName() default "";\n   \n    //desc\n    String desc() default "";\n\n    //enabled\n    boolean enabled() default true;\n}\n\n'})}),"\n",(0,i.jsx)(n.h4,{id:"12-scan-annotation-information",children:"1.2 Scan annotation information"}),"\n",(0,i.jsxs)(n.p,{children:["Annotation scanning is done through the ",(0,i.jsx)(n.code,{children:"ApacheDubboServiceBeanListener"}),", which implements the ",(0,i.jsx)(n.code,{children:"ApplicationListener<ContextRefreshedEvent>"})," interface and starts executing the event handler method when a context refresh event occurs during the ",(0,i.jsx)(n.code,{children:"Spring"})," container startup ",(0,i.jsx)(n.code,{children:"onApplicationEvent()"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"During constructor instantiation."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Read property configuration"}),"\n",(0,i.jsx)(n.li,{children:"Start the thread pool"}),"\n",(0,i.jsxs)(n.li,{children:["Start the registry for registering with ",(0,i.jsx)(n.code,{children:"shenyu-admin"})]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public class ApacheDubboServiceBeanListener implements ApplicationListener<ContextRefreshedEvent> {\n\n\t// ......\n\n    //Constructor\n    public ApacheDubboServiceBeanListener(final PropertiesConfig clientConfig, final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\n        //1.Read property configuration\n        Properties props = clientConfig.getProps();\n        String contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);\n        String appName = props.getProperty(ShenyuClientConstants.APP_NAME);\n        if (StringUtils.isBlank(contextPath)) {\n            throw new ShenyuClientIllegalArgumentException("apache dubbo client must config the contextPath or appName");\n        }\n        this.contextPath = contextPath;\n        this.appName = appName;\n        this.host = props.getProperty(ShenyuClientConstants.HOST);\n        this.port = props.getProperty(ShenyuClientConstants.PORT);\n        //2.Start the thread pool\n        executorService = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder().setNameFormat("shenyu-apache-dubbo-client-thread-pool-%d").build());\n        //3.Start the registry for registering with `shenyu-admin`\n        publisher.start(shenyuClientRegisterRepository);\n    }\n\n    /**\n     * Context refresh event, execute method logic\n     */\n    @Override\n    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {\n        //......\n    }\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ApacheDubboServiceBeanListener#onApplicationEvent()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Rewritten method logic: read ",(0,i.jsx)(n.code,{children:"Dubbo"})," service ",(0,i.jsx)(n.code,{children:"ServiceBean"}),", build metadata object and ",(0,i.jsx)(n.code,{children:"URI"})," object, and register it with ",(0,i.jsx)(n.code,{children:"shenyu-admin"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"    @Override\n    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {\n        //read ServiceBean\n        Map<String, ServiceBean> serviceBean = contextRefreshedEvent.getApplicationContext().getBeansOfType(ServiceBean.class);\n        if (serviceBean.isEmpty()) {\n            return;\n        }\n        //The method is guaranteed to be executed only once\n        if (!registered.compareAndSet(false, true)) {\n            return;\n        }\n        //handle metadata \n        for (Map.Entry<String, ServiceBean> entry : serviceBean.entrySet()) {\n            handler(entry.getValue());\n        }\n        //handle URI\n        serviceBean.values().stream().findFirst().ifPresent(bean -> {\n            publisher.publishEvent(buildURIRegisterDTO(bean));\n        });\n    }\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"handler()"}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"handler()"})," method, read all methods from the ",(0,i.jsx)(n.code,{children:"serviceBean"}),", determine if there is a ",(0,i.jsx)(n.code,{children:"ShenyuDubboClient"})," annotation on the method, build a metadata object if it exists, and register the method with ",(0,i.jsx)(n.code,{children:"shenyu-admin"})," through the registry."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"    private void handler(final ServiceBean<?> serviceBean) {\n        //get proxy\n        Object refProxy = serviceBean.getRef();\n        //get class\n        Class<?> clazz = refProxy.getClass();\n        if (AopUtils.isAopProxy(refProxy)) {\n            clazz = AopUtils.getTargetClass(refProxy);\n        }\n        //all methods\n        Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);\n        for (Method method : methods) {\n            //read ShenyuDubboClient annotation\n            ShenyuDubboClient shenyuDubboClient = method.getAnnotation(ShenyuDubboClient.class);\n            if (Objects.nonNull(shenyuDubboClient)) {\n                //build meatdata and registry\n                publisher.publishEvent(buildMetaDataDTO(serviceBean, shenyuDubboClient, method));\n            }\n        }\n    }\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"buildMetaDataDTO()"}),"\n",(0,i.jsx)(n.p,{children:"Constructs a metadata object where the necessary information for method registration is constructed and subsequently used for selector or rule matching."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'    private MetaDataRegisterDTO buildMetaDataDTO(final ServiceBean<?> serviceBean, final ShenyuDubboClient shenyuDubboClient, final Method method) {\n        //app name\n        String appName = buildAppName(serviceBean);\n        //path\n        String path = contextPath + shenyuDubboClient.path();\n        //desc\n        String desc = shenyuDubboClient.desc();\n        //service name\n        String serviceName = serviceBean.getInterface();\n        //rule name\n        String configRuleName = shenyuDubboClient.ruleName();\n        String ruleName = ("".equals(configRuleName)) ? path : configRuleName;\n        //method name \n        String methodName = method.getName();\n        //parameter Types\n        Class<?>[] parameterTypesClazz = method.getParameterTypes();\n        String parameterTypes = Arrays.stream(parameterTypesClazz).map(Class::getName).collect(Collectors.joining(","));\n        return MetaDataRegisterDTO.builder()\n                .appName(appName)\n                .serviceName(serviceName)\n                .methodName(methodName)\n                .contextPath(contextPath)\n                .host(buildHost())\n                .port(buildPort(serviceBean))\n                .path(path)\n                .ruleName(ruleName)\n                .pathDesc(desc)\n                .parameterTypes(parameterTypes)\n                .rpcExt(buildRpcExt(serviceBean)) //dubbo ext\n                .rpcType(RpcTypeEnum.DUBBO.getName())\n                .enabled(shenyuDubboClient.enabled())\n                .build();\n    }\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"buildRpcExt()"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"dubbo"})," ext information."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'   private String buildRpcExt(final ServiceBean serviceBean) {\n       DubboRpcExt build = DubboRpcExt.builder()\n               .group(StringUtils.isNotEmpty(serviceBean.getGroup()) ? serviceBean.getGroup() : "")//group\n               .version(StringUtils.isNotEmpty(serviceBean.getVersion()) ? serviceBean.getVersion() : "")//version\n               .loadbalance(StringUtils.isNotEmpty(serviceBean.getLoadbalance()) ? serviceBean.getLoadbalance() : Constants.DEFAULT_LOADBALANCE)//load balance\n               .retries(Objects.isNull(serviceBean.getRetries()) ? Constants.DEFAULT_RETRIES : serviceBean.getRetries())//retry\n               .timeout(Objects.isNull(serviceBean.getTimeout()) ? Constants.DEFAULT_CONNECT_TIMEOUT : serviceBean.getTimeout())//time\n               .sent(Objects.isNull(serviceBean.getSent()) ? Constants.DEFAULT_SENT : serviceBean.getSent())//sent\n               .cluster(StringUtils.isNotEmpty(serviceBean.getCluster()) ? serviceBean.getCluster() : Constants.DEFAULT_CLUSTER)//cluster\n               .url("")\n               .build();\n       return GsonUtils.getInstance().toJson(build);\n   }\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"buildURIRegisterDTO()"}),"\n",(0,i.jsxs)(n.p,{children:["Construct ",(0,i.jsx)(n.code,{children:"URI"})," objects to register information about the service itself, which can be subsequently used for service probing live."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"private URIRegisterDTO buildURIRegisterDTO(final ServiceBean serviceBean) {\n        return URIRegisterDTO.builder()\n                .contextPath(this.contextPath) //context path\n                .appName(buildAppName(serviceBean))//app name\n                .rpcType(RpcTypeEnum.DUBBO.getName())//dubbo\n                .host(buildHost()) //host\n                .port(buildPort(serviceBean))//port\n                .build();\n }\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The specific registration logic is implemented by the registration center, please refer to ",(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/zh/docs/design/register-center-design/",children:"Client Access Principles"})," ."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"//To the registration center, post registration events   \npublisher.publishEvent();\n"})}),"\n",(0,i.jsx)(n.h4,{id:"13-processing-registration-information",children:"1.3 Processing registration information"}),"\n",(0,i.jsxs)(n.p,{children:["The metadata and ",(0,i.jsx)(n.code,{children:"URI"})," data registered by the client through the registry are processed at the ",(0,i.jsx)(n.code,{children:"shenyu-admin"})," end, which is responsible for storing to the database and synchronizing to the ",(0,i.jsx)(n.code,{children:"shenyu"})," gateway. The client-side registration processing logic of the ",(0,i.jsx)(n.code,{children:"Dubbo"})," plugin is in the ",(0,i.jsx)(n.code,{children:"ShenyuClientRegisterDubboServiceImpl"}),". The inheritance relationship is as follows."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(48532).A+"",width:"977",height:"577"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ShenyuClientRegisterService: client registration service, top-level interface."}),"\n",(0,i.jsx)(n.li,{children:"FallbackShenyuClientRegisterService: registration failure, provides retry operation."}),"\n",(0,i.jsx)(n.li,{children:"AbstractShenyuClientRegisterServiceImpl: abstract class, implements part of the public registration logic."}),"\n",(0,i.jsxs)(n.li,{children:["ShenyuClientRegisterDubboServiceImpl: implementation of the ",(0,i.jsx)(n.code,{children:"Dubbo"})," plugin registration."]}),"\n"]}),"\n",(0,i.jsx)(n.h5,{id:"131-registration-service",children:"1.3.1 Registration Service"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()"}),"\n",(0,i.jsxs)(n.p,{children:["The metadata ",(0,i.jsx)(n.code,{children:"MetaDataRegisterDTO"})," object registered by the client through the registry is picked up and dropped in the ",(0,i.jsx)(n.code,{children:"register()"})," method of ",(0,i.jsx)(n.code,{children:"shenyu-admin"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"   @Override\n    public String register(final MetaDataRegisterDTO dto) {\n        //1. register selector\n        String selectorHandler = selectorHandler(dto);\n        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);\n        //2. register rule\n        String ruleHandler = ruleHandler();\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\n        ruleService.registerDefault(ruleDTO);\n        //3. register metadata\n        registerMetadata(dto);\n        //4. register contextPath\n        String contextPath = dto.getContextPath();\n        if (StringUtils.isNotEmpty(contextPath)) {\n            registerContextPath(dto);\n        }\n        return ShenyuResultMessage.SUCCESS;\n    }\n"})}),"\n",(0,i.jsx)(n.h6,{id:"1311-register-selector",children:"1.3.1.1 Register Selector"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Construct ",(0,i.jsx)(n.code,{children:"contextPath"}),", find if the selector information exists, if it does, return ",(0,i.jsx)(n.code,{children:"id"}),"; if it doesn't, create the default selector information."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"    @Override\n    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {\n        // build contextPath\n        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());\n        // Find if selector information exists by name\n        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);\n        if (Objects.isNull(selectorDO)) {\n            // Create a default selector message if it does not exist\n            return registerSelector(contextPath, pluginName, selectorHandler);\n        }\n        return selectorDO.getId();\n    }\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Default selector information"}),"\n",(0,i.jsx)(n.p,{children:"Construct the default selector information and its conditional properties here."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"   //register selector\n   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {\n        //build selector\n        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());\n        selectorDTO.setHandle(selectorHandler);\n        //register default selector\n        return registerDefault(selectorDTO);\n    }\n     //build selector\n    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {\n        //build default\n        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);\n        selectorDTO.setPluginId(pluginId);\n         //build the conditional properties of the default selector\n        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));\n        return selectorDTO;\n    }\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Build default selector"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"private SelectorDTO buildDefaultSelectorDTO(final String name) {\n    return SelectorDTO.builder()\n            .name(name) // name\n            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // default type cutom\n            .matchMode(MatchModeEnum.AND.getCode()) //default match mode\n            .enabled(Boolean.TRUE)  //enable\n            .loged(Boolean.TRUE)  //log\n            .continued(Boolean.TRUE) \n            .sort(1) \n            .build();\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Build default selector conditional properties"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'private List<SelectorConditionDTO> buildDefaultSelectorConditionDTO(final String contextPath) {\n    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();\n    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // default URI\n    selectorConditionDTO.setParamName("/");\n    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // default  match\n    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); \n    return Collections.singletonList(selectorConditionDTO);\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Register default selector"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Override\npublic String registerDefault(final SelectorDTO selectorDTO) {\n    //selector information\n    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\n    //selector conditional properties\n    List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\n    if (StringUtils.isEmpty(selectorDTO.getId())) {\n        // insert selector information into the database\n        selectorMapper.insertSelective(selectorDO);\n          // inserting selector conditional properties to the database\n        selectorConditionDTOs.forEach(selectorConditionDTO -> {\n            selectorConditionDTO.setSelectorId(selectorDO.getId());            \n            selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\n        });\n    }\n    // Publish synchronization events to synchronize selection information and its conditional attributes to the gateway\n    publishEvent(selectorDO, selectorConditionDTOs);\n    return selectorDO.getId();\n}\n"})}),"\n",(0,i.jsx)(n.h6,{id:"1312-registration-rules",children:"1.3.1.2 Registration Rules"}),"\n",(0,i.jsx)(n.p,{children:"In the second step of registering the service, start building the default rules and then register the rules."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Override\n    public String register(final MetaDataRegisterDTO dto) {\n        //1. handle selector\n        //......\n        \n        //2. handle rule\n        \n        String ruleHandler = ruleHandler();\n        // build default rule\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\n        // register rule\n        ruleService.registerDefault(ruleDTO);\n        \n        //3. reigster metadata\n        //......\n        \n        //4. register ContextPath\n        //......\n        \n        return ShenyuResultMessage.SUCCESS;\n    }\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"    @Override\n    protected String ruleHandler() {\n        // default rule\n        return new DubboRuleHandle().toJson();\n    }\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Dubbo"})," plugin default rule handling properties."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class DubboRuleHandle implements RuleHandle {\n\n    /**\n     * dubbo version.\n     */\n    private String version;\n\n    /**\n     * group.\n     */\n    private String group;\n\n    /**\n     * retry.\n     */\n    private Integer retries = 0;\n\n    /**\n     * loadbalance:RANDOM\n     */\n    private String loadbalance = LoadBalanceEnum.RANDOM.getName();\n\n    /**\n     * timeout default 3000\n     */\n    private long timeout = Constants.TIME_OUT;\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"build default rule"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'  // build default rule\n    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {\n        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());\n    }\n   //  build default rule\n    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {\n        RuleDTO ruleDTO = RuleDTO.builder()\n                .selectorId(selectorId)\n                .name(ruleName) \n                .matchMode(MatchModeEnum.AND.getCode()) \n                .enabled(Boolean.TRUE) \n                .loged(Boolean.TRUE) \n                .sort(1)\n                .handle(ruleHandler)\n                .build();\n        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()\n                .paramType(ParamTypeEnum.URI.getName()) \n                .paramName("/")\n                .paramValue(path) \n                .build();\n        if (path.indexOf("*") > 1) {\n            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); \n        } else {\n            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); \n        }\n        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));\n        return ruleDTO;\n    }\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Registration rules: insert records to the database and publish events to the gateway for data synchronization."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'\n    @Override\n    public String registerDefault(final RuleDTO ruleDTO) {\n        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());\n        if (Objects.nonNull(exist)) {\n            return "";\n        }\n\n        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);\n        List<RuleConditionDTO> ruleConditions = ruleDTO.getRuleConditions();\n        if (StringUtils.isEmpty(ruleDTO.getId())) {\n            // insert rule information into the database\n            ruleMapper.insertSelective(ruleDO);\n            //insert  rule body conditional attributes into the database\n            ruleConditions.forEach(ruleConditionDTO -> {\n                ruleConditionDTO.setRuleId(ruleDO.getId());     \n                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));\n            });\n        }\n        // Publish events to the gateway for data synchronization\n        publishEvent(ruleDO, ruleConditions);\n        return ruleDO.getId();\n    }\n\n'})}),"\n",(0,i.jsx)(n.h6,{id:"1313-register-metadata",children:"1.3.1.3 Register Metadata"}),"\n",(0,i.jsxs)(n.p,{children:["Metadata is mainly used for ",(0,i.jsx)(n.code,{children:"RPC"})," service calls."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"   @Override\n    public String register(final MetaDataRegisterDTO dto) {\n        //1. register selector\n        //......\n        \n        //2. register rule\n        //......\n        \n        //3. register metadata\n        registerMetadata(dto);\n        \n        //4. register ContextPath\n        //......\n        \n        return ShenyuResultMessage.SUCCESS;\n    }\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"org.apache.shenyu.admin.service.register.ShenyuClientRegisterDubboServiceImpl#registerMetadata()"}),"\n",(0,i.jsx)(n.p,{children:"Insert or update metadata and then publish sync events to the gateway."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"    @Override\n    protected void registerMetadata(final MetaDataRegisterDTO dto) {\n            // get metaDataService\n            MetaDataService metaDataService = getMetaDataService();\n            MetaDataDO exist = metaDataService.findByPath(dto.getPath());\n            //insert or update metadata\n            metaDataService.saveOrUpdateMetaData(exist, dto);\n    }\n\n    @Override\n    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {\n        DataEventTypeEnum eventType;\n        // DTO->DO\n        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);\n        // insert data\n        if (Objects.isNull(exist)) {\n            Timestamp currentTime = new Timestamp(System.currentTimeMillis());\n            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());\n            metaDataDO.setDateCreated(currentTime);\n            metaDataDO.setDateUpdated(currentTime);\n            metaDataMapper.insert(metaDataDO);\n            eventType = DataEventTypeEnum.CREATE;\n        } else {\n            // update\n            metaDataDO.setId(exist.getId());\n            metaDataMapper.update(metaDataDO);\n            eventType = DataEventTypeEnum.UPDATE;\n        }\n        // Publish sync events to gateway\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,\n                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));\n    }\n"})}),"\n",(0,i.jsx)(n.h5,{id:"132-register-uri",children:"1.3.2 Register URI"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The server side receives the ",(0,i.jsx)(n.code,{children:"URI"})," information registered by the client and processes it."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'    @Override\n    public String registerURI(final String selectorName, final List<URIRegisterDTO> uriList) {\n        String result;\n        String key = key(selectorName);\n        try {\n            this.removeFallBack(key);\n            // register URI\n            result = this.doRegisterURI(selectorName, uriList);\n            logger.info("Register success: {},{}", selectorName, uriList);\n        } catch (Exception ex) {\n            logger.warn("Register exception: cause:{}", ex.getMessage());\n            result = "";\n            // Retry after registration failure\n            this.addFallback(key, new FallbackHolder(selectorName, uriList));\n        }\n        return result;\n    }\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Get a valid ",(0,i.jsx)(n.code,{children:"URI"})," from the ",(0,i.jsx)(n.code,{children:"URI"})," registered by the client, update the corresponding selector ",(0,i.jsx)(n.code,{children:"handle"})," property, and send a selector update event to the gateway."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Override\n    public String doRegisterURI(final String selectorName, final List<URIRegisterDTO> uriList) {\n        //check\n        if (CollectionUtils.isEmpty(uriList)) {\n            return "";\n        }\n        \n        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\n        if (Objects.isNull(selectorDO)) {\n            throw new ShenyuException("doRegister Failed to execute,wait to retry.");\n        }\n        // gte valid URI\n        List<URIRegisterDTO> validUriList = uriList.stream().filter(dto -> Objects.nonNull(dto.getPort()) && StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());\n        // build handle\n        String handler = buildHandle(validUriList, selectorDO);\n        if (handler != null) {\n            selectorDO.setHandle(handler);\n            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\n            selectorData.setHandle(handler);\n            // Update the handle property of the selector to the database\n            selectorService.updateSelective(selectorDO);\n            // Send selector update events to the gateway\n            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));\n        }\n        return ShenyuResultMessage.SUCCESS;\n    }\n'})}),"\n",(0,i.jsx)(n.p,{children:"The source code analysis on service registration is completed as well as the analysis flow chart is as follows."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(40341).A+"",width:"1916",height:"693"})}),"\n",(0,i.jsxs)(n.p,{children:["The next step is to analyze how the ",(0,i.jsx)(n.code,{children:"dubbo"})," plugin initiates calls to the ",(0,i.jsx)(n.code,{children:"http"})," service based on this information."]}),"\n",(0,i.jsx)(n.h3,{id:"2-service-invocation",children:"2. Service Invocation"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"dubbo"})," plugin is the core processing plugin used by the ",(0,i.jsx)(n.code,{children:"ShenYu"})," gateway to convert ",(0,i.jsx)(n.code,{children:"http"})," requests into the ",(0,i.jsx)(n.code,{children:"dubbo protocol"})," and invoke the ",(0,i.jsx)(n.code,{children:"dubbo"})," service."]}),"\n",(0,i.jsxs)(n.p,{children:["Take the case provided by the official website ",(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/docs/quick-start/quick-start-dubbo/",children:"Quick Start with Dubbo"})," as an example, a ",(0,i.jsx)(n.code,{children:"dubbo"})," service is registered with ",(0,i.jsx)(n.code,{children:"shenyu-admin"})," through the registry, and then requested through the ",(0,i.jsx)(n.code,{children:"ShenYu"})," gateway proxy, the request is as follows."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GET http://localhost:9195/dubbo/findById?id=100\nAccept: application/json\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The class inheritance relationship in the ",(0,i.jsx)(n.code,{children:"Dubbo"})," plugin is as follows."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(36148).A+"",width:"491",height:"627"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ShenyuPlugin: top-level interface, defining interface methods."}),"\n",(0,i.jsx)(n.li,{children:"AbstractShenyuPlugin: abstract class that implements plugin common logic."}),"\n",(0,i.jsxs)(n.li,{children:["AbstractDubboPlugin: dubbo plugin abstract class, implementing ",(0,i.jsx)(n.code,{children:"dubbo"})," common logic."]}),"\n",(0,i.jsx)(n.li,{children:"ApacheDubboPlugin: ApacheDubbo plugin."}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"ShenYu Gateway supports ApacheDubbo and AlibabaDubbo\\"}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"21-receive-requests",children:"2.1 Receive requests"}),"\n",(0,i.jsxs)(n.p,{children:["After passing the ",(0,i.jsx)(n.code,{children:"ShenYu"})," gateway proxy, the request entry is ",(0,i.jsx)(n.code,{children:"ShenyuWebHandler"}),", which implements the ",(0,i.jsx)(n.code,{children:"org.springframework.web.server.WebHandler"})," interface."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public final class ShenyuWebHandler implements WebHandler, ApplicationListener<SortPluginEvent> {\n    //......\n    \n    /**\n     * hanlde request\n     */\n    @Override\n    public Mono<Void> handle(@NonNull final ServerWebExchange exchange) {\n       // execute default plugin chain\n        Mono<Void> execute = new DefaultShenyuPluginChain(plugins).execute(exchange);\n        if (scheduled) {\n            return execute.subscribeOn(scheduler);\n        }\n        return execute;\n    }\n    \n    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {\n\n        private int index;\n\n        private final List<ShenyuPlugin> plugins;\n\n  \n        DefaultShenyuPluginChain(final List<ShenyuPlugin> plugins) {\n            this.plugins = plugins;\n        }\n\n        /**\n         * execute.\n         */\n        @Override\n        public Mono<Void> execute(final ServerWebExchange exchange) {\n            return Mono.defer(() -> {\n                if (this.index < plugins.size()) {\n                    // get plugin \n                    ShenyuPlugin plugin = plugins.get(this.index++);\n                    boolean skip = plugin.skip(exchange);\n                    if (skip) {\n                        // next\n                        return this.execute(exchange);\n                    }\n                    // execute\n                    return plugin.execute(exchange, this);\n                }\n                return Mono.empty();\n            });\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"22-match-rule",children:"2.2 Match Rule"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Execute the matching logic for selectors and rules in the ",(0,i.jsx)(n.code,{children:"execute()"})," method."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Matching selectors."}),"\n",(0,i.jsx)(n.li,{children:"Matching rules."}),"\n",(0,i.jsx)(n.li,{children:"Execute the plugin."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        // plugin name\n        String pluginName = named();\n        // plugin data\n        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);\n        if (pluginData != null && pluginData.getEnabled()) {\n            // selector data\n            final Collection<SelectorData> selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);\n            if (CollectionUtils.isEmpty(selectors)) {\n                return handleSelectorIfNull(pluginName, exchange, chain);\n            }\n            // match selector\n            SelectorData selectorData = matchSelector(exchange, selectors);\n            if (Objects.isNull(selectorData)) {\n                return handleSelectorIfNull(pluginName, exchange, chain);\n            }\n            selectorLog(selectorData, pluginName);\n            // rule data\n            List<RuleData> rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());\n            if (CollectionUtils.isEmpty(rules)) {\n                return handleRuleIfNull(pluginName, exchange, chain);\n            }\n            // match rule\n            RuleData rule;\n            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {\n                //get last\n                rule = rules.get(rules.size() - 1);\n            } else {\n                rule = matchRule(exchange, rules);\n            }\n            if (Objects.isNull(rule)) {\n                return handleRuleIfNull(pluginName, exchange, chain);\n            }\n            ruleLog(rule, pluginName);\n            // execute\n            return doExecute(exchange, chain, selectorData, rule);\n        }\n        return chain.execute(exchange);\n    }\n"})}),"\n",(0,i.jsx)(n.h4,{id:"23-execute-globalplugin",children:"2.3 Execute GlobalPlugin"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.global.GlobalPlugin#execute()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"GlobalPlugin"})," is a global plugin that constructs contextual information in the ",(0,i.jsx)(n.code,{children:"execute()"})," method."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class GlobalPlugin implements ShenyuPlugin {\n    // shenyu context\n    private final ShenyuContextBuilder builder;\n    \n    //......\n    \n    @Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n       // build context information to be passed into the exchange\n        ShenyuContext shenyuContext = builder.build(exchange);\n        exchange.getAttributes().put(Constants.CONTEXT, shenyuContext);\n        return chain.execute(exchange);\n    }\n    \n    //......\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.global.DefaultShenyuContextBuilder#build()"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Build the default context information."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class DefaultShenyuContextBuilder implements ShenyuContextBuilder {\n    //......\n    \n    @Override\n    public ShenyuContext build(final ServerWebExchange exchange) {\n        //build data\n        Pair<String, MetaData> buildData = buildData(exchange);\n        //wrap ShenyuContext\n        return decoratorMap.get(buildData.getLeft()).decorator(buildDefaultContext(exchange.getRequest()), buildData.getRight());\n    }\n    \n    private Pair<String, MetaData> buildData(final ServerWebExchange exchange) {\n        //......\n        //get the metadata according to the requested uri\n        MetaData metaData = MetaDataCache.getInstance().obtain(request.getURI().getPath());\n        if (Objects.nonNull(metaData) && Boolean.TRUE.equals(metaData.getEnabled())) {\n            exchange.getAttributes().put(Constants.META_DATA, metaData);\n            return Pair.of(metaData.getRpcType(), metaData);\n        } else {\n            return Pair.of(RpcTypeEnum.HTTP.getName(), new MetaData());\n        }\n    }\n    //set the default context information\n    private ShenyuContext buildDefaultContext(final ServerHttpRequest request) {\n        String appKey = request.getHeaders().getFirst(Constants.APP_KEY);\n        String sign = request.getHeaders().getFirst(Constants.SIGN);\n        String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);\n        ShenyuContext shenyuContext = new ShenyuContext();\n        String path = request.getURI().getPath();\n        shenyuContext.setPath(path); \n        shenyuContext.setAppKey(appKey);\n        shenyuContext.setSign(sign);\n        shenyuContext.setTimestamp(timestamp);\n        shenyuContext.setStartDateTime(LocalDateTime.now());\n        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -> shenyuContext.setHttpMethod(httpMethod.name()));\n        return shenyuContext;\n    }\n }\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.dubbo.common.context.DubboShenyuContextDecorator#decorator()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["wrap ",(0,i.jsx)(n.code,{children:"ShenyuContext"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class DubboShenyuContextDecorator implements ShenyuContextDecorator {\n    \n    @Override\n    public ShenyuContext decorator(final ShenyuContext shenyuContext, final MetaData metaData) {\n        shenyuContext.setModule(metaData.getAppName());\n        shenyuContext.setMethod(metaData.getServiceName()); \n        shenyuContext.setContextPath(metaData.getContextPath()); \n        shenyuContext.setRpcType(RpcTypeEnum.DUBBO.getName()); \n        return shenyuContext;\n    }\n    \n    @Override\n    public String rpcType() {\n        return RpcTypeEnum.DUBBO.getName();\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"24-execute-rpcparamtransformplugin",children:"2.4 Execute RpcParamTransformPlugin"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"RpcParamTransformPlugin"})," is responsible for reading the parameters from the ",(0,i.jsx)(n.code,{children:"http"})," request, saving them in the ",(0,i.jsx)(n.code,{children:"exchange"})," and passing them to the ",(0,i.jsx)(n.code,{children:"rpc"})," service."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.base.RpcParamTransformPlugin#execute()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"execute()"})," method, the core logic of the plugin is executed: get the request information from ",(0,i.jsx)(n.code,{children:"exchange"})," and process the parameters according to the form of content passed in by the request."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class RpcParamTransformPlugin implements ShenyuPlugin {\n\n    @Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        //get request information from exchange\n        ServerHttpRequest request = exchange.getRequest();\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\n        if (Objects.nonNull(shenyuContext)) {\n           // APPLICATION_JSON\n            MediaType mediaType = request.getHeaders().getContentType();\n            if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {\n                return body(exchange, request, chain);\n            }\n            // APPLICATION_FORM_URLENCODED\n            if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {\n                return formData(exchange, request, chain);\n            }\n            //query\n            return query(exchange, request, chain);\n        }\n        return chain.execute(exchange);\n    }\n    \n    //APPLICATION_JSON\n    private Mono<Void> body(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\n        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())\n                .flatMap(body -> {\n                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, resolveBodyFromRequest(body));//\u89e3\u6790body\uff0c\u4fdd\u5b58\u5230exchange\u4e2d\n                    return chain.execute(exchange);\n                }));\n    }\n   // APPLICATION_FORM_URLENCODED\n    private Mono<Void> formData(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\n        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())\n                .flatMap(map -> {\n                    String param = resolveBodyFromRequest(map);\n                    LinkedMultiValueMap<String, String> linkedMultiValueMap;\n                    try {\n                        linkedMultiValueMap = BodyParamUtils.buildBodyParams(URLDecoder.decode(param, StandardCharsets.UTF_8.name())); //\u683c\u5f0f\u5316\u6570\u636e\n                    } catch (UnsupportedEncodingException e) {\n                        return Mono.error(e);\n                    }\n                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.toMap(() -> linkedMultiValueMap));// \u4fdd\u5b58\u5230exchange\u4e2d\n                    return chain.execute(exchange);\n                }));\n    }\n    //query\n    private Mono<Void> query(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\n        exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.ofString(() -> serverHttpRequest.getURI().getQuery()));//\u4fdd\u5b58\u5230exchange\u4e2d\n        return chain.execute(exchange);\n    }\n    //......\n }\n"})}),"\n",(0,i.jsx)(n.h4,{id:"25-execute-dubboplugin",children:"2.5 Execute DubboPlugin"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.dubbo.common.AbstractDubboPlugin#doExecute()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"doExecute()"})," method, the main purpose is to check the metadata and parameters."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public abstract class AbstractDubboPlugin extends AbstractShenyuPlugin {\n    \n    @Override\n    public Mono<Void> doExecute(final ServerWebExchange exchange,\n                                   final ShenyuPluginChain chain,\n                                   final SelectorData selector,\n                                   final RuleData rule) {\n        //param\n        String param = exchange.getAttribute(Constants.PARAM_TRANSFORM);\n        //context\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\n        assert shenyuContext != null;\n        //metaData\n        MetaData metaData = exchange.getAttribute(Constants.META_DATA);\n        //check metaData\n        if (!checkMetaData(metaData)) {\n            LOG.error(" path is : {}, meta data have error : {}", shenyuContext.getPath(), metaData);\n            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.META_DATA_ERROR, null);\n            return WebFluxResultUtils.result(exchange, error);\n        }\n        //check\n        if (Objects.nonNull(metaData) && StringUtils.isNoneBlank(metaData.getParameterTypes()) && StringUtils.isBlank(param)) {\n            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.DUBBO_HAVE_BODY_PARAM, null);\n            return WebFluxResultUtils.result(exchange, error);\n        }\n        //set rpcContext\n        this.rpcContext(exchange);\n        //dubbo invoke\n        return this.doDubboInvoker(exchange, chain, selector, rule, metaData, param);\n    }\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.apache.dubbo.ApacheDubboPlugin#doDubboInvoker()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Set special context information in the ",(0,i.jsx)(n.code,{children:"doDubboInvoker()"})," method, and then start the dubbo generalization call."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class ApacheDubboPlugin extends AbstractDubboPlugin {\n    \n    @Override\n    protected Mono<Void> doDubboInvoker(final ServerWebExchange exchange,\n                                        final ShenyuPluginChain chain,\n                                        final SelectorData selector,\n                                        final RuleData rule,\n                                        final MetaData metaData,\n                                        final String param) {\n        //set the current selector and rule information, and request address for dubbo graying support\n        RpcContext.getContext().setAttachment(Constants.DUBBO_SELECTOR_ID, selector.getId());\n        RpcContext.getContext().setAttachment(Constants.DUBBO_RULE_ID, rule.getId());\n        RpcContext.getContext().setAttachment(Constants.DUBBO_REMOTE_ADDRESS, Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress());\n        //dubbo generic invoker\n        final Mono<Object> result = dubboProxyService.genericInvoker(param, metaData, exchange);\n        //execute next plugin in chain\n        return result.then(chain.execute(exchange));\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.apache.dubbo.proxy.ApacheDubboProxyService#genericInvoker()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"genericInvoker()"})," method."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Gets the ",(0,i.jsx)(n.code,{children:"ReferenceConfig"})," object."]}),"\n",(0,i.jsxs)(n.li,{children:["Gets the generalization service ",(0,i.jsx)(n.code,{children:"GenericService"})," object."]}),"\n",(0,i.jsxs)(n.li,{children:["Constructs the request parameter ",(0,i.jsx)(n.code,{children:"pair"})," object."]}),"\n",(0,i.jsx)(n.li,{children:"Initiates an asynchronous generalization invocation."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class ApacheDubboProxyService {\n    //...... \n\n    /**\n     * Generic invoker object.\n     */\n    public Mono<Object> genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws ShenyuException {\n        //1.Get the ReferenceConfig object\n        ReferenceConfig<GenericService> reference = ApacheDubboConfigCache.getInstance().get(metaData.getPath());\n\n        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) {\n            //Failure of the current cache information\n            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());\n            //Reinitialization with metadata\n            reference = ApacheDubboConfigCache.getInstance().initRef(metaData);\n        }\n        //2.Get the GenericService object of the generalization service\n        GenericService genericService = reference.get();\n        //3.Constructing the request parameter pair object\n        Pair<String[], Object[]> pair;\n        if (StringUtils.isBlank(metaData.getParameterTypes()) || ParamCheckUtils.dubboBodyIsEmpty(body)) {\n            pair = new ImmutablePair<>(new String[]{}, new Object[]{});\n        } else {\n            pair = dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());\n        }\n        //4.Initiating asynchronous generalization calls\n        return Mono.fromFuture(invokeAsync(genericService, metaData.getMethodName(), pair.getLeft(), pair.getRight()).thenApply(ret -> {\n            //handle result\n            if (Objects.isNull(ret)) {\n                ret = Constants.DUBBO_RPC_RESULT_EMPTY;\n            }\n            exchange.getAttributes().put(Constants.RPC_RESULT, ret);\n            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());\n            return ret;\n        })).onErrorMap(exception -> exception instanceof GenericException ? new ShenyuException(((GenericException) exception).getExceptionMessage()) : new ShenyuException(exception));//\u5904\u7406\u5f02\u5e38\n    }\n    \n    //Generalized calls, asynchronous operations\n    private CompletableFuture<Object> invokeAsync(final GenericService genericService, final String method, final String[] parameterTypes, final Object[] args) throws GenericException {\n        genericService.$invoke(method, parameterTypes, args);\n        Object resultFromFuture = RpcContext.getContext().getFuture();\n        return resultFromFuture instanceof CompletableFuture ? (CompletableFuture<Object>) resultFromFuture : CompletableFuture.completedFuture(resultFromFuture);\n    }\n}\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Calling the ",(0,i.jsx)(n.code,{children:"dubbo"})," service at the gateway can be achieved by generalizing the call."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"ReferenceConfig"})," object is the key object to support generalization calls , and its initialization operation is done during data synchronization. There are two parts of data involved here, one is the synchronized plugin ",(0,i.jsx)(n.code,{children:"handler"})," information and the other is the synchronized plugin metadata information."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.dubbo.common.handler.AbstractDubboPluginDataHandler#handlerPlugin()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["When the plugin data is updated, the data synchronization module synchronizes the data from ",(0,i.jsx)(n.code,{children:"shenyu-admin"})," to the gateway. The initialization operation is performed in ",(0,i.jsx)(n.code,{children:"handlerPlugin()"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public abstract class AbstractDubboPluginDataHandler implements PluginDataHandler {\n    //......\n    \n    //Initializing the configuration cache\n   protected abstract void initConfigCache(DubboRegisterConfig dubboRegisterConfig);\n\n    @Override\n    public void handlerPlugin(final PluginData pluginData) {\n        if (Objects.nonNull(pluginData) && Boolean.TRUE.equals(pluginData.getEnabled())) {\n            //Data deserialization\n            DubboRegisterConfig dubboRegisterConfig = GsonUtils.getInstance().fromJson(pluginData.getConfig(), DubboRegisterConfig.class);\n            DubboRegisterConfig exist = Singleton.INST.get(DubboRegisterConfig.class);\n            if (Objects.isNull(dubboRegisterConfig)) {\n                return;\n            }\n            if (Objects.isNull(exist) || !dubboRegisterConfig.equals(exist)) {\n                // Perform initialization operations\n                this.initConfigCache(dubboRegisterConfig);\n            }\n            Singleton.INST.single(DubboRegisterConfig.class, dubboRegisterConfig);\n        }\n    }\n    //......\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.apache.dubbo.handler.ApacheDubboPluginDataHandler#initConfigCache()"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Perform initialization operations."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class ApacheDubboPluginDataHandler extends AbstractDubboPluginDataHandler {\n\n    @Override\n    protected void initConfigCache(final DubboRegisterConfig dubboRegisterConfig) {\n        //perform initialization operations\n        ApacheDubboConfigCache.getInstance().init(dubboRegisterConfig);\n        //cached results before failure\n        ApacheDubboConfigCache.getInstance().invalidateAll();\n    }\n}\n\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#init()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In the initialization, set ",(0,i.jsx)(n.code,{children:"registryConfig"})," and ",(0,i.jsx)(n.code,{children:"consumerConfig"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public final class ApacheDubboConfigCache extends DubboConfigCache {\n    //......  \n   /**\n     * init\n     */\n    public void init(final DubboRegisterConfig dubboRegisterConfig) {\n        //ApplicationConfig\n        if (Objects.isNull(applicationConfig)) {\n            applicationConfig = new ApplicationConfig("shenyu_proxy");\n        }\n        //When the protocol or address changes, you need to update the registryConfig\n        if (needUpdateRegistryConfig(dubboRegisterConfig)) {\n            RegistryConfig registryConfigTemp = new RegistryConfig();\n            registryConfigTemp.setProtocol(dubboRegisterConfig.getProtocol());\n            registryConfigTemp.setId("shenyu_proxy");\n            registryConfigTemp.setRegister(false);\n            registryConfigTemp.setAddress(dubboRegisterConfig.getRegister());            Optional.ofNullable(dubboRegisterConfig.getGroup()).ifPresent(registryConfigTemp::setGroup);\n            registryConfig = registryConfigTemp;\n        }\n        //ConsumerConfig\n        if (Objects.isNull(consumerConfig)) {\n            consumerConfig = ApplicationModel.getConfigManager().getDefaultConsumer().orElseGet(() -> {\n                ConsumerConfig consumerConfig = new ConsumerConfig();\n                consumerConfig.refresh();\n                return consumerConfig;\n            });\n           \n            //ConsumerConfig\n            Optional.ofNullable(dubboRegisterConfig.getThreadpool()).ifPresent(consumerConfig::setThreadpool); \n            Optional.ofNullable(dubboRegisterConfig.getCorethreads()).ifPresent(consumerConfig::setCorethreads);\n            Optional.ofNullable(dubboRegisterConfig.getThreads()).ifPresent(consumerConfig::setThreads);\n            Optional.ofNullable(dubboRegisterConfig.getQueues()).ifPresent(consumerConfig::setQueues);\n        }\n    }\n    \n    //Does the registration configuration need to be updated\n    private boolean needUpdateRegistryConfig(final DubboRegisterConfig dubboRegisterConfig) {\n        if (Objects.isNull(registryConfig)) {\n            return true;\n        }\n        return !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol())\n                || !Objects.equals(dubboRegisterConfig.getRegister(), registryConfig.getAddress())\n                || !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol());\n    }\n\n    //......\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.apache.dubbo.subscriber.ApacheDubboMetaDataSubscriber#onSubscribe()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["When the metadata is updated, the data synchronization module synchronizes the data from ",(0,i.jsx)(n.code,{children:"shenyu-admin"})," to the gateway. The metadata update operation is performed in the ",(0,i.jsx)(n.code,{children:"onSubscribe()"})," method."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class ApacheDubboMetaDataSubscriber implements MetaDataSubscriber {\n    //local memory cache\n    private static final ConcurrentMap<String, MetaData> META_DATA = Maps.newConcurrentMap();\n\n    //update metaData\n    public void onSubscribe(final MetaData metaData) {\n        // dubbo\n        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {\n            //Whether the corresponding metadata exists\n            MetaData exist = META_DATA.get(metaData.getPath());\n            if (Objects.isNull(exist) || Objects.isNull(ApacheDubboConfigCache.getInstance().get(metaData.getPath()))) {\n                // initRef\n                ApacheDubboConfigCache.getInstance().initRef(metaData);\n            } else {\n                // The corresponding metadata has undergone an update operation\n                if (!Objects.equals(metaData.getServiceName(), exist.getServiceName())\n                        || !Objects.equals(metaData.getRpcExt(), exist.getRpcExt())\n                        || !Objects.equals(metaData.getParameterTypes(), exist.getParameterTypes())\n                        || !Objects.equals(metaData.getMethodName(), exist.getMethodName())) {\n                    //Build ReferenceConfig again based on the latest metadata\n                    ApacheDubboConfigCache.getInstance().build(metaData);\n                }\n            }\n            //local memory cache\n            META_DATA.put(metaData.getPath(), metaData);\n        }\n    }\n\n    //dalete\n    public void unSubscribe(final MetaData metaData) {\n        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {\n            //\u4f7fReferenceConfig\u5931\u6548\n            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());\n            META_DATA.remove(metaData.getPath());\n        }\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#initRef()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Build ",(0,i.jsx)(n.code,{children:"ReferenceConfig"})," objects from ",(0,i.jsx)(n.code,{children:"metaData"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public final class ApacheDubboConfigCache extends DubboConfigCache {\n    //......\n    \n    public ReferenceConfig<GenericService> initRef(final MetaData metaData) {\n            try {\n                //First try to get it from the cache, and return it directly if it exists\n                ReferenceConfig<GenericService> referenceConfig = cache.get(metaData.getPath());\n                if (StringUtils.isNoneBlank(referenceConfig.getInterface())) {\n                    return referenceConfig;\n                }\n            } catch (ExecutionException e) {\n                LOG.error("init dubbo ref exception", e);\n            }\n          \n            //build if not exist\n            return build(metaData);\n        }\n\n        /**\n         * Build reference config.\n         */\n        @SuppressWarnings("deprecation")\n        public ReferenceConfig<GenericService> build(final MetaData metaData) {\n            if (Objects.isNull(applicationConfig) || Objects.isNull(registryConfig)) {\n                return new ReferenceConfig<>();\n            }\n            ReferenceConfig<GenericService> reference = new ReferenceConfig<>(); //ReferenceConfig\n            reference.setGeneric("true"); //generic invoke\n            reference.setAsync(true);//async\n\n            reference.setApplication(applicationConfig);//applicationConfig\n            reference.setRegistry(registryConfig);//registryConfig\n            reference.setConsumer(consumerConfig);//consumerConfig\n            reference.setInterface(metaData.getServiceName());//serviceName\n            reference.setProtocol("dubbo");//dubbo\n            reference.setCheck(false); \n            reference.setLoadbalance("gray");//gray\n\n            Map<String, String> parameters = new HashMap<>(2);\n            parameters.put("dispatcher", "direct");\n            reference.setParameters(parameters);\n\n            String rpcExt = metaData.getRpcExt();//rpc ext param\n            DubboParam dubboParam = parserToDubboParam(rpcExt);\n            if (Objects.nonNull(dubboParam)) {\n                if (StringUtils.isNoneBlank(dubboParam.getVersion())) {\n                    reference.setVersion(dubboParam.getVersion());//version\n                }\n                if (StringUtils.isNoneBlank(dubboParam.getGroup())) {\n                    reference.setGroup(dubboParam.getGroup());//group\n                }\n                if (StringUtils.isNoneBlank(dubboParam.getUrl())) {\n                    reference.setUrl(dubboParam.getUrl());//url\n                }\n                if (StringUtils.isNoneBlank(dubboParam.getCluster())) {\n                    reference.setCluster(dubboParam.getCluster());\n                }\n                Optional.ofNullable(dubboParam.getTimeout()).ifPresent(reference::setTimeout);//timeout\n                Optional.ofNullable(dubboParam.getRetries()).ifPresent(reference::setRetries);//retires\n                Optional.ofNullable(dubboParam.getSent()).ifPresent(reference::setSent);//Whether to ack async-sent\n            }\n            try {\n                //get GenericService\n                Object obj = reference.get();\n                if (Objects.nonNull(obj)) {\n                    LOG.info("init apache dubbo reference success there meteData is :{}", metaData);\n                    //cache reference\n                    cache.put(metaData.getPath(), reference);\n                }\n            } catch (Exception e) {\n                LOG.error("init apache dubbo reference exception", e);\n            }\n            return reference;\n        }\n    //......\n    }\n'})}),"\n",(0,i.jsx)(n.h4,{id:"26-execute-responseplugin",children:"2.6 Execute ResponsePlugin"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.response.ResponsePlugin#execute()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The response results are handled by the ",(0,i.jsx)(n.code,{children:"ResponsePlugin"})," plugin."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"    @Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\n        assert shenyuContext != null;\n        // handle results according to rpc type\n        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);\n    }\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The processing type is determined by ",(0,i.jsx)(n.code,{children:"MessageWriter"})," and the class inheritance relationship is as follows."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(28191).A+"",width:"1426",height:"290"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"MessageWriter: interface, defining message processing methods."}),"\n",(0,i.jsxs)(n.li,{children:["NettyClientMessageWriter: processing of ",(0,i.jsx)(n.code,{children:"Netty"})," call results."]}),"\n",(0,i.jsxs)(n.li,{children:["RPCMessageWriter: processing the results of ",(0,i.jsx)(n.code,{children:"RPC"})," calls."]}),"\n",(0,i.jsxs)(n.li,{children:["WebClientMessageWriter: processing the results of ",(0,i.jsx)(n.code,{children:"WebClient"})," calls."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Dubbo"})," service call, the processing result is ",(0,i.jsx)(n.code,{children:"RPCMessageWriter"})," of course."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"org.apache.shenyu.plugin.response.strategy.RPCMessageWriter#writeWith()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Process the response results in the ",(0,i.jsx)(n.code,{children:"writeWith()"})," method."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"\npublic class RPCMessageWriter implements MessageWriter {\n\n    @Override\n    public Mono<Void> writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        return chain.execute(exchange).then(Mono.defer(() -> {\n            Object result = exchange.getAttribute(Constants.RPC_RESULT); //result\n            if (Objects.isNull(result)) { \n                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);\n                return WebFluxResultUtils.result(exchange, error);\n            }\n            return WebFluxResultUtils.result(exchange, result);\n        }));\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["At this point in the analysis, the source code analysis of the ",(0,i.jsx)(n.code,{children:"Dubbo"})," plugin is complete, and the analysis flow chart is as follows."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(85333).A+"",width:"2496",height:"499"})}),"\n",(0,i.jsx)(n.h3,{id:"3-summary",children:"3. Summary"}),"\n",(0,i.jsxs)(n.p,{children:["The source code analysis in this article starts from ",(0,i.jsx)(n.code,{children:"Dubbo"})," service registration to ",(0,i.jsx)(n.code,{children:"Dubbo"})," plug-in service calls. The ",(0,i.jsx)(n.code,{children:"Dubbo"})," plugin is mainly used to handle the conversion of ",(0,i.jsx)(n.code,{children:"http"})," requests to the ",(0,i.jsx)(n.code,{children:"dubbo"})," protocol, and the main logic is implemented through generalized calls."]})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},28191:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>l});var i=t(96540);const r={},a=i.createContext(r);function s(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(a.Provider,{value:n},e.children)}},36148:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/ApacheDubboPlugin-286a36694f3fa121e7d3c7d67d08b833.png"},40341:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/dubbo-register-en-37db6c1d92c1763193e88e60de554e93.png"},48532:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/ShenyuClientRegisterDubboServiceImpl-a48cc4b745cb6a47ee000cf08d4cff04.png"},85333:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/dubbo-execute-en-230f6fe5b81c0ab5d10ed68025c16020.png"}}]);