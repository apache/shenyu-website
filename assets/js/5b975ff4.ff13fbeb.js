"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[53845],{28453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>a});var l=i(96540);const s={},r=l.createContext(s);function t(e){const n=l.useContext(r);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),l.createElement(r.Provider,{value:n},e.children)}},75433:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var l=i(74848),s=i(28453);const r={title:"Custom Plugin",keywords:["Custom Plugin"],description:"plugins"},t=void 0,a={id:"developer/custom-plugin",title:"Custom Plugin",description:"plugins",source:"@site/versioned_docs/version-2.6.1/developer/custom-plugin.md",sourceDirName:"developer",slug:"/developer/custom-plugin",permalink:"/docs/2.6.1/developer/custom-plugin",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/shenyu-website/edit/main/versioned_docs/version-2.6.1/developer/custom-plugin.md",tags:[],version:"2.6.1",frontMatter:{title:"Custom Plugin",keywords:["Custom Plugin"],description:"plugins"},sidebar:"tutorialSidebar",previous:{title:"Fetching Correct IP Address And Host",permalink:"/docs/2.6.1/developer/custom-parsing-ip-and-host"},next:{title:"Custom Response",permalink:"/docs/2.6.1/developer/custom-result"}},d={},c=[{value:"Description",id:"description",level:2},{value:"Single Responsibility Plugins",id:"single-responsibility-plugins",level:2},{value:"Matching Traffic Processing Plugin",id:"matching-traffic-processing-plugin",level:2},{value:"Subscribe your plugin data and do customized jobs",id:"subscribe-your-plugin-data-and-do-customized-jobs",level:2},{value:"Dynamic loading",id:"dynamic-loading",level:2},{value:"Plugin loading path details",id:"plugin-loading-path-details",level:4},{value:"Plugin jar upload",id:"plugin-jar-upload",level:2}];function o(e){const n={a:"a",code:"code",h2:"h2",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h2,{id:"description",children:"Description"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Plugins are core executors of ",(0,l.jsx)(n.code,{children:"Apache ShenYu"})," gateway. Every plugin handles matched requests when enabled."]}),"\n",(0,l.jsxs)(n.li,{children:["There are two kinds of plugins in the ",(0,l.jsx)(n.code,{children:"Apache ShenYu"})," gateway.","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"The first type is a chain with single responsibility, and can not custom filtering of traffic."}),"\n",(0,l.jsx)(n.li,{children:"The other one can do its own chain of responsibility for matched traffic."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["You could reference from ",(0,l.jsx)(n.a,{href:"https://github.com/apache/shenyu/tree/master/shenyu-plugin",children:"shenyu-plugin"})," module and develop plugins by yourself. Please fire pull requests of your wonderful plugins without hesitate."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"single-responsibility-plugins",children:"Single Responsibility Plugins"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Add following dependency:"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.apache.shenyu</groupId>\n    <artifactId>shenyu-plugin-api</artifactId>\n    <version>${project.version}</version>\n</dependency>\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Declare a new class named ",(0,l.jsx)(n.code,{children:"MyShenyuPlugin"})," and implements ",(0,l.jsx)(n.code,{children:"org.apache.shenyu.plugin.api.ShenyuPlugin"})]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public interface ShenyuPlugin {\n\n    /**\n     * Process the Web request and (optionally) delegate to the next\n     * {@code WebFilter} through the given {@link ShenyuPluginChain}.\n     *\n     * @param exchange the current server exchange\n     * @param chain    provides a way to delegate to the next filter\n     * @return {@code Mono<Void>} to indicate when request processing is complete\n     */\n    Mono<Void> execute(ServerWebExchange exchange, ShenyuPluginChain chain);\n\n    /**\n     * return plugin order .\n     * This attribute To determine the plugin execution order in the same type plugin.\n     *\n     * @return int order\n     */\n    int getOrder();\n\n    /**\n     * acquire plugin name.\n     * this is plugin name define you must offer the right name.\n     * if you impl AbstractShenyuPlugin this attribute not use.\n     *\n     * @return plugin name.\n     */\n    default String named() {\n        return "";\n    }\n\n    /**\n     * plugin is execute.\n     * if return true this plugin can not execute.\n     *\n     * @param exchange the current server exchange\n     * @return default false.\n     */\n    default Boolean skip(ServerWebExchange exchange) {\n        return false;\n    }\n}\n\n'})}),"\n",(0,l.jsx)(n.p,{children:"Detailed instruction of interface methods:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"execute()"})," core method, you can do any task here freely."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"getOrder()"})," get the order of current plugin."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"named()"})," acquire the name of specific plugin that uses the ",(0,l.jsx)(n.code,{children:"Camel Case"}),", eg: ",(0,l.jsx)(n.code,{children:"dubbo"}),", ",(0,l.jsx)(n.code,{children:"springCloud"})," ."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"skip()"})," determines whether this plugin should be skipped under certain conditions."]}),"\n",(0,l.jsxs)(n.li,{children:["Register plugin in ",(0,l.jsx)(n.code,{children:"Spring"})," as a ",(0,l.jsx)(n.code,{children:"Bean"}),", or simply apply ",(0,l.jsx)(n.code,{children:"@Component"})," in implementation class."]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"    @Bean\n    public ShenyuPlugin myShenyuPlugin() {\n        return new MyShenyuPlugin();\n    }\n"})}),"\n",(0,l.jsx)(n.h2,{id:"matching-traffic-processing-plugin",children:"Matching Traffic Processing Plugin"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Introduce the following dependency:"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:" <dependency>\n        <groupId>org.apache.shenyu</groupId>\n        <artifactId>shenyu-plugin-base</artifactId>\n        <version>${project.version}</version>\n  </dependency>\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Add a new class ",(0,l.jsx)(n.code,{children:"CustomPlugin"}),", inherit from ",(0,l.jsx)(n.code,{children:"org.apache.shenyu.plugin.base.AbstractShenyuPlugin"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"examples down below:"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'/**\n * This is your custom plugin.\n * He is running in after before plugin, implement your own functionality.\n * extends AbstractShenyuPlugin so you must user shenyu-admin And add related plug-in development.\n *\n * @author xiaoyu(Myth)\n */\npublic class CustomPlugin extends AbstractShenyuPlugin {\n\n    /**\n     * return plugin order .\n     * The same plugin he executes in the same order.\n     *\n     * @return int\n     */\n    @Override\n    public int getOrder() {\n        return 0;\n    }\n\n    /**\n     * acquire plugin name.\n     * return you custom plugin name.\n     * It must be the same name as the plug-in you added in the admin background.\n     *\n     * @return plugin name.\n     */\n    @Override\n    public String named() {\n        return "shenYu";\n    }\n\n    /**\n     * plugin is execute.\n     * Do I need to skip.\n     * if you need skip return true.\n     *\n     * @param exchange the current server exchange\n     * @return default false.\n     */\n    @Override\n    public Boolean skip(final ServerWebExchange exchange) {\n        return false;\n    }\n\n    /**\n     * this is Template Method child has Implement your own logic.\n     *\n     * @param exchange exchange the current server exchange\n     * @param chain    chain the current chain\n     * @param selector selector\n     * @param rule     rule\n     * @return {@code Mono<Void>} to indicate when request handling is complete\n     */\n    @Override\n    protected abstract Mono<Void> doExecute(ServerWebExchange exchange, ShenyuPluginChain chain, SelectorData selector, RuleData rule) {\n        LOGGER.debug(".......... function plugin start..............");\n        /*\n         * Processing after your selector matches the rule.\n         * rule.getHandle() is you Customize the json string to be processed.\n         * for this example.\n         * Convert your custom json string pass to an entity class.\n         */\n        final String ruleHandle = rule.getHandle();\n\n        final Test test = GsonUtils.getInstance().fromJson(ruleHandle, Test.class);\n\n        /*\n         * Then do your own business processing.\n         * The last execution  chain.execute(exchange).\n         * Let it continue on the chain until the end.\n         */\n        System.out.println(test.toString());\n        return chain.execute(exchange);\n    }\n}\n\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Detailed explanation:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Plugins will match the selector rule for customized plugins inherit from this abstract class."}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Firstly define a new plugin in ",(0,l.jsx)(n.code,{children:"shenyu-admin"}),"  \u2013> BasicConfig \u2013> Plugin, please mind that your plugin name should match the ",(0,l.jsx)(n.code,{children:"named()"})," method overridden in your class."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Re-login  ",(0,l.jsx)(n.code,{children:"shenyu-admin"}),", the plugin you added now showing on plugin-list page, you can choose selectors for matching."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["There is a field named ",(0,l.jsx)(n.code,{children:"handler"})," in rules, it is customized json string to be processed. You can process data after acquiring a ruleHandle (",(0,l.jsx)(n.code,{children:"final String ruleHandle = rule.getHandle();"}),") in ",(0,l.jsx)(n.code,{children:"doExecute()"})," method."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Register plugin in ",(0,l.jsx)(n.code,{children:"Spring"})," as a ",(0,l.jsx)(n.code,{children:"Bean"}),", or simply apply ",(0,l.jsx)(n.code,{children:"@Component"})," in implementation class."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"    @Bean\n    public ShenyuPlugin customPlugin() {\n        return new CustomPlugin();\n    }\n"})}),"\n",(0,l.jsx)(n.h2,{id:"subscribe-your-plugin-data-and-do-customized-jobs",children:"Subscribe your plugin data and do customized jobs"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Declare a new class named ",(0,l.jsx)(n.code,{children:"PluginDataHandler"})," and implements ",(0,l.jsx)(n.code,{children:"org.apache.shenyu.plugin.base.handler.PluginDataHandler"})]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public interface PluginDataHandler {\n\n    /**\n     * Handler plugin.\n     *\n     * @param pluginData the plugin data\n     */\n    default void handlerPlugin(PluginData pluginData) {\n    }\n\n    /**\n     * Remove plugin.\n     *\n     * @param pluginData the plugin data\n     */\n    default void removePlugin(PluginData pluginData) {\n    }\n\n    /**\n     * Handler selector.\n     *\n     * @param selectorData the selector data\n     */\n    default void handlerSelector(SelectorData selectorData) {\n    }\n\n    /**\n     * Remove selector.\n     *\n     * @param selectorData the selector data\n     */\n    default void removeSelector(SelectorData selectorData) {\n    }\n\n    /**\n     * Handler rule.\n     *\n     * @param ruleData the rule data\n     */\n    default void handlerRule(RuleData ruleData) {\n    }\n\n    /**\n     * Remove rule.\n     *\n     * @param ruleData the rule data\n     */\n    default void removeRule(RuleData ruleData) {\n    }\n\n    /**\n     * Plugin named string.\n     *\n     * @return the string\n     */\n    String pluginNamed();\n\n}\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Ensure ",(0,l.jsx)(n.code,{children:"pluginNamed()"})," is same as the plugin name you defined."]}),"\n",(0,l.jsxs)(n.li,{children:["Register defined class as a ",(0,l.jsx)(n.code,{children:"Spring Bean"}),", or simply apply ",(0,l.jsx)(n.code,{children:"@Component"})," in implementation class."]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"@Bean\npublic PluginDataHandler pluginDataHandler() {\n  return new PluginDataHandler();\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"dynamic-loading",children:"Dynamic loading"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["When using this feature, the above extensions ",(0,l.jsx)(n.code,{children:"ShenyuPlugin"}),", ",(0,l.jsx)(n.code,{children:"PluginDataHandler"}),", do not need to be ",(0,l.jsx)(n.code,{children:"spring bean"}),". You just need to build the jar package of the extension project."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Config in Yaml\uff1a"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"shenyu:\n  extPlugin:\n    path:  //Load the extension plugin jar package path\n    enabled: true //Whether to turn on \n    threads: 1  //Number of loading plug-in threads\n    scheduleTime: 300  //Cycle time (in seconds)\n    scheduleDelay: 30 //How long the shenyu gateway is delayed to load after it starts (in seconds)\n"})}),"\n",(0,l.jsx)(n.h4,{id:"plugin-loading-path-details",children:"Plugin loading path details"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"This path is for the directory where the extended plugin jar package is stored\u3002"}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Used ",(0,l.jsx)(n.code,{children:"-Dplugin-ext=xxxx"}),", Also used ",(0,l.jsx)(n.code,{children:"shenyu.extPlugin.path"})," in yaml\uff0cIf neither is configured, the ",(0,l.jsx)(n.code,{children:"ext-lib"})," directory in the apache shenyu gateway boot path will be loaded by default."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Priority \uff1a",(0,l.jsx)(n.code,{children:"-Dplugin-ext=xxxx"})," > ",(0,l.jsx)(n.code,{children:"shenyu.extPlugin.path"})," > ",(0,l.jsx)(n.code,{children:"ext-lib(default)"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"plugin-jar-upload",children:"Plugin jar upload"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["To use this feature, you will need to package the ",(0,l.jsx)(n.code,{children:"ShenyuPlugin"})," extension as a custom ShenyuPlugin Jar"]}),"\n",(0,l.jsxs)(n.li,{children:["Configure it in ShenyuAdmin","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["use  ",(0,l.jsx)(n.code,{children:"ShenyuAdmin - BasicConfig - Plugin"})," add plugin in ",(0,l.jsx)(n.code,{children:"pluginJar"})," click upload button"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Custom ShenyuPlugin can be started by loading third-party jars into the ",(0,l.jsx)(n.code,{children:"-cp"})," directory if it depends on other third-party packages in shenyu-bootstrap"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Tips:"}),"\n",(0,l.jsx)(n.p,{children:"The Upload jar package plugin supports hot loading\nIf you need to modify the jar online. You can make a new jar. And raise the version number, for example '1.0.1' to '1.0.2'"})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}}}]);