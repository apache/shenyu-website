"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[8983],{28453:(n,e,a)=>{a.d(e,{R:()=>l,x:()=>i});var s=a(96540);const t={},o=s.createContext(t);function l(n){const e=s.useContext(o);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:l(n.components),s.createElement(o.Provider,{value:e},n.children)}},83289:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>r,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var s=a(74848),t=a(28453);const o={sidebar_position:4,title:"K8s Deployment",keywords:["k8s"],description:"K8s Deployment"},l=void 0,i={id:"deployment/deployment-k8s",title:"K8s Deployment",description:"K8s Deployment",source:"@site/versioned_docs/version-2.4.1/deployment/deployment-k8s.md",sourceDirName:"deployment",slug:"/deployment/deployment-k8s",permalink:"/docs/2.4.1/deployment/deployment-k8s",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/shenyu-website/edit/main/versioned_docs/version-2.4.1/deployment/deployment-k8s.md",tags:[],version:"2.4.1",sidebarPosition:4,frontMatter:{sidebar_position:4,title:"K8s Deployment",keywords:["k8s"],description:"K8s Deployment"},sidebar:"tutorialSidebar",previous:{title:"Docker Deployment",permalink:"/docs/2.4.1/deployment/deployment-docker"},next:{title:"Helm Deployment",permalink:"/docs/2.4.1/deployment/deployment-helm"}},r={},c=[{value:"I. Using h2 as a database",id:"i-using-h2-as-a-database",level:2},{value:"1. Create Namespace and ConfigMap",id:"1-create-namespace-and-configmap",level:3},{value:"2. Create shenyu-admin",id:"2-create-shenyu-admin",level:3},{value:"3. Create shenyu-bootstrap",id:"3-create-shenyu-bootstrap",level:3},{value:"II. Use MySQL as the database",id:"ii-use-mysql-as-the-database",level:2},{value:"1. Create Namespace and ConfigMap",id:"1-create-namespace-and-configmap-1",level:3},{value:"2. Create Endpoints to represent MySQL",id:"2-create-endpoints-to-represent-mysql",level:3},{value:"3. Create PV to store mysql-connector.jar",id:"3-create-pv-to-store-mysql-connectorjar",level:3},{value:"4. Create shenyu-admin",id:"4-create-shenyu-admin",level:3},{value:"3. Create shenyu-bootstrap",id:"3-create-shenyu-bootstrap-1",level:3}];function p(n){const e={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(e.p,{children:["This article introduces the use of ",(0,s.jsx)(e.code,{children:"K8s"})," to deploy the ",(0,s.jsx)(e.code,{children:"Apache ShenYu"})," gateway."]}),"\n",(0,s.jsxs)(e.blockquote,{children:["\n",(0,s.jsx)(e.p,{children:"Catalog"}),"\n",(0,s.jsx)(e.p,{children:"I. Using h2 as a database"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"create Namespace and ConfigMap"}),"\n",(0,s.jsx)(e.li,{children:"deploying shenyu-admin"}),"\n",(0,s.jsx)(e.li,{children:"deploy shenyu-bootstrap\nII. Use MySQL as the database"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"Similar to the h2 process, there are two points to note"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["you need to load ",(0,s.jsx)(e.a,{href:"https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.18/mysql-connector-java-8.0.18.jar",children:"mysql-connector.jar"}),", so you need a place to store the file"]}),"\n",(0,s.jsx)(e.li,{children:"you need to specify an external MySQL database configuration to proxy the external MySQL database via Endpoints"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"The process is as follows."}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"create Namespace and ConfigMap"}),"\n",(0,s.jsx)(e.li,{children:"create Endpoints to proxy external MySQL"}),"\n",(0,s.jsx)(e.li,{children:"create PV store mysql-connector.jar"}),"\n",(0,s.jsx)(e.li,{children:"deploy shenyu-admin"}),"\n",(0,s.jsx)(e.li,{children:"deploy shenyu-bootstrap"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"i-using-h2-as-a-database",children:"I. Using h2 as a database"}),"\n",(0,s.jsx)(e.h3,{id:"1-create-namespace-and-configmap",children:"1. Create Namespace and ConfigMap"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-ns.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Namespace\nmetadata:\n  name: shenyu\n  labels:\n    name: shenyu\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: shenyu-cm\n  namespace: shenyu\ndata:\n  application-local.yml: |\n    server:\n        port: 9195\n        address: 0.0.0.0\n    spring:\n        main:\n            allow-bean-definition-overriding: true\n        application:\n            name: shenyu-bootstrap\n    management:\n        health:\n            defaults:\n            enabled: false\n    shenyu:\n          cross:\n            enabled: true\n            allowedHeaders:\n            allowedMethods: "*"\n            allowedOrigin: "*"\n            allowedExpose: "*"\n            maxAge: "18000"\n            allowCredentials: true\n          switchConfig:\n            local: true\n          file:\n            enabled: true\n            maxSize : 10\n          exclude:\n            enabled: false\n            paths:\n              - /favicon.ico\n          extPlugin:\n            path:\n            enabled: true\n            threads: 1\n            scheduleTime: 300\n            scheduleDelay: 30\n           sync:\n            websocket:\n              urls: ws://shenyu-admin-svc.shenyu.svc.cluster.local:9095/websocket\n           scheduler:\n            enabled: false\n            type: fixed\n            threads: 16\n    logging:\n        level:\n            root: info\n            org.springframework.boot: info\n            org.apache.ibatis: info\n            org.apache.shenyu.bonuspoint: info\n            org.apache.shenyu.lottery: info\n            org.apache.shenyu: info\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute ",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-ns.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"2-create-shenyu-admin",children:"2. Create shenyu-admin"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-admin.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"# Example of using the nodeport type to expose ports\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: shenyu\n  name: shenyu-admin-svc\nspec:\n  selector:\n    app: shenyu-admin\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 9095\n    targetPort: 9095\n    nodePort: 31095\n---\n# shenyu-admin\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: shenyu\n  name: shenyu-admin\nspec:\n  selector:\n    matchLabels:\n      app: shenyu-admin\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: shenyu-admin\n    spec:\n      containers:\n      - name: shenyu-admin\n        image: apache/shenyu-admin:2.4.1\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 9095\n        env:\n        - name: 'TZ'\n          value: 'Asia/Beijing'\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-admin.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"3-create-shenyu-bootstrap",children:"3. Create shenyu-bootstrap"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-bootstrap.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"# Example of using the nodeport type to expose ports\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: shenyu\n  name: shenyu-bootstrap-svc\nspec:\n  selector:\n    app: shenyu-bootstrap\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 9195\n    targetPort: 9195\n    nodePort: 31195\n---\n# shenyu-bootstrap\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: shenyu\n  name: shenyu-bootstrap\nspec:\n  selector:\n    matchLabels:\n      app: shenyu-bootstrap\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: shenyu-bootstrap\n    spec:\n      volumes:\n      - name: shenyu-bootstrap-config\n        configMap:\n          name: shenyu-cm\n          items:\n          - key: application-local.yml\n            path: application-local.yml\n      containers:\n      - name: shenyu-bootstrap\n        image: apache/shenyu-bootstrap:2.4.1\n        ports:\n        - containerPort: 9195\n        env:\n        - name: TZ\n          value: Asia/Beijing\n        volumeMounts:\n        - name: shenyu-bootstrap-config\n          mountPath: /opt/shenyu-bootstrap/conf/application-local.yml\n          subPath: application-local.yml\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute ",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-bootstrap.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"ii-use-mysql-as-the-database",children:"II. Use MySQL as the database"}),"\n",(0,s.jsx)(e.h3,{id:"1-create-namespace-and-configmap-1",children:"1. Create Namespace and ConfigMap"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-ns.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Namespace\nmetadata:\n  name: shenyu\n  labels:\n    name: shenyu\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: shenyu-cm\n  namespace: shenyu\ndata:\n  application-local.yml: |\n    server:\n        port: 9195\n        address: 0.0.0.0\n    spring:\n        main:\n            allow-bean-definition-overriding: true\n        application:\n            name: shenyu-bootstrap\n    management:\n        health:\n            defaults:\n            enabled: false\n    shenyu:\n          cross:\n            enabled: true\n            allowedHeaders:\n            allowedMethods: "*"\n            allowedOrigin: "*"\n            allowedExpose: "*"\n            maxAge: "18000"\n            allowCredentials: true\n          switchConfig:\n            local: true\n          file:\n            enabled: true\n            maxSize : 10\n          exclude:\n            enabled: false\n            paths:\n              - /favicon.ico\n          extPlugin:\n            path:\n            enabled: true\n            threads: 1\n            scheduleTime: 300\n            scheduleDelay: 30\n           sync:\n            websocket:\n              urls: ws://shenyu-admin-svc.shenyu.svc.cluster.local:9095/websocket\n           scheduler:\n            enabled: false\n            type: fixed\n            threads: 16\n    logging:\n        level:\n            root: info\n            org.springframework.boot: info\n            org.apache.ibatis: info\n            org.apache.shenyu.bonuspoint: info\n            org.apache.shenyu.lottery: info\n            org.apache.shenyu: info\n  application-mysql.yml: |\n    spring.datasource.url: jdbc:mysql://mysql.shenyu.svc.cluster.local:3306/shenyu?useUnicode=true&characterEncoding=utf-8&useSSL=false\n    spring.datasource.username: {your_mysql_user}\n    spring.datasource.password: {your_mysql_password}\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute ",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-ns.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"2-create-endpoints-to-represent-mysql",children:"2. Create Endpoints to represent MySQL"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-ep.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"kind: Service\napiVersion: v1\nmetadata:\n  name: mysql\n  namespace: shenyu\nspec:\n  ports:\n  - port: 3306\n    name: mysql\n    targetPort: {your_mysql_port}\n---\nkind: Endpoints\napiVersion: v1\nmetadata:\n  name: mysql\n  namespace: shenyu\nsubsets:\n- addresses:\n  - ip: {your_mysql_ip}\n  ports:\n  - port: {your_mysql_port}\n    name: mysql\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute ",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-ep.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"3-create-pv-to-store-mysql-connectorjar",children:"3. Create PV to store mysql-connector.jar"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-store.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"# Example of using PVC\u3001PV\u3001StorageClass to store jar file\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: shenyu-pv\nspec:\n  capacity:\n    storage: 1Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /home/shenyu/shenyu-admin/k8s-pv  # Specify the directory on the node, which should contain `mysql-connector.jar`\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - {your_node_name} # Specify node\n---\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: shenyu-pvc\n  namespace: shenyu\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n  storageClassName: local-storage\n---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute ",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-pv.yaml"})]}),"\n",(0,s.jsxs)(e.li,{children:["PV mounted directory upload ",(0,s.jsx)(e.code,{children:"mysql-connector.jar"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"4-create-shenyu-admin",children:"4. Create shenyu-admin"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-admin.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"# Example of using the nodeport type to expose ports\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: shenyu\n  name: shenyu-admin-svc\nspec:\n  selector:\n    app: shenyu-admin\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 9095\n    targetPort: 9095\n    nodePort: 31095\n---\n# shenyu-admin\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: shenyu\n  name: shenyu-admin\nspec:\n  selector:\n    matchLabels:\n      app: shenyu-admin\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: shenyu-admin\n    spec:\n      volumes:\n      - name: mysql-connector-volume\n        persistentVolumeClaim:\n          claimName: shenyu-pvc\n      - name: shenyu-admin-config\n        configMap:\n          name: shenyu-cm\n          items:\n          - key: application-mysql.yml\n            path: application-mysql.yml\n      containers:\n      - name: shenyu-admin\n        image: apache/shenyu-admin:2.4.1\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 9095\n        env:\n        - name: 'TZ'\n          value: 'Asia/Beijing'\n        - name: SPRING_PROFILES_ACTIVE\n          value: mysql\n        volumeMounts:\n        - name: shenyu-admin-config\n          mountPath: /opt/shenyu-admin/config/application-mysql.yml\n          subPath: application-mysql.yml\n        - mountPath: /opt/shenyu-admin/ext-lib\n          name: mysql-connector-volume\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-admin.yaml"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"3-create-shenyu-bootstrap-1",children:"3. Create shenyu-bootstrap"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"create shenyu-bootstrap.yaml"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:"# Example of using the nodeport type to expose ports\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: shenyu\n  name: shenyu-bootstrap-svc\nspec:\n  selector:\n    app: shenyu-bootstrap\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 9195\n    targetPort: 9195\n    nodePort: 31195\n---\n# shenyu-bootstrap\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: shenyu\n  name: shenyu-bootstrap\nspec:\n  selector:\n    matchLabels:\n      app: shenyu-bootstrap\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: shenyu-bootstrap\n    spec:\n      volumes:\n      - name: shenyu-bootstrap-config\n        configMap:\n          name: shenyu-cm\n          items:\n          - key: application-local.yml\n            path: application-local.yml\n      containers:\n      - name: shenyu-bootstrap\n        image: apache/shenyu-bootstrap:2.4.1\n        ports:\n        - containerPort: 9195\n        env:\n        - name: TZ\n          value: Asia/Beijing\n        volumeMounts:\n        - name: shenyu-bootstrap-config\n          mountPath: /opt/shenyu-bootstrap/conf/application-local.yml\n          subPath: application-local.yml\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["execute ",(0,s.jsx)(e.code,{children:"kubectl apply -f shenyu-bootstrap.yaml"})]}),"\n"]})]})}function d(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(p,{...n})}):p(n)}}}]);