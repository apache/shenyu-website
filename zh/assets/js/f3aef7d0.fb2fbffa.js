"use strict";(self.webpackChunkshenyu_website=self.webpackChunkshenyu_website||[]).push([[32240],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>b});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var u=a.createContext({}),s=function(e){var n=a.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},p=function(e){var n=s(e.components);return a.createElement(u.Provider,{value:n},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,u=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=s(t),d=r,b=c["".concat(u,".").concat(d)]||c[d]||g[d]||i;return t?a.createElement(b,l(l({ref:n},p),{},{components:t})):a.createElement(b,l({ref:n},p))}));function b(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=d;var o={};for(var u in n)hasOwnProperty.call(n,u)&&(o[u]=n[u]);o.originalType=e,o[c]="string"==typeof e?e:r,l[1]=o;for(var s=2;s<i;s++)l[s]=t[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},10735:(e,n,t)=>{t.r(n),t.d(n,{contentTitle:()=>l,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>u});var a=t(87462),r=(t(67294),t(3905));const i={title:"Dubbo\u63d2\u4ef6\u6e90\u7801\u5206\u6790",author:"midnight2104",author_title:"Apache ShenYu Committer",author_url:"https://github.com/midnight2104",tags:["plugin","dubbo","Apache ShenYu"]},l=void 0,o={permalink:"/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin",editUrl:"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Dubbo-Plugin.md",source:"@site/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Dubbo-Plugin.md",title:"Dubbo\u63d2\u4ef6\u6e90\u7801\u5206\u6790",description:"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002",date:"2023-04-02T11:39:27.293Z",formattedDate:"2023\u5e744\u67082\u65e5",tags:[{label:"plugin",permalink:"/zh/blog/tags/plugin"},{label:"dubbo",permalink:"/zh/blog/tags/dubbo"},{label:"Apache ShenYu",permalink:"/zh/blog/tags/apache-shen-yu"}],readingTime:28.74,truncated:!1,prevItem:{title:"Divide\u63d2\u4ef6\u6e90\u7801\u5206\u6790",permalink:"/zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin"},nextItem:{title:"SPI\u8bbe\u8ba1\u5b9e\u73b0\u6e90\u7801\u5206\u6790",permalink:"/zh/blog/SPI-SourceCode-Analysis-SPI"}},u=[{value:"1. \u670d\u52a1\u6ce8\u518c",id:"1-\u670d\u52a1\u6ce8\u518c",children:[]},{value:"2. \u670d\u52a1\u8c03\u7528",id:"2-\u670d\u52a1\u8c03\u7528",children:[]},{value:"3. \u5c0f\u7ed3",id:"3-\u5c0f\u7ed3",children:[]}],s={toc:u},p="wrapper";function c(e){let{components:n,...i}=e;return(0,r.kt)(p,(0,a.Z)({},s,i,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/zh/docs/index"},"Apache ShenYu")," \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"API")," \u7f51\u5173\u3002")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Apache ShenYu")," \u7f51\u5173\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo")," \u63d2\u4ef6\u5b8c\u6210\u5bf9 ",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u670d\u52a1\u7684\u8c03\u7528\u3002\u4f60\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 ",(0,r.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/docs/quick-start/quick-start-dubbo"},"Dubbo\u5feb\u901f\u5f00\u59cb")," \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8be5\u63d2\u4ef6\u3002"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u672c\u6587\u57fa\u4e8e",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-2.4.3"),"\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 ",(0,r.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/zh/docs/user-guide/dubbo-proxy/"},"Dubbo\u670d\u52a1\u63a5\u5165")," \u3002")),(0,r.kt)("h3",{id:"1-\u670d\u52a1\u6ce8\u518c"},"1. \u670d\u52a1\u6ce8\u518c"),(0,r.kt)("p",null,"\u4ee5\u5b98\u7f51\u63d0\u4f9b\u7684\u4f8b\u5b50\u4e3a\u4f8b ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-dubbo/shenyu-examples-apache-dubbo-service"},"shenyu-examples-dubbo")," \u3002 \u5047\u5982\u4f60\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u670d\u52a1\u5b9a\u4e49\u5982\u4e0b(",(0,r.kt)("inlineCode",{parentName:"p"},"spring-dubbo.xml"),")\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<beans xmlns="http://www.springframework.org/schema/beans"\n       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"\n       xsi:schemaLocation="http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans.xsd\n       http://code.alibabatech.com/schema/dubbo\n       https://code.alibabatech.com/schema/dubbo/dubbo.xsd">\n\n    <dubbo:application name="test-dubbo-service"/>\n    <dubbo:registry address="${dubbo.registry.address}"/>\n    <dubbo:protocol name="dubbo" port="20888"/>\n\n    <dubbo:service timeout="10000" interface="org.apache.shenyu.examples.dubbo.api.service.DubboTestService" ref="dubboTestService"/>\n\n</beans>\n')),(0,r.kt)("p",null,"\u58f0\u660e\u5e94\u7528\u670d\u52a1\u540d\u79f0\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u534f\u8bae\uff0c\u58f0\u660e\u670d\u52a1\u63a5\u53e3\uff0c\u5bf9\u5e94\u63a5\u53e3\u5b9e\u73b0\u7c7b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * DubboTestServiceImpl.\n */\n@Service("dubboTestService")\npublic class DubboTestServiceImpl implements DubboTestService {\n    \n    @Override\n    @ShenyuDubboClient(path = "/findById", desc = "Query by Id")\n    public DubboTest findById(final String id) {\n        return new DubboTest(id, "hello world shenyu Apache, findById");\n    }\n\n    //......\n}\n')),(0,r.kt)("p",null,"\u5728\u63a5\u53e3\u5b9e\u73b0\u7c7b\u4e2d\uff0c\u4f7f\u7528\u6ce8\u89e3",(0,r.kt)("inlineCode",{parentName:"p"},"@ShenyuDubboClient"),"\u5411",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u6ce8\u518c\u670d\u52a1\u3002\u8be5\u6ce8\u89e3\u7684\u4f5c\u7528\u53ca\u539f\u7406\uff0c\u7a0d\u540e\u518d\u8fdb\u884c\u5206\u6790\u3002"),(0,r.kt)("p",null,"\u5728\u914d\u7f6e\u6587\u4ef6",(0,r.kt)("inlineCode",{parentName:"p"},"application.yml"),"\u4e2d\u7684\u914d\u7f6e\u4fe1\u606f\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"server:\n  port: 8011\n  address: 0.0.0.0\n  servlet:\n    context-path: /\nspring:\n  main:\n    allow-bean-definition-overriding: true\ndubbo:\n  registry:\n    address: zookeeper://localhost:2181  # dubbo\u4f7f\u7528\u7684\u6ce8\u518c\u4e2d\u5fc3\n    \nshenyu:\n  register:\n    registerType: http #\u6ce8\u518c\u65b9\u5f0f\n    serverLists: http://localhost:9095 #\u6ce8\u518c\u5730\u5740\n    props:\n      username: admin \n      password: 123456\n  client:\n    dubbo:\n      props:\n        contextPath: /dubbo  \n        appName: dubbo\n\n")),(0,r.kt)("p",null,"\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u58f0\u660e",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u4f7f\u7528\u7684\u6ce8\u518c\u4e2d\u5fc3\u5730\u5740\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u670d\u52a1\u5411",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u6ce8\u518c\uff0c\u4f7f\u7528\u7684\u65b9\u5f0f\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"http"),"\uff0c\u6ce8\u518c\u5730\u5740\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:9095"),"\u3002"),(0,r.kt)("p",null,"\u5173\u4e8e\u6ce8\u518c\u65b9\u5f0f\u7684\u4f7f\u7528\uff0c\u8bf7\u53c2\u8003 ",(0,r.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/docs/design/register-center-design/"},"\u5e94\u7528\u5ba2\u6237\u7aef\u63a5\u5165")," \u3002"),(0,r.kt)("h4",{id:"11--\u58f0\u660e\u6ce8\u518c\u63a5\u53e3"},"1.1  \u58f0\u660e\u6ce8\u518c\u63a5\u53e3"),(0,r.kt)("p",null,"\u4f7f\u7528\u6ce8\u89e3",(0,r.kt)("inlineCode",{parentName:"p"},"@ShenyuDubboClient"),"\u5c06\u670d\u52a1\u6ce8\u518c\u5230\u7f51\u5173\u3002\u7b80\u5355",(0,r.kt)("inlineCode",{parentName:"p"},"demo"),"\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'// dubbo\u670d\u52a1\n@Service("dubboTestService")\npublic class DubboTestServiceImpl implements DubboTestService {\n    \n    @Override\n    @ShenyuDubboClient(path = "/findById", desc = "Query by Id") // \u9700\u8981\u6ce8\u518c\u7684\u65b9\u6cd5\n    public DubboTest findById(final String id) {\n        return new DubboTest(id, "hello world shenyu Apache, findById");\n    }\n\n    //......\n}\n')),(0,r.kt)("p",null,"\u6ce8\u89e3\u5b9a\u4e49\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u4f5c\u7528\u4e8e\u7c7b\u548c\u65b9\u6cd5\u4e0a\n */\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE, ElementType.METHOD})\n@Inherited\npublic @interface ShenyuDubboClient {\n    \n    //\u6ce8\u518c\u8def\u5f84\n    String path();\n    \n    //\u89c4\u5219\u540d\u79f0\n    String ruleName() default "";\n   \n    //\u63cf\u8ff0\u4fe1\u606f\n    String desc() default "";\n\n    //\u662f\u5426\u542f\u7528\n    boolean enabled() default true;\n}\n\n')),(0,r.kt)("h4",{id:"12-\u626b\u63cf\u6ce8\u89e3\u4fe1\u606f"},"1.2 \u626b\u63cf\u6ce8\u89e3\u4fe1\u606f"),(0,r.kt)("p",null,"\u6ce8\u89e3\u626b\u63cf\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"ApacheDubboServiceBeanListener"),"\u5b8c\u6210\uff0c\u5b83\u5b9e\u73b0\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"ApplicationListener<ContextRefreshedEvent>"),"\u63a5\u53e3\uff0c\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"Spring"),"\u5bb9\u5668\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u751f\u4e0a\u4e0b\u6587\u5237\u65b0\u4e8b\u4ef6\u65f6\uff0c\u5f00\u59cb\u6267\u884c\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5",(0,r.kt)("inlineCode",{parentName:"p"},"onApplicationEvent()"),"\u3002"),(0,r.kt)("p",null,"\u5728\u6784\u9020\u5668\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e"),(0,r.kt)("li",{parentName:"ul"},"\u5f00\u542f\u7ebf\u7a0b\u6c60"),(0,r.kt)("li",{parentName:"ul"},"\u542f\u52a8\u6ce8\u518c\u4e2d\u5fc3\uff0c\u7528\u4e8e\u5411",(0,r.kt)("inlineCode",{parentName:"li"},"shenyu-admin"),"\u6ce8\u518c")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public class ApacheDubboServiceBeanListener implements ApplicationListener<ContextRefreshedEvent> {\n\n    // ......\n\n    //\u6784\u9020\u5668\n    public ApacheDubboServiceBeanListener(final PropertiesConfig clientConfig, final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\n        //1.\u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\n        Properties props = clientConfig.getProps();\n        String contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);\n        String appName = props.getProperty(ShenyuClientConstants.APP_NAME);\n        if (StringUtils.isBlank(contextPath)) {\n            throw new ShenyuClientIllegalArgumentException("apache dubbo client must config the contextPath or appName");\n        }\n        this.contextPath = contextPath;\n        this.appName = appName;\n        this.host = props.getProperty(ShenyuClientConstants.HOST);\n        this.port = props.getProperty(ShenyuClientConstants.PORT);\n        //2.\u5f00\u542f\u7ebf\u7a0b\u6c60\n        executorService = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder().setNameFormat("shenyu-apache-dubbo-client-thread-pool-%d").build());\n        //3.\u542f\u52a8\u6ce8\u518c\u4e2d\u5fc3\n        publisher.start(shenyuClientRegisterRepository);\n    }\n\n    /**\n     * \u4e0a\u4e0b\u6587\u5237\u65b0\u4e8b\u4ef6\uff0c\u6267\u884c\u65b9\u6cd5\u903b\u8f91\n     */\n    @Override\n    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {\n        //......\n    }\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ApacheDubboServiceBeanListener#onApplicationEvent()")),(0,r.kt)("p",null,"\u91cd\u5199\u7684\u65b9\u6cd5\u903b\u8f91\uff1a\u8bfb\u53d6",(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u670d\u52a1",(0,r.kt)("inlineCode",{parentName:"p"},"ServiceBean"),"\uff0c\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\u548c",(0,r.kt)("inlineCode",{parentName:"p"},"URI"),"\u5bf9\u8c61\uff0c\u5e76\u5411",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u6ce8\u518c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"    @Override\n    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {\n        //\u8bfb\u53d6ServiceBean\n        Map<String, ServiceBean> serviceBean = contextRefreshedEvent.getApplicationContext().getBeansOfType(ServiceBean.class);\n        if (serviceBean.isEmpty()) {\n            return;\n        }\n        //\u4fdd\u8bc1\u8be5\u65b9\u6cd5\u53ea\u6267\u884c\u4e00\u6b21\n        if (!registered.compareAndSet(false, true)) {\n            return;\n        }\n        //\u5904\u7406\u5143\u6570\u636e\u5bf9\u8c61\n        for (Map.Entry<String, ServiceBean> entry : serviceBean.entrySet()) {\n            handler(entry.getValue());\n        }\n        //\u5904\u7406URI\u5bf9\u8c61\n        serviceBean.values().stream().findFirst().ifPresent(bean -> {\n            publisher.publishEvent(buildURIRegisterDTO(bean));\n        });\n    }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"handler()"),(0,r.kt)("p",{parentName:"li"},"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"handler()"),"\u65b9\u6cd5\u4e2d\uff0c\u4ece",(0,r.kt)("inlineCode",{parentName:"p"},"serviceBean"),"\u4e2d\u8bfb\u53d6\u6240\u6709\u65b9\u6cd5\uff0c\u5224\u65ad\u65b9\u6cd5\u4e0a\u662f\u5426\u6709",(0,r.kt)("inlineCode",{parentName:"p"},"ShenyuDubboClient"),"\u6ce8\u89e3\uff0c\u5982\u679c\u5b58\u5728\u5c31\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u5e76\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5411",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u6ce8\u518c\u8be5\u65b9\u6cd5\u3002"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"    private void handler(final ServiceBean<?> serviceBean) {\n        //\u83b7\u53d6\u4ee3\u7406\u5bf9\u8c61\n        Object refProxy = serviceBean.getRef();\n        //\u83b7\u53d6class\u4fe1\u606f\n        Class<?> clazz = refProxy.getClass();\n        if (AopUtils.isAopProxy(refProxy)) {\n            clazz = AopUtils.getTargetClass(refProxy);\n        }\n        //\u83b7\u53d6\u6240\u6709\u65b9\u6cd5\n        Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);\n        for (Method method : methods) {\n            //\u8bfb\u53d6ShenyuDubboClient\u6ce8\u89e3\u4fe1\u606f\n            ShenyuDubboClient shenyuDubboClient = method.getAnnotation(ShenyuDubboClient.class);\n            if (Objects.nonNull(shenyuDubboClient)) {\n                //\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u5e76\u6ce8\u518c\n                publisher.publishEvent(buildMetaDataDTO(serviceBean, shenyuDubboClient, method));\n            }\n        }\n    }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"buildMetaDataDTO()"),(0,r.kt)("p",{parentName:"li"},"\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u5728\u8fd9\u91cc\u6784\u5efa\u65b9\u6cd5\u6ce8\u518c\u7684\u5fc5\u8981\u4fe1\u606f\uff0c\u540e\u7eed\u7528\u4e8e\u9009\u62e9\u5668\u6216\u89c4\u5219\u5339\u914d\u3002"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'    private MetaDataRegisterDTO buildMetaDataDTO(final ServiceBean<?> serviceBean, final ShenyuDubboClient shenyuDubboClient, final Method method) {\n        //\u5e94\u7528\u540d\u79f0\n        String appName = buildAppName(serviceBean);\n        //\u65b9\u6cd5\u8def\u5f84\n        String path = contextPath + shenyuDubboClient.path();\n        //\u63cf\u8ff0\u4fe1\u606f\n        String desc = shenyuDubboClient.desc();\n        //\u670d\u52a1\u540d\u79f0\n        String serviceName = serviceBean.getInterface();\n        //\u89c4\u5219\u540d\u79f0\n        String configRuleName = shenyuDubboClient.ruleName();\n        String ruleName = ("".equals(configRuleName)) ? path : configRuleName;\n        //\u65b9\u6cd5\u540d\u79f0\n        String methodName = method.getName();\n        //\u53c2\u6570\u7c7b\u578b\n        Class<?>[] parameterTypesClazz = method.getParameterTypes();\n        String parameterTypes = Arrays.stream(parameterTypesClazz).map(Class::getName).collect(Collectors.joining(","));\n        return MetaDataRegisterDTO.builder()\n                .appName(appName)\n                .serviceName(serviceName)\n                .methodName(methodName)\n                .contextPath(contextPath)\n                .host(buildHost())\n                .port(buildPort(serviceBean))\n                .path(path)\n                .ruleName(ruleName)\n                .pathDesc(desc)\n                .parameterTypes(parameterTypes)\n                .rpcExt(buildRpcExt(serviceBean)) //dubbo\u670d\u52a1\u7684\u6269\u5c55\u4fe1\u606f\n                .rpcType(RpcTypeEnum.DUBBO.getName())\n                .enabled(shenyuDubboClient.enabled())\n                .build();\n    }\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"buildRpcExt()"),(0,r.kt)("p",{parentName:"li"}," ",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u670d\u52a1\u7684\u6269\u5c55\u4fe1\u606f"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},'   private String buildRpcExt(final ServiceBean serviceBean) {\n       DubboRpcExt build = DubboRpcExt.builder()\n               .group(StringUtils.isNotEmpty(serviceBean.getGroup()) ? serviceBean.getGroup() : "")//\u5206\u7ec4\n               .version(StringUtils.isNotEmpty(serviceBean.getVersion()) ? serviceBean.getVersion() : "")//\u7248\u672c\n               .loadbalance(StringUtils.isNotEmpty(serviceBean.getLoadbalance()) ? serviceBean.getLoadbalance() : Constants.DEFAULT_LOADBALANCE)//\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u9ed8\u8ba4\u968f\u673a\n               .retries(Objects.isNull(serviceBean.getRetries()) ? Constants.DEFAULT_RETRIES : serviceBean.getRetries())//\u91cd\u8bd5\u6b21\u6570\uff0c\u9ed8\u8ba42\n               .timeout(Objects.isNull(serviceBean.getTimeout()) ? Constants.DEFAULT_CONNECT_TIMEOUT : serviceBean.getTimeout())//\u8d85\u65f6\uff0c\u9ed8\u8ba43000\n               .sent(Objects.isNull(serviceBean.getSent()) ? Constants.DEFAULT_SENT : serviceBean.getSent())//sent\uff0c\u9ed8\u8ba4false\n               .cluster(StringUtils.isNotEmpty(serviceBean.getCluster()) ? serviceBean.getCluster() : Constants.DEFAULT_CLUSTER)//\u96c6\u7fa4\u7b56\u7565\uff0c\u9ed8\u8ba4failover\n               .url("")\n               .build();\n       return GsonUtils.getInstance().toJson(build);\n   }\n')))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"buildURIRegisterDTO()"),(0,r.kt)("p",{parentName:"li"},"\u6784\u5efa",(0,r.kt)("inlineCode",{parentName:"p"},"URI"),"\u5bf9\u8c61\uff0c\u6ce8\u518c\u670d\u52a1\u672c\u8eab\u7684\u4fe1\u606f\uff0c\u540e\u7eed\u53ef\u7528\u4e8e\u670d\u52a1\u63a2\u6d3b\u3002"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"private URIRegisterDTO buildURIRegisterDTO(final ServiceBean serviceBean) {\n        return URIRegisterDTO.builder()\n                .contextPath(this.contextPath) //\u4e0a\u4e0b\u6587\u8def\u5f84\n                .appName(buildAppName(serviceBean))//\u5e94\u7528\u540d\u79f0\n                .rpcType(RpcTypeEnum.DUBBO.getName())//rpc\u7c7b\u578b\uff1adubbo\n                .host(buildHost()) //host\n                .port(buildPort(serviceBean))//port\n                .build();\n }\n")),(0,r.kt)("p",null,"\u5177\u4f53\u7684\u6ce8\u518c\u903b\u8f91\u7531\u6ce8\u518c\u4e2d\u5fc3\u5b9e\u73b0\uff0c\u8bf7\u53c2\u8003 ",(0,r.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/zh/docs/design/register-center-design/"},"\u5ba2\u6237\u7aef\u63a5\u5165\u539f\u7406")," \u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"//\u5411\u6ce8\u518c\u4e2d\u5fc3\uff0c\u53d1\u5e03\u6ce8\u518c\u4e8b\u4ef6   \npublisher.publishEvent();\n")),(0,r.kt)("h4",{id:"13-\u5904\u7406\u6ce8\u518c\u4fe1\u606f"},"1.3 \u5904\u7406\u6ce8\u518c\u4fe1\u606f"),(0,r.kt)("p",null,"\u5ba2\u6237\u7aef\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u6ce8\u518c\u7684\u5143\u6570\u636e\u548c",(0,r.kt)("inlineCode",{parentName:"p"},"URI"),"\u6570\u636e\uff0c\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u7aef\u8fdb\u884c\u5904\u7406\uff0c\u8d1f\u8d23\u5b58\u50a8\u5230\u6570\u636e\u5e93\u548c\u540c\u6b65\u7ed9",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu"),"\u7f51\u5173\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u63d2\u4ef6\u7684\u5ba2\u6237\u7aef\u6ce8\u518c\u5904\u7406\u903b\u8f91\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"ShenyuClientRegisterDubboServiceImpl"),"\u4e2d\u3002\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(85929).Z})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ShenyuClientRegisterService\uff1a\u5ba2\u6237\u7aef\u6ce8\u518c\u670d\u52a1\uff0c\u9876\u5c42\u63a5\u53e3\uff1b"),(0,r.kt)("li",{parentName:"ul"},"FallbackShenyuClientRegisterService\uff1a\u6ce8\u518c\u5931\u8d25\uff0c\u63d0\u4f9b\u91cd\u8bd5\u64cd\u4f5c\uff1b"),(0,r.kt)("li",{parentName:"ul"},"AbstractShenyuClientRegisterServiceImpl\uff1a\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0\u90e8\u5206\u516c\u5171\u6ce8\u518c\u903b\u8f91\uff1b"),(0,r.kt)("li",{parentName:"ul"},"ShenyuClientRegisterDubboServiceImpl\uff1a\u5b9e\u73b0",(0,r.kt)("inlineCode",{parentName:"li"},"Dubbo"),"\u63d2\u4ef6\u7684\u6ce8\u518c\uff1b")),(0,r.kt)("h5",{id:"131-\u6ce8\u518c\u670d\u52a1"},"1.3.1 \u6ce8\u518c\u670d\u52a1"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()"),(0,r.kt)("p",{parentName:"li"},"\u5ba2\u6237\u7aef\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u6ce8\u518c\u7684\u5143\u6570\u636e",(0,r.kt)("inlineCode",{parentName:"p"},"MetaDataRegisterDTO"),"\u5bf9\u8c61\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"register()"),"\u65b9\u6cd5\u88ab\u63a5\u9001\u5230\u3002"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"   @Override\n    public String register(final MetaDataRegisterDTO dto) {\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\n        String selectorHandler = selectorHandler(dto);\n        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);\n        //2. \u6ce8\u518c\u89c4\u5219\n        String ruleHandler = ruleHandler();\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\n        ruleService.registerDefault(ruleDTO);\n        //3. \u6ce8\u518c\u5143\u6570\u636e\n        registerMetadata(dto);\n        //4. \u6ce8\u518cContextPath\n        String contextPath = dto.getContextPath();\n        if (StringUtils.isNotEmpty(contextPath)) {\n            registerContextPath(dto);\n        }\n        return ShenyuResultMessage.SUCCESS;\n    }\n")),(0,r.kt)("h6",{id:"1311-\u6ce8\u518c\u9009\u62e9\u5668"},"1.3.1.1 \u6ce8\u518c\u9009\u62e9\u5668"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()")),(0,r.kt)("p",null,"\u6784\u5efa",(0,r.kt)("inlineCode",{parentName:"p"},"contextPath"),"\uff0c\u67e5\u627e\u9009\u62e9\u5668\u4fe1\u606f\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u5b58\u5728\u5c31\u8fd4\u56de",(0,r.kt)("inlineCode",{parentName:"p"},"id"),"\uff1b\u4e0d\u5b58\u5728\u5c31\u521b\u5efa\u9ed8\u8ba4\u7684\u9009\u62e9\u5668\u4fe1\u606f\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"    @Override\n    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {\n        // \u6784\u5efacontextPath\n        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());\n        // \u901a\u8fc7\u540d\u79f0\u67e5\u627e\u9009\u62e9\u5668\u4fe1\u606f\u662f\u5426\u5b58\u5728\n        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);\n        if (Objects.isNull(selectorDO)) {\n            // \u4e0d\u5b58\u5728\u5c31\u521b\u5efa\u9ed8\u8ba4\u7684\u9009\u62e9\u5668\u4fe1\u606f\n            return registerSelector(contextPath, pluginName, selectorHandler);\n        }\n        return selectorDO.getId();\n    }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u9ed8\u8ba4\u9009\u62e9\u5668\u4fe1\u606f"),(0,r.kt)("p",{parentName:"li"},"\u5728\u8fd9\u91cc\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u4fe1\u606f\u53ca\u5176\u6761\u4ef6\u5c5e\u6027\u3002"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"   //\u6ce8\u518c\u9009\u62e9\u5668\n   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {\n        //\u6784\u5efa\u9009\u62e9\u5668\n        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());\n        selectorDTO.setHandle(selectorHandler);\n        //\u6ce8\u518c\u9ed8\u8ba4\u9009\u62e9\u5668\n        return registerDefault(selectorDTO);\n    }\n     //\u6784\u5efa\u9009\u62e9\u5668\n    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {\n        //\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\n        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);\n        selectorDTO.setPluginId(pluginId);\n         //\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u7684\u6761\u4ef6\u5c5e\u6027\n        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));\n        return selectorDTO;\n    }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"private SelectorDTO buildDefaultSelectorDTO(final String name) {\n    return SelectorDTO.builder()\n            .name(name) // \u540d\u79f0\n            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // \u9ed8\u8ba4\u7c7b\u578b\u81ea\u5b9a\u4e49\n            .matchMode(MatchModeEnum.AND.getCode()) //\u9ed8\u8ba4\u5339\u914d\u65b9\u5f0f and\n            .enabled(Boolean.TRUE)  //\u9ed8\u8ba4\u542f\u5f00\u542f\n            .loged(Boolean.TRUE)  //\u9ed8\u8ba4\u8bb0\u5f55\u65e5\u5fd7\n            .continued(Boolean.TRUE) //\u9ed8\u8ba4\u7ee7\u7eed\u540e\u7eed\u9009\u62e9\u5668\n            .sort(1) //\u9ed8\u8ba4\u987a\u5e8f1\n            .build();\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'private List<SelectorConditionDTO> buildDefaultSelectorConditionDTO(final String contextPath) {\n    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();\n    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // \u9ed8\u8ba4\u53c2\u6570\u7c7b\u578bURI\n    selectorConditionDTO.setParamName("/");\n    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // \u9ed8\u8ba4\u5339\u914d\u7b56\u7565 match\n    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // \u9ed8\u8ba4\u503c /contextPath/**\n    return Collections.singletonList(selectorConditionDTO);\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6ce8\u518c\u9ed8\u8ba4\u9009\u62e9\u5668")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Override\npublic String registerDefault(final SelectorDTO selectorDTO) {\n    //\u9009\u62e9\u5668\u4fe1\u606f\n    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\n    //\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\n    List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\n    if (StringUtils.isEmpty(selectorDTO.getId())) {\n        // \u5411\u6570\u636e\u5e93\u63d2\u5165\u9009\u62e9\u5668\u4fe1\u606f\n        selectorMapper.insertSelective(selectorDO);\n          // \u5411\u6570\u636e\u5e93\u63d2\u5165\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\n        selectorConditionDTOs.forEach(selectorConditionDTO -> {\n            selectorConditionDTO.setSelectorId(selectorDO.getId());            selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\n        });\n    }\n    // \u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\uff0c\u5411\u7f51\u5173\u540c\u6b65\u9009\u62e9\u4fe1\u606f\u53ca\u5176\u6761\u4ef6\u5c5e\u6027\n    publishEvent(selectorDO, selectorConditionDTOs);\n    return selectorDO.getId();\n}\n")),(0,r.kt)("h6",{id:"1312-\u6ce8\u518c\u89c4\u5219"},"1.3.1.2 \u6ce8\u518c\u89c4\u5219"),(0,r.kt)("p",null,"\u5728\u6ce8\u518c\u670d\u52a1\u7684\u7b2c\u4e8c\u6b65\u4e2d\uff0c\u5f00\u59cb\u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\uff0c\u7136\u540e\u6ce8\u518c\u89c4\u5219\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Override\n    public String register(final MetaDataRegisterDTO dto) {\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\n        //......\n        \n        //2. \u6ce8\u518c\u89c4\u5219\n        // \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\n        String ruleHandler = ruleHandler();\n        // \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\n        // \u6ce8\u518c\u89c4\u5219\n        ruleService.registerDefault(ruleDTO);\n        \n        //3. \u6ce8\u518c\u5143\u6570\u636e\n        //......\n        \n        //4. \u6ce8\u518cContextPath\n        //......\n        \n        return ShenyuResultMessage.SUCCESS;\n    }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"    @Override\n    protected String ruleHandler() {\n        // \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\n        return new DubboRuleHandle().toJson();\n    }\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u63d2\u4ef6\u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class DubboRuleHandle implements RuleHandle {\n\n    /**\n     * dubbo\u670d\u52a1\u7248\u672c\u4fe1\u606f.\n     */\n    private String version;\n\n    /**\n     * \u5206\u7ec4.\n     */\n    private String group;\n\n    /**\n     * \u91cd\u8bd5\u6b21\u6570.\n     */\n    private Integer retries = 0;\n\n    /**\n     * \u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff1a\u9ed8\u8ba4\u968f\u673a\n     */\n    private String loadbalance = LoadBalanceEnum.RANDOM.getName();\n\n    /**\n     * \u8d85\u65f6\uff0c\u9ed8\u8ba43000\n     */\n    private long timeout = Constants.TIME_OUT;\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'  // \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\n    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {\n        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());\n    }\n   //  \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\n    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {\n        RuleDTO ruleDTO = RuleDTO.builder()\n                .selectorId(selectorId) //\u5173\u8054\u7684\u9009\u62e9\u5668id\n                .name(ruleName) //\u89c4\u5219\u540d\u79f0\n                .matchMode(MatchModeEnum.AND.getCode()) // \u9ed8\u8ba4\u5339\u914d\u6a21\u5f0f and\n                .enabled(Boolean.TRUE) // \u9ed8\u8ba4\u5f00\u542f\n                .loged(Boolean.TRUE) //\u9ed8\u8ba4\u8bb0\u5f55\u65e5\u5fd7\n                .sort(1) //\u9ed8\u8ba4\u987a\u5e8f 1\n                .handle(ruleHandler)\n                .build();\n        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()\n                .paramType(ParamTypeEnum.URI.getName()) // \u9ed8\u8ba4\u53c2\u6570\u7c7b\u578bURI\n                .paramName("/")\n                .paramValue(path) //\u53c2\u6570\u503cpath\n                .build();\n        if (path.indexOf("*") > 1) {\n            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //\u5982\u679cpath\u4e2d\u6709*\uff0c\u64cd\u4f5c\u7c7b\u578b\u5219\u9ed8\u8ba4\u4e3a match\n        } else {\n            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // \u5426\u5219\uff0c\u9ed8\u8ba4\u64cd\u4f5c\u7c7b\u578b = \n        }\n        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));\n        return ruleDTO;\n    }\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()")),(0,r.kt)("p",null,"\u6ce8\u518c\u89c4\u5219\uff1a\u5411\u6570\u636e\u5e93\u63d2\u5165\u8bb0\u5f55\uff0c\u5e76\u5411\u7f51\u5173\u53d1\u5e03\u4e8b\u4ef6\uff0c\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'\n    @Override\n    public String registerDefault(final RuleDTO ruleDTO) {\n        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());\n        if (Objects.nonNull(exist)) {\n            return "";\n        }\n\n        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);\n        List<RuleConditionDTO> ruleConditions = ruleDTO.getRuleConditions();\n        if (StringUtils.isEmpty(ruleDTO.getId())) {\n            // \u5411\u6570\u636e\u5e93\u63d2\u5165\u89c4\u5219\u4fe1\u606f\n            ruleMapper.insertSelective(ruleDO);\n            //\u5411\u6570\u636e\u5e93\u63d2\u5165\u89c4\u5219\u4f53\u6761\u4ef6\u5c5e\u6027\n            ruleConditions.forEach(ruleConditionDTO -> {\n                ruleConditionDTO.setRuleId(ruleDO.getId());                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));\n            });\n        }\n        // \u5411\u7f51\u5173\u53d1\u5e03\u4e8b\u4ef6\uff0c\u8fdb\u884c\u6570\u636e\u540c\u6b65\n        publishEvent(ruleDO, ruleConditions);\n        return ruleDO.getId();\n    }\n\n')),(0,r.kt)("h6",{id:"1313-\u6ce8\u518c\u5143\u6570\u636e"},"1.3.1.3 \u6ce8\u518c\u5143\u6570\u636e"),(0,r.kt)("p",null,"\u5143\u6570\u636e\u4e3b\u8981\u7528\u4e8e",(0,r.kt)("inlineCode",{parentName:"p"},"RPC"),"\u670d\u52a1\u7684\u8c03\u7528\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"   @Override\n    public String register(final MetaDataRegisterDTO dto) {\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\n        //......\n        \n        //2. \u6ce8\u518c\u89c4\u5219\n        //......\n        \n        //3. \u6ce8\u518c\u5143\u6570\u636e\n        registerMetadata(dto);\n        \n        //4. \u6ce8\u518cContextPath\n        //......\n        \n        return ShenyuResultMessage.SUCCESS;\n    }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"org.apache.shenyu.admin.service.register.ShenyuClientRegisterDubboServiceImpl#registerMetadata()"),(0,r.kt)("p",{parentName:"li"},"\u63d2\u5165\u6216\u66f4\u65b0\u5143\u6570\u636e\uff0c\u7136\u540e\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u5230\u7f51\u5173\u3002"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"    @Override\n    protected void registerMetadata(final MetaDataRegisterDTO dto) {\n            // \u83b7\u53d6metaDataService\n            MetaDataService metaDataService = getMetaDataService();\n            // \u5143\u6570\u636e\u662f\u5426\u5b58\u5728\n            MetaDataDO exist = metaDataService.findByPath(dto.getPath());\n            // \u63d2\u5165\u6216\u66f4\u65b0\u5143\u6570\u636e\n            metaDataService.saveOrUpdateMetaData(exist, dto);\n    }\n\n    @Override\n    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {\n        DataEventTypeEnum eventType;\n        // \u6570\u636e\u7c7b\u578b\u8f6c\u6362 DTO->DO\n        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);\n        // \u63d2\u5165\u6570\u636e\n        if (Objects.isNull(exist)) {\n            Timestamp currentTime = new Timestamp(System.currentTimeMillis());\n            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());\n            metaDataDO.setDateCreated(currentTime);\n            metaDataDO.setDateUpdated(currentTime);\n            metaDataMapper.insert(metaDataDO);\n            eventType = DataEventTypeEnum.CREATE;\n        } else {\n            // \u66f4\u65b0\u6570\u636e\n            metaDataDO.setId(exist.getId());\n            metaDataMapper.update(metaDataDO);\n            eventType = DataEventTypeEnum.UPDATE;\n        }\n        // \u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u5230\u7f51\u5173\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,\n                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));\n    }\n")),(0,r.kt)("h5",{id:"132-\u6ce8\u518curi"},"1.3.2 \u6ce8\u518cURI"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()")),(0,r.kt)("p",null,"\u670d\u52a1\u7aef\u6536\u5230\u5ba2\u6237\u7aef\u6ce8\u518c\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"URI"),"\u4fe1\u606f\u540e\uff0c\u8fdb\u884c\u5904\u7406\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'    @Override\n    public String registerURI(final String selectorName, final List<URIRegisterDTO> uriList) {\n        String result;\n        String key = key(selectorName);\n        try {\n            this.removeFallBack(key);\n            // \u6ce8\u518cURI\n            result = this.doRegisterURI(selectorName, uriList);\n            logger.info("Register success: {},{}", selectorName, uriList);\n        } catch (Exception ex) {\n            logger.warn("Register exception: cause:{}", ex.getMessage());\n            result = "";\n            // \u6ce8\u518c\u5931\u8d25\u540e\uff0c\u8fdb\u884c\u91cd\u8bd5\n            this.addFallback(key, new FallbackHolder(selectorName, uriList));\n        }\n        return result;\n    }\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()")),(0,r.kt)("p",null,"\u4ece\u5ba2\u6237\u7aef\u6ce8\u518c\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"URI"),"\u4e2d\u83b7\u53d6\u6709\u6548\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"URI"),"\uff0c\u66f4\u65b0\u5bf9\u5e94\u7684\u9009\u62e9\u5668",(0,r.kt)("inlineCode",{parentName:"p"},"handle"),"\u5c5e\u6027\uff0c\u5411\u7f51\u5173\u53d1\u9001\u9009\u62e9\u5668\u66f4\u65b0\u4e8b\u4ef6\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@Override\n    public String doRegisterURI(final String selectorName, final List<URIRegisterDTO> uriList) {\n        //\u53c2\u6570\u68c0\u67e5\n        if (CollectionUtils.isEmpty(uriList)) {\n            return "";\n        }\n        //\u83b7\u53d6\u9009\u62e9\u5668\u4fe1\u606f\n        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\n        if (Objects.isNull(selectorDO)) {\n            throw new ShenyuException("doRegister Failed to execute,wait to retry.");\n        }\n        // \u83b7\u53d6\u6709\u6548\u7684URI\n        List<URIRegisterDTO> validUriList = uriList.stream().filter(dto -> Objects.nonNull(dto.getPort()) && StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());\n        // \u6784\u5efa\u9009\u62e9\u5668\u7684handle\u5c5e\u6027\n        String handler = buildHandle(validUriList, selectorDO);\n        if (handler != null) {\n            selectorDO.setHandle(handler);\n            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\n            selectorData.setHandle(handler);\n            // \u5411\u6570\u636e\u5e93\u66f4\u65b0\u9009\u62e9\u5668\u7684handle\u5c5e\u6027\n            selectorService.updateSelective(selectorDO);\n            // \u5411\u7f51\u5173\u53d1\u9001\u9009\u62e9\u5668\u66f4\u65b0\u4e8b\u4ef6\n            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));\n        }\n        return ShenyuResultMessage.SUCCESS;\n    }\n')),(0,r.kt)("p",null,"\u5173\u4e8e\u670d\u52a1\u6ce8\u518c\u7684\u6e90\u7801\u5206\u6790\u5c31\u4ee5\u53ca\u5b8c\u6210\u4e86\uff0c\u5206\u6790\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(7224).Z})),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\u5c31\u5206\u6790",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u63d2\u4ef6\u662f\u5982\u4f55\u6839\u636e\u8fd9\u4e9b\u4fe1\u606f\u5411",(0,r.kt)("inlineCode",{parentName:"p"},"http"),"\u670d\u52a1\u53d1\u8d77\u8c03\u7528\u3002"),(0,r.kt)("h3",{id:"2-\u670d\u52a1\u8c03\u7528"},"2. \u670d\u52a1\u8c03\u7528"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u63d2\u4ef6\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u7f51\u5173\u7528\u4e8e\u5c06",(0,r.kt)("inlineCode",{parentName:"p"},"http"),"\u8bf7\u6c42\u8f6c\u6210 ",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo\u534f\u8bae"),"\uff0c\u8c03\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u670d\u52a1\u7684\u6838\u5fc3\u5904\u7406\u63d2\u4ef6\u3002"),(0,r.kt)("p",null,"\u4ee5\u5b98\u7f51\u63d0\u4f9b\u7684\u6848\u4f8b ",(0,r.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/docs/quick-start/quick-start-dubbo/"},"Dubbo\u5feb\u901f\u5f00\u59cb")," \u4e3a\u4f8b\uff0c\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u670d\u52a1\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u5411",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u6ce8\u518c\u540e\uff0c\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u7f51\u5173\u4ee3\u7406\uff0c\u8bf7\u6c42\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"GET http://localhost:9195/dubbo/findById?id=100\nAccept: application/json\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u63d2\u4ef6\u4e2d\uff0c\u7c7b\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(98933).Z})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ShenyuPlugin\uff1a\u9876\u5c42\u63a5\u53e3\uff0c\u5b9a\u4e49\u63a5\u53e3\u65b9\u6cd5\uff1b"),(0,r.kt)("li",{parentName:"ul"},"AbstractShenyuPlugin\uff1a\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0\u63d2\u4ef6\u5171\u6709\u903b\u8f91\uff1b"),(0,r.kt)("li",{parentName:"ul"},"AbstractDubboPlugin\uff1adubbo\u63d2\u4ef6\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0",(0,r.kt)("inlineCode",{parentName:"li"},"dubbo"),"\u5171\u6709\u903b\u8f91\uff1b"),(0,r.kt)("li",{parentName:"ul"},"ApacheDubboPlugin\uff1aApacheDubbo\u63d2\u4ef6\u3002")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"ShenYu\u7f51\u5173\u652f\u6301ApacheDubbo\u548cAlibabaDubbo")),(0,r.kt)("h4",{id:"21-\u63a5\u6536\u8bf7\u6c42"},"2.1 \u63a5\u6536\u8bf7\u6c42"),(0,r.kt)("p",null,"\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u7f51\u5173\u4ee3\u7406\u540e\uff0c\u8bf7\u6c42\u5165\u53e3\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"ShenyuWebHandler"),"\uff0c\u5b83\u5b9e\u73b0\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"org.springframework.web.server.WebHandler"),"\u63a5\u53e3\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public final class ShenyuWebHandler implements WebHandler, ApplicationListener<SortPluginEvent> {\n    //......\n    \n    /**\n     * \u5904\u7406web\u8bf7\u6c42\n     */\n    @Override\n    public Mono<Void> handle(@NonNull final ServerWebExchange exchange) {\n       // \u6267\u884c\u9ed8\u8ba4\u63d2\u4ef6\u94fe\n        Mono<Void> execute = new DefaultShenyuPluginChain(plugins).execute(exchange);\n        if (scheduled) {\n            return execute.subscribeOn(scheduler);\n        }\n        return execute;\n    }\n    \n    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {\n\n        private int index;\n\n        private final List<ShenyuPlugin> plugins;\n\n        /**\n         * \u5b9e\u4f8b\u5316\u9ed8\u8ba4\u63d2\u4ef6\u94fe\n         */\n        DefaultShenyuPluginChain(final List<ShenyuPlugin> plugins) {\n            this.plugins = plugins;\n        }\n\n        /**\n         * \u6267\u884c\u6bcf\u4e2a\u63d2\u4ef6.\n         */\n        @Override\n        public Mono<Void> execute(final ServerWebExchange exchange) {\n            return Mono.defer(() -> {\n                if (this.index < plugins.size()) {\n                    // \u83b7\u53d6\u5f53\u524d\u6267\u884c\u63d2\u4ef6\n                    ShenyuPlugin plugin = plugins.get(this.index++);\n                    // \u662f\u5426\u8df3\u8fc7\u5f53\u524d\u63d2\u4ef6\n                    boolean skip = plugin.skip(exchange);\n                    if (skip) {\n                        // \u5982\u679c\u8df3\u8fc7\u5c31\u6267\u884c\u4e0b\u4e00\u4e2a\n                        return this.execute(exchange);\n                    }\n                    // \u6267\u884c\u5f53\u524d\u63d2\u4ef6\n                    return plugin.execute(exchange, this);\n                }\n                return Mono.empty();\n            });\n        }\n    }\n}\n")),(0,r.kt)("h4",{id:"22-\u5339\u914d\u89c4\u5219"},"2.2 \u5339\u914d\u89c4\u5219"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()")),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"execute()"),"\u65b9\u6cd5\u4e2d\u6267\u884c\u9009\u62e9\u5668\u548c\u89c4\u5219\u7684\u5339\u914d\u903b\u8f91\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5339\u914d\u9009\u62e9\u5668\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u5339\u914d\u89c4\u5219\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u6267\u884c\u63d2\u4ef6\u3002")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        // \u63d2\u4ef6\u540d\u79f0\n        String pluginName = named();\n        // \u63d2\u4ef6\u4fe1\u606f\n        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);\n        if (pluginData != null && pluginData.getEnabled()) {\n            // \u9009\u62e9\u5668\u4fe1\u606f\n            final Collection<SelectorData> selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);\n            if (CollectionUtils.isEmpty(selectors)) {\n                return handleSelectorIfNull(pluginName, exchange, chain);\n            }\n            // \u5339\u914d\u9009\u62e9\u5668\n            SelectorData selectorData = matchSelector(exchange, selectors);\n            if (Objects.isNull(selectorData)) {\n                return handleSelectorIfNull(pluginName, exchange, chain);\n            }\n            selectorLog(selectorData, pluginName);\n            // \u89c4\u5219\u4fe1\u606f\n            List<RuleData> rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());\n            if (CollectionUtils.isEmpty(rules)) {\n                return handleRuleIfNull(pluginName, exchange, chain);\n            }\n            // \u5339\u914d\u89c4\u5219\n            RuleData rule;\n            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {\n                //get last\n                rule = rules.get(rules.size() - 1);\n            } else {\n                rule = matchRule(exchange, rules);\n            }\n            if (Objects.isNull(rule)) {\n                return handleRuleIfNull(pluginName, exchange, chain);\n            }\n            ruleLog(rule, pluginName);\n            // \u6267\u884c\u63d2\u4ef6\n            return doExecute(exchange, chain, selectorData, rule);\n        }\n        return chain.execute(exchange);\n    }\n")),(0,r.kt)("h4",{id:"23-\u6267\u884cglobalplugin"},"2.3 \u6267\u884cGlobalPlugin"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.global.GlobalPlugin#execute()")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"GlobalPlugin"),"\u662f\u4e00\u4e2a\u5168\u5c40\u63d2\u4ef6\uff0c\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"execute()"),"\u65b9\u6cd5\u4e2d\u6784\u5efa\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class GlobalPlugin implements ShenyuPlugin {\n    // \u6784\u5efa\u4e0a\u4e0b\u6587\u4fe1\u606f\n    private final ShenyuContextBuilder builder;\n    \n    //......\n    \n    @Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n       // \u6784\u5efa\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u4f20\u5165\u5230 exchange \u4e2d\n        ShenyuContext shenyuContext = builder.build(exchange);\n        exchange.getAttributes().put(Constants.CONTEXT, shenyuContext);\n        return chain.execute(exchange);\n    }\n    \n    //......\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.global.DefaultShenyuContextBuilder#build()")),(0,r.kt)("p",null,"\u6784\u5efa\u9ed8\u8ba4\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class DefaultShenyuContextBuilder implements ShenyuContextBuilder {\n    //......\n    \n    @Override\n    public ShenyuContext build(final ServerWebExchange exchange) {\n        //\u6784\u5efa\u53c2\u6570\n        Pair<String, MetaData> buildData = buildData(exchange);\n        //\u5305\u88c5ShenyuContext\n        return decoratorMap.get(buildData.getLeft()).decorator(buildDefaultContext(exchange.getRequest()), buildData.getRight());\n    }\n    \n    private Pair<String, MetaData> buildData(final ServerWebExchange exchange) {\n        //......\n        //\u6839\u636e\u8bf7\u6c42\u7684uri\u83b7\u53d6\u5143\u6570\u636e\n        MetaData metaData = MetaDataCache.getInstance().obtain(request.getURI().getPath());\n        if (Objects.nonNull(metaData) && Boolean.TRUE.equals(metaData.getEnabled())) {\n            exchange.getAttributes().put(Constants.META_DATA, metaData);\n            return Pair.of(metaData.getRpcType(), metaData);\n        } else {\n            return Pair.of(RpcTypeEnum.HTTP.getName(), new MetaData());\n        }\n    }\n    //\u8bbe\u7f6e\u9ed8\u8ba4\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\n    private ShenyuContext buildDefaultContext(final ServerHttpRequest request) {\n        String appKey = request.getHeaders().getFirst(Constants.APP_KEY);\n        String sign = request.getHeaders().getFirst(Constants.SIGN);\n        String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);\n        ShenyuContext shenyuContext = new ShenyuContext();\n        String path = request.getURI().getPath();\n        shenyuContext.setPath(path); //\u8bf7\u6c42\u8def\u5f84\n        shenyuContext.setAppKey(appKey);\n        shenyuContext.setSign(sign);\n        shenyuContext.setTimestamp(timestamp);\n        shenyuContext.setStartDateTime(LocalDateTime.now());\n        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -> shenyuContext.setHttpMethod(httpMethod.name()));//\u8bf7\u6c42\u65b9\u6cd5\n        return shenyuContext;\n    }\n }\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.dubbo.common.context.DubboShenyuContextDecorator#decorator()")),(0,r.kt)("p",null,"\u5305\u88c5",(0,r.kt)("inlineCode",{parentName:"p"},"ShenyuContext"),"\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class DubboShenyuContextDecorator implements ShenyuContextDecorator {\n    \n    @Override\n    public ShenyuContext decorator(final ShenyuContext shenyuContext, final MetaData metaData) {\n        shenyuContext.setModule(metaData.getAppName());//\u83b7\u53d6AppName\n        shenyuContext.setMethod(metaData.getServiceName()); //\u83b7\u53d6ServiceName\n        shenyuContext.setContextPath(metaData.getContextPath()); //\u83b7\u53d6contextPath\n        shenyuContext.setRpcType(RpcTypeEnum.DUBBO.getName()); // dubbo\u670d\u52a1\n        return shenyuContext;\n    }\n    \n    @Override\n    public String rpcType() {\n        return RpcTypeEnum.DUBBO.getName();\n    }\n}\n")),(0,r.kt)("h4",{id:"24-\u6267\u884crpcparamtransformplugin"},"2.4 \u6267\u884cRpcParamTransformPlugin"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"RpcParamTransformPlugin"),"\u8d1f\u8d23\u4ece",(0,r.kt)("inlineCode",{parentName:"p"},"http"),"\u8bf7\u6c42\u4e2d\u8bfb\u53d6\u53c2\u6570\uff0c\u4fdd\u5b58\u5230",(0,r.kt)("inlineCode",{parentName:"p"},"exchange"),"\u4e2d\uff0c\u4f20\u9012\u7ed9",(0,r.kt)("inlineCode",{parentName:"p"},"rpc"),"\u670d\u52a1\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.base.RpcParamTransformPlugin#execute()")),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"execute()"),"\u65b9\u6cd5\u4e2d\uff0c\u6267\u884c\u8be5\u63d2\u4ef6\u7684\u6838\u5fc3\u903b\u8f91\uff1a\u4ece",(0,r.kt)("inlineCode",{parentName:"p"},"exchange"),"\u4e2d\u83b7\u53d6\u8bf7\u6c42\u4fe1\u606f\uff0c\u6839\u636e\u8bf7\u6c42\u4f20\u5165\u7684\u5185\u5bb9\u5f62\u5f0f\u5904\u7406\u53c2\u6570\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class RpcParamTransformPlugin implements ShenyuPlugin {\n\n    @Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        //\u4eceexchange\u4e2d\u83b7\u53d6\u8bf7\u6c42\u4fe1\u606f\n        ServerHttpRequest request = exchange.getRequest();\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\n        if (Objects.nonNull(shenyuContext)) {\n           // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_JSON\n            MediaType mediaType = request.getHeaders().getContentType();\n            if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {\n                return body(exchange, request, chain);\n            }\n            // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_FORM_URLENCODED\n            if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {\n                return formData(exchange, request, chain);\n            }\n            //\u4e00\u822c\u67e5\u8be2\u8bf7\u6c42\n            return query(exchange, request, chain);\n        }\n        return chain.execute(exchange);\n    }\n    \n    // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_JSON\n    private Mono<Void> body(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\n        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())\n                .flatMap(body -> {\n                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, resolveBodyFromRequest(body));//\u89e3\u6790body\uff0c\u4fdd\u5b58\u5230exchange\u4e2d\n                    return chain.execute(exchange);\n                }));\n    }\n   // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_FORM_URLENCODED\n    private Mono<Void> formData(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\n        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())\n                .flatMap(map -> {\n                    String param = resolveBodyFromRequest(map);\n                    LinkedMultiValueMap<String, String> linkedMultiValueMap;\n                    try {\n                        linkedMultiValueMap = BodyParamUtils.buildBodyParams(URLDecoder.decode(param, StandardCharsets.UTF_8.name())); //\u683c\u5f0f\u5316\u6570\u636e\n                    } catch (UnsupportedEncodingException e) {\n                        return Mono.error(e);\n                    }\n                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.toMap(() -> linkedMultiValueMap));// \u4fdd\u5b58\u5230exchange\u4e2d\n                    return chain.execute(exchange);\n                }));\n    }\n    //\u4e00\u822c\u67e5\u8be2\u8bf7\u6c42\n    private Mono<Void> query(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\n        exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.ofString(() -> serverHttpRequest.getURI().getQuery()));//\u4fdd\u5b58\u5230exchange\u4e2d\n        return chain.execute(exchange);\n    }\n    //......\n }\n")),(0,r.kt)("h4",{id:"25-\u6267\u884cdubboplugin"},"2.5 \u6267\u884cDubboPlugin"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.dubbo.common.AbstractDubboPlugin#doExecute()")),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"doExecute()"),"\u65b9\u6cd5\u4e2d\uff0c\u4e3b\u8981\u662f\u68c0\u67e5\u5143\u6570\u636e\u548c\u53c2\u6570\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public abstract class AbstractDubboPlugin extends AbstractShenyuPlugin {\n    \n    @Override\n    public Mono<Void> doExecute(final ServerWebExchange exchange,\n                                   final ShenyuPluginChain chain,\n                                   final SelectorData selector,\n                                   final RuleData rule) {\n        //\u83b7\u53d6\u53c2\u6570\n        String param = exchange.getAttribute(Constants.PARAM_TRANSFORM);\n        //\u83b7\u53d6\u4e0a\u4e0b\u6587\u4fe1\u606f\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\n        assert shenyuContext != null;\n        //\u83b7\u53d6\u5143\u6570\u636e\n        MetaData metaData = exchange.getAttribute(Constants.META_DATA);\n        //\u68c0\u67e5\u5143\u6570\u636e\n        if (!checkMetaData(metaData)) {\n            LOG.error(" path is : {}, meta data have error : {}", shenyuContext.getPath(), metaData);\n            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.META_DATA_ERROR, null);\n            return WebFluxResultUtils.result(exchange, error);\n        }\n        //\u68c0\u67e5\u5143\u6570\u636e\u548c\u53c2\u6570\n        if (Objects.nonNull(metaData) && StringUtils.isNoneBlank(metaData.getParameterTypes()) && StringUtils.isBlank(param)) {\n            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.DUBBO_HAVE_BODY_PARAM, null);\n            return WebFluxResultUtils.result(exchange, error);\n        }\n        //\u8bbe\u7f6erpcContext\n        this.rpcContext(exchange);\n        //\u8fdb\u884cdubbo\u670d\u52a1\u8c03\u7528\n        return this.doDubboInvoker(exchange, chain, selector, rule, metaData, param);\n    }\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.apache.dubbo.ApacheDubboPlugin#doDubboInvoker()")),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"doDubboInvoker()"),"\u65b9\u6cd5\u4e2d\u8bbe\u7f6e\u7279\u6b8a\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u7136\u540e\u5f00\u59cbdubbo\u7684\u6cdb\u5316\u8c03\u7528\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class ApacheDubboPlugin extends AbstractDubboPlugin {\n    \n    @Override\n    protected Mono<Void> doDubboInvoker(final ServerWebExchange exchange,\n                                        final ShenyuPluginChain chain,\n                                        final SelectorData selector,\n                                        final RuleData rule,\n                                        final MetaData metaData,\n                                        final String param) {\n        //\u8bbe\u7f6e\u5f53\u524d\u7684\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\uff0c\u4ee5\u53ca\u8bf7\u6c42\u5730\u5740\uff0c\u7528\u4e8e\u652f\u6301dubbo\u7684\u7070\u5ea6\n        RpcContext.getContext().setAttachment(Constants.DUBBO_SELECTOR_ID, selector.getId());\n        RpcContext.getContext().setAttachment(Constants.DUBBO_RULE_ID, rule.getId());\n        RpcContext.getContext().setAttachment(Constants.DUBBO_REMOTE_ADDRESS, Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress());\n        //dubbo\u7684\u6cdb\u5316\u8c03\u7528\n        final Mono<Object> result = dubboProxyService.genericInvoker(param, metaData, exchange);\n        //\u6267\u884c\u4e0b\u4e00\u4e2a\u63d2\u4ef6\n        return result.then(chain.execute(exchange));\n    }\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.apache.dubbo.proxy.ApacheDubboProxyService#genericInvoker()")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"genericInvoker()"),"\u65b9\u6cd5\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u83b7\u53d6",(0,r.kt)("inlineCode",{parentName:"li"},"ReferenceConfig"),"\u5bf9\u8c61\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u83b7\u53d6\u6cdb\u5316\u670d\u52a1",(0,r.kt)("inlineCode",{parentName:"li"},"GenericService"),"\u5bf9\u8c61\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u6784\u9020\u8bf7\u6c42\u53c2\u6570",(0,r.kt)("inlineCode",{parentName:"li"},"pair"),"\u5bf9\u8c61\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u53d1\u8d77\u5f02\u6b65\u7684\u6cdb\u5316\u8c03\u7528\u3002")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class ApacheDubboProxyService {\n    //...... \n\n    /**\n     * Generic invoker object.\n     */\n    public Mono<Object> genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws ShenyuException {\n        //1.\u83b7\u53d6ReferenceConfig\u5bf9\u8c61\n        ReferenceConfig<GenericService> reference = ApacheDubboConfigCache.getInstance().get(metaData.getPath());\n        //\u5982\u679c\u6ca1\u6709\u83b7\u53d6\u5230\n        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) {\n            //\u5931\u6548\u5f53\u524d\u7f13\u5b58\u7684\u4fe1\u606f\n            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());\n            //\u4f7f\u7528\u5143\u6570\u636e\u8fdb\u884c\u518d\u6b21\u521d\u59cb\u5316\n            reference = ApacheDubboConfigCache.getInstance().initRef(metaData);\n        }\n        //2.\u83b7\u53d6\u6cdb\u5316\u670d\u52a1GenericService\u5bf9\u8c61\n        GenericService genericService = reference.get();\n        //3.\u6784\u9020\u8bf7\u6c42\u53c2\u6570pair\u5bf9\u8c61\n        Pair<String[], Object[]> pair;\n        if (StringUtils.isBlank(metaData.getParameterTypes()) || ParamCheckUtils.dubboBodyIsEmpty(body)) {\n            pair = new ImmutablePair<>(new String[]{}, new Object[]{});\n        } else {\n            pair = dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());\n        }\n        //4.\u53d1\u8d77\u5f02\u6b65\u7684\u6cdb\u5316\u8c03\u7528\n        return Mono.fromFuture(invokeAsync(genericService, metaData.getMethodName(), pair.getLeft(), pair.getRight()).thenApply(ret -> {\n            //\u5904\u7406\u7ed3\u679c\n            if (Objects.isNull(ret)) {\n                ret = Constants.DUBBO_RPC_RESULT_EMPTY;\n            }\n            exchange.getAttributes().put(Constants.RPC_RESULT, ret);\n            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());\n            return ret;\n        })).onErrorMap(exception -> exception instanceof GenericException ? new ShenyuException(((GenericException) exception).getExceptionMessage()) : new ShenyuException(exception));//\u5904\u7406\u5f02\u5e38\n    }\n    \n    //\u6cdb\u5316\u8c03\u7528\uff0c\u5f02\u6b65\u64cd\u4f5c\n    private CompletableFuture<Object> invokeAsync(final GenericService genericService, final String method, final String[] parameterTypes, final Object[] args) throws GenericException {\n        genericService.$invoke(method, parameterTypes, args);\n        Object resultFromFuture = RpcContext.getContext().getFuture();\n        return resultFromFuture instanceof CompletableFuture ? (CompletableFuture<Object>) resultFromFuture : CompletableFuture.completedFuture(resultFromFuture);\n    }\n}\n\n")),(0,r.kt)("p",null,"\u901a\u8fc7\u6cdb\u5316\u8c03\u7528\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5728\u7f51\u5173\u8c03\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u670d\u52a1\u4e86\u3002"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ReferenceConfig"),"\u5bf9\u8c61\u662f\u652f\u6301\u6cdb\u5316\u8c03\u7528\u7684\u5173\u952e\u5bf9\u8c61 \uff0c\u5b83\u7684\u521d\u59cb\u5316\u64cd\u4f5c\u662f\u5728\u6570\u636e\u540c\u6b65\u7684\u65f6\u5019\u5b8c\u6210\u7684\u3002\u8fd9\u91cc\u6d89\u53ca\u4e24\u90e8\u5206\u6570\u636e\uff0c\u4e00\u662f\u540c\u6b65\u7684\u63d2\u4ef6",(0,r.kt)("inlineCode",{parentName:"p"},"handler"),"\u4fe1\u606f\uff0c\u4e8c\u662f\u540c\u6b65\u7684\u63d2\u4ef6\u5143\u6570\u636e\u4fe1\u606f\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.dubbo.common.handler.AbstractDubboPluginDataHandler#handlerPlugin()")),(0,r.kt)("p",null,"\u5f53\u63d2\u4ef6\u6570\u636e\u66f4\u65b0\u65f6\uff0c\u6570\u636e\u540c\u6b65\u6a21\u5757\u4f1a\u5c06\u6570\u636e\u4ece",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u540c\u6b65\u5230\u7f51\u5173\u3002\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"handlerPlugin()"),"\u4e2d\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public abstract class AbstractDubboPluginDataHandler implements PluginDataHandler {\n    //......\n    \n    //\u521d\u59cb\u5316\u914d\u7f6e\u7f13\u5b58\n   protected abstract void initConfigCache(DubboRegisterConfig dubboRegisterConfig);\n\n    @Override\n    public void handlerPlugin(final PluginData pluginData) {\n        if (Objects.nonNull(pluginData) && Boolean.TRUE.equals(pluginData.getEnabled())) {\n            //\u6570\u636e\u53cd\u5e8f\u5217\u5316\n            DubboRegisterConfig dubboRegisterConfig = GsonUtils.getInstance().fromJson(pluginData.getConfig(), DubboRegisterConfig.class);\n            DubboRegisterConfig exist = Singleton.INST.get(DubboRegisterConfig.class);\n            if (Objects.isNull(dubboRegisterConfig)) {\n                return;\n            }\n            if (Objects.isNull(exist) || !dubboRegisterConfig.equals(exist)) {\n                // \u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\n                this.initConfigCache(dubboRegisterConfig);\n            }\n            Singleton.INST.single(DubboRegisterConfig.class, dubboRegisterConfig);\n        }\n    }\n    //......\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.apache.dubbo.handler.ApacheDubboPluginDataHandler#initConfigCache()")),(0,r.kt)("p",null,"\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class ApacheDubboPluginDataHandler extends AbstractDubboPluginDataHandler {\n\n    @Override\n    protected void initConfigCache(final DubboRegisterConfig dubboRegisterConfig) {\n        //\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\n        ApacheDubboConfigCache.getInstance().init(dubboRegisterConfig);\n        //\u5931\u6548\u4e4b\u524d\u7f13\u5b58\u7684\u7ed3\u679c\n        ApacheDubboConfigCache.getInstance().invalidateAll();\n    }\n}\n\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#init()")),(0,r.kt)("p",null,"\u5728\u521d\u59cb\u5316\u4e2d\uff0c\u8bbe\u7f6e",(0,r.kt)("inlineCode",{parentName:"p"},"registryConfig"),"\u548c",(0,r.kt)("inlineCode",{parentName:"p"},"consumerConfig"),"\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public final class ApacheDubboConfigCache extends DubboConfigCache {\n    //......  \n   /**\n     * \u521d\u59cb\u5316\n     */\n    public void init(final DubboRegisterConfig dubboRegisterConfig) {\n        //\u521b\u5efaApplicationConfig\n        if (Objects.isNull(applicationConfig)) {\n            applicationConfig = new ApplicationConfig("shenyu_proxy");\n        }\n        //\u534f\u8bae\u6216\u8005\u5730\u5740\u53d1\u751f\u6539\u53d8\u65f6\uff0c\u9700\u8981\u66f4\u65b0registryConfig\n        if (needUpdateRegistryConfig(dubboRegisterConfig)) {\n            RegistryConfig registryConfigTemp = new RegistryConfig();\n            registryConfigTemp.setProtocol(dubboRegisterConfig.getProtocol());\n            registryConfigTemp.setId("shenyu_proxy");\n            registryConfigTemp.setRegister(false);\n            registryConfigTemp.setAddress(dubboRegisterConfig.getRegister());            Optional.ofNullable(dubboRegisterConfig.getGroup()).ifPresent(registryConfigTemp::setGroup);\n            registryConfig = registryConfigTemp;\n        }\n        //\u521b\u5efaConsumerConfig\n        if (Objects.isNull(consumerConfig)) {\n            consumerConfig = ApplicationModel.getConfigManager().getDefaultConsumer().orElseGet(() -> {\n                ConsumerConfig consumerConfig = new ConsumerConfig();\n                consumerConfig.refresh();\n                return consumerConfig;\n            });\n           \n //\u8bbe\u7f6eConsumerConfig\n            Optional.ofNullable(dubboRegisterConfig.getThreadpool()).ifPresent(consumerConfig::setThreadpool); \n            Optional.ofNullable(dubboRegisterConfig.getCorethreads()).ifPresent(consumerConfig::setCorethreads);\n            \n Optional.ofNullable(dubboRegisterConfig.getThreads()).ifPresent(consumerConfig::setThreads);\n            \n Optional.ofNullable(dubboRegisterConfig.getQueues()).ifPresent(consumerConfig::setQueues);\n        }\n    }\n    \n    //\u662f\u5426\u9700\u8981\u66f4\u65b0\u6ce8\u518c\u914d\u7f6e\n    private boolean needUpdateRegistryConfig(final DubboRegisterConfig dubboRegisterConfig) {\n        if (Objects.isNull(registryConfig)) {\n            return true;\n        }\n        return !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol())\n                || !Objects.equals(dubboRegisterConfig.getRegister(), registryConfig.getAddress())\n                || !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol());\n    }\n\n    //......\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.apache.dubbo.subscriber.ApacheDubboMetaDataSubscriber#onSubscribe()")),(0,r.kt)("p",null,"\u5f53\u5143\u6570\u636e\u66f4\u65b0\u65f6\uff0c\u6570\u636e\u540c\u6b65\u6a21\u5757\u4f1a\u5c06\u6570\u636e\u4ece",(0,r.kt)("inlineCode",{parentName:"p"},"shenyu-admin"),"\u540c\u6b65\u5230\u7f51\u5173\u3002\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"onSubscribe()"),"\u65b9\u6cd5\u4e2d\u6267\u884c\u5143\u6570\u636e\u66f4\u65b0\u64cd\u4f5c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public class ApacheDubboMetaDataSubscriber implements MetaDataSubscriber {\n    //\u672c\u5730\u5185\u5b58\u7f13\u5b58\n    private static final ConcurrentMap<String, MetaData> META_DATA = Maps.newConcurrentMap();\n\n    //\u5143\u6570\u636e\u53d1\u751f\u66f4\u65b0\n    public void onSubscribe(final MetaData metaData) {\n        // dubbo\u670d\u52a1\u7684\u5143\u6570\u636e\u66f4\u65b0\n        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {\n            //\u5bf9\u5e94\u7684\u5143\u6570\u636e\u662f\u5426\u5b58\u5728\n            MetaData exist = META_DATA.get(metaData.getPath());\n            if (Objects.isNull(exist) || Objects.isNull(ApacheDubboConfigCache.getInstance().get(metaData.getPath()))) {\n                // \u9996\u6b21\u521d\u59cb\u5316\n                ApacheDubboConfigCache.getInstance().initRef(metaData);\n            } else {\n                // \u5bf9\u5e94\u7684\u5143\u6570\u636e\u53d1\u751f\u4e86\u66f4\u65b0\u64cd\u4f5c\n                if (!Objects.equals(metaData.getServiceName(), exist.getServiceName())\n                        || !Objects.equals(metaData.getRpcExt(), exist.getRpcExt())\n                        || !Objects.equals(metaData.getParameterTypes(), exist.getParameterTypes())\n                        || !Objects.equals(metaData.getMethodName(), exist.getMethodName())) {\n                    //\u6839\u636e\u6700\u65b0\u7684\u5143\u6570\u636e\u518d\u6b21\u6784\u5efaReferenceConfig\n                    ApacheDubboConfigCache.getInstance().build(metaData);\n                }\n            }\n            //\u672c\u5730\u5185\u5b58\u7f13\u5b58\n            META_DATA.put(metaData.getPath(), metaData);\n        }\n    }\n\n    //\u5220\u9664\u5143\u6570\u636e\n    public void unSubscribe(final MetaData metaData) {\n        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {\n            //\u4f7fReferenceConfig\u5931\u6548\n            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());\n            META_DATA.remove(metaData.getPath());\n        }\n    }\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#initRef()")),(0,r.kt)("p",null,"\u901a\u8fc7",(0,r.kt)("inlineCode",{parentName:"p"},"metaData"),"\u6784\u5efa",(0,r.kt)("inlineCode",{parentName:"p"},"ReferenceConfig"),"\u5bf9\u8c61\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public final class ApacheDubboConfigCache extends DubboConfigCache {\n    //......\n    \n    public ReferenceConfig<GenericService> initRef(final MetaData metaData) {\n            try {\n                //\u5148\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u5b58\u5728\u5c31\u76f4\u63a5\u8fd4\u56de\n                ReferenceConfig<GenericService> referenceConfig = cache.get(metaData.getPath());\n                if (StringUtils.isNoneBlank(referenceConfig.getInterface())) {\n                    return referenceConfig;\n                }\n            } catch (ExecutionException e) {\n                LOG.error("init dubbo ref exception", e);\n            }\n           //\u4e0d\u5b58\u5728\uff0c\u5c31\u6784\u5efa\n            return build(metaData);\n        }\n\n        /**\n         * Build reference config.\n         */\n        @SuppressWarnings("deprecation")\n        public ReferenceConfig<GenericService> build(final MetaData metaData) {\n            if (Objects.isNull(applicationConfig) || Objects.isNull(registryConfig)) {\n                return new ReferenceConfig<>();\n            }\n            ReferenceConfig<GenericService> reference = new ReferenceConfig<>(); //\u65b0\u5efaReferenceConfig\n            reference.setGeneric("true"); //\u6cdb\u5316\u8c03\u7528\n            reference.setAsync(true);//\u652f\u6301\u5f02\u6b65\n\n            reference.setApplication(applicationConfig);//\u8bbe\u7f6e\u5e94\u7528\u914d\u7f6e\n            reference.setRegistry(registryConfig);//\u8bbe\u7f6e\u6ce8\u518c\u4e2d\u5fc3\u914d\u7f6e\n            reference.setConsumer(consumerConfig);//\u8bbe\u7f6e\u6d88\u8d39\u8005\u914d\u7f6e\n            reference.setInterface(metaData.getServiceName());//\u8bbe\u7f6e\u670d\u52a1\u63a5\u53e3\n            reference.setProtocol("dubbo");//\u8bbe\u7f6edubbo\u534f\u8bae\n            reference.setCheck(false); //\u4e0d\u68c0\u67e5 service provider\n            reference.setLoadbalance("gray");//\u652f\u6301\u7070\u5ea6\n\n            Map<String, String> parameters = new HashMap<>(2);\n            parameters.put("dispatcher", "direct");\n            reference.setParameters(parameters);//\u81ea\u5b9a\u4e49\u53c2\u6570\n\n            String rpcExt = metaData.getRpcExt();//rpc\u6269\u5c55\u53c2\u6570\n            DubboParam dubboParam = parserToDubboParam(rpcExt);//\u53cd\u5e8f\u5217\u5316\n            if (Objects.nonNull(dubboParam)) {\n                if (StringUtils.isNoneBlank(dubboParam.getVersion())) {\n                    reference.setVersion(dubboParam.getVersion());//\u8bbe\u7f6e\u7248\u672c\n                }\n                if (StringUtils.isNoneBlank(dubboParam.getGroup())) {\n                    reference.setGroup(dubboParam.getGroup());//\u8bbe\u7f6e\u5206\u7ec4\n                }\n                if (StringUtils.isNoneBlank(dubboParam.getUrl())) {\n                    reference.setUrl(dubboParam.getUrl());//\u8bbe\u7f6eurl\n                }\n                if (StringUtils.isNoneBlank(dubboParam.getCluster())) {\n                    reference.setCluster(dubboParam.getCluster());//\u8bbe\u7f6eCluster type\n                }\n                Optional.ofNullable(dubboParam.getTimeout()).ifPresent(reference::setTimeout);//timeout\n                Optional.ofNullable(dubboParam.getRetries()).ifPresent(reference::setRetries);//retires\n                Optional.ofNullable(dubboParam.getSent()).ifPresent(reference::setSent);//Whether to ack async-sent\n            }\n            try {\n                //\u83b7\u53d6GenericService\n                Object obj = reference.get();\n                if (Objects.nonNull(obj)) {\n                    LOG.info("init apache dubbo reference success there meteData is :{}", metaData);\n                    //\u7f13\u5b58\u5f53\u524d\u7684reference\n                    cache.put(metaData.getPath(), reference);\n                }\n            } catch (Exception e) {\n                LOG.error("init apache dubbo reference exception", e);\n            }\n            return reference;\n        }\n    //......\n    }\n')),(0,r.kt)("h4",{id:"26-\u6267\u884cresponseplugin"},"2.6 \u6267\u884cResponsePlugin"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.response.ResponsePlugin#execute()")),(0,r.kt)("p",null,"\u54cd\u5e94\u7ed3\u679c\u7531",(0,r.kt)("inlineCode",{parentName:"p"},"ResponsePlugin"),"\u63d2\u4ef6\u5904\u7406\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"    @Override\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\n        assert shenyuContext != null;\n        // \u6839\u636erpc\u7c7b\u578b\u5904\u7406\u7ed3\u679c\n        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);\n    }\n")),(0,r.kt)("p",null,"\u5904\u7406\u7c7b\u578b\u7531",(0,r.kt)("inlineCode",{parentName:"p"},"MessageWriter"),"\u51b3\u5b9a\uff0c\u7c7b\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(45911).Z})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"MessageWriter\uff1a\u63a5\u53e3\uff0c\u5b9a\u4e49\u6d88\u606f\u5904\u7406\u65b9\u6cd5\uff1b"),(0,r.kt)("li",{parentName:"ul"},"NettyClientMessageWriter\uff1a\u5904\u7406",(0,r.kt)("inlineCode",{parentName:"li"},"Netty"),"\u8c03\u7528\u7ed3\u679c\uff1b"),(0,r.kt)("li",{parentName:"ul"},"RPCMessageWriter\uff1a\u5904\u7406",(0,r.kt)("inlineCode",{parentName:"li"},"RPC"),"\u8c03\u7528\u7ed3\u679c\uff1b"),(0,r.kt)("li",{parentName:"ul"},"WebClientMessageWriter\uff1a\u5904\u7406",(0,r.kt)("inlineCode",{parentName:"li"},"WebClient"),"\u8c03\u7528\u7ed3\u679c\uff1b")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u670d\u52a1\u8c03\u7528\uff0c\u5904\u7406\u7ed3\u679c\u5f53\u7136\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"RPCMessageWriter"),"\u4e86\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"org.apache.shenyu.plugin.response.strategy.RPCMessageWriter#writeWith()")),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"writeWith()"),"\u65b9\u6cd5\u4e2d\u5904\u7406\u54cd\u5e94\u7ed3\u679c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"\npublic class RPCMessageWriter implements MessageWriter {\n\n    @Override\n    public Mono<Void> writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\n        return chain.execute(exchange).then(Mono.defer(() -> {\n            Object result = exchange.getAttribute(Constants.RPC_RESULT); //\u83b7\u53d6\u7ed3\u679c\n            if (Objects.isNull(result)) { //\u5904\u7406\u5f02\u5e38\n                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);\n                return WebFluxResultUtils.result(exchange, error);\n            }\n            return WebFluxResultUtils.result(exchange, result);//\u8fd4\u56de\u7ed3\u679c\n        }));\n    }\n}\n")),(0,r.kt)("p",null,"\u5206\u6790\u81f3\u6b64\uff0c\u5173\u4e8e",(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u63d2\u4ef6\u7684\u6e90\u7801\u5206\u6790\u5c31\u5b8c\u6210\u4e86\uff0c\u5206\u6790\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(59478).Z})),(0,r.kt)("h3",{id:"3-\u5c0f\u7ed3"},"3. \u5c0f\u7ed3"),(0,r.kt)("p",null,"\u672c\u6587\u6e90\u7801\u5206\u6790\u4ece",(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u670d\u52a1\u6ce8\u518c\u5f00\u59cb\uff0c\u5230",(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u63d2\u4ef6\u7684\u670d\u52a1\u8c03\u7528\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"Dubbo"),"\u63d2\u4ef6\u4e3b\u8981\u7528\u6765\u5904\u7406\u5c06",(0,r.kt)("inlineCode",{parentName:"p"},"http"),"\u8bf7\u6c42\u8f6c\u6210",(0,r.kt)("inlineCode",{parentName:"p"},"dubbo"),"\u534f\u8bae,\u4e3b\u8981\u903b\u8f91\u662f\u901a\u8fc7\u6cdb\u5316\u8c03\u7528\u5b9e\u73b0\u3002"))}c.isMDXComponent=!0},98933:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/ApacheDubboPlugin-286a36694f3fa121e7d3c7d67d08b833.png"},45911:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"},85929:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/ShenyuClientRegisterDubboServiceImpl-a48cc4b745cb6a47ee000cf08d4cff04.png"},59478:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/dubbo-execute-zh-cd073b32b44fa14c94a575450d8b320d.png"},7224:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/dubbo-register-zh-3a94f676f21cccb70d92c1e9e1eaad29.png"}}]);