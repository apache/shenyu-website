"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[13507],{44933:e=>{e.exports=JSON.parse('{"blogPosts":[{"id":"/DataSync-SourceCode-Analysis-Apollo-Data-Sync","metadata":{"permalink":"/zh/blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync.md","title":"Apollo\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","description":"\u672c\u6587\u57fa\u4e8eshenyu-2.6.1\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 \u6570\u636e\u540c\u6b65\u539f\u7406 \u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"apollo","permalink":"/zh/blog/tags/apollo"},{"label":"data sync","permalink":"/zh/blog/tags/data-sync"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":15.6,"hasTruncateMarker":false,"authors":[{"name":"hql0312","title":"Apache ShenYu Contributor","url":"https://github.com/hql0312"}],"frontMatter":{"title":"Apollo\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","author":"hql0312","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/hql0312","tags":["apollo","data sync","Apache ShenYu"]},"unlisted":false,"nextItem":{"title":"Etcd\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync"}},"content":"> \u672c\u6587\u57fa\u4e8e`shenyu-2.6.1`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [\u6570\u636e\u540c\u6b65\u539f\u7406](https://shenyu.apache.org/zh/docs/design/data-sync) \u3002\\n\\n### Admin\u7ba1\u7406\u7aef\\n\\n\u4ee5\u65b0\u589e\u63d2\u4ef6\u7684\u6d41\u7a0b\u6765\u7406\u89e3\u4e0b\u6574\u4f53\u7684\u6d41\u7a0b\\n\\n![](/img/activities/code-analysis-apollo-data-sync/Apollo-Sync.png)\\n\\n### \u63a5\u6536\u6570\u636e\\n\\n- PluginController.createPlugin()\\n\\n\u8fdb\u5165`PluginController`\u7c7b\u4e2d\u7684`createPlugin()`\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002\\n\\n```java\\n@Validated\\n@RequiredArgsConstructor\\n@RestController\\n@RequestMapping(\\"/plugin\\")\\npublic class PluginController {\\n\\n  @PostMapping(\\"\\")\\n  @RequiresPermissions(\\"system:plugin:add\\")\\n  public ShenyuAdminResult createPlugin(@Valid @ModelAttribute final PluginDTO pluginDTO) {\\n      // \u8c03\u7528pluginService.createOrUpdate \u8fdb\u884c\u5904\u7406\u903b\u8f91\\n      return ShenyuAdminResult.success(pluginService.createOrUpdate(pluginDTO));\\n  }\\n    \\n    // ......\\n}\\n```\\n\\n### \u5904\u7406\u6570\u636e\\n\\n- PluginServiceImpl.createOrUpdate() -> PluginServiceImpl.create()\\n\\n\u5728`PluginServiceImpl`\u7c7b\u4e2d\u901a\u8fc7`create()`\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\u3002\\n\\n```java\\n@RequiredArgsConstructor\\n@Service\\npublic class PluginServiceImpl implements SelectorService {\\n    // \u4e8b\u4ef6\u53d1\u5e03\u5bf9\u8c61 pluginEventPublisher\\n    private final PluginEventPublisher pluginEventPublisher;\\n\\n   private String create(final PluginDTO pluginDTO) {\\n      // \u5224\u65ad\u6709\u6ca1\u6709\u5bf9\u5e94\u7684\u63d2\u4ef6\\n      Assert.isNull(pluginMapper.nameExisted(pluginDTO.getName()), AdminConstants.PLUGIN_NAME_IS_EXIST);\\n      // \u81ea\u5b9a\u4e49\u7684\u63d2\u4ef6jar\\n      if (!Objects.isNull(pluginDTO.getFile())) {\\n        Assert.isTrue(checkFile(Base64.decode(pluginDTO.getFile())), AdminConstants.THE_PLUGIN_JAR_FILE_IS_NOT_CORRECT_OR_EXCEEDS_16_MB);\\n      }\\n      // \u521b\u5efaplugin\u5bf9\u8c61\\n      PluginDO pluginDO = PluginDO.buildPluginDO(pluginDTO);\\n      // \u63d2\u5165\u5bf9\u8c61\u5230\u6570\u636e\u5e93\\n      if (pluginMapper.insertSelective(pluginDO) > 0) {\\n        // \u63d2\u4ef6\u65b0\u589e\u6210\u529f\uff0c\u5219\u53d1\u5e03\u521b\u5efa\u4e8b\u4ef6\\n        // publish create event. init plugin data\\n        pluginEventPublisher.onCreated(pluginDO);\\n      }\\n      return ShenyuResultMessage.CREATE_SUCCESS;\\n  }\\n    \\n    \\n    // ......\\n    \\n}\\n\\n```\\n\\n\u5728`PluginServiceImpl`\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u5e76\u901a\u8fc7 `pluginEventPublisher` \u8fdb\u884c\u53d1\u5e03\u4e8b\u4ef6\u3002\\n\\n`pluginEventPublisher.onCreateed`\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u53d1\u5e03\u53d8\u66f4\u7684\u4e8b\u4ef6\u3002\\n\\n```java\\n    @Override\\npublic void onCreated(final PluginDO plugin) {\\n        // \u53d1\u5e03DataChangeEvent\u4e8b\u4ef6\uff1a\u4e8b\u4ef6\u5206\u7ec4(\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219)\u3001\u4e8b\u4ef6\u7c7b\u578b(\u521b\u5efa\u3001\u5220\u9664\u3001\u66f4\u65b0)\u3001\u53d8\u66f4\u7684\u6570\u636e\\n        publisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, DataEventTypeEnum.CREATE,\\n        Collections.singletonList(PluginTransfer.INSTANCE.mapToData(plugin))));\\n        // \u53d1\u5e03PluginCreatedEvent\\n        publish(new PluginCreatedEvent(plugin, SessionUtil.visitorName()));\\n}\\n```\\n\\n\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7`publisher.publishEvent()`\u5b8c\u6210\uff0c\u8fd9\u4e2a`publisher`\u5bf9\u8c61\u662f\u4e00\u4e2a`ApplicationEventPublisher`\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f`org.springframework.context.ApplicationEventPublisher`\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7`Spring`\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002\\n\\n> \u5173\u4e8e`ApplicationEventPublisher`\uff1a\\n>\\n> \u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 `ApplicationEventPublisher` \u7684 `publishEvent` \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c`Spring`\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 `onApplicationEvent` \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 `publishEvent`\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 `ApplicationEventPublisher` \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002\\n>\\n> - `ApplicationEventPublisher`\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b\\n> - `ApplicationEvent`\uff1a`Spring` \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b\\n> - `ApplicationListener`\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\uff1b\\n\\n\\n\u5728`Spring`\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c\\n\\n\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684`ApplicationEventPublisher`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a`eventPublisher`\u3002\\n\\n\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f`ApplicationEvent`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEvent`\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\npublic class DataChangedEvent extends ApplicationEvent {\\n//......\\n}\\n```\\n\\n\u6700\u540e\u4e00\u4e2a\u662f `ApplicationListener`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEventDispatcher`\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n    //......\\n    \\n}\\n```\\n\\n### \u5206\u53d1\u6570\u636e\\n\\n- DataChangedEventDispatcher.onApplicationEvent()\\n\\n\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230`DataChangedEventDispatcher`\u7c7b\u4e2d\u7684`onApplicationEvent()`\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n  /**\\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\\n     * @param event\\n     */\\n  @Override\\n  @SuppressWarnings(\\"unchecked\\")\\n  public void onApplicationEvent(final DataChangedEvent event) {\\n    // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08\u8fd9\u91cc\u53ea\u4f1a\u6ce8\u518cApolloDataChangedListener\uff09\\n    for (DataChangedListener listener : listeners) {\\n      // \u4f9d\u636e\u4e0d\u540c\u7684\u5206\u7ec4\u7c7b\u578b\u8fdb\u884c\u8f6c\u53d1\\n      switch (event.getGroupKey()) {\\n        case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\\n          listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\\n          break;\\n        case PLUGIN: // \u63d2\u4ef6\u4e8b\u4ef6\\n          // \u8c03\u7528\u6ce8\u518c\u7684listener\u5bf9\u8c61\\n          listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\\n          break;\\n        case RULE: // \u89c4\u5219\u4e8b\u4ef6\\n          listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\\n          break;\\n        case SELECTOR: // \u9009\u62e9\u5668\u4e8b\u4ef6\\n          listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\\n          break;\\n        case META_DATA: // \u5143\u6570\u636e\u4e8b\u4ef6\\n          listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\\n          break;\\n        case PROXY_SELECTOR: // \u4ee3\u7406\u9009\u62e9\u5668\u4e8b\u4ef6\\n          listener.onProxySelectorChanged((List<ProxySelectorData>) event.getSource(), event.getEventType());\\n          break;\\n        case DISCOVER_UPSTREAM: // \u6ce8\u518c\u53d1\u73b0\u4e0b\u6e38\u5217\u8868\u4e8b\u4ef6\\n          listener.onDiscoveryUpstreamChanged((List<DiscoverySyncData>) event.getSource(), event.getEventType());\\n          applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnUpstreamChanged((List<DiscoverySyncData>) event.getSource(), event.getEventType());\\n          break;\\n        default:\\n          throw new IllegalStateException(\\"Unexpected value: \\" + event.getGroupKey());\\n      }\\n    }\\n  }\\n    \\n}\\n```\\n\\n\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528`onApplicationEvent`\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002\\n\\n`ShenYu`\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u4f1a\u6709\u4ee5\u4e0b\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u3001\u5143\u6570\u636e\u3001\u4ee3\u7406\u9009\u62e9\u5668\u3001\u53d1\u73b0\u4e0b\u6e38\u4e8b\u4ef6\u3002\\n\\n\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08`DataChangedListener`\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61,\u7531\u7279\u5b9a\u7684\u5b9e\u73b0\u6765\u5904\u7406\uff0c\u800c\u4e0d\u540c\u7684\u76d1\u542c\u7531\u4e0d\u540c\u7684\u5b9e\u73b0\u6765\u5904\u7406\uff0c\u5f53\u524d\u5206\u6790\u7684\u662fApollo\u6765\\n\u76d1\u542c\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u5173\u6ce8 `ApolloDataChangedListener`\u3002\\n\\n```java\\n// \u7ee7\u627fAbstractNodeDataChangedListener\\npublic class ApolloDataChangedListener extends AbstractNodeDataChangedListener {\\n    \\n}\\n```\\n\\n`ApolloDataChangedListener` \u7ee7\u627f\u4e86 `AbstractNodeDataChangedListener` \u7c7b\uff0c\u8be5\u7c7b\u4e3b\u8981\u662f\u4ee5key\u4f5c\u4e3a\u5b58\u50a8\u65b9\u5f0f\u7684\u57fa\u7c7b\uff0c\u5982apollo\u3001nacos\u7b49\uff0c\u5176\u4ed6\u7684\u5982zookeeper\u3001\\nconsul\u3001etcd \u7b49\u662f\u4ee5path\u7684\u65b9\u5f0f\u8fdb\u884c\u5206\u5c42\u7ea7\u6765\u67e5\u627e\u7684\u3002\\n\\n```java\\n// \u4ee5key\u4f5c\u4e3a\u67e5\u627e\u5b58\u50a8\u65b9\u5f0f\u7684\u57fa\u7c7b\\npublic abstract class AbstractNodeDataChangedListener implements DataChangedListener { \\n    \\n    protected AbstractNodeDataChangedListener(final ChangeData changeData) {\\n      this.changeData = changeData;\\n    }\\n}\\n```\\n\\n`AbstractNodeDataChangedListener` \u63a5\u6536 `ChangeData`\u4f5c\u4e3a\u53c2\u6570\uff0c\u8be5\u5bf9\u8c61\u5b9a\u4e49\u4e86\u5b58\u50a8\u4e8eApollo\u4e2d\u7684\u5404\u4e2a\u6570\u636e\u7684key\u547d\u540d\uff0c\u5b58\u50a8\u4e8eApollo\u4e2d\u7684\u6570\u636e\u5305\u62ec\u4ee5\u4e0b\u6570\u636e\uff1a\\n- \u63d2\u4ef6(plugin)\\n- \u9009\u62e9\u5668(selector)\\n- \u89c4\u5219(rule)\\n- \u6388\u6743(auth)\\n- \u5143\u6570\u636e(meta)\\n- \u4ee3\u7406\u9009\u62e9\u5668(proxy.selector)\\n- \u4e0b\u6e38\u5217\u8868(discovery)\\n\\n\u8fd9\u4e9b\u4fe1\u606f\u7531ApolloDataChangedListener\u6784\u9020\u5668\u6307\u5b9a:\\n\\n```java\\npublic class ApolloDataChangedListener extends AbstractNodeDataChangedListener {\\n  public ApolloDataChangedListener(final ApolloClient apolloClient) {\\n    // \u914d\u7f6e\u51e0\u7c7b\u5206\u7ec4\u6570\u636e\u7684\u524d\u7f00\\n    super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,\\n            ApolloPathConstants.SELECTOR_DATA_ID,\\n            ApolloPathConstants.RULE_DATA_ID,\\n            ApolloPathConstants.AUTH_DATA_ID,\\n            ApolloPathConstants.META_DATA_ID,\\n            ApolloPathConstants.PROXY_SELECTOR_DATA_ID,\\n            ApolloPathConstants.DISCOVERY_DATA_ID));\\n    // \u64cd\u4f5capollo\u7684\u5bf9\u8c61\\n    this.apolloClient = apolloClient;\\n  }\\n}\\n```\\n\\n`DataChangedListener` \u5b9a\u4e49\u4e86\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u6cd5\uff1a\\n\\n```java\\n// \u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\npublic interface DataChangedListener {\\n\\n    // \u6388\u6743\u4fe1\u606f\u53d8\u66f4\u65f6\u8c03\u7528\\n    default void onAppAuthChanged(List<AppAuthData> changed, DataEventTypeEnum eventType) {\\n    }\\n\\n    // \u63d2\u4ef6\u4fe1\u606f\u53d8\u66f4\u65f6\u8c03\u7528\\n    default void onPluginChanged(List<PluginData> changed, DataEventTypeEnum eventType) {\\n    }\\n\\n    // \u9009\u62e9\u5668\u4fe1\u606f\u53d8\u66f4\u65f6\u8c03\u7528\\n    default void onSelectorChanged(List<SelectorData> changed, DataEventTypeEnum eventType) {\\n    }\\n    \\n     // \u5143\u6570\u636e\u4fe1\u606f\u53d8\u66f4\u65f6\u8c03\u7528\\n    default void onMetaDataChanged(List<MetaData> changed, DataEventTypeEnum eventType) {\\n\\n    }\\n\\n    // \u89c4\u5219\u4fe1\u606f\u53d8\u66f4\u65f6\u8c03\u7528\\n    default void onRuleChanged(List<RuleData> changed, DataEventTypeEnum eventType) {\\n    }\\n\\n    // \u4ee3\u7406\u9009\u62e9\u5668\u53d8\u66f4\u65f6\u8c03\u7528\\n    default void onProxySelectorChanged(List<ProxySelectorData> changed, DataEventTypeEnum eventType) {\\n    }\\n    // \u53d1\u73b0\u4e0b\u6e38\u4fe1\u606f\u53d8\u66f4\u65f6\u8c03\u7528\\n    default void onDiscoveryUpstreamChanged(List<DiscoverySyncData> changed, DataEventTypeEnum eventType) {\\n    }\\n\\n}\\n```\\n\\n\u7531 `DataChangedEventDispatcher`\u5904\u7406\u63d2\u4ef6\u65f6\uff0c\u8c03\u7528\u65b9\u6cd5 `listener.onPluginChanged`, \u63a5\u4e0b\u6765\u5206\u6790\u4e0b\u5bf9\u8c61\u7684\u903b\u8f91\uff0c\u5b9e\u73b0\u7531`AbstractNodeDataChangedListener`\u5904\u7406\uff1a\\n\\n```java\\npublic abstract class AbstractNodeDataChangedListener implements DataChangedListener {\\n  @Override\\n  public void onPluginChanged(final List<PluginData> changed, final DataEventTypeEnum eventType) {\\n    // \u914d\u7f6e\u524d\u7f00\u4e3aplugin.\\n    final String configKeyPrefix = changeData.getPluginDataId() + DefaultNodeConstants.JOIN_POINT;\\n    this.onCommonChanged(configKeyPrefix, changed, eventType, PluginData::getName, PluginData.class);\\n    LOG.debug(\\"[DataChangedListener] PluginChanged {}\\", configKeyPrefix);\\n  }\\n}\\n```\\n\\n\u9996\u5148\u6784\u5efa\u914d\u7f6e\u6570\u636e\u7684key\u524d\u7f00\u4e3a\uff1a`plugin.`, \u518d\u8c03\u7528`onCommonChanged`\u7edf\u4e00\u5904\u7406\uff1a\\n\\n```java\\nprivate <T> void onCommonChanged(final String configKeyPrefix, final List<T> changedList,\\n                                     final DataEventTypeEnum eventType, final Function<? super T, ? extends String> mapperToKey,\\n                                     final Class<T> tClass) {\\n        // Avoiding concurrent operations on list nodes\\n        final ReentrantLock reentrantLock = listSaveLockMap.computeIfAbsent(configKeyPrefix, key -> new ReentrantLock());\\n        try {\\n            reentrantLock.lock();\\n            // \u5f53\u524d\u4f20\u5165\u7684\u63d2\u4ef6\u5217\u8868\\n            final List<String> changeNames = changedList.stream().map(mapperToKey).collect(Collectors.toList());\\n            switch (eventType) {\\n                // \u5220\u9664\u64cd\u4f5c\\n                case DELETE:\\n                    // \u6309 plugin.${pluginName} \u8fdb\u884c\u5220\u9664\\n                    changedList.stream().map(mapperToKey).forEach(removeKey -> {\\n                        delConfig(configKeyPrefix + removeKey);\\n                    });\\n                    // \u4eceplugin.list\u4e2d\u79fb\u9664\u5bf9\u5e94\u7684\u63d2\u4ef6\u540d\u79f0\\n                    // plugin.list \u8bb0\u5f55\u4e0b\u4e86\u76ee\u524d\u542f\u7528\u7684\u5217\u8868\\n                    delChangedData(configKeyPrefix, changeNames);\\n                    break;\\n                case REFRESH:\\n                case MYSELF:\\n                    // \u91cd\u8f7d\u903b\u8f91\\n                    // \u83b7\u53d6plugin.list\u4e2d\u7684\u6240\u6709\u63d2\u4ef6\u5217\u8868\\n                    final List<String> configDataNames = this.getConfigDataNames(configKeyPrefix);\\n                    // \u4f9d\u6b21\u66f4\u65b0\u5f53\u524d\u8c03\u6574\u7684\u6bcf\u4e2a\u63d2\u4ef6\\n                    changedList.forEach(changedData -> {\\n                        // \u53d1\u5e03\u914d\u7f6e\\n                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);\\n                    });\\n                    // \u76ee\u524d\u5b58\u50a8\u7684\u5217\u8868\u4e2d\uff0c\u5982\u679c\u6570\u636e\u6bd4\u5f53\u524d\u4f20\u5165\u7684\u591a\uff0c\u5219\u5220\u9664\u591a\u4f59\u7684\u6570\u636e\\n                    if (configDataNames != null && configDataNames.size() > changedList.size()) {\\n                        // \u8e22\u9664\u5f53\u524d\u52a0\u8f7d\u7684\u6570\u636e\\n                        configDataNames.removeAll(changeNames);\\n                        // \u9010\u4e2a\u5220\u9664\u5df2\u7ecf\u53d6\u6d88\u7684\u6570\u636e\\n                        configDataNames.forEach(this::delConfig);\\n                    }\\n                    // \u91cd\u65b0\u66f4\u65b0\u5217\u8868\u6570\u636e\\n                    publishConfig(configKeyPrefix + DefaultNodeConstants.LIST_STR, changeNames);\\n                    break;\\n                default:\\n                    // \u65b0\u589e\u6216\u662f\u66f4\u65b0\\n                    changedList.forEach(changedData -> {\\n                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);\\n                    });\\n                    // \u5c06\u65b0\u52a0\u7684\u63d2\u4ef6\u66f4\u65b0\\n                    putChangeData(configKeyPrefix, changeNames);\\n                    break;\\n            }\\n        } catch (Exception e) {\\n            LOG.error(\\"AbstractNodeDataChangedListener onCommonMultiChanged error \\", e);\\n        } finally {\\n            reentrantLock.unlock();\\n        }\\n    }\\n```\\n\\n\u5728\u4ee5\u4e0a\u903b\u8f91\uff0c\u5176\u5b9e\u5305\u542b\u5168\u91cf\u91cd\u8f7d(REFRESH\u3001MYSELF)\u4e0e\u589e\u91cf(DELETE\u3001UPDATE\u3001CREATE)\u7684\u5904\u7406\\n\\n\u5728\u63d2\u4ef6\u4e2d\u4e3b\u8981\u5305\u542b\u4e24\u4e2a\u8282\u70b9\uff1a\\n- `plugin.list` \u5f53\u524d\u751f\u6548\u7684\u63d2\u4ef6\u5217\u8868\\n- `plugin.${plugin.name}` \u5177\u4f53\u63d2\u4ef6\u7684\u8be6\u7ec6\u4fe1\u606f\\n\u6700\u540e\uff0c\u5c06\u8fd9\u4e24\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684\u6570\u636e\u5199\u5165Apollo\u3002\\n\\n\\n\\n### \u6570\u636e\u521d\u59cb\u5316\\n\\n\u5f53`admin`\u542f\u52a8\u540e\uff0c\u4f1a\u5c06\u5f53\u524d\u7684\u6570\u636e\u4fe1\u606f\u5168\u91cf\u540c\u6b65\u5230`apollo`\u4e2d\uff0c\u7531`ApolloDataChangedInit`\u5b9e\u73b0\uff1a\\n\\n```java\\n// \u7ee7\u627fAbstractDataChangedInit\\npublic class ApolloDataChangedInit extends AbstractDataChangedInit {\\n    // apollo\u64cd\u4f5c\u5bf9\u8c61\\n    private final ApolloClient apolloClient;\\n    \\n    public ApolloDataChangedInit(final ApolloClient apolloClient) {\\n        this.apolloClient = apolloClient;\\n    }\\n    \\n    @Override\\n    protected boolean notExist() {\\n        // \u5224\u65ad plugin\u3001auth\u3001meta\u3001proxy.selector\u7b49\u8282\u70b9\u662f\u5426\u5b58\u5728\\n        // \u53ea\u8981\u6709\u4e00\u4e2a\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u5165\u91cd\u65b0\u52a0\u8f7d(\u8fd9\u4e9b\u8282\u70b9\u4e0d\u4f1a\u521b\u5efa\uff0c\u4e3a\u4ec0\u4e48\u8981\u5224\u65ad\u4e00\u6b21\u5462\uff1f)\\n        return Stream.of(ApolloPathConstants.PLUGIN_DATA_ID, ApolloPathConstants.AUTH_DATA_ID, ApolloPathConstants.META_DATA_ID, ApolloPathConstants.PROXY_SELECTOR_DATA_ID).allMatch(\\n                this::dataIdNotExist);\\n    }\\n\\n    /**\\n     * Data id not exist boolean.\\n     *\\n     * @param pluginDataId the plugin data id\\n     * @return the boolean\\n     */\\n    private boolean dataIdNotExist(final String pluginDataId) {\\n        return Objects.isNull(apolloClient.getItemValue(pluginDataId));\\n    }\\n}\\n\\n```\\n\\n\u5224\u65ad`apollo`\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u884c\u540c\u6b65\u3002\\n\u8fd9\u91cc\u6709\u4e00\u4e2abug, \u56e0\u4e3a\u8fd9\u91cc\u5224\u65ad\u7684key\uff0c\u5728\u540c\u6b65\u65f6\uff0c\u5e76\u4e0d\u4f1a\u521b\u5efa\uff0c\u5219\u4f1a\u5bfc\u81f4\u6bcf\u6b21\u91cd\u542f\u65f6\u90fd\u91cd\u65b0\u52a0\u8f7d\u6570\u636e\uff0c\u5df2\u63d0[PR#5435](https://github.com/apache/shenyu/pull/5435)\\n\\n\\n`ApolloDataChangedInit`\u5b9e\u73b0\u4e86`CommandLineRunner`\u63a5\u53e3\u3002\u5b83\u662f`springboot`\u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u4f1a\u5728\u6240\u6709 `Spring Beans`\u521d\u59cb\u5316\u4e4b\u540e\u6267\u884c`run()`\u65b9\u6cd5\uff0c\u5e38\u7528\u4e8e\u9879\u76ee\u4e2d\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002\\n\\n- SyncDataService.syncAll()\\n\\n\u4ece\u6570\u636e\u5e93\u67e5\u8be2\u6570\u636e\uff0c\u7136\u540e\u8fdb\u884c\u5168\u91cf\u6570\u636e\u540c\u6b65\uff0c\u6240\u6709\u7684\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u3001\u5143\u6570\u636e\u3001\u4ee3\u7406\u9009\u62e9\u5668\u3001\u53d1\u73b0\u4e0b\u6e38\u4e8b\u4ef6\u3002\u4e3b\u8981\u662f\u901a\u8fc7`eventPublisher`\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\uff0c`eventPublisher`\u901a\u8fc7`publishEvent()`\u53d1\u5e03\u5b8c\u4e8b\u4ef6\u540e\uff0c\u6709`ApplicationListener`\u6267\u884c\u4e8b\u4ef6\u53d8\u66f4\u64cd\u4f5c\uff0c\u5728`ShenYu`\u4e2d\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684`DataChangedEventDispatcher`\u3002\\n\\n```java\\n@Service\\npublic class SyncDataServiceImpl implements SyncDataService {\\n    // \u4e8b\u4ef6\u53d1\u5e03\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n     /***\\n     * \u5168\u91cf\u6570\u636e\u540c\u6b65\\n     * @param type the type\\n     * @return\\n     */\\n     @Override\\n     public boolean syncAll(final DataEventTypeEnum type) {\\n         // \u540c\u6b65auth\u6570\u636e\\n         appAuthService.syncData();\\n         // \u540c\u6b65\u63d2\u4ef6\u6570\u636e\\n         List<PluginData> pluginDataList = pluginService.listAll();\\n         // \u901a\u8fc7spring\u53d1\u5e03/\u8ba2\u9605\u673a\u5236\u8fdb\u884c\u901a\u77e5\u8ba2\u9605\u8005(\u53d1\u5e03DataChangedEvent)\\n         // \u7edf\u4e00\u7531DataChangedEventDispatcher\u8fdb\u884c\u76d1\u542c\\n         // DataChangedEvent\u5e26\u4e0a\u4e86\u914d\u7f6e\u5206\u7ec4\u7c7b\u578b\u3001\u5f53\u524d\u64cd\u4f5c\u7c7b\u578b\u3001\u6570\u636e\\n         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));\\n         // \u540c\u6b65\u9009\u62e9\u5668\\n         List<SelectorData> selectorDataList = selectorService.listAll();\\n         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));\\n         // \u540c\u6b65\u89c4\u5219\\n         List<RuleData> ruleDataList = ruleService.listAll();\\n         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));\\n         //\u5143\u6570\u636e\\n         metaDataService.syncData();\\n         // \u4e0b\u6e38\u5217\u8868\\n         discoveryService.syncData();\\n         return true;\\n     }\\n    \\n}\\n```\\n\\n### bootstrap\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\\n\\n\u7f51\u5173\u8fd9\u8fb9\u7684\u6570\u636e\u540c\u6b65\u521d\u59cb\u5316\u64cd\u4f5c\u4e3b\u8981\u662f\u8ba2\u9605`apollo`\u4e2d\u7684\u8282\u70b9\uff0c\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u6536\u5230\u53d8\u66f4\u6570\u636e\u3002\u8fd9\u4f9d\u8d56\u4e8e`apollo`\u7684`listener`\u673a\u5236\u3002\u5728`ShenYu`\u4e2d\uff0c\u8d1f\u8d23`apollo`\u6570\u636e\u540c\u6b65\u7684\u662f`ApolloDataService`\u3002\\n\\n`ApolloDataService`\u7684\u529f\u80fd\u903b\u8f91\u662f\u5728\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\uff1a\u5bf9`apollo`\u4e2d\u7684`shenyu`\u6570\u636e\u540c\u6b65\u8282\u70b9\u5b8c\u6210\u8ba2\u9605\u3002\u901a\u8fc7`configService.addChangeListener()`\u65b9\u6cd5\u5b9e\u73b0\uff1b\\n\\n\\n```java\\npublic class ApolloDataService extends AbstractNodeDataSyncService implements SyncDataService {\\n    public ApolloDataService(final Config configService, final PluginDataSubscriber pluginDataSubscriber,\\n                             final List<MetaDataSubscriber> metaDataSubscribers,\\n                             final List<AuthDataSubscriber> authDataSubscribers,\\n                             final List<ProxySelectorDataSubscriber> proxySelectorDataSubscribers,\\n                             final List<DiscoveryUpstreamDataSubscriber> discoveryUpstreamDataSubscribers) {\\n        // \u914d\u7f6e\u76d1\u542c\u7684\u524d\u7f00\\n        super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,\\n                        ApolloPathConstants.SELECTOR_DATA_ID,\\n                        ApolloPathConstants.RULE_DATA_ID,\\n                        ApolloPathConstants.AUTH_DATA_ID,\\n                        ApolloPathConstants.META_DATA_ID,\\n                        ApolloPathConstants.PROXY_SELECTOR_DATA_ID,\\n                        ApolloPathConstants.DISCOVERY_DATA_ID),\\n                pluginDataSubscriber, metaDataSubscribers, authDataSubscribers, proxySelectorDataSubscribers, discoveryUpstreamDataSubscribers);\\n        this.configService = configService;\\n        // \u5f00\u59cb\u76d1\u542c\\n        // \u6ce8\uff1aApollo\u8be5\u65b9\u6cd5\uff0c\u53ea\u8d1f\u8d23\u83b7\u53d6apollo\u7684\u6570\u636e\u83b7\u53d6\uff0c\u5e76\u6dfb\u52a0\u5230\u672c\u5730\u7f13\u5b58\u4e2d\uff0c\u4e0d\u5904\u7406\u76d1\u542c\\n        startWatch();\\n        // \u914d\u7f6e\u76d1\u542c\\n        apolloWatchPrefixes();\\n    }\\n}\\n```\\n\\n\u9996\u5148\u914d\u7f6e\u9700\u8981\u5904\u7406\u7684key\u4fe1\u606f\uff0c\u540cadmin\u540c\u6b65\u7684key\u3002\u63a5\u7740\u8c03\u7528`startWatch()` \u65b9\u6cd5\u8fdb\u884c\u5904\u7406\u6570\u636e\u83b7\u53d6\u4e0e\u76d1\u542c\u3002\u4f46\u5bf9\u4e8eApollo\u7684\u5b9e\u73b0\u4e2d\uff0c\u8be5\u65b9\u6cd5\u53ea\u8d1f\u8d23\u5904\u7406\u6570\u636e\u7684\u83b7\u53d6\u5e76\u8bbe\u7f6e\u5230\u672c\u5730\u7f13\u5b58\u4e2d\u3002\\n\u76d1\u542c\u7531`apolloWatchPrefixes`\u65b9\u6cd5\u6765\u5904\u7406\\n\\n```java\\nprivate void apolloWatchPrefixes() {\\n        // \u5b9a\u4e49\u76d1\u542c\u5668\\n        final ConfigChangeListener listener = changeEvent -> {\\n            changeEvent.changedKeys().forEach(changeKey -> {\\n                try {\\n                    final ConfigChange configChange = changeEvent.getChange(changeKey);\\n                    // \u672a\u53d8\u66f4\u5219\u8df3\u8fc7\\n                    if (configChange == null) {\\n                        LOG.error(\\"apollo watchPrefixes error configChange is null {}\\", changeKey);\\n                        return;\\n                    }\\n                    final String newValue = configChange.getNewValue();\\n                    // skip last is \\"list\\"\\n                    // \u5982\u679c\u662flist\u7ed3\u5c3e\u7684Key\uff0c\u5982plugin.list\u5219\u8df3\u8fc7\uff0c\u56e0\u4e3a\u8fd9\u91cc\u53ea\u662f\u8bb0\u5f55\u751f\u6548\u7684\u4e00\u4e2a\u5217\u8868\uff0c\u4e0d\u4f1a\u5728\u672c\u5730\u7f13\u5b58\u4e2d\\n                    final int lastListStrIndex = changeKey.length() - DefaultNodeConstants.LIST_STR.length();\\n                    if (changeKey.lastIndexOf(DefaultNodeConstants.LIST_STR) == lastListStrIndex) {\\n                        return;\\n                    }\\n                    // \u5982\u679c\u662fplugin.\u5f00\u5934 => \u5904\u7406\u63d2\u4ef6\u6570\u636e\\n                    if (changeKey.indexOf(ApolloPathConstants.PLUGIN_DATA_ID) == 0) {\\n                        // \u5220\u9664\\n                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {\\n                            // \u6e05\u9664\u7f13\u5b58\\n                            unCachePluginData(changeKey);\\n                        } else {\\n                            // \u66f4\u65b0\u7f13\u5b58\\n                            cachePluginData(newValue);\\n                        }\\n                        // \u5982\u679c\u662fselector.\u5f00\u5934 => \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\\n                    } else if (changeKey.indexOf(ApolloPathConstants.SELECTOR_DATA_ID) == 0) {\\n                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {\\n                            unCacheSelectorData(changeKey);\\n                        } else {\\n                            cacheSelectorData(newValue);\\n                        }\\n                        // \u5982\u679c\u662frule.\u5f00\u5934 => \u5904\u7406\u89c4\u5219\u6570\u636e\\n                    } else if (changeKey.indexOf(ApolloPathConstants.RULE_DATA_ID) == 0) {\\n                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {\\n                            unCacheRuleData(changeKey);\\n                        } else {\\n                            cacheRuleData(newValue);\\n                        }\\n                        // \u5982\u679c\u662fauth.\u5f00\u5934 => \u5904\u7406\u6388\u6743\u6570\u636e\\n                    } else if (changeKey.indexOf(ApolloPathConstants.AUTH_DATA_ID) == 0) {\\n                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {\\n                            unCacheAuthData(changeKey);\\n                        } else {\\n                            cacheAuthData(newValue);\\n                        }\\n                        // \u5982\u679c\u662fmeta.\u5f00\u5934 => \u5904\u7406\u5143\u6570\u636e\\n                    } else if (changeKey.indexOf(ApolloPathConstants.META_DATA_ID) == 0) {\\n                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {\\n                            unCacheMetaData(changeKey);\\n                        } else {\\n                            cacheMetaData(newValue);\\n                        }\\n                        // \u5982\u679c\u662fproxy.selector.\u5f00\u5934 => \u5904\u7406\u4ee3\u7406\u9009\u62e9\u5668\u6570\u636e\\n                    } else if (changeKey.indexOf(ApolloPathConstants.PROXY_SELECTOR_DATA_ID) == 0) {\\n                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {\\n                            unCacheProxySelectorData(changeKey);\\n                        } else {\\n                            cacheProxySelectorData(newValue);\\n                        }\\n                        // \u5982\u679c\u662fdiscovery.\u5f00\u5934 => \u5904\u7406\u4e0b\u6e38\u5217\u8868\u6570\u636e\\n                    } else if (changeKey.indexOf(ApolloPathConstants.DISCOVERY_DATA_ID) == 0) {\\n                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {\\n                            unCacheDiscoveryUpstreamData(changeKey);\\n                        } else {\\n                            cacheDiscoveryUpstreamData(newValue);\\n                        }\\n                    }\\n                } catch (Exception e) {\\n                    LOG.error(\\"apollo sync listener change key handler error\\", e);\\n                }\\n            });\\n        };\\n        watchConfigChangeListener = listener;\\n        // \u6dfb\u52a0\u76d1\u542c\\n        configService.addChangeListener(listener, Collections.emptySet(), ApolloPathConstants.pathKeySet());\\n\\n    }\\n```\\n\\n\u7531\u524d\u9762admin\u52a0\u8f7d\u6570\u636e\u7684\u903b\u8f91\uff0c\u63d2\u4ef6\u53ea\u4f1a\u589e\u52a0\u4e24\u4e2aKey\uff1a`plugin.list` \u4e0e `plugin.${plugin.name}`,\u800c `plugin.list` \u662f\u6240\u6709\u542f\u7528\u7684\u63d2\u4ef6\u5217\u8868\uff0c\u8be5key\u7684\u6570\u636e\u5728\\n\u672c\u5730\u7f13\u5b58\u4e2d\u6ca1\u6709\u6570\u636e\uff0c\u53ea\u4f1a\u5173\u6ce8`plugin.${plugin.name}` key\u5bf9\u5e94\u7684\u6570\u636e\uff0c\u8fd9\u662f\u5bf9\u5e94\u7684\u63d2\u4ef6\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\\n\\n\u81f3\u6b64\uff0cbootstrap\u5728`apollo`\u4e2d\u7684\u540c\u6b65\u903b\u8f91\u5c31\u5206\u6790\u5b8c\u6210\u3002"},{"id":"/DataSync-SourceCode-Analysis-Etcd-Data-Sync","metadata":{"permalink":"/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync.md","title":"Etcd\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"etcd","permalink":"/zh/blog/tags/etcd"},{"label":"data sync","permalink":"/zh/blog/tags/data-sync"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":25.105,"hasTruncateMarker":false,"authors":[{"name":"4zd","title":"Apache ShenYu Contributor","url":"https://github.com/4zd"}],"frontMatter":{"title":"Etcd\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","author":"4zd","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/4zd","tags":["etcd","data sync","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Apollo\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync"},"nextItem":{"title":"Http\u957f\u8f6e\u8be2\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync"}},"content":"> [Apache ShenYu](https://shenyu.apache.org/zh/docs/index) \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 `API` \u7f51\u5173\u3002\\n\\n\u5728`ShenYu`\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002`Apache ShenYu` \u7f51\u5173\u5f53\u524d\u652f\u6301`ZooKeeper`\u3001`WebSocket`\u3001`Http\u957f\u8f6e\u8be2`\u3001`Nacos` \u3001`Etcd` \u548c `Consul` \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e`Etcd`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.4.0`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [\u6570\u636e\u540c\u6b65\u539f\u7406](https://shenyu.apache.org/zh/docs/design/data-sync) \u3002\\n\\n### 1. \u5173\u4e8eEtcd\\n\\n[`Etcd`](https://github.com/etcd-io/etcd)\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u7684\u952e\u503c\u5bf9\u5b58\u50a8\u7cfb\u7edf\uff0c\u5b83\u4e3a\u5927\u578b\u5206\u5e03\u5f0f\u8ba1\u7b97\u63d0\u4f9b\u5206\u5e03\u5f0f\u914d\u7f6e\u670d\u52a1\u3001\u540c\u6b65\u670d\u52a1\u548c\u547d\u540d\u6ce8\u518c\u3002\\n\\n### 2. Admin\u6570\u636e\u540c\u6b65\\n\\n\u6211\u4eec\u4ece\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\u8fdb\u884c\u6e90\u7801\u8ffd\u8e2a\uff0c\u6bd4\u5982\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u5bf9`Divide`\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff1a\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/update-selector-zh.png)\\n\\n#### 2.1 \u63a5\u6536\u6570\u636e\\n\\n- SelectorController.createSelector()\\n\\n\u8fdb\u5165`SelectorController`\u7c7b\u4e2d\u7684`updateSelector()`\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002\\n\\n```java\\n@Validated\\n@RequiredArgsConstructor\\n@RestController\\n@RequestMapping(\\"/selector\\")\\npublic class SelectorController {\\n    \\n    @PutMapping(\\"/{id}\\")\\n    public ShenyuAdminResult updateSelector(@PathVariable(\\"id\\") final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {\\n        // \u8bbe\u7f6e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636eid\\n        selectorDTO.setId(id);\\n        // \u521b\u5efa\u6216\u66f4\u65b0\u64cd\u4f5c\\n        Integer updateCount = selectorService.createOrUpdate(selectorDTO);\\n        // \u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\\n        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);\\n    }\\n    \\n    // ......\\n}\\n```\\n\\n#### 2.2 \u5904\u7406\u6570\u636e\\n\\n- SelectorServiceImpl.createOrUpdate()\\n\\n\u5728`SelectorServiceImpl`\u7c7b\u4e2d\u901a\u8fc7`createOrUpdate()`\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u66f4\u65b0`upstream`\u3002\\n\\n```java\\n@RequiredArgsConstructor\\n@Service\\npublic class SelectorServiceImpl implements SelectorService {\\n    // \u8d1f\u8d23\u4e8b\u4ef6\u53d1\u5e03\u7684eventPublisher\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n    @Override\\n    @Transactional(rollbackFor = Exception.class)\\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\\n        int selectorCount;\\n        // \u6784\u5efa\u6570\u636e DTO --\x3e DO\\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\\n        // \u5224\u65ad\u662f\u6dfb\u52a0\u8fd8\u662f\u66f4\u65b0\\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\\n            // \u63d2\u5165\u9009\u62e9\u5668\u6570\u636e\\n            selectorCount = selectorMapper.insertSelective(selectorDO);\\n            // \u63d2\u5165\u9009\u62e9\u5668\u4e2d\u7684\u6761\u4ef6\u6570\u636e\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\\n            });\\n            // check selector add\\n            // \u6743\u9650\u68c0\u67e5\\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\\n                dataPermissionDTO.setDataId(selectorDO.getId());\\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\\n            }\\n\\n        } else {\\n            // \u66f4\u65b0\u6570\u636e\uff0c\u5148\u5220\u9664\u518d\u65b0\u589e\\n            selectorCount = selectorMapper.updateSelective(selectorDO);\\n            //delete rule condition then add\\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\\n                selectorConditionMapper.insertSelective(selectorConditionDO);\\n            });\\n        }\\n        // \u53d1\u5e03\u4e8b\u4ef6\\n        publishEvent(selectorDO, selectorConditionDTOs);\\n\\n        // \u66f4\u65b0upstream\\n        updateDivideUpstream(selectorDO);\\n        return selectorCount;\\n    }\\n    \\n    \\n    // ......\\n    \\n}\\n\\n```\\n\\n\u5728`Service`\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u6df1\u5165\u8ffd\u8e2a\u4e86\u3002\u5173\u4e8e\u66f4\u65b0`upstream`\u64cd\u4f5c\uff0c\u653e\u5230\u540e\u9762\u5bf9\u5e94\u7684\u7ae0\u8282\u4e2d\u8fdb\u884c\u5206\u6790\uff0c\u91cd\u70b9\u5173\u6ce8\u53d1\u5e03\u4e8b\u4ef6\u7684\u64cd\u4f5c\uff0c\u5b83\u4f1a\u6267\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n`publishEvent()`\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u6784\u5efa\u6761\u4ef6\u6570\u636e\uff0c\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u3002\\n\\n```java\\n     private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\\n        // \u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\\n        // \u6784\u5efa\u6761\u4ef6\u6570\u636e\\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\\n        // \u53d1\u5e03\u53d8\u66f4\u6570\u636e\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\\n    }\\n```\\n\\n\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7`eventPublisher.publishEvent()`\u5b8c\u6210\uff0c\u8fd9\u4e2a`eventPublisher`\u5bf9\u8c61\u662f\u4e00\u4e2a`ApplicationEventPublisher`\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f`org.springframework.context.ApplicationEventPublisher`\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7`Spring`\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002\\n\\n> \u5173\u4e8e`ApplicationEventPublisher`\uff1a\\n>\\n> \u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 `ApplicationEventPublisher` \u7684 `publishEvent` \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c`Spring`\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 `onApplicationEvent` \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 `publishEvent`\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 `ApplicationEventPublisher` \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002\\n>\\n> - `ApplicationEventPublisher`\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b\\n> - `ApplicationEvent`\uff1a`Spring` \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b\\n> - `ApplicationListener`\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\uff1b\\n\\n\\n\u5728`Spring`\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c\\n\\n\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684`ApplicationEventPublisher`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a`eventPublisher`\u3002\\n\\n\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f`ApplicationEvent`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEvent`\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\npublic class DataChangedEvent extends ApplicationEvent {\\n//......\\n}\\n```\\n\\n\u6700\u540e\u4e00\u4e2a\u662f `ApplicationListener`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEventDispatcher`\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n    //......\\n    \\n}\\n```\\n\\n#### 2.3 \u5206\u53d1\u6570\u636e\\n\\n- DataChangedEventDispatcher.onApplicationEvent()\\n\\n\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230`DataChangedEventDispatcher`\u7c7b\u4e2d\u7684`onApplicationEvent()`\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n  /**\\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\\n     * @param event\\n     */\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\\n                    break;\\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\\n                    break;\\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\\n                    break;\\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\\n                    break;\\n                case META_DATA:  // \u5143\u6570\u636e\\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\\n                    break;\\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\\n                    throw new IllegalStateException(\\"Unexpected value: \\" + event.getGroupKey());\\n            }\\n        }\\n    }\\n    \\n}\\n```\\n\\n\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528`onApplicationEvent`\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002\\n\\n`ShenYu`\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u662f\u4e94\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u548c\u5143\u6570\u636e\u3002\\n\\n\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08`DataChangedListener`\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u5b83\u7684\u5177\u4f53\u5b9e\u73b0\u6709\uff1a\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/data-changed-listener.png)\\n\\n\u8fd9\u51e0\u4e2a\u5b9e\u73b0\u7c7b\u5c31\u662f\u5f53\u524d`ShenYu`\u652f\u6301\u7684\u540c\u6b65\u7b56\u7565\uff1a\\n\\n- `WebsocketDataChangedListener`\uff1a\u57fa\u4e8e`websocket`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ZookeeperDataChangedListener`\uff1a\u57fa\u4e8e`zookeeper`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ConsulDataChangedListener`\uff1a\u57fa\u4e8e`consul`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `EtcdDataDataChangedListener`\uff1a\u57fa\u4e8e`etcd`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `HttpLongPollingDataChangedListener`\uff1a\u57fa\u4e8e`http\u957f\u8f6e\u8be2`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `NacosDataChangedListener`\uff1a\u57fa\u4e8e`nacos`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n\\n\u65e2\u7136\u6709\u8fd9\u4e48\u591a\u79cd\u5b9e\u73b0\u7b56\u7565\uff0c\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u5462\uff1f\\n\\n\u56e0\u4e3a\u672c\u6587\u662f\u57fa\u4e8e`Etcd`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ee5`EtcdDataDataChangedListener`\u4e3a\u4f8b\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u88ab\u52a0\u8f7d\u5e76\u5b9e\u73b0\u7684\u3002\\n\\n\u901a\u8fc7\u67e5\u770b\u5bf9`EtcdDataDataChangedListener`\u7c7b\u7684\u8c03\u7528\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u5b83\u662f\u5728`DataSyncConfiguration`\u7c7b\u8fdb\u884c\u914d\u7f6e\u7684\u3002\\n\\n```java\\n/**\\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\\n * The type Data sync configuration.\\n */\\n@Configuration\\npublic class DataSyncConfiguration {\\n\\n   //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\\n  \\n  /**\\n   * The type Etcd listener.\\n   */\\n  @Configuration\\n  @ConditionalOnProperty(prefix = \\"shenyu.sync.etcd\\", name = \\"url\\")\\n  @EnableConfigurationProperties(EtcdProperties.class)\\n  static class EtcdListener {\\n\\n    @Bean\\n    public EtcdClient etcdClient(final EtcdProperties etcdProperties) {\\n      Client client = Client.builder()\\n              .endpoints(etcdProperties.getUrl())\\n              .build();\\n      return new EtcdClient(client);\\n    }\\n\\n    /**\\n     * Config event listener data changed listener.\\n     * \u521b\u5efaEtcd\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\n     * @param etcdClient the etcd client\\n     * @return the data changed listener\\n     */\\n    @Bean\\n    @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)\\n    public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {\\n      return new EtcdDataDataChangedListener(etcdClient);\\n    }\\n\\n    /**\\n     * data init.\\n     * \u521b\u5efaEtcd\u6570\u636e\u521d\u59cb\u5316\u7c7b\\n     * @param etcdClient        the etcd client\\n     * @param syncDataService the sync data service\\n     * @return the etcd data init\\n     */\\n    @Bean\\n    @ConditionalOnMissingBean(EtcdDataInit.class)\\n    public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {\\n      return new EtcdDataInit(etcdClient, syncDataService);\\n    }\\n  }\\n    \\n    //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\\n}\\n\\n```\\n\\n\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u662f\u901a\u8fc7`SpringBoot`\u6761\u4ef6\u88c5\u914d\u7c7b\u5b9e\u73b0\u7684\u3002\u5728`EtcdListener`\u7c7b\u4e0a\u9762\u6709\u51e0\u4e2a\u6ce8\u89e3\uff1a\\n\\n- `@Configuration`\uff1a\u914d\u7f6e\u6587\u4ef6\uff0c\u5e94\u7528\u4e0a\u4e0b\u6587\uff1b\\n\\n- `@ConditionalOnProperty(prefix = \\"shenyu.sync.etcd\\", name = \\"url\\")`\uff1a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u91c7\u7528`etcd`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n  ```properties\\n  shenyu:  \\n    sync:\\n       etcd:\\n            url: localhost:2181\\n  ```\\n\\n- `@EnableConfigurationProperties(EtcdProperties.class)`\uff1a\u5bfc\u5165\u53e6\u4e00\u4e2a\u5c5e\u6027\u7c7b`EtcdProperties`\uff0c`EtcdProperties`\u4e2d\u5404\u5c5e\u6027\u5bf9\u5e94\u914d\u7f6e\u6587\u4ef6\u4e2d\u4ee5`shenyu.sync.etcd`\u4f5c\u4e3a\u524d\u7f00\u7684\u5404\u5c5e\u6027\u3002\\n\\n```java\\n@Data\\n@ConfigurationProperties(prefix = \\"shenyu.sync.etcd\\")\\npublic class EtcdProperties {\\n\\n  private String url;\\n\\n  private Integer sessionTimeout;\\n\\n  private Integer connectionTimeout;\\n\\n  private String serializer;\\n}\\n```\\n\\n\u5f53\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\u4e86`shenyu.sync.etcd.url`\u5c5e\u6027\u65f6\uff0c`Admin`\u5c06\u91c7\u7528`etcd`\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u6b64\u65f6\u914d\u7f6e\u7c7b`EtcdListener`\u4f1a\u751f\u6548\uff0c\u5e76\u751f\u6210`EtcdClient`, `EtcdDataDataChangedListener`\u548c`EtcdDataInit`\u7c7b\u578b\u7684bean\u3002\\n* \u751f\u6210`EtcdClient`\u7c7b\u578b\u7684bean\uff0c`etcdClient`\uff0c\u8fd9\u4e2abean\u6839\u636e\u914d\u7f6e\u6587\u4ef6\uff0c\u914d\u7f6e\u4e86\u4e0eetcd\u670d\u52a1\u5668\u7684\u8fde\u63a5\u4fe1\u606f\uff0c\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5cetcd\u8282\u70b9\u3002\\n* \u751f\u6210`EtcdDataDataChangedListener`\u7c7b\u578b\u7684bean\uff0c`etcdDataDataChangedListener`\uff0c\u8fd9\u4e2abean\u5c06bean`etcdClient`\u4f5c\u4e3a\u6210\u5458\u53d8\u91cf\uff0c\u5f53\u76d1\u542c\u5230\u4e8b\u4ef6\u65f6\uff0c\u8fdb\u884c\u56de\u8c03\u64cd\u4f5c\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8be5bean\u64cd\u4f5cetcd\u8282\u70b9\u3002\\n* \u751f\u6210`EtcdDataInit`\u7c7b\u578b\u7684bean\uff0c`etcdDataInit`\uff0c\u8fd9\u4e2abean\u5c06bean`etcdClient`\u548cbean`syncDataService`\u4f5c\u4e3a\u6210\u5458\u53d8\u91cf\uff0c\u4f7f\u7528`etcdClient`\u6839\u636eetcd\u8def\u5f84\uff0c\u5224\u65ad\u6570\u636e\u662f\u5426\u672a\u521d\u59cb\u5316\uff0c\u5f53\u672a\u521d\u59cb\u5316\u65f6\uff0c\u5c06\u8c03\u7528syncDataService\u8fdb\u884c\u5237\u65b0\u64cd\u4f5c\uff0c\u5c06\u5728\u4e0b\u6587\u8be6\u8ff0\u3002\\n\u6839\u636e\u4e0a\u6587\u6240\u8ff0\uff0c\u5728\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5`onApplicationEvent()`\u4e2d\uff0c\u5c31\u4f1a\u5230\u76f8\u5e94\u7684`listener`\u4e2d\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u662f\u5bf9\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u6570\u636e\u540c\u6b65\u91c7\u7528\u7684\u662f`etcd`\uff0c\u6240\u4ee5\uff0c\u4ee3\u7801\u4f1a\u8fdb\u5165\u5230`EtcdDataDataChangedListener`\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\u3002\\n\\n```java\\n    //DataChangedEventDispatcher.java\\n\\t\\t@Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                    \\n                // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n                    \\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // \u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u4f1a\u8fdb\u5165\u5230EtcdDataDataChangedListener\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\\n                    break;\\n         }\\n    }\\n```\\n\\n#### 2.4 Etcd\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\n\\n- EtcdDataDataChangedListener.onSelectorChanged()\\n\\n  \u5728`onSelectorChanged()`\u65b9\u6cd5\u4e2d\uff0c\u5224\u65ad\u64cd\u4f5c\u7c7b\u578b\uff0c\u662f\u5237\u65b0\u540c\u6b65\u8fd8\u662f\u66f4\u65b0\u6216\u521b\u5efa\u540c\u6b65\u3002\u6839\u636e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636e\u4fe1\u606f\u5224\u65ad\u8282\u70b9\u662f\u5426\u5728`etcd`\u4e2d\u3002\\n\\n```java\\n/**\\n * EtcdDataDataChangedListener.\\n */\\n@Slf4j\\npublic class EtcdDataDataChangedListener implements DataChangedListener {\\n\\n    private final EtcdClient etcdClient;\\n\\n    public EtcdDataDataChangedListener(final EtcdClient client) {\\n        this.etcdClient = client;\\n    }\\n\\n    // \u9009\u62e9\u5668\u4fe1\u606f\u53d1\u751f\u6539\u53d8\\n    @Override\\n    public void onSelectorChanged(final List<SelectorData> changed, final DataEventTypeEnum eventType) {\\n      // \u5237\u65b0\u64cd\u4f5c\\n      if (eventType == DataEventTypeEnum.REFRESH && !changed.isEmpty()) {\\n        String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());\\n        etcdClient.deleteEtcdPathRecursive(selectorParentPath);\\n      }\\n      // \u53d1\u751f\u53d8\u66f4\u7684\u6570\u636e\\n      for (SelectorData data : changed) {\\n        // \u6784\u5efa\u9009\u62e9\u5668\u6570\u636e\u7684\u771f\u5b9e\u8def\u5f84\\n        String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());\\n        //\u5220\u9664\u64cd\u4f5c\\n        if (eventType == DataEventTypeEnum.DELETE) {\\n          etcdClient.delete(selectorRealPath);\\n          continue;\\n        }\\n        //create or update\uff0c\u521b\u5efa\u6216\u66f4\u65b0\u64cd\u4f5c\\n        updateNode(selectorRealPath, data);\\n      }\\n    }\\n    \\n}\\n```\\n\\n\u8fd9\u90e8\u5206\u662f\u6838\u5fc3\u3002`changed`\u8868\u793a\u9700\u66f4\u65b0\u7684`SelectorData`\u5217\u8868\uff0c`eventType`\u8868\u793a\u4e8b\u4ef6\u7c7b\u578b\u3002\u5f53\u4e8b\u4ef6\u7c7b\u578b\u4e3a\u5237\u65b0`REFRESH`\uff0c\u5e76\u4e14`SelectorData`\u6709\u6539\u52a8\u65f6\uff0c\u4f1a\u5148\u5c06etcd\u4e2d\u8be5plugin\u4e0b\u7684selector\u8282\u70b9\u90fd\u5148\u5220\u9664\u3002\u6ce8\u610f\u8fd9\u91cc\u7684\u6761\u4ef6`SelectorData`\u6709\u6539\u52a8\u662f\u5fc5\u987b\u7684\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u6ca1\u6709\u6539\u52a8\u65f6\u8fdb\u884c\u5237\u65b0\uff0c\u5c06\u6240\u6709selector\u8282\u70b9\u90fd\u5220\u9664\u7684bug\u3002\\n\u83b7\u53d6\u5230selector\u5bf9\u5e94\u8def\u5f84\u540e\uff0c\u4f1a\u5bf9\u8282\u70b9\u8fdb\u884c\u5220\u9664\u3001\u521b\u5efa\u6216\u66f4\u65b0\u3002\\n\\n\u53ea\u8981\u5c06\u53d8\u52a8\u7684\u6570\u636e\u6b63\u786e\u5199\u5165\u5230`etcd`\u7684\u8282\u70b9\u4e0a\uff0c`admin`\u8fd9\u8fb9\u7684\u64cd\u4f5c\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002\\n\\n\u5728\u6211\u4eec\u5f53\u524d\u7684\u6848\u4f8b\u4e2d\uff0c\u5bf9`Divide`\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff0c\u5c31\u4f1a\u5bf9\u56fe\u4e2d\u7684\u7279\u5b9a\u8282\u70b9\u66f4\u65b0\u3002\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/zookeeper-node.png)\\n\\n\\n\u6211\u4eec\u7528\u65f6\u5e8f\u56fe\u5c06\u4e0a\u9762\u7684\u66f4\u65b0\u6d41\u7a0b\u4e32\u8054\u8d77\u6765\u3002\\n\\n![](/img/activities/code-analysis-etcd-data-sync/etcd-sync-sequence-admin-zh.png)\\n\\n\\n### 3. \u7f51\u5173\u6570\u636e\u540c\u6b65\\n\\n\u5047\u8bbe`ShenYu`\u7f51\u5173\u5df2\u7ecf\u5728\u6b63\u5e38\u8fd0\u884c\uff0c\u4f7f\u7528\u7684\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e5f\u662f`etcd`\u3002\u90a3\u4e48\u5f53\u5728`admin`\u7aef\u66f4\u65b0\u9009\u62e9\u5668\u6570\u636e\u540e\uff0c\u5e76\u4e14\u5411`etcd`\u53d1\u9001\u4e86\u53d8\u66f4\u7684\u6570\u636e\uff0c\u90a3\u7f51\u5173\u662f\u5982\u4f55\u63a5\u6536\u5e76\u5904\u7406\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7ee7\u7eed\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u4e00\u63a2\u7a76\u7adf\u3002\\n\\n#### 3.1 EtcdClient\u63a5\u6536\u6570\u636e\\n\\n- EtcdClient.watchDataChange()\\n\\n\u5728\u7f51\u5173\u7aef\u6709\u4e00\u4e2a`EtcdSyncDataService`\u7c7b\uff0c\u5b83\u901a\u8fc7`etcdClient`\u8ba2\u9605\u4e86\u6570\u636e\u8282\u70b9\uff0c\u5f53\u6570\u636e\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u53ef\u4ee5\u611f\u77e5\u5230\u3002\\n\\n```java\\n/**\\n * Data synchronize of etcd.\\n */\\n@Slf4j\\npublic class EtcdSyncDataService implements SyncDataService, AutoCloseable {\\n    //\u7701\u7565\u5176\u5b83\u4ee3\u7801\\n    private void subscribeSelectorDataChanges(final String path) {\\n      etcdClient.watchDataChange(path, (updateNode, updateValue) -> cacheSelectorData(updateValue),\\n              this::unCacheSelectorData);\\n    }\\n  //\u7701\u7565\u5176\u5b83\u4ee3\u7801\\n}\\n```\\n\\n`Etcd`\u7684`Watch`\u673a\u5236\uff0c\u4f1a\u7ed9\u8ba2\u9605\u7684\u5ba2\u6237\u7aef\u53d1\u9001\u8282\u70b9\u53d8\u66f4\u901a\u77e5\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u66f4\u65b0\u9009\u62e9\u5668\u4fe1\u606f\uff0c\u5c31\u4f1a\u8fdb\u5165\u5230`watchDataChange()`\u65b9\u6cd5\u3002\u901a\u8fc7`cacheSelectorData()`\u53bb\u5904\u7406\u6570\u636e\u3002\\n\\n#### 3.2 \u5904\u7406\u6570\u636e\\n\\n- EtcdSyncDataService.cacheSelectorData()\\n\\n\u7ecf\u8fc7\u5224\u7a7a\u903b\u8f91\u4e4b\u540e\uff0c\u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684\u64cd\u4f5c\u53c8\u4ea4\u7ed9\u4e86`PluginDataSubscriber`\u5904\u7406\u3002\\n\\n```java\\n    private void cacheSelectorData(final String dataString) {\\n        final SelectorData selectorData = GsonUtils.getInstance().fromJson(dataString, SelectorData.class);\\n        Optional.ofNullable(selectorData)\\n            .ifPresent(data -> Optional.ofNullable(pluginDataSubscriber).ifPresent(e -> e.onSelectorSubscribe(data)));\\n        }\\n```\\n\\n`PluginDataSubscriber`\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b83\u53ea\u6709\u4e00\u4e2a`CommonPluginDataSubscriber`\u5b9e\u73b0\u7c7b\uff0c\u8d1f\u8d23\u5904\u7406\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\u3002\\n\\n\\n#### 3.3 \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\\n\\n- PluginDataSubscriber.onSelectorSubscribe()\\n\\n\u5b83\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528`subscribeDataHandler()`\u65b9\u6cd5\u3002\u5728\u65b9\u6cd5\u4e2d\uff0c\u66f4\u5177\u6570\u636e\u7c7b\u578b\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u6216\u89c4\u5219\uff09\uff0c\u64cd\u4f5c\u7c7b\u578b\uff08\u66f4\u65b0\u6216\u5220\u9664\uff09\uff0c\u53bb\u6267\u884c\u4e0d\u540c\u903b\u8f91\u3002\\n\\n```java\\n/**\\n * \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\\n * The type Common plugin data subscriber.\\n */\\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\\n    //......\\n     // \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\\n    @Override\\n    public void onSelectorSubscribe(final SelectorData selectorData) {\\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\\n    }    \\n    \\n    // \u8ba2\u9605\u6570\u636e\u5904\u7406\u5668\uff0c\u5904\u7406\u6570\u636e\u7684\u66f4\u65b0\u6216\u5220\u9664\\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\\n        Optional.ofNullable(classData).ifPresent(data -> {\\n            // \u63d2\u4ef6\u6570\u636e\\n            if (data instanceof PluginData) {\\n                PluginData pluginData = (PluginData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cachePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\\n                }\\n            } else if (data instanceof SelectorData) {  // \u9009\u62e9\u5668\u6570\u636e\\n                SelectorData selectorData = (SelectorData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\\n                }\\n            } else if (data instanceof RuleData) {  // \u89c4\u5219\u6570\u636e\\n                RuleData ruleData = (RuleData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) { // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\\n                }\\n            }\\n        });\\n    }\\n    \\n}\\n```\\n\\n\\n#### 3.4 \u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58\\n\\n\u90a3\u4e48\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684\u903b\u8f91\uff1a\\n\\n```java\\n// \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\nBaseDataCache.getInstance().cacheSelectData(selectorData);\\n// \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    \\nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n```\\n\\n\u4e00\u662f\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u7684\u5185\u5b58\u4e2d\u3002`BaseDataCache`\u662f\u6700\u7ec8\u7f13\u5b58\u6570\u636e\u7684\u7c7b\uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\u3002\u9009\u62e9\u5668\u6570\u636e\u5c31\u5b58\u5230\u4e86`SELECTOR_MAP`\u8fd9\u4e2a`Map`\u4e2d\u3002\u5728\u540e\u7eed\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e5f\u662f\u4ece\u8fd9\u91cc\u62ff\u6570\u636e\u3002\\n\\n```java\\npublic final class BaseDataCache {\\n    // \u79c1\u6709\u53d8\u91cf\\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\\n  \\t// \u79c1\u6709\u6784\u9020\u5668\\n    private BaseDataCache() {\\n    }\\n    \\n    /**\\n     * Gets instance.\\n     *  \u516c\u5f00\u65b9\u6cd5\\n     * @return the instance\\n     */\\n    public static BaseDataCache getInstance() {\\n        return INSTANCE;\\n    }\\n    \\n    /**\\n    *  \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684Map\\n     * pluginName -> SelectorData.\\n     */\\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\\n    \\n    public void cacheSelectData(final SelectorData selectorData) {\\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\\n    }\\n        \\n   /**\\n     * cache selector data.\\n     * \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\\n     * @param data the selector data\\n     */\\n    private void selectorAccept(final SelectorData data) {\\n        String key = data.getPluginName();\\n        if (SELECTOR_MAP.containsKey(key)) { // \u66f4\u65b0\u64cd\u4f5c\uff0c\u5148\u5220\u9664\u518d\u63d2\u5165\\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\\n            resultList.add(data);\\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\\n            SELECTOR_MAP.put(key, collect);\\n        } else {  // \u65b0\u589e\u64cd\u4f5c\uff0c\u76f4\u63a5\u653e\u5230Map\u4e2d\\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\\n        }\\n    }\\n    \\n}\\n```\\n\\n\u4e8c\u662f\u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\u3002  \u901a\u8fc7`idea`\u7f16\u8f91\u5668\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u540e\uff0c\u6709\u5982\u4e0b\u7684\u63d2\u4ef6\u8fd8\u6709\u5904\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u5c55\u5f00\u4e86\u3002\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/handler-selector.png)\\n\\n\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u6e90\u7801\u8ffd\u8e2a\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\uff0c\u5728`admin`\u7aef\u65b0\u589e\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u5c31\u5c06`etcd`\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5206\u6790\u6e05\u695a\u4e86\u3002\\n\\n\u6211\u4eec\u8fd8\u662f\u901a\u8fc7\u65f6\u5e8f\u56fe\u5c06\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u6d41\u7a0b\u4e32\u8054\u4e00\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-etcd-data-sync/etcd-sync-sequence-gateway-zh.png)\\n\\n\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5df2\u7ecf\u5206\u6790\u5b8c\u4e86\uff0c\u4e3a\u4e86\u4e0d\u8ba9\u540c\u6b65\u6d41\u7a0b\u88ab\u6253\u65ad\uff0c\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\u5c31\u5ffd\u7565\u4e86\u5176\u4ed6\u903b\u8f91\u3002\u6211\u4eec\u8fd8\u9700\u8981\u5206\u6790`Admin`\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\u548c\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\u7684\u6d41\u7a0b\u3002\\n\\n### 4. Admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\\n\\n\u5f53`admin`\u542f\u52a8\u540e\uff0c\u4f1a\u5c06\u5f53\u524d\u7684\u6570\u636e\u4fe1\u606f\u5168\u91cf\u540c\u6b65\u5230`etcd`\u4e2d\uff0c\u5b9e\u73b0\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n```java\\n\\n/**\\n * EtcdDataInit.\\n */\\n@Slf4j\\npublic class EtcdDataInit implements CommandLineRunner {\\n\\n  private final EtcdClient etcdClient;\\n\\n  private final SyncDataService syncDataService;\\n\\n  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {\\n    this.etcdClient = client;\\n    this.syncDataService = syncDataService;\\n  }\\n\\n  @Override\\n  public void run(final String... args) throws Exception {\\n    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;\\n    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;\\n    final String metaDataPath = DefaultPathConstants.META_DATA;\\n    if (!etcdClient.exists(pluginPath) && !etcdClient.exists(authPath) && !etcdClient.exists(metaDataPath)) {\\n      log.info(\\"Init all data from database\\");\\n      syncDataService.syncAll(DataEventTypeEnum.REFRESH);\\n    }\\n  }\\n}\\n\\n```\\n\\n\u5224\u65ad`etcd`\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u884c\u540c\u6b65\u3002\\n\\n`EtcdDataInit`\u5b9e\u73b0\u4e86`CommandLineRunner`\u63a5\u53e3\u3002\u5b83\u662f`springboot`\u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u4f1a\u5728\u6240\u6709 `Spring Beans`\u521d\u59cb\u5316\u4e4b\u540e\u6267\u884c`run()`\u65b9\u6cd5\uff0c\u5e38\u7528\u4e8e\u9879\u76ee\u4e2d\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002\\n\\n- SyncDataService.syncAll()\\n\\n\u4ece\u6570\u636e\u5e93\u67e5\u8be2\u6570\u636e\uff0c\u7136\u540e\u8fdb\u884c\u5168\u91cf\u6570\u636e\u540c\u6b65\uff0c\u6240\u6709\u7684\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002\u4e3b\u8981\u662f\u901a\u8fc7`eventPublisher`\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u3002\u8fd9\u91cc\u5c31\u8ddf\u524d\u9762\u63d0\u5230\u7684\u540c\u6b65\u903b\u8f91\u5c31\u53c8\u8054\u7cfb\u8d77\u6765\u4e86\uff0c`eventPublisher`\u901a\u8fc7`publishEvent()`\u53d1\u5e03\u5b8c\u4e8b\u4ef6\u540e\uff0c\u6709`ApplicationListener`\u6267\u884c\u4e8b\u4ef6\u53d8\u66f4\u64cd\u4f5c\uff0c\u5728`ShenYu`\u4e2d\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684`DataChangedEventDispatcher`\u3002\\n\\n```java\\n@Service\\npublic class SyncDataServiceImpl implements SyncDataService {\\n    // \u4e8b\u4ef6\u53d1\u5e03\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n     /***\\n     * \u5168\u91cf\u6570\u636e\u540c\u6b65\\n     * @param type the type\\n     * @return\\n     */\\n    @Override\\n    public boolean syncAll(final DataEventTypeEnum type) {\\n        // \u540c\u6b65\u8ba4\u8bc1\u4fe1\u606f\\n        appAuthService.syncData();\\n        // \u540c\u6b65\u63d2\u4ef6\u4fe1\u606f\\n        List<PluginData> pluginDataList = pluginService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));\\n        // \u540c\u6b65\u9009\u62e9\u5668\u4fe1\u606f\\n        List<SelectorData> selectorDataList = selectorService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));\\n        // \u540c\u6b65\u89c4\u5219\u4fe1\u606f\\n        List<RuleData> ruleDataList = ruleService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));\\n        // \u540c\u6b65\u5143\u6570\u636e\u4fe1\u606f\\n        metaDataService.syncData();\\n        return true;\\n    }\\n    \\n}\\n```\\n\\n### 5. \u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\\n\\n\u7f51\u5173\u8fd9\u8fb9\u7684\u6570\u636e\u540c\u6b65\u521d\u59cb\u5316\u64cd\u4f5c\u4e3b\u8981\u662f\u8ba2\u9605`etcd`\u4e2d\u7684\u8282\u70b9\uff0c\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u6536\u5230\u53d8\u66f4\u6570\u636e\u3002\u8fd9\u4f9d\u8d56\u4e8e`Etcd`\u7684`Watch`\u673a\u5236\u3002\u5728`ShenYu`\u4e2d\uff0c\u8d1f\u8d23`etcd`\u6570\u636e\u540c\u6b65\u7684\u662f`EtcdSyncDataService`\uff0c\u4e5f\u5728\u524d\u9762\u63d0\u5230\u8fc7\u3002\\n\\n`EtcdSyncDataService`\u7684\u529f\u80fd\u903b\u8f91\u662f\u5728\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\uff1a\u5bf9`etcd`\u4e2d\u7684`shenyu`\u6570\u636e\u540c\u6b65\u8282\u70b9\u5b8c\u6210\u8ba2\u9605\u3002\u8fd9\u91cc\u7684\u8ba2\u9605\u5206\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u5df2\u7ecf\u5b58\u5728\u7684\u8282\u70b9\u4e0a\u9762\u6570\u636e\u53d1\u751f\u66f4\u65b0\uff0c\u8fd9\u901a\u8fc7`etcdClient.watchDataChange()`\u65b9\u6cd5\u5b9e\u73b0\uff1b\u53e6\u4e00\u7c7b\u662f\u5f53\u524d\u8282\u70b9\u4e0b\u6709\u65b0\u589e\u6216\u5220\u9664\u8282\u70b9\uff0c\u5373\u5b50\u8282\u70b9\u53d1\u751f\u53d8\u5316\uff0c\u8fd9\u901a\u8fc7`etcdClient.watchChildChange()`\u65b9\u6cd5\u5b9e\u73b0\u3002\\n\\n\\n`EtcdSyncDataService`\u7684\u4ee3\u7801\u6709\u70b9\u591a\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5\u63d2\u4ef6\u6570\u636e\u7684\u8bfb\u53d6\u548c\u8ba2\u9605\u8fdb\u884c\u8ffd\u8e2a\uff0c\u5176\u4ed6\u7c7b\u578b\u7684\u6570\u636e\u64cd\u4f5c\u539f\u7406\u662f\u4e00\u6837\u7684\u3002\\n\\n```java\\n/**\\n * etcd \u6570\u636e\u540c\u6b65\u670d\u52a1\\n */\\n@Slf4j\\npublic class EtcdSyncDataService implements SyncDataService, AutoCloseable {\\n  // \u5728\u5b9e\u4f8b\u5316\u7684\u65f6\u5019\uff0c\u5b8c\u6210\u4eceetcd\u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u5e76\u8ba2\u9605\u8282\u70b9\\n  public EtcdSyncDataService(/*\u7701\u7565\u6784\u9020\u53c2\u6570*/) {\\n    this.etcdClient = etcdClient;\\n    this.pluginDataSubscriber = pluginDataSubscriber;\\n    this.metaDataSubscribers = metaDataSubscribers;\\n    this.authDataSubscribers = authDataSubscribers;\\n    // \u8ba2\u9605\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\\n    watcherData();\\n    // \u8ba2\u9605\u8ba4\u8bc1\u6570\u636e\\n    watchAppAuth();\\n    // \u8ba2\u9605\u5143\u6570\u636e\\n    watchMetaData();\\n  }\\n\\n  private void watcherData() {\\n    // \u63d2\u4ef6\u8282\u70b9\u8def\u5f84\\n    final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;\\n    // \u6240\u6709\u63d2\u4ef6\u8282\u70b9\\n    List<String> pluginZKs = etcdClientGetChildren(pluginParent);\\n    for (String pluginName : pluginZKs) {\\n      // \u8ba2\u9605\u5f53\u524d\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\\n      watcherAll(pluginName);\\n    }\\n    // \u8ba2\u9605\u5b50\u8282\u70b9\uff08\u65b0\u589e\u6216\u5220\u9664\u4e00\u4e2a\u63d2\u4ef6\uff09\\n    etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -> {\\n      if (!updateNode.isEmpty()) {\\n        // \u9700\u8981\u8ba2\u9605\u5b50\u8282\u70b9\u7684\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\\n        watcherAll(updateNode);\\n      }\\n    }, null);\\n  }\\n\\n  private void watcherAll(final String pluginName) {\\n    // \u8ba2\u9605\u63d2\u4ef6\u6570\u636e\\n    watcherPlugin(pluginName);\\n    // \u8ba2\u9605\u9009\u62e9\u5668\u6570\u636e\\n    watcherSelector(pluginName);\\n    // \u8ba2\u9605\u89c4\u5219\u6570\u636e\\n    watcherRule(pluginName);\\n  }\\n\\n  private void watcherPlugin(final String pluginName) {\\n    // \u5f53\u524d\u63d2\u4ef6\u8def\u5f84\\n    String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);\\n    // \u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d\\n    cachePluginData(etcdClient.get(pluginPath));\\n    // \u8ba2\u9605\u63d2\u4ef6\u8282\u70b9\\n    subscribePluginDataChanges(pluginPath, pluginName);\\n  }\\n  \\n  private void cachePluginData(final String dataString) {\\n    final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);\\n    Optional.ofNullable(pluginData)\\n      .flatMap(data -> Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -> e.onSubscribe(pluginData));\\n  }  \\n\\n  private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {\\n    // \u8ba2\u9605\u6570\u636e\u53d8\u66f4\uff1a\u66f4\u65b0\u6216\u5220\u9664\uff0c\u4e24\u4e2alambda\u8868\u8fbe\u5f0f\u5206\u522b\u4e3a\u66f4\u65b0\u548c\u5220\u9664\u64cd\u4f5c\\n    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -> {\\n      final String dataPath = buildRealPath(pluginPath, updatePath);\\n      final String dataStr = etcdClient.get(dataPath);\\n      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);\\n      Optional.ofNullable(data)\\n              .ifPresent(d -> Optional.ofNullable(pluginDataSubscriber).ifPresent(e -> e.onSubscribe(d)));\\n    }, deleteNode -> deletePlugin(pluginName));\\n  }\\n\\n}\\n```\\n\\n\u4e0a\u9762\u7684\u6e90\u4ee3\u7801\u4e2d\u90fd\u7ed9\u51fa\u4e86\u6ce8\u91ca\uff0c\u76f8\u4fe1\u5927\u5bb6\u53ef\u4ee5\u770b\u660e\u767d\u3002\u8ba2\u9605\u63d2\u4ef6\u6570\u636e\u7684\u4e3b\u8981\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n> 1. \u6784\u9020\u5f53\u524d\u63d2\u4ef6\u8def\u5f84\\n> 2. \u8bfb\u53d6etcd\u4e0a\u5f53\u524d\u8282\u70b9\u6570\u636e\uff0c\u5e76\u53cd\u5e8f\u5217\u5316\\n> 4. \u63d2\u4ef6\u6570\u636e\u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d\\n> 5. \u8ba2\u9605\u63d2\u4ef6\u8282\u70b9\\n\\n\\n### 6. \u603b\u7ed3\\n\\n\u672c\u6587\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\uff0c\u5bf9`etcd`\u7684\u6570\u636e\u540c\u6b65\u539f\u7406\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a\\n\\n- \u57fa\u4e8e`etcd`\u7684\u6570\u636e\u540c\u6b65\uff0c\u4e3b\u8981\u662f\u901a\u8fc7`watch`\u673a\u5236\u5b9e\u73b0\uff1b\\n- \u901a\u8fc7`Spring`\u5b8c\u6210\u4e8b\u4ef6\u53d1\u5e03\u548c\u76d1\u542c\uff1b\\n- \u901a\u8fc7\u62bd\u8c61`DataChangedListener`\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u540c\u6b65\u7b56\u7565\uff0c\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff1b\\n- \u4f7f\u7528\u5355\u4f8b\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0\u7f13\u5b58\u6570\u636e\u7c7b`BaseDataCache`\uff1b\\n- \u901a\u8fc7`SpringBoot`\u7684\u6761\u4ef6\u88c5\u914d\u548c`starter`\u52a0\u8f7d\u673a\u5236\u5b9e\u73b0\u914d\u7f6e\u7c7b\u7684\u52a0\u8f7d\u3002"},{"id":"/DataSync-SourceCode-Analysis-Http-Data-Sync","metadata":{"permalink":"/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Http-Data-Sync.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Http-Data-Sync.md","title":"Http\u957f\u8f6e\u8be2\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"http","permalink":"/zh/blog/tags/http"},{"label":"data sync","permalink":"/zh/blog/tags/data-sync"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":36.79,"hasTruncateMarker":false,"authors":[{"name":"midnight2104","title":"Apache ShenYu Committer","url":"https://github.com/midnight2104"}],"frontMatter":{"title":"Http\u957f\u8f6e\u8be2\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","author":"midnight2104","author_title":"Apache ShenYu Committer","author_url":"https://github.com/midnight2104","tags":["http","data sync","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Etcd\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync"},"nextItem":{"title":"Nacos\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync"}},"content":"> [Apache ShenYu](https://shenyu.apache.org/zh/docs/index) \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 `API` \u7f51\u5173\u3002\\n\\n\u5728`ShenYu`\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002`Apache ShenYu` \u7f51\u5173\u5f53\u524d\u652f\u6301`ZooKeeper`\u3001`WebSocket`\u3001`Http\u957f\u8f6e\u8be2`\u3001`Nacos` \u3001`Etcd` \u548c `Consul` \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e`Http\u957f\u8f6e\u8be2`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.5.0`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [\u6570\u636e\u540c\u6b65\u539f\u7406](https://shenyu.apache.org/zh/docs/design/data-sync) \u3002\\n\\n### 1. Http\u957f\u8f6e\u8be2\\n\\n\u8fd9\u91cc\u76f4\u63a5\u5f15\u7528\u5b98\u7f51\u7684\u76f8\u5173\u63cf\u8ff0\uff1a\\n\\n> `Zookeeper`\u548c`WebSocket` \u6570\u636e\u540c\u6b65\u7684\u673a\u5236\u6bd4\u8f83\u7b80\u5355\uff0c\u800c `Http\u957f\u8f6e\u8be2`\u5219\u6bd4\u8f83\u590d\u6742\u3002 `Apache ShenYu` \u501f\u9274\u4e86 `Apollo`\u3001`Nacos` \u7684\u8bbe\u8ba1\u601d\u60f3\uff0c\u53d6\u5176\u7cbe\u534e\uff0c\u81ea\u5df1\u5b9e\u73b0\u4e86 `Http\u957f\u8f6e\u8be2`\u6570\u636e\u540c\u6b65\u529f\u80fd\u3002\u6ce8\u610f\uff0c\u8fd9\u91cc\u5e76\u975e\u4f20\u7edf\u7684 `ajax` \u957f\u8f6e\u8be2\uff01\\n\\n![](/img/activities/code-analysis-http-data-sync/http-long-polling-zh.png)\\n\\n`Http\u957f\u8f6e\u8be2` \u673a\u5236\u5982\u4e0a\u6240\u793a\uff0c`Apache ShenYu`\u7f51\u5173\u4e3b\u52a8\u8bf7\u6c42 `shenyu-admin` \u7684\u914d\u7f6e\u670d\u52a1\uff0c\u8bfb\u53d6\u8d85\u65f6\u65f6\u95f4\u4e3a `90s`\uff0c\u610f\u5473\u7740\u7f51\u5173\u5c42\u8bf7\u6c42\u914d\u7f6e\u670d\u52a1\u6700\u591a\u4f1a\u7b49\u5f85 `90s`\uff0c\u8fd9\u6837\u4fbf\u4e8e `shenyu-admin` \u914d\u7f6e\u670d\u52a1\u53ca\u65f6\u54cd\u5e94\u53d8\u66f4\u6570\u636e\uff0c\u4ece\u800c\u5b9e\u73b0\u51c6\u5b9e\u65f6\u63a8\u9001\u3002\\n\\n`Http\u957f\u8f6e\u8be2` \u673a\u5236\u662f\u7531\u7f51\u5173\u4e3b\u52a8\u8bf7\u6c42 `shenyu-admin` \uff0c\u6240\u4ee5\u8fd9\u6b21\u7684\u6e90\u7801\u5206\u6790\uff0c\u6211\u4eec\u4ece\u7f51\u5173\u8fd9\u4e00\u4fa7\u5f00\u59cb\u3002\\n\\n### 2. \u7f51\u5173\u6570\u636e\u540c\u6b65\\n\\n#### 2.1 \u52a0\u8f7d\u914d\u7f6e\\n\\n`Http\u957f\u8f6e\u8be2` \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7684\u52a0\u8f7d\u662f\u901a\u8fc7`spring boot`\u7684`starter`\u673a\u5236\uff0c\u5f53\u6211\u4eec\u5f15\u5165\u76f8\u5173\u4f9d\u8d56\u548c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u52a0\u8f7d\u3002\\n\\n\u5728`pom`\u6587\u4ef6\u4e2d\u5f15\u5165\u4f9d\u8d56\uff1a\\n\\n```xml\\n\x3c!--shenyu data sync start use http--\x3e\\n<dependency>\\n    <groupId>org.apache.shenyu</groupId>\\n    <artifactId>shenyu-spring-boot-starter-sync-data-http</artifactId>\\n    <version>${project.version}</version>\\n</dependency>\\n```\\n\\n\u5728`application.yml`\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u914d\u7f6e\uff1a\\n\\n```yaml\\nshenyu:\\n    sync:\\n       http:\\n          url : http://localhost:9095\\n```\\n\\n\u5f53\u7f51\u5173\u542f\u52a8\u65f6\uff0c\u914d\u7f6e\u7c7b`HttpSyncDataConfiguration`\u5c31\u4f1a\u6267\u884c\uff0c\u52a0\u8f7d\u76f8\u5e94\u7684`Bean`\u3002\\n\\n```java\\n/**\\n * Http sync data configuration for spring boot.\\n */\\n@Configuration\\n@ConditionalOnClass(HttpSyncDataService.class)\\n@ConditionalOnProperty(prefix = \\"shenyu.sync.http\\", name = \\"url\\")\\n@EnableConfigurationProperties(value = HttpConfig.class)\\npublic class HttpSyncDataConfiguration {\\n\\n  private static final Logger LOGGER = LoggerFactory.getLogger(HttpSyncDataConfiguration.class);\\n\\n  /**\\n   * Rest template.\\n   * \u521b\u5efaRestTemplate\\n   * @param httpConfig the http config       http\u914d\u7f6e\\n   * @return the rest template\\n   */\\n  @Bean\\n  public RestTemplate restTemplate(final HttpConfig httpConfig) {\\n    OkHttp3ClientHttpRequestFactory factory = new OkHttp3ClientHttpRequestFactory();\\n    factory.setConnectTimeout(Objects.isNull(httpConfig.getConnectionTimeout()) ? (int) HttpConstants.CLIENT_POLLING_CONNECT_TIMEOUT : httpConfig.getConnectionTimeout());\\n    factory.setReadTimeout(Objects.isNull(httpConfig.getReadTimeout()) ? (int) HttpConstants.CLIENT_POLLING_READ_TIMEOUT : httpConfig.getReadTimeout());\\n    factory.setWriteTimeout(Objects.isNull(httpConfig.getWriteTimeout()) ? (int) HttpConstants.CLIENT_POLLING_WRITE_TIMEOUT : httpConfig.getWriteTimeout());\\n    return new RestTemplate(factory);\\n  }\\n\\n  /**\\n   * AccessTokenManager.\\n   * \u521b\u5efaAccessTokenManager,\u4e13\u95e8\u7528\u6237\u5bf9admin\u8fdb\u884chttp\u8bf7\u6c42\u65f6access token\u7684\u5904\u7406\\n   * @param httpConfig   the http config.      \\n   * @param restTemplate the rest template.\\n   * @return the access token manager.\\n   */\\n  @Bean\\n  public AccessTokenManager accessTokenManager(final HttpConfig httpConfig, final RestTemplate restTemplate) {\\n    return new AccessTokenManager(restTemplate, httpConfig);\\n  }\\n\\n  /**\\n   * Http sync data service.\\n   * \u521b\u5efa HttpSyncDataService \\n   * @param httpConfig         the http config\\n   * @param pluginSubscriber   the plugin subscriber\\n   * @param restTemplate       the rest template\\n   * @param metaSubscribers    the meta subscribers\\n   * @param authSubscribers    the auth subscribers\\n   * @param accessTokenManager the access token manager\\n   * @return the sync data service\\n   */\\n  @Bean\\n  public SyncDataService httpSyncDataService(final ObjectProvider<HttpConfig> httpConfig,\\n                                             final ObjectProvider<PluginDataSubscriber> pluginSubscriber,\\n                                             final ObjectProvider<RestTemplate> restTemplate,\\n                                             final ObjectProvider<List<MetaDataSubscriber>> metaSubscribers,\\n                                             final ObjectProvider<List<AuthDataSubscriber>> authSubscribers,\\n                                             final ObjectProvider<AccessTokenManager> accessTokenManager) {\\n    LOGGER.info(\\"you use http long pull sync shenyu data\\");\\n    return new HttpSyncDataService(\\n            Objects.requireNonNull(httpConfig.getIfAvailable()),\\n            Objects.requireNonNull(pluginSubscriber.getIfAvailable()),\\n            Objects.requireNonNull(restTemplate.getIfAvailable()),\\n            metaSubscribers.getIfAvailable(Collections::emptyList),\\n            authSubscribers.getIfAvailable(Collections::emptyList),\\n            Objects.requireNonNull(accessTokenManager.getIfAvailable())\\n    );\\n  }\\n}\\n\\n```\\n\\n`HttpSyncDataConfiguration`\u662f`Http\u957f\u8f6e\u8be2`\u6570\u636e\u540c\u6b65\u7684\u914d\u7f6e\u7c7b\uff0c\u8d1f\u8d23\u521b\u5efa`HttpSyncDataService`\uff08\u8d1f\u8d23`http`\u6570\u636e\u540c\u6b65\u7684\u5177\u4f53\u5b9e\u73b0\uff09\u3001`RestTemplate`\u548c`AccessTokenManager` \uff08\u8d1f\u8d23\u4e0e`admin`http\u8c03\u7528\u65f6access token\u7684\u5904\u7406\uff09\u3002\u5b83\u7684\u6ce8\u89e3\u5982\u4e0b\uff1a\\n\\n- `@Configuration`\uff1a\u8868\u793a\u8fd9\u662f\u4e00\u4e2a\u914d\u7f6e\u7c7b\uff1b\\n- `@ConditionalOnClass(HttpSyncDataService.class)`\uff1a\u6761\u4ef6\u6ce8\u89e3\uff0c\u8868\u793a\u8981\u6709`HttpSyncDataService`\u8fd9\u4e2a\u7c7b\uff1b\\n- `@ConditionalOnProperty(prefix = \\"shenyu.sync.http\\", name = \\"url\\")`\uff1a\u6761\u4ef6\u6ce8\u89e3\uff0c\u8981\u6709`shenyu.sync.http.url`\u8fd9\u4e2a\u5c5e\u6027\u914d\u7f6e\u3002\\n- `@EnableConfigurationProperties(value = HttpConfig.class)`\uff1a\u8868\u793a\u8ba9HttpConfig\u4e0a\u7684\u6ce8\u89e3`@ConfigurationProperties(prefix = \\"shenyu.sync.http\\")`\u751f\u6548\uff0c\u5c06`HttpConfig`\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u6ce8\u5165Ioc\u5bb9\u5668\u4e2d\u3002\\n\\n\\n\\n#### 2.2 \u5c5e\u6027\u521d\u59cb\u5316\\n\\n- HttpSyncDataService\\n\\n\u5728`HttpSyncDataService`\u7684\u6784\u9020\u51fd\u6570\u4e2d\uff0c\u5b8c\u6210\u5c5e\u6027\u521d\u59cb\u5316\u3002\\n\\n```java\\npublic class HttpSyncDataService implements SyncDataService {\\n\\n    // \u7701\u7565\u4e86\u5c5e\u6027\u5b57\u6bb5......\\n\\n    public HttpSyncDataService(final HttpConfig httpConfig,\\n                               final PluginDataSubscriber pluginDataSubscriber,\\n                               final RestTemplate restTemplate,\\n                               final List<MetaDataSubscriber> metaDataSubscribers,\\n                               final List<AuthDataSubscriber> authDataSubscribers,\\n                               final AccessTokenManager accessTokenManager) {\\n          // 1.\u8bbe\u7f6eaccessTokenManager\\n          this.accessTokenManager = accessTokenManager;\\n          // 2.\u521b\u5efa\u6570\u636e\u5904\u7406\u5668\\n          this.factory = new DataRefreshFactory(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);\\n          // 3.shenyu-admin\u7684url\uff0c \u591a\u4e2a\u7528\u9017\u53f7(,)\u5206\u5272\\n          this.serverList = Lists.newArrayList(Splitter.on(\\",\\").split(httpConfig.getUrl()));\\n          // 4.\u53ea\u7528\u4e8ehttp\u957f\u8f6e\u8be2\u7684restTemplate\\n          this.restTemplate = restTemplate;\\n          // 5.\u5f00\u59cb\u6267\u884c\u957f\u8f6e\u8be2\u4efb\u52a1\\n          this.start();\\n    }\\n\\n    //......\\n}\\n```\\n\\n\u4e0a\u9762\u4ee3\u7801\u4e2d\u7701\u7565\u4e86\u5176\u4ed6\u51fd\u6570\u548c\u76f8\u5173\u5b57\u6bb5\uff0c\u5728\u6784\u9020\u51fd\u6570\u4e2d\u5b8c\u6210\u5c5e\u6027\u7684\u521d\u59cb\u5316\uff0c\u4e3b\u8981\u662f\uff1a\\n\\n- \u8bbe\u7f6e`accessTokenManager`\uff0c\u5b9a\u65f6\u5411`admin`\u8bf7\u6c42\u66f4\u65b0`accessToken`\u7684\u503c\u3002\u7136\u540e\u6bcf\u6b21\u5411`admin`\u53d1\u8d77\u8bf7\u6c42\u65f6\u90fd\u5fc5\u987b\u5c06`header`\u7684`X-Access-Token`\u5c5e\u6027\u8bbe\u7f6e\u6210`accessToken`\u5bf9\u5e94\u7684\u503c\uff1b\\n\\n- \u521b\u5efa\u6570\u636e\u5904\u7406\u5668\uff0c\u7528\u4e8e\u540e\u7eed\u7f13\u5b58\u5404\u79cd\u7c7b\u578b\u7684\u6570\u636e\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219\u3001\u5143\u6570\u636e\u548c\u8ba4\u8bc1\u6570\u636e\uff09\uff1b\\n\\n- \u83b7\u53d6`admin`\u5c5e\u6027\u914d\u7f6e\uff0c\u4e3b\u8981\u662f\u83b7\u53d6`admin`\u7684`url`\uff0c`admin`\u6709\u53ef\u80fd\u662f\u96c6\u7fa4\uff0c\u591a\u4e2a\u7528\u9017\u53f7`(,)`\u5206\u5272\uff1b\\n\\n- \u8bbe\u7f6e`RestTemplate`\uff0c\u7528\u4e8e\u5411`admin`\u53d1\u8d77\u8bf7\u6c42\uff1b\\n\\n- \u5f00\u59cb\u6267\u884c\u957f\u8f6e\u8be2\u4efb\u52a1\u3002\\n\\n#### 2.3 \u5f00\u59cb\u957f\u8f6e\u8be2\\n\\n- HttpSyncDataService#start()\\n\\n\u5728`start()`\u65b9\u6cd5\u4e2d\uff0c\u5e72\u4e86\u4e24\u4ef6\u4e8b\u60c5\uff0c\u4e00\u4e2a\u662f\u83b7\u53d6\u5168\u91cf\u6570\u636e\uff0c\u5373\u8bf7\u6c42`admin`\u7aef\u83b7\u53d6\u6240\u6709\u9700\u8981\u540c\u6b65\u7684\u6570\u636e\uff0c\u7136\u540e\u5c06\u83b7\u53d6\u5230\u7684\u6570\u636e\u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d\u3002\u53e6\u4e00\u4e2a\u662f\u5f00\u542f\u591a\u7ebf\u7a0b\u6267\u884c\u957f\u8f6e\u8be2\u4efb\u52a1\u3002\\n\\n```java\\npublic class HttpSyncDataService implements SyncDataService {\\n    \\n    // ......\\n\\n    private void start() {\\n      // // \u53ea\u521d\u59cb\u5316\u4e00\u6b21\uff0c\u901a\u8fc7\u539f\u5b50\u7c7b\u5b9e\u73b0\u3002 \\n      if (RUNNING.compareAndSet(false, true)) {\\n        // \u521d\u6b21\u542f\u52a8\uff0c\u83b7\u53d6\u5168\u91cf\u6570\u636e\\n        this.fetchGroupConfig(ConfigGroupEnum.values());\\n        // \u4e00\u4e2a\u540e\u53f0\u670d\u52a1\uff0c\u4e00\u4e2a\u7ebf\u7a0b\\n        int threadSize = serverList.size();\\n        // \u81ea\u5b9a\u4e49\u7ebf\u7a0b\u6c60\\n        this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,\\n                new LinkedBlockingQueue<>(),\\n                ShenyuThreadFactory.create(\\"http-long-polling\\", true));\\n        // \u5f00\u59cb\u957f\u8f6e\u8be2\uff0c\u4e00\u4e2aadmin\u670d\u52a1\uff0c\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u7528\u4e8e\u6570\u636e\u540c\u6b65\\n        this.serverList.forEach(server -> this.executor.execute(new HttpLongPollingTask(server)));\\n      } else {\\n        LOG.info(\\"shenyu http long polling was started, executor=[{}]\\", executor);\\n      }\\n    }\\n  \\n    // ......\\n}\\n```\\n\\n##### 2.3.1 \u83b7\u53d6\u5168\u91cf\u6570\u636e\\n\\n- HttpSyncDataService#fetchGroupConfig()\\n\\n`ShenYu`\u5c06\u6240\u6709\u9700\u8981\u540c\u6b65\u7684\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u67095\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u5206\u522b\u662f\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219\u3001\u5143\u6570\u636e\u548c\u8ba4\u8bc1\u6570\u636e\u3002\\n\\n```java\\npublic enum ConfigGroupEnum {\\n    APP_AUTH, // \u8ba4\u8bc1\u6570\u636e\\n    PLUGIN, //\u63d2\u4ef6\\n    RULE, // \u89c4\u5219\\n    SELECTOR, // \u9009\u62e9\u5668\\n    META_DATA; // \u5143\u6570\u636e\\n}\\n```\\n\\n`admin`\u6709\u53ef\u80fd\u662f\u96c6\u7fa4\uff0c\u8fd9\u91cc\u901a\u8fc7\u5faa\u73af\u7684\u65b9\u5f0f\u5411\u6bcf\u4e2a`admin`\u53d1\u8d77\u8bf7\u6c42\uff0c\u6709\u4e00\u4e2a\u6267\u884c\u6210\u529f\u4e86\uff0c\u90a3\u4e48\u5411`admin`\u83b7\u53d6\u5168\u91cf\u6570\u636e\u5e76\u7f13\u5b58\u5230\u7f51\u5173\u7684\u64cd\u4f5c\u5c31\u6267\u884c\u6210\u529f\u3002\u5982\u679c\u51fa\u73b0\u4e86\u5f02\u5e38\uff0c\u5c31\u5411\u4e0b\u4e00\u4e2a`admin`\u53d1\u8d77\u8bf7\u6c42\u3002\\n\\n```java\\npublic class HttpSyncDataService implements SyncDataService {\\n\\n  // ......\\n\\n  private void fetchGroupConfig(final ConfigGroupEnum... groups) throws ShenyuException {\\n    // admin\u6709\u53ef\u80fd\u662f\u96c6\u7fa4\uff0c\u8fd9\u91cc\u901a\u8fc7\u5faa\u73af\u7684\u65b9\u5f0f\u5411\u6bcf\u4e2aadmin\u53d1\u8d77\u8bf7\u6c42\\n    for (int index = 0; index < this.serverList.size(); index++) {\\n      String server = serverList.get(index);\\n      try {\\n        // \u771f\u6b63\u53bb\u6267\u884c\\n        this.doFetchGroupConfig(server, groups);\\n        // \u6709\u4e00\u4e2a\u6210\u529f\uff0c\u5c31\u6210\u529f\u4e86\uff0c\u53ef\u4ee5\u9000\u51fa\u5faa\u73af\\n        break;\\n      } catch (ShenyuException e) {\\n        // \u51fa\u73b0\u5f02\u5e38\uff0c\u5c1d\u8bd5\u6267\u884c\u4e0b\u4e00\u4e2a\\n        // \u6700\u540e\u4e00\u4e2a\u4e5f\u6267\u884c\u5931\u8d25\u4e86\uff0c\u629b\u51fa\u5f02\u5e38\\n        if (index >= serverList.size() - 1) {\\n          throw e;\\n        }\\n        LOG.warn(\\"fetch config fail, try another one: {}\\", serverList.get(index + 1));\\n      }\\n    }\\n  }\\n\\n  // ......\\n}\\n```\\n\\n\\n\\n- HttpSyncDataService#doFetchGroupConfig()\\n\\n\u5728\u6b64\u65b9\u6cd5\u4e2d\uff0c\u9996\u5148\u62fc\u88c5\u8bf7\u6c42\u53c2\u6570\uff0c\u7136\u540e\u901a\u8fc7`httpClient`\u53d1\u8d77\u8bf7\u6c42\uff0c\u5230`admin`\u4e2d\u83b7\u53d6\u6570\u636e\uff0c\u6700\u540e\u5c06\u83b7\u53d6\u5230\u7684\u6570\u636e\u66f4\u65b0\u5230\u7f51\u5173\u5185\u5b58\u4e2d\u3002\\n\\n```java\\npublic class HttpSyncDataService implements SyncDataService {\\n  private void doFetchGroupConfig(final String server, final ConfigGroupEnum... groups) {\\n    // 1. \u62fc\u8bf7\u6c42\u53c2\u6570\uff0c\u6240\u6709\u5206\u7ec4\u679a\u4e3e\u7c7b\u578b\\n    StringBuilder params = new StringBuilder();\\n    for (ConfigGroupEnum groupKey : groups) {\\n      params.append(\\"groupKeys\\").append(\\"=\\").append(groupKey.name()).append(\\"&\\");\\n    }\\n    // admin\u7aef\u63d0\u4f9b\u7684\u63a5\u53e3  /configs/fetch\\n    String url = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_FETCH + \\"?\\" + StringUtils.removeEnd(params.toString(), \\"&\\");\\n    LOG.info(\\"request configs: [{}]\\", url);\\n    String json;\\n    try {\\n      HttpHeaders headers = new HttpHeaders();\\n      // \u8bbe\u7f6eaccessToken\\n      headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());\\n      HttpEntity<String> httpEntity = new HttpEntity<>(headers);\\n      // 2. \u53d1\u8d77\u8bf7\u6c42\uff0c\u83b7\u53d6\u53d8\u66f4\u6570\u636e\\n      json = this.restTemplate.exchange(url, HttpMethod.GET, httpEntity, String.class).getBody();\\n    } catch (RestClientException e) {\\n      String message = String.format(\\"fetch config fail from server[%s], %s\\", url, e.getMessage());\\n      LOG.warn(message);\\n      throw new ShenyuException(message, e);\\n    }\\n    // 3. \u66f4\u65b0\u7f51\u5173\u5185\u5b58\u4e2d\u6570\u636e\\n    boolean updated = this.updateCacheWithJson(json);\\n    if (updated) {\\n      LOG.debug(\\"get latest configs: [{}]\\", json);\\n      return;\\n    }\\n    // \u66f4\u65b0\u6210\u529f\uff0c\u6b64\u65b9\u6cd5\u5c31\u6267\u884c\u5b8c\u6210\u4e86\\n    LOG.info(\\"The config of the server[{}] has not been updated or is out of date. Wait for 30s to listen for changes again.\\", server);\\n    // \u670d\u52a1\u7aef\u6ca1\u6709\u6570\u636e\u66f4\u65b0\uff0c\u5c31\u7b4930s\\n    ThreadUtils.sleep(TimeUnit.SECONDS, 30);\\n  }\\n}\\n```\\n\\n\u4ece\u4ee3\u7801\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230 `admin`\u7aef\u63d0\u4f9b\u7684\u83b7\u53d6\u5168\u91cf\u6570\u636e\u63a5\u53e3\u662f  `/configs/fetch`\uff0c\u8fd9\u91cc\u5148\u4e0d\u8fdb\u4e00\u6b65\u6df1\u5165\uff0c\u653e\u5728\u540e\u6587\u518d\u5206\u6790\u3002\\n\\n\u83b7\u53d6\u5230`admin`\u8fd4\u56de\u7ed3\u679c\u6570\u636e\uff0c\u5e76\u6210\u529f\u66f4\u65b0\uff0c\u90a3\u4e48\u6b64\u65b9\u6cd5\u5c31\u6267\u884c\u7ed3\u675f\u4e86\u3002\u5982\u679c\u6ca1\u6709\u66f4\u65b0\u6210\u529f\uff0c\u90a3\u4e48\u6709\u53ef\u80fd\u662f\u670d\u52a1\u7aef\u6ca1\u6709\u6570\u636e\u66f4\u65b0\uff0c\u5c31\u7b49\u5f85`30s`\u3002\\n\\n\u8fd9\u91cc\u9700\u8981\u63d0\u524d\u8bf4\u660e\u4e00\u4e0b\uff0c\u7f51\u5173\u5728\u5224\u65ad\u662f\u5426\u66f4\u65b0\u6210\u529f\u65f6\uff0c\u6709\u6bd4\u5bf9\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u9a6c\u4e0a\u5c31\u4f1a\u63d0\u5230\u3002\\n\\n- HttpSyncDataService#updateCacheWithJson()\\n\\n\u66f4\u65b0\u7f51\u5173\u5185\u5b58\u4e2d\u7684\u6570\u636e\u3002\u4f7f\u7528`GSON`\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\uff0c\u4ece\u5c5e\u6027`data`\u4e2d\u62ff\u771f\u6b63\u7684\u6570\u636e\uff0c\u7136\u540e\u4ea4\u7ed9`DataRefreshFactory`\u53bb\u505a\u66f4\u65b0\u3002\\n\\n```java\\n    private boolean updateCacheWithJson(final String json) {\\n        // \u4f7f\u7528GSON\u8fdb\u884c\u53cd\u5e8f\u5217\u5316\\n        JsonObject jsonObject = GSON.fromJson(json, JsonObject.class);\\n        // if the config cache will be updated?\\n        return factory.executor(jsonObject.getAsJsonObject(\\"data\\"));\\n    }\\n```\\n\\n- DataRefreshFactory#executor()\\n\\n\u6839\u636e\u4e0d\u540c\u6570\u636e\u7c7b\u578b\u53bb\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u66f4\u65b0\u7ed3\u679c\u3002\u5177\u4f53\u66f4\u65b0\u903b\u8f91\u4ea4\u7ed9\u4e86`dataRefresh.refresh()`\u65b9\u6cd5\u3002\u5728\u66f4\u65b0\u7ed3\u679c\u4e2d\uff0c\u6709\u4e00\u79cd\u6570\u636e\u7c7b\u578b\u8fdb\u884c\u4e86\u66f4\u65b0\uff0c\u5c31\u8868\u793a\u6b64\u6b21\u64cd\u4f5c\u53d1\u751f\u4e86\u66f4\u65b0\u3002\\n\\n```java\\n    public boolean executor(final JsonObject data) {\\n        //\u5e76\u884c\u66f4\u65b0\u6570\u636e\\n        List<Boolean> result = ENUM_MAP.values().parallelStream()\\n                .map(dataRefresh -> dataRefresh.refresh(data))\\n                .collect(Collectors.toList());\\n        //\u6709\u4e00\u4e2a\u66f4\u65b0\u5c31\u8868\u793a\u6b64\u6b21\u53d1\u751f\u4e86\u66f4\u65b0\u64cd\u4f5c\\n        return result.stream().anyMatch(Boolean.TRUE::equals);\\n    }\\n```\\n\\n- AbstractDataRefresh#refresh()\\n\\n\u6570\u636e\u66f4\u65b0\u903b\u8f91\u91c7\u7528\u7684\u662f\u6a21\u677f\u65b9\u6cd5\u8bbe\u8ba1\u6a21\u5f0f\uff0c\u901a\u7528\u64cd\u4f5c\u5728\u62bd\u8c61\u65b9\u6cd5\u4e2d\u5b8c\u6210\uff0c\u4e0d\u540c\u7684\u5b9e\u73b0\u903b\u8f91\u7531\u5b50\u7c7b\u5b8c\u6210\u30025\u79cd\u6570\u636e\u7c7b\u578b\u5177\u4f53\u7684\u66f4\u65b0\u903b\u8f91\u6709\u4e9b\u5dee\u5f02\uff0c\u4f46\u662f\u4e5f\u5b58\u5728\u901a\u7528\u7684\u66f4\u65b0\u903b\u8f91\uff0c\u7c7b\u56fe\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-http-data-sync/data-refresh.png)\\n\\n\u5728\u901a\u7528\u7684`refresh()`\u65b9\u6cd5\u4e2d\uff0c\u8d1f\u8d23\u6570\u636e\u7c7b\u578b\u8f6c\u6362\uff0c\u5224\u65ad\u662f\u5426\u9700\u8981\u66f4\u65b0\uff0c\u548c\u5b9e\u9645\u7684\u6570\u636e\u5237\u65b0\u64cd\u4f5c\u3002\\n\\n```java\\npublic abstract class AbstractDataRefresh<T> implements DataRefresh {\\n\\n  // ......\\n\\n  @Override\\n  public Boolean refresh(final JsonObject data) {\\n    // \u6570\u636e\u7c7b\u578b\u8f6c\u6362\\n    JsonObject jsonObject = convert(data);\\n    if (Objects.isNull(jsonObject)) {\\n      return false;\\n    }\\n\\n    boolean updated = false;\\n    // \u5f97\u5230\u6570\u636e\u7c7b\u578b\\n    ConfigData<T> result = fromJson(jsonObject);\\n    // \u662f\u5426\u9700\u8981\u66f4\u65b0\\n    if (this.updateCacheIfNeed(result)) {\\n      updated = true;\\n      // \u771f\u6b63\u7684\u66f4\u65b0\u903b\u8f91\uff0c\u6570\u636e\u5237\u65b0\u64cd\u4f5c\\n      refresh(result.getData());\\n    }\\n\\n    return updated;\\n  }\\n\\n  // ......\\n}\\n```\\n\\n\\n- AbstractDataRefresh#updateCacheIfNeed()\\n\\n\u6570\u636e\u8f6c\u6362\u7684\u8fc7\u7a0b\uff0c\u5c31\u662f\u6839\u636e\u4e0d\u540c\u7684\u6570\u636e\u7c7b\u578b\u8fdb\u884c\u8f6c\u6362\uff0c\u6211\u4eec\u5c31\u4e0d\u518d\u8fdb\u4e00\u6b65\u8ffd\u8e2a\u4e86\uff0c\u770b\u770b\u6570\u636e\u662f\u5426\u9700\u8981\u66f4\u65b0\u7684\u903b\u8f91\u3002\u65b9\u6cd5\u540d\u662f`updateCacheIfNeed()`\uff0c\u901a\u8fc7\u65b9\u6cd5\u91cd\u8f7d\u5b9e\u73b0\u3002\\n\\n```java\\npublic abstract class AbstractDataRefresh<T> implements DataRefresh {\\n\\n  // ......\\n\\n  // result\u662f\u6570\u636e\\n  protected abstract boolean updateCacheIfNeed(ConfigData<T> result);\\n\\n  // newVal\u662f\u83b7\u53d6\u5230\u7684\u6700\u65b0\u7684\u503c\\n  // groupEnum \u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\\n  protected boolean updateCacheIfNeed(final ConfigData<T> newVal, final ConfigGroupEnum groupEnum) {\\n    // \u5982\u679c\u662f\u7b2c\u4e00\u6b21\uff0c\u90a3\u4e48\u76f4\u63a5\u653e\u5230cache\u4e2d\uff0c\u8fd4\u56de true\uff0c\u8868\u793a\u6b64\u6b21\u8fdb\u884c\u4e86\u66f4\u65b0\\n    if (GROUP_CACHE.putIfAbsent(groupEnum, newVal) == null) {\\n      return true;\\n    }\\n    ResultHolder holder = new ResultHolder(false);\\n    GROUP_CACHE.merge(groupEnum, newVal, (oldVal, value) -> {\\n      // md5 \u503c\u76f8\u540c\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\\n      if (StringUtils.equals(oldVal.getMd5(), newVal.getMd5())) {\\n        LOG.info(\\"Get the same config, the [{}] config cache will not be updated, md5:{}\\", groupEnum, oldVal.getMd5());\\n        return oldVal;\\n      }\\n\\n      // \u5f53\u524d\u7f13\u5b58\u7684\u6570\u636e\u4fee\u6539\u65f6\u95f4\u5927\u4e8e \u65b0\u6765\u7684\u6570\u636e\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\\n      // must compare the last update time\\n      if (oldVal.getLastModifyTime() >= newVal.getLastModifyTime()) {\\n        LOG.info(\\"Last update time earlier than the current configuration, the [{}] config cache will not be updated\\", groupEnum);\\n        return oldVal;\\n      }\\n      LOG.info(\\"update {} config: {}\\", groupEnum, newVal);\\n      holder.result = true;\\n      return newVal;\\n    });\\n    return holder.result;\\n  }\\n\\n  // ......\\n}\\n```\\n\\n\\n\u4ece\u4e0a\u9762\u7684\u6e90\u7801\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u6709\u4e24\u79cd\u60c5\u51b5\u4e0d\u9700\u8981\u66f4\u65b0\uff1a\\n\\n- \u4e24\u4e2a\u7684\u6570\u636e\u7684`md5` \u503c\u76f8\u540c\uff0c\u4e0d\u9700\u8981\u66f4\u65b0;\\n- \u5f53\u524d\u7f13\u5b58\u7684\u6570\u636e\u4fee\u6539\u65f6\u95f4\u5927\u4e8e \u65b0\u6765\u7684\u6570\u636e\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\u3002\\n\\n\u5176\u4ed6\u60c5\u51b5\u9700\u8981\u66f4\u65b0\u6570\u636e\u3002\\n\\n\u5206\u6790\u5230\u8fd9\u91cc\uff0c\u5c31\u5c06`start()` \u65b9\u6cd5\u4e2d\u521d\u6b21\u542f\u52a8\uff0c\u83b7\u53d6\u5168\u91cf\u6570\u636e\u7684\u903b\u8f91\u5206\u6790\u5b8c\u4e86\uff0c\u63a5\u4e0b\u6765\u662f\u957f\u8f6e\u8be2\u7684\u64cd\u4f5c\u3002\u4e3a\u4e86\u65b9\u4fbf\uff0c\u6211\u5c06`start()`\u65b9\u6cd5\u518d\u7c98\u8d34\u4e00\u6b21\uff1a\\n\\n```java\\npublic class HttpSyncDataService implements SyncDataService {\\n\\n  // ......\\n\\n  private void start() {\\n    // // \u53ea\u521d\u59cb\u5316\u4e00\u6b21\uff0c\u901a\u8fc7\u539f\u5b50\u7c7b\u5b9e\u73b0\u3002 \\n    if (RUNNING.compareAndSet(false, true)) {\\n      // \u521d\u6b21\u542f\u52a8\uff0c\u83b7\u53d6\u5168\u91cf\u6570\u636e\\n      this.fetchGroupConfig(ConfigGroupEnum.values());\\n      // \u4e00\u4e2a\u540e\u53f0\u670d\u52a1\uff0c\u4e00\u4e2a\u7ebf\u7a0b\\n      int threadSize = serverList.size();\\n      // \u81ea\u5b9a\u4e49\u7ebf\u7a0b\u6c60\\n      this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,\\n              new LinkedBlockingQueue<>(),\\n              ShenyuThreadFactory.create(\\"http-long-polling\\", true));\\n      // \u5f00\u59cb\u957f\u8f6e\u8be2\uff0c\u4e00\u4e2aadmin\u670d\u52a1\uff0c\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u7528\u4e8e\u6570\u636e\u540c\u6b65\\n      this.serverList.forEach(server -> this.executor.execute(new HttpLongPollingTask(server)));\\n    } else {\\n      LOG.info(\\"shenyu http long polling was started, executor=[{}]\\", executor);\\n    }\\n  }\\n\\n  // ......\\n}\\n```\\n\\n\\n##### 2.3.2 \u6267\u884c\u957f\u8f6e\u8be2\u4efb\u52a1\\n\\n- HttpLongPollingTask#run()\\n\\n\u957f\u8f6e\u8be2\u4efb\u52a1\u662f`HttpLongPollingTask`\uff0c\u5b83\u5b9e\u73b0\u4e86`Runnable`\u63a5\u53e3\uff0c\u4efb\u52a1\u903b\u8f91\u5728`run()`\u65b9\u6cd5\u4e2d\u3002\u901a\u8fc7`while()`\u5faa\u73af\u5b9e\u73b0\u4e0d\u65ad\u6267\u884c\u4efb\u52a1\uff0c\u5373\u957f\u8f6e\u8be2\u3002\u5728\u6bcf\u4e00\u6b21\u7684\u8f6e\u8be2\u4e2d\u6709\u4e09\u6b21\u91cd\u8bd5\u903b\u8f91\uff0c\u4e00\u6b21\u8f6e\u8be2\u4efb\u52a1\u5931\u8d25\u4e86\uff0c\u7b49 `5s` \u518d\u7ee7\u7eed\uff0c`3` \u6b21\u90fd\u5931\u8d25\u4e86\uff0c\u7b49`5` \u5206\u949f\u518d\u8bd5\u3002\\n\\n\u5f00\u59cb\u957f\u8f6e\u8be2\uff0c\u4e00\u4e2a`admin`\u670d\u52a1\uff0c\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u7528\u4e8e\u6570\u636e\u540c\u6b65\u3002\\n\\n```java\\nclass HttpLongPollingTask implements Runnable {\\n\\n  private final String server;\\n\\n  HttpLongPollingTask(final String server) {\\n    this.server = server;\\n  }\\n\\n  @Override\\n  public void run() {\\n    // \u4e00\u76f4\u8f6e\u8be2\\n    while (RUNNING.get()) {\\n      // \u9ed8\u8ba4\u91cd\u8bd5 3 \u6b21\\n      int retryTimes = 3;\\n      for (int time = 1; time <= retryTimes; time++) {\\n        try {\\n          doLongPolling(server);\\n        } catch (Exception e) {\\n          if (time < retryTimes) {\\n            LOG.warn(\\"Long polling failed, tried {} times, {} times left, will be suspended for a while! {}\\",\\n                    time, retryTimes - time, e.getMessage());\\n            // \u957f\u8f6e\u8be2\u5931\u8d25\u4e86\uff0c\u7b49 5s \u518d\u7ee7\u7eed\\n            ThreadUtils.sleep(TimeUnit.SECONDS, 5);\\n            continue;\\n          }\\n          LOG.error(\\"Long polling failed, try again after 5 minutes!\\", e);\\n          // 3 \u6b21\u90fd\u5931\u8d25\u4e86\uff0c\u7b49 5 \u5206\u949f\u518d\u8bd5\\n          ThreadUtils.sleep(TimeUnit.MINUTES, 5);\\n        }\\n      }\\n    }\\n    LOG.warn(\\"Stop http long polling.\\");\\n  }\\n}\\n```\\n\\n- HttpSyncDataService#doLongPolling()\\n\\n\u6267\u884c\u957f\u8f6e\u8be2\u4efb\u52a1\u7684\u6838\u5fc3\u903b\u8f91\uff1a\\n\\n- \u6839\u636e\u6570\u636e\u7c7b\u578b\u7ec4\u88c5\u8bf7\u6c42\u53c2\u6570\uff1a`md5` \u548c `lastModifyTime`\uff1b\\n- \u7ec4\u88c5\u8bf7\u6c42\u5934\u548c\u8bf7\u6c42\u4f53\uff1b\\n- \u5411`admin`\u53d1\u8d77\u8bf7\u6c42\uff0c\u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff1b\\n- \u6839\u636e\u53d1\u751f\u53d8\u66f4\u7684\u7ec4\uff0c\u518d\u53bb\u83b7\u53d6\u6570\u636e\u3002\\n\\n```java\\npublic class HttpSyncDataService implements SyncDataService {\\n  private void doLongPolling(final String server) {\\n    // \u7ec4\u88c5\u8bf7\u6c42\u53c2\u6570\uff1amd5 \u548c lastModifyTime\\n    MultiValueMap<String, String> params = new LinkedMultiValueMap<>(8);\\n    for (ConfigGroupEnum group : ConfigGroupEnum.values()) {\\n      ConfigData<?> cacheConfig = factory.cacheConfigData(group);\\n      if (cacheConfig != null) {\\n        String value = String.join(\\",\\", cacheConfig.getMd5(), String.valueOf(cacheConfig.getLastModifyTime()));\\n        params.put(group.name(), Lists.newArrayList(value));\\n      }\\n    }\\n    // \u7ec4\u88c5\u8bf7\u6c42\u5934\u548c\u8bf7\u6c42\u4f53\\n    HttpHeaders headers = new HttpHeaders();\\n    headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);\\n    // \u8bbe\u7f6eaccessToken\\n    headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());\\n    HttpEntity<MultiValueMap<String, String>> httpEntity = new HttpEntity<>(params, headers);\\n    String listenerUrl = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_LISTENER;\\n\\n    JsonArray groupJson;\\n    //\u5411admin\u53d1\u8d77\u8bf7\u6c42\uff0c\u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\\n    //\u8fd9\u91cc\u53ea\u662f\u5224\u65ad\u4e86\u67d0\u4e2a\u7ec4\u662f\u5426\u53d1\u751f\u53d8\u66f4\\n    try {\\n      String json = this.restTemplate.postForEntity(listenerUrl, httpEntity, String.class).getBody();\\n      LOG.info(\\"listener result: [{}]\\", json);\\n      JsonObject responseFromServer = GsonUtils.getGson().fromJson(json, JsonObject.class);\\n      groupJson = responseFromServer.getAsJsonArray(\\"data\\");\\n    } catch (RestClientException e) {\\n      String message = String.format(\\"listener configs fail, server:[%s], %s\\", server, e.getMessage());\\n      throw new ShenyuException(message, e);\\n    }\\n    // \u6839\u636e\u53d1\u751f\u53d8\u66f4\u7684\u7ec4\uff0c\u518d\u53bb\u83b7\u53d6\u6570\u636e\\n    /**\\n     * \u5b98\u7f51\u5bf9\u6b64\u5904\u7684\u89e3\u91ca\uff1a\\n     * \u7f51\u5173\u6536\u5230\u54cd\u5e94\u4fe1\u606f\u4e4b\u540e\uff0c\u53ea\u77e5\u9053\u662f\u54ea\u4e2a Group \u53d1\u751f\u4e86\u914d\u7f6e\u53d8\u66f4\uff0c\u8fd8\u9700\u8981\u518d\u6b21\u8bf7\u6c42\u8be5 Group \u7684\u914d\u7f6e\u6570\u636e\u3002\\n     * \u8fd9\u91cc\u53ef\u80fd\u4f1a\u5b58\u5728\u4e00\u4e2a\u7591\u95ee\uff1a\u4e3a\u4ec0\u4e48\u4e0d\u662f\u76f4\u63a5\u5c06\u53d8\u66f4\u7684\u6570\u636e\u5199\u51fa\uff1f\\n     * \u6211\u4eec\u5728\u5f00\u53d1\u7684\u65f6\u5019\uff0c\u4e5f\u6df1\u5165\u8ba8\u8bba\u8fc7\u8be5\u95ee\u9898\uff0c\u56e0\u4e3a http \u957f\u8f6e\u8be2\u673a\u5236\u53ea\u80fd\u4fdd\u8bc1\u51c6\u5b9e\u65f6\uff0c\u5982\u679c\u5728\u7f51\u5173\u5c42\u5904\u7406\u4e0d\u53ca\u65f6\uff0c\\n     * \u6216\u8005\u7ba1\u7406\u5458\u9891\u7e41\u66f4\u65b0\u914d\u7f6e\uff0c\u5f88\u6709\u53ef\u80fd\u4fbf\u9519\u8fc7\u4e86\u67d0\u4e2a\u914d\u7f6e\u53d8\u66f4\u7684\u63a8\u9001\uff0c\u5b89\u5168\u8d77\u89c1\uff0c\u6211\u4eec\u53ea\u544a\u77e5\u67d0\u4e2a Group \u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u66f4\u3002\\n     *\\n     * \u4e2a\u4eba\u7406\u89e3\uff1a\\n     * \u5982\u679c\u5c06\u53d8\u66f4\u6570\u636e\u76f4\u63a5\u5199\u51fa\uff0c\u5f53\u7ba1\u7406\u5458\u9891\u7e41\u66f4\u65b0\u914d\u7f6e\u65f6\uff0c\u7b2c\u4e00\u6b21\u66f4\u65b0\u4e86\uff0c\u5c06client\u79fb\u9664\u963b\u585e\u961f\u5217\uff0c\u8fd4\u56de\u54cd\u5e94\u4fe1\u606f\u7ed9\u7f51\u5173\u3002\\n     * \u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u8fdb\u884c\u4e86\u7b2c\u4e8c\u6b21\u66f4\u65b0\uff0c\u90a3\u4e48\u5f53\u524d\u7684client\u662f\u4e0d\u5728\u963b\u585e\u961f\u5217\u4e2d\uff0c\u6240\u4ee5\u8fd9\u4e00\u6b21\u7684\u53d8\u66f4\u5c31\u4f1a\u9519\u8fc7\u3002\\n     * \u7f51\u5173\u5c42\u5904\u7406\u4e0d\u53ca\u65f6\uff0c\u4e5f\u662f\u540c\u7406\u3002\\n     * \u8fd9\u662f\u4e00\u4e2a\u957f\u8f6e\u8be2\uff0c\u4e00\u4e2a\u7f51\u5173\u4e00\u4e2a\u540c\u6b65\u7ebf\u7a0b\uff0c\u53ef\u80fd\u5b58\u5728\u8017\u65f6\u7684\u8fc7\u7a0b\u3002\\n     * \u5982\u679cadmin\u6709\u6570\u636e\u53d8\u66f4\uff0c\u5f53\u524d\u7f51\u5173client\u662f\u6ca1\u6709\u5728\u963b\u585e\u961f\u5217\u4e2d\uff0c\u5c31\u4e0d\u5230\u6570\u636e\u3002\\n     */\\n    if (Objects.nonNull(groupJson) && groupJson.size() > 0) {\\n      // fetch group configuration async.\\n      ConfigGroupEnum[] changedGroups = GsonUtils.getGson().fromJson(groupJson, ConfigGroupEnum[].class);\\n      LOG.info(\\"Group config changed: {}\\", Arrays.toString(changedGroups));\\n      this.doFetchGroupConfig(server, changedGroups);\\n    }\\n  }\\n}\\n```\\n\\n\u8fd9\u91cc\u9700\u8981\u7279\u522b\u89e3\u91ca\u4e00\u70b9\u7684\u662f\uff1a\u5728\u957f\u8f6e\u8be2\u4efb\u52a1\u4e2d\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u76f4\u63a5\u62ff\u5230\u53d8\u66f4\u7684\u6570\u636e\uff1f\u800c\u662f\u5148\u5224\u65ad\u54ea\u4e2a\u5206\u7ec4\u6570\u636e\u53d1\u751f\u4e86\u53d8\u66f4\uff0c\u7136\u540e\u518d\u6b21\u8bf7\u6c42`admin`\uff0c\u83b7\u53d6\u53d8\u66f4\u6570\u636e\uff1f\\n\\n\u5b98\u7f51\u5bf9\u6b64\u5904\u7684\u89e3\u91ca\u662f\uff1a\\n\\n> \u7f51\u5173\u6536\u5230\u54cd\u5e94\u4fe1\u606f\u4e4b\u540e\uff0c\u53ea\u77e5\u9053\u662f\u54ea\u4e2a Group \u53d1\u751f\u4e86\u914d\u7f6e\u53d8\u66f4\uff0c\u8fd8\u9700\u8981\u518d\u6b21\u8bf7\u6c42\u8be5 Group \u7684\u914d\u7f6e\u6570\u636e\u3002\\n> \u8fd9\u91cc\u53ef\u80fd\u4f1a\u5b58\u5728\u4e00\u4e2a\u7591\u95ee\uff1a\u4e3a\u4ec0\u4e48\u4e0d\u662f\u76f4\u63a5\u5c06\u53d8\u66f4\u7684\u6570\u636e\u5199\u51fa\uff1f\\n> \u6211\u4eec\u5728\u5f00\u53d1\u7684\u65f6\u5019\uff0c\u4e5f\u6df1\u5165\u8ba8\u8bba\u8fc7\u8be5\u95ee\u9898\uff0c\u56e0\u4e3a `http` \u957f\u8f6e\u8be2\u673a\u5236\u53ea\u80fd\u4fdd\u8bc1\u51c6\u5b9e\u65f6\uff0c\u5982\u679c\u5728\u7f51\u5173\u5c42\u5904\u7406\u4e0d\u53ca\u65f6\uff0c\\n> \u6216\u8005\u7ba1\u7406\u5458\u9891\u7e41\u66f4\u65b0\u914d\u7f6e\uff0c\u5f88\u6709\u53ef\u80fd\u4fbf\u9519\u8fc7\u4e86\u67d0\u4e2a\u914d\u7f6e\u53d8\u66f4\u7684\u63a8\u9001\uff0c\u5b89\u5168\u8d77\u89c1\uff0c\u6211\u4eec\u53ea\u544a\u77e5\u67d0\u4e2a Group \u4fe1\u606f\u53d1\u751f\u4e86\u53d8\u66f4\u3002\\n\\n\u4e2a\u4eba\u7406\u89e3\u662f\uff1a\\n\\n> \u5982\u679c\u5c06\u53d8\u66f4\u6570\u636e\u76f4\u63a5\u5199\u51fa\uff0c\u7ba1\u7406\u5458\u9891\u7e41\u66f4\u65b0\u914d\u7f6e\u65f6\uff0c\u7b2c\u4e00\u6b21\u66f4\u65b0\u4e86\uff0c\u5c06`client`\u79fb\u9664\u963b\u585e\u961f\u5217\uff0c\u8fd4\u56de\u54cd\u5e94\u4fe1\u606f\u7ed9\u7f51\u5173\u3002\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u8fdb\u884c\u4e86\u7b2c\u4e8c\u6b21\u66f4\u65b0\uff0c\u90a3\u4e48\u5f53\u524d\u7684`client`\u662f\u4e0d\u5728\u963b\u585e\u961f\u5217\u4e2d\uff0c\u6240\u4ee5\u8fd9\u4e00\u6b21\u7684\u53d8\u66f4\u5c31\u4f1a\u9519\u8fc7\u3002\u7f51\u5173\u5c42\u5904\u7406\u4e0d\u53ca\u65f6\uff0c\u4e5f\u662f\u540c\u7406\u3002 \u8fd9\u662f\u4e00\u4e2a\u957f\u8f6e\u8be2\uff0c\u4e00\u4e2a\u7f51\u5173\u4e00\u4e2a\u540c\u6b65\u7ebf\u7a0b\uff0c\u53ef\u80fd\u5b58\u5728\u8017\u65f6\u7684\u8fc7\u7a0b\u3002\u5982\u679c`admin`\u6709\u6570\u636e\u53d8\u66f4\uff0c\u5f53\u524d\u7f51\u5173client\u662f\u6ca1\u6709\u5728\u963b\u585e\u961f\u5217\u4e2d\uff0c\u5c31\u4f1a\u66f4\u65b0\u4e0d\u5230\u6570\u636e\u3002\\n\\n\u6211\u4eec\u8fd8\u6ca1\u6709\u5206\u6790\u5230`admin`\u7aef\u7684\u5904\u7406\u903b\u8f91\uff0c\u5148\u5927\u6982\u8bf4\u4e00\u4e0b\u3002\u5728`admin`\u7aef\uff0c\u4f1a\u5c06\u7f51\u5173`client`\u653e\u5230\u963b\u585e\u961f\u5217\uff0c\u6709\u6570\u636e\u53d8\u66f4\uff0c\u7f51\u5173`client`\u5c31\u4f1a\u51fa\u961f\u5217\uff0c\u53d1\u9001\u53d8\u66f4\u6570\u636e\u3002\u6240\u4ee5\uff0c\u5982\u679c\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u7f51\u5173`client`\u4e0d\u5728\u963b\u585e\u961f\u5217\uff0c\u90a3\u4e48\u5c31\u65e0\u6cd5\u5f97\u5230\u5f53\u524d\u53d8\u66f4\u7684\u6570\u636e\u3002\\n\\n\u77e5\u9053\u54ea\u4e2a\u5206\u7ec4\u6570\u636e\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u4e3b\u52a8\u518d\u5411`admin`\u83b7\u53d6\u53d8\u66f4\u7684\u6570\u636e\uff0c\u6839\u636e\u5206\u7ec4\u4e0d\u540c\uff0c\u5168\u91cf\u62ff\u6570\u636e\u3002\u8c03\u7528\u65b9\u6cd5\u662f`doFetchGroupConfig()`\uff0c\u8fd9\u4e2a\u5728\u524d\u9762\u5df2\u7ecf\u5206\u6790\u8fc7\u4e86\u3002\\n\\n\u5206\u6790\u5230\u8fd9\u91cc\uff0c\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u64cd\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002\u957f\u8f6e\u8be2\u4efb\u52a1\u5c31\u662f\u4e0d\u65ad\u5411`admin`\u53d1\u8d77\u8bf7\u6c42\uff0c\u770b\u770b\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff0c\u5982\u679c\u6709\u5206\u7ec4\u6570\u636e\u53d1\u751f\u53d8\u66f4\uff0c\u90a3\u4e48\u5c31\u518d\u4e3b\u52a8\u5411`admin`\u53d1\u8d77\u8bf7\u6c42\uff0c\u83b7\u53d6\u53d8\u66f4\u6570\u636e\uff0c\u7136\u540e\u66f4\u65b0\u7f51\u5173\u5185\u5b58\u4e2d\u7684\u6570\u636e\u3002\\n\\n\u7f51\u5173\u7aef\u957f\u8f6e\u8be2\u4efb\u52a1\u6d41\u7a0b\uff1a\\n\\n![](/img/activities/code-analysis-http-data-sync/http-long-polling-sequence-zh.png)\\n\\n### 3. admin\u6570\u636e\u540c\u6b65\\n\\n\u4ece\u524d\u9762\u5206\u6790\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u7f51\u5173\u7aef\u4e3b\u8981\u8c03\u7528`admin`\u7684\u4e24\u4e2a\u63a5\u53e3\uff1a\\n\\n- `/configs/listener`\uff1a\u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff1b\\n- `/configs/fetch`\uff1a\u83b7\u53d6\u53d8\u66f4\u7ec4\u6570\u636e\u3002\\n\\n\u76f4\u63a5\u4ece\u8fd9\u4e24\u4e2a\u63a5\u53e3\u5206\u6790\u7684\u8bdd\uff0c\u53ef\u80fd\u6709\u7684\u5730\u65b9\u4e0d\u597d\u7406\u89e3\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u662f\u4ece`admin`\u542f\u52a8\u6d41\u7a0b\u5f00\u59cb\u5206\u6790\u6570\u636e\u540c\u6b65\u8fc7\u7a0b\u3002\\n\\n#### 3.1 \u52a0\u8f7d\u914d\u7f6e\\n\\n\u5982\u679c\u5728\u914d\u7f6e\u6587\u4ef6`application.yml`\u4e2d\uff0c\u8fdb\u884c\u4e86\u5982\u4e0b\u914d\u7f6e\uff0c\u5c31\u8868\u793a\u901a\u8fc7`http\u957f\u8f6e\u8be2`\u7684\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n```yaml\\nshenyu:\\n  sync:\\n      http:\\n        enabled: true\\n```\\n\\n\u7a0b\u5e8f\u542f\u52a8\u65f6\uff0c\u901a\u8fc7`springboot`\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\u6570\u636e\u540c\u6b65\u7c7b\u7684\u914d\u7f6e\u52a0\u8f7d\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u521b\u5efa`HttpLongPollingDataChangedListener`\uff0c\u8d1f\u8d23\u5904\u7406\u957f\u8f6e\u8be2\u7684\u76f8\u5173\u5b9e\u73b0\u903b\u8f91\u3002\\n\\n```java\\n/**\\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\\n * The type Data sync configuration.\\n */\\n@Configuration\\npublic class DataSyncConfiguration {\\n\\n    /**\\n     * http\u957f\u8f6e\u8be2\\n     * http long polling.\\n     */\\n    @Configuration\\n    @ConditionalOnProperty(name = \\"shenyu.sync.http.enabled\\", havingValue = \\"true\\")\\n    @EnableConfigurationProperties(HttpSyncProperties.class)\\n    static class HttpLongPollingListener {\\n\\n        @Bean\\n        @ConditionalOnMissingBean(HttpLongPollingDataChangedListener.class)\\n        public HttpLongPollingDataChangedListener httpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {\\n            return new HttpLongPollingDataChangedListener(httpSyncProperties);\\n        }\\n    }\\n}\\n```\\n\\n\\n\\n#### 3.2 \u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\u5b9e\u4f8b\u5316\\n\\n- HttpLongPollingDataChangedListener\\n\\n\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\u901a\u8fc7\u6784\u9020\u51fd\u6570\u7684\u65b9\u5f0f\u5b8c\u6210\u5b9e\u4f8b\u5316\u548c\u521d\u59cb\u5316\u64cd\u4f5c\u3002\u5728\u6784\u9020\u51fd\u6570\u4e2d\u4f1a\u521b\u5efa\u963b\u585e\u961f\u5217\uff0c\u7528\u4e8e\u5b58\u653e\u5ba2\u6237\u7aef\uff1b\u521b\u5efa\u7ebf\u7a0b\u6c60\uff0c\u7528\u4e8e\u6267\u884c\u5ef6\u8fdf\u4efb\u52a1\uff0c\u5468\u671f\u4efb\u52a1\uff1b\u4fdd\u5b58\u957f\u8f6e\u8be2\u76f8\u5173\u5c5e\u6027\u4fe1\u606f\u3002\\n\\n```java\\n    public HttpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {\\n        // \u9ed8\u8ba4\u5ba2\u6237\u7aef\uff08\u8fd9\u91cc\u662f\u7f51\u5173\uff091024\u4e2a\\n        this.clients = new ArrayBlockingQueue<>(1024);\\n        // \u521b\u5efa\u7ebf\u7a0b\u6c60\\n        // ScheduledThreadPoolExecutor \u53ef\u4ee5\u6267\u884c\u5ef6\u8fdf\u4efb\u52a1\uff0c\u5468\u671f\u4efb\u52a1\uff0c\u666e\u901a\u4efb\u52a1\\n        this.scheduler = new ScheduledThreadPoolExecutor(1,\\n                ShenyuThreadFactory.create(\\"long-polling\\", true));\\n        // \u957f\u8f6e\u8be2\u7684\u5c5e\u6027\u4fe1\u606f\\n        this.httpSyncProperties = httpSyncProperties;\\n    }\\n```\\n\\n\u53e6\u5916\uff0c\u5b83\u7684\u7c7b\u56fe\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-http-data-sync/data-changed-listener.png)\\n\\n\u5b9e\u73b0\u4e86`InitializingBean`\u63a5\u53e3\uff0c\u6240\u4ee5\u5728`bean`\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\u6267\u884c`afterInitialize()`\u65b9\u6cd5\u3002\u901a\u8fc7\u7ebf\u7a0b\u6c60\u6267\u884c\u5468\u671f\u4efb\u52a1\uff1a\u66f4\u65b0\u5185\u5b58\u4e2d`\uff08CACHE\uff09`\u7684\u6570\u636e\u6bcf\u9694`5`\u5206\u949f\u6267\u884c\u4e00\u6b21\uff0c`5`\u5206\u949f\u540e\u5f00\u59cb\u6267\u884c\u3002\u5237\u65b0\u672c\u5730\u7f13\u5b58\u5c31\u662f\u4ece\u6570\u636e\u5e93\u8bfb\u53d6\u6570\u636e\u5230\u672c\u5730\u7f13\u5b58\uff08\u8fd9\u91cc\u5c31\u662f\u5185\u5b58\uff09\uff0c\u901a\u8fc7`refreshLocalCache()`\u5b8c\u6210\u3002\\n\\n```java\\npublic class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {\\n\\n  // ......\\n\\n  /**\\n   * \u5728 InitializingBean\u63a5\u53e3\u4e2d\u7684afterPropertiesSet()\u65b9\u6cd5\u4e2d\u88ab\u8c03\u7528\uff0c\u5373\u5728bean\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\u6267\u884c\\n   */\\n  @Override\\n  protected void afterInitialize() {\\n    long syncInterval = httpSyncProperties.getRefreshInterval().toMillis();\\n    // \u6267\u884c\u5468\u671f\u4efb\u52a1\uff1a\u66f4\u65b0\u5185\u5b58\u4e2d\uff08CACHE\uff09\u7684\u6570\u636e\u6bcf\u96945\u5206\u949f\u6267\u884c\u4e00\u6b21\uff0c5\u5206\u949f\u540e\u5f00\u59cb\u6267\u884c\\n    // \u9632\u6b62admin\u5148\u542f\u52a8\u4e00\u6bb5\u65f6\u95f4\u540e\uff0c\u4ea7\u751f\u4e86\u6570\u636e\uff1b\u7136\u540e\u7f51\u5173\u521d\u6b21\u8fde\u63a5\u65f6\uff0c\u6ca1\u6709\u62ff\u5230\u5168\u91cf\u6570\u636e\\n    scheduler.scheduleWithFixedDelay(() -> {\\n      LOG.info(\\"http sync strategy refresh config start.\\");\\n      try {\\n        // \u4ece\u6570\u636e\u5e93\u8bfb\u53d6\u6570\u636e\u5230\u672c\u5730\u7f13\u5b58\uff08\u8fd9\u91cc\u5c31\u662f\u5185\u5b58\uff09\\n        this.refreshLocalCache();\\n        LOG.info(\\"http sync strategy refresh config success.\\");\\n      } catch (Exception e) {\\n        LOG.error(\\"http sync strategy refresh config error!\\", e);\\n      }\\n    }, syncInterval, syncInterval, TimeUnit.MILLISECONDS);\\n    LOG.info(\\"http sync strategy refresh interval: {}ms\\", syncInterval);\\n  }\\n\\n  // ......\\n}\\n```\\n\\n- refreshLocalCache()\\n\\n\u5206\u522b\u5bf95\u79cd\u6570\u636e\u7c7b\u578b\u8fdb\u884c\u66f4\u65b0\u3002\\n\\n```java\\npublic abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {\\n\\n  // ......\\n\\n  // \u4ece\u6570\u636e\u5e93\u8bfb\u53d6\u6570\u636e\u5230\u672c\u5730\u7f13\u5b58\uff08\u8fd9\u91cc\u5c31\u662f\u5185\u5b58\uff09\\n  private void refreshLocalCache() {\\n    //\u66f4\u65b0\u8ba4\u8bc1\u6570\u636e\\n    this.updateAppAuthCache();\\n    //\u66f4\u65b0\u63d2\u4ef6\u6570\u636e\\n    this.updatePluginCache();\\n    //\u66f4\u65b0\u89c4\u5219\u6570\u636e\\n    this.updateRuleCache();\\n    //\u66f4\u65b0\u9009\u62e9\u5668\u6570\u636e\\n    this.updateSelectorCache();\\n    //\u66f4\u65b0\u5143\u6570\u636e\\n    this.updateMetaDataCache();\\n  }\\n\\n  // ......\\n}\\n```\\n\\n5\u4e2a\u66f4\u65b0\u65b9\u6cd5\u7684\u903b\u8f91\u662f\u7c7b\u4f3c\u7684\uff0c\u8c03\u7528`service`\u65b9\u6cd5\u83b7\u53d6\u6570\u636e\uff0c\u7136\u540e\u653e\u5230\u5185\u5b58`CACHE`\u4e2d\u3002\u4ee5\u66f4\u65b0\u89c4\u5219\u6570\u636e\u65b9\u6cd5`updateRuleCache()`\u4e3a\u4f8b\uff0c\u4f20\u5165\u89c4\u5219\u679a\u4e3e\u7c7b\u578b\uff0c\u8c03\u7528`ruleService.listAll()`\u4ece\u6570\u636e\u5e93\u83b7\u53d6\u6240\u6709\u89c4\u5219\u6570\u636e\u3002\\n\\n```java\\n    /**\\n     * Update rule cache.\\n     */\\n    protected void updateRuleCache() {\\n        this.updateCache(ConfigGroupEnum.RULE, ruleService.listAll());\\n    }\\n```\\n\\n\\n- updateCache()\\n\\n\u4f7f\u7528\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u66f4\u65b0\u5185\u5b58\u4e2d\u7684\u6570\u636e\u3002\\n\\n```java\\npublic abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {\\n\\n  // ......\\n\\n  // \u7f13\u5b58\u6570\u636e\u7684 Map\\n  protected static final ConcurrentMap<String, ConfigDataCache> CACHE = new ConcurrentHashMap<>();\\n\\n  /**\\n   * if md5 is not the same as the original, then update lcoal cache.\\n   * \u66f4\u65b0\u7f13\u5b58\u4e2d\u7684\u6570\u636e\\n   * @param group ConfigGroupEnum\\n   * @param <T> the type of class\\n   * @param data the new config data\\n   */\\n  protected <T> void updateCache(final ConfigGroupEnum group, final List<T> data) {\\n    //\u6570\u636e\u5e8f\u5217\u5316\\n    String json = GsonUtils.getInstance().toJson(data);\\n    //\u4f20\u5165md5\u503c\u548c\u4fee\u6539\u65f6\u95f4\\n    ConfigDataCache newVal = new ConfigDataCache(group.name(), json, Md5Utils.md5(json), System.currentTimeMillis());\\n    //\u66f4\u65b0\u5206\u7ec4\u6570\u636e\\n    ConfigDataCache oldVal = CACHE.put(newVal.getGroup(), newVal);\\n    LOG.info(\\"update config cache[{}], old: {}, updated: {}\\", group, oldVal, newVal);\\n  }\\n\\n  // ......\\n}\\n```\\n\\n\u521d\u59cb\u5316\u7684\u8fc7\u7a0b\u5c31\u662f\u542f\u52a8\u5468\u671f\u6027\u4efb\u52a1\uff0c\u5b9a\u65f6\u4ece\u6570\u636e\u5e93\u83b7\u53d6\u6570\u636e\u66f4\u65b0\u5185\u5b58\u6570\u636e\u3002\\n\\n\u63a5\u4e0b\u6765\u5f00\u59cb\u5bf9\u4e24\u4e2a\u63a5\u53e3\u5f00\u59cb\u5206\u6790\uff1a\\n\\n- `/configs/listener`\uff1a\u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff1b\\n- `/configs/fetch`\uff1a\u83b7\u53d6\u53d8\u66f4\u7ec4\u6570\u636e\u3002\\n\\n#### 3.3  \u6570\u636e\u53d8\u66f4\u8f6e\u8be2\u63a5\u53e3\\n\\n- `/configs/listener`\uff1a\u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff1b\\n\\n\u63a5\u53e3\u7c7b\u662f`ConfigController`\uff0c\u53ea\u6709\u4f7f\u7528`http\u957f\u8f6e\u8be2`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u65f6\u624d\u4f1a\u751f\u6548\u3002\u63a5\u53e3\u65b9\u6cd5`listener()`\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528`doLongPolling()`\u65b9\u6cd5\u3002\\n\\n```java\\n   \\n/**\\n * This Controller only when HttpLongPollingDataChangedListener exist, will take effect.\\n */\\n@ConditionalOnBean(HttpLongPollingDataChangedListener.class)\\n@RestController\\n@RequestMapping(\\"/configs\\")\\npublic class ConfigController {\\n\\n    private final HttpLongPollingDataChangedListener longPollingListener;\\n\\n    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {\\n      this.longPollingListener = longPollingListener;\\n    }\\n    \\n    // \u7701\u7565\u5176\u4ed6\u903b\u8f91\\n\\n    /**\\n     * Listener.\\n     * \u76d1\u542c\u6570\u636e\u53d8\u66f4\uff0c\u6267\u884c\u957f\u8f6e\u8be2\\n     * @param request  the request\\n     * @param response the response\\n     */\\n    @PostMapping(value = \\"/listener\\")\\n    public void listener(final HttpServletRequest request, final HttpServletResponse response) {\\n        longPollingListener.doLongPolling(request, response);\\n    }\\n\\n}\\n```\\n\\n- HttpLongPollingDataChangedListener#doLongPolling()\\n\\n\u6267\u884c\u957f\u8f6e\u8be2\u4efb\u52a1\uff1a\u5982\u679c\u6709\u6570\u636e\u53d8\u66f4\uff0c\u5c06\u4f1a\u7acb\u5373\u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\uff08\u8fd9\u91cc\u5c31\u662f\u7f51\u5173\u7aef\uff09\u3002\u5426\u5219\uff0c\u5ba2\u6237\u7aef\u4f1a\u4e00\u76f4\u88ab\u963b\u585e\uff0c\u76f4\u5230\u6709\u6570\u636e\u53d8\u66f4\u6216\u8005\u8d85\u65f6\u3002\\n\\n```java\\npublic class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {\\n\\n  // ......\\n\\n  /**\\n   * \u6267\u884c\u957f\u8f6e\u8be2\uff1a\u5982\u679c\u6709\u6570\u636e\u53d8\u66f4\uff0c\u4f1a\u7acb\u5373\u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\uff08\u8fd9\u91cc\u5c31\u662f\u7f51\u5173\u7aef\uff09\u3002\\n   * \u5426\u5219\uff0c\u5426\u5219\u5ba2\u6237\u7aef\u4f1a\u4e00\u76f4\u88ab\u963b\u585e\uff0c\u76f4\u5230\u6709\u6570\u636e\u53d8\u66f4\u6216\u8005\u8d85\u65f6\u3002\\n   * @param request\\n   * @param response\\n   */\\n  public void doLongPolling(final HttpServletRequest request, final HttpServletResponse response) {\\n    // compare group md5\\n    // \u6bd4\u8f83md5\uff0c\u5224\u65ad\u7f51\u5173\u7684\u6570\u636e\u548cadmin\u7aef\u7684\u6570\u636e\u662f\u5426\u4e00\u81f4\uff0c\u5f97\u5230\u53d1\u751f\u53d8\u66f4\u7684\u6570\u636e\u7ec4\\n    List<ConfigGroupEnum> changedGroup = compareChangedGroup(request);\\n    String clientIp = getRemoteIp(request);\\n    // response immediately.\\n    // \u6709\u53d8\u66f4\u7684\u6570\u636e\uff0c\u5219\u7acb\u5373\u5411\u7f51\u5173\u54cd\u5e94\\n    if (CollectionUtils.isNotEmpty(changedGroup)) {\\n      this.generateResponse(response, changedGroup);\\n      Log.info(\\"send response with the changed group, ip={}, group={}\\", clientIp, changedGroup);\\n      return;\\n    }\\n\\n    // \u6ca1\u6709\u53d8\u66f4\uff0c\u5219\u5c06\u5ba2\u6237\u7aef\uff08\u8fd9\u91cc\u5c31\u662f\u7f51\u5173\uff09\u653e\u8fdb\u963b\u585e\u961f\u5217\\n    final AsyncContext asyncContext = request.startAsync();\\n    asyncContext.setTimeout(0L);\\n    scheduler.execute(new LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));\\n  }\\n\\n  // ......\\n}\\n```\\n\\n- HttpLongPollingDataChangedListener#compareChangedGroup()\\n\\n\u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff0c\u5224\u65ad\u903b\u8f91\u662f\u6bd4\u8f83\u7f51\u5173\u7aef\u548c`admin`\u7aef\u7684`md5`\u503c\u548c`lastModifyTime`\u3002\\n\\n- \u5982\u679c`md5`\u503c\u4e0d\u4e00\u6837\uff0c\u90a3\u4e48\u9700\u8981\u66f4\u65b0\uff1b\\n- \u5982\u679c`admin`\u7aef\u7684`lastModifyTime`\u5927\u4e8e\u7f51\u5173\u7aef\u7684`lastModifyTime`\uff0c\u90a3\u4e48\u9700\u8981\u66f4\u65b0\u3002\\n\\n```java\\n /**\\n     * \u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\\n     * @param request\\n     * @return\\n     */\\n    private List<ConfigGroupEnum> compareChangedGroup(final HttpServletRequest request) {\\n        List<ConfigGroupEnum> changedGroup = new ArrayList<>(ConfigGroupEnum.values().length);\\n        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {\\n            // \u7f51\u5173\u7aef\u6570\u636e\u7684md5\u503c\u548clastModifyTime\\n            String[] params = StringUtils.split(request.getParameter(group.name()), \',\');\\n            if (params == null || params.length != 2) {\\n                throw new ShenyuException(\\"group param invalid:\\" + request.getParameter(group.name()));\\n            }\\n            String clientMd5 = params[0];\\n            long clientModifyTime = NumberUtils.toLong(params[1]);\\n            ConfigDataCache serverCache = CACHE.get(group.name());\\n            // do check. \u5224\u65ad\u7ec4\u6570\u636e\u662f\u5426\u53d1\u751f\u53d8\u66f4\\n            if (this.checkCacheDelayAndUpdate(serverCache, clientMd5, clientModifyTime)) {\\n                changedGroup.add(group);\\n            }\\n        }\\n        return changedGroup;\\n    }\\n```\\n\\n- LongPollingClient\\n\\n\u6ca1\u6709\u53d8\u66f4\u6570\u636e\uff0c\u5219\u5c06\u5ba2\u6237\u7aef\uff08\u8fd9\u91cc\u5c31\u662f\u7f51\u5173\uff09\u653e\u8fdb\u963b\u585e\u961f\u5217\u3002\u963b\u585e\u65f6\u95f4\u662f60\u79d2\uff0c\u537360\u79d2\u540e\u79fb\u9664\uff0c\u5e76\u54cd\u5e94\u5ba2\u6237\u7aef\u3002\\n\\n```java\\nclass LongPollingClient implements Runnable {\\n      // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n    \\n        @Override\\n        public void run() {\\n            try {\\n                // \u5148\u8bbe\u7f6e\u5b9a\u65f6\u4efb\u52a1\uff1a60\u79d2\u540e\u79fb\u9664\uff0c\u5e76\u54cd\u5e94\u5ba2\u6237\u7aef\\n                this.asyncTimeoutFuture = scheduler.schedule(() -> {\\n                    clients.remove(LongPollingClient.this);\\n                    List<ConfigGroupEnum> changedGroups = compareChangedGroup((HttpServletRequest) asyncContext.getRequest());\\n                    sendResponse(changedGroups);\\n                }, timeoutTime, TimeUnit.MILLISECONDS);\\n\\n                // \u6dfb\u52a0\u5230\u963b\u585e\u961f\u5217\\n                clients.add(this);\\n\\n            } catch (Exception ex) {\\n                log.error(\\"add long polling client error\\", ex);\\n            }\\n        }\\n\\n        /**\\n         * Send response.\\n         *\\n         * @param changedGroups the changed groups\\n         */\\n        void sendResponse(final List<ConfigGroupEnum> changedGroups) {\\n            // cancel scheduler\\n            if (null != asyncTimeoutFuture) {\\n                asyncTimeoutFuture.cancel(false);\\n            }\\n            // \u54cd\u5e94\u53d8\u66f4\u7684\u7ec4\\n            generateResponse((HttpServletResponse) asyncContext.getResponse(), changedGroups);\\n            asyncContext.complete();\\n        }\\n    }\\n```\\n\\n\\n#### 3.4  \u83b7\u53d6\u53d8\u66f4\u6570\u636e\u63a5\u53e3\\n\\n- `/configs/fetch`\uff1a\u83b7\u53d6\u53d8\u66f4\u6570\u636e\uff1b\\n\\n\u6839\u636e\u7f51\u5173\u4f20\u5165\u7684\u53c2\u6570\uff0c\u83b7\u53d6\u5206\u7ec4\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u3002\u4e3b\u8981\u5b9e\u73b0\u65b9\u6cd5\u662f`longPollingListener.fetchConfig()`\u3002\\n\\n```java\\n\\n@ConditionalOnBean(HttpLongPollingDataChangedListener.class)\\n@RestController\\n@RequestMapping(\\"/configs\\")\\npublic class ConfigController {\\n\\n    private final HttpLongPollingDataChangedListener longPollingListener;\\n  \\n    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {\\n      this.longPollingListener = longPollingListener;\\n    }\\n\\n    /**\\n     * Fetch configs shenyu result.\\n     * \u5168\u91cf\u83b7\u53d6\u5206\u7ec4\u6570\u636e\\n     * @param groupKeys the group keys\\n     * @return the shenyu result\\n     */\\n    @GetMapping(\\"/fetch\\")\\n    public ShenyuAdminResult fetchConfigs(@NotNull final String[] groupKeys) {\\n        Map<String, ConfigData<?>> result = Maps.newHashMap();\\n        for (String groupKey : groupKeys) {\\n            ConfigData<?> data = longPollingListener.fetchConfig(ConfigGroupEnum.valueOf(groupKey));\\n            result.put(groupKey, data);\\n        }\\n        return ShenyuAdminResult.success(ShenyuResultMessage.SUCCESS, result);\\n    }\\n    \\n  // \u7701\u7565\u4e86\u5176\u4ed6\u63a5\u53e3\\n\\n}\\n```\\n\\n- AbstractDataChangedListener#fetchConfig()\\n\\n\u6570\u636e\u83b7\u53d6\u76f4\u63a5\u4ece`CACHE`\u4e2d\u62ff\uff0c\u7136\u540e\u6839\u636e\u4e0d\u540c\u5206\u7ec4\u7c7b\u578b\u8fdb\u884c\u5339\u914d\uff0c\u5c01\u88c5\u3002\\n\\n```java\\npublic abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {\\n  /**\\n   * fetch configuration from cache.\\n   * \u83b7\u53d6\u5206\u7ec4\u4e0b\u7684\u5168\u91cf\u6570\u636e\\n   * @param groupKey the group key\\n   * @return the configuration data\\n   */\\n  public ConfigData<?> fetchConfig(final ConfigGroupEnum groupKey) {\\n    // \u76f4\u63a5\u4ece CACHE \u4e2d\u62ff\u6570\u636e\\n    ConfigDataCache config = CACHE.get(groupKey.name());\\n    switch (groupKey) {\\n      case APP_AUTH: // \u8ba4\u8bc1\u6570\u636e\\n        return buildConfigData(config, AppAuthData.class);\\n      case PLUGIN: // \u63d2\u4ef6\u6570\u636e\\n        return buildConfigData(config, PluginData.class);\\n      case RULE:   // \u89c4\u5219\u6570\u636e\\n        return buildConfigData(config, RuleData.class);\\n      case SELECTOR:  // \u9009\u62e9\u5668\u6570\u636e\\n        return buildConfigData(config, SelectorData.class);\\n      case META_DATA: // \u5143\u6570\u636e\\n        return buildConfigData(config, MetaData.class);\\n      default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\\n        throw new IllegalStateException(\\"Unexpected groupKey: \\" + groupKey);\\n    }\\n  }\\n}\\n```\\n\\n#### 3.5 \u6570\u636e\u53d8\u66f4\\n\\n\u5728\u4e4b\u524d\u7684`websocket`\u6570\u636e\u540c\u6b65\u548c`zookeeper`\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u77e5\u9053`admin`\u7aef\u6570\u636e\u540c\u6b65\u8bbe\u8ba1\u7ed3\u6784\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-http-data-sync/data-changed-listener-admin.png)\\n\\n\u5404\u79cd\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\u90fd\u662f`DataChangedListener`\u7684\u5b50\u7c7b\u3002\\n\\n\u5f53\u5728`admin`\u7aef\u4fee\u6539\u6570\u636e\u540e\uff0c\u901a\u8fc7`Spring`\u7684\u4e8b\u4ef6\u5904\u7406\u673a\u5236\uff0c\u53d1\u9001\u4e8b\u4ef6\u901a\u77e5\u3002\u53d1\u9001\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n```java\\n\\n/**\\n * Event forwarders, which forward the changed events to each ConfigEventListener.\\n * \u6570\u636e\u53d8\u66f4\u4e8b\u4ef6\u5206\u53d1\u5668\uff1a\u5f53admin\u7aef\u6709\u6570\u636e\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u5c06\u53d8\u66f4\u6570\u636e\u540c\u6b65\u5230 ShenYu \u7f51\u5173\\n * \u6570\u636e\u53d8\u66f4\u4f9d\u8d56\u4e8eSpring\u7684\u4e8b\u4ef6\u76d1\u542c\u673a\u5236\uff1aApplicationEventPublisher --\x3e ApplicationEvent --\x3e ApplicationListener\\n *\\n */\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n   //\u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n\\n    /**\\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\\n     * @param event\\n     */\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\\n                    break;\\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\\n                    break;\\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\\n                    break;\\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\\n                    // \u5f53\u9009\u62e9\u5668\u6570\u636e\u66f4\u65b0\u65f6\uff0c\u66f4\u65b0API\u6587\u6863\u4fe1\u606f\\n                    applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\\n                    break;\\n                case META_DATA:  // \u5143\u6570\u636e\\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\\n                    break;\\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\\n                    throw new IllegalStateException(\\"Unexpected value: \\" + event.getGroupKey());\\n            }\\n        }\\n    }\\n}\\n```\\n\\n\u5047\u8bbe\uff0c\u5bf9\u63d2\u4ef6\u4fe1\u606f\u8fdb\u884c\u4e86\u4fee\u6539\uff0c\u901a\u8fc7`http\u957f\u8f6e\u8be2`\u7684\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u90a3\u4e48`listener.onPluginChanged()`\u7684\u5b9e\u9645\u8c03\u7528\u7684\u662f`org.apache.shenyu.admin.listener.AbstractDataChangedListener#onPluginChanged`\uff1a\\n\\n```java\\n    /**\\n     * \u5728admin\u7684\u64cd\u4f5c\uff0c\u6709\u63d2\u4ef6\u53d1\u751f\u4e86\u66f4\u65b0\\n     * @param changed   the changed\\n     * @param eventType the event type\\n     */\\n    @Override\\n    public void onPluginChanged(final List<PluginData> changed, final DataEventTypeEnum eventType) {\\n        if (CollectionUtils.isEmpty(changed)) {\\n            return;\\n        }\\n        // \u66f4\u65b0\u5185\u5b58CACHE\\n        this.updatePluginCache();\\n        // \u6267\u884c\u53d8\u66f4\u4efb\u52a1\\n        this.afterPluginChanged(changed, eventType);\\n    }\\n```\\n\\n\\n\u6709\u4e24\u4e2a\u5904\u7406\u64cd\u4f5c\uff0c\u4e00\u662f\u66f4\u65b0\u5185\u5b58`CACHE`\uff0c\u8fd9\u4e2a\u5728\u524d\u9762\u5206\u6790\u8fc7\u4e86\uff1b\u53e6\u4e00\u4e2a\u662f\u6267\u884c\u53d8\u66f4\u4efb\u52a1\uff0c\u5728\u7ebf\u7a0b\u6c60\u4e2d\u6267\u884c\u3002\\n\\n- HttpLongPollingDataChangedListener#afterPluginChanged()\\n\\n```java\\n    @Override\\n    protected void afterPluginChanged(final List<PluginData> changed, final DataEventTypeEnum eventType) {\\n        // \u5728\u7ebf\u7a0b\u6c60\u4e2d\u6267\u884c\\n        scheduler.execute(new DataChangeTask(ConfigGroupEnum.PLUGIN));\\n    }\\n```\\n\\n- DataChangeTask\\n\\n\u6570\u636e\u53d8\u66f4\u4efb\u52a1\uff1a\u5c06\u963b\u585e\u961f\u5217\u4e2d\u7684\u5ba2\u6237\u7aef\u4f9d\u6b21\u79fb\u9664\uff0c\u5e76\u53d1\u9001\u54cd\u5e94\uff0c\u901a\u77e5\u7f51\u5173\u6709\u7ec4\u6570\u636e\u53d1\u751f\u53d8\u66f4\u3002\\n\\n```java\\nclass DataChangeTask implements Runnable {\\n\\t\\t//\u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91 \\n        @Override\\n        public void run() {\\n            // \u963b\u585e\u961f\u5217\u4e2d\u7684\u5ba2\u6237\u7aef\u8d85\u8fc7\u4e86\u7ed9\u5b9a\u7684\u503c100\uff0c\u5219\u5206\u6279\u6267\u884c\\n            if (clients.size() > httpSyncProperties.getNotifyBatchSize()) {\\n                List<LongPollingClient> targetClients = new ArrayList<>(clients.size());\\n                clients.drainTo(targetClients);\\n                List<List<LongPollingClient>> partitionClients = Lists.partition(targetClients, httpSyncProperties.getNotifyBatchSize());\\n               // \u5206\u6279\u6267\u884c\\n                partitionClients.forEach(item -> scheduler.execute(() -> doRun(item)));\\n            } else {\\n                // \u6267\u884c\u4efb\u52a1\\n                doRun(clients);\\n            }\\n        }\\n\\n        private void doRun(final Collection<LongPollingClient> clients) {\\n            // \u901a\u77e5\u6240\u6709\u5ba2\u6237\u7aef\u53d1\u751f\u4e86\u6570\u636e\u53d8\u66f4\\n            for (Iterator<LongPollingClient> iter = clients.iterator(); iter.hasNext();) {\\n                LongPollingClient client = iter.next();\\n                iter.remove();\\n                // \u53d1\u9001\u54cd\u5e94\\n                client.sendResponse(Collections.singletonList(groupKey));\\n                LOG.info(\\"send response with the changed group,ip={}, group={}, changeTime={}\\", client.ip, groupKey, changeTime);\\n            }\\n        }\\n    }\\n```\\n\\n\u81f3\u6b64\uff0c`admin`\u7aef\u6570\u636e\u540c\u6b65\u903b\u8f91\u5c31\u5206\u6790\u5b8c\u4e86\u3002\u5728\u57fa\u4e8e`http\u957f\u8f6e\u8be2`\u6570\u636e\u540c\u6b65\u662f\uff0c\u5b83\u4e3b\u8981\u6709\u4e09\u4e2a\u529f\u80fd\uff1a\\n\\n- \u63d0\u4f9b\u6570\u636e\u53d8\u66f4\u76d1\u542c\u63a5\u53e3\uff1b\\n- \u63d0\u4f9b\u83b7\u53d6\u53d8\u66f4\u6570\u636e\u63a5\u53e3\uff1b\\n- \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u79fb\u9664\u963b\u585e\u961f\u5217\u4e2d\u7684\u5ba2\u6237\u7aef\uff0c\u5e76\u54cd\u5e94\u7ed3\u679c\u3002\\n\\n\u6700\u540e\uff0c\u7528\u4e09\u5f20\u56fe\u63cf\u8ff0\u4e0b`admin`\u7aef\u957f\u8f6e\u8be2\u4efb\u52a1\u6d41\u7a0b\uff1a\\n\\n- `/configs/listener`\u6570\u636e\u53d8\u66f4\u76d1\u542c\u63a5\u53e3\uff1a\\n\\n![](/img/activities/code-analysis-http-data-sync/http-long-polling-listener-zh.png)\\n\\n- `/configs/fetch`\u83b7\u53d6\u53d8\u66f4\u6570\u636e\u63a5\u53e3\uff1a\\n\\n![](/img/activities/code-analysis-http-data-sync/http-long-polling-fetch-zh.png)\\n\\n- \u5728admin\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u66f4\u65b0\u6570\u636e\uff0c\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff1a\\n\\n![](/img/activities/code-analysis-http-data-sync/http-long-polling-admin-update-zh.png)\\n\\n\\n### 4. \u603b\u7ed3\\n\\n\u672c\u6587\u4e3b\u8981\u5bf9`ShenYu`\u7f51\u5173\u4e2d\u7684`http\u957f\u8f6e\u8be2`\u6570\u636e\u540c\u6b65\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a\\n\\n- `http\u957f\u8f6e\u8be2`\u7531\u7f51\u5173\u7aef\u4e3b\u52a8\u53d1\u8d77\u8bf7\u6c42\uff0c\u4e0d\u65ad\u8bf7\u6c42`admin`\u7aef\uff1b\\n- \u53d8\u66f4\u6570\u636e\u4ee5\u7ec4\u4e3a\u7c92\u5ea6\uff08\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219\u3001\u5143\u6570\u636e\uff09\uff1b\\n- `http\u957f\u8f6e\u8be2`\u7ed3\u679c\u53ea\u62ff\u5230\u4e86\u53d8\u66f4\u7ec4\uff0c\u8fd8\u9700\u8981\u518d\u6b21\u53d1\u8d77\u8bf7\u6c42\u83b7\u53d6\u7ec4\u6570\u636e\uff1b\\n- \u6570\u636e\u662f\u5426\u66f4\u65b0\u7531`md5`\u503c\u548c\u4fee\u6539\u65f6\u95f4`lastModifyTime`\u51b3\u5b9a\u3002"},{"id":"/DataSync-SourceCode-Analysis-Nacos-Data-Sync","metadata":{"permalink":"/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync.md","title":"Nacos\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"nacos","permalink":"/zh/blog/tags/nacos"},{"label":"data sync","permalink":"/zh/blog/tags/data-sync"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":28.35,"hasTruncateMarker":false,"authors":[{"name":"4zd","title":"Apache ShenYu Contributor","url":"https://github.com/4zd"}],"frontMatter":{"title":"Nacos\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","author":"4zd","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/4zd","tags":["nacos","data sync","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Http\u957f\u8f6e\u8be2\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync"},"nextItem":{"title":"WebSocket\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync"}},"content":"> [Apache ShenYu](https://shenyu.apache.org/zh/docs/index) \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 `API` \u7f51\u5173\u3002\\n\\n\u5728`ShenYu`\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002`Apache ShenYu` \u7f51\u5173\u5f53\u524d\u652f\u6301`ZooKeeper`\u3001`WebSocket`\u3001`Http\u957f\u8f6e\u8be2`\u3001`Nacos` \u3001`Etcd` \u548c `Consul` \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e`Nacos`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.4.0`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [\u6570\u636e\u540c\u6b65\u539f\u7406](https://shenyu.apache.org/zh/docs/design/data-sync) \u3002\\n\\n### 1. \u5173\u4e8eNacos\\n\\n[`Nacos`](https://github.com/alibaba/nacos) \u5e73\u53f0\u7528\u4e8e\u52a8\u6001\u670d\u52a1\u53d1\u73b0\uff0c\u4ee5\u53ca\u914d\u7f6e\u548c\u670d\u52a1\u7ba1\u7406\u3002 `Shenyu`\u7f51\u5173\u53ef\u9009\u62e9\u4f7f\u7528`Nacos`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n### 2. Admin\u6570\u636e\u540c\u6b65\\n\\n\u6211\u4eec\u4ece\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\u8fdb\u884c\u6e90\u7801\u8ffd\u8e2a\uff0c\u6bd4\u5982\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u5bf9`Divide`\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff1a\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/update-selector-zh.png)\\n\\n#### 2.1 \u63a5\u6536\u6570\u636e\\n\\n- SelectorController.updateSelector()\\n\\n\u8fdb\u5165`SelectorController`\u7c7b\u4e2d\u7684`updateSelector()`\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002\\n\\n```java\\n@Validated\\n@RequiredArgsConstructor\\n@RestController\\n@RequestMapping(\\"/selector\\")\\npublic class SelectorController {\\n    \\n    @PutMapping(\\"/{id}\\")\\n    public ShenyuAdminResult updateSelector(@PathVariable(\\"id\\") final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {\\n        // \u8bbe\u7f6e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636eid\\n        selectorDTO.setId(id);\\n        // \u521b\u5efa\u6216\u66f4\u65b0\u64cd\u4f5c\\n        Integer updateCount = selectorService.createOrUpdate(selectorDTO);\\n        // \u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\\n        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);\\n    }\\n    \\n    // ......\\n}\\n```\\n\\n#### 2.2 \u5904\u7406\u6570\u636e\\n\\n- SelectorServiceImpl.createOrUpdate()\\n\\n\u5728`SelectorServiceImpl`\u7c7b\u4e2d\u901a\u8fc7`createOrUpdate()`\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u66f4\u65b0`upstream`\u3002\\n\\n```java\\n@RequiredArgsConstructor\\n@Service\\npublic class SelectorServiceImpl implements SelectorService {\\n    // \u8d1f\u8d23\u4e8b\u4ef6\u53d1\u5e03\u7684eventPublisher\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n    @Override\\n    @Transactional(rollbackFor = Exception.class)\\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\\n        int selectorCount;\\n        // \u6784\u5efa\u6570\u636e DTO --\x3e DO\\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\\n        // \u5224\u65ad\u662f\u6dfb\u52a0\u8fd8\u662f\u66f4\u65b0\\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\\n            // \u63d2\u5165\u9009\u62e9\u5668\u6570\u636e\\n            selectorCount = selectorMapper.insertSelective(selectorDO);\\n            // \u63d2\u5165\u9009\u62e9\u5668\u4e2d\u7684\u6761\u4ef6\u6570\u636e\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\\n            });\\n            // check selector add\\n            // \u6743\u9650\u68c0\u67e5\\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\\n                dataPermissionDTO.setDataId(selectorDO.getId());\\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\\n            }\\n\\n        } else {\\n            // \u66f4\u65b0\u6570\u636e\uff0c\u5148\u5220\u9664\u518d\u65b0\u589e\\n            selectorCount = selectorMapper.updateSelective(selectorDO);\\n            //delete rule condition then add\\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\\n                selectorConditionMapper.insertSelective(selectorConditionDO);\\n            });\\n        }\\n        // \u53d1\u5e03\u4e8b\u4ef6\\n        publishEvent(selectorDO, selectorConditionDTOs);\\n\\n        // \u66f4\u65b0upstream\\n        updateDivideUpstream(selectorDO);\\n        return selectorCount;\\n    }\\n    \\n    \\n    // ......\\n    \\n}\\n\\n```\\n\\n\u5728`Service`\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u6df1\u5165\u8ffd\u8e2a\u4e86\u3002\u5173\u4e8e\u66f4\u65b0`upstream`\u64cd\u4f5c\uff0c\u653e\u5230\u540e\u9762\u5bf9\u5e94\u7684\u7ae0\u8282\u4e2d\u8fdb\u884c\u5206\u6790\uff0c\u91cd\u70b9\u5173\u6ce8\u53d1\u5e03\u4e8b\u4ef6\u7684\u64cd\u4f5c\uff0c\u5b83\u4f1a\u6267\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n`publishEvent()`\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u6784\u5efa\u6761\u4ef6\u6570\u636e\uff0c\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u3002\\n\\n```java\\n     private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\\n        // \u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\\n        // \u6784\u5efa\u6761\u4ef6\u6570\u636e\\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\\n        // \u53d1\u5e03\u53d8\u66f4\u6570\u636e\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\\n    }\\n```\\n\\n\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7`eventPublisher.publishEvent()`\u5b8c\u6210\uff0c\u8fd9\u4e2a`eventPublisher`\u5bf9\u8c61\u662f\u4e00\u4e2a`ApplicationEventPublisher`\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f`org.springframework.context.ApplicationEventPublisher`\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7`Spring`\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002\\n\\n> \u5173\u4e8e`ApplicationEventPublisher`\uff1a\\n>\\n> \u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 `ApplicationEventPublisher` \u7684 `publishEvent` \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c`Spring`\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 `onApplicationEvent` \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 `publishEvent`\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 `ApplicationEventPublisher` \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002\\n>\\n> - `ApplicationEventPublisher`\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b\\n> - `ApplicationEvent`\uff1a`Spring` \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b\\n> - `ApplicationListener`\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\uff1b\\n\\n\\n\u5728`Spring`\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c\\n\\n\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684`ApplicationEventPublisher`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a`eventPublisher`\u3002\\n\\n\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f`ApplicationEvent`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEvent`\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\npublic class DataChangedEvent extends ApplicationEvent {\\n//......\\n}\\n```\\n\\n\u6700\u540e\u4e00\u4e2a\u662f `ApplicationListener`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEventDispatcher`\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n    //......\\n    \\n}\\n```\\n\\n#### 2.3 \u5206\u53d1\u6570\u636e\\n\\n- DataChangedEventDispatcher.onApplicationEvent()\\n\\n\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230`DataChangedEventDispatcher`\u7c7b\u4e2d\u7684`onApplicationEvent()`\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n  /**\\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\\n     * @param event\\n     */\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\\n                    break;\\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\\n                    break;\\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\\n                    break;\\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\\n                    break;\\n                case META_DATA:  // \u5143\u6570\u636e\\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\\n                    break;\\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\\n                    throw new IllegalStateException(\\"Unexpected value: \\" + event.getGroupKey());\\n            }\\n        }\\n    }\\n    \\n}\\n```\\n\\n\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528`onApplicationEvent`\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002\\n\\n`ShenYu`\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u662f\u4e94\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u548c\u5143\u6570\u636e\u3002\\n\\n\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08`DataChangedListener`\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u5b83\u7684\u5177\u4f53\u5b9e\u73b0\u6709\uff1a\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/data-changed-listener.png)\\n\\n\u8fd9\u51e0\u4e2a\u5b9e\u73b0\u7c7b\u5c31\u662f\u5f53\u524d`ShenYu`\u652f\u6301\u7684\u540c\u6b65\u7b56\u7565\uff1a\\n\\n- `WebsocketDataChangedListener`\uff1a\u57fa\u4e8e`websocket`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ZookeeperDataChangedListener`\uff1a\u57fa\u4e8e`zookeeper`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ConsulDataChangedListener`\uff1a\u57fa\u4e8e`consul`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `EtcdDataDataChangedListener`\uff1a\u57fa\u4e8e`etcd`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `HttpLongPollingDataChangedListener`\uff1a\u57fa\u4e8e`http\u957f\u8f6e\u8be2`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `NacosDataChangedListener`\uff1a\u57fa\u4e8e`nacos`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n\\n\u65e2\u7136\u6709\u8fd9\u4e48\u591a\u79cd\u5b9e\u73b0\u7b56\u7565\uff0c\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u5462\uff1f\\n\\n\u56e0\u4e3a\u672c\u6587\u662f\u57fa\u4e8e`Nacos`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ee5`NacosDataChangedListener`\u4e3a\u4f8b\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u88ab\u52a0\u8f7d\u5e76\u5b9e\u73b0\u7684\u3002\\n\\n\u901a\u8fc7\u67e5\u770b\u5bf9`NacosDataChangedListener`\u7c7b\u7684\u8c03\u7528\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u5b83\u662f\u5728`DataSyncConfiguration`\u7c7b\u8fdb\u884c\u914d\u7f6e\u7684\u3002\\n\\n```java\\n/**\\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\\n * The type Data sync configuration.\\n */\\n@Configuration\\npublic class DataSyncConfiguration {\\n\\n   //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\\n  \\n    /**\\n     * The type Nacos listener.\\n     */\\n    @Configuration\\n    @ConditionalOnProperty(prefix = \\"shenyu.sync.nacos\\", name = \\"url\\")\\n    @Import(NacosConfiguration.class)\\n    static class NacosListener {\\n\\n        /**\\n         * Data changed listener data changed listener.\\n         *\\n         * @param configService the config service\\n         * @return the data changed listener\\n         */\\n        @Bean\\n        @ConditionalOnMissingBean(NacosDataChangedListener.class)\\n        public DataChangedListener nacosDataChangedListener(final ConfigService configService) {\\n            return new NacosDataChangedListener(configService);\\n        }\\n\\n        /**\\n         * Nacos data init zookeeper data init.\\n         *\\n         * @param configService the config service\\n         * @param syncDataService the sync data service\\n         * @return the nacos data init\\n         */\\n        @Bean\\n        @ConditionalOnMissingBean(NacosDataInit.class)\\n        public NacosDataInit nacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {\\n            return new NacosDataInit(configService, syncDataService);\\n        }\\n    }  \\n    \\n   //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\\n}\\n\\n```\\n\\n\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u662f\u901a\u8fc7`SpringBoot`\u6761\u4ef6\u88c5\u914d\u7c7b\u5b9e\u73b0\u7684\u3002\u5728`NacosListener`\u7c7b\u4e0a\u9762\u6709\u51e0\u4e2a\u6ce8\u89e3\uff1a\\n\\n- `@Configuration`\uff1a\u914d\u7f6e\u6587\u4ef6\uff0c\u5e94\u7528\u4e0a\u4e0b\u6587\uff1b\\n\\n- `@ConditionalOnProperty(prefix = \\"shenyu.sync.nacos\\", name = \\"url\\")`\uff1a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u91c7\u7528`nacos`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n  ```properties\\n  shenyu:  \\n    sync:\\n       nacos:\\n            url: localhost:8848\\n  ```\\n\\n- `@Import(NacosConfiguration.class)`\uff1a\u5bfc\u5165\u53e6\u4e00\u4e2a\u914d\u7f6e\u7c7b`NacosConfiguration`\uff0c`NacosConfiguration`\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b9\u6cd5`ConfigService nacosConfigService(final NacosProperties nacosProp)`\uff0c\u5c06Nacos\u5c5e\u6027\u8f6c\u6362\u4e3a`ConfigService`\u7c7b\u578b\u7684bean\uff0c\u800cNacos\u5c5e\u6027\u662f\u901a\u8fc7`@EnableConfigurationProperties(NacosProperties.class)` \u5bfc\u5165\u7684\u3002\u6211\u4eec\u5148\u770bConfigService\u7c7b\u578b\u7684bean\u5b9a\u4e49\u3002\u518d\u5206\u6790\u5c5e\u6027\u914d\u7f6e\u7c7b\u548c\u5bf9\u5e94\u7684\u5c5e\u6027\u914d\u7f6e\u6587\u4ef6\u3002\\n\\n```java\\n/**\\n * Nacos configuration.\\n */\\n@EnableConfigurationProperties(NacosProperties.class)\\npublic class NacosConfiguration {\\n\\n    /**\\n     * register configService in spring ioc.\\n     *\\n     * @param nacosProp the nacos configuration\\n     * @return ConfigService {@linkplain ConfigService}\\n     * @throws Exception the exception\\n     */\\n    @Bean\\n    @ConditionalOnMissingBean(ConfigService.class)\\n    public ConfigService nacosConfigService(final NacosProperties nacosProp) throws Exception {\\n        Properties properties = new Properties();\\n        if (nacosProp.getAcm() != null && nacosProp.getAcm().isEnabled()) {\\n            // Use aliyun ACM service\\n            properties.put(PropertyKeyConst.ENDPOINT, nacosProp.getAcm().getEndpoint());\\n            properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getAcm().getNamespace());\\n            // Use subaccount ACM administrative authority\\n            properties.put(PropertyKeyConst.ACCESS_KEY, nacosProp.getAcm().getAccessKey());\\n            properties.put(PropertyKeyConst.SECRET_KEY, nacosProp.getAcm().getSecretKey());\\n        } else {\\n            properties.put(PropertyKeyConst.SERVER_ADDR, nacosProp.getUrl());\\n            if (StringUtils.isNotBlank(nacosProp.getNamespace())) {\\n                properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getNamespace());\\n            }\\n            if (StringUtils.isNotBlank(nacosProp.getUsername())) {\\n                properties.put(PropertyKeyConst.USERNAME, nacosProp.getUsername());\\n            }\\n            if (StringUtils.isNotBlank(nacosProp.getPassword())) {\\n                properties.put(PropertyKeyConst.PASSWORD, nacosProp.getPassword());\\n            }\\n        }\\n        return NacosFactory.createConfigService(properties);\\n    }\\n}\\n```\\n\\n\u8fd9\u4e2a\u65b9\u6cd5\u4e3b\u8981\u5206\u6210\u4e24\u6b65\uff0c\u7b2c\u4e00\u6b65\u6839\u636e\u662f\u5426\u4f7f\u7528\u4e86aliyun\u7684ACM\u670d\u52a1\uff0c\u4eceNacosProperties\u4e2d\u83b7\u53d6\u4e0d\u540c\u7684nacos\u8def\u5f84\u548c\u9274\u6743\u4fe1\u606f\uff0c\u7b2c\u4e8c\u6b65\u6839\u636e\u83b7\u53d6\u5230\u7684\u8fd9\u4e9b\u5c5e\u6027\uff0c\u4f7f\u7528Nacos\u5b98\u65b9\u7684\u5de5\u5382\u65b9\u6cd5\uff0c\u4f7f\u7528\u53cd\u5c04\u7684\u65b9\u5f0f\uff0c\u521b\u5efaconfigService\u3002\\n\\n\u63a5\u4e0b\u6765\uff0c\u8ba9\u6211\u4eec\u5206\u6790\u4e00\u4e0bNacos\u7684\u5c5e\u6027\u914d\u7f6e\u548c\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u3002\\n\\n```java\\n/**\\n * The type Nacos config.\\n */\\n@ConfigurationProperties(prefix = \\"shenyu.sync.nacos\\")\\npublic class NacosProperties {\\n\\n    private String url;\\n\\n    private String namespace;\\n\\n    private String username;\\n\\n    private String password;\\n\\n    private NacosACMProperties acm;\\n\\n    /**\\n     * Gets the value of url.\\n     *\\n     * @return the value of url\\n     */\\n    public String getUrl() {\\n        return url;\\n    }\\n\\n    /**\\n     * Sets the url.\\n     *\\n     * @param url url\\n     */\\n    public void setUrl(final String url) {\\n        this.url = url;\\n    }\\n\\n    /**\\n     * Gets the value of namespace.\\n     *\\n     * @return the value of namespace\\n     */\\n    public String getNamespace() {\\n        return namespace;\\n    }\\n\\n    /**\\n     * Sets the namespace.\\n     *\\n     * @param namespace namespace\\n     */\\n    public void setNamespace(final String namespace) {\\n        this.namespace = namespace;\\n    }\\n\\n    /**\\n     * Gets the value of username.\\n     *\\n     * @return the value of username\\n     */\\n    public String getUsername() {\\n        return username;\\n    }\\n\\n    /**\\n     * Sets the username.\\n     *\\n     * @param username username\\n     */\\n    public void setUsername(final String username) {\\n        this.username = username;\\n    }\\n\\n    /**\\n     * Gets the value of password.\\n     *\\n     * @return the value of password\\n     */\\n    public String getPassword() {\\n        return password;\\n    }\\n\\n    /**\\n     * Sets the password.\\n     *\\n     * @param password password\\n     */\\n    public void setPassword(final String password) {\\n        this.password = password;\\n    }\\n\\n    /**\\n     * Gets the value of acm.\\n     *\\n     * @return the value of acm\\n     */\\n    public NacosACMProperties getAcm() {\\n        return acm;\\n    }\\n\\n    /**\\n     * Sets the acm.\\n     *\\n     * @param acm acm\\n     */\\n    public void setAcm(final NacosACMProperties acm) {\\n        this.acm = acm;\\n    }\\n\\n    public static class NacosACMProperties {\\n\\n        private boolean enabled;\\n\\n        private String endpoint;\\n\\n        private String namespace;\\n\\n        private String accessKey;\\n\\n        private String secretKey;\\n\\n        /**\\n         * Gets the value of enabled.\\n         *\\n         * @return the value of enabled\\n         */\\n        public boolean isEnabled() {\\n            return enabled;\\n        }\\n\\n        /**\\n         * Sets the enabled.\\n         *\\n         * @param enabled enabled\\n         */\\n        public void setEnabled(final boolean enabled) {\\n            this.enabled = enabled;\\n        }\\n\\n        /**\\n         * Gets the value of endpoint.\\n         *\\n         * @return the value of endpoint\\n         */\\n        public String getEndpoint() {\\n            return endpoint;\\n        }\\n\\n        /**\\n         * Sets the endpoint.\\n         *\\n         * @param endpoint endpoint\\n         */\\n        public void setEndpoint(final String endpoint) {\\n            this.endpoint = endpoint;\\n        }\\n\\n        /**\\n         * Gets the value of namespace.\\n         *\\n         * @return the value of namespace\\n         */\\n        public String getNamespace() {\\n            return namespace;\\n        }\\n\\n        /**\\n         * Sets the namespace.\\n         *\\n         * @param namespace namespace\\n         */\\n        public void setNamespace(final String namespace) {\\n            this.namespace = namespace;\\n        }\\n\\n        /**\\n         * Gets the value of accessKey.\\n         *\\n         * @return the value of accessKey\\n         */\\n        public String getAccessKey() {\\n            return accessKey;\\n        }\\n\\n        /**\\n         * Sets the accessKey.\\n         *\\n         * @param accessKey accessKey\\n         */\\n        public void setAccessKey(final String accessKey) {\\n            this.accessKey = accessKey;\\n        }\\n\\n        /**\\n         * Gets the value of secretKey.\\n         *\\n         * @return the value of secretKey\\n         */\\n        public String getSecretKey() {\\n            return secretKey;\\n        }\\n\\n        /**\\n         * Sets the secretKey.\\n         *\\n         * @param secretKey secretKey\\n         */\\n        public void setSecretKey(final String secretKey) {\\n            this.secretKey = secretKey;\\n        }\\n    }\\n\\n}\\n```\\n\\n\u5f53\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\u4e86`shenyu.sync.nacos.url`\u5c5e\u6027\u65f6\uff0c\u5c06\u91c7\u7528`nacos`\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u6b64\u65f6\u914d\u7f6e\u7c7b`NacosListener`\u4f1a\u751f\u6548\uff0c\u5e76\u751f\u6210`NacosDataChangedListener`\u548c`NacosDataInit`\u7c7b\u578b\u7684bean\u3002\\n* \u751f\u6210`NacosDataChangedListener`\u7c7b\u578b\u7684bean\uff0c`nacosDataChangedListener`\uff0c\u8fd9\u4e2abean\u5c06`ConfigService`\u7c7b\u578b\u7684bean\u4f5c\u4e3a\u6210\u5458\u53d8\u91cf\uff0c`ConfigService`\u662fnacos\u5b98\u65b9\u63d0\u4f9b\u7684api\uff0c\u5f53`nacosDataChangedListener`\u76d1\u542c\u5230\u4e8b\u4ef6\u65f6\uff0c\u8fdb\u884c\u56de\u8c03\u64cd\u4f5c\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5api\u76f4\u63a5\u4e0enacos\u670d\u52a1\u5668\u4ea4\u4e92\uff0c\u4fee\u6539\u914d\u7f6e\u3002\\n* \u751f\u6210`NacosDataInit`\u7c7b\u578b\u7684bean\uff0c`nacosDataInit`\uff0c\u8fd9\u4e2abean\u5c06bean`configService`\u548cbean`syncDataService`\u4f5c\u4e3a\u6210\u5458\u53d8\u91cf\uff0c\u8c03\u7528`Nacos`\u7684api `configService`\u5224\u65ad\u914d\u7f6e\u662f\u5426\u672a\u521d\u59cb\u5316\uff0c\u672a\u521d\u59cb\u5316\u5219\u8c03\u7528`syncDataService`\u8fdb\u884c\u5237\u65b0\u64cd\u4f5c\uff0c\u5c06\u5728\u4e0b\u6587\u8be6\u8ff0\u3002\\n\u6839\u636e\u4e0a\u6587\u6240\u8ff0\uff0c\u5728\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5`onApplicationEvent()`\u4e2d\uff0c\u4f1a\u89e6\u53d1\u76f8\u5e94\u7684`listener`\u7684\u64cd\u4f5c\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u662f\u5bf9\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u6570\u636e\u540c\u6b65\u91c7\u7528\u7684\u662f`nacos`\uff0c\u6240\u4ee5\uff0c\u4ee3\u7801\u4f1a\u8fdb\u5165\u5230`NacosDataChangedListener`\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\u3002\\n\\n```java\\n    //DataChangedEventDispatcher.java\\n\\t\\t@Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                    \\n                // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n                    \\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // \u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u4f1a\u8fdb\u5165\u5230NacosDataChangedListener\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\\n                    break;\\n         }\\n    }\\n```\\n\\n#### 2.4 Nacos\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\n\\n- NacosDataChangedListener.onSelectorChanged()\\n\\n  \u5728`onSelectorChanged()`\u65b9\u6cd5\u4e2d\uff0c\u5224\u65ad\u64cd\u4f5c\u7c7b\u578b\uff0c\u662f\u5237\u65b0\u540c\u6b65\u8fd8\u662f\u66f4\u65b0\u6216\u521b\u5efa\u540c\u6b65\u3002\u6839\u636e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636e\u4fe1\u606f\u5224\u65ad\u8282\u70b9\u662f\u5426\u5728`nacos`\u4e2d\u3002\\n\\n```java\\n/**\\n * Use nacos to push data changes.\\n */\\npublic class NacosDataChangedListener implements DataChangedListener {\\n    // \u9009\u62e9\u5668\u4fe1\u606f\u53d1\u751f\u6539\u53d8\\n    @Override\\n    public void onSelectorChanged(final List<SelectorData> changed, final DataEventTypeEnum eventType) {\\n        updateSelectorMap(getConfig(NacosPathConstants.SELECTOR_DATA_ID));\\n        switch (eventType) {\\n            case DELETE:\\n                changed.forEach(selector -> {\\n                    List<SelectorData> ls = SELECTOR_MAP\\n                            .getOrDefault(selector.getPluginName(), new ArrayList<>())\\n                            .stream()\\n                            .filter(s -> !s.getId().equals(selector.getId()))\\n                            .sorted(SELECTOR_DATA_COMPARATOR)\\n                            .collect(Collectors.toList());\\n                    SELECTOR_MAP.put(selector.getPluginName(), ls);\\n                });\\n                break;\\n            case REFRESH:\\n            case MYSELF:\\n                SELECTOR_MAP.keySet().removeAll(SELECTOR_MAP.keySet());\\n                changed.forEach(selector -> {\\n                    List<SelectorData> ls = SELECTOR_MAP\\n                            .getOrDefault(selector.getPluginName(), new ArrayList<>())\\n                            .stream()\\n                            .sorted(SELECTOR_DATA_COMPARATOR)\\n                            .collect(Collectors.toList());\\n                    ls.add(selector);\\n                    SELECTOR_MAP.put(selector.getPluginName(), ls);\\n                });\\n                break;\\n            default:\\n                changed.forEach(selector -> {\\n                    List<SelectorData> ls = SELECTOR_MAP\\n                            .getOrDefault(selector.getPluginName(), new ArrayList<>())\\n                            .stream()\\n                            .filter(s -> !s.getId().equals(selector.getId()))\\n                            .sorted(SELECTOR_DATA_COMPARATOR)\\n                            .collect(Collectors.toList());\\n                    ls.add(selector);\\n                    SELECTOR_MAP.put(selector.getPluginName(), ls);\\n                });\\n                break;\\n        }\\n        publishConfig(NacosPathConstants.SELECTOR_DATA_ID, SELECTOR_MAP);\\n    }\\n}\\n```\\n\\n\\n\\n\u8fd9\u90e8\u5206\u662f\u6838\u5fc3\u3002`changed`\u8868\u793a\u9700\u66f4\u65b0\u7684`SelectorData`\u5217\u8868\uff0c`eventType`\u8868\u793a\u4e8b\u4ef6\u7c7b\u578b\u3002`SELECTOR_MAP`\u7684\u7c7b\u578b\u662f`ConcurrentMap<String, List<SelectorData>>`\uff0c\u8be5map\u7684key\u4e3aselector\u6240\u5c5e\u7684plugin\u7684\u540d\u79f0\uff0cvalue\u4e3a\u8be5plugin\u4e0b\u7684selector\u5217\u8868\u3002`NacosPathConstants.SELECTOR_DATA_ID`\u7684\u503c\u4e3a`shenyu.selector.json`\u3002\u64cd\u4f5c\u6b65\u9aa4\u5982\u4e0b\uff0c\u7b2c\u4e00\u6b65\uff0c\u4f7f\u7528`getConfig`\u65b9\u6cd5\u8c03\u7528`Nacos`\u7684api\uff0c\u4ece`Nacos`\u83b7\u53d6`group`\u4e3a`shenyu.selector.json`\u7684\u914d\u7f6e\u4fe1\u606f\uff0c`updateSelectorMap`\u65b9\u6cd5\u4f7f\u7528\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u66f4\u65b0`SELECTOR_MAP`\uff0c\u8fd9\u6837\u5c31\u540c\u6b65\u5230\u4e86`Nacos`\u4e0a\u6700\u65b0\u7684selector\u4fe1\u606f\u3002\u7b2c\u4e8c\u6b65\uff0c\u518d\u6839\u636e\u4e8b\u4ef6\u7c7b\u578b\u6765\u66f4\u65b0`SELECTOR_MAP`\uff0c\u6700\u540e\u4f7f\u7528`publishConfig`\u65b9\u6cd5\uff0c\u8c03\u7528`Nacos`\u7684api\uff0c\u5c06`Nacos`\u4e0a\uff0c`group`\u4e3a`shenyu.selector.json`\u7684\u914d\u7f6e\u8fdb\u884c\u5168\u91cf\u66ff\u6362\u3002\\n\\n\u53ea\u8981\u5c06\u53d8\u52a8\u7684\u6570\u636e\u6b63\u786e\u5199\u5165\u5230`Nacos`\u4e0a\uff0c`admin`\u8fd9\u8fb9\u7684\u64cd\u4f5c\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002\\n\\n\u5728\u6211\u4eec\u5f53\u524d\u7684\u6848\u4f8b\u4e2d\uff0c\u5bf9`Divide`\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff0c\u5c31\u4f1a\u5bf9\u56fe\u4e2d\u7684\u7279\u5b9a\u8282\u70b9\u66f4\u65b0\u3002\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/zookeeper-node.png)\\n\\n\\n\u6211\u4eec\u7528\u65f6\u5e8f\u56fe\u5c06\u4e0a\u9762\u7684\u66f4\u65b0\u6d41\u7a0b\u4e32\u8054\u8d77\u6765\u3002\\n\\n![](/img/activities/code-analysis-nacos-data-sync/nacos-sync-sequence-admin-zh.png)\\n\\n\\n### 3. \u7f51\u5173\u6570\u636e\u540c\u6b65\\n\\n\u5047\u8bbe`ShenYu`\u7f51\u5173\u5df2\u7ecf\u5728\u6b63\u5e38\u8fd0\u884c\uff0c\u4f7f\u7528\u7684\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e5f\u662f`nacos`\u3002\u90a3\u4e48\u5f53\u5728`admin`\u7aef\u66f4\u65b0\u9009\u62e9\u5668\u6570\u636e\u540e\uff0c\u5e76\u4e14\u5411`nacos`\u53d1\u9001\u4e86\u53d8\u66f4\u7684\u6570\u636e\uff0c\u90a3\u7f51\u5173\u662f\u5982\u4f55\u63a5\u6536\u5e76\u5904\u7406\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7ee7\u7eed\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u4e00\u63a2\u7a76\u7adf\u3002\\n\\n#### 3.1 `NacosSyncDataService`\u63a5\u6536\u6570\u636e\\n\\n\u7f51\u5173\u662f\u901a\u8fc7`NacosSyncDataService`\u5bf9`nacos`\u8fdb\u884c\u76d1\u542c\u5e76\u83b7\u53d6\u6570\u636e\u66f4\u65b0\u7684\uff0c\u4f46\u662f\u5728\u8fd9\u90e8\u5206\u5185\u5bb9\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u770b\u4e00\u4e0b`NacosSyncDataService`\u7c7b\u578b\u7684bean\u662f\u5982\u4f55\u751f\u6210\u7684\u3002\u7b54\u6848\u662f\u5728Spring\u914d\u7f6e\u7c7b`NacosSyncDataConfiguration`\u4e2d\u5b9a\u4e49\u7684\u3002\u6211\u4eec\u770b\u5230`NacosSyncDataConfiguration`\u7c7b\u4e0a\u7684\u6ce8\u89e3\uff0c`@ConditionalOnProperty(prefix = \\"shenyu.sync.nacos\\", name = \\"url\\")`\uff0c\u8fd9\u4e2a\u6ce8\u89e3\u6211\u4eec\u5728\u4e0a\u6587\u5bf9`ShenYu`\u7684Admin\u7aef\u4e2d\u7684`NacosListener`\u7c7b\u8fdb\u884c\u5206\u6790\u65f6\u770b\u5230\u8fc7\uff0c\u662f\u4e00\u4e2a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u5728`Shenyu`\u7f51\u5173\u7aef\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u8868\u793a`Shenyu`\u7f51\u5173\u7aef\u91c7\u7528`nacos`\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c`NacosSyncDataConfiguration`\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u751f\u6548\u3002\\n\\n```properties\\nshenyu:  \\n  sync:\\n     nacos:\\n          url: localhost:8848\\n```\\n\\n```java\\n/**\\n * Nacos sync data configuration for spring boot.\\n */\\n@Configuration\\n@ConditionalOnClass(NacosSyncDataService.class)\\n@ConditionalOnProperty(prefix = \\"shenyu.sync.nacos\\", name = \\"url\\")\\npublic class NacosSyncDataConfiguration {\\n\\n    private static final Logger LOGGER = LoggerFactory.getLogger(NacosSyncDataConfiguration.class);\\n\\n    /**\\n     * Nacos sync data service.\\n     *\\n     * @param configService     the config service\\n     * @param pluginSubscriber the plugin subscriber\\n     * @param metaSubscribers   the meta subscribers\\n     * @param authSubscribers   the auth subscribers\\n     * @return the sync data service\\n     */\\n    @Bean\\n    public SyncDataService nacosSyncDataService(final ObjectProvider<ConfigService> configService, final ObjectProvider<PluginDataSubscriber> pluginSubscriber,\\n                                           final ObjectProvider<List<MetaDataSubscriber>> metaSubscribers, final ObjectProvider<List<AuthDataSubscriber>> authSubscribers) {\\n        LOGGER.info(\\"you use nacos sync shenyu data.......\\");\\n        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),\\n                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));\\n    }\\n\\n    /**\\n     * Nacos config service config service.\\n     *\\n     * @param nacosConfig the nacos config\\n     * @return the config service\\n     * @throws Exception the exception\\n     */\\n    @Bean\\n    public ConfigService nacosConfigService(final NacosConfig nacosConfig) throws Exception {\\n        Properties properties = new Properties();\\n        if (nacosConfig.getAcm() != null && nacosConfig.getAcm().isEnabled()) {\\n            properties.put(PropertyKeyConst.ENDPOINT, nacosConfig.getAcm().getEndpoint());\\n            properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getAcm().getNamespace());\\n            properties.put(PropertyKeyConst.ACCESS_KEY, nacosConfig.getAcm().getAccessKey());\\n            properties.put(PropertyKeyConst.SECRET_KEY, nacosConfig.getAcm().getSecretKey());\\n        } else {\\n            properties.put(PropertyKeyConst.SERVER_ADDR, nacosConfig.getUrl());\\n            if (StringUtils.isNotBlank(nacosConfig.getNamespace())) {\\n                properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getNamespace());\\n            }\\n            if (nacosConfig.getUsername() != null) {\\n                properties.put(PropertyKeyConst.USERNAME, nacosConfig.getUsername());\\n            }\\n            if (nacosConfig.getPassword() != null) {\\n                properties.put(PropertyKeyConst.PASSWORD, nacosConfig.getPassword());\\n            }\\n        }\\n        return NacosFactory.createConfigService(properties);\\n    }\\n\\n    /**\\n     * Http config http config.\\n     *\\n     * @return the http config\\n     */\\n    @Bean\\n    @ConfigurationProperties(prefix = \\"shenyu.sync.nacos\\")\\n    public NacosConfig nacosConfig() {\\n        return new NacosConfig();\\n    }\\n}\\n```\\n\\n\u6211\u4eec\u91cd\u70b9\u5173\u6ce8\u4e00\u4e0b\u4e0a\u9762\u4ee3\u7801\u4e2d`nacosSyncDataService`\u8fd9\u4e2abean\u7684\u751f\u6210\uff1a\\n\\n```java\\n@Bean\\npublic SyncDataService nacosSyncDataService(final ObjectProvider<ConfigService> configService, final ObjectProvider<PluginDataSubscriber> pluginSubscriber,\\n                                           final ObjectProvider<List<MetaDataSubscriber>> metaSubscribers, final ObjectProvider<List<AuthDataSubscriber>> authSubscribers) {\\n        LOGGER.info(\\"you use nacos sync shenyu data.......\\");\\n        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),\\n                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));\\n}\\n```\\n\\n\u662f\u76f4\u63a5\u8c03\u7528`NacosSyncDataService`\u7684\u6784\u9020\u65b9\u6cd5new\u4e86\u4e00\u4e2a\u8be5\u7c7b\u578b\u7684\u5bf9\u8c61\u3002\u6211\u4eec\u7ee7\u7eed\u770b\u6784\u9020\u65b9\u6cd5\uff1a\\n\\n```java\\npublic NacosSyncDataService(final ConfigService configService, final PluginDataSubscriber pluginDataSubscriber,\\n                                final List<MetaDataSubscriber> metaDataSubscribers, final List<AuthDataSubscriber> authDataSubscribers) {\\n\\n        super(configService, pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);\\n        start();\\n}\\n```\\n\\n```java\\n    public void start() {\\n        watcherData(NacosPathConstants.PLUGIN_DATA_ID, this::updatePluginMap);\\n        watcherData(NacosPathConstants.SELECTOR_DATA_ID, this::updateSelectorMap);\\n        watcherData(NacosPathConstants.RULE_DATA_ID, this::updateRuleMap);\\n        watcherData(NacosPathConstants.META_DATA_ID, this::updateMetaDataMap);\\n        watcherData(NacosPathConstants.AUTH_DATA_ID, this::updateAuthMap);\\n    }\\n```\\n\\n```java\\n    protected void watcherData(final String dataId, final OnChange oc) {\\n        Listener listener = new Listener() {\\n            @Override\\n            public void receiveConfigInfo(final String configInfo) {\\n                oc.change(configInfo);\\n            }\\n\\n            @Override\\n            public Executor getExecutor() {\\n                return null;\\n            }\\n        };\\n        oc.change(getConfigAndSignListener(dataId, listener));\\n        LISTENERS.computeIfAbsent(dataId, key -> new ArrayList<>()).add(listener);\\n    }\\n```\\n\\n\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u6784\u9020\u65b9\u6cd5\u4e2d\u8c03\u7528\u4e86`start`\u65b9\u6cd5\uff0c\u5e76\u4e14\u901a\u8fc7`watcherData`\u65b9\u6cd5\u521b\u5efa\u4e86\u76d1\u542c\u5668\uff0c\u5e76\u4e14\u5173\u8054\u4e86\u56de\u8c03\u51fd\u6570oc\uff0c\u7531\u4e8e\u6211\u4eec\u6b63\u5728\u5206\u6790selector\u7c7b\u578b\u7ec4\u4ef6\u7684\u53d8\u5316\uff0c\u5bf9\u5e94\u7684\u56de\u8c03\u51fd\u6570\u662f`updateSelectorMap`\u3002\u8fd9\u4e2a\u56de\u8c03\u51fd\u6570\u7528\u4e8e\u5904\u7406\u6570\u636e\u3002\\n\\n#### 3.2 \u5904\u7406\u6570\u636e\\n\\n- NacosCacheHandler.updateSelectorMap()\\n\\n\u7ecf\u8fc7\u5224\u7a7a\u903b\u8f91\u4e4b\u540e\uff0c\u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684\u64cd\u4f5c\u53c8\u4ea4\u7ed9\u4e86`PluginDataSubscriber`\u5904\u7406\u3002\\n\\n```java\\n    protected void updateSelectorMap(final String configInfo) {\\n        try {\\n            List<SelectorData> selectorDataList = GsonUtils.getInstance().toObjectMapList(configInfo, SelectorData.class).values().stream().flatMap(Collection::stream).collect(Collectors.toList());\\n            selectorDataList.forEach(selectorData -> Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -> {\\n                subscriber.unSelectorSubscribe(selectorData);\\n                subscriber.onSelectorSubscribe(selectorData);\\n            }));\\n        } catch (JsonParseException e) {\\n            LOG.error(\\"sync selector data have error:\\", e);\\n        }\\n    }\\n```\\n\\n`PluginDataSubscriber`\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b83\u53ea\u6709\u4e00\u4e2a`CommonPluginDataSubscriber`\u5b9e\u73b0\u7c7b\uff0c\u8d1f\u8d23\u5904\u7406\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\u3002\\n\\n\\n#### 3.3 \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\\n\\n- PluginDataSubscriber.onSelectorSubscribe()\\n\\n\u5b83\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528`subscribeDataHandler()`\u65b9\u6cd5\u3002\u5728\u65b9\u6cd5\u4e2d\uff0c\u66f4\u5177\u6570\u636e\u7c7b\u578b\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u6216\u89c4\u5219\uff09\uff0c\u64cd\u4f5c\u7c7b\u578b\uff08\u66f4\u65b0\u6216\u5220\u9664\uff09\uff0c\u53bb\u6267\u884c\u4e0d\u540c\u903b\u8f91\u3002\\n\\n```java\\n/**\\n * \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\\n * The type Common plugin data subscriber.\\n */\\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\\n    //......\\n     // \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\\n    @Override\\n    public void onSelectorSubscribe(final SelectorData selectorData) {\\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\\n    }    \\n    \\n    // \u8ba2\u9605\u6570\u636e\u5904\u7406\u5668\uff0c\u5904\u7406\u6570\u636e\u7684\u66f4\u65b0\u6216\u5220\u9664\\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\\n        Optional.ofNullable(classData).ifPresent(data -> {\\n            // \u63d2\u4ef6\u6570\u636e\\n            if (data instanceof PluginData) {\\n                PluginData pluginData = (PluginData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cachePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\\n                }\\n            } else if (data instanceof SelectorData) {  // \u9009\u62e9\u5668\u6570\u636e\\n                SelectorData selectorData = (SelectorData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\\n                }\\n            } else if (data instanceof RuleData) {  // \u89c4\u5219\u6570\u636e\\n                RuleData ruleData = (RuleData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) { // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\\n                }\\n            }\\n        });\\n    }\\n    \\n}\\n```\\n\\n\\n#### 3.4 \u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58\\n\\n\u90a3\u4e48\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684\u903b\u8f91\uff1a\\n\\n```java\\n// \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\nBaseDataCache.getInstance().cacheSelectData(selectorData);\\n// \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    \\nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n```\\n\\n\u4e00\u662f\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u7684\u5185\u5b58\u4e2d\u3002`BaseDataCache`\u662f\u6700\u7ec8\u7f13\u5b58\u6570\u636e\u7684\u7c7b\uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\u3002\u9009\u62e9\u5668\u6570\u636e\u5c31\u5b58\u5230\u4e86`SELECTOR_MAP`\u8fd9\u4e2a`Map`\u4e2d\u3002\u5728\u540e\u7eed\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e5f\u662f\u4ece\u8fd9\u91cc\u62ff\u6570\u636e\u3002\\n\\n```java\\npublic final class BaseDataCache {\\n    // \u79c1\u6709\u53d8\u91cf\\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\\n  \\t// \u79c1\u6709\u6784\u9020\u5668\\n    private BaseDataCache() {\\n    }\\n    \\n    /**\\n     * Gets instance.\\n     *  \u516c\u5f00\u65b9\u6cd5\\n     * @return the instance\\n     */\\n    public static BaseDataCache getInstance() {\\n        return INSTANCE;\\n    }\\n    \\n    /**\\n    *  \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684Map\\n     * pluginName -> SelectorData.\\n     */\\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\\n    \\n    public void cacheSelectData(final SelectorData selectorData) {\\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\\n    }\\n        \\n   /**\\n     * cache selector data.\\n     * \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\\n     * @param data the selector data\\n     */\\n    private void selectorAccept(final SelectorData data) {\\n        String key = data.getPluginName();\\n        if (SELECTOR_MAP.containsKey(key)) { // \u66f4\u65b0\u64cd\u4f5c\uff0c\u5148\u5220\u9664\u518d\u63d2\u5165\\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\\n            resultList.add(data);\\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\\n            SELECTOR_MAP.put(key, collect);\\n        } else {  // \u65b0\u589e\u64cd\u4f5c\uff0c\u76f4\u63a5\u653e\u5230Map\u4e2d\\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\\n        }\\n    }\\n    \\n}\\n```\\n\\n\u4e8c\u662f\u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\u3002  \u901a\u8fc7`idea`\u7f16\u8f91\u5668\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u540e\uff0c\u6709\u5982\u4e0b\u7684\u63d2\u4ef6\u8fd8\u6709\u5904\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u5c55\u5f00\u4e86\u3002\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/handler-selector.png)\\n\\n\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u6e90\u7801\u8ffd\u8e2a\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\uff0c\u5728`admin`\u7aef\u65b0\u589e\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u5c31\u5c06`nacos`\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5206\u6790\u6e05\u695a\u4e86\u3002\\n\\n\u6211\u4eec\u8fd8\u662f\u901a\u8fc7\u65f6\u5e8f\u56fe\u5c06\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u6d41\u7a0b\u4e32\u8054\u4e00\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-nacos-data-sync/nacos-sync-sequence-gateway-zh.png)\\n\\n\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5df2\u7ecf\u5206\u6790\u5b8c\u4e86\uff0c\u4e3a\u4e86\u4e0d\u8ba9\u540c\u6b65\u6d41\u7a0b\u88ab\u6253\u65ad\uff0c\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\u5c31\u5ffd\u7565\u4e86\u5176\u4ed6\u903b\u8f91\u3002\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\u7684\u6d41\u7a0b\u5728`NacosSyncDataService`\u7684`start`\u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u5728\u4e0a\u6587\u5206\u6790`\u7f51\u5173\u6570\u636e\u540c\u6b65`\u65f6\u5206\u6790\u8fc7\u4e86\uff0c\u4e0b\u9762\u5206\u6790`Admin`\u7684\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\u3002\\n\\n### 4. Admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\\n\\n`admin`\u7aef\uff0c`NacosDataInit`\u7c7b\u578b\u7684bean\uff0c\u5728`NacosListener`\u4e2d\u8fdb\u884c\u5b9a\u4e49\u548c\u751f\u6210\uff0c\u5982\u679c`admin`\u7684\u914d\u7f6e\u4e2d\u6307\u5b9a\u4e86\u4f7f\u7528`nacos`\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u5f53`admin`\u542f\u52a8\u540e\uff0c\u4f1a\u5c06\u5f53\u524d\u7684\u6570\u636e\u4fe1\u606f\u5168\u91cf\u540c\u6b65\u5230`nacos`\u4e2d\uff0c\u5b9e\u73b0\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n```java\\n\\n/**\\n * The type Nacos data init.\\n */\\npublic class NacosDataInit implements CommandLineRunner {\\n\\n    private static final Logger LOG = LoggerFactory.getLogger(NacosDataInit.class);\\n\\n    private final ConfigService configService;\\n\\n    private final SyncDataService syncDataService;\\n\\n    /**\\n     * Instantiates a new Nacos data init.\\n     * @param configService the nacos config service\\n     * @param syncDataService the sync data service\\n     */\\n    public NacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {\\n        this.configService = configService;\\n        this.syncDataService = syncDataService;\\n    }\\n\\n    @Override\\n    public void run(final String... args) {\\n        String pluginDataId = NacosPathConstants.PLUGIN_DATA_ID;\\n        String authDataId = NacosPathConstants.AUTH_DATA_ID;\\n        String metaDataId = NacosPathConstants.META_DATA_ID;\\n        if (dataIdNotExist(pluginDataId) && dataIdNotExist(authDataId) && dataIdNotExist(metaDataId)) {\\n            syncDataService.syncAll(DataEventTypeEnum.REFRESH);\\n        }\\n    }\\n\\n    private boolean dataIdNotExist(final String pluginDataId) {\\n        try {\\n            String group = NacosPathConstants.GROUP;\\n            long timeout = NacosPathConstants.DEFAULT_TIME_OUT;\\n            return configService.getConfig(pluginDataId, group, timeout) == null;\\n        } catch (NacosException e) {\\n            LOG.error(\\"Get data from nacos error.\\", e);\\n            throw new ShenyuException(e.getMessage());\\n        }\\n    }\\n}\\n\\n```\\n\\n\u5224\u65ad`nacos`\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u884c\u540c\u6b65\u3002\\n\\n`NacosDataInit`\u5b9e\u73b0\u4e86`CommandLineRunner`\u63a5\u53e3\u3002\u5b83\u662f`springboot`\u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u4f1a\u5728\u6240\u6709 `Spring Beans`\u521d\u59cb\u5316\u4e4b\u540e\u6267\u884c`run()`\u65b9\u6cd5\uff0c\u5e38\u7528\u4e8e\u9879\u76ee\u4e2d\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002\\n\\n- SyncDataService.syncAll()\\n\\n\u4ece\u6570\u636e\u5e93\u67e5\u8be2\u6570\u636e\uff0c\u7136\u540e\u8fdb\u884c\u5168\u91cf\u6570\u636e\u540c\u6b65\uff0c\u6240\u6709\u7684\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002\u4e3b\u8981\u662f\u901a\u8fc7`eventPublisher`\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u3002\u8fd9\u91cc\u5c31\u8ddf\u524d\u9762\u63d0\u5230\u7684\u540c\u6b65\u903b\u8f91\u5c31\u53c8\u8054\u7cfb\u8d77\u6765\u4e86\uff0c`eventPublisher`\u901a\u8fc7`publishEvent()`\u53d1\u5e03\u5b8c\u4e8b\u4ef6\u540e\uff0c\u6709`ApplicationListener`\u6267\u884c\u4e8b\u4ef6\u53d8\u66f4\u64cd\u4f5c\uff0c\u5728`ShenYu`\u4e2d\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684`DataChangedEventDispatcher`\u3002\\n\\n```java\\n@Service\\npublic class SyncDataServiceImpl implements SyncDataService {\\n    // \u4e8b\u4ef6\u53d1\u5e03\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n     /***\\n     * \u5168\u91cf\u6570\u636e\u540c\u6b65\\n     * @param type the type\\n     * @return\\n     */\\n    @Override\\n    public boolean syncAll(final DataEventTypeEnum type) {\\n        // \u540c\u6b65\u8ba4\u8bc1\u4fe1\u606f\\n        appAuthService.syncData();\\n        // \u540c\u6b65\u63d2\u4ef6\u4fe1\u606f\\n        List<PluginData> pluginDataList = pluginService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));\\n        // \u540c\u6b65\u9009\u62e9\u5668\u4fe1\u606f\\n        List<SelectorData> selectorDataList = selectorService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));\\n        // \u540c\u6b65\u89c4\u5219\u4fe1\u606f\\n        List<RuleData> ruleDataList = ruleService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));\\n        // \u540c\u6b65\u5143\u6570\u636e\u4fe1\u606f\\n        metaDataService.syncData();\\n        return true;\\n    }\\n    \\n}\\n```\\n\\n\\n### 5. \u603b\u7ed3\\n\\n\u672c\u6587\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\uff0c\u5bf9`nacos`\u7684\u6570\u636e\u540c\u6b65\u539f\u7406\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a\\n\\n- \u57fa\u4e8e`nacos`\u7684\u6570\u636e\u540c\u6b65\uff0c\u4e3b\u8981\u662f\u901a\u8fc7`watch`\u673a\u5236\u5b9e\u73b0\uff1b\\n- \u901a\u8fc7`Spring`\u5b8c\u6210\u4e8b\u4ef6\u53d1\u5e03\u548c\u76d1\u542c\uff1b\\n- \u901a\u8fc7\u62bd\u8c61`DataChangedListener`\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u540c\u6b65\u7b56\u7565\uff0c\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff1b\\n- \u4f7f\u7528\u5355\u4f8b\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0\u7f13\u5b58\u6570\u636e\u7c7b`BaseDataCache`\uff1b\\n- \u901a\u8fc7`SpringBoot`\u7684\u6761\u4ef6\u88c5\u914d\u548c`starter`\u52a0\u8f7d\u673a\u5236\u5b9e\u73b0\u914d\u7f6e\u7c7b\u7684\u52a0\u8f7d\u3002"},{"id":"/DataSync-SourceCode-Analysis-WebSocket-Data-Sync","metadata":{"permalink":"/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync.md","title":"WebSocket\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","description":"\u5728ShenYu\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002Apache ShenYu \u7f51\u5173\u5f53\u524d\u652f\u6301ZooKeeper\u3001WebSocket\u3001Http\u957f\u8f6e\u8be2\u3001Nacos \u3001etcd \u548c Consul \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8eWebSocket\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"websocket","permalink":"/zh/blog/tags/websocket"},{"label":"data sync","permalink":"/zh/blog/tags/data-sync"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":29.18,"hasTruncateMarker":false,"authors":[{"name":"midnight2104","title":"Apache ShenYu Committer","url":"https://github.com/midnight2104"}],"frontMatter":{"title":"WebSocket\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","author":"midnight2104","author_title":"Apache ShenYu Committer","author_url":"https://github.com/midnight2104","tags":["websocket","data sync","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Nacos\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync"},"nextItem":{"title":"ZooKeeper\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync"}},"content":"\u5728`ShenYu`\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002`Apache ShenYu` \u7f51\u5173\u5f53\u524d\u652f\u6301`ZooKeeper`\u3001`WebSocket`\u3001`Http\u957f\u8f6e\u8be2`\u3001`Nacos` \u3001`etcd` \u548c `Consul` \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e`WebSocket`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.4.0`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [\u6570\u636e\u540c\u6b65\u539f\u7406](https://shenyu.apache.org/zh/docs/design/data-sync) \u3002\\n\\n\\n### 1. \u5173\u4e8eWebSocket\u901a\u4fe1\\n\\n`WebSocket`\u534f\u8bae\u8bde\u751f\u4e8e`2008`\u5e74\uff0c\u5728`2011`\u5e74\u6210\u4e3a\u56fd\u9645\u6807\u51c6\u3002\u5b83\u53ef\u4ee5\u53cc\u5411\u901a\u4fe1\uff0c\u670d\u52a1\u5668\u53ef\u4ee5\u4e3b\u52a8\u5411\u5ba2\u6237\u7aef\u63a8\u9001\u4fe1\u606f\uff0c\u5ba2\u6237\u7aef\u4e5f\u53ef\u4ee5\u4e3b\u52a8\u5411\u670d\u52a1\u5668\u53d1\u9001\u4fe1\u606f\u3002`WebSocket`\u534f\u8bae\u5efa\u7acb\u5728 `TCP` \u534f\u8bae\u4e4b\u4e0a\uff0c\u5c5e\u4e8e\u5e94\u7528\u5c42\uff0c\u6027\u80fd\u5f00\u9500\u5c0f\uff0c\u901a\u4fe1\u9ad8\u6548\uff0c\u534f\u8bae\u6807\u8bc6\u7b26\u662f`ws`\u3002\\n\\n\\n### 2. Admin\u6570\u636e\u540c\u6b65\\n\\n\u6211\u4eec\u4ece\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\u8fdb\u884c\u6e90\u7801\u8ffd\u8e2a\uff0c\u6bd4\u5982\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff1a\\n\\n![](/img/activities/code-analysis-websocket-data-sync/add-selector.png)\\n\\n#### 2.1 \u63a5\u6536\u6570\u636e\\n\\n- SelectorController.createSelector()\\n\\n\u8fdb\u5165`SelectorController`\u7c7b\u4e2d\u7684`createSelector()`\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002\\n\\n```java\\n@Validated\\n@RequiredArgsConstructor\\n@RestController\\n@RequestMapping(\\"/selector\\")\\npublic class SelectorController {\\n    \\n    @PostMapping(\\"\\")\\n    public ShenyuAdminResult createSelector(@Valid @RequestBody final SelectorDTO selectorDTO) { // @Valid \u6570\u6821\u9a8c\\n        // \u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\\n        Integer createCount = selectorService.createOrUpdate(selectorDTO);\\n        // \u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\\n        return ShenyuAdminResult.success(ShenyuResultMessage.CREATE_SUCCESS, createCount);\\n    }\\n    \\n    // ......\\n}\\n```\\n\\n\\n\\n#### 2.2 \u5904\u7406\u6570\u636e\\n\\n- SelectorServiceImpl.createOrUpdate()\\n\\n\u5728`SelectorServiceImpl`\u7c7b\u4e2d\u901a\u8fc7`createOrUpdate()`\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u66f4\u65b0`upstream`\u3002\\n\\n```java\\n@RequiredArgsConstructor\\n@Service\\npublic class SelectorServiceImpl implements SelectorService {\\n    // \u8d1f\u8d23\u4e8b\u4ef6\u53d1\u5e03\u7684eventPublisher\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n    @Override\\n    @Transactional(rollbackFor = Exception.class)\\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\\n        int selectorCount;\\n        // \u6784\u5efa\u6570\u636e DTO --\x3e DO\\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\\n        // \u5224\u65ad\u662f\u6dfb\u52a0\u8fd8\u662f\u66f4\u65b0\\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\\n            // \u63d2\u5165\u9009\u62e9\u5668\u6570\u636e\\n            selectorCount = selectorMapper.insertSelective(selectorDO);\\n            // \u63d2\u5165\u9009\u62e9\u5668\u4e2d\u7684\u6761\u4ef6\u6570\u636e\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\\n            });\\n            // check selector add\\n            // \u6743\u9650\u68c0\u67e5\\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\\n                dataPermissionDTO.setDataId(selectorDO.getId());\\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\\n            }\\n\\n        } else {\\n            // \u66f4\u65b0\u6570\u636e\uff0c\u5148\u5220\u9664\u518d\u65b0\u589e\\n            selectorCount = selectorMapper.updateSelective(selectorDO);\\n            //delete rule condition then add\\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\\n                selectorConditionMapper.insertSelective(selectorConditionDO);\\n            });\\n        }\\n        // \u53d1\u5e03\u4e8b\u4ef6\\n        publishEvent(selectorDO, selectorConditionDTOs);\\n\\n        // \u66f4\u65b0upstream\\n        updateDivideUpstream(selectorDO);\\n        return selectorCount;\\n    }\\n    \\n    \\n    // ......\\n    \\n}\\n\\n```\\n\\n\u5728`Service`\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u5927\u5bb6\u5e94\u8be5\u5f88\u719f\u6089\u4e86\uff0c\u5c31\u4e0d\u5c55\u5f00\u3002\u5173\u4e8e\u66f4\u65b0`upstream`\u64cd\u4f5c\uff0c\u653e\u5230\u540e\u9762\u5bf9\u5e94\u7684\u7ae0\u8282\u4e2d\u8fdb\u884c\u5206\u6790\uff0c\u91cd\u70b9\u5173\u6ce8\u53d1\u5e03\u4e8b\u4ef6\u7684\u64cd\u4f5c\uff0c\u5b83\u4f1a\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n\\n\\n`publishEvent()`\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u6784\u5efa\u6761\u4ef6\u6570\u636e\uff0c\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u3002\\n\\n```java\\n       private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\\n        // \u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\\n        // \u6784\u5efa\u6761\u4ef6\u6570\u636e\\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\\n        // \u53d1\u5e03\u53d8\u66f4\u6570\u636e\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\\n    }\\n```\\n\\n\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7`eventPublisher.publishEvent()`\u5b8c\u6210\uff0c\u8fd9\u4e2a`eventPublisher`\u5bf9\u8c61\u662f\u4e00\u4e2a`ApplicationEventPublisher`\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f`org.springframework.context.ApplicationEventPublisher`\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7`Spring`\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002\\n\\n> \u5173\u4e8e`ApplicationEventPublisher`\uff1a\\n>\\n> \u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 `ApplicationEventPublisher` \u7684 `publishEvent` \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c`Spring`\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 `onApplicationEvent` \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 `publishEvent`\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 `ApplicationEventPublisher` \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002\\n>\\n> - `ApplicationEventPublisher`\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b\\n> - `ApplicationEvent`\uff1a`Spring` \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b\\n> - `ApplicationListener`\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\u3002\\n\\n\u5728`Spring`\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c\\n\\n\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684`ApplicationEventPublisher`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a`eventPublisher`\u3002\\n\\n\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f`ApplicationEvent`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEvent`\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\npublic class DataChangedEvent extends ApplicationEvent {\\n//......\\n}\\n```\\n\\n\u6700\u540e\u4e00\u4e2a\u662f `ApplicationListener`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEventDispatcher`\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n    //......\\n    \\n}\\n```\\n\\n\\n\\n#### 2.3 \u5206\u53d1\u6570\u636e\\n\\n- DataChangedEventDispatcher.onApplicationEvent()\\n\\n\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230`DataChangedEventDispatcher`\u7c7b\u4e2d\u7684`onApplicationEvent()`\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n  /**\\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\\n     * @param event\\n     */\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\\n                    break;\\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\\n                    break;\\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\\n                    break;\\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\\n                    break;\\n                case META_DATA:  // \u5143\u6570\u636e\\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\\n                    break;\\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\\n                    throw new IllegalStateException(\\"Unexpected value: \\" + event.getGroupKey());\\n            }\\n        }\\n    }\\n    \\n}\\n```\\n\\n\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528`onApplicationEvent`\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002\\n\\n`ShenYu`\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u662f\u4e94\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u548c\u5143\u6570\u636e\u3002\\n\\n\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08`DataChangedListener`\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u5b83\u7684\u5177\u4f53\u5b9e\u73b0\u6709\uff1a\\n\\n![](/img/activities/code-analysis-websocket-data-sync/data-changed-listener.png)\\n\\n\u8fd9\u51e0\u4e2a\u5b9e\u73b0\u7c7b\u5c31\u662f\u5f53\u524d`ShenYu`\u652f\u6301\u7684\u540c\u6b65\u7b56\u7565\uff1a\\n\\n- `WebsocketDataChangedListener`\uff1a\u57fa\u4e8e`websocket`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ZookeeperDataChangedListener`\uff1a\u57fa\u4e8e`zookeeper`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ConsulDataChangedListener`\uff1a\u57fa\u4e8e`consul`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `EtcdDataDataChangedListener`\uff1a\u57fa\u4e8e`etcd`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `HttpLongPollingDataChangedListener`\uff1a\u57fa\u4e8e`http\u957f\u8f6e\u8be2`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `NacosDataChangedListener`\uff1a\u57fa\u4e8e`nacos`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n\\n\u65e2\u7136\u6709\u8fd9\u4e48\u591a\u79cd\u5b9e\u73b0\u7b56\u7565\uff0c\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u5462\uff1f\\n\\n\u56e0\u4e3a\u672c\u6587\u662f\u57fa\u4e8e`websocket`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ee5`WebsocketDataChangedListener`\u4e3a\u4f8b\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u88ab\u52a0\u8f7d\u5e76\u5b9e\u73b0\u7684\u3002\\n\\n\u901a\u8fc7\u5728\u6e90\u7801\u5de5\u7a0b\u4e2d\u8fdb\u884c\u5168\u5c40\u641c\u7d22\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u7684\u5b9e\u73b0\u662f\u5728`DataSyncConfiguration`\u7c7b\u5b8c\u6210\u7684\u3002\\n\\n```java\\n/**\\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\\n * The type Data sync configuration.\\n */\\n@Configuration\\npublic class DataSyncConfiguration {\\n    \\n /**\\n     * websocket\u6570\u636e\u540c\u6b65\uff08\u9ed8\u8ba4\u7b56\u7565\uff09\\n     * The WebsocketListener(default strategy).\\n     */\\n    @Configuration\\n    @ConditionalOnProperty(name = \\"shenyu.sync.websocket.enabled\\", havingValue = \\"true\\", matchIfMissing = true)\\n    @EnableConfigurationProperties(WebsocketSyncProperties.class)\\n    static class WebsocketListener {\\n\\n        /**\\n         * Config event listener data changed listener.\\n         * \u914d\u7f6ewebsocket\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\n         * @return the data changed listener\\n         */\\n        @Bean\\n        @ConditionalOnMissingBean(WebsocketDataChangedListener.class)\\n        public DataChangedListener websocketDataChangedListener() {\\n            return new WebsocketDataChangedListener();\\n        }\\n\\n        /**\\n         * Websocket collector.\\n         * Websocket\u5904\u7406\u7c7b\uff1a\u5efa\u7acb\u8fde\u63a5\uff0c\u53d1\u9001\u6d88\u606f\uff0c\u5173\u95ed\u8fde\u63a5\u7b49\u64cd\u4f5c\\n         * @return the websocket collector\\n         */\\n        @Bean\\n        @ConditionalOnMissingBean(WebsocketCollector.class)\\n        public WebsocketCollector websocketCollector() {\\n            return new WebsocketCollector();\\n        }\\n\\n        /**\\n         * Server endpoint exporter \\n         *\\n         * @return the server endpoint exporter\\n         */\\n        @Bean\\n        @ConditionalOnMissingBean(ServerEndpointExporter.class)\\n        public ServerEndpointExporter serverEndpointExporter() {\\n            return new ServerEndpointExporter();\\n        }\\n    }\\n    \\n    //......\\n}\\n\\n```\\n\\n\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u662f\u901a\u8fc7`SpringBoot`\u6761\u4ef6\u88c5\u914d\u7c7b\u5b9e\u73b0\u7684\u3002\u5728`WebsocketListener`\u7c7b\u4e0a\u9762\u6709\u51e0\u4e2a\u6ce8\u89e3\uff1a\\n\\n- `@Configuration`\uff1a\u914d\u7f6e\u6587\u4ef6\uff0c\u5e94\u7528\u4e0a\u4e0b\u6587\uff1b\\n\\n- `@ConditionalOnProperty(name = \\"shenyu.sync.websocket.enabled\\", havingValue = \\"true\\", matchIfMissing = true)`\uff1a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u91c7\u7528`websocket`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u4e0d\u8fc7\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e0b`matchIfMissing = true`\u8fd9\u4e2a\u5c5e\u6027\uff0c\u5b83\u8868\u793a\uff0c\u5982\u679c\u4f60\u6ca1\u6709\u5982\u4e0b\u7684\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u7c7b\u4e5f\u4f1a\u751f\u6548\u3002\u57fa\u4e8e`websocket`\u7684\u6570\u636e\u540c\u6b65\u65f6\u5b98\u65b9\u63a8\u8350\u7684\u65b9\u5f0f\uff0c\u4e5f\u662f\u9ed8\u8ba4\u91c7\u7528\u7684\u65b9\u5f0f\u3002\\n\\n  ```properties\\n  shenyu:  \\n    sync:\\n      websocket:\\n        enabled: true\\n  ```\\n\\n- `@EnableConfigurationProperties`\uff1a\u542f\u7528\u914d\u7f6e\u5c5e\u6027\uff1b\\n\\n\\n\\n\u5f53\u6211\u4eec\u4e3b\u52a8\u914d\u7f6e\uff0c\u91c7\u7528`websocket`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u65f6\uff0c`WebsocketDataChangedListener`\u5c31\u4f1a\u751f\u6210\u3002\u6240\u4ee5\u5728\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5`onApplicationEvent()`\u4e2d\uff0c\u5c31\u4f1a\u5230\u76f8\u5e94\u7684`listener`\u4e2d\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u662f\u65b0\u589e\u52a0\u4e86\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u6570\u636e\u901a\u8fc7\u91c7\u7528\u7684\u662f`websocket`\uff0c\u6240\u4ee5\uff0c\u4ee3\u7801\u4f1a\u8fdb\u5165\u5230`WebsocketDataChangedListener`\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\u3002\\n\\n```java\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                    \\n                // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n                    \\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // WebsocketDataChangedListener\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\\n                    break;\\n         }\\n    }\\n```\\n\\n\\n#### 2.4 Websocket\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\n\\n- WebsocketDataChangedListener.onSelectorChanged()\\n\\n  \u5728`onSelectorChanged()`\u65b9\u6cd5\u4e2d\uff0c\u5c06\u6570\u636e\u8fdb\u884c\u4e86\u5c01\u88c5\uff0c\u8f6c\u6210`WebsocketData`\uff0c\u7136\u540e\u901a\u8fc7`WebsocketCollector.send()`\u53d1\u9001\u6570\u636e\u3002\\n\\n```java\\n    // \u9009\u62e9\u5668\u6570\u636e\u6709\u66f4\u65b0\\n    @Override\\n    public void onSelectorChanged(final List<SelectorData> selectorDataList, final DataEventTypeEnum eventType) {\\n        // \u6784\u9020 WebsocketData \u6570\u636e\\n        WebsocketData<SelectorData> websocketData =\\n                new WebsocketData<>(ConfigGroupEnum.SELECTOR.name(), eventType.name(), selectorDataList);\\n        // \u901a\u8fc7websocket\u53d1\u9001\u6570\u636e\\n        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);\\n    }\\n```\\n\\n\\n#### 2.5 Websocket\u53d1\u9001\u6570\u636e\\n\\n- WebsocketCollector.send()\\n\\n\u5728`send()`\u65b9\u6cd5\u4e2d\uff0c\u5224\u65ad\u4e86\u4e00\u4e0b\u540c\u6b65\u7684\u7c7b\u578b\uff0c\u6839\u636e\u4e0d\u540c\u7684\u7c7b\u578b\uff0c\u8fdb\u884c\u5904\u7406\u3002\\n\\n```java\\n@Slf4j\\n@ServerEndpoint(value = \\"/websocket\\", configurator = WebsocketConfigurator.class)\\npublic class WebsocketCollector {\\n    \\n/**\\n     * Send.\\n     *\\n     * @param message the message\\n     * @param type    the type\\n     */\\n    public static void send(final String message, final DataEventTypeEnum type) {\\n        if (StringUtils.isNotBlank(message)) {\\n            // \u5982\u679c\u662fMYSELF\uff08\u7b2c\u4e00\u6b21\u7684\u5168\u91cf\u540c\u6b65\uff09\\n            if (DataEventTypeEnum.MYSELF == type) {\\n                // \u4ecethreadlocal\u4e2d\u83b7\u53d6session\\n                Session session = (Session) ThreadLocalUtil.get(SESSION_KEY);\\n                if (session != null) {\\n                    // \u5411\u8be5session\u53d1\u9001\u5168\u91cf\u6570\u636e\\n                    sendMessageBySession(session, message);\\n                }\\n            } else {\\n                // \u540e\u7eed\u7684\u589e\u91cf\u540c\u6b65\\n                // \u5411\u6240\u6709\u7684session\u4e2d\u540c\u6b65\u53d8\u66f4\u6570\u636e\\n                SESSION_SET.forEach(session -> sendMessageBySession(session, message));\\n            }\\n        }\\n    }\\n\\n    private static void sendMessageBySession(final Session session, final String message) {\\n        try {\\n            // \u901a\u8fc7websocket\u7684session\u628a\u6d88\u606f\u53d1\u9001\u51fa\u53bb\\n            session.getBasicRemote().sendText(message);\\n        } catch (IOException e) {\\n            log.error(\\"websocket send result is exception: \\", e);\\n        }\\n    }\\n}\\n```\\n\\n\\n\\n\u6211\u4eec\u7ed9\u7684\u6848\u4f8b\u662f\u4e00\u4e2a\u65b0\u589e\u64cd\u4f5c \uff0c\u662f\u4e00\u4e2a\u589e\u91cf\u540c\u6b65\uff0c\u6240\u4ee5\u4f1a\u8d70\\n\\n`SESSION_SET.forEach(session -> sendMessageBySession(session, message));`\\n\\n\u8fd9\u4e2a\u903b\u8f91\u3002\\n\\n\u518d\u901a\u8fc7\\n\\n`session.getBasicRemote().sendText(message);`\\n\\n\u5c06\u6570\u636e\u53d1\u9001\u4e86\u51fa\u53bb\u3002\\n\\n\\n\\n\u81f3\u6b64\uff0c\u5f53`admin`\u7aef\u53d1\u751f\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u5c31\u5c06\u53d8\u66f4\u7684\u6570\u636e\u4ee5\u589e\u91cf\u5f62\u5f0f\u901a\u8fc7`WebSocket`\u53d1\u7ed9\u4e86\u7f51\u5173\u3002\\n\\n\u5206\u6790\u5230\u8fd9\u91cc\uff0c\u4e0d\u77e5\u9053\u5927\u5bb6\u6709\u6ca1\u6709\u7591\u95ee\u5462\uff1f\u6bd4\u5982`session`\u662f\u600e\u4e48\u6765\u7684\uff1f\u7f51\u5173\u5982\u4f55\u548c`admin`\u5efa\u7acb\u8fde\u63a5\u7684\uff1f\\n\\n\u4e0d\u8981\u7740\u6025\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u5c31\u8fdb\u884c\u7f51\u5173\u7aef\u7684\u540c\u6b65\u5206\u6790\u3002\\n\\n\u4e0d\u8fc7\uff0c\u5728\u7ee7\u7eed\u6e90\u7801\u5206\u6790\u524d\uff0c\u6211\u4eec\u7528\u4e00\u5f20\u56fe\u5c06\u4e0a\u9762\u7684\u5206\u6790\u8fc7\u7a0b\u4e32\u8054\u8d77\u6765\u3002\\n\\n![](/img/activities/code-analysis-websocket-data-sync/websocket-data-sync-admin.png)\\n\\n\\n\\n### 3. \u7f51\u5173\u6570\u636e\u540c\u6b65\\n\\n\u5047\u8bbe`ShenYu`\u7f51\u5173\u5df2\u7ecf\u5728\u6b63\u5e38\u8fd0\u884c\u4e86\uff0c\u4f7f\u7528\u7684\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e5f\u662f`websocket`\u3002\u90a3\u4e48\u5f53\u5728`admin`\u7aef\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u540e\uff0c\u5e76\u4e14\u901a\u8fc7`WebSocket`\u53d1\u9001\u5230\u7f51\u5173\uff0c\u90a3\u7f51\u5173\u662f\u5982\u4f55\u63a5\u6536\u5e76\u5904\u7406\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7ee7\u7eed\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u4e00\u63a2\u7a76\u7adf\u3002\\n\\n#### 3.1 WebsocketClient\u63a5\u6536\u6570\u636e\\n\\n- ShenyuWebsocketClient.onMessage()\\n\\n\u5728\u7f51\u5173\u7aef\u6709\u4e00\u4e2a`ShenyuWebsocketClient`\u7c7b\uff0c\u5b83\u7ee7\u627f\u4e86`WebSocketClient`\uff0c\u53ef\u4ee5\u548c`WebSocket`\u5efa\u7acb\u8fde\u63a5\u5e76\u901a\u4fe1\u3002\\n\\n```java\\npublic final class ShenyuWebsocketClient extends WebSocketClient {\\n  // ......\\n}\\n```\\n\\n\u5f53\u5728`admin`\u7aef\u901a\u8fc7`websocket`\u53d1\u9001\u6570\u636e\u540e\uff0c`ShenyuWebsocketClient`\u5c31\u53ef\u4ee5\u901a\u8fc7`onMessage()`\u63a5\u6536\u5230\u6570\u636e\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u81ea\u5df1\u8fdb\u884c\u5904\u7406\u3002\\n\\n```java\\npublic final class ShenyuWebsocketClient extends WebSocketClient {\\n      // \u63a5\u53d7\u5230\u6d88\u606f\u540e\u6267\u884c\\n    @Override\\n    public void onMessage(final String result) {\\n        // \u5904\u7406\u63a5\u6536\u5230\u7684\u6570\u636e\\n        handleResult(result);\\n    }\\n    \\n    private void handleResult(final String result) {\\n        // \u6570\u636e\u53cd\u5e8f\u5217\u5316\\n        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);\\n        // \u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219...\\n        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());\\n        // \u54ea\u79cd\u64cd\u4f5c\u7c7b\u578b\uff0c\u66f4\u65b0\u3001\u5220\u9664...\\n        String eventType = websocketData.getEventType();\\n        String json = GsonUtils.getInstance().toJson(websocketData.getData());\\n\\n        // \u5904\u7406\u6570\u636e\\n        websocketDataHandler.executor(groupEnum, json, eventType);\\n    }\\n}\\n```\\n\\n\\n\\n\u63a5\u6536\u5230\u6570\u636e\u540e\uff0c\u9996\u5148\u8fdb\u884c\u4e86\u53cd\u5e8f\u5217\u5316\u64cd\u4f5c\uff0c\u8bfb\u53d6\u6570\u636e\u7c7b\u578b\u548c\u64cd\u4f5c\u7c7b\u578b\uff0c\u7d27\u63a5\u7740\uff0c\u5c31\u4ea4\u7ed9`websocketDataHandler.executor()`\u8fdb\u884c\u5904\u7406\u3002\\n\\n#### 3.2 \u6267\u884cWebsocket\u4e8b\u4ef6\u5904\u7406\u5668\\n\\n- WebsocketDataHandler.executor()\\n\\n\u901a\u8fc7\u5de5\u5382\u6a21\u5f0f\u521b\u5efa\u4e86`Websocket`\u6570\u636e\u5904\u7406\u5668\uff0c\u6bcf\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u90fd\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5904\u7406\u5668\uff1a\\n\\n> \u63d2\u4ef6 --\x3e \u63d2\u4ef6\u6570\u636e\u5904\u7406\u5668;\\n>\\n> \u9009\u62e9\u5668 --\x3e \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\uff1b\\n>\\n> \u89c4\u5219 --\x3e \u89c4\u5219\u6570\u636e\u5904\u7406\u5668\uff1b\\n>\\n> \u8ba4\u8bc1\u4fe1\u606f --\x3e \u8ba4\u8bc1\u6570\u636e\u5904\u7406\u5668\uff1b\\n>\\n> \u5143\u6570\u636e --\x3e \u5143\u6570\u636e\u5904\u7406\u5668\u3002\\n\\n```java\\n\\n/**\\n * \u901a\u8fc7\u5de5\u5382\u6a21\u5f0f\u521b\u5efa Websocket\u6570\u636e\u5904\u7406\u5668\\n * The type Websocket cache handler.\\n */\\npublic class WebsocketDataHandler {\\n\\n    private static final EnumMap<ConfigGroupEnum, DataHandler> ENUM_MAP = new EnumMap<>(ConfigGroupEnum.class);\\n\\n    /**\\n     * Instantiates a new Websocket data handler.\\n     * \u6bcf\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u63d0\u4f9b\u4e00\u4e2a\u5904\u7406\u5668\\n     * @param pluginDataSubscriber the plugin data subscriber\\n     * @param metaDataSubscribers  the meta data subscribers\\n     * @param authDataSubscribers  the auth data subscribers\\n     */\\n    public WebsocketDataHandler(final PluginDataSubscriber pluginDataSubscriber,\\n                                final List<MetaDataSubscriber> metaDataSubscribers,\\n                                final List<AuthDataSubscriber> authDataSubscribers) {\\n        // \u63d2\u4ef6 --\x3e \u63d2\u4ef6\u6570\u636e\u5904\u7406\u5668\\n        ENUM_MAP.put(ConfigGroupEnum.PLUGIN, new PluginDataHandler(pluginDataSubscriber));\\n        // \u9009\u62e9\u5668 --\x3e \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\\n        ENUM_MAP.put(ConfigGroupEnum.SELECTOR, new SelectorDataHandler(pluginDataSubscriber));\\n        // \u89c4\u5219 --\x3e \u89c4\u5219\u6570\u636e\u5904\u7406\u5668\\n        ENUM_MAP.put(ConfigGroupEnum.RULE, new RuleDataHandler(pluginDataSubscriber));\\n        // \u8ba4\u8bc1\u4fe1\u606f --\x3e \u8ba4\u8bc1\u6570\u636e\u5904\u7406\u5668\\n        ENUM_MAP.put(ConfigGroupEnum.APP_AUTH, new AuthDataHandler(authDataSubscribers));\\n        // \u5143\u6570\u636e --\x3e \u5143\u6570\u636e\u5904\u7406\u5668\\n        ENUM_MAP.put(ConfigGroupEnum.META_DATA, new MetaDataHandler(metaDataSubscribers));\\n    }\\n\\n    /**\\n     * Executor.\\n     *\\n     * @param type      the type\\n     * @param json      the json\\n     * @param eventType the event type\\n     */\\n    public void executor(final ConfigGroupEnum type, final String json, final String eventType) {\\n        // \u6839\u636e\u6570\u636e\u7c7b\u578b\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u6570\u636e\u5904\u7406\u5668\\n        ENUM_MAP.get(type).handle(json, eventType);\\n    }\\n}\\n\\n```\\n\\n\\n\\n\u4e0d\u540c\u7684\u6570\u636e\u7c7b\u578b\uff0c\u6709\u4e0d\u540c\u7684\u6570\u636e\u5904\u7406\u65b9\u5f0f\uff0c\u6240\u4ee5\u6709\u4e0d\u540c\u7684\u5b9e\u73b0\u7c7b\u3002\u4f46\u662f\u5b83\u4eec\u4e4b\u95f4\u4e5f\u6709\u76f8\u540c\u7684\u5904\u7406\u903b\u8f91\uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7\u6a21\u677f\u65b9\u6cd5\u8bbe\u8ba1\u6a21\u5f0f\u6765\u5b9e\u73b0\u3002\u76f8\u540c\u7684\u903b\u8f91\u653e\u5728\u62bd\u8c61\u7c7b\u4e2d\u7684`handle()`\u65b9\u6cd5\u4e2d\uff0c\u4e0d\u540c\u903b\u8f91\u5c31\u4ea4\u7ed9\u5404\u81ea\u7684\u5b9e\u73b0\u7c7b\u3002\\n\\n![](/img/activities/code-analysis-websocket-data-sync/data-handler.png)\\n\\n\\n\\n\u6211\u4eec\u7684\u6848\u4f8b\u662f\u65b0\u589e\u4e86\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u6240\u4ee5\u4f1a\u4ea4\u7ed9`SelectorDataHandler`\uff08 \u9009\u62e9\u5668 --\x3e \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\uff09\u8fdb\u884c\u6570\u636e\u5904\u7406\u3002\\n\\n\\n\\n#### 3.3 \u5224\u65ad\u4e8b\u4ef6\u7c7b\u578b\\n\\n- AbstractDataHandler.handle()\\n\\n\u5b9e\u73b0\u6570\u636e\u53d8\u66f4\u7684\u901a\u7528\u903b\u8f91\u5904\u7406\uff1a\u6839\u636e\u4e0d\u540c\u7684\u64cd\u4f5c\u7c7b\u578b\u8c03\u7528\u4e0d\u540c\u65b9\u6cd5\u3002\\n\\n```java\\n\\npublic abstract class AbstractDataHandler<T> implements DataHandler {\\n\\n    /**\\n     * Convert list.\\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\\n     * @param json the json\\n     * @return the list\\n     */\\n    protected abstract List<T> convert(String json);\\n\\n    /**\\n     * Do refresh.\\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\\n     * @param dataList the data list\\n     */\\n    protected abstract void doRefresh(List<T> dataList);\\n\\n    /**\\n     * Do update.\\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\\n     * @param dataList the data list\\n     */\\n    protected abstract void doUpdate(List<T> dataList);\\n\\n    /**\\n     * Do delete.\\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\\n     * @param dataList the data list\\n     */\\n    protected abstract void doDelete(List<T> dataList);\\n\\n    // \u901a\u7528\u903b\u8f91\uff0c\u62bd\u8c61\u7c7b\u5b9e\u73b0\\n    @Override\\n    public void handle(final String json, final String eventType) {\\n        List<T> dataList = convert(json);\\n        if (CollectionUtils.isNotEmpty(dataList)) {\\n            DataEventTypeEnum eventTypeEnum = DataEventTypeEnum.acquireByName(eventType);\\n            switch (eventTypeEnum) {\\n                case REFRESH:\\n                case MYSELF:\\n                    doRefresh(dataList);  //\u5237\u65b0\u6570\u636e\uff0c\u5168\u91cf\u540c\u6b65\\n                    break;\\n                case UPDATE:\\n                case CREATE:\\n                    doUpdate(dataList); // \u66f4\u65b0\u6216\u521b\u5efa\u6570\u636e\uff0c\u589e\u91cf\u540c\u6b65\\n                    break;\\n                case DELETE:\\n                    doDelete(dataList);  // \u5220\u9664\u6570\u636e\\n                    break;\\n                default:\\n                    break;\\n            }\\n        }\\n    }\\n}\\n```\\n\\n\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u662f\u65b0\u589e\u64cd\u4f5c\uff0c\u901a\u8fc7`switch-case`\u8fdb\u5165\u5230`doUpdate()`\u65b9\u6cd5\u4e2d\u3002\\n\\n#### 3.4 \u8fdb\u5165\u5177\u4f53\u7684\u6570\u636e\u5904\u7406\u5668\\n\\n- SelectorDataHandler.doUpdate()\\n\\n```java\\n\\n/**\\n * \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\\n * The type Selector data handler.\\n */\\n@RequiredArgsConstructor\\npublic class SelectorDataHandler extends AbstractDataHandler<SelectorData> {\\n\\n    private final PluginDataSubscriber pluginDataSubscriber;\\n\\n    //......\\n\\n    // \u66f4\u65b0\u64cd\u4f5c\\n    @Override\\n    protected void doUpdate(final List<SelectorData> dataList) {\\n        dataList.forEach(pluginDataSubscriber::onSelectorSubscribe);\\n    }\\n}\\n```\\n\\n\u904d\u5386\u6570\u636e\uff0c\u8fdb\u5165`onSelectorSubscribe()`\u65b9\u6cd5\u3002\\n\\n- PluginDataSubscriber.onSelectorSubscribe()\\n\\n\u5b83\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528`subscribeDataHandler()`\u65b9\u6cd5\u3002\u5728\u65b9\u6cd5\u4e2d\uff0c\u66f4\u5177\u6570\u636e\u7c7b\u578b\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u6216\u89c4\u5219\uff09\uff0c\u64cd\u4f5c\u7c7b\u578b\uff08\u66f4\u65b0\u6216\u5220\u9664\uff09\uff0c\u53bb\u6267\u884c\u4e0d\u540c\u903b\u8f91\u3002\\n\\n```java\\n/**\\n * \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\\n * The type Common plugin data subscriber.\\n */\\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\\n    //......\\n     // \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\\n    @Override\\n    public void onSelectorSubscribe(final SelectorData selectorData) {\\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\\n    }    \\n    \\n    // \u8ba2\u9605\u6570\u636e\u5904\u7406\u5668\uff0c\u5904\u7406\u6570\u636e\u7684\u66f4\u65b0\u6216\u5220\u9664\\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\\n        Optional.ofNullable(classData).ifPresent(data -> {\\n            // \u63d2\u4ef6\u6570\u636e\\n            if (data instanceof PluginData) {\\n                PluginData pluginData = (PluginData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cachePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\\n                }\\n            } else if (data instanceof SelectorData) {  // \u9009\u62e9\u5668\u6570\u636e\\n                SelectorData selectorData = (SelectorData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406 \\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\\n                }\\n            } else if (data instanceof RuleData) {  // \u89c4\u5219\u6570\u636e\\n                RuleData ruleData = (RuleData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) { // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\\n                }\\n            }\\n        });\\n    }\\n    \\n}\\n```\\n\\n\\n\\n\u90a3\u4e48\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684\u903b\u8f91\uff1a\\n\\n```java\\n// \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\nBaseDataCache.getInstance().cacheSelectData(selectorData);\\n// \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                  \\nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n```\\n\\n\u4e00\u662f\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u7684\u5185\u5b58\u4e2d\u3002`BaseDataCache`\u662f\u6700\u7ec8\u7f13\u5b58\u6570\u636e\u7684\u7c7b\uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\u3002\u9009\u62e9\u5668\u6570\u636e\u5c31\u5b58\u5230\u4e86`SELECTOR_MAP`\u8fd9\u4e2a`Map`\u4e2d\u3002\u5728\u540e\u7eed\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e5f\u662f\u4ece\u8fd9\u91cc\u62ff\u6570\u636e\u3002\\n\\n```java\\npublic final class BaseDataCache {\\n    // \u79c1\u6709\u53d8\u91cf\\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\\n  \\t// \u79c1\u6709\u6784\u9020\u5668\\n    private BaseDataCache() {\\n    }\\n    \\n    /**\\n     * Gets instance.\\n     *  \u516c\u5f00\u65b9\u6cd5\\n     * @return the instance\\n     */\\n    public static BaseDataCache getInstance() {\\n        return INSTANCE;\\n    }\\n    \\n    /**\\n    *  \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684Map\\n     * pluginName -> SelectorData.\\n     */\\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\\n    \\n    public void cacheSelectData(final SelectorData selectorData) {\\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\\n    }\\n        \\n   /**\\n     * cache selector data.\\n     * \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\\n     * @param data the selector data\\n     */\\n    private void selectorAccept(final SelectorData data) {\\n        String key = data.getPluginName();\\n        if (SELECTOR_MAP.containsKey(key)) { // \u66f4\u65b0\u64cd\u4f5c\uff0c\u5148\u5220\u9664\u518d\u63d2\u5165\\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\\n            resultList.add(data);\\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\\n            SELECTOR_MAP.put(key, collect);\\n        } else {  // \u65b0\u589e\u64cd\u4f5c\uff0c\u76f4\u63a5\u653e\u5230Map\u4e2d\\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\\n        }\\n    }\\n    \\n}\\n```\\n\\n\\n\\n\u4e8c\u662f\u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\u3002  \u901a\u8fc7`idea`\u7f16\u8f91\u5668\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u540e\uff0c\u6709\u5982\u4e0b\u7684\u63d2\u4ef6\u8fd8\u6709\u5904\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u5c55\u5f00\u4e86\u3002\\n\\n![](/img/activities/code-analysis-websocket-data-sync/handler-selector.png)\\n\\n\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u6e90\u7801\u8ffd\u8e2a\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\uff0c\u5728`admin`\u7aef\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u5c31\u5c06`websocket`\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5206\u6790\u6e05\u695a\u4e86\u3002\\n\\n\u6211\u4eec\u8fd8\u662f\u7528\u4e0b\u9762\u7684\u4e00\u5f20\u56fe\u5c06\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u6d41\u7a0b\u4e32\u8054\u4e00\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-websocket-data-sync/websocket-data-sync-gateway.png)\\n\\n\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5df2\u7ecf\u5206\u6790\u5b8c\u4e86\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e9b\u95ee\u9898\u6ca1\u6709\u5206\u6790\u5230\uff0c\u5c31\u662f\u7f51\u5173\u662f\u5982\u4f55\u8ddf`admin`\u5efa\u7acb\u8fde\u63a5\u7684\uff1f\\n\\n### 4. \u7f51\u5173\u548cadmin\u5efa\u7acbwebsocket\u8fde\u63a5\\n\\n- websocket\u914d\u7f6e\\n\\n\u5728\u7f51\u5173\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6709\u5982\u4e0b\u914d\u7f6e\uff0c\u5e76\u4e14\u5f15\u5165\u4e86\u76f8\u5173\u4f9d\u8d56\uff0c\u5c31\u4f1a\u542f\u52a8`websocket`\u76f8\u5173\u670d\u52a1\u3002\\n\\n```yaml\\nshenyu:\\n    file:\\n      enabled: true\\n    cross:\\n      enabled: true\\n    dubbo :\\n      parameter: multi\\n    sync:\\n      websocket :  # \u4f7f\u7528websocket\u8fdb\u884c\u6570\u636e\u540c\u6b65\\n        urls: ws://localhost:9095/websocket   # admin\u7aef\u7684websocket\u5730\u5740\\n        allowOrigin: ws://localhost:9195\\n```\\n\\n\u5728\u7f51\u5173\u4e2d\u5f15\u5165`websocket`\u7684\u4f9d\u8d56\u3002\\n\\n```xml\\n\x3c!--shenyu data sync start use websocket--\x3e\\n<dependency>\\n    <groupId>org.apache.shenyu</groupId>\\n    <artifactId>shenyu-spring-boot-starter-sync-data-websocket</artifactId>\\n    <version>${project.version}</version>\\n</dependency>\\n```\\n\\n- Websocket\u6570\u636e\u540c\u6b65\u914d\u7f6e\\n\\n\u901a\u8fc7`springboot`\u7684\u6761\u4ef6\u88c5\u914d\uff0c\u521b\u5efa\u76f8\u5173\u7684`bean`\u3002\u5728\u7f51\u5173\u542f\u52a8\u7684\u65f6\u5019\uff0c\u5982\u679c\u6211\u4eec\u914d\u7f6e\u4e86`shenyu.sync.websocket.urls`\uff0c\u90a3\u4e48`Websocket`\u6570\u636e\u540c\u6b65\u914d\u7f6e\u5c31\u4f1a\u88ab\u52a0\u8f7d\u3002\u8fd9\u91cc\u901a\u8fc7`spring boot starter`\u5b8c\u6210\u4f9d\u8d56\u7684\u52a0\u8f7d\u3002\\n\\n```java\\n\\n/**\\n * Websocket\u6570\u636e\u540c\u6b65\u914d\u7f6e\\n * \u901a\u8fc7springboot\u5b9e\u73b0\u6761\u4ef6\u6ce8\u5165\\n * Websocket sync data configuration for spring boot.\\n */\\n@Configuration\\n@ConditionalOnClass(WebsocketSyncDataService.class)\\n@ConditionalOnProperty(prefix = \\"shenyu.sync.websocket\\", name = \\"urls\\")\\n@Slf4j\\npublic class WebsocketSyncDataConfiguration {\\n\\n    /**\\n     * Websocket sync data service.\\n     * Websocket\u6570\u636e\u540c\u6b65\u670d\u52a1\\n     * @param websocketConfig   the websocket config\\n     * @param pluginSubscriber the plugin subscriber\\n     * @param metaSubscribers   the meta subscribers\\n     * @param authSubscribers   the auth subscribers\\n     * @return the sync data service\\n     */\\n    // \u521b\u5efawebsocketSyncDataService\\n    @Bean\\n    public SyncDataService websocketSyncDataService(final ObjectProvider<WebsocketConfig> websocketConfig, final ObjectProvider<PluginDataSubscriber> pluginSubscriber,\\n                                           final ObjectProvider<List<MetaDataSubscriber>> metaSubscribers, final ObjectProvider<List<AuthDataSubscriber>> authSubscribers) {\\n        log.info(\\"you use websocket sync shenyu data.......\\");\\n        return new WebsocketSyncDataService(websocketConfig.getIfAvailable(WebsocketConfig::new), pluginSubscriber.getIfAvailable(),\\n                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));\\n    }\\n\\n    /**\\n     * Config websocket config.\\n     *\\n     * @return the websocket config\\n     */\\n    @Bean\\n    @ConfigurationProperties(prefix = \\"shenyu.sync.websocket\\")\\n    public WebsocketConfig websocketConfig() {\\n        return new WebsocketConfig();  // \u521b\u5efaWebsocketConfig\\n    }\\n}\\n```\\n\\n\\n\\n\u5728\u9879\u76ee\u7684`resources/META-INF`\u76ee\u5f55\u5148\u65b0\u5efa`spring.factories`\u6587\u4ef6\uff0c\u5728\u6587\u4ef6\u4e2d\u6307\u660e\u914d\u7f6e\u7c7b\u3002\\n\\n![](/img/activities/code-analysis-websocket-data-sync/websocket-springboot-starter.png)\\n\\n\\n\\n- Websocket\u6570\u636e\u540c\u6b65\u670d\u52a1\\n\\n\u5728`WebsocketSyncDataService`\u4e2d\u505a\u4e86\u5982\u4e0b\u51e0\u4ef6\u4e8b\u60c5\uff1a\\n\\n- \u8bfb\u53d6\u914d\u7f6e\u4e2d\u7684`urls`\uff0c\u8fd9\u4e2a\u8868\u793a`admin`\u7aef\u7684\u540c\u6b65\u5730\u5740\uff0c\u6709\u591a\u4e2a\u7684\u8bdd\uff0c\u4f7f\u7528\\",\\"\u5206\u5272\uff1b\\n- \u521b\u5efa\u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff0c\u4e00\u4e2a`admin`\u5206\u914d\u4e00\u4e2a\uff0c\u7528\u4e8e\u6267\u884c\u5b9a\u65f6\u4efb\u52a1\uff1b\\n- \u521b\u5efa`ShenyuWebsocketClient`\uff0c\u4e00\u4e2a`admin`\u5206\u914d\u4e00\u4e2a\uff0c\u7528\u4e8e\u548c`admin`\u5efa\u7acb`websocket`\u901a\u4fe1\uff1b\\n- \u5f00\u59cb\u548c`admin`\u7aef\u7684`websocket` \u5efa\u7acb\u8fde\u63a5\uff1b\\n- \u6267\u884c\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf\u969410\u79d2\u6267\u884c\u4e00\u6b21\u3002\u4e3b\u8981\u4f5c\u7528\u662f\u5224\u65ad`websocket`\u8fde\u63a5\u662f\u5426\u5df2\u7ecf\u65ad\u5f00\uff0c\u5982\u679c\u5df2\u7ecf\u65ad\u5f00\uff0c\u5219\u5c1d\u8bd5\u91cd\u8fde\u3002\u5982\u679c\u6ca1\u6709\u65ad\u5f00\uff0c\u5c31\u8fdb\u884c `ping-pong` \u68c0\u6d4b\u3002\\n\\n```java\\n\\n/**\\n * Websocket\u6570\u636e\u540c\u6b65\u670d\u52a1\\n * Websocket sync data service.\\n */\\n@Slf4j\\npublic class WebsocketSyncDataService implements SyncDataService, AutoCloseable {\\n\\n    private final List<WebSocketClient> clients = new ArrayList<>();\\n\\n    private final ScheduledThreadPoolExecutor executor;\\n\\n    /**\\n     * Instantiates a new Websocket sync cache.\\n     * \u521b\u5efaWebsocket\u6570\u636e\u540c\u6b65\u670d\u52a1\\n     * @param websocketConfig      the websocket config\\n     * @param pluginDataSubscriber the plugin data subscriber\\n     * @param metaDataSubscribers  the meta data subscribers\\n     * @param authDataSubscribers  the auth data subscribers\\n     */\\n    public WebsocketSyncDataService(final WebsocketConfig websocketConfig,\\n                                    final PluginDataSubscriber pluginDataSubscriber,\\n                                    final List<MetaDataSubscriber> metaDataSubscribers,\\n                                    final List<AuthDataSubscriber> authDataSubscribers) {\\n        // admin\u7aef\u7684\u540c\u6b65\u5730\u5740\uff0c\u6709\u591a\u4e2a\u7684\u8bdd\uff0c\u4f7f\u7528\\",\\"\u5206\u5272\\n        String[] urls = StringUtils.split(websocketConfig.getUrls(), \\",\\");\\n        // \u521b\u5efa\u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff0c\u4e00\u4e2aadmin\u5206\u914d\u4e00\u4e2a\\n        executor = new ScheduledThreadPoolExecutor(urls.length, ShenyuThreadFactory.create(\\"websocket-connect\\", true));\\n        for (String url : urls) {\\n            try {\\n                //\u521b\u5efaWebsocketClient\uff0c\u4e00\u4e2aadmin\u5206\u914d\u4e00\u4e2a\\n                clients.add(new ShenyuWebsocketClient(new URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));\\n            } catch (URISyntaxException e) {\\n                log.error(\\"websocket url({}) is error\\", url, e);\\n            }\\n        }\\n        try {\\n            for (WebSocketClient client : clients) {\\n                // \u548cwebsocket server\u5efa\u7acb\u8fde\u63a5\\n                boolean success = client.connectBlocking(3000, TimeUnit.MILLISECONDS);\\n                if (success) {\\n                    log.info(\\"websocket connection is successful.....\\");\\n                } else {\\n                    log.error(\\"websocket connection is error.....\\");\\n                }\\n\\n                // \u6267\u884c\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf\u969410\u79d2\u6267\u884c\u4e00\u6b21\\n                // \u4e3b\u8981\u4f5c\u7528\u662f\u5224\u65adwebsocket\u8fde\u63a5\u662f\u5426\u5df2\u7ecf\u65ad\u5f00\uff0c\u5982\u679c\u5df2\u7ecf\u65ad\u5f00\uff0c\u5219\u5c1d\u8bd5\u91cd\u8fde\u3002\\n                // \u5982\u679c\u6ca1\u6709\u65ad\u5f00\uff0c\u5c31\u8fdb\u884c ping-pong \u68c0\u6d4b\\n                executor.scheduleAtFixedRate(() -> {\\n                    try {\\n                        if (client.isClosed()) {\\n                            boolean reconnectSuccess = client.reconnectBlocking();\\n                            if (reconnectSuccess) {\\n                                log.info(\\"websocket reconnect server[{}] is successful.....\\", client.getURI().toString());\\n                            } else {\\n                                log.error(\\"websocket reconnection server[{}] is error.....\\", client.getURI().toString());\\n                            }\\n                        } else {\\n                            client.sendPing();\\n                            log.debug(\\"websocket send to [{}] ping message successful\\", client.getURI().toString());\\n                        }\\n                    } catch (InterruptedException e) {\\n                        log.error(\\"websocket connect is error :{}\\", e.getMessage());\\n                    }\\n                }, 10, 10, TimeUnit.SECONDS);\\n            }\\n            /* client.setProxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress(\\"proxyaddress\\", 80)));*/\\n        } catch (InterruptedException e) {\\n            log.info(\\"websocket connection...exception....\\", e);\\n        }\\n\\n    }\\n\\n    @Override\\n    public void close() {\\n        // \u5173\u95ed websocket client\\n        for (WebSocketClient client : clients) {\\n            if (!client.isClosed()) {\\n                client.close();\\n            }\\n        }\\n        // \u5173\u95ed\u7ebf\u7a0b\u6c60\\n        if (Objects.nonNull(executor)) {\\n            executor.shutdown();\\n        }\\n    }\\n}\\n```\\n\\n- ShenyuWebsocketClient\\n\\n\u5728`ShenYu`\u4e2d\u521b\u5efa\u7684`WebSocket`\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u548c`admin`\u7aef\u901a\u4fe1\u3002\u7b2c\u4e00\u6b21\u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\uff0c\u540c\u6b65\u5168\u91cf\u6570\u636e\uff0c\u540e\u7eed\u8fdb\u884c\u589e\u91cf\u540c\u6b65\u3002\\n\\n```java\\n\\n/**\\n * \u5728ShenYu\u4e2d\u81ea\u5b9a\u4e49\u7684WebSocket\u5ba2\u6237\u7aef\\n * The type shenyu websocket client.\\n */\\n@Slf4j\\npublic final class ShenyuWebsocketClient extends WebSocketClient {\\n    \\n    private volatile boolean alreadySync = Boolean.FALSE;\\n    \\n    private final WebsocketDataHandler websocketDataHandler;\\n    \\n    /**\\n     * Instantiates a new shenyu websocket client.\\n     * \u521b\u5efaShenyuWebsocketClient\\n     * @param serverUri             the server uri  \u670d\u52a1\u7aefuri\\n     * @param pluginDataSubscriber the plugin data subscriber \u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u5668\\n     * @param metaDataSubscribers   the meta data subscribers \u5143\u6570\u636e\u8ba2\u9605\u5668\\n     * @param authDataSubscribers   the auth data subscribers \u8ba4\u8bc1\u6570\u636e\u8ba2\u9605\u5668\\n     */\\n    public ShenyuWebsocketClient(final URI serverUri, final PluginDataSubscriber pluginDataSubscriber,final List<MetaDataSubscriber> metaDataSubscribers, final List<AuthDataSubscriber> authDataSubscribers) {\\n        super(serverUri);\\n        this.websocketDataHandler = new WebsocketDataHandler(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);\\n    }\\n\\n    // \u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\u6267\u884c\\n    @Override\\n    public void onOpen(final ServerHandshake serverHandshake) {\\n        // \u9632\u6b62\u91cd\u65b0\u5efa\u7acb\u8fde\u63a5\u65f6\uff0c\u518d\u6b21\u6267\u884c\uff0c\u6240\u4ee5\u7528alreadySync\u8fdb\u884c\u5224\u65ad\\n        if (!alreadySync) {\\n            // \u540c\u6b65\u6240\u6709\u6570\u636e\uff0cMYSELF \u7c7b\u578b\\n            send(DataEventTypeEnum.MYSELF.name());\\n            alreadySync = true;\\n        }\\n    }\\n\\n    // \u63a5\u6536\u5230\u6d88\u606f\u540e\u6267\u884c\\n    @Override\\n    public void onMessage(final String result) {\\n        // \u5904\u7406\u63a5\u6536\u5230\u7684\u6570\u636e\\n        handleResult(result);\\n    }\\n    \\n    // \u5173\u95ed\u540e\u6267\u884c\\n    @Override\\n    public void onClose(final int i, final String s, final boolean b) {\\n        this.close();\\n    }\\n    \\n    // \u5931\u8d25\u540e\u6267\u884c\\n    @Override\\n    public void onError(final Exception e) {\\n        this.close();\\n    }\\n    \\n    @SuppressWarnings(\\"ALL\\")\\n    private void handleResult(final String result) {\\n        // \u6570\u636e\u53cd\u5e8f\u5217\u5316\\n        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);\\n        // \u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219...\\n        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());\\n        // \u54ea\u79cd\u64cd\u4f5c\u7c7b\u578b\uff0c\u66f4\u65b0\u3001\u5220\u9664...\\n        String eventType = websocketData.getEventType();\\n        String json = GsonUtils.getInstance().toJson(websocketData.getData());\\n\\n        // \u5904\u7406\u6570\u636e\\n        websocketDataHandler.executor(groupEnum, json, eventType);\\n    }\\n}\\n\\n```\\n\\n\\n### 5. \u603b\u7ed3\\n\\n\u672c\u6587\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\uff0c\u5bf9`websocket`\u7684\u6570\u636e\u540c\u6b65\u539f\u7406\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a\\n\\n- `websocket`\u652f\u6301\u53cc\u5411\u901a\u4fe1\uff0c\u6027\u80fd\u597d\uff0c\u63a8\u8350\u4f7f\u7528\uff1b\\n- \u901a\u8fc7`Spring`\u5b8c\u6210\u4e8b\u4ef6\u53d1\u5e03\u548c\u76d1\u542c\uff1b\\n- \u901a\u8fc7\u62bd\u8c61`DataChangedListener`\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u540c\u6b65\u7b56\u7565\uff0c\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff1b\\n- \u4f7f\u7528\u5de5\u5382\u6a21\u5f0f\u521b\u5efa `WebsocketDataHandler`\uff0c\u5b9e\u73b0\u4e0d\u540c\u6570\u636e\u7c7b\u578b\u7684\u5904\u7406\uff1b\\n- \u4f7f\u7528\u6a21\u677f\u65b9\u6cd5\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0`AbstractDataHandler`\uff0c\u5904\u7406\u901a\u7528\u7684\u64cd\u4f5c\u7c7b\u578b\uff1b\\n- \u4f7f\u7528\u5355\u4f8b\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0\u7f13\u5b58\u6570\u636e\u7c7b`BaseDataCache`\uff1b\\n- \u901a\u8fc7`SpringBoot`\u7684\u6761\u4ef6\u88c5\u914d\u548c`starter`\u52a0\u8f7d\u673a\u5236\u5b9e\u73b0\u914d\u7f6e\u7c7b\u7684\u52a0\u8f7d\u3002"},{"id":"/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync","metadata":{"permalink":"/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync.md","title":"ZooKeeper\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"zookeeper","permalink":"/zh/blog/tags/zookeeper"},{"label":"data sync","permalink":"/zh/blog/tags/data-sync"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":25.66,"hasTruncateMarker":false,"authors":[{"name":"midnight2104","title":"Apache ShenYu Committer","url":"https://github.com/midnight2104"}],"frontMatter":{"title":"ZooKeeper\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","author":"midnight2104","author_title":"Apache ShenYu Committer","author_url":"https://github.com/midnight2104","tags":["zookeeper","data sync","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"WebSocket\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync"},"nextItem":{"title":"e2e\u6d4b\u8bd5\u8be6\u89e3","permalink":"/zh/blog/E2eTest-Analysis"}},"content":"> [Apache ShenYu](https://shenyu.apache.org/zh/docs/index) \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 `API` \u7f51\u5173\u3002\\n\\n\u5728`ShenYu`\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002`Apache ShenYu` \u7f51\u5173\u5f53\u524d\u652f\u6301`ZooKeeper`\u3001`WebSocket`\u3001`Http\u957f\u8f6e\u8be2`\u3001`Nacos` \u3001`Etcd` \u548c `Consul` \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e`ZooKeeper`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.4.0`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [\u6570\u636e\u540c\u6b65\u539f\u7406](https://shenyu.apache.org/zh/docs/design/data-sync) \u3002\\n\\n### 1. \u5173\u4e8eZooKeeper\\n\\n[`Apache ZooKeeper`](https://zh.wikipedia.org/wiki/Apache_ZooKeeper)\u662f`Apache`\u8f6f\u4ef6\u57fa\u91d1\u4f1a\u7684\u4e00\u4e2a\u8f6f\u4ef6\u9879\u76ee\uff0c\u5b83\u4e3a\u5927\u578b\u5206\u5e03\u5f0f\u8ba1\u7b97\u63d0\u4f9b\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u914d\u7f6e\u670d\u52a1\u3001\u540c\u6b65\u670d\u52a1\u548c\u547d\u540d\u6ce8\u518c\u3002`ZooKeeper`\u8282\u70b9\u5c06\u5b83\u4eec\u7684\u6570\u636e\u5b58\u50a8\u4e8e\u4e00\u4e2a\u5206\u5c42\u7684\u540d\u5b57\u7a7a\u95f4\uff0c\u975e\u5e38\u7c7b\u4f3c\u4e8e\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u6216\u4e00\u4e2a\u524d\u7f00\u6811\u7ed3\u6784\u3002\u5ba2\u6237\u7aef\u53ef\u4ee5\u5728\u8282\u70b9\u8bfb\u5199\uff0c\u4ece\u800c\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u62e5\u6709\u4e00\u4e2a\u5171\u4eab\u7684\u914d\u7f6e\u670d\u52a1\u3002\\n\\n### 2. Admin\u6570\u636e\u540c\u6b65\\n\\n\u6211\u4eec\u4ece\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\u8fdb\u884c\u6e90\u7801\u8ffd\u8e2a\uff0c\u6bd4\u5982\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u5bf9`Divide`\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff1a\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/update-selector-zh.png)\\n\\n#### 2.1 \u63a5\u6536\u6570\u636e\\n\\n- SelectorController.createSelector()\\n\\n\u8fdb\u5165`SelectorController`\u7c7b\u4e2d\u7684`updateSelector()`\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002\\n\\n```java\\n@Validated\\n@RequiredArgsConstructor\\n@RestController\\n@RequestMapping(\\"/selector\\")\\npublic class SelectorController {\\n    \\n    @PutMapping(\\"/{id}\\")\\n    public ShenyuAdminResult updateSelector(@PathVariable(\\"id\\") final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {\\n        // \u8bbe\u7f6e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636eid\\n        selectorDTO.setId(id);\\n        // \u521b\u5efa\u6216\u66f4\u65b0\u64cd\u4f5c\\n        Integer updateCount = selectorService.createOrUpdate(selectorDTO);\\n        // \u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\\n        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);\\n    }\\n    \\n    // ......\\n}\\n```\\n\\n#### 2.2 \u5904\u7406\u6570\u636e\\n\\n- SelectorServiceImpl.createOrUpdate()\\n\\n\u5728`SelectorServiceImpl`\u7c7b\u4e2d\u901a\u8fc7`createOrUpdate()`\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u66f4\u65b0`upstream`\u3002\\n\\n```java\\n@RequiredArgsConstructor\\n@Service\\npublic class SelectorServiceImpl implements SelectorService {\\n    // \u8d1f\u8d23\u4e8b\u4ef6\u53d1\u5e03\u7684eventPublisher\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n    @Override\\n    @Transactional(rollbackFor = Exception.class)\\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\\n        int selectorCount;\\n        // \u6784\u5efa\u6570\u636e DTO --\x3e DO\\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\\n        // \u5224\u65ad\u662f\u6dfb\u52a0\u8fd8\u662f\u66f4\u65b0\\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\\n            // \u63d2\u5165\u9009\u62e9\u5668\u6570\u636e\\n            selectorCount = selectorMapper.insertSelective(selectorDO);\\n            // \u63d2\u5165\u9009\u62e9\u5668\u4e2d\u7684\u6761\u4ef6\u6570\u636e\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\\n            });\\n            // check selector add\\n            // \u6743\u9650\u68c0\u67e5\\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\\n                dataPermissionDTO.setDataId(selectorDO.getId());\\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\\n            }\\n\\n        } else {\\n            // \u66f4\u65b0\u6570\u636e\uff0c\u5148\u5220\u9664\u518d\u65b0\u589e\\n            selectorCount = selectorMapper.updateSelective(selectorDO);\\n            //delete rule condition then add\\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\\n                selectorConditionMapper.insertSelective(selectorConditionDO);\\n            });\\n        }\\n        // \u53d1\u5e03\u4e8b\u4ef6\\n        publishEvent(selectorDO, selectorConditionDTOs);\\n\\n        // \u66f4\u65b0upstream\\n        updateDivideUpstream(selectorDO);\\n        return selectorCount;\\n    }\\n    \\n    \\n    // ......\\n    \\n}\\n\\n```\\n\\n\u5728`Serrvice`\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u6df1\u5165\u8ffd\u8e2a\u4e86\u3002\u5173\u4e8e\u66f4\u65b0`upstream`\u64cd\u4f5c\uff0c\u653e\u5230\u540e\u9762\u5bf9\u5e94\u7684\u7ae0\u8282\u4e2d\u8fdb\u884c\u5206\u6790\uff0c\u91cd\u70b9\u5173\u6ce8\u53d1\u5e03\u4e8b\u4ef6\u7684\u64cd\u4f5c\uff0c\u5b83\u4f1a\u6267\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n`publishEvent()`\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u6784\u5efa\u6761\u4ef6\u6570\u636e\uff0c\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u3002\\n\\n```java\\n       private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\\n        // \u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\\n        // \u6784\u5efa\u6761\u4ef6\u6570\u636e\\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\\n        // \u53d1\u5e03\u53d8\u66f4\u6570\u636e\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\\n    }\\n```\\n\\n\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7`eventPublisher.publishEvent()`\u5b8c\u6210\uff0c\u8fd9\u4e2a`eventPublisher`\u5bf9\u8c61\u662f\u4e00\u4e2a`ApplicationEventPublisher`\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f`org.springframework.context.ApplicationEventPublisher`\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7`Spring`\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002\\n\\n> \u5173\u4e8e`ApplicationEventPublisher`\uff1a\\n>\\n> \u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 `ApplicationEventPublisher` \u7684 `publishEvent` \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c`Spring`\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 `onApplicationEvent` \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 `publishEvent`\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 `ApplicationEventPublisher` \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002\\n>\\n> - `ApplicationEventPublisher`\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b\\n> - `ApplicationEvent`\uff1a`Spring` \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b\\n> - `ApplicationListener`\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\uff1b\\n\\n\\n\u5728`Spring`\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c\\n\\n\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684`ApplicationEventPublisher`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a`eventPublisher`\u3002\\n\\n\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f`ApplicationEvent`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEvent`\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\npublic class DataChangedEvent extends ApplicationEvent {\\n//......\\n}\\n```\\n\\n\u6700\u540e\u4e00\u4e2a\u662f `ApplicationListener`\uff0c\u5728`ShenYu`\u4e2d\u901a\u8fc7`DataChangedEventDispatcher`\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n    //......\\n    \\n}\\n```\\n\\n#### 2.3 \u5206\u53d1\u6570\u636e\\n\\n- DataChangedEventDispatcher.onApplicationEvent()\\n\\n\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230`DataChangedEventDispatcher`\u7c7b\u4e2d\u7684`onApplicationEvent()`\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002\\n\\n```java\\n@Component\\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\\n\\n  /**\\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\\n     * @param event\\n     */\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\\n                    break;\\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\\n                    break;\\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\\n                    break;\\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\\n                    break;\\n                case META_DATA:  // \u5143\u6570\u636e\\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\\n                    break;\\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\\n                    throw new IllegalStateException(\\"Unexpected value: \\" + event.getGroupKey());\\n            }\\n        }\\n    }\\n    \\n}\\n```\\n\\n\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528`onApplicationEvent`\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002\\n\\n`ShenYu`\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u662f\u4e94\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u548c\u5143\u6570\u636e\u3002\\n\\n\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08`DataChangedListener`\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u5b83\u7684\u5177\u4f53\u5b9e\u73b0\u6709\uff1a\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/data-changed-listener.png)\\n\\n\u8fd9\u51e0\u4e2a\u5b9e\u73b0\u7c7b\u5c31\u662f\u5f53\u524d`ShenYu`\u652f\u6301\u7684\u540c\u6b65\u7b56\u7565\uff1a\\n\\n- `WebsocketDataChangedListener`\uff1a\u57fa\u4e8e`websocket`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ZookeeperDataChangedListener`\uff1a\u57fa\u4e8e`zookeeper`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `ConsulDataChangedListener`\uff1a\u57fa\u4e8e`consul`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `EtcdDataDataChangedListener`\uff1a\u57fa\u4e8e`etcd`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `HttpLongPollingDataChangedListener`\uff1a\u57fa\u4e8e`http\u957f\u8f6e\u8be2`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n- `NacosDataChangedListener`\uff1a\u57fa\u4e8e`nacos`\u7684\u6570\u636e\u540c\u6b65\uff1b\\n\\n\u65e2\u7136\u6709\u8fd9\u4e48\u591a\u79cd\u5b9e\u73b0\u7b56\u7565\uff0c\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u5462\uff1f\\n\\n\u56e0\u4e3a\u672c\u6587\u662f\u57fa\u4e8e`Zookeeper`\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ee5`ZookeeperDataChangedListener`\u4e3a\u4f8b\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u88ab\u52a0\u8f7d\u5e76\u5b9e\u73b0\u7684\u3002\\n\\n\u901a\u8fc7\u5728\u6e90\u7801\u5de5\u7a0b\u4e2d\u8fdb\u884c\u5168\u5c40\u641c\u7d22\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u7684\u5b9e\u73b0\u662f\u5728`DataSyncConfiguration`\u7c7b\u5b8c\u6210\u7684\u3002\\n\\n```java\\n/**\\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\\n * The type Data sync configuration.\\n */\\n@Configuration\\npublic class DataSyncConfiguration {\\n    \\n    \\n    /**\\n     * zookeeper\u6570\u636e\u540c\u6b65\\n     * The type Zookeeper listener.\\n     */\\n    @Configuration\\n    @ConditionalOnProperty(prefix = \\"shenyu.sync.zookeeper\\", name = \\"url\\")  // \u6761\u4ef6\u5c5e\u6027\uff0c\u6ee1\u8db3\u624d\u4f1a\u88ab\u52a0\u8f7d\\n    @Import(ZookeeperConfiguration.class)\\n    static class ZookeeperListener {\\n\\n        /**\\n         * Config event listener data changed listener.\\n         * \u521b\u5efaZookeeper\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\n         * @param zkClient the zk client\\n         * @return the data changed listener\\n         */\\n        @Bean\\n        @ConditionalOnMissingBean(ZookeeperDataChangedListener.class)\\n        public DataChangedListener zookeeperDataChangedListener(final ZkClient zkClient) {\\n            return new ZookeeperDataChangedListener(zkClient);\\n        }\\n\\n        /**\\n         * Zookeeper data init zookeeper data init.\\n         *  \u521b\u5efa Zookeeper \u6570\u636e\u521d\u59cb\u5316\u7c7b\\n         * @param zkClient        the zk client\\n         * @param syncDataService the sync data service\\n         * @return the zookeeper data init\\n         */\\n        @Bean\\n        @ConditionalOnMissingBean(ZookeeperDataInit.class)\\n        public ZookeeperDataInit zookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {\\n            return new ZookeeperDataInit(zkClient, syncDataService);\\n        }\\n    }\\n    \\n    //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\\n}\\n\\n```\\n\\n\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u662f\u901a\u8fc7`SpringBoot`\u6761\u4ef6\u88c5\u914d\u7c7b\u5b9e\u73b0\u7684\u3002\u5728`ZookeeperListener`\u7c7b\u4e0a\u9762\u6709\u51e0\u4e2a\u6ce8\u89e3\uff1a\\n\\n- `@Configuration`\uff1a\u914d\u7f6e\u6587\u4ef6\uff0c\u5e94\u7528\u4e0a\u4e0b\u6587\uff1b\\n\\n- `@ConditionalOnProperty(prefix = \\"shenyu.sync.zookeeper\\", name = \\"url\\")`\uff1a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u91c7\u7528`zookeeper`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n  ```properties\\n  shenyu:  \\n    sync:\\n       zookeeper:\\n            url: localhost:2181\\n            sessionTimeout: 5000\\n            connectionTimeout: 2000\\n  ```\\n\\n- `@Import(ZookeeperConfiguration.class)`\uff1a\u5bfc\u5165\u53e6\u4e00\u4e2a\u7c7b`ZookeeperConfiguration`\uff1b\\n\\n```java\\n  @EnableConfigurationProperties(ZookeeperProperties.class)  // \u542f\u7528zk\u5c5e\u6027\u914d\u7f6e\u7c7b\\n  public class ZookeeperConfiguration {\\n\\n    /**\\n     * register zkClient in spring ioc.\\n     * \u5411 Spring IOC \u5bb9\u5668\u6ce8\u518c zkClient\\n     * @param zookeeperProp the zookeeper configuration\\n     * @return ZkClient {@linkplain ZkClient}\\n        */\\n      @Bean\\n      @ConditionalOnMissingBean(ZkClient.class)\\n      public ZkClient zkClient(final ZookeeperProperties zookeeperProp) {\\n        return new ZkClient(zookeeperProp.getUrl(), zookeeperProp.getSessionTimeout(), zookeeperProp.getConnectionTimeout()); // \u8bfb\u53d6zk\u914d\u7f6e\u4fe1\u606f\uff0c\u5e76\u521b\u5efazkClient\\n      }\\n  }\\n```\\n\\n```java\\n@Data\\n@ConfigurationProperties(prefix = \\"shenyu.sync.zookeeper\\") // zk\u5c5e\u6027\u914d\u7f6e\\npublic class ZookeeperProperties {\\n\\n    private String url;\\n\\n    private Integer sessionTimeout;\\n\\n    private Integer connectionTimeout;\\n\\n    private String serializer;\\n}\\n```\\n\\n\u5f53\u6211\u4eec\u4e3b\u52a8\u914d\u7f6e\uff0c\u91c7\u7528`zookeeper`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u65f6\uff0c`zookeeperDataChangedListener`\u5c31\u4f1a\u751f\u6210\u3002\u6240\u4ee5\u5728\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5`onApplicationEvent()`\u4e2d\uff0c\u5c31\u4f1a\u5230\u76f8\u5e94\u7684`listener`\u4e2d\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u662f\u5bf9\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u6570\u636e\u540c\u6b65\u91c7\u7528\u7684\u662f`zookeeper`\uff0c\u6240\u4ee5\uff0c\u4ee3\u7801\u4f1a\u8fdb\u5165\u5230`ZookeeperDataChangedListener`\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\u3002\\n\\n```java\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void onApplicationEvent(final DataChangedEvent event) {\\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\\n        for (DataChangedListener listener : listeners) {\\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\\n            switch (event.getGroupKey()) {\\n                    \\n                // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n                    \\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // \u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u4f1a\u8fdb\u5165\u5230ZookeeperDataChangedListener\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\\n                    break;\\n         }\\n    }\\n```\\n\\n#### 2.4 Zookeeper\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\\n\\n- ZookeeperDataChangedListener.onSelectorChanged()\\n\\n  \u5728`onSelectorChanged()`\u65b9\u6cd5\u4e2d\uff0c\u5224\u65ad\u64cd\u4f5c\u7c7b\u578b\uff0c\u662f\u5237\u65b0\u540c\u6b65\u8fd8\u662f\u66f4\u65b0\u6216\u521b\u5efa\u540c\u6b65\u3002\u6839\u636e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636e\u4fe1\u606f\u5224\u65ad\u8282\u70b9\u662f\u5426\u5728`zk`\u4e2d\u3002\\n\\n```java\\n\\n/**\\n * \u4f7f\u7528 zookeeper \u53d1\u5e03\u53d8\u66f4\u6570\u636e\\n */\\npublic class ZookeeperDataChangedListener implements DataChangedListener {\\n    \\n    // \u9009\u62e9\u5668\u4fe1\u606f\u53d1\u751f\u6539\u53d8\\n    @Override\\n    public void onSelectorChanged(final List<SelectorData> changed, final DataEventTypeEnum eventType) {\\n        // \u5237\u65b0\u64cd\u4f5c\\n        if (eventType == DataEventTypeEnum.REFRESH && !changed.isEmpty()) {\\n            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());\\n            deleteZkPathRecursive(selectorParentPath);\\n        }\\n        // \u53d1\u751f\u53d8\u66f4\u7684\u6570\u636e\\n        for (SelectorData data : changed) {\\n            // \u6784\u5efa\u9009\u62e9\u5668\u6570\u636e\u7684\u771f\u5b9e\u8def\u5f84\\n            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());\\n            // \u5982\u679c\u662f\u5220\u9664\u64cd\u4f5c\\n            if (eventType == DataEventTypeEnum.DELETE) {\\n                // \u5220\u9664\u5f53\u524d\u6570\u636e\\n                deleteZkPath(selectorRealPath);\\n                continue;\\n            }\\n            // \u7236\u8282\u70b9\u8def\u5f84\\n            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(data.getPluginName());\\n            // \u521b\u5efa\u7236\u8282\u70b9\\n            createZkNode(selectorParentPath);\\n            // \u63d2\u5165\u6216\u66f4\u65b0\u6570\u636e\\n            insertZkNode(selectorRealPath, data);\\n        }\\n    }\\n\\n\\t// \u521b\u5efa zk \u8282\u70b9\\n    private void createZkNode(final String path) {\\n        // \u4e0d\u5b58\u5728\u624d\u521b\u5efa\\n        if (!zkClient.exists(path)) {\\n            zkClient.createPersistent(path, true);\\n        }\\n    }\\n\\n    // \u63d2\u5165zk\u8282\u70b9\\n    private void insertZkNode(final String path, final Object data) {\\n        // \u521b\u5efa\u8282\u70b9\\n        createZkNode(path);\\n        // \u901a\u8fc7 zkClient \u5199\u5165\u6570\u636e\\n        zkClient.writeData(path, null == data ? \\"\\" : GsonUtils.getInstance().toJson(data));\\n    }\\n    \\n}\\n```\\n\\n\u53ea\u8981\u5c06\u53d8\u52a8\u7684\u6570\u636e\u6b63\u786e\u5199\u5165\u5230`zk`\u7684\u8282\u70b9\u4e0a\uff0c`admin`\u8fd9\u8fb9\u7684\u64cd\u4f5c\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002`ShenYu`\u5728\u4f7f\u7528`zk`\u8fdb\u884c\u6570\u636e\u540c\u6b65\u65f6\uff0c`zk`\u7684\u8282\u70b9\u662f\u901a\u8fc7\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u3002\\n\\n\u5728\u6211\u4eec\u5f53\u524d\u7684\u6848\u4f8b\u4e2d\uff0c\u5bf9`Divide`\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff0c\u5c31\u4f1a\u5bf9\u56fe\u4e2d\u7684\u7279\u5b9a\u8282\u70b9\u66f4\u65b0\u3002\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/zookeeper-node.png)\\n\\n\\n\u6211\u4eec\u7528\u65f6\u5e8f\u56fe\u5c06\u4e0a\u9762\u7684\u66f4\u65b0\u6d41\u7a0b\u4e32\u8054\u8d77\u6765\u3002\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/zk-sync-sequence-admin-zh.png)\\n\\n\\n### 3. \u7f51\u5173\u6570\u636e\u540c\u6b65\\n\\n\u5047\u8bbe`ShenYu`\u7f51\u5173\u5df2\u7ecf\u5728\u6b63\u5e38\u8fd0\u884c\uff0c\u4f7f\u7528\u7684\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e5f\u662f`zookeeper`\u3002\u90a3\u4e48\u5f53\u5728`admin`\u7aef\u66f4\u65b0\u9009\u62e9\u5668\u6570\u636e\u540e\uff0c\u5e76\u4e14\u5411`zk`\u53d1\u9001\u4e86\u53d8\u66f4\u7684\u6570\u636e\uff0c\u90a3\u7f51\u5173\u662f\u5982\u4f55\u63a5\u6536\u5e76\u5904\u7406\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7ee7\u7eed\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u4e00\u63a2\u7a76\u7adf\u3002\\n\\n#### 3.1 ZkClient\u63a5\u6536\u6570\u636e\\n\\n- ZkClient.subscribeDataChanges()\\n\\n\u5728\u7f51\u5173\u7aef\u6709\u4e00\u4e2a`ZookeeperSyncDataService`\u7c7b\uff0c\u5b83\u901a\u8fc7`ZkClient`\u8ba2\u9605\u4e86\u6570\u636e\u8282\u70b9\uff0c\u5f53\u6570\u636e\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u53ef\u4ee5\u611f\u77e5\u5230\u3002\\n\\n```java\\n/**\\n * \u4f7f\u7528 zookeeper \u7f13\u5b58\u6570\u636e\\n */\\npublic class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {\\n    \\nprivate void subscribeSelectorDataChanges(final String path) {\\n       // zkClient\u8ba2\u9605\u6570\u636e\u8282\u70b9\\n        zkClient.subscribeDataChanges(path, new IZkDataListener() {\\n            @Override\\n            public void handleDataChange(final String dataPath, final Object data) {\\n                cacheSelectorData(GsonUtils.getInstance().fromJson(data.toString(), SelectorData.class)); // \u8282\u70b9\u6570\u636e\u88ab\u66f4\u65b0\\n            }\\n\\n            @Override\\n            public void handleDataDeleted(final String dataPath) {\\n                unCacheSelectorData(dataPath);  // \u8282\u70b9\u6570\u636e\u88ab\u5220\u9664\\n            }\\n        });\\n    }\\n \\n    // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n}\\n```\\n\\n`ZooKeeper`\u7684`Watch`\u673a\u5236\uff0c\u4f1a\u7ed9\u8ba2\u9605\u7684\u5ba2\u6237\u7aef\u53d1\u9001\u8282\u70b9\u53d8\u66f4\u901a\u77e5\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u66f4\u65b0\u9009\u62e9\u5668\u4fe1\u606f\uff0c\u5c31\u4f1a\u8fdb\u5165\u5230`handleDataChange()`\u65b9\u6cd5\u3002\u901a\u8fc7`cacheSelectorData()`\u53bb\u5904\u7406\u6570\u636e\u3002\\n\\n#### 3.2 \u5904\u7406\u6570\u636e\\n\\n- ZookeeperSyncDataService.cacheSelectorData()\\n\\n\u7ecf\u8fc7\u5224\u7a7a\u903b\u8f91\u4e4b\u540e\uff0c\u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684\u64cd\u4f5c\u53c8\u4ea4\u7ed9\u4e86`PluginDataSubscriber`\u5904\u7406\u3002\\n\\n```java\\n    private void cacheSelectorData(final SelectorData selectorData) {\\n        Optional.ofNullable(selectorData)\\n                .ifPresent(data -> Optional.ofNullable(pluginDataSubscriber).ifPresent(e -> e.onSelectorSubscribe(data)));\\n    }\\n```\\n\\n`PluginDataSubscriber`\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b83\u53ea\u6709\u4e00\u4e2a`CommonPluginDataSubscriber`\u5b9e\u73b0\u7c7b\uff0c\u8d1f\u8d23\u5904\u7406\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\u3002\\n\\n\\n#### 3.3 \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\\n\\n- PluginDataSubscriber.onSelectorSubscribe()\\n\\n\u5b83\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528`subscribeDataHandler()`\u65b9\u6cd5\u3002\u5728\u65b9\u6cd5\u4e2d\uff0c\u66f4\u5177\u6570\u636e\u7c7b\u578b\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u6216\u89c4\u5219\uff09\uff0c\u64cd\u4f5c\u7c7b\u578b\uff08\u66f4\u65b0\u6216\u5220\u9664\uff09\uff0c\u53bb\u6267\u884c\u4e0d\u540c\u903b\u8f91\u3002\\n\\n```java\\n/**\\n * \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\\n * The type Common plugin data subscriber.\\n */\\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\\n    //......\\n     // \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\\n    @Override\\n    public void onSelectorSubscribe(final SelectorData selectorData) {\\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\\n    }    \\n    \\n    // \u8ba2\u9605\u6570\u636e\u5904\u7406\u5668\uff0c\u5904\u7406\u6570\u636e\u7684\u66f4\u65b0\u6216\u5220\u9664\\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\\n        Optional.ofNullable(classData).ifPresent(data -> {\\n            // \u63d2\u4ef6\u6570\u636e\\n            if (data instanceof PluginData) {\\n                PluginData pluginData = (PluginData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cachePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removePluginData(pluginData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\\n                }\\n            } else if (data instanceof SelectorData) {  // \u9009\u62e9\u5668\u6570\u636e\\n                SelectorData selectorData = (SelectorData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\\n                }\\n            } else if (data instanceof RuleData) {  // \u89c4\u5219\u6570\u636e\\n                RuleData ruleData = (RuleData) data;\\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\\n                } else if (dataType == DataEventTypeEnum.DELETE) { // \u5220\u9664\u64cd\u4f5c\\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\\n                }\\n            }\\n        });\\n    }\\n    \\n}\\n```\\n\\n\\n#### 3.4 \u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58\\n\\n\u90a3\u4e48\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684\u903b\u8f91\uff1a\\n\\n```java\\n// \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\\nBaseDataCache.getInstance().cacheSelectData(selectorData);\\n// \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    \\nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\\n```\\n\\n\u4e00\u662f\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u7684\u5185\u5b58\u4e2d\u3002`BaseDataCache`\u662f\u6700\u7ec8\u7f13\u5b58\u6570\u636e\u7684\u7c7b\uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\u3002\u9009\u62e9\u5668\u6570\u636e\u5c31\u5b58\u5230\u4e86`SELECTOR_MAP`\u8fd9\u4e2a`Map`\u4e2d\u3002\u5728\u540e\u7eed\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e5f\u662f\u4ece\u8fd9\u91cc\u62ff\u6570\u636e\u3002\\n\\n```java\\npublic final class BaseDataCache {\\n    // \u79c1\u6709\u53d8\u91cf\\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\\n  \\t// \u79c1\u6709\u6784\u9020\u5668\\n    private BaseDataCache() {\\n    }\\n    \\n    /**\\n     * Gets instance.\\n     *  \u516c\u5f00\u65b9\u6cd5\\n     * @return the instance\\n     */\\n    public static BaseDataCache getInstance() {\\n        return INSTANCE;\\n    }\\n    \\n    /**\\n    *  \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684Map\\n     * pluginName -> SelectorData.\\n     */\\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\\n    \\n    public void cacheSelectData(final SelectorData selectorData) {\\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\\n    }\\n        \\n   /**\\n     * cache selector data.\\n     * \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\\n     * @param data the selector data\\n     */\\n    private void selectorAccept(final SelectorData data) {\\n        String key = data.getPluginName();\\n        if (SELECTOR_MAP.containsKey(key)) { // \u66f4\u65b0\u64cd\u4f5c\uff0c\u5148\u5220\u9664\u518d\u63d2\u5165\\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\\n            resultList.add(data);\\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\\n            SELECTOR_MAP.put(key, collect);\\n        } else {  // \u65b0\u589e\u64cd\u4f5c\uff0c\u76f4\u63a5\u653e\u5230Map\u4e2d\\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\\n        }\\n    }\\n    \\n}\\n```\\n\\n\u4e8c\u662f\u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\u3002  \u901a\u8fc7`idea`\u7f16\u8f91\u5668\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u540e\uff0c\u6709\u5982\u4e0b\u7684\u63d2\u4ef6\u8fd8\u6709\u5904\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u5c55\u5f00\u4e86\u3002\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/handler-selector.png)\\n\\n\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u6e90\u7801\u8ffd\u8e2a\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\uff0c\u5728`admin`\u7aef\u65b0\u589e\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u5c31\u5c06`zookeeper`\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5206\u6790\u6e05\u695a\u4e86\u3002\\n\\n\u6211\u4eec\u8fd8\u662f\u901a\u8fc7\u65f6\u5e8f\u56fe\u5c06\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u6d41\u7a0b\u4e32\u8054\u4e00\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-zookeeper-data-sync/zk-sync-sequence-gateway-zh.png)\\n\\n\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5df2\u7ecf\u5206\u6790\u5b8c\u4e86\uff0c\u4e3a\u4e86\u4e0d\u8ba9\u540c\u6b65\u6d41\u7a0b\u88ab\u6253\u65ad\uff0c\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\u5c31\u5ffd\u7565\u4e86\u5176\u4ed6\u903b\u8f91\u3002\u6211\u4eec\u8fd8\u9700\u8981\u5206\u6790`Admin`\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\u548c\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\u7684\u6d41\u7a0b\u3002\\n\\n### 4. Admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\\n\\n\u5f53`admin`\u542f\u52a8\u540e\uff0c\u4f1a\u5c06\u5f53\u524d\u7684\u6570\u636e\u4fe1\u606f\u5168\u91cf\u540c\u6b65\u5230`zk`\u4e2d\uff0c\u5b9e\u73b0\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n```java\\n\\n/**\\n * Zookeeper \u6570\u636e\u521d\u59cb\u5316\\n */\\npublic class ZookeeperDataInit implements CommandLineRunner {\\n\\n    private final ZkClient zkClient;\\n\\n    private final SyncDataService syncDataService;\\n\\n    /**\\n     * Instantiates a new Zookeeper data init.\\n     *\\n     * @param zkClient        the zk client\\n     * @param syncDataService the sync data service\\n     */\\n    public ZookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {\\n        this.zkClient = zkClient;\\n        this.syncDataService = syncDataService;\\n    }\\n\\n    @Override\\n    public void run(final String... args) {\\n        String pluginPath = DefaultPathConstants.PLUGIN_PARENT;\\n        String authPath = DefaultPathConstants.APP_AUTH_PARENT;\\n        String metaDataPath = DefaultPathConstants.META_DATA;\\n        // \u5224\u65adzk\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\\n        if (!zkClient.exists(pluginPath) && !zkClient.exists(authPath) && !zkClient.exists(metaDataPath)) {\\n            syncDataService.syncAll(DataEventTypeEnum.REFRESH);\\n        }\\n    }\\n}\\n\\n```\\n\\n\u5224\u65ad`zk`\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u884c\u540c\u6b65\u3002\\n\\n`ZookeeperDataInit`\u5b9e\u73b0\u4e86`CommandLineRunner`\u63a5\u53e3\u3002\u5b83\u662f`springboot`\u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u4f1a\u5728\u6240\u6709 `Spring Beans`\u521d\u59cb\u5316\u4e4b\u540e\u6267\u884c`run()`\u65b9\u6cd5\uff0c\u5e38\u7528\u4e8e\u9879\u76ee\u4e2d\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002\\n\\n- SyncDataService.syncAll()\\n\\n\u4ece\u6570\u636e\u5e93\u67e5\u8be2\u6570\u636e\uff0c\u7136\u540e\u8fdb\u884c\u5168\u91cf\u6570\u636e\u540c\u6b65\uff0c\u6240\u6709\u7684\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002\u4e3b\u8981\u662f\u901a\u8fc7`eventPublisher`\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u3002\u8fd9\u91cc\u5c31\u8ddf\u524d\u9762\u63d0\u5230\u7684\u540c\u6b65\u903b\u8f91\u5c31\u53c8\u8054\u7cfb\u8d77\u6765\u4e86\uff0c`eventPublisher`\u901a\u8fc7`publishEvent()`\u53d1\u5e03\u5b8c\u4e8b\u4ef6\u540e\uff0c\u6709`ApplicationListener`\u6267\u884c\u4e8b\u4ef6\u53d8\u66f4\u64cd\u4f5c\uff0c\u5728`ShenYu`\u4e2d\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684`DataChangedEventDispatcher`\u3002\\n\\n```java\\n@Service\\npublic class SyncDataServiceImpl implements SyncDataService {\\n    // \u4e8b\u4ef6\u53d1\u5e03\\n    private final ApplicationEventPublisher eventPublisher;\\n    \\n     /***\\n     * \u5168\u91cf\u6570\u636e\u540c\u6b65\\n     * @param type the type\\n     * @return\\n     */\\n    @Override\\n    public boolean syncAll(final DataEventTypeEnum type) {\\n        // \u540c\u6b65\u8ba4\u8bc1\u4fe1\u606f\\n        appAuthService.syncData();\\n        // \u540c\u6b65\u63d2\u4ef6\u4fe1\u606f\\n        List<PluginData> pluginDataList = pluginService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));\\n        // \u540c\u6b65\u9009\u62e9\u5668\u4fe1\u606f\\n        List<SelectorData> selectorDataList = selectorService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));\\n        // \u540c\u6b65\u89c4\u5219\u4fe1\u606f\\n        List<RuleData> ruleDataList = ruleService.listAll();\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));\\n        // \u540c\u6b65\u5143\u6570\u636e\u4fe1\u606f\\n        metaDataService.syncData();\\n        return true;\\n    }\\n    \\n}\\n```\\n\\n### 5. \u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\\n\\n\u7f51\u5173\u8fd9\u8fb9\u7684\u6570\u636e\u540c\u6b65\u521d\u59cb\u5316\u64cd\u4f5c\u4e3b\u8981\u662f\u8ba2\u9605`zk`\u4e2d\u7684\u8282\u70b9\uff0c\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u6536\u5230\u53d8\u66f4\u6570\u636e\u3002\u8fd9\u4f9d\u8d56\u4e8e`ZooKeeper`\u7684`Watch`\u673a\u5236\u3002\u5728`ShenYu`\u4e2d\uff0c\u8d1f\u8d23`zk`\u6570\u636e\u540c\u6b65\u7684\u662f`ZookeeperSyncDataService`\uff0c\u4e5f\u5728\u524d\u9762\u63d0\u5230\u8fc7\u3002\\n\\n\\n`ZookeeperSyncDataService`\u7684\u529f\u80fd\u903b\u8f91\u662f\u5728\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\uff1a\u5bf9`zk`\u4e2d\u7684`shenyu`\u6570\u636e\u540c\u6b65\u8282\u70b9\u5b8c\u6210\u8ba2\u9605\u3002\u8fd9\u91cc\u7684\u8ba2\u9605\u5206\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u5df2\u7ecf\u5b58\u5728\u7684\u8282\u70b9\u4e0a\u9762\u6570\u636e\u53d1\u751f\u66f4\u65b0\uff0c\u8fd9\u901a\u8fc7`zkClient.subscribeDataChanges()`\u65b9\u6cd5\u5b9e\u73b0\uff1b\u53e6\u4e00\u7c7b\u662f\u5f53\u524d\u8282\u70b9\u4e0b\u6709\u65b0\u589e\u6216\u5220\u9664\u8282\u70b9\uff0c\u5373\u5b50\u8282\u70b9\u53d1\u751f\u53d8\u5316\uff0c\u8fd9\u901a\u8fc7`zkClient.subscribeChildChanges()`\u65b9\u6cd5\u5b9e\u73b0\u3002\\n\\n\\n`ZookeeperSyncDataService`\u7684\u4ee3\u7801\u6709\u70b9\u591a\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5\u63d2\u4ef6\u6570\u636e\u7684\u8bfb\u53d6\u548c\u8ba2\u9605\u8fdb\u884c\u8ffd\u8e2a\uff0c\u5176\u4ed6\u7c7b\u578b\u7684\u6570\u636e\u64cd\u4f5c\u539f\u7406\u662f\u4e00\u6837\u7684\u3002\\n\\n```java\\n\\n/**\\n *  zookeeper \u6570\u636e\u540c\u6b65\u670d\u52a1\\n */\\npublic class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {\\n    // \u5728\u5b9e\u4f8b\u5316\u7684\u65f6\u5019\uff0c\u5b8c\u6210\u4ecezk\u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u5e76\u8ba2\u9605\u8282\u70b9\\n    public ZookeeperSyncDataService( /*\u7701\u7565\u6784\u9020\u53c2\u6570\u53c2\u6570*/ ) {\\n        this.zkClient = zkClient;\\n        this.pluginDataSubscriber = pluginDataSubscriber;\\n        this.metaDataSubscribers = metaDataSubscribers;\\n        this.authDataSubscribers = authDataSubscribers;\\n        // \u8ba2\u9605\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\\n        watcherData();\\n        // \u8ba2\u9605\u8ba4\u8bc1\u6570\u636e\\n        watchAppAuth();\\n        // \u8ba2\u9605\u5143\u6570\u636e\\n        watchMetaData();\\n    }\\n    \\n    private void watcherData() {\\n        // \u63d2\u4ef6\u8282\u70b9\u8def\u5f84\\n        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;\\n        // \u6240\u6709\u63d2\u4ef6\u8282\u70b9\\n        List<String> pluginZKs = zkClientGetChildren(pluginParent);\\n        for (String pluginName : pluginZKs) {\\n            // \u8ba2\u9605\u5f53\u524d\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\\n            watcherAll(pluginName);\\n        }\\n        // \u8ba2\u9605\u5b50\u8282\u70b9\uff08\u65b0\u589e\u6216\u5220\u9664\u4e00\u4e2a\u63d2\u4ef6\uff09\\n        zkClient.subscribeChildChanges(pluginParent, (parentPath, currentChildren) -> {\\n            if (CollectionUtils.isNotEmpty(currentChildren)) {\\n                for (String pluginName : currentChildren) {\\n                    // \u9700\u8981\u8ba2\u9605\u5b50\u8282\u70b9\u7684\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\\n                    watcherAll(pluginName);\\n                }\\n            }\\n        });\\n    }\\n    \\n    private void watcherAll(final String pluginName) {\\n        // \u8ba2\u9605\u63d2\u4ef6\u6570\u636e\\n        watcherPlugin(pluginName);\\n        // \u8ba2\u9605\u9009\u62e9\u5668\u6570\u636e\\n        watcherSelector(pluginName);\\n        // \u8ba2\u9605\u89c4\u5219\u6570\u636e\\n        watcherRule(pluginName);\\n    }\\n\\n    private void watcherPlugin(final String pluginName) {\\n        // \u5f53\u524d\u63d2\u4ef6\u8def\u5f84\\n        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);\\n        // \u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u5c31\u521b\u5efa\\n        if (!zkClient.exists(pluginPath)) {\\n            zkClient.createPersistent(pluginPath, true);\\n        }\\n        // \u8bfb\u53d6zk\u4e0a\u5f53\u524d\u8282\u70b9\u6570\u636e\uff0c\u5e76\u53cd\u5e8f\u5217\u5316\\n        PluginData pluginData = null == zkClient.readData(pluginPath) ? null\\n                : GsonUtils.getInstance().fromJson((String) zkClient.readData(pluginPath), PluginData.class);\\n        // \u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d\\n        cachePluginData(pluginData);\\n        // \u8ba2\u9605\u63d2\u4ef6\u8282\u70b9\\n        subscribePluginDataChanges(pluginPath, pluginName);\\n    }\\n    \\n   private void cachePluginData(final PluginData pluginData) {\\n       // \u7701\u7565\u5b9e\u73b0\u903b\u8f91\uff0c\u5176\u5b9e\u5c31\u662f CommonPluginDataSubscriber \u4e2d\u7684\u64cd\u4f5c\uff0c\u8ddf\u524d\u9762\u90fd\u80fd\u8054\u7cfb\u8d77\u6765\\n    }\\n    \\n    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {\\n        // \u8ba2\u9605\u6570\u636e\u53d8\u66f4\uff1a\u66f4\u65b0\u6216\u5220\u9664\\n        zkClient.subscribeDataChanges(pluginPath, new IZkDataListener() {\\n\\n            @Override\\n            public void handleDataChange(final String dataPath, final Object data) {  // \u66f4\u65b0\u64cd\u4f5c\\n                 // \u7701\u7565\u5b9e\u73b0\u903b\u8f91\uff0c\u5176\u5b9e\u5c31\u662f CommonPluginDataSubscriber \u4e2d\u7684\u64cd\u4f5c\uff0c\u8ddf\u524d\u9762\u90fd\u80fd\u8054\u7cfb\u8d77\u6765\\n            }\\n\\n            @Override\\n            public void handleDataDeleted(final String dataPath) {   // \u5220\u9664\u64cd\u4f5c\\n                  // \u7701\u7565\u5b9e\u73b0\u903b\u8f91\uff0c\u5176\u5b9e\u5c31\u662f CommonPluginDataSubscriber \u4e2d\u7684\u64cd\u4f5c\uff0c\u8ddf\u524d\u9762\u90fd\u80fd\u8054\u7cfb\u8d77\u6765\\n\\n            }\\n        });\\n    }\\n    \\n}    \\n```\\n\\n\u4e0a\u9762\u7684\u6e90\u4ee3\u7801\u4e2d\u90fd\u7ed9\u51fa\u4e86\u6ce8\u91ca\uff0c\u76f8\u4fe1\u5927\u5bb6\u53ef\u4ee5\u770b\u660e\u767d\u3002\u8ba2\u9605\u63d2\u4ef6\u6570\u636e\u7684\u4e3b\u8981\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n> 1. \u6784\u9020\u5f53\u524d\u63d2\u4ef6\u8def\u5f84\\n> 2. \u8def\u5f84\u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u5c31\u521b\u5efa\\n> 3. \u8bfb\u53d6zk\u4e0a\u5f53\u524d\u8282\u70b9\u6570\u636e\uff0c\u5e76\u53cd\u5e8f\u5217\u5316\\n> 4. \u63d2\u4ef6\u6570\u636e\u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d\\n> 5. \u8ba2\u9605\u63d2\u4ef6\u8282\u70b9\\n\\n\\n### 6. \u603b\u7ed3\\n\\n\u672c\u6587\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\uff0c\u5bf9`zookeeper`\u7684\u6570\u636e\u540c\u6b65\u539f\u7406\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a\\n\\n- \u57fa\u4e8e`zookeeper`\u7684\u6570\u636e\u540c\u6b65\uff0c\u4e3b\u8981\u662f\u901a\u8fc7`watch`\u673a\u5236\u5b9e\u73b0\uff1b\\n- \u901a\u8fc7`Spring`\u5b8c\u6210\u4e8b\u4ef6\u53d1\u5e03\u548c\u76d1\u542c\uff1b\\n- \u901a\u8fc7\u62bd\u8c61`DataChangedListener`\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u540c\u6b65\u7b56\u7565\uff0c\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff1b\\n- \u4f7f\u7528\u5355\u4f8b\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0\u7f13\u5b58\u6570\u636e\u7c7b`BaseDataCache`\uff1b\\n- \u901a\u8fc7`SpringBoot`\u7684\u6761\u4ef6\u88c5\u914d\u548c`starter`\u52a0\u8f7d\u673a\u5236\u5b9e\u73b0\u914d\u7f6e\u7c7b\u7684\u52a0\u8f7d\u3002"},{"id":"/E2eTest-Analysis","metadata":{"permalink":"/zh/blog/E2eTest-Analysis","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/E2eTest-Analysis.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/E2eTest-Analysis.md","title":"e2e\u6d4b\u8bd5\u8be6\u89e3","description":"\u8fd9\u7bc7\u6587\u7ae0\u5c06\u4f1a\u5bf9Apache ShenYu\u7684e2e\u6a21\u5757\u8fdb\u884c\u6df1\u5165\u5256\u6790\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"E2e Test","permalink":"/zh/blog/tags/e-2-e-test"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":9.87,"hasTruncateMarker":false,"authors":[{"name":"Haiqi Qin","title":"Apache ShenYu Committer","url":"https://github.com/HaiqiQin","imageURL":"https://avatars.githubusercontent.com/u/80969210?v=4"}],"frontMatter":{"title":"e2e\u6d4b\u8bd5\u8be6\u89e3","author":"Haiqi Qin","author_title":"Apache ShenYu Committer","author_url":"https://github.com/HaiqiQin","author_image_url":"https://avatars.githubusercontent.com/u/80969210?v=4","tags":["E2e Test","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"ZooKeeper\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync"},"nextItem":{"title":"\u96c6\u6210\u6d4b\u8bd5\u5256\u6790","permalink":"/zh/blog/IntegrationTest-Analysis"}},"content":"\u8fd9\u7bc7\u6587\u7ae0\u5c06\u4f1a\u5bf9Apache ShenYu\u7684e2e\u6a21\u5757\u8fdb\u884c\u6df1\u5165\u5256\u6790\u3002\\n\\n### \u4ec0\u4e48\u662fe2e\\n\\ne2e(end to end)\uff0c\u4e5f\u53eb\u7aef\u5230\u7aef\u6d4b\u8bd5\uff0c\u662f\u4e00\u79cd\u7528\u4e8e\u6d4b\u8bd5\u5e94\u7528\u7a0b\u5e8f\u6d41\u662f\u5426\u4ece\u5934\u5230\u5c3e\u6309\u8bbe\u8ba1\u6267\u884c\u7684\u65b9\u6cd5\u3002 \u6267\u884c\u7aef\u5230\u7aef\u6d4b\u8bd5\u7684\u76ee\u7684\u662f\u8bc6\u522b\u7cfb\u7edf\u4f9d\u8d56\u5173\u7cfb\uff0c\u5e76\u786e\u4fdd\u5728\u5404\u79cd\u7cfb\u7edf\u7ec4\u4ef6\u548c\u7cfb\u7edf\u4e4b\u95f4\u4f20\u9012\u6b63\u786e\u7684\u4fe1\u606f\u3002\u7aef\u5230\u7aef\u6d4b\u8bd5\u7684\u76ee\u7684\u662f\u6d4b\u8bd5 \u6574\u4e2a\u8f6f\u4ef6\u7684\u4f9d\u8d56\u6027\u3001\u6570\u636e\u5b8c\u6574\u6027\u4ee5\u53ca\u4e0e\u5176\u4ed6\u7cfb\u7edf\u3001\u63a5\u53e3\u548c\u6570\u636e\u5e93\u7684\u901a\u4fe1\uff0c\u4ee5\u6a21\u62df\u5b8c\u6574\u7684\u751f\u4ea7\u573a\u666f\u3002\\n\\n### e2e\u7684\u4f18\u52bf\\n\\ne2e\u6d4b\u8bd5\u80fd\u591f\u6a21\u62df\u771f\u5b9e\u7528\u6237\u573a\u666f\u4e0b\u6d4b\u8bd5\u8f6f\u4ef6\u7cfb\u7edf\u7684\u5b8c\u6574\u6027\u548c\u51c6\u786e\u6027\uff0c\u80fd\u591f\u9a8c\u8bc1\u6574\u4e2a\u7cfb\u7edf\u662f\u5426\u6309\u7167\u9884\u671f\u5de5\u4f5c\uff0c\u4ee5\u53ca\u4e0d\u540c\u7ec4\u4ef6\u662f\u5426\u80fd\u591f\u534f\u540c\u5de5\u4f5c\u3002 e2e\u6d4b\u8bd5\u6709\u4ee5\u4e0b\u51e0\u4e2a\u597d\u5904:\\n\\n1. \u5e2e\u52a9\u4fdd\u8bc1\u7cfb\u7edf\u529f\u80fd\u7684\u6b63\u786e\u6027\uff1ae2e\u6d4b\u8bd5\u80fd\u591f\u6a21\u62df\u771f\u5b9e\u7528\u6237\u573a\u666f\u4e0b\u7684\u4ea4\u4e92\u548c\u64cd\u4f5c\uff0c\u9a8c\u8bc1\u6574\u4e2a\u7cfb\u7edf\u662f\u5426\u80fd\u591f\u6309\u7167\u9884\u671f\u5de5\u4f5c\uff0c\u5e2e\u52a9\u53d1\u73b0\u7cfb\u7edf\u4e2d\u7684\u6f5c\u5728\u95ee\u9898\u548c\u7f3a\u9677\u3002\\n2. \u63d0\u9ad8\u6d4b\u8bd5\u8986\u76d6\u7387\uff1ae2e\u6d4b\u8bd5\u80fd\u591f\u8986\u76d6\u6574\u4e2a\u7cfb\u7edf\uff0c\u5305\u62ec\u524d\u7aef\u3001\u540e\u7aef\u3001\u6570\u636e\u5e93\u7b49\u4e0d\u540c\u5c42\u9762\u548c\u7ec4\u4ef6\uff0c\u4ece\u800c\u63d0\u9ad8\u6d4b\u8bd5\u8986\u76d6\u7387\uff0c\u4fdd\u8bc1\u6d4b\u8bd5\u7684\u5168\u9762\u6027\u548c\u51c6\u786e\u6027\u3002\\n3. \u4fdd\u8bc1\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\uff1aE2E\u6d4b\u8bd5\u53ef\u4ee5\u68c0\u67e5\u7cfb\u7edf\u5728\u5404\u79cd\u60c5\u51b5\u4e0b\u7684\u7a33\u5b9a\u6027\u548c\u5065\u58ee\u6027\uff0c\u5305\u62ec\u7cfb\u7edf\u7684\u54cd\u5e94\u65f6\u95f4\u3001\u9519\u8bef\u5904\u7406\u80fd\u529b\u3001\u5e76\u53d1\u6027\u7b49\u65b9\u9762\uff0c\u5e2e\u52a9\u786e\u4fdd\u7cfb\u7edf\u5728\u9762\u5bf9\u9ad8\u8d1f\u8f7d\u548c\u5f02\u5e38\u60c5\u51b5\u65f6\u4ecd\u7136\u80fd\u591f\u4fdd\u6301\u7a33\u5b9a\u8fd0\u884c\u3002\\n4. \u51cf\u5c11\u6d4b\u8bd5\u6210\u672c\uff1ae2e\u6d4b\u8bd5\u80fd\u591f\u63d0\u9ad8\u6d4b\u8bd5\u6548\u7387\u548c\u51c6\u786e\u6027\uff0c\u51cf\u5c11\u6d4b\u8bd5\u6210\u672c\u548c\u65f6\u95f4\uff0c\u4ece\u800c\u5e2e\u52a9\u4f01\u4e1a\u66f4\u5feb\u901f\u5730\u53d1\u5e03\u548c\u4ea4\u4ed8\u9ad8\u8d28\u91cf\u7684\u8f6f\u4ef6\u4ea7\u54c1\u3002\\n\\n\u603b\u4e4b\uff0ce2e\u6d4b\u8bd5\u662f\u4e00\u79cd\u5168\u9762\u7684\u6d4b\u8bd5\u65b9\u5f0f\uff0c\u80fd\u591f\u9a8c\u8bc1\u6574\u4e2a\u7cfb\u7edf\u662f\u5426\u6309\u7167\u9884\u671f\u5de5\u4f5c\uff0c\u63d0\u9ad8\u6d4b\u8bd5\u8986\u76d6\u7387\u548c\u6d4b\u8bd5\u6548\u7387\uff0c\u4ece\u800c\u4fdd\u8bc1\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u548c\u6b63\u786e\u6027\uff0c\u51cf\u5c11\u6d4b\u8bd5\u6210\u672c\u548c\u65f6\u95f4\uff0c\u662f\u4e00\u79cd\u975e\u5e38\u91cd\u8981\u548c\u6709\u6548\u7684\u6d4b\u8bd5\u65b9\u6cd5\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5b8c\u5584 e2e\u76f8\u5173\u4ee3\u7801\u3002\\n\\n### \u81ea\u52a8\u5316e2e\u6d4b\u8bd5\u5982\u4f55\u5b9e\u73b0\\n\\n\u5728Apache ShenYu\u4e2d\uff0ce2e\u6d4b\u8bd5\u7684\u4e3b\u8981\u6b65\u9aa4\u4f53\u73b0\u5728GitHub Action\u5de5\u4f5c\u6d41\u7684\u811a\u672c\u4e2d\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u8be5\u811a\u672c\u4f4d\u4e8e [~/.github/workflows](https://github.com/apache/incubator-shenyu/tree/master/.github/workflows)\u76ee\u5f55\u4e0b\u7684e2e\u6587\u4ef6\u4e2d\u3002\\n\\n```yaml\\nname: e2e\\n\\non:\\n  pull_request:\\n  push:\\n    branches:\\n      - master\\njobs:\\n  changes:\\n    ...\\n  build-docker-images:\\n    ...\\n  e2e-http:\\n    ...\\n  e2e-case:\\n    runs-on: ubuntu-latest\\n    needs:\\n      - changes\\n      - build-docker-images\\n    if: ${{ needs.changes.outputs.e2e == \'true\' }}\\n    strategy:\\n      matrix:\\n        case: [ \\"shenyu-e2e-case-spring-cloud\\", \\"shenyu-e2e-case-apache-dubbo\\", \\"shenyu-e2e-case-sofa\\" ]\\n    steps:\\n      - uses: actions/checkout@v3\\n        with:\\n          submodules: true\\n      - name: Load ShenYu Docker Images\\n        run: |\\n          docker load --input /tmp/apache-shenyu-admin.tar\\n          docker load --input /tmp/apache-shenyu-bootstrap.tar\\n          docker image ls -a\\n      - name: Build examples with Maven\\n        run: ./mvnw -B clean install -Pexample -Dmaven.javadoc.skip=true -Dmaven.test.skip=true -f ./shenyu-examples/pom.xml\\n      - name: Run ShenYu E2E Tests\\n        env:\\n          storage: mysql\\n        run: |\\n          bash ./shenyu-e2e/script/storage_init.sh\\n          ./mvnw -B -f ./shenyu-e2e/pom.xml -pl shenyu-e2e-case/${{ matrix.case }} -Dstorage=mysql test\\n```\\n\\n\u5f53\u5de5\u4f5c\u6d41\u89e6\u53d1\u65f6\uff0c\u4f7f\u7528shenyu-dist\u6a21\u5757\u4e0b\u7684dockerfile\u6587\u4ef6\u6784\u5efaadmin\u4e0ebootstrap\u9879\u76ee\u7684\u955c\u50cf\u5e76\u4e0a\u4f20\uff0c\u5f53e2e\u6d4b\u8bd5\u6a21\u5757\u8fd0\u884c\u65f6\u53ef\u4ee5\u52a0\u8f7dadmin\u4e0ebootstrap\u955c\u50cf\u3002\u7d27\u63a5\u7740\u6784\u5efaexamples\u4e2d\u7684\u6a21\u5757\uff0c\u6700\u540e\u6267\u884c\u5bf9\u5e94\u6d4b\u8bd5\u6a21\u5757\u7684\u6d4b\u8bd5\u65b9\u6cd5\u3002\\n\\n### \u672c\u5730\u5982\u4f55\u8fd0\u884ce2e\u6d4b\u8bd5\\n\\n\u5982\u679c\u9700\u8981\u7f16\u5199e2e\u6d4b\u8bd5\u7528\u4f8b\uff0c\u9996\u5148\u9700\u8981\u5728\u672c\u5730\u7f16\u7801\u5e76\u8c03\u8bd5\u3002\u76ee\u524de2e\u652f\u6301\u4e24\u79cd\u542f\u52a8\u65b9\u5f0f\uff0c\u4e00\u4e2a\u662fdocker\u542f\u52a8\uff0c\u53e6\u4e00\u4e2a\u662fhost\u542f\u52a8\u3002\u8fd9\u4e24\u79cd\u6a21\u5f0f\u53ef\u4ee5\u901a\u8fc7\u5728\u6d4b\u8bd5\u7c7b\u4e2d\u7684@ShenYuTest\u6ce8\u89e3\u4e2d\u5207\u6362\u3002host\u542f\u52a8\u65b9\u5f0f\u76f4\u63a5\u5728\u672c\u5730\u5c06\u9700\u8981\u542f\u52a8\u7684\u670d\u52a1\u76f4\u63a5\u542f\u52a8\u5373\u53ef\u8fd0\u884c\u6d4b\u8bd5\u4ee3\u7801\u3002\u91c7\u7528docker\u8fdb\u884c\u542f\u52a8\u524d\uff0c\u9700\u8981\u5728\u5148\u6784\u5efa\u51fa\u76f8\u5e94\u955c\u50cf\u3002\u56e0\u4e3aShenYu\u76ee\u524d\u9700\u8981\u652f\u6301\u5728github\u5de5\u4f5c\u6d41\u8fdb\u884ce2e\u6d4b\u8bd5\uff0c\u5efa\u8bae\u91c7\u7528docker\u542f\u52a8\u65b9\u5f0f\u3002\\n\\n### e2e\u542f\u52a8\u6d41\u7a0b\u5256\u6790\\n\\n\u76ee\u524de2e\u6a21\u5757\u4e3b\u8981\u5206\u4e3a\u56db\u4e2a\u90e8\u5206\uff0c\u5206\u522b\u4e3a\uff1acase\u3001client\u3001common\u4ee5\u53caengine\u3002\\n\\n![e2e-modules](/img/activities/code-analysis-e2e/e2e-modules.png)\\n\\ncase\u6a21\u5757\u5b58\u653e\u63d2\u4ef6\u7684\u6d4b\u8bd5\u7528\u4f8b\uff0cclient\u6a21\u5757\u7f16\u5199\u4e86admin\u4e0egateway\u7684\u5ba2\u6237\u7aef\uff0c\u4ee5\u4fbf\u8bf7\u6c42\u5bf9\u5e94\u63a5\u53e3\u3002common\u5b58\u653e\u4e00\u4e9b\u516c\u5171\u7c7b\uff0cengine\u6a21\u5757\u662f\u6846\u67b6\u7684\u6838\u5fc3\uff0c\u4f9d\u6258testcontainer\u6846\u67b6\u5229\u7528java\u4ee3\u7801\u542f\u52a8docker\u5bb9\u5668\u5e76\u5b8c\u6210\u5bf9admin\u4ee5\u53cagatewat\u7684\u914d\u7f6e\u64cd\u4f5c\u3002\\n\\n\u63a5\u4e0b\u6765\u6211\u5c06\u4f9d\u6258\u6e90\u7801\u5bf9e2e\u542f\u52a8\u6d41\u7a0b\u8fdb\u884c\u5256\u6790\u3002\\n\\n\u5f53\u6211\u4eec\u6267\u884ccase\u4e2d\u7684\u6d4b\u8bd5\u65b9\u6cd5\u65f6\uff0c@ShenYuTest\u6ce8\u89e3\u5c06\u4f1a\u751f\u6548\uff0c\u5bf9\u6d4b\u8bd5\u7c7b\u8fdb\u884c\u6269\u5c55\u3002\u901a\u8fc7@ShenYuTest\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u542f\u52a8\u65b9\u6cd5\u3001\u5bf9admin\u4ee5\u53cagateway\u914d\u7f6e\u76f8\u5173\u53c2\u6570\uff0c\u4ee5\u53ca\u9009\u62e9\u5c06\u8981\u6267\u884c\u7684docker-compose\u6587\u4ef6\u3002\u5bf9\u4e8eadmin\u4ee5\u53cagateway\uff0c\u53ef\u4ee5\u914d\u7f6e\u767b\u9646\u6240\u9700\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801\u3001\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4ee5\u53ca\u4fee\u6539yaml\u7684\u5185\u5bb9\u3002\\n\\n```java\\n@ShenYuTest(\\n        mode = ShenYuEngineConfigure.Mode.DOCKER,\\n        services = {\\n                @ShenYuTest.ServiceConfigure(\\n                        serviceName = \\"admin\\",\\n                        port = 9095,\\n                        baseUrl = \\"http://{hostname:localhost}:9095\\",\\n                        parameters = {\\n                                @ShenYuTest.Parameter(key = \\"username\\", value = \\"admin\\"),\\n                                @ShenYuTest.Parameter(key = \\"password\\", value = \\"123456\\"),\\n                                @ShenYuTest.Parameter(key = \\"dataSyn\\", value = \\"admin_websocket\\")\\n                        }\\n                ),\\n                @ShenYuTest.ServiceConfigure(\\n                        serviceName = \\"gateway\\",\\n                        port = 9195,\\n                        baseUrl = \\"http://{hostname:localhost}:9195\\", \\n                        type = ShenYuEngineConfigure.ServiceType.SHENYU_GATEWAY,\\n                        parameters = {\\n                          @ShenYuTest.Parameter(key = \\"application\\", value =  \\"spring.cloud.discovery.enabled:true,eureka.client.enabled:true\\"), \\n                          @ShenYuTest.Parameter(key = \\"dataSyn\\", value = \\"gateway_websocket\\")})},           dockerComposeFile = \\"classpath:./docker-compose.mysql.yml\\")\\n\\n```\\n\\n@ShenYuTest\u901a\u8fc7ShenYuExtension\u7c7b\u8fdb\u884c\u6269\u5c55\uff0c\u5bf9admin\u4e0egateway\u7684\u914d\u7f6e\u5728ShenYuExtension\u4e2d\u7684beforeAll\u4e2d\u751f\u6548\u3002\u5177\u4f53\u7684\u751f\u6548\u903b\u8f91\u5728DockerServiceCompose\u7c7b\u4e2d\u5b9e\u73b0\u3002\\n\\n![e2e-shenyutest](/img/activities/code-analysis-e2e/e2e-shenyutest.png)\\n\\n![e2e-beforeall](/img/activities/code-analysis-e2e/e2e-beforeall.png)\\n\\n@ShenYuTest\u914d\u7f6e\u9879\u5728docker\u542f\u52a8\u524d\u751f\u6548\uff0c\u4e3b\u8981\u901a\u8fc7\u4fee\u6539\u6d4b\u8bd5\u6a21\u5757\u4e2dresource\u76ee\u5f55\u4e0b\u7684yaml\u6587\u4ef6\u3002\u76ee\u524de2e\u652f\u6301\u5bf9\u4e0d\u540c\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u8fdb\u884c\u6d4b\u8bd5\uff0c\u5176\u539f\u7406\u5c31\u662f\u901a\u8fc7DockerServiceCompose\u7c7b\u4e2d\u7684chooseDataSyn\u65b9\u6cd5\u3002\u5728DataSyncHandler\u4e2d\u5bf9\u5404\u79cd\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u9700\u8981\u4fee\u6539\u7684\u5185\u5bb9\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u6700\u540e\u542f\u52a8container\u3002\\n\\n![e2e-docer-service-compose](/img/activities/code-analysis-e2e/e2e-docer-service-compose.png)\\n\\n![e2e-datahandle-syn](/img/activities/code-analysis-e2e/e2e-datahandle-syn.png)\\n\\n\u5f53docker\u542f\u52a8\u5b8c\u540e\uff0c\u5f00\u59cb\u5bf9\u63d2\u4ef6\u529f\u80fd\u8fdb\u884c\u6d4b\u8bd5\u3002\u5728PluginsTest\u7c7b\u4e2d\uff0c\u6709\u9488\u5bf9\u6d4b\u8bd5\u8fdb\u884c\u7684\u524d\u7f6e\u4ee5\u53ca\u540e\u7f6e\u64cd\u4f5c\u3002\\n\\n```java\\n    @BeforeAll\\n    static void setup(final AdminClient adminClient, final GatewayClient gatewayClient) throws InterruptedException, JsonProcessingException {\\n        adminClient.login();\\n        Thread.sleep(10000);\\n        List<SelectorDTO> selectorDTOList = adminClient.listAllSelectors();\\n        List<MetaDataDTO> metaDataDTOList = adminClient.listAllMetaData();\\n        List<RuleDTO> ruleDTOList = adminClient.listAllRules();\\n        Assertions.assertEquals(2, selectorDTOList.size());\\n        Assertions.assertEquals(13, metaDataDTOList.size());\\n        Assertions.assertEquals(14, ruleDTOList.size());\\n        \\n        for (SelectorDTO selectorDTO : selectorDTOList) {\\n            if (selectorDTO.getHandle() != null && !\\"\\".equals(selectorDTO.getHandle())) {\\n                SpringCloudPluginCases.verifierUri(selectorDTO.getHandle());\\n            }\\n        }\\n        \\n        List<MetaData> metaDataCacheList = gatewayClient.getMetaDataCache();\\n        List<SelectorCacheData> selectorCacheList = gatewayClient.getSelectorCache();\\n        List<RuleCacheData> ruleCacheList = gatewayClient.getRuleCache();\\n        Assertions.assertEquals(2, selectorCacheList.size());\\n        Assertions.assertEquals(13, metaDataCacheList.size());\\n        Assertions.assertEquals(14, ruleCacheList.size());\\n\\n        MultiValueMap<String, String> formData = new LinkedMultiValueMap<>();\\n        formData.add(\\"id\\", \\"8\\");\\n        formData.add(\\"name\\", \\"springCloud\\");\\n        formData.add(\\"enabled\\", \\"true\\");\\n        formData.add(\\"role\\", \\"Proxy\\");\\n        formData.add(\\"sort\\", \\"200\\");\\n        adminClient.changePluginStatus(\\"8\\", formData);\\n        String id = \\"\\";\\n        for (SelectorDTO selectorDTO : selectorDTOList) {\\n            if (!\\"\\".equals(selectorDTO.getHandle())) {\\n                id = selectorDTO.getId();\\n            }\\n        }\\n        adminClient.deleteSelectors(id);\\n        selectorDTOList = adminClient.listAllSelectors();\\n        Assertions.assertEquals(1, selectorDTOList.size());\\n    }\\n```\\n\\n\u4ee5springcloud\u63d2\u4ef6\u4e3a\u4f8b\uff0c\u9996\u5148\u9700\u8981\u6d4b\u8bd5\u6ce8\u518c\u4e2d\u5fc3\u4ee5\u53ca\u6570\u636e\u540c\u6b65\u80fd\u5426\u6b63\u5e38\u5de5\u4f5c\uff0c\u63a5\u7740\u542f\u52a8\u63d2\u4ef6\u5e76\u5220\u9664\u5df2\u5b58\u5728\u7684\u9009\u62e9\u5668\u3002\u6d4b\u8bd5\u6570\u636e\u662f\u5426\u6210\u529f\u6ce8\u518c\u8fdb\u6ce8\u518c\u4e2d\u5fc3\uff0c\u53ef\u4ee5\u8c03\u7528admin\u5ba2\u6237\u7aef\u7684\u63a5\u53e3\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u6570\u636e\u540c\u6b65\u662f\u5426\u6210\u529f\uff0c\u53ef\u4ee5\u83b7\u53d6gateway\u7684\u7f13\u5b58\u8fdb\u884c\u6d4b\u8bd5\u3002\\n\\n\u63a5\u7740\u8fd0\u884ccase\u6587\u4ef6\u4e2d\u7684\u6d4b\u8bd5\u7528\u4f8b\uff0c\u901a\u8fc7@ShenYuScenario\u83b7\u53d6\u7528\u4f8b\u3002\\n\\n```java\\n    @ShenYuScenario(provider = SpringCloudPluginCases.class)\\n    void testSpringCloud(GatewayClient gateway, CaseSpec spec) {\\n        spec.getVerifiers().forEach(verifier -> verifier.verify(gateway.getHttpRequesterSupplier().get()));\\n    }\\n```\\n\\n\u9488\u5bf9\u4e0d\u540c\u7684\u63d2\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u6784\u5efaCase\u7c7b\uff0c\u5b58\u653e\u8981\u6d4b\u8bd5\u7684\u89c4\u5219\u3002\u6240\u6709\u7684\u6d4b\u8bd5\u89c4\u5219\u5b58\u653e\u8fdblist\u4e2d\uff0c\u6309\u987a\u5e8f\u8fdb\u884c\u6d4b\u8bd5\u3002beforeEachSpec\u4e2d\u8fdb\u884c\u6784\u5efa\u9009\u62e9\u5668\u4e0e\u89c4\u5219\uff0ccaseSpec\u5b58\u653e\u6d4b\u8bd5\u5b9e\u4f53\uff0c\u5982\u679c\u7b26\u5408uri\u89c4\u5219\u7684\u5e94\u5b58\u5728\uff0c\u5426\u5219\u4e0d\u5b58\u5728\u3002\u6211\u4eec\u9700\u8981\u6a21\u62df\u7528\u6237\u5bf9\u9009\u62e9\u5668\u548c\u89c4\u5219\u8fdb\u884c\u65b0\u589e\uff0c\u56e0\u4e3a\u5404\u4e2a\u63d2\u4ef6\u7684\u9009\u62e9\u5668\u7684handler\u89c4\u5219\u4e0d\u4e00\u5b9a\u76f8\u540c\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u6839\u636e\u63d2\u4ef6\u9700\u6c42\u53bb\u7f16\u5199\u5176handle\u7c7b\u3002\u5e76\u901a\u8fc7\u8bf7\u6c42\u9a8c\u8bc1\u5176\u7b26\u5408\u89c4\u5219\u3002\u5177\u4f53\u6d4b\u8bd5\u7528\u4f8b\u4e3b\u8981\u5206\u4e3a\u4e24\u5927\u7c7b\uff0c\u4e00\u7c7b\u662f\u5bf9uri\u89c4\u5219\u8fdb\u884c\u5339\u914d\uff0c\u6bd4\u5982euqal\u3001path_pattern\u3001start_with\u3001end_with\uff0c\u4e00\u7c7b\u662f\u8bf7\u6c42\u7c7b\u578b\uff0c\u6bd4\u5982get\u3001put\u3001post\u3001delete\u3002\\n\\n\u5f53\u516b\u79cd\u5339\u914d\u60c5\u51b5\u90fd\u6d4b\u8bd5\u901a\u8fc7\u540e\uff0c\u53ef\u4ee5\u5224\u65ad\u8be5\u63d2\u4ef6\u529f\u80fd\u6b63\u5e38\uff0c\u6211\u4eec\u5728\u6d4b\u8bd5\u7ed3\u675f\u540e\u9700\u8981\u6062\u590d\u73af\u5883\uff0c\u5c06\u6240\u6709\u7684\u9009\u62e9\u5668\u5220\u9664\uff0c\u5c06\u8be5\u63d2\u4ef6\u8bbe\u7f6e\u4e3a\u4e0d\u53ef\u7528\uff0c\u6700\u540e\u5173\u95ed\u6240\u6709\u5bb9\u5668\u3002\\n\\n```java\\n    @Override\\n    public List<ScenarioSpec> get() {\\n        return Lists.newArrayList(\\n                testWithUriEquals(),\\n                testWithUriPathPattern(),\\n                testWithUriStartWith(),\\n                testWithEndWith(),\\n                testWithMethodGet(),\\n                testWithMethodPost(),\\n                testWithMethodPut(),\\n                testWithMethodDelete()\\n        );\\n    }\\n\\n    private ShenYuScenarioSpec testWithUriEquals() {\\n        return ShenYuScenarioSpec.builder()\\n                .name(\\"single-spring-cloud uri =]\\")\\n                .beforeEachSpec(\\n                        ShenYuBeforeEachSpec.builder()\\n                                .addSelectorAndRule(\\n                                        newSelectorBuilder(\\"selector\\", Plugin.SPRING_CLOUD)                                               .handle(SpringCloudSelectorHandle.builder().serviceId(\\"springCloud-test\\")\\n                                                        .gray(true)\\n                                                        .divideUpstreams(DIVIDE_UPSTREAMS)\\n                                                        .build())\\n                                                .conditionList(newConditions(Condition.ParamType.URI, Condition.Operator.EQUAL, TEST))\\n                                                .build(),\\n                                        newRuleBuilder(\\"rule\\")                               .handle(SpringCloudRuleHandle.builder().loadBalance(\\"hash\\").timeout(3000).build())\\n                                                .conditionList(newConditions(Condition.ParamType.URI, Condition.Operator.EQUAL, TEST))\\n                                                .build()\\n                                )\\n                                .checker(notExists(TEST))\\n                                .waiting(exists(TEST))\\n                                .build()\\n                )\\n                .caseSpec(\\n                        ShenYuCaseSpec.builder()\\n                                .addExists(TEST)\\n                                .addNotExists(\\"/springcloud/te\\")\\n                                .addNotExists(\\"/put\\")\\n                                .addNotExists(\\"/get\\")\\n                                .build()\\n                )\\n                .afterEachSpec(ShenYuAfterEachSpec.DEFAULT)\\n                .build();\\n    }\\n```"},{"id":"/IntegrationTest-Analysis","metadata":{"permalink":"/zh/blog/IntegrationTest-Analysis","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/IntegrationTest-Analysis.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/IntegrationTest-Analysis.md","title":"\u96c6\u6210\u6d4b\u8bd5\u5256\u6790","description":"\u8fd9\u7bc7\u6587\u7ae0\u5c06\u4f1a\u5bf9Apache ShenYu\u7684\u96c6\u6210\u6d4b\u8bd5\u8fdb\u884c\u6df1\u5165\u5256\u6790\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"Integration Test","permalink":"/zh/blog/tags/integration-test"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":8.345,"hasTruncateMarker":false,"authors":[{"name":"Kunshuai Zhu","title":"Apache ShenYu Committer","url":"https://github.com/JooKS-me","imageURL":"https://avatars1.githubusercontent.com/u/62384022?v=4"}],"frontMatter":{"title":"\u96c6\u6210\u6d4b\u8bd5\u5256\u6790","author":"Kunshuai Zhu","author_title":"Apache ShenYu Committer","author_url":"https://github.com/JooKS-me","author_image_url":"https://avatars1.githubusercontent.com/u/62384022?v=4","tags":["Integration Test","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"e2e\u6d4b\u8bd5\u8be6\u89e3","permalink":"/zh/blog/E2eTest-Analysis"},"nextItem":{"title":"\u6269\u5c55\u63d2\u4ef6\u52a0\u8f7d\u903b\u8f91","permalink":"/zh/blog/Loader-SourceCode-Analysis-ExtLoader"}},"content":"\u8fd9\u7bc7\u6587\u7ae0\u5c06\u4f1a\u5bf9Apache ShenYu\u7684\u96c6\u6210\u6d4b\u8bd5\u8fdb\u884c\u6df1\u5165\u5256\u6790\u3002\\n\\n### \u4ec0\u4e48\u662f\u96c6\u6210\u6d4b\u8bd5\uff1f\\n\\n\u96c6\u6210\u6d4b\u8bd5\u5728\u4e00\u4e9b\u9879\u76ee\u91cc\u4e5f\u53ebE2E (End To End)\u6d4b\u8bd5\uff0c\u4e3b\u8981\u7528\u4e8e\u6d4b\u8bd5\u5404\u4e2a\u6a21\u5757\u7ec4\u88c5\u6210\u4e00\u4e2a\u7cfb\u7edf\u540e\u662f\u5426\u80fd\u7b26\u5408\u9884\u671f\u3002\\n\\nApache ShenYu\u5c06\u96c6\u6210\u6d4b\u8bd5\u653e\u5728\u4e86\u6301\u7eed\u96c6\u6210\u4e2d\uff0c\u5229\u7528GitHub Action\uff0c\u5728\u6bcf\u6b21\u5411\u4e3b\u5206\u652f\u63d0\u4ea4Pull Request\u6216\u662fMerge\u65f6\u89e6\u53d1\u3002\u8fd9\u6837\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u9879\u76ee\u7684\u7ef4\u62a4\u6210\u672c\uff0c\u63d0\u5347Apache ShenYu\u7684\u7a33\u5b9a\u6027\u3002\\n\\n### \u81ea\u52a8\u5316\u7684\u96c6\u6210\u6d4b\u8bd5\u5982\u4f55\u5b9e\u73b0\uff1f\\n\\nApache ShenYu\u4e2d\uff0c\u96c6\u6210\u6d4b\u8bd5\u7684\u4e3b\u8981\u6b65\u9aa4\u4f53\u73b0\u5728GitHub Action\u5de5\u4f5c\u6d41\u7684\u811a\u672c\u4e2d\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u8be5\u811a\u672c\u4f4d\u4e8e [~/.github/workflows](https://github.com/apache/incubator-shenyu/tree/master/.github/workflows)\u76ee\u5f55\u4e0b\u3002\\n\\n```yaml\\nname: it\\non:\\n  pull_request:\\n  push:\\n    branches:\\n      - master\\njobs:\\n  build:\\n    strategy:\\n      matrix:\\n        case:\\n          - shenyu-integrated-test-alibaba-dubbo\\n          ...\\n    runs-on: ubuntu-latest\\n    steps:\\n      - uses: actions/checkout@v2\\n        with:\\n          submodules: true\\n      ...\\n```\\n\\n\u4e0b\u9762\u6211\u5c06\u4ece\u8fd9\u4e2ayaml\u6587\u4ef6\u51fa\u53d1\uff0c\u5e26\u4f60\u5256\u6790\u6574\u4e2a\u81ea\u52a8\u5316\u96c6\u6210\u6d4b\u8bd5\u7684\u6d41\u7a0b\u3002\\n\\n### \u5de5\u4f5c\u6d41\u7684\u89e6\u53d1\\n\\n\u7531\u4e8e\u6211\u4eec\u5728 `on` \u4e2d\u6307\u5b9a\u4e86 `pull_request` \u548c `push.branch: master`\uff0c\u90a3\u4e48\u5f53\u6211\u4eec\u63d0\u4ea4pull_request\u6216\u662fmerge\u5206\u652f\u5230master\uff08push\uff09\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u89e6\u53d1\u8fd9\u4e2a\u5de5\u4f5c\u6d41\u3002\\n\\n\u5173\u4e8e\u66f4\u591aGitHub Action\u7684\u7528\u6cd5\uff0c\u53ef\u4ee5\u53c2\u8003 [GitHub Action](https://docs.github.com/en/actions) \u7684\u6587\u6863\uff0c\u8fd9\u91cc\u4e0d\u4f1a\u505a\u8be6\u7ec6\u7684\u4ecb\u7ecd\u3002\\n\\n### \u521d\u59cb\u5316\u73af\u5883\\n\\n- \u62c9\u53d6\u4ee3\u7801\\n\\n```yaml\\n- uses: actions/checkout@v2\\n  with:\\n \\t    submodules: true\\n```\\n\\n- \u8bbe\u7f6e\u8df3\u8fc7\u6807\u5fd7\\n\\n```yaml\\n- name: Set Skip Env Var\\n      uses: ./.github/actions/skip-ci\\n```\\n\\n\u5f53\u53d1\u751f\u7684\u662f\u4e00\u4e9b\u5bf9\u529f\u80fd\u65e0\u5173\u7684\u6539\u52a8\uff08\u5982\u6539\u52a8\u6587\u6863\uff09\u65f6\uff0c\u4f1a\u8df3\u8fc7\u96c6\u6210\u6d4b\u8bd5\uff0c\u4ee5\u8282\u7ea6\u8d44\u6e90\u3002\\n\\n- \u7f13\u5b58maven\u4f9d\u8d56\u3001\u5b89\u88c5Java\\n\\n```yaml\\n- name: Cache Maven Repos\\n...\\n- uses: actions/setup-java@v1\\n```\\n\\n### \u6784\u5efa\u6574\u4e2a\u9879\u76ee\uff0c\u540c\u65f6\u6784\u5efadocker\u955c\u50cf\\n\\n```shell\\n./mvnw -B clean install -Prelease,docker -Dmaven.javadoc.skip=true -Dmaven.test.skip=true\\n```\\n\\n\u4e0a\u9762\u8fd9\u884c\u547d\u4ee4\u4e2d\uff0c-P\u540e\u9762\u8ddf\u7740`release,docker`\uff0c\u8868\u793a\u4f1a\u6fc0\u6d3bpom\u6587\u4ef6\u4e2d\u76f8\u5173\u7684profile\u914d\u7f6e\u3002\\n\\n\u800crelease\u548cdocker\u8fd9\u4e24\u4e2aprofile\uff0c\u76ee\u524d\u53ea\u5728 `shenyu-dist` \u4e0b\u7684\u51e0\u4e2a\u5b50\u6a21\u5757\u4e2d\u5b58\u5728\u3002\u4e0b\u9762\u5c06\u4ee5 [shenyu-dist-admin](https://github.com/apache/incubator-shenyu/tree/master/shenyu-dist/shenyu-admin-dist) \u6a21\u5757\u4e3a\u4f8b\uff0c\u4ecb\u7ecdprofile\u4e3arelease\u548cdocker\u7684\u914d\u7f6e\u7684\u5177\u4f53\u5185\u5bb9\u3002\u53e6\u5916\uff0c\u96c6\u6210\u6d4b\u8bd5\u53ea\u4f7f\u7528\u4e86\u8fd9\u4e00\u6b65\u6784\u5efa\u7684 `shenyu-admin` \u955c\u50cf\u3002\\n\\n- \u9996\u5148\u662frelease\\n\\n  ```xml\\n  <profile>\\n      <id>release</id>\\n      <activation>\\n          <activeByDefault>false</activeByDefault>\\n      </activation>\\n      <build>\\n          <finalName>apache-shenyu-incubating-${project.version}</finalName>\\n          <plugins>\\n              <plugin>\\n                  <groupId>org.apache.maven.plugins</groupId>\\n                  <artifactId>maven-assembly-plugin</artifactId>\\n                  <executions>\\n                      <execution>\\n                          <id>admin-bin</id>\\n                          <phase>package</phase>\\n                          <goals>\\n                              <goal>single</goal>\\n                          </goals>\\n                      </execution>\\n                  </executions>\\n                  <configuration>\\n                      <descriptors>\\n                          <descriptor>${project.basedir}/src/main/assembly/binary.xml</descriptor>\\n                      </descriptors>\\n                      <tarLongFileMode>posix</tarLongFileMode>\\n                  </configuration>\\n              </plugin>\\n          </plugins>\\n      </build>\\n  </profile>\\n  ```\\n\\n  \u5f53-P\u540e\u9762\u8ddf\u7740release\u65f6\uff0c\u5c31\u4f1a\u6fc0\u6d3b\u4e0a\u9762\u7684 `maven-assembly-plugin` \u63d2\u4ef6\u3002\u800cexecutions\u4e2d\u5c06\u63d2\u4ef6\u7684\u6267\u884c\u65f6\u673a\u7ed1\u5b9a\u5728\u4e86maven\u751f\u547d\u5468\u671fpackage\u4e2d\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\uff0c\u5f53\u6211\u4eec\u6267\u884c `mvn install` \u7684\u65f6\u5019\u5c31\u4f1a\u89e6\u53d1\u3002\\n\\n  configuration\u4e2d\u6307\u5b9a\u4e86\u6211\u4eec\u7f16\u5199\u597d\u7684 `binary.xml`\uff0c`maven-assembly-plugin` \u63d2\u4ef6\u5c06\u4f1a\u6309\u7167\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5c06\u9700\u8981\u7684\u6587\u4ef6\u590d\u5236\u8fdb\u6765\uff0c\u5e76\u6253\u5305\u3002\u4f60\u53ef\u4ee5\u70b9\u51fb\u94fe\u63a5\u67e5\u770b\u8be5\u6587\u4ef6\uff1a[shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml](https://github.com/apache/incubator-shenyu/blob/master/shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml)\\n\\n  \u6839\u636e\u8fd9\u4e2a\u6587\u4ef6\uff0c\u63d2\u4ef6\u4f1a\u5c06\u5176\u4ed6\u6a21\u5757\u4e0b\u6253\u5305\u597d\u7684jar\u5305\u3001\u914d\u7f6e\u6587\u4ef6\u3001\u542f\u52a8\u811a\u672c\u7b49\u201c\u590d\u5236\u201d\u8fc7\u6765\uff0c\u6700\u7ec8\u6253\u6210 `tar.gz` \u683c\u5f0f\u7684\u538b\u7f29\u5305\u3002\\n\\n- \u7136\u540e\u662fdocker\\n\\n  ```xml\\n  <profile>\\n      <id>docker</id>\\n      <activation>\\n          <activeByDefault>false</activeByDefault>\\n      </activation>\\n      <build>\\n          <plugins>\\n              <plugin>\\n                  <groupId>com.spotify</groupId>\\n                  <artifactId>dockerfile-maven-plugin</artifactId>\\n                  <version>${dockerfile-maven-plugin.version}</version>\\n                  <executions>\\n                      <execution>\\n                          <id>tag-latest</id>\\n                          <goals>\\n                              <goal>build</goal>\\n                          </goals>\\n                          <configuration>\\n                              <tag>latest</tag>\\n                          </configuration>\\n                      </execution>\\n                      <execution>\\n                          <id>tag-version</id>\\n                          <goals>\\n                              <goal>build</goal>\\n                          </goals>\\n                          <configuration>\\n                              <tag>${project.version}</tag>\\n                          </configuration>\\n                      </execution>\\n                  </executions>\\n                  <configuration>\\n                      <repository>apache/shenyu-admin</repository>\\n                      <buildArgs>\\n                          <APP_NAME>apache-shenyu-incubating-${project.version}-admin-bin</APP_NAME>\\n                      </buildArgs>\\n                  </configuration>\\n              </plugin>\\n          </plugins>\\n      </build>\\n  </profile>\\n  ```\\n\\n  \u7c7b\u6bd4\u4e0a\u9762\u7684release\uff0c\u8fd9\u91cc\u662f\u6fc0\u6d3b `dockerfile-maven-plugin` \u63d2\u4ef6\u3002\u5f53 `mvn install -Pdocker` \u65f6\uff0c\u63d2\u4ef6\u5c31\u4f1a\u5229\u7528\u6211\u4eec\u7f16\u5199\u597d\u7684dockerfile\u6784\u5efadocker\u955c\u50cf\u3002\\n\\n\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cdockerfile-maven-plugin\u76ee\u524d\u5bf9aarch64\u67b6\u6784\u7684\u8bbe\u5907\u652f\u6301\u6709\u9650\uff0c\u5728aarch64\u67b6\u6784\u7684\u673a\u5668\u4e0a\u8fd0\u884c\u8be5\u63d2\u4ef6\u65f6\u4f1a\u51fa\u73b0\u5982\u4e0b\u9519\u8bef\u3002\u4e14\u5728\u672c\u4eba\u5199\u8fd9\u7bc7\u6587\u7ae0\u7684\u65f6\u5019\u5df2\u7ecf\u5f88\u4e45\u6ca1\u6709\u7ef4\u62a4\uff0c\u8fd9\u610f\u5473\u7740aarch64\u67b6\u6784\u7684\u8bbe\u5907\u4f7f\u7528\u8fd9\u4e2a\u63d2\u4ef6\u7684\u95ee\u9898\u5728\u77ed\u671f\u5185\u4e0d\u4f1a\u89e3\u51b3\u3002\\n\\n```shell\\n[ERROR] Failed to execute goal com.spotify:dockerfile-maven-plugin:1.4.6:build (tag-latest) on project shenyu-admin-dist: Could not build image: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: java.lang.UnsatisfiedLinkError: could not load FFI provider jnr.ffi.provider.jffi.Provider: ExceptionInInitializerError: Can\'t overwrite cause with java.lang.UnsatisfiedLinkError: java.lang.UnsatisfiedLinkError: /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: dlopen(/private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib, 1): no suitable image found.  Did find:\\n[ERROR]         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture in universal wrapper\\n[ERROR]         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture in universal wrapper\\n...\\n```\\n\\n\u8fd9\u91cc\u6709\u4e2a\u4e34\u65f6\u7684\u89e3\u51b3\u65b9\u6848\uff1a\\n\\n1. \u6253\u5f00\u4e00\u4e2a\u65b0\u7684shell\uff0c\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\uff0c\u5229\u7528 socat \u5c06 unix socket \u8def\u7531\u5230 tcp \u7aef\u53e3\\n\\n   ```shell\\n   socat TCP-LISTEN:2375,range=127.0.0.1/32,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock\\n   ```\\n\\n2. \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\\n\\n   ```shell\\n   export DOCKER_HOST=tcp://127.0.0.1:2375\\n   ```\\n\\n### \u6784\u5efaexamples\u6a21\u5757\\n\\n```yaml\\n- name: Build examples\\n  if: env.SKIP_CI != \'true\'\\n  run: ./mvnw -B clean install -Pexample -Dmaven.javadoc.skip=true -Dmaven.test.skip=true -f ./shenyu-examples/pom.xml\\n```\\n\\n\u56e0\u4e3a\u8003\u8651\u5230release\u7684\u9700\u8981\uff0c\u76ee\u524d\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u7684pom\u6587\u4ef6\u4e2d\u4e0d\u9971\u542bexample\u5b50\u6a21\u5757\uff0c\u6240\u4ee5\u4e0a\u9762\u8fd9\u4e2a\u6b65\u9aa4\u53e6\u5916\u6784\u5efa\u4e86examples\u6a21\u5757\u3002\\n\\n\u4e0e\u4e0a\u9762\u7c7b\u4f3c\uff0c\u8fd9\u884c\u547d\u4ee4\u4e5f\u4f1a\u5229\u7528maven\u7684\u63d2\u4ef6\u6784\u5efa\u955c\u50cf\uff0c\u4ee5\u4f9b\u6211\u4eec\u540e\u7eeddocker\u7f16\u6392\u4f7f\u7528\u3002\\n\\n### \u6784\u5efa\u5b9a\u5236\u5316\u7f51\u5173\\n\\n```yaml\\n- name: Build integrated tests\\n  if: env.SKIP_CI != \'true\'\\n  run: ./mvnw -B clean install -Pit -DskipTests -f ./shenyu-integrated-test/pom.xml\\n```\\n\\n\u4e3a\u4e86\u7ec6\u5206Apache ShenYu\u7684\u4e0d\u540c\u529f\u80fd\u7684\u96c6\u6210\u6d4b\u8bd5\uff0c\u6211\u4eec\u5728\u8fd9\u4e00\u6b65\u5c06\u6784\u5efa\u96c6\u6210\u6d4b\u8bd5\u6a21\u5757\u5b9a\u5236\u7684\u7f51\u5173\u3002\u6240\u8c13\u7684\u201c\u5b9a\u5236\u201d\u5c31\u662f\u5728pom\u6587\u4ef6\u4e2d\u5f15\u5165\u9700\u8981\u7684\u6700\u5c11\u4f9d\u8d56\uff0c\u7136\u540e\u4ee3\u66ff\u9ed8\u8ba4\u7684 `shenyu-bootstrap`\u3002\u4e0e\u4e0a\u9762\u4e24\u4e2a\u6b65\u9aa4\u7c7b\u4f3c\uff0c\u8fd9\u4e00\u6b65\u4e5f\u4f1a\u6784\u5efa\u51fadocker\u955c\u50cf\u3002\\n\\n\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u91cc\u7684\u6253\u5305\u6784\u5efa\u7684\u65b9\u5f0f\u4e0e `shenyu-dist` \u6a21\u5757\u7684\u6709\u4e00\u4e9b\u4e0d\u540c\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5bf9\u6bd4pom\u6587\u4ef6\u53d1\u73b0\u3002\\n\\n### \u8fd0\u884cdocker compose\\n\\n```yaml\\n- name: Start docker compose\\n  if: env.SKIP_CI != \'true\'\\n  run: docker-compose -f ./shenyu-integrated-test/${{ matrix.case }}/docker-compose.yml up -d\\n```\\n\\n\u8fd9\u4e00\u6b65\u5c06\u4f1a\u6839\u636e\u96c6\u6210\u6d4b\u8bd5\u6a21\u5757\u4e0b\u7f16\u5199\u597d\u7684\u4e0d\u540c\u7684 `docker-compose.yml` \u6587\u4ef6\uff0c\u8fdb\u884cdocker\u7f16\u6392\u3002\\n\\n```yaml\\nversion: \\"3.9\\"\\nservices:\\n  shenyu-zk:\\n    container_name: shenyu-zk\\n    image: zookeeper:3.5\\n    ...\\n  shenyu-redis:\\n    image: redis:6.0-alpine\\n    container_name: shenyu-redis\\n    ...\\n\\n  shenyu-examples-http:\\n    deploy:\\n      resources:\\n        limits:\\n          memory: 2048M\\n    container_name: shenyu-examples-http\\n    image: shenyu-examples-http:latest\\n    ...\\n\\n  shenyu-admin:\\n    image: apache/shenyu-admin:latest\\n    container_name: shenyu-admin\\n    ...\\n\\n  shenyu-integrated-test-http:\\n    container_name: shenyu-integrated-test-http\\n    image: apache/shenyu-integrated-test-http:latest\\n    ...\\n    depends_on:\\n      shenyu-admin:\\n        condition: service_healthy\\n    healthcheck:\\n      test: [ \\"CMD\\", \\"wget\\", \\"http://shenyu-integrated-test-http:9195/actuator/health\\" ]\\n      timeout: 2s\\n      retries: 30\\n\\nnetworks:\\n  shenyu:\\n    name: shenyu\\n```\\n\\n\u4f8b\u5982 `shenyu-integrated-test-http` \u6a21\u5757\u4e0b\u7684 `docker-compose.yml`\uff0c\u6309\u987a\u5e8f\u542f\u52a8\u4e86zookeeper\u3001redis\u3001example\u3001admin\u3001\u7f51\u5173\u7b49\u670d\u52a1\u3002\u5176\u4e2d\uff0cexample\u3001admin\u3001\u7f51\u5173\u7684\u955c\u50cf\u662f\u6211\u4eec\u4e4b\u524d\u6784\u5efa\u7684\u3002\\n\\n\u5176\u4e2d\uff0cdocker-compose\u5229\u7528 `depends_on` \u786e\u5b9a\u4e86\u670d\u52a1\u4e4b\u95f4\u7684\u62d3\u6251\u5173\u7cfb\uff0c\u5e76\u4e14\u5927\u90e8\u5206\u670d\u52a1\u90fd\u6709\u76f8\u5e94\u7684\u5065\u5eb7\u68c0\u67e5\uff0c\u5f85\u5065\u5eb7\u68c0\u67e5\u901a\u8fc7\u540e\u624d\u4f1a\u542f\u52a8\u4e0b\u4e00\u4e2a\u670d\u52a1\u3002\\n\\n### \u8fd0\u884c\u5065\u5eb7\u68c0\u67e5\uff0c\u7b49\u5f85docker-compose\u542f\u52a8\u5b8c\u6bd5\\n\\n```yaml\\n- name: Wait for docker compose start up completely\\n  if: env.SKIP_CI != \'true\'\\n  run: bash ./shenyu-integrated-test/${{ matrix.case }}/script/healthcheck.sh\\n```\\n\\n\u5728\u8fd9\u4e00\u6b65\uff0c\u5bbf\u4e3b\u673a\u4f1a\u8fd0\u884c `healthcheck.sh` \u8fd9\u4e2a\u811a\u672c\uff0c\u7136\u540e\u5229\u7528 curl \u547d\u4ee4\u8bbf\u95ee\u5404\u4e2a\u670d\u52a1\u5217\u8868\uff08\u5728services.list\u6587\u4ef6\u4e2d\uff09\u7684\u5065\u5eb7\u72b6\u6001\u63a5\u53e3 `/actuator/health`\uff0c\u4e00\u76f4\u5230\u670d\u52a1\u72b6\u6001\u90fd\u4e3a\u6b63\u5e38\u624d\u4f1a\u7ee7\u7eed\u3002\\n\\n### \u8fd0\u884c\u6d4b\u8bd5\\n\\n```yaml\\n- name: Run test\\n  id: test\\n  if: env.SKIP_CI != \'true\'\\n  run: ./mvnw test -Pit -f ./shenyu-integrated-test/${{ matrix.case }}/pom.xml\\n  continue-on-error: true\\n```\\n\\n\u8fd9\u4e00\u6b65\u5c31\u662f\u5229\u7528maven test\u547d\u4ee4\uff0c\u9010\u4e2a\u6267\u884c `/src/test/`  \u76ee\u5f55\u4e0b\u7684\u6d4b\u8bd5\u7c7b\u3002\\n\\n### \u67e5\u770bDocker Compose\u65e5\u5fd7\\n\\n```yaml\\n- name: Check test result\\n  if: env.SKIP_CI != \'true\'\\n  run: |\\n    docker-compose -f ./shenyu-integrated-test/${{ matrix.case }}/docker-compose.yml logs --tail=\\"all\\"\\n    if [[ ${{steps.test.outcome}} == \\"failure\\" ]]; then\\n      echo \\"Test Failed\\"\\n      exit 1\\n    else\\n      echo \\"Test Successful\\"\\n      exit 0\\n    fi\\n```\\n\\n\u5f53\u5de5\u4f5c\u6d41\u51fa\u73b0\u9519\u8bef\u65f6\uff0cdocker compose\u7684\u65e5\u5fd7\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u66f4\u597d\u7684\u6392\u67e5\u95ee\u9898\uff0c\u6240\u4ee5\u5728\u8fd9\u4e00\u6b65\u6211\u4eec\u5c06docker compose\u7684\u65e5\u5fd7\u6253\u5370\u51fa\u6765\u3002"},{"id":"/Loader-SourceCode-Analysis-ExtLoader","metadata":{"permalink":"/zh/blog/Loader-SourceCode-Analysis-ExtLoader","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Loader-SourceCode-Analysis-ExtLoader.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Loader-SourceCode-Analysis-ExtLoader.md","title":"\u6269\u5c55\u63d2\u4ef6\u52a0\u8f7d\u903b\u8f91","description":"\u672c\u6587\u57fa\u4e8eshenyu-2.6.1\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790.","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"plugin","permalink":"/zh/blog/tags/plugin"},{"label":"ext","permalink":"/zh/blog/tags/ext"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":9.695,"hasTruncateMarker":false,"authors":[{"name":"hql0312","title":"hql0312 Coder","url":"https://github.com/hql0312"}],"frontMatter":{"title":"\u6269\u5c55\u63d2\u4ef6\u52a0\u8f7d\u903b\u8f91","author":"hql0312","author_title":"hql0312 Coder","author_url":"https://github.com/hql0312","tags":["plugin","ext","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"\u96c6\u6210\u6d4b\u8bd5\u5256\u6790","permalink":"/zh/blog/IntegrationTest-Analysis"},"nextItem":{"title":"Context-Path\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin"}},"content":"> \u672c\u6587\u57fa\u4e8e`shenyu-2.6.1`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790.\\n\\n# \u6b63\u6587\\n\\nShenyu \u63d0\u4f9b\u4e86\u4e00\u79cd\u673a\u5236\u6765\u5b9a\u5236\u81ea\u5df1\u7684\u63d2\u4ef6\u6216\u662f\u4fee\u6539\u5df2\u6709\u7684\u63d2\u4ef6\uff0c\u5728\u5176\u5185\u90e8\u901a\u8fc7extPlugin\u7684\u914d\u7f6e\u5b9e\u73b0\uff0c\u5176\u9700\u8981\u6ee1\u8db3\u4ee5\u4e0b\u4e24\u70b9\uff1a\\n1. \u5b9e\u73b0\u63a5\u53e3 `ShenyuPlugin` \u6216\u662f `PluginDataHandler`\\n2. \u5c06\u5b9e\u73b0\u7684\u5305\u6253\u5305\u540e\uff0c\u653e\u7f6e\u4e8e`shenyu.extPlugin.path`\u5bf9\u5e94\u7684\u8def\u5f84\u4e0b\\n\\n## \u5165\u53e3\\n\\n\u771f\u6b63\u5b9e\u73b0\u8be5\u903b\u8f91\u7684\u7c7b\u662f`ShenyuLoaderService`,\u63a5\u4e0b\u6765\u770b\u4e0b\u8be5\u7c7b\u662f\u5982\u4f55\u5904\u7406\\n\\n```java\\n    public ShenyuLoaderService(final ShenyuWebHandler webHandler, final CommonPluginDataSubscriber subscriber, final ShenyuConfig shenyuConfig) {\\n        // \u63d2\u4ef6\u4fe1\u606f\u7684\u4fe1\u606f\u8ba2\u9605\\n        this.subscriber = subscriber;\\n        // Shenyu\u5c01\u88c5\u7684WebHandler\uff0c\u5305\u542b\u4e86\u6240\u6709\u7684\u63d2\u4ef6\u903b\u8f91\\n        this.webHandler = webHandler;\\n        // \u914d\u7f6e\u4fe1\u606f\\n        this.shenyuConfig = shenyuConfig;\\n        // \u6269\u5c55\u63d2\u4ef6\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u5982\u8def\u5f84\uff0c\u662f\u5426\u542f\u7528\u3001\u5f00\u542f\u591a\u5c11\u7ebf\u7a0b\u6765\u5904\u7406\u3001\u68c0\u67e5\u52a0\u8f7d\u7684\u9891\u7387\u7b49\u4fe1\u606f\\n        ExtPlugin config = shenyuConfig.getExtPlugin();\\n        // \u5982\u679c\u542f\u7528\u7684\uff0c\u5219\u521b\u5efa\u5b9a\u65f6\u4efb\u52a1\u6765\u68c0\u67e5\u5e76\u52a0\u8f7d\\n        if (config.getEnabled()) {\\n            // \u521b\u5efa\u4e00\u4e2a\u6307\u5b9a\u7ebf\u7a0b\u540d\u79f0\u7684\u5b9a\u65f6\u4efb\u52a1\\n            ScheduledThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(config.getThreads(), ShenyuThreadFactory.create(\\"plugin-ext-loader\\", true));\\n            // \u521b\u5efa\u56fa\u5b9a\u9891\u7387\u6267\u884c\u7684\u4efb\u52a1\uff0c\u9ed8\u8ba4\u572830s\uff0c\u6bcf300s\uff0c\u6267\u884c\u4e00\u6b21\\n            executor.scheduleAtFixedRate(() -> loadExtOrUploadPlugins(null), config.getScheduleDelay(), config.getScheduleTime(), TimeUnit.SECONDS);\\n        }\\n    }\\n    \\n```\\n\\n\u8be5\u7c7b\u6709\u4ee5\u4e0b\u51e0\u4e2a\u5c5e\u6027\uff1a\\n\\n`webHandler`: \u8be5\u7c7b\u662fshenyu \u5904\u7406\u8bf7\u6c42\u7684\u5165\u53e3\uff0c\u5f15\u7528\u4e86\u6240\u6709\u7684\u63d2\u4ef6\u6570\u636e\uff0c\u5728\u6269\u5c55\u63d2\u4ef6\u52a0\u8f7d\u540e\uff0c\u9700\u8981\u8fdb\u884c\u66f4\u65b0\\n\\n`subscriber`: \u8be5\u7c7b\u662f\u63d2\u4ef6\u7684\u8ba2\u9605\u7684\u5165\u53e3\uff0c\u5f15\u7528\u4e86\u6240\u6709\u63d2\u4ef6\u7684\u8ba2\u9605\u5904\u7406\u7c7b\uff0c\u5728\u6269\u5c55\u914d\u7f6e\u52a0\u8f7d\u540e\uff0c\u4e5f\u9700\u8981\u8fdb\u884c\u540c\u6b65\u66f4\u65b0\\n\\n`executor`: \u5728`ShenyuLoaderService`\u5185\u90e8\u4f1a\u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\uff0c\u6765\u5b9a\u65f6\u626b\u63cf\u52a0\u8f7d\u6307\u5b9a\u8def\u5f84\u4e0b\u7684jar\u5305\uff0c\u4fbf\u4e8e\u52a0\u8f7d\u6269\u5c55\u7684\u63d2\u4ef6\uff0c\u5b9e\u73b0\u52a8\u6001\u53d1\u73b0\\n\u9ed8\u8ba4\u4f1a\u5728\u542f\u52a830\u79d2\u540e\uff0c\u6bcf300\u79d2\u626b\u63cf\u4e00\u6b21\\n\\n\u540c\u65f6\u8fd9\u91cc\u53ef\u4ee5\u901a\u8fc7 `shenyu.extPlugin.enabled`\u914d\u7f6e\u6765\u51b3\u5b9a\u662f\u5426\u8981\u5f00\u542f\u6269\u5c55\u63d2\u4ef6\u529f\u80fd\u7684\u542f\u7528\\n\\n\u4ee5\u4e0a\u7684\u914d\u7f6e\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8fdb\u884c\u8c03\u6574\uff1a\\n\\n```yaml\\nshenyu:\\n  extPlugin:\\n    path:   # \u6269\u5c55\u63d2\u4ef6\u7684\u5b58\u50a8\u76ee\u5f55\\n    enabled: true # \u662f\u5426\u542f\u7528\u6269\u5c55\u529f\u80fd\\n    threads: 1 # \u626b\u63cf\u52a0\u8f7d\u7684\u7ebf\u7a0b\u6570\\n    scheduleTime: 300 # \u4efb\u52a1\u6267\u884c\u7684\u9891\u7387\\n    scheduleDelay: 30 # \u4efb\u52a1\u542f\u52a8\u540e\u591a\u4e45\u5f00\u59cb\u6267\u884c\\n```\\n\\n\u63a5\u4e0b\u6765\u770b\u4e0b\u52a0\u8f7d\u7684\u903b\u8f91\uff1a\\n\\n```java\\n   public void loadExtOrUploadPlugins(final PluginData uploadedJarResource) {\\n        try {\\n            List<ShenyuLoaderResult> plugins = new ArrayList<>();\\n            // \u83b7\u53d6ShenyuPluginClassloader\u7684\u6301\u6709\u5bf9\u8c61\\n            ShenyuPluginClassloaderHolder singleton = ShenyuPluginClassloaderHolder.getSingleton();\\n            if (Objects.isNull(uploadedJarResource)) {\\n                // \u53c2\u6570\u4e3a\u7a7a\uff0c\u5219\u4ece\u6269\u5c55\u7684\u76ee\u5f55\uff0c\u52a0\u8f7d\u6240\u6709\u7684jar\u5305\\n                // PluginJar\uff1a\u5305\u542bShenyuPlugin\u63a5\u53e3\u3001PluginDataHandler\u63a5\u53e3\u7684\u6570\u636e\\n                List<PluginJarParser.PluginJar> uploadPluginJars = ShenyuExtPathPluginJarLoader.loadExtendPlugins(shenyuConfig.getExtPlugin().getPath());\\n                // \u904d\u5386\u6240\u6709\u7684\u5f85\u52a0\u8f7d\u63d2\u4ef6\\n                for (PluginJarParser.PluginJar extPath : uploadPluginJars) {\\n                    LOG.info(\\"shenyu extPlugin find new {} to load\\", extPath.getAbsolutePath());\\n                    // \u4f7f\u7528\u6269\u5c55\u63d2\u4ef6\u7684\u52a0\u8f7d\u5668\u6765\u52a0\u8f7d\u6307\u5b9a\u7684\u63d2\u4ef6\uff0c\u4fbf\u4e8e\u540e\u7eed\u7684\u52a0\u8f7d\u548c\u5378\u8f7d\\n                    ShenyuPluginClassLoader extPathClassLoader = singleton.createPluginClassLoader(extPath);\\n                    // \u4f7f\u7528ShenyuPluginClassLoader \u8fdb\u884c\u52a0\u8f7d\\n                    // \u4e3b\u8981\u903b\u8f91\u662f\uff1a\u5224\u65ad\u662f\u5426\u5b9e\u73b0ShenyuPlugin\u63a5\u53e3\u3001PluginDataHandler\u63a5\u53e3 \u6216\u662f\u5426\u6807\u8bc6 @Component\\\\@Service\u7b49\u6ce8\u89e3\uff0c\u5982\u679c\u6709\uff0c\u5219\u6ce8\u518c\u4e3aSpringBean\\n                    // \u6784\u9020 ShenyuLoaderResult\u5bf9\u8c61\\n                    plugins.addAll(extPathClassLoader.loadUploadedJarPlugins());\\n                }\\n            } else {\\n                // \u52a0\u8f7d\u6307\u5b9ajar\uff0c\u903b\u8f91\u540c\u52a0\u8f7d\u5168\u90e8\\n                PluginJarParser.PluginJar pluginJar = PluginJarParser.parseJar(Base64.getDecoder().decode(uploadedJarResource.getPluginJar()));\\n                LOG.info(\\"shenyu upload plugin jar find new {} to load\\", pluginJar.getJarKey());\\n                ShenyuPluginClassLoader uploadPluginClassLoader = singleton.createPluginClassLoader(pluginJar);\\n                plugins.addAll(uploadPluginClassLoader.loadUploadedJarPlugins());\\n            }\\n            // \u5c06\u6269\u5c55\u7684\u63d2\u4ef6\uff0c\u52a0\u5165\u5230ShenyuWebHandler\u7684\u63d2\u4ef6\u5217\u8868\uff0c\u540e\u7eed\u7684\u8bf7\u6c42\u5219\u4f1a\u7ecf\u8fc7\u52a0\u5165\u7684\u63d2\u4ef6\u5185\u5bb9\\n            loaderPlugins(plugins);\\n        } catch (Exception e) {\\n            LOG.error(\\"shenyu plugins load has error \\", e);\\n        }\\n    }\\n```\\n\\n\u8be5\u65b9\u6cd5\u5904\u7406\u7684\u903b\u8f91\uff1a\\n1. \u5224\u65ad\u53c2\u6570uploadedJarResource\u662f\u5426\u6709\u503c\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u4f1a\u52a0\u8f7d\u5168\u90e8\uff0c\u5426\u5219\u52a0\u8f7d\u6307\u5b9a\u8d44\u6e90jar\u5305\u8fdb\u884c\u5904\u7406\\n2. \u4ece `shenyu.extPlugin.path` \u4e2d\u83b7\u53d6\u5230\u6307\u5b9ajar\u5305\uff0c\u5e76\u5c01\u88c5\u6210 PluginJar\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u5305\u542b\u4e86jar\u5305\u4ee5\u4e0b\u4fe1\u606f\\n    - version: \u7248\u672c\u4fe1\u606f\\n    - groupId\uff1a\u5305\u7684groupId\\n    - artifactId: \u5305\u7684 artifactId\\n    - absolutePath\uff1a \u7edd\u5bf9\u8def\u5f84\\n    - clazzMap\uff1aclass\u5bf9\u5e94\u7684\u5b57\u8282\u7801\\n    - resourceMap\uff1ajar\u5305\u7684\u5b57\u8282\u7801\\n3. \u901a\u8fc7`ShenyuPluginClassloaderHolder`\u521b\u5efa\u5bf9\u5e94\u7684ClassLoader,\u5bf9\u5e94\u7684\u7c7b\u662f`ShenyuPluginClassLoader`, \u5e76\u8fdb\u884c\u52a0\u8f7d\u5bf9\u5e94\u7684\u7c7b\\n    - \u8c03\u7528`ShenyuPluginClassLoader.loadUploadedJarPlugins` \u52a0\u8f7d\u5bf9\u5e94\u7684\u7c7b\u5e76\u6ce8\u518c\u6210Spring Bean\uff0c\u8fd9\u6837\u53ef\u4ee5\u4f7f\u7528Spring\u5bb9\u5668\u6765\u7ba1\u7406\\n4. \u8c03\u7528`loaderPlugins`\u65b9\u6cd5\uff0c\u5c06\u6269\u5c55\u7684\u63d2\u4ef6\u66f4\u65b0\u5230 `webHandler` \u4ee5\u53ca `subscriber`\u4e2d\\n\\n## \u63d2\u4ef6\u6ce8\u518c\\n\\n\u5bf9\u4e8e\u63d0\u4f9b\u7684jar\u5305\u91cc\u7684\u5185\u5bb9\uff0c\u52a0\u8f7d\u5668\u53ea\u4f1a\u5904\u7406\u6307\u5b9a\u63a5\u53e3\u7c7b\u578b\u7684\u7c7b\uff0c\u5b9e\u73b0\u903b\u8f91\u5728 `ShenyuPluginClassLoader.loadUploadedJarPlugins()` \u65b9\u6cd5\\n\\n```java\\npublic List<ShenyuLoaderResult> loadUploadedJarPlugins() {\\n        List<ShenyuLoaderResult> results = new ArrayList<>();\\n        // \u6240\u6709\u7684\u7c7b\u6620\u5c04\u5173\u7cfb\\n        Set<String> names = pluginJar.getClazzMap().keySet();\\n        // \u904d\u5386\u6240\u6709\u7684\u7c7b\\n        names.forEach(className -> {\\n            Object instance;\\n            try {\\n                // \u5c1d\u8bd5\u521b\u5efa\u5bf9\u8c61\uff0c\u5982\u679c\u53ef\u4ee5\uff0c\u5219\u52a0\u5165\u5230Spring\u5bb9\u5668\u4e2d\\n                instance = getOrCreateSpringBean(className);\\n                if (Objects.nonNull(instance)) {\\n                    // \u6784\u5efaShenyuLoaderResult\u5bf9\u8c61\\n                    results.add(buildResult(instance));\\n                    LOG.info(\\"The class successfully loaded into a upload-Jar-plugin {} is registered as a spring bean\\", className);\\n                }\\n            } catch (ClassNotFoundException | IllegalAccessException | InstantiationException e) {\\n                LOG.warn(\\"Registering upload-Jar-plugins succeeds spring bean fails:{}\\", className, e);\\n            }\\n        });\\n        return results;\\n    }\\n```\\n\\n\u8be5\u65b9\u6cd5\u5c31\u662f\u8d1f\u8d23\u6784\u5efa\u6240\u6709\u7b26\u5408\u6761\u4ef6\u7684\u5bf9\u8c61\uff0c\u5e76\u5c01\u88c5\u6210 `ShenyuLoaderResult`\u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u5bf9\u4e8e\u521b\u5efa\u540e\u5bf9\u8c61\uff0c\u8fdb\u884c\u4e86\u5c01\u88c5\uff0c\u4f1a\u5728\u65b9\u6cd5 `buildResult()`\u4e2d\u8fdb\u884c\u5904\u7406\\n\\n```java\\n    private ShenyuLoaderResult buildResult(final Object instance) {\\n        ShenyuLoaderResult result = new ShenyuLoaderResult();\\n        // \u521b\u5efa\u7684\u5bf9\u8c61\u662f\u5426\u5b9e\u73b0\u4e86ShenyuPlugin\\n        if (instance instanceof ShenyuPlugin) {\\n            result.setShenyuPlugin((ShenyuPlugin) instance);\\n            // \u521b\u5efa\u7684\u5bf9\u8c61\u662f\u5426\u5b9e\u73b0\u4e86PluginDataHandler\\n        } else if (instance instanceof PluginDataHandler) {\\n            result.setPluginDataHandler((PluginDataHandler) instance);\\n        }\\n        return result;\\n    }\\n```\\n\\n\u540c\u65f6\u8fdb\u5165\u65b9\u6cd5 `getOrCreateSpringBean()` \u8fdb\u4e00\u6b65\u5206\u6790\\n\\n```java\\n    private <T> T getOrCreateSpringBean(final String className) throws ClassNotFoundException, IllegalAccessException, InstantiationException {\\n        // \u786e\u8ba4\u662f\u5426\u5df2\u7ecf\u6ce8\u518c\u8fc7\u4e86\uff0c\u5982\u679c\u6709\u5219\u4e0d\u5904\u7406\uff0c\u76f4\u63a5\u8fd4\u56de\\n        if (SpringBeanUtils.getInstance().existBean(className)) {\\n            return SpringBeanUtils.getInstance().getBeanByClassName(className);\\n        }\\n        lock.lock();\\n        try {\\n            // Double check,\\n            T inst = SpringBeanUtils.getInstance().getBeanByClassName(className);\\n            if (Objects.isNull(inst)) {\\n                // \u4f7f\u7528 ShenyuPluginClassLoader \u8fdb\u884c\u52a0\u8f7d\u7c7b\\n                Class<?> clazz = Class.forName(className, false, this);\\n                //Exclude ShenyuPlugin subclass and PluginDataHandler subclass\\n                // without adding @Component @Service annotation\\n                // \u786e\u8ba4\u662f\u5426\u662f ShenyuPlugin \u6216\u662f PluginDataHandler\u7684\u5b50\u7c7b\\n                boolean next = ShenyuPlugin.class.isAssignableFrom(clazz)\\n                        || PluginDataHandler.class.isAssignableFrom(clazz);\\n                if (!next) {\\n                    // \u5982\u679c\u4e0d\u662f\uff0c\u786e\u8ba4\u662f\u5426\u6807\u8bc6\u4e86 @Component \u4e0e @Service \u6ce8\u89e3\\n                    Annotation[] annotations = clazz.getAnnotations();\\n                    next = Arrays.stream(annotations).anyMatch(e -> e.annotationType().equals(Component.class)\\n                            || e.annotationType().equals(Service.class));\\n                }\\n                if (next) {\\n                    // \u5982\u679c\u7b26\u5408\u4ee5\u4e0a\u5185\u5bb9\uff0c\u5219\u6ce8\u518cBean\\n                    GenericBeanDefinition beanDefinition = new GenericBeanDefinition();\\n                    beanDefinition.setBeanClassName(className);\\n                    beanDefinition.setAutowireCandidate(true);\\n                    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\\n                    // \u6ce8\u518cbean\\n                    String beanName = SpringBeanUtils.getInstance().registerBean(beanDefinition, this);\\n                    // \u521b\u5efa\u5bf9\u8c61\\n                    inst = SpringBeanUtils.getInstance().getBeanByClassName(beanName);\\n                }\\n            }\\n            return inst;\\n        } finally {\\n            lock.unlock();\\n        }\\n    }\\n```\\n\\n\u903b\u8f91\u5927\u81f4\u5982\u4e0b\uff1a\\n1. \u5224\u65ad\u662f\u5426\u5b9e\u73b0\u4e86\u63a5\u53e3 `ShenyuPlugin` \u6216 `PluginDataHandler`, \u5982\u679c\u6ca1\u6709\uff0c\u5219\u662f\u5426\u6807\u8bc6\u4e86 `@Component` \u6216\u662f `@Service`\\n2. \u5982\u679c\u7b26\u54081\u7684\u6761\u4ef6\uff0c\u5219\u5c06\u8be5\u5bf9\u8c61\u6ce8\u518c\u5230Spring \u5bb9\u5668\uff0c\u5e76\u8fd4\u56de\u521b\u5efa\u7684\u5bf9\u8c61\\n\\n## \u540c\u6b65\\n\\n\u5728\u63d2\u4ef6\u6ce8\u518c\u6210\u529f\u540e\uff0c\u8fd9\u65f6\u53ea\u662f\u5b9e\u4f8b\u5316\u4e86\u63d2\u4ef6\uff0c\u4f46\u5b83\u8fd8\u4e0d\u4f1a\u751f\u6548\uff0c\u56e0\u4e3a\u5b83\u8fd8\u672a\u6dfb\u52a0\u5230 Shenyu\u7684\u63d2\u4ef6\u94fe\u4e2d\uff0c\u540c\u6b65\u903b\u8f91\u7531 `loaderPlugins()`\u65b9\u6cd5\u5b9e\u73b0\\n\\n```java\\n    private void loaderPlugins(final List<ShenyuLoaderResult> results) {\\n        if (CollectionUtils.isEmpty(results)) {\\n            return;\\n        }\\n        // \u83b7\u53d6\u6240\u6709\u5b9e\u73b0\u4e86\u63a5\u53e3ShenyuPlugin\u7684\u5bf9\u8c61\\n        List<ShenyuPlugin> shenyuExtendPlugins = results.stream().map(ShenyuLoaderResult::getShenyuPlugin).filter(Objects::nonNull).collect(Collectors.toList());\\n        // \u540c\u6b65\u66f4\u65b0webHandler\u4e2dplugins\\n        webHandler.putExtPlugins(shenyuExtendPlugins);\\n        // \u83b7\u53d6\u6240\u6709\u5b9e\u73b0\u4e86\u63a5\u53e3PluginDataHandler\u7684\u5bf9\u8c61\\n        List<PluginDataHandler> handlers = results.stream().map(ShenyuLoaderResult::getPluginDataHandler).filter(Objects::nonNull).collect(Collectors.toList());\\n        // \u540c\u6b65\u6269\u5c55\u7684PluginDataHandler\\n        subscriber.putExtendPluginDataHandler(handlers);\\n\\n    }\\n```\\n\\n\u8be5\u65b9\u6cd5\u7684\u903b\u8f91\u5904\u7406\u4e86\u4e24\u4e2a\u6570\u636e\uff1a\\n1. \u5c06\u5b9e\u73b0\u4e86 `ShenyuPlugin` \u63a5\u53e3\u7684\u6570\u636e\uff0c\u540c\u6b65\u81f3 `webHandler`\u7684plugins \u5217\u8868\\n\\n```java\\n    public void putExtPlugins(final List<ShenyuPlugin> extPlugins) {\\n        if (CollectionUtils.isEmpty(extPlugins)) {\\n            return;\\n        }\\n        // \u8fc7\u6ee4\u51fa\u65b0\u589e\u7684\u63d2\u4ef6\\n        final List<ShenyuPlugin> shenyuAddPlugins = extPlugins.stream()\\n                .filter(e -> plugins.stream().noneMatch(plugin -> plugin.named().equals(e.named())))\\n                .collect(Collectors.toList());\\n        // \u8fc7\u6ee4\u51fa\u66f4\u65b0\u7684\u63d2\u4ef6\uff0c\u4ee5\u540d\u79f0\u548c\u65e7\u7684\u76f8\u540c\u6765\u5224\u65ad\uff0c\u5219\u4e3a\u66f4\u65b0\\n        final List<ShenyuPlugin> shenyuUpdatePlugins = extPlugins.stream()\\n                .filter(e -> plugins.stream().anyMatch(plugin -> plugin.named().equals(e.named())))\\n                .collect(Collectors.toList());\\n        // \u5982\u679c\u6ca1\u6709\u6570\u636e\uff0c\u5219\u8df3\u8fc7\\n        if (CollectionUtils.isEmpty(shenyuAddPlugins) && CollectionUtils.isEmpty(shenyuUpdatePlugins)) {\\n            return;\\n        }\\n        // \u590d\u5236\u65e7\u7684\u6570\u636e\\n        // copy new list\\n        List<ShenyuPlugin> newPluginList = new ArrayList<>(plugins);\\n        // \u6dfb\u52a0\u65b0\u7684\u63d2\u4ef6\u6570\u636e\\n        // Add extend plugin from pluginData or shenyu ext-lib\\n        this.sourcePlugins.addAll(shenyuAddPlugins);\\n        // \u6dfb\u52a0\u65b0\u6570\u636e\\n        if (CollectionUtils.isNotEmpty(shenyuAddPlugins)) {\\n            shenyuAddPlugins.forEach(plugin -> LOG.info(\\"shenyu auto add extends plugins:{}\\", plugin.named()));\\n            newPluginList.addAll(shenyuAddPlugins);\\n        }\\n        // \u4fee\u6539\u66f4\u65b0\u7684\u6570\u636e\\n        if (CollectionUtils.isNotEmpty(shenyuUpdatePlugins)) {\\n            shenyuUpdatePlugins.forEach(plugin -> LOG.info(\\"shenyu auto update extends plugins:{}\\", plugin.named()));\\n            for (ShenyuPlugin updatePlugin : shenyuUpdatePlugins) {\\n                for (int i = 0; i < newPluginList.size(); i++) {\\n                    if (newPluginList.get(i).named().equals(updatePlugin.named())) {\\n                        newPluginList.set(i, updatePlugin);\\n                    }\\n                }\\n                for (int i = 0; i < this.sourcePlugins.size(); i++) {\\n                    if (this.sourcePlugins.get(i).named().equals(updatePlugin.named())) {\\n                        this.sourcePlugins.set(i, updatePlugin);\\n                    }\\n                }\\n            }\\n        }\\n        // \u91cd\u65b0\u6392\u5e8f\\n        plugins = sortPlugins(newPluginList);\\n    }\\n```\\n\\n2. \u5c06\u5b9e\u73b0\u4e86 `PluginDataHandler` \u63a5\u53e3\u7684\u6570\u636e\uff0c\u540c\u6b65\u81f3 `subscriber` \u7684handlers \u5217\u8868\\n\\n```java\\n    public void putExtendPluginDataHandler(final List<PluginDataHandler> handlers) {\\n        if (CollectionUtils.isEmpty(handlers)) {\\n            return;\\n        }\\n        // \u904d\u5386\u6240\u6709\u6570\u636e\\n        for (PluginDataHandler handler : handlers) {\\n            String pluginNamed = handler.pluginNamed();\\n            // \u66f4\u65b0\u73b0\u6709\u7684PluginDataHandler\u5217\u8868\\n            MapUtils.computeIfAbsent(handlerMap, pluginNamed, name -> {\\n                LOG.info(\\"shenyu auto add extends plugin data handler name is :{}\\", pluginNamed);\\n                return handler;\\n            });\\n        }\\n    }\\n```\\n\\n\u81f3\u6b64\uff0c\u6269\u5c55\u63d2\u4ef6\u7684\u52a0\u8f7d\u8fc7\u7a0b\u5206\u6790\u7ed3\u675f\u3002"},{"id":"/Plugin-SourceCode-Analysis-Context-Path-Plugin","metadata":{"permalink":"/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Context-Path-Plugin.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Context-Path-Plugin.md","title":"Context-Path\u63d2\u4ef6\u6e90\u7801\u5206\u6790","description":"\u5f00\u59cb\u524d\uff0c\u53ef\u4ee5\u53c2\u8003 \u8fd9\u7bc7\u6587\u7ae0 \u8fd0\u884cshenyu\u7f51\u5173","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"Context-Path","permalink":"/zh/blog/tags/context-path"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":2.41,"hasTruncateMarker":false,"authors":[{"name":"Kunshuai Zhu","title":"Apache ShenYu Contributor","url":"https://github.com/JooKS-me","imageURL":"https://avatars1.githubusercontent.com/u/62384022?v=4"}],"frontMatter":{"title":"Context-Path\u63d2\u4ef6\u6e90\u7801\u5206\u6790","author":"Kunshuai Zhu","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/JooKS-me","author_image_url":"https://avatars1.githubusercontent.com/u/62384022?v=4","tags":["Context-Path","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"\u6269\u5c55\u63d2\u4ef6\u52a0\u8f7d\u903b\u8f91","permalink":"/zh/blog/Loader-SourceCode-Analysis-ExtLoader"},"nextItem":{"title":"Divide\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin"}},"content":"> \u5f00\u59cb\u524d\uff0c\u53ef\u4ee5\u53c2\u8003 [\u8fd9\u7bc7\u6587\u7ae0](./Start-SourceCode-Analysis-Start-Demo) \u8fd0\u884cshenyu\u7f51\u5173\\n\\n### \u6b63\u6587\\n\\n\u9996\u5148\uff0c\u770b`ContextPathPlugin#doExecute`\u65b9\u6cd5\uff0c\u8fd9\u662f\u8fd9\u4e2a\u63d2\u4ef6\u7684\u6838\u5fc3\u3002\\n\\n```java\\nprotected Mono<Void> doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {\\n    ...\\n    // 1. \u4eceJVM\u7f13\u5b58\u4e2d\u53d6\u5f97contextMappingHandle\\n    ContextMappingHandle contextMappingHandle = ContextPathPluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));\\n    ...\\n    // 2. \u6839\u636econtextMappingHandle\u8bbe\u7f6eshenyu\u4e0a\u4e0b\u6587\\n    buildContextPath(shenyuContext, contextMappingHandle);\\n    return chain.execute(exchange);\\n}\\n```\\n\\n1. \u4eceJVM\u7f13\u5b58\u4e2d\u53d6\u5f97`contextMappingHandle`\\n\\n   \u8fd9\u91cc\u7684`contextMappingHandle`\u662f`ContextMappingHandle`\u7c7b\u7684\u5b9e\u4f8b\uff0c\u91cc\u9762\u6709\u4e24\u4e2a\u6210\u5458\u53d8\u91cf\uff1a`contextPath`\u548c`addPrefix`\\n\\n   \u8fd9\u4e24\u4e2a\u53d8\u91cf\u5728\u4e4b\u524dAdmin\u91cc\u9762\u7684Rules\u8868\u5355\u91cc\u6709\u51fa\u73b0\u8fc7\uff0c\u662f\u5728\u6570\u636e\u540c\u6b65\u7684\u65f6\u5019\u66f4\u65b0\u7684\u3002\\n\\n2. \u6839\u636econtextMappingHandle\u8bbe\u7f6eshenyu\u4e0a\u4e0b\u6587\\n\\n   \u4e0b\u9762\u662f`ContextPathPlugin#buildContextPath`\u65b9\u6cd5\u7684\u6e90\u4ee3\u7801\\n\\n   ```java\\n   private void buildContextPath(final ShenyuContext context, final ContextMappingHandle handle) {\\n       String realURI = \\"\\";\\n       // 1. \u8bbe\u7f6eshenyu\u7684context path\uff0c\u6839\u636econtextPath\u7684\u957f\u5ea6\u5c06\u771f\u5b9eURI\u7684\u524d\u7f00\u53bb\u6389\\n       if (StringUtils.isNoneBlank(handle.getContextPath())) {\\n           context.setContextPath(handle.getContextPath());\\n           context.setModule(handle.getContextPath());\\n           realURI = context.getPath().substring(handle.getContextPath().length());\\n       }\\n       // \u52a0\u4e0a\u524d\u7f00\\n       if (StringUtils.isNoneBlank(handle.getAddPrefix())) {\\n           if (StringUtils.isNotBlank(realURI)) {\\n               realURI = handle.getAddPrefix() + realURI;\\n           } else {\\n               realURI = handle.getAddPrefix() + context.getPath();\\n           }\\n       }\\n       context.setRealUrl(realURI);\\n   }\\n   ```\\n\\n    - \u8bbe\u7f6eshenyu\u7684context path\uff0c**\u6839\u636econtextPath\u7684\u957f\u5ea6\u5c06\u771f\u5b9eURI\u7684\u524d\u7f00\u53bb\u6389**\\n\\n      \u4f60\u53ef\u80fd\u4f1a\u6709\u7591\u95ee\uff0c**\u8fd9\u91cc\u6240\u8c13\u7684\u300c\u6839\u636econtextPath\u7684\u957f\u5ea6\u300d\u4f1a\u4e0d\u4f1a\u6709\u95ee\u9898\u5462\uff1f**\\n\\n      \u5b9e\u9645\u4e0a\u8fd9\u6837\u7684\u5224\u65ad\u662f\u6ca1\u6709\u95ee\u9898\u7684\uff0c\u56e0\u4e3a\u8bf7\u6c42\u5728\u88abSelector\u548cRules\u5339\u914d\u5230\u4e4b\u540e\uff0c\u624d\u4f1a\u88ab\u63d2\u4ef6\u5904\u7406\u3002\u6240\u4ee5\u5728\u8bbe\u7f6e\u597dSelector\u548cRules\u7684\u524d\u63d0\u4e0b\uff0c\u662f\u5b8c\u5168\u53ef\u4ee5\u6ee1\u8db3\u8f6c\u6362\u7279\u5b9acontextPath\u7684\u9700\u6c42\u7684\u3002\\n\\n\u7136\u540e\uff0c`ContextPathPlugin`\u7c7b\u8fd8\u6709\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u65b9\u6cd5`skip`\uff0c\u4e0b\u9762\u5c55\u793a\u4e86\u90e8\u5206\u4ee3\u7801\u3002\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff1a**\u5982\u679c\u662f\u5bf9RPC\u670d\u52a1\u7684\u8c03\u7528\uff0c\u5c31\u4f1a\u76f4\u63a5\u8df3\u8fc7context_path\u63d2\u4ef6\u3002**\\n\\n```java\\npublic Boolean skip(final ServerWebExchange exchange) {\\n    ...\\n    return Objects.equals(rpcType, RpcTypeEnum.DUBBO.getName())\\n            || Objects.equals(rpcType, RpcTypeEnum.GRPC.getName())\\n            || Objects.equals(rpcType, RpcTypeEnum.TARS.getName())\\n            || Objects.equals(rpcType, RpcTypeEnum.MOTAN.getName())\\n            || Objects.equals(rpcType, RpcTypeEnum.SOFA.getName());\\n}\\n```\\n\\n\u6700\u540e\uff0ccontext_path\u63d2\u4ef6\u8fd8\u6709\u53e6\u4e00\u4e2a\u7c7b`ContextPathPluginDataHandler`\u3002\u8fd9\u4e2a\u7c7b\u7684\u4f5c\u7528\u662f\u8ba2\u9605\u63d2\u4ef6\u7684\u6570\u636e\uff0c\u5f53\u63d2\u4ef6\u914d\u7f6e\u88ab\u4fee\u6539\u3001\u5220\u9664\u3001\u589e\u52a0\u65f6\uff0c\u5c31\u5f80JVM\u7f13\u5b58\u91cc\u9762\u4fee\u6539\u3001\u5220\u9664\u3001\u65b0\u589e\u6570\u636e\u3002"},{"id":"/Plugin-SourceCode-Analysis-Divide-Plugin","metadata":{"permalink":"/zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Divide-Plugin.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Divide-Plugin.md","title":"Divide\u63d2\u4ef6\u6e90\u7801\u5206\u6790","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"plugin","permalink":"/zh/blog/tags/plugin"},{"label":"divide","permalink":"/zh/blog/tags/divide"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":26.27,"hasTruncateMarker":false,"authors":[{"name":"midnight2104","title":"Apache ShenYu Committer","url":"https://github.com/midnight2104"}],"frontMatter":{"title":"Divide\u63d2\u4ef6\u6e90\u7801\u5206\u6790","author":"midnight2104","author_title":"Apache ShenYu Committer","author_url":"https://github.com/midnight2104","tags":["plugin","divide","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Context-Path\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin"},"nextItem":{"title":"Dubbo\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin"}},"content":"> [Apache ShenYu](https://shenyu.apache.org/zh/docs/index) \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 `API` \u7f51\u5173\u3002\\n\\n`ShenYu` \u7f51\u5173\u4f7f\u7528 `divide` \u63d2\u4ef6\u6765\u5904\u7406 `http` \u8bf7\u6c42\u3002\u4f60\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 [Http\u5feb\u901f\u5f00\u59cb](https://shenyu.apache.org/zh/docs/next/quick-start/quick-start-http) \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8be5\u63d2\u4ef6\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.4.3`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [Http\u670d\u52a1\u63a5\u5165](https://shenyu.apache.org/zh/docs/user-guide/proxy/http-proxy) \u3002\\n\\n\\n### 1. \u670d\u52a1\u6ce8\u518c\\n\\n#### 1.1  \u58f0\u660e\u6ce8\u518c\u63a5\u53e3\\n\\n\u4f7f\u7528\u6ce8\u89e3`@ShenyuSpringMvcClient`\u5c06\u670d\u52a1\u6ce8\u518c\u5230\u7f51\u5173\u3002\u7b80\u5355`demo`\u5982\u4e0b\uff1a\\n\\n```java\\n@RestController\\n@RequestMapping(\\"/order\\")\\n@ShenyuSpringMvcClient(path = \\"/order\\")  // API\u6ce8\u518c\\npublic class OrderController {\\n    @GetMapping(\\"/findById\\")\\n    @ShenyuSpringMvcClient(path = \\"/findById\\", desc = \\"Find by id\\") // \u65b9\u6cd5\u6ce8\u518c\\n    public OrderDTO findById(@RequestParam(\\"id\\") final String id) {\\n        return build(id, \\"hello world findById\\");\\n    }\\n}\\n```\\n\\n\u6ce8\u89e3\u5b9a\u4e49\uff1a\\n\\n```java\\n\\n/**\\n * \u4f5c\u7528\u4e8e\u7c7b\u548c\u65b9\u6cd5\u4e0a\\n */\\n@Retention(RetentionPolicy.RUNTIME)\\n@Target({ElementType.TYPE, ElementType.METHOD})\\npublic @interface ShenyuSpringMvcClient {\\n    \\n\\t//\u6ce8\u518c\u8def\u5f84\\n    String path() default \\"\\";\\n    \\n    //\u89c4\u5219\u540d\u79f0\\n    String ruleName() default \\"\\";\\n   \\n    //\u63cf\u8ff0\u4fe1\u606f\\n    String desc() default \\"\\";\\n\\n    //\u662f\u5426\u542f\u7528\\n    boolean enabled() default true;\\n    \\n    //\u6ce8\u518c\u5143\u6570\u636e\\n    boolean registerMetaData() default false;\\n}\\n\\n```\\n\\n#### 1.2 \u626b\u63cf\u6ce8\u89e3\u4fe1\u606f\\n\\n\u6ce8\u89e3\u626b\u63cf\u901a\u8fc7`SpringMvcClientBeanPostProcessor`\u5b8c\u6210\uff0c\u5b83\u5b9e\u73b0\u4e86`BeanPostProcessor`\u63a5\u53e3\uff0c\u662f`Spring`\u63d0\u4f9b\u7684\u540e\u7f6e\u5904\u7406\u5668\u3002\\n\\n\u5728\u6784\u9020\u5668\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\uff1a\\n\\n- \u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\\n- \u6dfb\u52a0\u6ce8\u89e3\uff0c\u8bfb\u53d6`path`\u4fe1\u606f\\n- \u542f\u52a8\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5411`shenyu-admin`\u6ce8\u518c\\n\\n```java\\npublic class SpringMvcClientBeanPostProcessor implements BeanPostProcessor {\\n    //...\\n    /**\\n     * \u6784\u9020\u5668\u5b9e\u4f8b\u5316\\n     */\\n    public SpringMvcClientBeanPostProcessor(final PropertiesConfig clientConfig,\\n                                            final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\\n        // 1. \u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\\n        Properties props = clientConfig.getProps();\\n        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);\\n        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH, \\"\\");\\n        if (StringUtils.isBlank(appName) && StringUtils.isBlank(contextPath)) {\\n            String errorMsg = \\"http register param must config the appName or contextPath\\";\\n            LOG.error(errorMsg);\\n            throw new ShenyuClientIllegalArgumentException(errorMsg);\\n        }\\n        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));\\n        // 2. \u6dfb\u52a0\u6ce8\u89e3\\n        mappingAnnotation.add(ShenyuSpringMvcClient.class);\\n        mappingAnnotation.add(PostMapping.class);\\n        mappingAnnotation.add(GetMapping.class);\\n        mappingAnnotation.add(DeleteMapping.class);\\n        mappingAnnotation.add(PutMapping.class);\\n        mappingAnnotation.add(RequestMapping.class);\\n        // 3. \u542f\u52a8\u6ce8\u518c\u4e2d\u5fc3\\n        publisher.start(shenyuClientRegisterRepository);\\n    }\\n    \\n    @Override\\n    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {\\n       // \u91cd\u5199\u540e\u7f6e\u5904\u7406\u5668\u903b\u8f91\\n        \\n        return bean;\\n    }\\n    \\n```\\n\\n- SpringMvcClientBeanPostProcessor#postProcessAfterInitialization()\\n\\n\u91cd\u5199\u540e\u7f6e\u5904\u7406\u5668\u903b\u8f91\uff1a\u8bfb\u53d6\u6ce8\u89e3\u4fe1\u606f\uff0c\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\u548c`URI`\u5bf9\u8c61\uff0c\u5e76\u5411`shenyu-admin`\u6ce8\u518c\u3002\\n\\n```java\\n    @Override\\n    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {\\n        // 1. \u5982\u679c\u662f\u6ce8\u518c\u6574\u4e2a\u670d\u52a1\u6216\u8005\u4e0d\u662fController\u7c7b\uff0c\u5c31\u4e0d\u5904\u7406\\n        if (Boolean.TRUE.equals(isFull) || !hasAnnotation(bean.getClass(), Controller.class)) {\\n            return bean;\\n        }\\n        // 2. \u8bfb\u53d6\u7c7b\u4e0a\u7684\u6ce8\u89e3 ShenyuSpringMvcClient\\n        final ShenyuSpringMvcClient beanShenyuClient = AnnotationUtils.findAnnotation(bean.getClass(), ShenyuSpringMvcClient.class);\\n        // 2.1\u6784\u5efasuperPath\\n        final String superPath = buildApiSuperPath(bean.getClass());\\n        // 2.2 \u662f\u5426\u6ce8\u518c\u6574\u4e2a\u7c7b\u65b9\u6cd5\\n        if (Objects.nonNull(beanShenyuClient) && superPath.contains(\\"*\\")) {\\n            // \u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u7136\u540e\u5411shenyu-admin\u6ce8\u518c\\n            publisher.publishEvent(buildMetaDataDTO(beanShenyuClient, pathJoin(contextPath, superPath)));\\n            return bean;\\n        }\\n        // 3. \u8bfb\u53d6\u6240\u6709\u65b9\u6cd5\\n        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(bean.getClass());\\n        for (Method method : methods) {\\n            // 3.1 \u8bfb\u53d6\u65b9\u6cd5\u4e0a\u7684\u6ce8\u89e3 ShenyuSpringMvcClient\\n            ShenyuSpringMvcClient methodShenyuClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);\\n            // \u5982\u679c\u65b9\u6cd5\u4e0a\u9762\u6ca1\u6709\u6ce8\u89e3\uff0c\u5c31\u7528\u7c7b\u4e0a\u9762\u7684\u6ce8\u89e3\\n            methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;\\n            if (Objects.nonNull(methodShenyuClient)) {\\n               // 3.2 \u6784\u5efapath\u4fe1\u606f\uff0c\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u5411shenyu-admin\u6ce8\u518c\\n                publisher.publishEvent(buildMetaDataDTO(methodShenyuClient, buildApiPath(method, superPath)));\\n            }\\n        }\\n        \\n        return bean;\\n    }\\n```\\n\\n- 1.\u5982\u679c\u662f\u6ce8\u518c\u6574\u4e2a\u670d\u52a1\u6216\u8005\u4e0d\u662f`Controller`\u7c7b\uff0c\u5c31\u4e0d\u5904\u7406\\n- 2.\u8bfb\u53d6\u7c7b\u4e0a\u7684\u6ce8\u89e3 `ShenyuSpringMvcClient`\uff0c\u5982\u679c\u662f\u6ce8\u518c\u6574\u4e2a\u7c7b\uff0c\u5c31\u5728\u8fd9\u91cc\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u7136\u540e\u5411`shenyu-admin`\u6ce8\u518c\\n- 3.\u5904\u7406\u65b9\u6cd5\u4e0a\u7684\u6ce8\u89e3 `ShenyuSpringMvcClient`\uff0c\u9488\u5bf9\u7279\u5b9a\u65b9\u6cd5\u6784\u5efa`path`\u4fe1\u606f\uff0c\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u7136\u540e\u5411`shenyu-admin`\u6ce8\u518c\\n\\n\\n\\n\u8fd9\u91cc\u6709\u4e24\u4e2a\u53d6`path`\u7684\u65b9\u6cd5\uff0c\u9700\u8981\u7279\u522b\u8bf4\u660e\u4e00\u4e0b\uff1a\\n\\n- buildApiSuperPath()\\n\\n  \u6784\u9020`SuperPath`\uff1a\u5148\u4ece\u7c7b\u4e0a\u7684\u6ce8\u89e3`ShenyuSpringMvcClient`\u53d6`path`\u5c5e\u6027\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u4ece\u5f53\u524d\u7c7b\u7684`RequestMapping`\u6ce8\u89e3\u4e2d\u53d6`path`\u4fe1\u606f\u3002\\n\\n```java\\n    private String buildApiSuperPath(@NonNull final Class<?> method) {\\n        // \u5148\u4ece\u7c7b\u4e0a\u7684\u6ce8\u89e3ShenyuSpringMvcClient\u53d6path\u5c5e\u6027\\n        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);\\n        if (Objects.nonNull(shenyuSpringMvcClient) && StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {\\n            return shenyuSpringMvcClient.path();\\n        }\\n        // \u4ece\u5f53\u524d\u7c7b\u7684RequestMapping\u6ce8\u89e3\u4e2d\u53d6path\u4fe1\u606f\\n        RequestMapping requestMapping = AnnotationUtils.findAnnotation(method, RequestMapping.class);\\n        if (Objects.nonNull(requestMapping) && ArrayUtils.isNotEmpty(requestMapping.path()) && StringUtils.isNotBlank(requestMapping.path()[0])) {\\n            return requestMapping.path()[0];\\n        }\\n        return \\"\\";\\n    }\\n```\\n\\n- buildApiPath()\\n\\n  \u6784\u5efa`path`\uff1a\u5148\u8bfb\u53d6\u65b9\u6cd5\u4e0a\u7684\u6ce8\u89e3`ShenyuSpringMvcClient`\uff0c\u5982\u679c\u5b58\u5728\u5c31\u6784\u5efa\uff1b\u5426\u5219\u4ece\u65b9\u6cd5\u7684\u5176\u4ed6\u6ce8\u89e3\u4e0a\u83b7\u53d6`path`\u4fe1\u606f\uff1b\u5b8c\u6574\u7684`path = contextPath(\u4e0a\u4e0b\u6587\u4fe1\u606f)+superPath(\u7c7b\u4fe1\u606f)+methodPath(\u65b9\u6cd5\u4fe1\u606f)`\u3002\\n\\n```java\\n    private String buildApiPath(@NonNull final Method method, @NonNull final String superPath) {\\n        // 1. \u8bfb\u53d6\u65b9\u6cd5\u4e0a\u7684\u6ce8\u89e3ShenyuSpringMvcClient\\n        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);\\n        // 1.1\u5982\u679c\u5b58\u5728path\uff0c\u5c31\u6784\u5efa\\n        if (Objects.nonNull(shenyuSpringMvcClient) && StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {\\n            //1.2\u5b8c\u6574 path = contextPath+superPath+methodPath\\n            return pathJoin(contextPath, superPath, shenyuSpringMvcClient.path());\\n        }\\n        // 2.\u4ece\u65b9\u6cd5\u7684\u5176\u4ed6\u6ce8\u89e3\u4e0a\u83b7\u53d6path\u4fe1\u606f\\n        final String path = getPathByMethod(method);\\n        if (StringUtils.isNotBlank(path)) {\\n             // 2.1 \u5b8c\u6574\u7684path = contextPath+superPath+methodPath\\n            return pathJoin(contextPath, superPath, path);\\n        }\\n        return pathJoin(contextPath, superPath);\\n    }\\n```\\n\\n- getPathByMethod()\\n\\n  \u4ece\u65b9\u6cd5\u7684\u5176\u4ed6\u6ce8\u89e3\u4e0a\u83b7\u53d6`path`\u4fe1\u606f\uff0c\u5176\u4ed6\u6ce8\u89e3\u5305\u62ec\uff1a\\n\\n   - ShenyuSpringMvcClient\\n   - PostMapping\\n   - GetMapping\\n   - DeleteMapping\\n   - PutMapping\\n   - RequestMapping\\n\\n\\n\\n```java\\n\\n    private String getPathByMethod(@NonNull final Method method) {\\n        // \u904d\u5386\u63a5\u53e3\u6ce8\u89e3\u83b7\u53d6path\u4fe1\u606f\\n        for (Class<? extends Annotation> mapping : mappingAnnotation) {\\n            final String pathByAnnotation = getPathByAnnotation(AnnotationUtils.findAnnotation(method, mapping), pathAttributeNames);\\n            if (StringUtils.isNotBlank(pathByAnnotation)) {\\n                return pathByAnnotation;\\n            }\\n        }\\n        return null;\\n    }\\n```\\n\\n\\n\\n\u626b\u63cf\u6ce8\u89e3\u5b8c\u6210\u540e\uff0c\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u7136\u540e\u5c06\u8be5\u5bf9\u8c61\u53d1\u9001\u5230`shenyu-admin`\uff0c\u5373\u53ef\u5b8c\u6210\u6ce8\u518c\u3002\\n\\n- \u5143\u6570\u636e\u5bf9\u8c61\\n\\n  \u5305\u62ec\u5f53\u524d\u6ce8\u518c\u65b9\u6cd5\u7684\u89c4\u5219\u4fe1\u606f\uff1acontextPath\uff0cappName\uff0c\u6ce8\u518c\u8def\u5f84\uff0c\u63cf\u8ff0\u4fe1\u606f\uff0c\u6ce8\u518c\u7c7b\u578b\uff0c\u662f\u5426\u542f\u7528\uff0c\u89c4\u5219\u540d\u79f0\u548c\u662f\u5426\u6ce8\u518c\u5143\u6570\u636e\u3002\\n\\n```java\\n private MetaDataRegisterDTO buildMetaDataDTO(@NonNull final ShenyuSpringMvcClient shenyuSpringMvcClient, final String path) {\\n        return MetaDataRegisterDTO.builder()\\n                .contextPath(contextPath) // contextPath\\n                .appName(appName) // appName\\n                .path(path) // \u6ce8\u518c\u8def\u5f84\uff0c\u5728\u7f51\u5173\u89c4\u5219\u5339\u914d\u65f6\u4f7f\u7528\\n                .pathDesc(shenyuSpringMvcClient.desc()) // \u63cf\u8ff0\u4fe1\u606f\\n                .rpcType(RpcTypeEnum.HTTP.getName()) // divide\u63d2\u4ef6\uff0c\u9ed8\u8ba4\u65f6http\u7c7b\u578b\\n                .enabled(shenyuSpringMvcClient.enabled()) // \u662f\u5426\u542f\u7528\u89c4\u5219\\n                .ruleName(StringUtils.defaultIfBlank(shenyuSpringMvcClient.ruleName(), path))//\u89c4\u5219\u540d\u79f0\\n                .registerMetaData(shenyuSpringMvcClient.registerMetaData()) //\u662f\u5426\u6ce8\u518c\u5143\u6570\u636e\u4fe1\u606f\\n                .build();\\n    }\\n```\\n\\n\\n\\n\u5177\u4f53\u7684\u6ce8\u518c\u903b\u8f91\u7531\u6ce8\u518c\u4e2d\u5fc3\u5b9e\u73b0\uff0c\u5728\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u5df2\u7ecf\u5206\u6790\u8fc7\u4e86\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u6df1\u5165\u5206\u6790\u3002\\n\\n\\n\\n#### 1.3 \u6ce8\u518cURI\u4fe1\u606f\\n\\n`ContextRegisterListener`\u8d1f\u8d23\u5c06\u5ba2\u6237\u7aef\u7684`URI`\u4fe1\u606f\u6ce8\u518c\u5230`shenyu-admin`\uff0c\u5b83\u5b9e\u73b0\u4e86`ApplicationListener`\u63a5\u53e3\uff0c\u53d1\u751f\u4e0a\u4e0b\u6587\u5237\u65b0\u4e8b\u4ef6`ContextRefreshedEvent`\u65f6\uff0c\u6267\u884c`onApplicationEvent()`\u65b9\u6cd5\uff0c\u5b9e\u73b0\u6ce8\u518c\u903b\u8f91\u3002\\n\\n```java\\n\\npublic class ContextRegisterListener implements ApplicationListener<ContextRefreshedEvent>, BeanFactoryAware {\\n\\t//......\\n    \\n    /**\\n     * \u6784\u9020\u5668\u5b9e\u4f8b\u5316\\n     */\\n    public ContextRegisterListener(final PropertiesConfig clientConfig) {\\n        // \u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\\n        final Properties props = clientConfig.getProps();\\n        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));\\n        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);\\n        if (Boolean.TRUE.equals(isFull)) {\\n            if (StringUtils.isBlank(contextPath)) {\\n                final String errorMsg = \\"http register param must config the contextPath\\";\\n                LOG.error(errorMsg);\\n                throw new ShenyuClientIllegalArgumentException(errorMsg);\\n            }\\n        }\\n        this.port = Integer.parseInt(Optional.ofNullable(props.getProperty(ShenyuClientConstants.PORT)).orElseGet(() -> \\"-1\\"));\\n        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);\\n        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);\\n        this.host = props.getProperty(ShenyuClientConstants.HOST);\\n    }\\n\\n    @Override\\n    public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {\\n        this.beanFactory = beanFactory;\\n    }\\n\\n    // \u6267\u884c\u5e94\u7528\u4e8b\u4ef6\\n    @Override\\n    public void onApplicationEvent(@NonNull final ContextRefreshedEvent contextRefreshedEvent) {\\n        // \u4fdd\u8bc1\u8be5\u65b9\u6cd5\u6267\u884c\u4e00\u6b21\\n        if (!registered.compareAndSet(false, true)) {\\n            return;\\n        }\\n        // 1. \u5982\u679c\u662f\u6ce8\u518c\u6574\u4e2a\u670d\u52a1\\n        if (Boolean.TRUE.equals(isFull)) {\\n            // \u6784\u5efa\u5143\u6570\u636e\uff0c\u5e76\u6ce8\u518c\\n            publisher.publishEvent(buildMetaDataDTO());\\n        }\\n        try {\\n            // \u83b7\u53d6\u7aef\u53e3\u4fe1\u606f\\n            final int mergedPort = port <= 0 ? PortUtils.findPort(beanFactory) : port;\\n            // 2. \u6784\u5efaURI\u6570\u636e\uff0c\u5e76\u6ce8\u518c\\n            publisher.publishEvent(buildURIRegisterDTO(mergedPort));\\n        } catch (ShenyuException e) {\\n            throw new ShenyuException(e.getMessage() + \\"please config ${shenyu.client.http.props.port} in xml/yml !\\");\\n        }\\n    }\\n\\n    // \u6784\u5efaURI\u6570\u636e\\n    private URIRegisterDTO buildURIRegisterDTO(final int port) {\\n        return URIRegisterDTO.builder()\\n            .contextPath(this.contextPath) // contextPath\\n            .appName(appName) // appName\\n            .protocol(protocol) // \u670d\u52a1\u4f7f\u7528\u7684\u534f\u8bae\\n            .host(IpUtils.isCompleteHost(this.host) ? this.host : IpUtils.getHost(this.host)) //\u4e3b\u673a\\n            .port(port) // \u7aef\u53e3\\n            .rpcType(RpcTypeEnum.HTTP.getName()) // divide\u63d2\u4ef6\uff0c\u9ed8\u8ba4\u6ce8\u518chttp\u7c7b\u578b\\n            .build();\\n    }\\n\\n    // \u6784\u5efa\u5143\u6570\u636e\\n    private MetaDataRegisterDTO buildMetaDataDTO() {\\n        return MetaDataRegisterDTO.builder()\\n            .contextPath(contextPath)\\n            .appName(appName)\\n            .path(contextPath)\\n            .rpcType(RpcTypeEnum.HTTP.getName())\\n            .enabled(true)\\n            .ruleName(contextPath)\\n            .build();\\n    }\\n}\\n```\\n\\n\\n\\n#### 1.4 \u5904\u7406\u6ce8\u518c\u4fe1\u606f\\n\\n\u5ba2\u6237\u7aef\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u6ce8\u518c\u7684\u5143\u6570\u636e\u548c`URI`\u6570\u636e\uff0c\u5728`shenyu-admin`\u8fdb\u884c\u5904\u7406\uff0c\u8d1f\u8d23\u5b58\u50a8\u5230\u6570\u636e\u5e93\u548c\u540c\u6b65\u7ed9`shenyu`\u7f51\u5173\u3002`Divide`\u63d2\u4ef6\u7684\u5ba2\u6237\u7aef\u6ce8\u518c\u5904\u7406\u903b\u8f91\u5728`ShenyuClientRegisterDivideServiceImpl`\u4e2d\u3002\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-divide-plugin/ShenyuClientRegisterDivideServiceImpl.png)\\n\\n- ShenyuClientRegisterService\uff1a\u5ba2\u6237\u7aef\u6ce8\u518c\u670d\u52a1\uff0c\u9876\u5c42\u63a5\u53e3\uff1b\\n- FallbackShenyuClientRegisterService\uff1a\u6ce8\u518c\u5931\u8d25\uff0c\u63d0\u4f9b\u91cd\u8bd5\u64cd\u4f5c\uff1b\\n- AbstractShenyuClientRegisterServiceImpl\uff1a\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0\u90e8\u5206\u516c\u5171\u6ce8\u518c\u903b\u8f91\uff1b\\n- AbstractContextPathRegisterService\uff1a\u62bd\u8c61\u7c7b\uff0c\u8d1f\u8d23\u6ce8\u518c`ContextPath`\uff1b\\n- ShenyuClientRegisterDivideServiceImpl\uff1a\u5b9e\u73b0`Divide`\u63d2\u4ef6\u7684\u6ce8\u518c\uff1b\\n\\n##### 1.4.1 \u6ce8\u518c\u670d\u52a1\\n\\n- org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()\\n\\n  \u5ba2\u6237\u7aef\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u6ce8\u518c\u7684\u5143\u6570\u636e`MetaDataRegisterDTO`\u5bf9\u8c61\u5728`shenyu-admin`\u7684`register()`\u65b9\u6cd5\u88ab\u63a5\u9001\u5230\u3002\\n\\n```java\\n   @Override\\n    public String register(final MetaDataRegisterDTO dto) {\\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\\n        String selectorHandler = selectorHandler(dto);\\n        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);\\n        //2. \u6ce8\u518c\u89c4\u5219\\n        String ruleHandler = ruleHandler();\\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\\n        ruleService.registerDefault(ruleDTO);\\n        //3. \u6ce8\u518c\u5143\u6570\u636e\\n        registerMetadata(dto);\\n        //4. \u6ce8\u518cContextPath\\n        String contextPath = dto.getContextPath();\\n        if (StringUtils.isNotEmpty(contextPath)) {\\n            registerContextPath(dto);\\n        }\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n###### 1.4.1.1 \u6ce8\u518c\u9009\u62e9\u5668\\n\\n- org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()\\n\\n\u6784\u5efa`contextPath`\uff0c\u67e5\u627e\u9009\u62e9\u5668\u4fe1\u606f\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u5b58\u5728\u5c31\u8fd4\u56de`id`\uff1b\u4e0d\u5b58\u5728\u5c31\u521b\u5efa\u9ed8\u8ba4\u7684\u9009\u62e9\u5668\u4fe1\u606f\u3002\\n\\n```java\\n    @Override\\n    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {\\n        // \u6784\u5efacontextPath\\n        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());\\n        // \u901a\u8fc7\u540d\u79f0\u67e5\u627e\u9009\u62e9\u5668\u4fe1\u606f\u662f\u5426\u5b58\u5728\\n        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);\\n        if (Objects.isNull(selectorDO)) {\\n            // \u4e0d\u5b58\u5728\u5c31\u521b\u5efa\u9ed8\u8ba4\u7684\u9009\u62e9\u5668\u4fe1\u606f\\n            return registerSelector(contextPath, pluginName, selectorHandler);\\n        }\\n        return selectorDO.getId();\\n    }\\n```\\n\\n- \u9ed8\u8ba4\u9009\u62e9\u5668\u4fe1\u606f\\n\\n  \u5728\u8fd9\u91cc\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u4fe1\u606f\u53ca\u5176\u6761\u4ef6\u5c5e\u6027\u3002\\n\\n```java\\n   //\u6ce8\u518c\u9009\u62e9\u5668\\n   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {\\n        //\u6784\u5efa\u9009\u62e9\u5668\\n        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());\\n        selectorDTO.setHandle(selectorHandler);\\n        //\u6ce8\u518c\u9ed8\u8ba4\u9009\u62e9\u5668\\n        return registerDefault(selectorDTO);\\n    }\\n     //\u6784\u5efa\u9009\u62e9\u5668\\n    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {\\n        //\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\\n        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);\\n        selectorDTO.setPluginId(pluginId);\\n         //\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u7684\u6761\u4ef6\u5c5e\u6027\\n        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));\\n        return selectorDTO;\\n    }\\n```\\n\\n- \u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\\n\\n```\\nprivate SelectorDTO buildDefaultSelectorDTO(final String name) {\\n    return SelectorDTO.builder()\\n            .name(name) // \u540d\u79f0\\n            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // \u9ed8\u8ba4\u7c7b\u578b\u81ea\u5b9a\u4e49\\n            .matchMode(MatchModeEnum.AND.getCode()) //\u9ed8\u8ba4\u5339\u914d\u65b9\u5f0f and\\n            .enabled(Boolean.TRUE)  //\u9ed8\u8ba4\u542f\u5f00\u542f\\n            .loged(Boolean.TRUE)  //\u9ed8\u8ba4\u8bb0\u5f55\u65e5\u5fd7\\n            .continued(Boolean.TRUE) //\u9ed8\u8ba4\u7ee7\u7eed\u540e\u7eed\u9009\u62e9\u5668\\n            .sort(1) //\u9ed8\u8ba4\u987a\u5e8f1\\n            .build();\\n}\\n\\n\\n```\\n\\n- \u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\\n\\n```java\\nprivate List<SelectorConditionDTO> buildDefaultSelectorConditionDTO(final String contextPath) {\\n    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();\\n    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // \u9ed8\u8ba4\u53c2\u6570\u7c7b\u578bURI\\n    selectorConditionDTO.setParamName(\\"/\\");\\n    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // \u9ed8\u8ba4\u5339\u914d\u7b56\u7565 match\\n    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // \u9ed8\u8ba4\u503c /contextPath/**\\n    return Collections.singletonList(selectorConditionDTO);\\n}\\n```\\n\\n- \u6ce8\u518c\u9ed8\u8ba4\u9009\u62e9\u5668\\n\\n```\\n@Override\\npublic String registerDefault(final SelectorDTO selectorDTO) {\\n    //\u9009\u62e9\u5668\u4fe1\u606f\\n    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\\n    //\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\\n    List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\\n    if (StringUtils.isEmpty(selectorDTO.getId())) {\\n        // \u5411\u6570\u636e\u5e93\u63d2\u5165\u9009\u62e9\u5668\u4fe1\u606f\\n        selectorMapper.insertSelective(selectorDO);\\n          // \u5411\u6570\u636e\u5e93\u63d2\u5165\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\\n        selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n            selectorConditionDTO.setSelectorId(selectorDO.getId());        \\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\\n        });\\n    }\\n    // \u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\uff0c\u5411\u7f51\u5173\u540c\u6b65\u9009\u62e9\u4fe1\u606f\u53ca\u5176\u6761\u4ef6\u5c5e\u6027\\n    publishEvent(selectorDO, selectorConditionDTOs);\\n    return selectorDO.getId();\\n}\\n```\\n\\n###### 1.4.1.2 \u6ce8\u518c\u89c4\u5219\\n\\n\u5728\u6ce8\u518c\u670d\u52a1\u7684\u7b2c\u4e8c\u6b65\u4e2d\uff0c\u5f00\u59cb\u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\uff0c\u7136\u540e\u6ce8\u518c\u89c4\u5219\u3002\\n\\n```java\\n@Override\\n    public String register(final MetaDataRegisterDTO dto) {\\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\\n        //......\\n        \\n        //2. \u6ce8\u518c\u89c4\u5219\\n        // \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n        String ruleHandler = ruleHandler();\\n        // \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\\n        // \u6ce8\u518c\u89c4\u5219\\n        ruleService.registerDefault(ruleDTO);\\n        \\n        //3. \u6ce8\u518c\u5143\u6570\u636e\\n        //......\\n        \\n        //4. \u6ce8\u518cContextPath\\n        //......\\n        \\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n- \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n\\n```java\\n    @Override\\n    protected String ruleHandler() {\\n        // \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n        return new DivideRuleHandle().toJson();\\n    }\\n```\\n\\n`Divide`\u63d2\u4ef6\u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n\\n```java\\n\\npublic class DivideRuleHandle implements RuleHandle {\\n\\n    /**\\n     * \u8d1f\u8f7d\u5747\u8861\uff1a\u9ed8\u8ba4\u968f\u673a\\n     */\\n    private String loadBalance = LoadBalanceEnum.RANDOM.getName();\\n\\n    /**\\n     * \u91cd\u8bd5\u7b56\u7565\uff1a\u9ed8\u8ba4\u91cd\u8bd5\u5f53\u524d\u670d\u52a1\\n     */\\n    private String retryStrategy = RetryEnum.CURRENT.getName();\\n\\n    /**\\n     * \u91cd\u8bd5\u6b21\u6570\uff1a\u9ed8\u8ba43\u6b21\\n     */\\n    private int retry = 3;\\n\\n    /**\\n     * \u8c03\u7528\u8d85\u65f6\uff1a\u9ed8\u8ba4 3000\\n     */\\n    private long timeout = Constants.TIME_OUT;\\n\\n    /**\\n     * header\u6700\u5927\u503c\uff1a10240 byte\\n     */\\n    private long headerMaxSize = Constants.HEADER_MAX_SIZE;\\n\\n    /**\\n     * request\u6700\u5927\u503c\uff1a102400 byte\\n     */\\n    private long requestMaxSize = Constants.REQUEST_MAX_SIZE;\\n}\\n```\\n\\n\\n- \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n\\n```java\\n  // \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {\\n        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());\\n    }\\n   //  \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {\\n        RuleDTO ruleDTO = RuleDTO.builder()\\n                .selectorId(selectorId) //\u5173\u8054\u7684\u9009\u62e9\u5668id\\n                .name(ruleName) //\u89c4\u5219\u540d\u79f0\\n                .matchMode(MatchModeEnum.AND.getCode()) // \u9ed8\u8ba4\u5339\u914d\u6a21\u5f0f and\\n                .enabled(Boolean.TRUE) // \u9ed8\u8ba4\u5f00\u542f\\n                .loged(Boolean.TRUE) //\u9ed8\u8ba4\u8bb0\u5f55\u65e5\u5fd7\\n                .sort(1) //\u9ed8\u8ba4\u987a\u5e8f 1\\n                .handle(ruleHandler)\\n                .build();\\n        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()\\n                .paramType(ParamTypeEnum.URI.getName()) // \u9ed8\u8ba4\u53c2\u6570\u7c7b\u578bURI\\n                .paramName(\\"/\\")\\n                .paramValue(path) //\u53c2\u6570\u503cpath\\n                .build();\\n        if (path.indexOf(\\"*\\") > 1) {\\n            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //\u5982\u679cpath\u4e2d\u6709*\uff0c\u64cd\u4f5c\u7c7b\u578b\u5219\u9ed8\u8ba4\u4e3a match\\n        } else {\\n            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // \u5426\u5219\uff0c\u9ed8\u8ba4\u64cd\u4f5c\u7c7b\u578b = \\n        }\\n        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));\\n        return ruleDTO;\\n    }\\n```\\n\\n- org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()\\n\\n\u6ce8\u518c\u89c4\u5219\uff1a\u5411\u6570\u636e\u5e93\u63d2\u5165\u8bb0\u5f55\uff0c\u5e76\u5411\u7f51\u5173\u53d1\u5e03\u4e8b\u4ef6\uff0c\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n```java\\n\\n    @Override\\n    public String registerDefault(final RuleDTO ruleDTO) {\\n        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());\\n        if (Objects.nonNull(exist)) {\\n            return \\"\\";\\n        }\\n\\n        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);\\n        List<RuleConditionDTO> ruleConditions = ruleDTO.getRuleConditions();\\n        if (StringUtils.isEmpty(ruleDTO.getId())) {\\n            // \u5411\u6570\u636e\u5e93\u63d2\u5165\u89c4\u5219\u4fe1\u606f\\n            ruleMapper.insertSelective(ruleDO);\\n            //\u5411\u6570\u636e\u5e93\u63d2\u5165\u89c4\u5219\u4f53\u6761\u4ef6\u5c5e\u6027\\n            ruleConditions.forEach(ruleConditionDTO -> {\\n                ruleConditionDTO.setRuleId(ruleDO.getId());            \\n                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));\\n            });\\n        }\\n        // \u5411\u7f51\u5173\u53d1\u5e03\u4e8b\u4ef6\uff0c\u8fdb\u884c\u6570\u636e\u540c\u6b65\\n        publishEvent(ruleDO, ruleConditions);\\n        return ruleDO.getId();\\n    }\\n\\n```\\n\\n\\n\\n###### 1.4.1.3 \u6ce8\u518c\u5143\u6570\u636e\\n\\n\\n\\n```java\\n   @Override\\n    public String register(final MetaDataRegisterDTO dto) {\\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\\n        //......\\n        \\n        //2. \u6ce8\u518c\u89c4\u5219\\n        //......\\n        \\n        //3. \u6ce8\u518c\u5143\u6570\u636e\\n        registerMetadata(dto);\\n        \\n        //4. \u6ce8\u518cContextPath\\n        //......\\n        \\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n- org.apache.shenyu.admin.service.register.ShenyuClientRegisterDivideServiceImpl#registerMetadata()\\n\\n  \u63d2\u5165\u6216\u66f4\u65b0\u5143\u6570\u636e\uff0c\u7136\u540e\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u5230\u7f51\u5173\u3002\\n\\n```java\\n\\n    @Override\\n    protected void registerMetadata(final MetaDataRegisterDTO dto) {\\n        if (dto.isRegisterMetaData()) { // \u5982\u679c\u6ce8\u518c\u5143\u6570\u636e\\n            // \u83b7\u53d6metaDataService\\n            MetaDataService metaDataService = getMetaDataService();\\n            // \u5143\u6570\u636e\u662f\u5426\u5b58\u5728\\n            MetaDataDO exist = metaDataService.findByPath(dto.getPath());\\n            // \u63d2\u5165\u6216\u66f4\u65b0\u5143\u6570\u636e\\n            metaDataService.saveOrUpdateMetaData(exist, dto);\\n        }\\n    }\\n\\n    @Override\\n    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {\\n        DataEventTypeEnum eventType;\\n        // \u6570\u636e\u7c7b\u578b\u8f6c\u6362 DTO->DO\\n        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);\\n        // \u63d2\u5165\u6570\u636e\\n        if (Objects.isNull(exist)) {\\n            Timestamp currentTime = new Timestamp(System.currentTimeMillis());\\n            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());\\n            metaDataDO.setDateCreated(currentTime);\\n            metaDataDO.setDateUpdated(currentTime);\\n            metaDataMapper.insert(metaDataDO);\\n            eventType = DataEventTypeEnum.CREATE;\\n        } else {\\n            // \u66f4\u65b0\u6570\u636e\\n            metaDataDO.setId(exist.getId());\\n            metaDataMapper.update(metaDataDO);\\n            eventType = DataEventTypeEnum.UPDATE;\\n        }\\n        // \u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u5230\u7f51\u5173\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,\\n                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));\\n    }\\n```\\n\\n###### 1.4.1.4 \u6ce8\u518cContextPath\\n\\n```java\\n   @Override\\n    public String register(final MetaDataRegisterDTO dto) {\\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\\n        //......\\n        \\n        //2. \u6ce8\u518c\u89c4\u5219\\n        //......\\n        \\n        //3. \u6ce8\u518c\u5143\u6570\u636e\\n        //......\\n        \\n        //4. \u6ce8\u518cContextPath\\n        String contextPath = dto.getContextPath();\\n        if (StringUtils.isNotEmpty(contextPath)) {\\n            registerContextPath(dto);\\n        }\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n- org.apache.shenyu.admin.service.register.AbstractContextPathRegisterService#registerContextPath()\\n\\n```java\\n    @Override\\n    public void registerContextPath(final MetaDataRegisterDTO dto) {\\n        // \u8bbe\u7f6e\u9009\u62e9\u5668\u7684contextPath\\n        String contextPathSelectorId = getSelectorService().registerDefault(dto, PluginEnum.CONTEXT_PATH.getName(), \\"\\");\\n        ContextMappingRuleHandle handle = new ContextMappingRuleHandle();\\n        handle.setContextPath(PathUtils.decoratorContextPath(dto.getContextPath()));\\n        // \u8bbe\u7f6e\u89c4\u5219\u7684contextPath\\n        getRuleService().registerDefault(buildContextPathDefaultRuleDTO(contextPathSelectorId, dto, handle.toJson()));\\n    }\\n```\\n\\n\\n\\n##### 1.4.2 \u6ce8\u518cURI\\n\\n- org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()\\n\\n\u670d\u52a1\u7aef\u6536\u5230\u5ba2\u6237\u7aef\u6ce8\u518c\u7684`URI`\u4fe1\u606f\u540e\uff0c\u8fdb\u884c\u5904\u7406\u3002\\n\\n```java\\n    @Override\\n    public String registerURI(final String selectorName, final List<URIRegisterDTO> uriList) {\\n        String result;\\n        String key = key(selectorName);\\n        try {\\n            this.removeFallBack(key);\\n            // \u6ce8\u518cURI\\n            result = this.doRegisterURI(selectorName, uriList);\\n            logger.info(\\"Register success: {},{}\\", selectorName, uriList);\\n        } catch (Exception ex) {\\n            logger.warn(\\"Register exception: cause:{}\\", ex.getMessage());\\n            result = \\"\\";\\n            // \u6ce8\u518c\u5931\u8d25\u540e\uff0c\u8fdb\u884c\u91cd\u8bd5\\n            this.addFallback(key, new FallbackHolder(selectorName, uriList));\\n        }\\n        return result;\\n    }\\n```\\n\\n- org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()\\n\\n\u4ece\u5ba2\u6237\u7aef\u6ce8\u518c\u7684`URI`\u4e2d\u83b7\u53d6\u6709\u6548\u7684`URI`\uff0c\u66f4\u65b0\u5bf9\u5e94\u7684\u9009\u62e9\u5668`handle`\u5c5e\u6027\uff0c\u5411\u7f51\u5173\u53d1\u9001\u9009\u62e9\u5668\u66f4\u65b0\u4e8b\u4ef6\u3002\\n\\n```java\\n@Override\\n    public String doRegisterURI(final String selectorName, final List<URIRegisterDTO> uriList) {\\n        //\u53c2\u6570\u68c0\u67e5\\n        if (CollectionUtils.isEmpty(uriList)) {\\n            return \\"\\";\\n        }\\n        //\u83b7\u53d6\u9009\u62e9\u5668\u4fe1\u606f\\n        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\\n        if (Objects.isNull(selectorDO)) {\\n            throw new ShenyuException(\\"doRegister Failed to execute,wait to retry.\\");\\n        }\\n        // \u83b7\u53d6\u6709\u6548\u7684URI\\n        List<URIRegisterDTO> validUriList = uriList.stream().filter(dto -> Objects.nonNull(dto.getPort()) && StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());\\n        // \u6784\u5efa\u9009\u62e9\u5668\u7684handle\u5c5e\u6027\\n        String handler = buildHandle(validUriList, selectorDO);\\n        if (handler != null) {\\n            selectorDO.setHandle(handler);\\n            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\\n            selectorData.setHandle(handler);\\n            // \u5411\u6570\u636e\u5e93\u66f4\u65b0\u9009\u62e9\u5668\u7684handle\u5c5e\u6027\\n            selectorService.updateSelective(selectorDO);\\n            // \u5411\u7f51\u5173\u53d1\u9001\u9009\u62e9\u5668\u66f4\u65b0\u4e8b\u4ef6\\n            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));\\n        }\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n\u5173\u4e8e\u670d\u52a1\u6ce8\u518c\u7684\u6e90\u7801\u5206\u6790\u5c31\u4ee5\u53ca\u5b8c\u6210\u4e86\uff0c\u5206\u6790\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-divide-plugin/divide-register-zh.png)\\n\\n\\n\\n\u63a5\u4e0b\u6765\u5c31\u5206\u6790`divide`\u63d2\u4ef6\u662f\u5982\u4f55\u6839\u636e\u8fd9\u4e9b\u4fe1\u606f\u5411`http`\u670d\u52a1\u53d1\u8d77\u8c03\u7528\u3002\\n\\n\\n\\n### 2. \u670d\u52a1\u8c03\u7528\\n\\n`divide`\u63d2\u4ef6\u662f\u7f51\u5173\u7528\u4e8e\u5904\u7406 `http\u534f\u8bae`\u8bf7\u6c42\u7684\u6838\u5fc3\u5904\u7406\u63d2\u4ef6\u3002\\n\\n\u4ee5\u5b98\u7f51\u63d0\u4f9b\u7684\u6848\u4f8b [Http\u5feb\u901f\u5f00\u59cb](https://shenyu.apache.org/zh/docs/next/quick-start/quick-start-http) \u4e3a\u4f8b\uff0c\u4e00\u4e2a\u76f4\u8fde\u8bf7\u6c42\u5982\u4e0b\uff1a\\n\\n```\\nGET http://localhost:8189/order/findById?id=100\\nAccept: application/json\\n```\\n\\n\\n\\n\u901a\u8fc7`ShenYu`\u7f51\u5173\u4ee3\u7406\u540e\uff0c\u8bf7\u6c42\u5982\u4e0b\uff1a\\n\\n```\\nGET http://localhost:9195/http/order/findById?id=100\\nAccept: application/json\\n```\\n\\n\\n\\n\u901a\u8fc7`ShenYu`\u7f51\u5173\u4ee3\u7406\u540e\u7684\u670d\u52a1\u4ecd\u7136\u80fd\u591f\u8bf7\u6c42\u5230\u4e4b\u524d\u7684\u670d\u52a1\uff0c\u5728\u8fd9\u91cc\u8d77\u4f5c\u7528\u7684\u5c31\u662f`divide`\u63d2\u4ef6\u3002\u7c7b\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-divide-plugin/DividePlugin.png)\\n\\n- ShenyuPlugin\uff1a\u9876\u5c42\u63a5\u53e3\uff0c\u5b9a\u4e49\u63a5\u53e3\u65b9\u6cd5\uff1b\\n- AbstractShenyuPlugin\uff1a\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0\u63d2\u4ef6\u5171\u6709\u903b\u8f91\uff1b\\n- DividePlugin\uff1aDivide\u63d2\u4ef6\u3002\\n\\n#### 2.1 \u63a5\u6536\u8bf7\u6c42\\n\\n\u901a\u8fc7`ShenYu`\u7f51\u5173\u4ee3\u7406\u540e\uff0c\u8bf7\u6c42\u5165\u53e3\u662f`ShenyuWebHandler`\uff0c\u5b83\u5b9e\u73b0\u4e86`org.springframework.web.server.WebHandler`\u63a5\u53e3\u3002\\n\\n```\\npublic final class ShenyuWebHandler implements WebHandler, ApplicationListener<SortPluginEvent> {\\n    //......\\n    \\n    /**\\n     * \u5904\u7406web\u8bf7\u6c42\\n     */\\n    @Override\\n    public Mono<Void> handle(@NonNull final ServerWebExchange exchange) {\\n       // \u6267\u884c\u9ed8\u8ba4\u63d2\u4ef6\u94fe\\n        Mono<Void> execute = new DefaultShenyuPluginChain(plugins).execute(exchange);\\n        if (scheduled) {\\n            return execute.subscribeOn(scheduler);\\n        }\\n        return execute;\\n    }\\n    \\n    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {\\n\\n        private int index;\\n\\n        private final List<ShenyuPlugin> plugins;\\n\\n        /**\\n         * \u5b9e\u4f8b\u5316\u9ed8\u8ba4\u63d2\u4ef6\u94fe\\n         */\\n        DefaultShenyuPluginChain(final List<ShenyuPlugin> plugins) {\\n            this.plugins = plugins;\\n        }\\n\\n        /**\\n         * \u6267\u884c\u6bcf\u4e2a\u63d2\u4ef6.\\n         */\\n        @Override\\n        public Mono<Void> execute(final ServerWebExchange exchange) {\\n            return Mono.defer(() -> {\\n                if (this.index < plugins.size()) {\\n                    // \u83b7\u53d6\u5f53\u524d\u6267\u884c\u63d2\u4ef6\\n                    ShenyuPlugin plugin = plugins.get(this.index++);\\n                    // \u662f\u5426\u8df3\u8fc7\u5f53\u524d\u63d2\u4ef6\\n                    boolean skip = plugin.skip(exchange);\\n                    if (skip) {\\n                        // \u5982\u679c\u8df3\u8fc7\u5c31\u6267\u884c\u4e0b\u4e00\u4e2a\\n                        return this.execute(exchange);\\n                    }\\n                    // \u6267\u884c\u5f53\u524d\u63d2\u4ef6\\n                    return plugin.execute(exchange, this);\\n                }\\n                return Mono.empty();\\n            });\\n        }\\n    }\\n}\\n```\\n\\n#### 2.2 \u5339\u914d\u89c4\u5219\\n\\n- org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()\\n\\n\u5728`execute()`\u65b9\u6cd5\u4e2d\u6267\u884c\u9009\u62e9\u5668\u548c\u89c4\u5219\u7684\u5339\u914d\u903b\u8f91\u3002\\n\\n- \u5339\u914d\u9009\u62e9\u5668\uff1b\\n- \u5339\u914d\u89c4\u5219\uff1b\\n- \u6267\u884c\u63d2\u4ef6\u3002\\n\\n```java\\n@Override\\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        // \u63d2\u4ef6\u540d\u79f0\\n        String pluginName = named();\\n        // \u63d2\u4ef6\u4fe1\u606f\\n        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);\\n        if (pluginData != null && pluginData.getEnabled()) {\\n            // \u9009\u62e9\u5668\u4fe1\u606f\\n            final Collection<SelectorData> selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);\\n            if (CollectionUtils.isEmpty(selectors)) {\\n                return handleSelectorIfNull(pluginName, exchange, chain);\\n            }\\n            // \u5339\u914d\u9009\u62e9\u5668\\n            SelectorData selectorData = matchSelector(exchange, selectors);\\n            if (Objects.isNull(selectorData)) {\\n                return handleSelectorIfNull(pluginName, exchange, chain);\\n            }\\n            selectorLog(selectorData, pluginName);\\n            // \u89c4\u5219\u4fe1\u606f\\n            List<RuleData> rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());\\n            if (CollectionUtils.isEmpty(rules)) {\\n                return handleRuleIfNull(pluginName, exchange, chain);\\n            }\\n            // \u5339\u914d\u89c4\u5219\\n            RuleData rule;\\n            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {\\n                //get last\\n                rule = rules.get(rules.size() - 1);\\n            } else {\\n                rule = matchRule(exchange, rules);\\n            }\\n            if (Objects.isNull(rule)) {\\n                return handleRuleIfNull(pluginName, exchange, chain);\\n            }\\n            ruleLog(rule, pluginName);\\n            // \u6267\u884c\u63d2\u4ef6\\n            return doExecute(exchange, chain, selectorData, rule);\\n        }\\n        return chain.execute(exchange);\\n    }\\n```\\n\\n#### 2.3 \u6267\u884cdivide\u63d2\u4ef6\\n\\n- org.apache.shenyu.plugin.divide.DividePlugin#doExecute()\\n\\n\u5728`doExecute()`\u65b9\u6cd5\u4e2d\u6267\u884c`divide`\u63d2\u4ef6\u7684\u5177\u4f53\u903b\u8f91\uff1a\\n\\n- \u6821\u9a8c`header`\u5927\u5c0f\uff1b\\n- \u6821\u9a8c`request`\u5927\u5c0f\uff1b\\n- \u83b7\u53d6\u670d\u52a1\u5217\u8868\uff1b\\n- \u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\uff1b\\n- \u8bbe\u7f6e\u8bf7\u6c42`url`\uff0c\u8d85\u65f6\u65f6\u95f4\uff0c\u91cd\u8bd5\u7b56\u7565\u3002\\n\\n```java\\n@Override\\n    protected Mono<Void> doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {\\n        // \u83b7\u53d6\u4e0a\u4e0b\u6587\u4fe1\u606f\\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\\n        assert shenyuContext != null;\\n        // \u83b7\u53d6\u89c4\u5219\u7684handle\u5c5e\u6027\\n        DivideRuleHandle ruleHandle = DividePluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));\\n        long headerSize = 0;\\n        // \u6821\u9a8cheader\u5927\u5c0f\\n        for (List<String> multiHeader : exchange.getRequest().getHeaders().values()) {\\n            for (String value : multiHeader) {\\n                headerSize += value.getBytes(StandardCharsets.UTF_8).length;\\n            }\\n        }\\n        if (headerSize > ruleHandle.getHeaderMaxSize()) {\\n            LOG.error(\\"request header is too large\\");\\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_HEADER_TOO_LARGE, null);\\n            return WebFluxResultUtils.result(exchange, error);\\n        }\\n        \\n        // \u6821\u9a8crequest\u5927\u5c0f\\n        if (exchange.getRequest().getHeaders().getContentLength() > ruleHandle.getRequestMaxSize()) {\\n            LOG.error(\\"request entity is too large\\");\\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_ENTITY_TOO_LARGE, null);\\n            return WebFluxResultUtils.result(exchange, error);\\n        }\\n        // \u83b7\u53d6\u670d\u52a1\u5217\u8868upstreamList\\n        List<Upstream> upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());\\n        if (CollectionUtils.isEmpty(upstreamList)) {\\n            LOG.error(\\"divide upstream configuration error\uff1a {}\\", rule);\\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);\\n            return WebFluxResultUtils.result(exchange, error);\\n        }\\n        // \u8bf7\u6c42ip\\n        String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();\\n        // \u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\\n        Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);\\n        if (Objects.isNull(upstream)) {\\n            LOG.error(\\"divide has no upstream\\");\\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);\\n            return WebFluxResultUtils.result(exchange, error);\\n        }\\n        // \u8bbe\u7f6eurl\\n        String domain = upstream.buildDomain();\\n        exchange.getAttributes().put(Constants.HTTP_DOMAIN, domain);\\n        // \u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\\n        exchange.getAttributes().put(Constants.HTTP_TIME_OUT, ruleHandle.getTimeout());\\n        exchange.getAttributes().put(Constants.HTTP_RETRY, ruleHandle.getRetry());\\n        // \u8bbe\u7f6e\u91cd\u8bd5\u7b56\u7565\\n        exchange.getAttributes().put(Constants.RETRY_STRATEGY, ruleHandle.getRetryStrategy());\\n        exchange.getAttributes().put(Constants.LOAD_BALANCE, ruleHandle.getLoadBalance());\\n        exchange.getAttributes().put(Constants.DIVIDE_SELECTOR_ID, selector.getId());\\n        return chain.execute(exchange);\\n    }\\n```\\n\\n#### 2.4 \u53d1\u8d77\u8bf7\u6c42\\n\\n\u9ed8\u8ba4\u7531`WebClientPlugin`\u5411`http`\u670d\u52a1\u53d1\u8d77\u8c03\u7528\u8bf7\u6c42\uff0c\u7c7b\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-divide-plugin/WebClientPlugin.png)\\n\\n- ShenyuPlugin\uff1a\u9876\u5c42\u63d2\u4ef6\uff0c\u5b9a\u4e49\u63d2\u4ef6\u65b9\u6cd5\uff1b\\n- AbstractHttpClientPlugin\uff1a\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0\u8bf7\u6c42\u8c03\u7528\u7684\u516c\u5171\u903b\u8f91\uff1b\\n- WebClientPlugin\uff1a\u901a\u8fc7`WebClient`\u53d1\u8d77\u8bf7\u6c42\uff1b\\n- NettyHttpClientPlugin\uff1a\u901a\u8fc7`Netty`\u53d1\u8d77\u8bf7\u6c42\u3002\\n\\n\u53d1\u8d77\u8bf7\u6c42\u8c03\u7528\uff1a\\n\\n- org.apache.shenyu.plugin.httpclient.AbstractHttpClientPlugin#execute()\\n\\n\u5728`execute()`\u65b9\u6cd5\u4e2d\u53d1\u8d77\u8bf7\u6c42\u8c03\u7528\uff1a\\n\\n- \u83b7\u53d6\u6307\u5b9a\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u91cd\u8bd5\u6b21\u6570\\n- \u53d1\u8d77\u8bf7\u6c42\\n- \u6839\u636e\u6307\u5b9a\u7684\u91cd\u8bd5\u7b56\u7565\u8fdb\u884c\u5931\u8d25\u540e\u91cd\u8bd5\u64cd\u4f5c\\n\\n```java\\n\\npublic abstract class AbstractHttpClientPlugin<R> implements ShenyuPlugin {\\n\\n    protected static final Logger LOG = LoggerFactory.getLogger(AbstractHttpClientPlugin.class);\\n\\n    @Override\\n    public final Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        // \u83b7\u53d6\u4e0a\u4e0b\u6587\u4fe1\u606f\\n        final ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\\n        assert shenyuContext != null;\\n        // \u83b7\u53d6uri\\n        final URI uri = exchange.getAttribute(Constants.HTTP_URI);\\n        if (Objects.isNull(uri)) {\\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_URL, null);\\n            return WebFluxResultUtils.result(exchange, error);\\n        }\\n        // \u83b7\u53d6\u6307\u5b9a\u7684\u8d85\u65f6\u65f6\u95f4\\n        final long timeout = (long) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_TIME_OUT)).orElse(3000L);\\n        final Duration duration = Duration.ofMillis(timeout);\\n        // \u83b7\u53d6\u6307\u5b9a\u91cd\u8bd5\u6b21\u6570\\n        final int retryTimes = (int) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_RETRY)).orElse(0);\\n        // \u83b7\u53d6\u6307\u5b9a\u7684\u91cd\u8bd5\u7b56\u7565\\n        final String retryStrategy = (String) Optional.ofNullable(exchange.getAttribute(Constants.RETRY_STRATEGY)).orElseGet(RetryEnum.CURRENT::getName);\\n        LOG.info(\\"The request urlPath is {}, retryTimes is {}, retryStrategy is {}\\", uri.toASCIIString(), retryTimes, retryStrategy);\\n        // \u6784\u5efaheader\\n        final HttpHeaders httpHeaders = buildHttpHeaders(exchange);\\n        // \u53d1\u8d77\u8bf7\u6c42\\n        final Mono<R> response = doRequest(exchange, exchange.getRequest().getMethodValue(), uri, httpHeaders, exchange.getRequest().getBody())\\n                .timeout(duration, Mono.error(new TimeoutException(\\"Response took longer than timeout: \\" + duration)))\\n                .doOnError(e -> LOG.error(e.getMessage(), e));\\n        \\n        // \u91cd\u8bd5\u7b56\u7565CURRENT\uff0c\u5bf9\u5f53\u524d\u670d\u52a1\u8fdb\u884c\u91cd\u8bd5\\n        if (RetryEnum.CURRENT.getName().equals(retryStrategy)) {\\n            //old version of DividePlugin and SpringCloudPlugin will run on this\\n            return response.retryWhen(Retry.anyOf(TimeoutException.class, ConnectTimeoutException.class, ReadTimeoutException.class, IllegalStateException.class)\\n                    .retryMax(retryTimes)\\n                    .backoff(Backoff.exponential(Duration.ofMillis(200), Duration.ofSeconds(20), 2, true)))\\n                    .onErrorMap(TimeoutException.class, th -> new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))\\n                    .flatMap((Function<Object, Mono<? extends Void>>) o -> chain.execute(exchange));\\n        }\\n        \\n        // \u5bf9\u5176\u4ed6\u670d\u52a1\u8fdb\u884c\u91cd\u8bd5\\n        // \u6392\u9664\u5df2\u7ecf\u8c03\u7528\u8fc7\u7684\u670d\u52a1\\n        final Set<URI> exclude = Sets.newHashSet(uri);\\n        // \u8bf7\u6c42\u91cd\u8bd5\\n        return resend(response, exchange, duration, httpHeaders, exclude, retryTimes)\\n                .onErrorMap(TimeoutException.class, th -> new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))\\n                .flatMap((Function<Object, Mono<? extends Void>>) o -> chain.execute(exchange));\\n    }\\n\\n    private Mono<R> resend(final Mono<R> clientResponse,\\n                           final ServerWebExchange exchange,\\n                           final Duration duration,\\n                           final HttpHeaders httpHeaders,\\n                           final Set<URI> exclude,\\n                           final int retryTimes) {\\n        Mono<R> result = clientResponse;\\n        // \u6839\u636e\u6307\u5b9a\u7684\u91cd\u8bd5\u6b21\u6570\u8fdb\u884c\u91cd\u8bd5\\n        for (int i = 0; i < retryTimes; i++) {\\n            result = resend(result, exchange, duration, httpHeaders, exclude);\\n        }\\n        return result;\\n    }\\n\\n    private Mono<R> resend(final Mono<R> response,\\n                           final ServerWebExchange exchange,\\n                           final Duration duration,\\n                           final HttpHeaders httpHeaders,\\n                           final Set<URI> exclude) {\\n        return response.onErrorResume(th -> {\\n            final String selectorId = exchange.getAttribute(Constants.DIVIDE_SELECTOR_ID);\\n            final String loadBalance = exchange.getAttribute(Constants.LOAD_BALANCE);\\n            //\u67e5\u8be2\u53ef\u7528\u670d\u52a1\\n            final List<Upstream> upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selectorId)\\n                    .stream().filter(data -> {\\n                        final String trimUri = data.getUrl().trim();\\n                        for (URI needToExclude : exclude) {\\n                            // exclude already called\\n                            if ((needToExclude.getHost() + \\":\\" + needToExclude.getPort()).equals(trimUri)) {\\n                                return false;\\n                            }\\n                        }\\n                        return true;\\n                    }).collect(Collectors.toList());\\n            if (CollectionUtils.isEmpty(upstreamList)) {\\n                // no need to retry anymore\\n                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));\\n            }\\n            // \u8bf7\u6c42ip\\n            final String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();\\n            // \u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\\n            final Upstream upstream = LoadBalancerFactory.selector(upstreamList, loadBalance, ip);\\n            if (Objects.isNull(upstream)) {\\n                // no need to retry anymore\\n                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));\\n            }\\n            final URI newUri = RequestUrlUtils.buildRequestUri(exchange, upstream.buildDomain());\\n            // \u6392\u9664\u5df2\u7ecf\u8c03\u7528\u7684uri\\n            exclude.add(newUri);\\n             // \u8fdb\u884c\u518d\u6b21\u8c03\u7528\\n            return doRequest(exchange, exchange.getRequest().getMethodValue(), newUri, httpHeaders, exchange.getRequest().getBody())\\n                    .timeout(duration, Mono.error(new TimeoutException(\\"Response took longer than timeout: \\" + duration)))\\n                    .doOnError(e -> LOG.error(e.getMessage(), e));\\n        });\\n    }\\n\\n    //......\\n}\\n\\n```\\n\\n- org.apache.shenyu.plugin.httpclient.WebClientPlugin#doRequest()\\n\\n\u5728`doRequest()`\u65b9\u6cd5\u4e2d\u901a\u8fc7`webClient`\u53d1\u8d77\u771f\u6b63\u7684\u8bf7\u6c42\u8c03\u7528\u3002\\n\\n```java\\n\\n@Override\\n    protected Mono<ClientResponse> doRequest(final ServerWebExchange exchange, final String httpMethod, final URI uri,\\n                                             final HttpHeaders httpHeaders, final Flux<DataBuffer> body) {\\n        return webClient.method(HttpMethod.valueOf(httpMethod)).uri(uri) //\u8bf7\u6c42uri\\n                .headers(headers -> headers.addAll(httpHeaders)) // \u8bf7\u6c42header\\n                .body(BodyInserters.fromDataBuffers(body))\\n                .exchange() // \u53d1\u8d77\u8bf7\u6c42\\n                .doOnSuccess(res -> {\\n                    if (res.statusCode().is2xxSuccessful()) { // \u6210\u529f\\n                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());\\n                    } else { // \u5931\u8d25\\n                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.ERROR.getName());\\n                    }\\n                    exchange.getResponse().setStatusCode(res.statusCode());\\n                    exchange.getAttributes().put(Constants.CLIENT_RESPONSE_ATTR, res);\\n                });\\n    }\\n```\\n\\n#### 2.5 \u5904\u7406\u54cd\u5e94\u7ed3\u679c\\n\\n- org.apache.shenyu.plugin.response.ResponsePlugin#execute()\\n\\n\u54cd\u5e94\u7ed3\u679c\u7531`ResponsePlugin`\u63d2\u4ef6\u5904\u7406\u3002\\n\\n```java\\n    @Override\\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\\n        assert shenyuContext != null;\\n        // \u6839\u636erpc\u7c7b\u578b\u5904\u7406\u7ed3\u679c\\n        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);\\n    }\\n```\\n\\n\u5904\u7406\u7c7b\u578b\u7531`MessageWriter`\u51b3\u5b9a\uff0c\u7c7b\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-divide-plugin/MessageWriter.png)\\n\\n- MessageWriter\uff1a\u63a5\u53e3\uff0c\u5b9a\u4e49\u6d88\u606f\u5904\u7406\u65b9\u6cd5\uff1b\\n- NettyClientMessageWriter\uff1a\u5904\u7406`Netty`\u8c03\u7528\u7ed3\u679c\uff1b\\n- RPCMessageWriter\uff1a\u5904\u7406`RPC`\u8c03\u7528\u7ed3\u679c\uff1b\\n- WebClientMessageWriter\uff1a\u5904\u7406`WebClient`\u8c03\u7528\u7ed3\u679c\uff1b\\n\\n\u9ed8\u8ba4\u662f\u901a\u8fc7`WebCient`\u53d1\u8d77`http`\u8bf7\u6c42\u3002\\n\\n- org.apache.shenyu.plugin.response.strategy.WebClientMessageWriter#writeWith()\\n\\n\u5728`writeWith()`\u65b9\u6cd5\u4e2d\u5904\u7406\u54cd\u5e94\u7ed3\u679c\u3002\\n\\n```java\\n\\n    @Override\\n    public Mono<Void> writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        return chain.execute(exchange).then(Mono.defer(() -> {\\n            // \u83b7\u53d6\u54cd\u5e94\\n            ServerHttpResponse response = exchange.getResponse();\\n            ClientResponse clientResponse = exchange.getAttribute(Constants.CLIENT_RESPONSE_ATTR);\\n            if (Objects.isNull(clientResponse)) {\\n                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);\\n                return WebFluxResultUtils.result(exchange, error);\\n            }\\n            //\u83b7\u53d6cookies\u548cheaders\\n            response.getCookies().putAll(clientResponse.cookies());\\n            response.getHeaders().putAll(clientResponse.headers().asHttpHeaders());\\n            // image, pdf or stream does not do format processing.\\n            // \u5904\u7406\u7279\u6b8a\u54cd\u5e94\u7c7b\u578b\\n            if (clientResponse.headers().contentType().isPresent()) {\\n                final String media = clientResponse.headers().contentType().get().toString().toLowerCase();\\n                if (media.matches(COMMON_BIN_MEDIA_TYPE_REGEX)) {\\n                    return response.writeWith(clientResponse.body(BodyExtractors.toDataBuffers()))\\n                            .doOnCancel(() -> clean(exchange));\\n                }\\n            }\\n            // \u5904\u7406\u4e00\u822c\u54cd\u5e94\u7c7b\u578b\\n            clientResponse = ResponseUtils.buildClientResponse(response, clientResponse.body(BodyExtractors.toDataBuffers()));\\n            return clientResponse.bodyToMono(byte[].class)\\n                    .flatMap(originData -> WebFluxResultUtils.result(exchange, originData))\\n                    .doOnCancel(() -> clean(exchange));\\n        }));\\n    }\\n```\\n\\n\u5206\u6790\u81f3\u6b64\uff0c\u5173\u4e8e`Divide`\u63d2\u4ef6\u7684\u6e90\u7801\u5206\u6790\u5c31\u5b8c\u6210\u4e86\uff0c\u5206\u6790\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-divide-plugin/divide-execute-zh.png)\\n\\n\\n### 3. \u5c0f\u7ed3\\n\\n\u672c\u6587\u6e90\u7801\u5206\u6790\u4ece`http`\u670d\u52a1\u6ce8\u518c\u5f00\u59cb\uff0c\u5230`divide`\u63d2\u4ef6\u7684\u670d\u52a1\u8c03\u7528\u3002`divide`\u63d2\u4ef6\u4e3b\u8981\u7528\u6765\u5904\u7406`http`\u8bf7\u6c42\u3002\u6709\u4e9b\u6e90\u7801\u6ca1\u6709\u8fdb\u5165\u6df1\u5165\u5206\u6790\uff0c\u6bd4\u5982\u8d1f\u8f7d\u5747\u8861\u7684\u5b9e\u73b0\uff0c\u670d\u52a1\u63a2\u6d3b\uff0c\u5c06\u5728\u540e\u7eed\u7ee7\u7eed\u5206\u6790\u3002"},{"id":"/Plugin-SourceCode-Analysis-Dubbo-Plugin","metadata":{"permalink":"/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Dubbo-Plugin.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Dubbo-Plugin.md","title":"Dubbo\u63d2\u4ef6\u6e90\u7801\u5206\u6790","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"plugin","permalink":"/zh/blog/tags/plugin"},{"label":"dubbo","permalink":"/zh/blog/tags/dubbo"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":28.74,"hasTruncateMarker":false,"authors":[{"name":"midnight2104","title":"Apache ShenYu Committer","url":"https://github.com/midnight2104"}],"frontMatter":{"title":"Dubbo\u63d2\u4ef6\u6e90\u7801\u5206\u6790","author":"midnight2104","author_title":"Apache ShenYu Committer","author_url":"https://github.com/midnight2104","tags":["plugin","dubbo","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Divide\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin"},"nextItem":{"title":"McpServer \u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"}},"content":"> [Apache ShenYu](https://shenyu.apache.org/zh/docs/index) \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 `API` \u7f51\u5173\u3002\\n\\n`Apache ShenYu` \u7f51\u5173\u4f7f\u7528 `dubbo` \u63d2\u4ef6\u5b8c\u6210\u5bf9 `dubbo`\u670d\u52a1\u7684\u8c03\u7528\u3002\u4f60\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 [Dubbo\u5feb\u901f\u5f00\u59cb](https://shenyu.apache.org/docs/quick-start/quick-start-dubbo) \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8be5\u63d2\u4ef6\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.4.3`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [Dubbo\u670d\u52a1\u63a5\u5165](https://shenyu.apache.org/zh/docs/user-guide/dubbo-proxy/) \u3002\\n\\n\\n### 1. \u670d\u52a1\u6ce8\u518c\\n\\n\u4ee5\u5b98\u7f51\u63d0\u4f9b\u7684\u4f8b\u5b50\u4e3a\u4f8b [shenyu-examples-dubbo](https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-dubbo/shenyu-examples-apache-dubbo-service) \u3002 \u5047\u5982\u4f60\u7684`dubbo`\u670d\u52a1\u5b9a\u4e49\u5982\u4e0b(`spring-dubbo.xml`)\uff1a\\n\\n```xml\\n<beans xmlns=\\"http://www.springframework.org/schema/beans\\"\\n       xmlns:xsi=\\"http://www.w3.org/2001/XMLSchema-instance\\"\\n       xmlns:dubbo=\\"http://code.alibabatech.com/schema/dubbo\\"\\n       xsi:schemaLocation=\\"http://www.springframework.org/schema/beans\\n       http://www.springframework.org/schema/beans/spring-beans.xsd\\n       http://code.alibabatech.com/schema/dubbo\\n       https://code.alibabatech.com/schema/dubbo/dubbo.xsd\\">\\n\\n    <dubbo:application name=\\"test-dubbo-service\\"/>\\n    <dubbo:registry address=\\"${dubbo.registry.address}\\"/>\\n    <dubbo:protocol name=\\"dubbo\\" port=\\"20888\\"/>\\n\\n    <dubbo:service timeout=\\"10000\\" interface=\\"org.apache.shenyu.examples.dubbo.api.service.DubboTestService\\" ref=\\"dubboTestService\\"/>\\n\\n</beans>\\n```\\n\\n\u58f0\u660e\u5e94\u7528\u670d\u52a1\u540d\u79f0\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5730\u5740\uff0c\u4f7f\u7528`dubbo`\u534f\u8bae\uff0c\u58f0\u660e\u670d\u52a1\u63a5\u53e3\uff0c\u5bf9\u5e94\u63a5\u53e3\u5b9e\u73b0\u7c7b\uff1a\\n\\n```java\\n/**\\n * DubboTestServiceImpl.\\n */\\n@Service(\\"dubboTestService\\")\\npublic class DubboTestServiceImpl implements DubboTestService {\\n    \\n    @Override\\n    @ShenyuDubboClient(path = \\"/findById\\", desc = \\"Query by Id\\")\\n    public DubboTest findById(final String id) {\\n        return new DubboTest(id, \\"hello world shenyu Apache, findById\\");\\n    }\\n\\n    //......\\n}\\n```\\n\\n\u5728\u63a5\u53e3\u5b9e\u73b0\u7c7b\u4e2d\uff0c\u4f7f\u7528\u6ce8\u89e3`@ShenyuDubboClient`\u5411`shenyu-admin`\u6ce8\u518c\u670d\u52a1\u3002\u8be5\u6ce8\u89e3\u7684\u4f5c\u7528\u53ca\u539f\u7406\uff0c\u7a0d\u540e\u518d\u8fdb\u884c\u5206\u6790\u3002\\n\\n\u5728\u914d\u7f6e\u6587\u4ef6`application.yml`\u4e2d\u7684\u914d\u7f6e\u4fe1\u606f\uff1a\\n\\n```yaml\\nserver:\\n  port: 8011\\n  address: 0.0.0.0\\n  servlet:\\n    context-path: /\\nspring:\\n  main:\\n    allow-bean-definition-overriding: true\\ndubbo:\\n  registry:\\n    address: zookeeper://localhost:2181  # dubbo\u4f7f\u7528\u7684\u6ce8\u518c\u4e2d\u5fc3\\n    \\nshenyu:\\n  register:\\n    registerType: http #\u6ce8\u518c\u65b9\u5f0f\\n    serverLists: http://localhost:9095 #\u6ce8\u518c\u5730\u5740\\n    props:\\n      username: admin \\n      password: 123456\\n  client:\\n    dubbo:\\n      props:\\n        contextPath: /dubbo  \\n        appName: dubbo\\n\\n```\\n\\n\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u58f0\u660e`dubbo`\u4f7f\u7528\u7684\u6ce8\u518c\u4e2d\u5fc3\u5730\u5740\uff0c`dubbo`\u670d\u52a1\u5411`shenyu-admin`\u6ce8\u518c\uff0c\u4f7f\u7528\u7684\u65b9\u5f0f\u662f`http`\uff0c\u6ce8\u518c\u5730\u5740\u662f`http://localhost:9095`\u3002\\n\\n\u5173\u4e8e\u6ce8\u518c\u65b9\u5f0f\u7684\u4f7f\u7528\uff0c\u8bf7\u53c2\u8003 [\u5e94\u7528\u5ba2\u6237\u7aef\u63a5\u5165](https://shenyu.apache.org/docs/design/register-center-design/) \u3002\\n\\n\\n\\n#### 1.1  \u58f0\u660e\u6ce8\u518c\u63a5\u53e3\\n\\n\u4f7f\u7528\u6ce8\u89e3`@ShenyuDubboClient`\u5c06\u670d\u52a1\u6ce8\u518c\u5230\u7f51\u5173\u3002\u7b80\u5355`demo`\u5982\u4e0b\uff1a\\n\\n```java\\n// dubbo\u670d\u52a1\\n@Service(\\"dubboTestService\\")\\npublic class DubboTestServiceImpl implements DubboTestService {\\n    \\n    @Override\\n    @ShenyuDubboClient(path = \\"/findById\\", desc = \\"Query by Id\\") // \u9700\u8981\u6ce8\u518c\u7684\u65b9\u6cd5\\n    public DubboTest findById(final String id) {\\n        return new DubboTest(id, \\"hello world shenyu Apache, findById\\");\\n    }\\n\\n    //......\\n}\\n```\\n\\n\u6ce8\u89e3\u5b9a\u4e49\uff1a\\n\\n```java\\n/**\\n * \u4f5c\u7528\u4e8e\u7c7b\u548c\u65b9\u6cd5\u4e0a\\n */\\n@Retention(RetentionPolicy.RUNTIME)\\n@Target({ElementType.TYPE, ElementType.METHOD})\\n@Inherited\\npublic @interface ShenyuDubboClient {\\n    \\n\\t//\u6ce8\u518c\u8def\u5f84\\n    String path();\\n    \\n    //\u89c4\u5219\u540d\u79f0\\n    String ruleName() default \\"\\";\\n   \\n    //\u63cf\u8ff0\u4fe1\u606f\\n    String desc() default \\"\\";\\n\\n    //\u662f\u5426\u542f\u7528\\n    boolean enabled() default true;\\n}\\n\\n```\\n\\n#### 1.2 \u626b\u63cf\u6ce8\u89e3\u4fe1\u606f\\n\\n\u6ce8\u89e3\u626b\u63cf\u901a\u8fc7`ApacheDubboServiceBeanListener`\u5b8c\u6210\uff0c\u5b83\u5b9e\u73b0\u4e86`ApplicationListener<ContextRefreshedEvent>`\u63a5\u53e3\uff0c\u5728`Spring`\u5bb9\u5668\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u53d1\u751f\u4e0a\u4e0b\u6587\u5237\u65b0\u4e8b\u4ef6\u65f6\uff0c\u5f00\u59cb\u6267\u884c\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5`onApplicationEvent()`\u3002\\n\\n\u5728\u6784\u9020\u5668\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\uff1a\\n\\n- \u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\\n- \u5f00\u542f\u7ebf\u7a0b\u6c60\\n- \u542f\u52a8\u6ce8\u518c\u4e2d\u5fc3\uff0c\u7528\u4e8e\u5411`shenyu-admin`\u6ce8\u518c\\n\\n```java\\npublic class ApacheDubboServiceBeanListener implements ApplicationListener<ContextRefreshedEvent> {\\n\\n\\t// ......\\n\\n    //\u6784\u9020\u5668\\n    public ApacheDubboServiceBeanListener(final PropertiesConfig clientConfig, final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\\n        //1.\u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\\n        Properties props = clientConfig.getProps();\\n        String contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);\\n        String appName = props.getProperty(ShenyuClientConstants.APP_NAME);\\n        if (StringUtils.isBlank(contextPath)) {\\n            throw new ShenyuClientIllegalArgumentException(\\"apache dubbo client must config the contextPath or appName\\");\\n        }\\n        this.contextPath = contextPath;\\n        this.appName = appName;\\n        this.host = props.getProperty(ShenyuClientConstants.HOST);\\n        this.port = props.getProperty(ShenyuClientConstants.PORT);\\n        //2.\u5f00\u542f\u7ebf\u7a0b\u6c60\\n        executorService = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder().setNameFormat(\\"shenyu-apache-dubbo-client-thread-pool-%d\\").build());\\n        //3.\u542f\u52a8\u6ce8\u518c\u4e2d\u5fc3\\n        publisher.start(shenyuClientRegisterRepository);\\n    }\\n\\n    /**\\n     * \u4e0a\u4e0b\u6587\u5237\u65b0\u4e8b\u4ef6\uff0c\u6267\u884c\u65b9\u6cd5\u903b\u8f91\\n     */\\n    @Override\\n    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {\\n        //......\\n    }\\n```\\n\\n- ApacheDubboServiceBeanListener#onApplicationEvent()\\n\\n\u91cd\u5199\u7684\u65b9\u6cd5\u903b\u8f91\uff1a\u8bfb\u53d6`Dubbo`\u670d\u52a1`ServiceBean`\uff0c\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\u548c`URI`\u5bf9\u8c61\uff0c\u5e76\u5411`shenyu-admin`\u6ce8\u518c\u3002\\n\\n```java\\n    @Override\\n    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {\\n        //\u8bfb\u53d6ServiceBean\\n        Map<String, ServiceBean> serviceBean = contextRefreshedEvent.getApplicationContext().getBeansOfType(ServiceBean.class);\\n        if (serviceBean.isEmpty()) {\\n            return;\\n        }\\n        //\u4fdd\u8bc1\u8be5\u65b9\u6cd5\u53ea\u6267\u884c\u4e00\u6b21\\n        if (!registered.compareAndSet(false, true)) {\\n            return;\\n        }\\n        //\u5904\u7406\u5143\u6570\u636e\u5bf9\u8c61\\n        for (Map.Entry<String, ServiceBean> entry : serviceBean.entrySet()) {\\n            handler(entry.getValue());\\n        }\\n        //\u5904\u7406URI\u5bf9\u8c61\\n        serviceBean.values().stream().findFirst().ifPresent(bean -> {\\n            publisher.publishEvent(buildURIRegisterDTO(bean));\\n        });\\n    }\\n```\\n\\n- handler()\\n\\n  \u5728`handler()`\u65b9\u6cd5\u4e2d\uff0c\u4ece`serviceBean`\u4e2d\u8bfb\u53d6\u6240\u6709\u65b9\u6cd5\uff0c\u5224\u65ad\u65b9\u6cd5\u4e0a\u662f\u5426\u6709`ShenyuDubboClient`\u6ce8\u89e3\uff0c\u5982\u679c\u5b58\u5728\u5c31\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u5e76\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\uff0c\u5411`shenyu-admin`\u6ce8\u518c\u8be5\u65b9\u6cd5\u3002\\n\\n```java\\n    private void handler(final ServiceBean<?> serviceBean) {\\n        //\u83b7\u53d6\u4ee3\u7406\u5bf9\u8c61\\n        Object refProxy = serviceBean.getRef();\\n        //\u83b7\u53d6class\u4fe1\u606f\\n        Class<?> clazz = refProxy.getClass();\\n        if (AopUtils.isAopProxy(refProxy)) {\\n            clazz = AopUtils.getTargetClass(refProxy);\\n        }\\n        //\u83b7\u53d6\u6240\u6709\u65b9\u6cd5\\n        Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);\\n        for (Method method : methods) {\\n            //\u8bfb\u53d6ShenyuDubboClient\u6ce8\u89e3\u4fe1\u606f\\n            ShenyuDubboClient shenyuDubboClient = method.getAnnotation(ShenyuDubboClient.class);\\n            if (Objects.nonNull(shenyuDubboClient)) {\\n                //\u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u5e76\u6ce8\u518c\\n                publisher.publishEvent(buildMetaDataDTO(serviceBean, shenyuDubboClient, method));\\n            }\\n        }\\n    }\\n```\\n\\n- buildMetaDataDTO()\\n\\n  \u6784\u5efa\u5143\u6570\u636e\u5bf9\u8c61\uff0c\u5728\u8fd9\u91cc\u6784\u5efa\u65b9\u6cd5\u6ce8\u518c\u7684\u5fc5\u8981\u4fe1\u606f\uff0c\u540e\u7eed\u7528\u4e8e\u9009\u62e9\u5668\u6216\u89c4\u5219\u5339\u914d\u3002\\n\\n```java\\n    private MetaDataRegisterDTO buildMetaDataDTO(final ServiceBean<?> serviceBean, final ShenyuDubboClient shenyuDubboClient, final Method method) {\\n        //\u5e94\u7528\u540d\u79f0\\n        String appName = buildAppName(serviceBean);\\n        //\u65b9\u6cd5\u8def\u5f84\\n        String path = contextPath + shenyuDubboClient.path();\\n        //\u63cf\u8ff0\u4fe1\u606f\\n        String desc = shenyuDubboClient.desc();\\n        //\u670d\u52a1\u540d\u79f0\\n        String serviceName = serviceBean.getInterface();\\n        //\u89c4\u5219\u540d\u79f0\\n        String configRuleName = shenyuDubboClient.ruleName();\\n        String ruleName = (\\"\\".equals(configRuleName)) ? path : configRuleName;\\n        //\u65b9\u6cd5\u540d\u79f0\\n        String methodName = method.getName();\\n        //\u53c2\u6570\u7c7b\u578b\\n        Class<?>[] parameterTypesClazz = method.getParameterTypes();\\n        String parameterTypes = Arrays.stream(parameterTypesClazz).map(Class::getName).collect(Collectors.joining(\\",\\"));\\n        return MetaDataRegisterDTO.builder()\\n                .appName(appName)\\n                .serviceName(serviceName)\\n                .methodName(methodName)\\n                .contextPath(contextPath)\\n                .host(buildHost())\\n                .port(buildPort(serviceBean))\\n                .path(path)\\n                .ruleName(ruleName)\\n                .pathDesc(desc)\\n                .parameterTypes(parameterTypes)\\n                .rpcExt(buildRpcExt(serviceBean)) //dubbo\u670d\u52a1\u7684\u6269\u5c55\u4fe1\u606f\\n                .rpcType(RpcTypeEnum.DUBBO.getName())\\n                .enabled(shenyuDubboClient.enabled())\\n                .build();\\n    }\\n```\\n\\n- buildRpcExt()\\n\\n  `dubbo`\u670d\u52a1\u7684\u6269\u5c55\u4fe1\u606f\\n\\n ```java\\n    private String buildRpcExt(final ServiceBean serviceBean) {\\n        DubboRpcExt build = DubboRpcExt.builder()\\n                .group(StringUtils.isNotEmpty(serviceBean.getGroup()) ? serviceBean.getGroup() : \\"\\")//\u5206\u7ec4\\n                .version(StringUtils.isNotEmpty(serviceBean.getVersion()) ? serviceBean.getVersion() : \\"\\")//\u7248\u672c\\n                .loadbalance(StringUtils.isNotEmpty(serviceBean.getLoadbalance()) ? serviceBean.getLoadbalance() : Constants.DEFAULT_LOADBALANCE)//\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff0c\u9ed8\u8ba4\u968f\u673a\\n                .retries(Objects.isNull(serviceBean.getRetries()) ? Constants.DEFAULT_RETRIES : serviceBean.getRetries())//\u91cd\u8bd5\u6b21\u6570\uff0c\u9ed8\u8ba42\\n                .timeout(Objects.isNull(serviceBean.getTimeout()) ? Constants.DEFAULT_CONNECT_TIMEOUT : serviceBean.getTimeout())//\u8d85\u65f6\uff0c\u9ed8\u8ba43000\\n                .sent(Objects.isNull(serviceBean.getSent()) ? Constants.DEFAULT_SENT : serviceBean.getSent())//sent\uff0c\u9ed8\u8ba4false\\n                .cluster(StringUtils.isNotEmpty(serviceBean.getCluster()) ? serviceBean.getCluster() : Constants.DEFAULT_CLUSTER)//\u96c6\u7fa4\u7b56\u7565\uff0c\u9ed8\u8ba4failover\\n                .url(\\"\\")\\n                .build();\\n        return GsonUtils.getInstance().toJson(build);\\n    }\\n ```\\n\\n\\n\\n- buildURIRegisterDTO()\\n\\n  \u6784\u5efa`URI`\u5bf9\u8c61\uff0c\u6ce8\u518c\u670d\u52a1\u672c\u8eab\u7684\u4fe1\u606f\uff0c\u540e\u7eed\u53ef\u7528\u4e8e\u670d\u52a1\u63a2\u6d3b\u3002\\n\\n\\n```java\\nprivate URIRegisterDTO buildURIRegisterDTO(final ServiceBean serviceBean) {\\n        return URIRegisterDTO.builder()\\n                .contextPath(this.contextPath) //\u4e0a\u4e0b\u6587\u8def\u5f84\\n                .appName(buildAppName(serviceBean))//\u5e94\u7528\u540d\u79f0\\n                .rpcType(RpcTypeEnum.DUBBO.getName())//rpc\u7c7b\u578b\uff1adubbo\\n                .host(buildHost()) //host\\n                .port(buildPort(serviceBean))//port\\n                .build();\\n }\\n```\\n\\n\\n\\n\u5177\u4f53\u7684\u6ce8\u518c\u903b\u8f91\u7531\u6ce8\u518c\u4e2d\u5fc3\u5b9e\u73b0\uff0c\u8bf7\u53c2\u8003 [\u5ba2\u6237\u7aef\u63a5\u5165\u539f\u7406](https://shenyu.apache.org/zh/docs/design/register-center-design/) \u3002\\n\\n```java\\n//\u5411\u6ce8\u518c\u4e2d\u5fc3\uff0c\u53d1\u5e03\u6ce8\u518c\u4e8b\u4ef6   \\npublisher.publishEvent();\\n```\\n\\n#### 1.3 \u5904\u7406\u6ce8\u518c\u4fe1\u606f\\n\\n\u5ba2\u6237\u7aef\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u6ce8\u518c\u7684\u5143\u6570\u636e\u548c`URI`\u6570\u636e\uff0c\u5728`shenyu-admin`\u7aef\u8fdb\u884c\u5904\u7406\uff0c\u8d1f\u8d23\u5b58\u50a8\u5230\u6570\u636e\u5e93\u548c\u540c\u6b65\u7ed9`shenyu`\u7f51\u5173\u3002`Dubbo`\u63d2\u4ef6\u7684\u5ba2\u6237\u7aef\u6ce8\u518c\u5904\u7406\u903b\u8f91\u5728`ShenyuClientRegisterDubboServiceImpl`\u4e2d\u3002\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-dubbo-plugin/ShenyuClientRegisterDubboServiceImpl.png)\\n\\n\\n\\n- ShenyuClientRegisterService\uff1a\u5ba2\u6237\u7aef\u6ce8\u518c\u670d\u52a1\uff0c\u9876\u5c42\u63a5\u53e3\uff1b\\n- FallbackShenyuClientRegisterService\uff1a\u6ce8\u518c\u5931\u8d25\uff0c\u63d0\u4f9b\u91cd\u8bd5\u64cd\u4f5c\uff1b\\n- AbstractShenyuClientRegisterServiceImpl\uff1a\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0\u90e8\u5206\u516c\u5171\u6ce8\u518c\u903b\u8f91\uff1b\\n- ShenyuClientRegisterDubboServiceImpl\uff1a\u5b9e\u73b0`Dubbo`\u63d2\u4ef6\u7684\u6ce8\u518c\uff1b\\n\\n##### 1.3.1 \u6ce8\u518c\u670d\u52a1\\n\\n- org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()\\n\\n  \u5ba2\u6237\u7aef\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u6ce8\u518c\u7684\u5143\u6570\u636e`MetaDataRegisterDTO`\u5bf9\u8c61\u5728`shenyu-admin`\u7684`register()`\u65b9\u6cd5\u88ab\u63a5\u9001\u5230\u3002\\n\\n```java\\n   @Override\\n    public String register(final MetaDataRegisterDTO dto) {\\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\\n        String selectorHandler = selectorHandler(dto);\\n        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);\\n        //2. \u6ce8\u518c\u89c4\u5219\\n        String ruleHandler = ruleHandler();\\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\\n        ruleService.registerDefault(ruleDTO);\\n        //3. \u6ce8\u518c\u5143\u6570\u636e\\n        registerMetadata(dto);\\n        //4. \u6ce8\u518cContextPath\\n        String contextPath = dto.getContextPath();\\n        if (StringUtils.isNotEmpty(contextPath)) {\\n            registerContextPath(dto);\\n        }\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n###### 1.3.1.1 \u6ce8\u518c\u9009\u62e9\u5668\\n\\n- org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()\\n\\n\u6784\u5efa`contextPath`\uff0c\u67e5\u627e\u9009\u62e9\u5668\u4fe1\u606f\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u5b58\u5728\u5c31\u8fd4\u56de`id`\uff1b\u4e0d\u5b58\u5728\u5c31\u521b\u5efa\u9ed8\u8ba4\u7684\u9009\u62e9\u5668\u4fe1\u606f\u3002\\n\\n```java\\n    @Override\\n    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {\\n        // \u6784\u5efacontextPath\\n        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());\\n        // \u901a\u8fc7\u540d\u79f0\u67e5\u627e\u9009\u62e9\u5668\u4fe1\u606f\u662f\u5426\u5b58\u5728\\n        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);\\n        if (Objects.isNull(selectorDO)) {\\n            // \u4e0d\u5b58\u5728\u5c31\u521b\u5efa\u9ed8\u8ba4\u7684\u9009\u62e9\u5668\u4fe1\u606f\\n            return registerSelector(contextPath, pluginName, selectorHandler);\\n        }\\n        return selectorDO.getId();\\n    }\\n```\\n\\n- \u9ed8\u8ba4\u9009\u62e9\u5668\u4fe1\u606f\\n\\n  \u5728\u8fd9\u91cc\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u4fe1\u606f\u53ca\u5176\u6761\u4ef6\u5c5e\u6027\u3002\\n\\n```java\\n   //\u6ce8\u518c\u9009\u62e9\u5668\\n   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {\\n        //\u6784\u5efa\u9009\u62e9\u5668\\n        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());\\n        selectorDTO.setHandle(selectorHandler);\\n        //\u6ce8\u518c\u9ed8\u8ba4\u9009\u62e9\u5668\\n        return registerDefault(selectorDTO);\\n    }\\n     //\u6784\u5efa\u9009\u62e9\u5668\\n    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {\\n        //\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\\n        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);\\n        selectorDTO.setPluginId(pluginId);\\n         //\u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u7684\u6761\u4ef6\u5c5e\u6027\\n        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));\\n        return selectorDTO;\\n    }\\n```\\n\\n- \u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\\n\\n```java\\nprivate SelectorDTO buildDefaultSelectorDTO(final String name) {\\n    return SelectorDTO.builder()\\n            .name(name) // \u540d\u79f0\\n            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // \u9ed8\u8ba4\u7c7b\u578b\u81ea\u5b9a\u4e49\\n            .matchMode(MatchModeEnum.AND.getCode()) //\u9ed8\u8ba4\u5339\u914d\u65b9\u5f0f and\\n            .enabled(Boolean.TRUE)  //\u9ed8\u8ba4\u542f\u5f00\u542f\\n            .loged(Boolean.TRUE)  //\u9ed8\u8ba4\u8bb0\u5f55\u65e5\u5fd7\\n            .continued(Boolean.TRUE) //\u9ed8\u8ba4\u7ee7\u7eed\u540e\u7eed\u9009\u62e9\u5668\\n            .sort(1) //\u9ed8\u8ba4\u987a\u5e8f1\\n            .build();\\n}\\n```\\n\\n- \u6784\u5efa\u9ed8\u8ba4\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\\n\\n```java\\nprivate List<SelectorConditionDTO> buildDefaultSelectorConditionDTO(final String contextPath) {\\n    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();\\n    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // \u9ed8\u8ba4\u53c2\u6570\u7c7b\u578bURI\\n    selectorConditionDTO.setParamName(\\"/\\");\\n    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // \u9ed8\u8ba4\u5339\u914d\u7b56\u7565 match\\n    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // \u9ed8\u8ba4\u503c /contextPath/**\\n    return Collections.singletonList(selectorConditionDTO);\\n}\\n```\\n\\n- \u6ce8\u518c\u9ed8\u8ba4\u9009\u62e9\u5668\\n\\n```java\\n@Override\\npublic String registerDefault(final SelectorDTO selectorDTO) {\\n    //\u9009\u62e9\u5668\u4fe1\u606f\\n    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\\n    //\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\\n    List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\\n    if (StringUtils.isEmpty(selectorDTO.getId())) {\\n        // \u5411\u6570\u636e\u5e93\u63d2\u5165\u9009\u62e9\u5668\u4fe1\u606f\\n        selectorMapper.insertSelective(selectorDO);\\n          // \u5411\u6570\u636e\u5e93\u63d2\u5165\u9009\u62e9\u5668\u6761\u4ef6\u5c5e\u6027\\n        selectorConditionDTOs.forEach(selectorConditionDTO -> {\\n            selectorConditionDTO.setSelectorId(selectorDO.getId());            selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\\n        });\\n    }\\n    // \u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\uff0c\u5411\u7f51\u5173\u540c\u6b65\u9009\u62e9\u4fe1\u606f\u53ca\u5176\u6761\u4ef6\u5c5e\u6027\\n    publishEvent(selectorDO, selectorConditionDTOs);\\n    return selectorDO.getId();\\n}\\n```\\n\\n###### 1.3.1.2 \u6ce8\u518c\u89c4\u5219\\n\\n\u5728\u6ce8\u518c\u670d\u52a1\u7684\u7b2c\u4e8c\u6b65\u4e2d\uff0c\u5f00\u59cb\u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\uff0c\u7136\u540e\u6ce8\u518c\u89c4\u5219\u3002\\n\\n```java\\n@Override\\n    public String register(final MetaDataRegisterDTO dto) {\\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\\n        //......\\n        \\n        //2. \u6ce8\u518c\u89c4\u5219\\n        // \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n        String ruleHandler = ruleHandler();\\n        // \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\\n        // \u6ce8\u518c\u89c4\u5219\\n        ruleService.registerDefault(ruleDTO);\\n        \\n        //3. \u6ce8\u518c\u5143\u6570\u636e\\n        //......\\n        \\n        //4. \u6ce8\u518cContextPath\\n        //......\\n        \\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n- \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n\\n```java\\n    @Override\\n    protected String ruleHandler() {\\n        // \u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n        return new DubboRuleHandle().toJson();\\n    }\\n```\\n\\n`Dubbo`\u63d2\u4ef6\u9ed8\u8ba4\u89c4\u5219\u5904\u7406\u5c5e\u6027\\n\\n```java\\npublic class DubboRuleHandle implements RuleHandle {\\n\\n    /**\\n     * dubbo\u670d\u52a1\u7248\u672c\u4fe1\u606f.\\n     */\\n    private String version;\\n\\n    /**\\n     * \u5206\u7ec4.\\n     */\\n    private String group;\\n\\n    /**\\n     * \u91cd\u8bd5\u6b21\u6570.\\n     */\\n    private Integer retries = 0;\\n\\n    /**\\n     * \u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff1a\u9ed8\u8ba4\u968f\u673a\\n     */\\n    private String loadbalance = LoadBalanceEnum.RANDOM.getName();\\n\\n    /**\\n     * \u8d85\u65f6\uff0c\u9ed8\u8ba43000\\n     */\\n    private long timeout = Constants.TIME_OUT;\\n}\\n```\\n\\n\\n\\n- \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n\\n```java\\n  // \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {\\n        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());\\n    }\\n   //  \u6784\u5efa\u9ed8\u8ba4\u89c4\u5219\u4fe1\u606f\\n    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {\\n        RuleDTO ruleDTO = RuleDTO.builder()\\n                .selectorId(selectorId) //\u5173\u8054\u7684\u9009\u62e9\u5668id\\n                .name(ruleName) //\u89c4\u5219\u540d\u79f0\\n                .matchMode(MatchModeEnum.AND.getCode()) // \u9ed8\u8ba4\u5339\u914d\u6a21\u5f0f and\\n                .enabled(Boolean.TRUE) // \u9ed8\u8ba4\u5f00\u542f\\n                .loged(Boolean.TRUE) //\u9ed8\u8ba4\u8bb0\u5f55\u65e5\u5fd7\\n                .sort(1) //\u9ed8\u8ba4\u987a\u5e8f 1\\n                .handle(ruleHandler)\\n                .build();\\n        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()\\n                .paramType(ParamTypeEnum.URI.getName()) // \u9ed8\u8ba4\u53c2\u6570\u7c7b\u578bURI\\n                .paramName(\\"/\\")\\n                .paramValue(path) //\u53c2\u6570\u503cpath\\n                .build();\\n        if (path.indexOf(\\"*\\") > 1) {\\n            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //\u5982\u679cpath\u4e2d\u6709*\uff0c\u64cd\u4f5c\u7c7b\u578b\u5219\u9ed8\u8ba4\u4e3a match\\n        } else {\\n            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // \u5426\u5219\uff0c\u9ed8\u8ba4\u64cd\u4f5c\u7c7b\u578b = \\n        }\\n        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));\\n        return ruleDTO;\\n    }\\n```\\n\\n- org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()\\n\\n\u6ce8\u518c\u89c4\u5219\uff1a\u5411\u6570\u636e\u5e93\u63d2\u5165\u8bb0\u5f55\uff0c\u5e76\u5411\u7f51\u5173\u53d1\u5e03\u4e8b\u4ef6\uff0c\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\\n\\n```java\\n\\n    @Override\\n    public String registerDefault(final RuleDTO ruleDTO) {\\n        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());\\n        if (Objects.nonNull(exist)) {\\n            return \\"\\";\\n        }\\n\\n        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);\\n        List<RuleConditionDTO> ruleConditions = ruleDTO.getRuleConditions();\\n        if (StringUtils.isEmpty(ruleDTO.getId())) {\\n            // \u5411\u6570\u636e\u5e93\u63d2\u5165\u89c4\u5219\u4fe1\u606f\\n            ruleMapper.insertSelective(ruleDO);\\n            //\u5411\u6570\u636e\u5e93\u63d2\u5165\u89c4\u5219\u4f53\u6761\u4ef6\u5c5e\u6027\\n            ruleConditions.forEach(ruleConditionDTO -> {\\n                ruleConditionDTO.setRuleId(ruleDO.getId());                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));\\n            });\\n        }\\n        // \u5411\u7f51\u5173\u53d1\u5e03\u4e8b\u4ef6\uff0c\u8fdb\u884c\u6570\u636e\u540c\u6b65\\n        publishEvent(ruleDO, ruleConditions);\\n        return ruleDO.getId();\\n    }\\n\\n```\\n\\n\\n\\n###### 1.3.1.3 \u6ce8\u518c\u5143\u6570\u636e\\n\\n\u5143\u6570\u636e\u4e3b\u8981\u7528\u4e8e`RPC`\u670d\u52a1\u7684\u8c03\u7528\u3002\\n\\n```java\\n   @Override\\n    public String register(final MetaDataRegisterDTO dto) {\\n        //1. \u6ce8\u518c\u9009\u62e9\u5668\\n        //......\\n        \\n        //2. \u6ce8\u518c\u89c4\u5219\\n        //......\\n        \\n        //3. \u6ce8\u518c\u5143\u6570\u636e\\n        registerMetadata(dto);\\n        \\n        //4. \u6ce8\u518cContextPath\\n        //......\\n        \\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n- org.apache.shenyu.admin.service.register.ShenyuClientRegisterDubboServiceImpl#registerMetadata()\\n\\n  \u63d2\u5165\u6216\u66f4\u65b0\u5143\u6570\u636e\uff0c\u7136\u540e\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u5230\u7f51\u5173\u3002\\n\\n```java\\n    @Override\\n    protected void registerMetadata(final MetaDataRegisterDTO dto) {\\n            // \u83b7\u53d6metaDataService\\n            MetaDataService metaDataService = getMetaDataService();\\n            // \u5143\u6570\u636e\u662f\u5426\u5b58\u5728\\n            MetaDataDO exist = metaDataService.findByPath(dto.getPath());\\n            // \u63d2\u5165\u6216\u66f4\u65b0\u5143\u6570\u636e\\n            metaDataService.saveOrUpdateMetaData(exist, dto);\\n    }\\n\\n    @Override\\n    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {\\n        DataEventTypeEnum eventType;\\n        // \u6570\u636e\u7c7b\u578b\u8f6c\u6362 DTO->DO\\n        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);\\n        // \u63d2\u5165\u6570\u636e\\n        if (Objects.isNull(exist)) {\\n            Timestamp currentTime = new Timestamp(System.currentTimeMillis());\\n            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());\\n            metaDataDO.setDateCreated(currentTime);\\n            metaDataDO.setDateUpdated(currentTime);\\n            metaDataMapper.insert(metaDataDO);\\n            eventType = DataEventTypeEnum.CREATE;\\n        } else {\\n            // \u66f4\u65b0\u6570\u636e\\n            metaDataDO.setId(exist.getId());\\n            metaDataMapper.update(metaDataDO);\\n            eventType = DataEventTypeEnum.UPDATE;\\n        }\\n        // \u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u5230\u7f51\u5173\\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,\\n                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));\\n    }\\n```\\n\\n\\n\\n##### 1.3.2 \u6ce8\u518cURI\\n\\n- org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()\\n\\n\u670d\u52a1\u7aef\u6536\u5230\u5ba2\u6237\u7aef\u6ce8\u518c\u7684`URI`\u4fe1\u606f\u540e\uff0c\u8fdb\u884c\u5904\u7406\u3002\\n\\n```java\\n    @Override\\n    public String registerURI(final String selectorName, final List<URIRegisterDTO> uriList) {\\n        String result;\\n        String key = key(selectorName);\\n        try {\\n            this.removeFallBack(key);\\n            // \u6ce8\u518cURI\\n            result = this.doRegisterURI(selectorName, uriList);\\n            logger.info(\\"Register success: {},{}\\", selectorName, uriList);\\n        } catch (Exception ex) {\\n            logger.warn(\\"Register exception: cause:{}\\", ex.getMessage());\\n            result = \\"\\";\\n            // \u6ce8\u518c\u5931\u8d25\u540e\uff0c\u8fdb\u884c\u91cd\u8bd5\\n            this.addFallback(key, new FallbackHolder(selectorName, uriList));\\n        }\\n        return result;\\n    }\\n```\\n\\n- org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()\\n\\n\u4ece\u5ba2\u6237\u7aef\u6ce8\u518c\u7684`URI`\u4e2d\u83b7\u53d6\u6709\u6548\u7684`URI`\uff0c\u66f4\u65b0\u5bf9\u5e94\u7684\u9009\u62e9\u5668`handle`\u5c5e\u6027\uff0c\u5411\u7f51\u5173\u53d1\u9001\u9009\u62e9\u5668\u66f4\u65b0\u4e8b\u4ef6\u3002\\n\\n```java\\n@Override\\n    public String doRegisterURI(final String selectorName, final List<URIRegisterDTO> uriList) {\\n        //\u53c2\u6570\u68c0\u67e5\\n        if (CollectionUtils.isEmpty(uriList)) {\\n            return \\"\\";\\n        }\\n        //\u83b7\u53d6\u9009\u62e9\u5668\u4fe1\u606f\\n        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\\n        if (Objects.isNull(selectorDO)) {\\n            throw new ShenyuException(\\"doRegister Failed to execute,wait to retry.\\");\\n        }\\n        // \u83b7\u53d6\u6709\u6548\u7684URI\\n        List<URIRegisterDTO> validUriList = uriList.stream().filter(dto -> Objects.nonNull(dto.getPort()) && StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());\\n        // \u6784\u5efa\u9009\u62e9\u5668\u7684handle\u5c5e\u6027\\n        String handler = buildHandle(validUriList, selectorDO);\\n        if (handler != null) {\\n            selectorDO.setHandle(handler);\\n            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\\n            selectorData.setHandle(handler);\\n            // \u5411\u6570\u636e\u5e93\u66f4\u65b0\u9009\u62e9\u5668\u7684handle\u5c5e\u6027\\n            selectorService.updateSelective(selectorDO);\\n            // \u5411\u7f51\u5173\u53d1\u9001\u9009\u62e9\u5668\u66f4\u65b0\u4e8b\u4ef6\\n            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));\\n        }\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n```\\n\\n\u5173\u4e8e\u670d\u52a1\u6ce8\u518c\u7684\u6e90\u7801\u5206\u6790\u5c31\u4ee5\u53ca\u5b8c\u6210\u4e86\uff0c\u5206\u6790\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-dubbo-plugin/dubbo-register-zh.png)\\n\\n\\n\\n\u63a5\u4e0b\u6765\u5c31\u5206\u6790`dubbo`\u63d2\u4ef6\u662f\u5982\u4f55\u6839\u636e\u8fd9\u4e9b\u4fe1\u606f\u5411`http`\u670d\u52a1\u53d1\u8d77\u8c03\u7528\u3002\\n\\n\\n\\n### 2. \u670d\u52a1\u8c03\u7528\\n\\n`dubbo`\u63d2\u4ef6\u662f`ShenYu`\u7f51\u5173\u7528\u4e8e\u5c06`http`\u8bf7\u6c42\u8f6c\u6210 `dubbo\u534f\u8bae`\uff0c\u8c03\u7528`dubbo`\u670d\u52a1\u7684\u6838\u5fc3\u5904\u7406\u63d2\u4ef6\u3002\\n\\n\u4ee5\u5b98\u7f51\u63d0\u4f9b\u7684\u6848\u4f8b [Dubbo\u5feb\u901f\u5f00\u59cb](https://shenyu.apache.org/docs/quick-start/quick-start-dubbo/) \u4e3a\u4f8b\uff0c\u4e00\u4e2a`dubbo`\u670d\u52a1\u901a\u8fc7\u6ce8\u518c\u4e2d\u5fc3\u5411`shenyu-admin`\u6ce8\u518c\u540e\uff0c\u901a\u8fc7`ShenYu`\u7f51\u5173\u4ee3\u7406\uff0c\u8bf7\u6c42\u5982\u4e0b\uff1a\\n\\n```\\nGET http://localhost:9195/dubbo/findById?id=100\\nAccept: application/json\\n```\\n\\n\\n\\n`Dubbo`\u63d2\u4ef6\u4e2d\uff0c\u7c7b\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-dubbo-plugin/ApacheDubboPlugin.png)\\n\\n- ShenyuPlugin\uff1a\u9876\u5c42\u63a5\u53e3\uff0c\u5b9a\u4e49\u63a5\u53e3\u65b9\u6cd5\uff1b\\n- AbstractShenyuPlugin\uff1a\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0\u63d2\u4ef6\u5171\u6709\u903b\u8f91\uff1b\\n- AbstractDubboPlugin\uff1adubbo\u63d2\u4ef6\u62bd\u8c61\u7c7b\uff0c\u5b9e\u73b0`dubbo`\u5171\u6709\u903b\u8f91\uff1b\\n- ApacheDubboPlugin\uff1aApacheDubbo\u63d2\u4ef6\u3002\\n\\n> ShenYu\u7f51\u5173\u652f\u6301ApacheDubbo\u548cAlibabaDubbo\\n\\n#### 2.1 \u63a5\u6536\u8bf7\u6c42\\n\\n\u901a\u8fc7`ShenYu`\u7f51\u5173\u4ee3\u7406\u540e\uff0c\u8bf7\u6c42\u5165\u53e3\u662f`ShenyuWebHandler`\uff0c\u5b83\u5b9e\u73b0\u4e86`org.springframework.web.server.WebHandler`\u63a5\u53e3\u3002\\n\\n```java\\npublic final class ShenyuWebHandler implements WebHandler, ApplicationListener<SortPluginEvent> {\\n    //......\\n    \\n    /**\\n     * \u5904\u7406web\u8bf7\u6c42\\n     */\\n    @Override\\n    public Mono<Void> handle(@NonNull final ServerWebExchange exchange) {\\n       // \u6267\u884c\u9ed8\u8ba4\u63d2\u4ef6\u94fe\\n        Mono<Void> execute = new DefaultShenyuPluginChain(plugins).execute(exchange);\\n        if (scheduled) {\\n            return execute.subscribeOn(scheduler);\\n        }\\n        return execute;\\n    }\\n    \\n    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {\\n\\n        private int index;\\n\\n        private final List<ShenyuPlugin> plugins;\\n\\n        /**\\n         * \u5b9e\u4f8b\u5316\u9ed8\u8ba4\u63d2\u4ef6\u94fe\\n         */\\n        DefaultShenyuPluginChain(final List<ShenyuPlugin> plugins) {\\n            this.plugins = plugins;\\n        }\\n\\n        /**\\n         * \u6267\u884c\u6bcf\u4e2a\u63d2\u4ef6.\\n         */\\n        @Override\\n        public Mono<Void> execute(final ServerWebExchange exchange) {\\n            return Mono.defer(() -> {\\n                if (this.index < plugins.size()) {\\n                    // \u83b7\u53d6\u5f53\u524d\u6267\u884c\u63d2\u4ef6\\n                    ShenyuPlugin plugin = plugins.get(this.index++);\\n                    // \u662f\u5426\u8df3\u8fc7\u5f53\u524d\u63d2\u4ef6\\n                    boolean skip = plugin.skip(exchange);\\n                    if (skip) {\\n                        // \u5982\u679c\u8df3\u8fc7\u5c31\u6267\u884c\u4e0b\u4e00\u4e2a\\n                        return this.execute(exchange);\\n                    }\\n                    // \u6267\u884c\u5f53\u524d\u63d2\u4ef6\\n                    return plugin.execute(exchange, this);\\n                }\\n                return Mono.empty();\\n            });\\n        }\\n    }\\n}\\n```\\n\\n#### 2.2 \u5339\u914d\u89c4\u5219\\n\\n- org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()\\n\\n\u5728`execute()`\u65b9\u6cd5\u4e2d\u6267\u884c\u9009\u62e9\u5668\u548c\u89c4\u5219\u7684\u5339\u914d\u903b\u8f91\u3002\\n\\n- \u5339\u914d\u9009\u62e9\u5668\uff1b\\n- \u5339\u914d\u89c4\u5219\uff1b\\n- \u6267\u884c\u63d2\u4ef6\u3002\\n\\n```java\\n@Override\\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        // \u63d2\u4ef6\u540d\u79f0\\n        String pluginName = named();\\n        // \u63d2\u4ef6\u4fe1\u606f\\n        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);\\n        if (pluginData != null && pluginData.getEnabled()) {\\n            // \u9009\u62e9\u5668\u4fe1\u606f\\n            final Collection<SelectorData> selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);\\n            if (CollectionUtils.isEmpty(selectors)) {\\n                return handleSelectorIfNull(pluginName, exchange, chain);\\n            }\\n            // \u5339\u914d\u9009\u62e9\u5668\\n            SelectorData selectorData = matchSelector(exchange, selectors);\\n            if (Objects.isNull(selectorData)) {\\n                return handleSelectorIfNull(pluginName, exchange, chain);\\n            }\\n            selectorLog(selectorData, pluginName);\\n            // \u89c4\u5219\u4fe1\u606f\\n            List<RuleData> rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());\\n            if (CollectionUtils.isEmpty(rules)) {\\n                return handleRuleIfNull(pluginName, exchange, chain);\\n            }\\n            // \u5339\u914d\u89c4\u5219\\n            RuleData rule;\\n            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {\\n                //get last\\n                rule = rules.get(rules.size() - 1);\\n            } else {\\n                rule = matchRule(exchange, rules);\\n            }\\n            if (Objects.isNull(rule)) {\\n                return handleRuleIfNull(pluginName, exchange, chain);\\n            }\\n            ruleLog(rule, pluginName);\\n            // \u6267\u884c\u63d2\u4ef6\\n            return doExecute(exchange, chain, selectorData, rule);\\n        }\\n        return chain.execute(exchange);\\n    }\\n```\\n\\n#### 2.3 \u6267\u884cGlobalPlugin\\n\\n- org.apache.shenyu.plugin.global.GlobalPlugin#execute()\\n\\n`GlobalPlugin`\u662f\u4e00\u4e2a\u5168\u5c40\u63d2\u4ef6\uff0c\u5728`execute()`\u65b9\u6cd5\u4e2d\u6784\u5efa\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002\\n\\n```java\\npublic class GlobalPlugin implements ShenyuPlugin {\\n    // \u6784\u5efa\u4e0a\u4e0b\u6587\u4fe1\u606f\\n    private final ShenyuContextBuilder builder;\\n    \\n    //......\\n    \\n    @Override\\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n       // \u6784\u5efa\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u4f20\u5165\u5230 exchange \u4e2d\\n        ShenyuContext shenyuContext = builder.build(exchange);\\n        exchange.getAttributes().put(Constants.CONTEXT, shenyuContext);\\n        return chain.execute(exchange);\\n    }\\n    \\n    //......\\n}\\n```\\n\\n\\n\\n- org.apache.shenyu.plugin.global.DefaultShenyuContextBuilder#build()\\n\\n\u6784\u5efa\u9ed8\u8ba4\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002\\n\\n```java\\npublic class DefaultShenyuContextBuilder implements ShenyuContextBuilder {\\n    //......\\n    \\n    @Override\\n    public ShenyuContext build(final ServerWebExchange exchange) {\\n        //\u6784\u5efa\u53c2\u6570\\n        Pair<String, MetaData> buildData = buildData(exchange);\\n        //\u5305\u88c5ShenyuContext\\n        return decoratorMap.get(buildData.getLeft()).decorator(buildDefaultContext(exchange.getRequest()), buildData.getRight());\\n    }\\n    \\n    private Pair<String, MetaData> buildData(final ServerWebExchange exchange) {\\n        //......\\n        //\u6839\u636e\u8bf7\u6c42\u7684uri\u83b7\u53d6\u5143\u6570\u636e\\n        MetaData metaData = MetaDataCache.getInstance().obtain(request.getURI().getPath());\\n        if (Objects.nonNull(metaData) && Boolean.TRUE.equals(metaData.getEnabled())) {\\n            exchange.getAttributes().put(Constants.META_DATA, metaData);\\n            return Pair.of(metaData.getRpcType(), metaData);\\n        } else {\\n            return Pair.of(RpcTypeEnum.HTTP.getName(), new MetaData());\\n        }\\n    }\\n    //\u8bbe\u7f6e\u9ed8\u8ba4\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\\n    private ShenyuContext buildDefaultContext(final ServerHttpRequest request) {\\n        String appKey = request.getHeaders().getFirst(Constants.APP_KEY);\\n        String sign = request.getHeaders().getFirst(Constants.SIGN);\\n        String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);\\n        ShenyuContext shenyuContext = new ShenyuContext();\\n        String path = request.getURI().getPath();\\n        shenyuContext.setPath(path); //\u8bf7\u6c42\u8def\u5f84\\n        shenyuContext.setAppKey(appKey);\\n        shenyuContext.setSign(sign);\\n        shenyuContext.setTimestamp(timestamp);\\n        shenyuContext.setStartDateTime(LocalDateTime.now());\\n        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -> shenyuContext.setHttpMethod(httpMethod.name()));//\u8bf7\u6c42\u65b9\u6cd5\\n        return shenyuContext;\\n    }\\n }\\n```\\n\\n- org.apache.shenyu.plugin.dubbo.common.context.DubboShenyuContextDecorator#decorator()\\n\\n\u5305\u88c5`ShenyuContext`\uff1a\\n\\n```java\\npublic class DubboShenyuContextDecorator implements ShenyuContextDecorator {\\n    \\n    @Override\\n    public ShenyuContext decorator(final ShenyuContext shenyuContext, final MetaData metaData) {\\n        shenyuContext.setModule(metaData.getAppName());//\u83b7\u53d6AppName\\n        shenyuContext.setMethod(metaData.getServiceName()); //\u83b7\u53d6ServiceName\\n        shenyuContext.setContextPath(metaData.getContextPath()); //\u83b7\u53d6contextPath\\n        shenyuContext.setRpcType(RpcTypeEnum.DUBBO.getName()); // dubbo\u670d\u52a1\\n        return shenyuContext;\\n    }\\n    \\n    @Override\\n    public String rpcType() {\\n        return RpcTypeEnum.DUBBO.getName();\\n    }\\n}\\n```\\n\\n\\n\\n#### 2.4 \u6267\u884cRpcParamTransformPlugin\\n\\n`RpcParamTransformPlugin`\u8d1f\u8d23\u4ece`http`\u8bf7\u6c42\u4e2d\u8bfb\u53d6\u53c2\u6570\uff0c\u4fdd\u5b58\u5230`exchange`\u4e2d\uff0c\u4f20\u9012\u7ed9`rpc`\u670d\u52a1\u3002\\n\\n- org.apache.shenyu.plugin.base.RpcParamTransformPlugin#execute()\\n\\n\u5728`execute()`\u65b9\u6cd5\u4e2d\uff0c\u6267\u884c\u8be5\u63d2\u4ef6\u7684\u6838\u5fc3\u903b\u8f91\uff1a\u4ece`exchange`\u4e2d\u83b7\u53d6\u8bf7\u6c42\u4fe1\u606f\uff0c\u6839\u636e\u8bf7\u6c42\u4f20\u5165\u7684\u5185\u5bb9\u5f62\u5f0f\u5904\u7406\u53c2\u6570\u3002\\n\\n```java\\npublic class RpcParamTransformPlugin implements ShenyuPlugin {\\n\\n    @Override\\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        //\u4eceexchange\u4e2d\u83b7\u53d6\u8bf7\u6c42\u4fe1\u606f\\n        ServerHttpRequest request = exchange.getRequest();\\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\\n        if (Objects.nonNull(shenyuContext)) {\\n           // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_JSON\\n            MediaType mediaType = request.getHeaders().getContentType();\\n            if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {\\n                return body(exchange, request, chain);\\n            }\\n            // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_FORM_URLENCODED\\n            if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {\\n                return formData(exchange, request, chain);\\n            }\\n            //\u4e00\u822c\u67e5\u8be2\u8bf7\u6c42\\n            return query(exchange, request, chain);\\n        }\\n        return chain.execute(exchange);\\n    }\\n    \\n    // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_JSON\\n    private Mono<Void> body(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\\n        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())\\n                .flatMap(body -> {\\n                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, resolveBodyFromRequest(body));//\u89e3\u6790body\uff0c\u4fdd\u5b58\u5230exchange\u4e2d\\n                    return chain.execute(exchange);\\n                }));\\n    }\\n   // \u5982\u679c\u8bf7\u6c42\u53c2\u6570\u683c\u5f0f\u662fAPPLICATION_FORM_URLENCODED\\n    private Mono<Void> formData(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\\n        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())\\n                .flatMap(map -> {\\n                    String param = resolveBodyFromRequest(map);\\n                    LinkedMultiValueMap<String, String> linkedMultiValueMap;\\n                    try {\\n                        linkedMultiValueMap = BodyParamUtils.buildBodyParams(URLDecoder.decode(param, StandardCharsets.UTF_8.name())); //\u683c\u5f0f\u5316\u6570\u636e\\n                    } catch (UnsupportedEncodingException e) {\\n                        return Mono.error(e);\\n                    }\\n                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.toMap(() -> linkedMultiValueMap));// \u4fdd\u5b58\u5230exchange\u4e2d\\n                    return chain.execute(exchange);\\n                }));\\n    }\\n    //\u4e00\u822c\u67e5\u8be2\u8bf7\u6c42\\n    private Mono<Void> query(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {\\n        exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.ofString(() -> serverHttpRequest.getURI().getQuery()));//\u4fdd\u5b58\u5230exchange\u4e2d\\n        return chain.execute(exchange);\\n    }\\n    //......\\n }\\n```\\n\\n\\n\\n#### 2.5 \u6267\u884cDubboPlugin\\n\\n- org.apache.shenyu.plugin.dubbo.common.AbstractDubboPlugin#doExecute()\\n\\n\u5728`doExecute()`\u65b9\u6cd5\u4e2d\uff0c\u4e3b\u8981\u662f\u68c0\u67e5\u5143\u6570\u636e\u548c\u53c2\u6570\u3002\\n\\n```java\\npublic abstract class AbstractDubboPlugin extends AbstractShenyuPlugin {\\n    \\n    @Override\\n    public Mono<Void> doExecute(final ServerWebExchange exchange,\\n                                   final ShenyuPluginChain chain,\\n                                   final SelectorData selector,\\n                                   final RuleData rule) {\\n        //\u83b7\u53d6\u53c2\u6570\\n        String param = exchange.getAttribute(Constants.PARAM_TRANSFORM);\\n        //\u83b7\u53d6\u4e0a\u4e0b\u6587\u4fe1\u606f\\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\\n        assert shenyuContext != null;\\n        //\u83b7\u53d6\u5143\u6570\u636e\\n        MetaData metaData = exchange.getAttribute(Constants.META_DATA);\\n        //\u68c0\u67e5\u5143\u6570\u636e\\n        if (!checkMetaData(metaData)) {\\n            LOG.error(\\" path is : {}, meta data have error : {}\\", shenyuContext.getPath(), metaData);\\n            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);\\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.META_DATA_ERROR, null);\\n            return WebFluxResultUtils.result(exchange, error);\\n        }\\n        //\u68c0\u67e5\u5143\u6570\u636e\u548c\u53c2\u6570\\n        if (Objects.nonNull(metaData) && StringUtils.isNoneBlank(metaData.getParameterTypes()) && StringUtils.isBlank(param)) {\\n            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);\\n            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.DUBBO_HAVE_BODY_PARAM, null);\\n            return WebFluxResultUtils.result(exchange, error);\\n        }\\n        //\u8bbe\u7f6erpcContext\\n        this.rpcContext(exchange);\\n        //\u8fdb\u884cdubbo\u670d\u52a1\u8c03\u7528\\n        return this.doDubboInvoker(exchange, chain, selector, rule, metaData, param);\\n    }\\n}\\n```\\n\\n\\n\\n- org.apache.shenyu.plugin.apache.dubbo.ApacheDubboPlugin#doDubboInvoker()\\n\\n\u5728`doDubboInvoker()`\u65b9\u6cd5\u4e2d\u8bbe\u7f6e\u7279\u6b8a\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u7136\u540e\u5f00\u59cbdubbo\u7684\u6cdb\u5316\u8c03\u7528\u3002\\n\\n```java\\npublic class ApacheDubboPlugin extends AbstractDubboPlugin {\\n    \\n    @Override\\n    protected Mono<Void> doDubboInvoker(final ServerWebExchange exchange,\\n                                        final ShenyuPluginChain chain,\\n                                        final SelectorData selector,\\n                                        final RuleData rule,\\n                                        final MetaData metaData,\\n                                        final String param) {\\n        //\u8bbe\u7f6e\u5f53\u524d\u7684\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\uff0c\u4ee5\u53ca\u8bf7\u6c42\u5730\u5740\uff0c\u7528\u4e8e\u652f\u6301dubbo\u7684\u7070\u5ea6\\n        RpcContext.getContext().setAttachment(Constants.DUBBO_SELECTOR_ID, selector.getId());\\n        RpcContext.getContext().setAttachment(Constants.DUBBO_RULE_ID, rule.getId());\\n        RpcContext.getContext().setAttachment(Constants.DUBBO_REMOTE_ADDRESS, Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress());\\n        //dubbo\u7684\u6cdb\u5316\u8c03\u7528\\n        final Mono<Object> result = dubboProxyService.genericInvoker(param, metaData, exchange);\\n        //\u6267\u884c\u4e0b\u4e00\u4e2a\u63d2\u4ef6\\n        return result.then(chain.execute(exchange));\\n    }\\n}\\n```\\n\\n- org.apache.shenyu.plugin.apache.dubbo.proxy.ApacheDubboProxyService#genericInvoker()\\n\\n`genericInvoker()`\u65b9\u6cd5\uff1a\\n\\n- \u83b7\u53d6`ReferenceConfig`\u5bf9\u8c61\uff1b\\n- \u83b7\u53d6\u6cdb\u5316\u670d\u52a1`GenericService`\u5bf9\u8c61\uff1b\\n- \u6784\u9020\u8bf7\u6c42\u53c2\u6570`pair`\u5bf9\u8c61\uff1b\\n- \u53d1\u8d77\u5f02\u6b65\u7684\u6cdb\u5316\u8c03\u7528\u3002\\n\\n```java\\npublic class ApacheDubboProxyService {\\n    //...... \\n\\n    /**\\n     * Generic invoker object.\\n     */\\n    public Mono<Object> genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws ShenyuException {\\n        //1.\u83b7\u53d6ReferenceConfig\u5bf9\u8c61\\n        ReferenceConfig<GenericService> reference = ApacheDubboConfigCache.getInstance().get(metaData.getPath());\\n        //\u5982\u679c\u6ca1\u6709\u83b7\u53d6\u5230\\n        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) {\\n            //\u5931\u6548\u5f53\u524d\u7f13\u5b58\u7684\u4fe1\u606f\\n            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());\\n            //\u4f7f\u7528\u5143\u6570\u636e\u8fdb\u884c\u518d\u6b21\u521d\u59cb\u5316\\n            reference = ApacheDubboConfigCache.getInstance().initRef(metaData);\\n        }\\n        //2.\u83b7\u53d6\u6cdb\u5316\u670d\u52a1GenericService\u5bf9\u8c61\\n        GenericService genericService = reference.get();\\n        //3.\u6784\u9020\u8bf7\u6c42\u53c2\u6570pair\u5bf9\u8c61\\n        Pair<String[], Object[]> pair;\\n        if (StringUtils.isBlank(metaData.getParameterTypes()) || ParamCheckUtils.dubboBodyIsEmpty(body)) {\\n            pair = new ImmutablePair<>(new String[]{}, new Object[]{});\\n        } else {\\n            pair = dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());\\n        }\\n        //4.\u53d1\u8d77\u5f02\u6b65\u7684\u6cdb\u5316\u8c03\u7528\\n        return Mono.fromFuture(invokeAsync(genericService, metaData.getMethodName(), pair.getLeft(), pair.getRight()).thenApply(ret -> {\\n            //\u5904\u7406\u7ed3\u679c\\n            if (Objects.isNull(ret)) {\\n                ret = Constants.DUBBO_RPC_RESULT_EMPTY;\\n            }\\n            exchange.getAttributes().put(Constants.RPC_RESULT, ret);\\n            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());\\n            return ret;\\n        })).onErrorMap(exception -> exception instanceof GenericException ? new ShenyuException(((GenericException) exception).getExceptionMessage()) : new ShenyuException(exception));//\u5904\u7406\u5f02\u5e38\\n    }\\n    \\n    //\u6cdb\u5316\u8c03\u7528\uff0c\u5f02\u6b65\u64cd\u4f5c\\n    private CompletableFuture<Object> invokeAsync(final GenericService genericService, final String method, final String[] parameterTypes, final Object[] args) throws GenericException {\\n        genericService.$invoke(method, parameterTypes, args);\\n        Object resultFromFuture = RpcContext.getContext().getFuture();\\n        return resultFromFuture instanceof CompletableFuture ? (CompletableFuture<Object>) resultFromFuture : CompletableFuture.completedFuture(resultFromFuture);\\n    }\\n}\\n\\n```\\n\\n\u901a\u8fc7\u6cdb\u5316\u8c03\u7528\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5728\u7f51\u5173\u8c03\u7528`dubbo`\u670d\u52a1\u4e86\u3002\\n\\n\\n\\n`ReferenceConfig`\u5bf9\u8c61\u662f\u652f\u6301\u6cdb\u5316\u8c03\u7528\u7684\u5173\u952e\u5bf9\u8c61 \uff0c\u5b83\u7684\u521d\u59cb\u5316\u64cd\u4f5c\u662f\u5728\u6570\u636e\u540c\u6b65\u7684\u65f6\u5019\u5b8c\u6210\u7684\u3002\u8fd9\u91cc\u6d89\u53ca\u4e24\u90e8\u5206\u6570\u636e\uff0c\u4e00\u662f\u540c\u6b65\u7684\u63d2\u4ef6`handler`\u4fe1\u606f\uff0c\u4e8c\u662f\u540c\u6b65\u7684\u63d2\u4ef6\u5143\u6570\u636e\u4fe1\u606f\u3002\\n\\n- org.apache.shenyu.plugin.dubbo.common.handler.AbstractDubboPluginDataHandler#handlerPlugin()\\n\\n\u5f53\u63d2\u4ef6\u6570\u636e\u66f4\u65b0\u65f6\uff0c\u6570\u636e\u540c\u6b65\u6a21\u5757\u4f1a\u5c06\u6570\u636e\u4ece`shenyu-admin`\u540c\u6b65\u5230\u7f51\u5173\u3002\u5728`handlerPlugin()`\u4e2d\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\u3002\\n\\n```java\\npublic abstract class AbstractDubboPluginDataHandler implements PluginDataHandler {\\n    //......\\n    \\n    //\u521d\u59cb\u5316\u914d\u7f6e\u7f13\u5b58\\n   protected abstract void initConfigCache(DubboRegisterConfig dubboRegisterConfig);\\n\\n    @Override\\n    public void handlerPlugin(final PluginData pluginData) {\\n        if (Objects.nonNull(pluginData) && Boolean.TRUE.equals(pluginData.getEnabled())) {\\n            //\u6570\u636e\u53cd\u5e8f\u5217\u5316\\n            DubboRegisterConfig dubboRegisterConfig = GsonUtils.getInstance().fromJson(pluginData.getConfig(), DubboRegisterConfig.class);\\n            DubboRegisterConfig exist = Singleton.INST.get(DubboRegisterConfig.class);\\n            if (Objects.isNull(dubboRegisterConfig)) {\\n                return;\\n            }\\n            if (Objects.isNull(exist) || !dubboRegisterConfig.equals(exist)) {\\n                // \u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\\n                this.initConfigCache(dubboRegisterConfig);\\n            }\\n            Singleton.INST.single(DubboRegisterConfig.class, dubboRegisterConfig);\\n        }\\n    }\\n    //......\\n}\\n```\\n\\n- org.apache.shenyu.plugin.apache.dubbo.handler.ApacheDubboPluginDataHandler#initConfigCache()\\n\\n\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\u3002\\n\\n```java\\npublic class ApacheDubboPluginDataHandler extends AbstractDubboPluginDataHandler {\\n\\n    @Override\\n    protected void initConfigCache(final DubboRegisterConfig dubboRegisterConfig) {\\n        //\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\\n        ApacheDubboConfigCache.getInstance().init(dubboRegisterConfig);\\n        //\u5931\u6548\u4e4b\u524d\u7f13\u5b58\u7684\u7ed3\u679c\\n        ApacheDubboConfigCache.getInstance().invalidateAll();\\n    }\\n}\\n\\n```\\n\\n- org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#init()\\n\\n\u5728\u521d\u59cb\u5316\u4e2d\uff0c\u8bbe\u7f6e`registryConfig`\u548c`consumerConfig`\u3002\\n\\n```java\\npublic final class ApacheDubboConfigCache extends DubboConfigCache {\\n    //......  \\n   /**\\n     * \u521d\u59cb\u5316\\n     */\\n    public void init(final DubboRegisterConfig dubboRegisterConfig) {\\n        //\u521b\u5efaApplicationConfig\\n        if (Objects.isNull(applicationConfig)) {\\n            applicationConfig = new ApplicationConfig(\\"shenyu_proxy\\");\\n        }\\n        //\u534f\u8bae\u6216\u8005\u5730\u5740\u53d1\u751f\u6539\u53d8\u65f6\uff0c\u9700\u8981\u66f4\u65b0registryConfig\\n        if (needUpdateRegistryConfig(dubboRegisterConfig)) {\\n            RegistryConfig registryConfigTemp = new RegistryConfig();\\n            registryConfigTemp.setProtocol(dubboRegisterConfig.getProtocol());\\n            registryConfigTemp.setId(\\"shenyu_proxy\\");\\n            registryConfigTemp.setRegister(false);\\n            registryConfigTemp.setAddress(dubboRegisterConfig.getRegister());            Optional.ofNullable(dubboRegisterConfig.getGroup()).ifPresent(registryConfigTemp::setGroup);\\n            registryConfig = registryConfigTemp;\\n        }\\n        //\u521b\u5efaConsumerConfig\\n        if (Objects.isNull(consumerConfig)) {\\n            consumerConfig = ApplicationModel.getConfigManager().getDefaultConsumer().orElseGet(() -> {\\n                ConsumerConfig consumerConfig = new ConsumerConfig();\\n                consumerConfig.refresh();\\n                return consumerConfig;\\n            });\\n           \\n //\u8bbe\u7f6eConsumerConfig\\n            Optional.ofNullable(dubboRegisterConfig.getThreadpool()).ifPresent(consumerConfig::setThreadpool); \\n            Optional.ofNullable(dubboRegisterConfig.getCorethreads()).ifPresent(consumerConfig::setCorethreads);\\n            \\n Optional.ofNullable(dubboRegisterConfig.getThreads()).ifPresent(consumerConfig::setThreads);\\n            \\n Optional.ofNullable(dubboRegisterConfig.getQueues()).ifPresent(consumerConfig::setQueues);\\n        }\\n    }\\n    \\n    //\u662f\u5426\u9700\u8981\u66f4\u65b0\u6ce8\u518c\u914d\u7f6e\\n    private boolean needUpdateRegistryConfig(final DubboRegisterConfig dubboRegisterConfig) {\\n        if (Objects.isNull(registryConfig)) {\\n            return true;\\n        }\\n        return !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol())\\n                || !Objects.equals(dubboRegisterConfig.getRegister(), registryConfig.getAddress())\\n                || !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol());\\n    }\\n\\n    //......\\n}\\n```\\n\\n\\n\\n- org.apache.shenyu.plugin.apache.dubbo.subscriber.ApacheDubboMetaDataSubscriber#onSubscribe()\\n\\n\u5f53\u5143\u6570\u636e\u66f4\u65b0\u65f6\uff0c\u6570\u636e\u540c\u6b65\u6a21\u5757\u4f1a\u5c06\u6570\u636e\u4ece`shenyu-admin`\u540c\u6b65\u5230\u7f51\u5173\u3002\u5728`onSubscribe()`\u65b9\u6cd5\u4e2d\u6267\u884c\u5143\u6570\u636e\u66f4\u65b0\u64cd\u4f5c\u3002\\n\\n```java\\npublic class ApacheDubboMetaDataSubscriber implements MetaDataSubscriber {\\n    //\u672c\u5730\u5185\u5b58\u7f13\u5b58\\n    private static final ConcurrentMap<String, MetaData> META_DATA = Maps.newConcurrentMap();\\n\\n    //\u5143\u6570\u636e\u53d1\u751f\u66f4\u65b0\\n    public void onSubscribe(final MetaData metaData) {\\n        // dubbo\u670d\u52a1\u7684\u5143\u6570\u636e\u66f4\u65b0\\n        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {\\n            //\u5bf9\u5e94\u7684\u5143\u6570\u636e\u662f\u5426\u5b58\u5728\\n            MetaData exist = META_DATA.get(metaData.getPath());\\n            if (Objects.isNull(exist) || Objects.isNull(ApacheDubboConfigCache.getInstance().get(metaData.getPath()))) {\\n                // \u9996\u6b21\u521d\u59cb\u5316\\n                ApacheDubboConfigCache.getInstance().initRef(metaData);\\n            } else {\\n                // \u5bf9\u5e94\u7684\u5143\u6570\u636e\u53d1\u751f\u4e86\u66f4\u65b0\u64cd\u4f5c\\n                if (!Objects.equals(metaData.getServiceName(), exist.getServiceName())\\n                        || !Objects.equals(metaData.getRpcExt(), exist.getRpcExt())\\n                        || !Objects.equals(metaData.getParameterTypes(), exist.getParameterTypes())\\n                        || !Objects.equals(metaData.getMethodName(), exist.getMethodName())) {\\n                    //\u6839\u636e\u6700\u65b0\u7684\u5143\u6570\u636e\u518d\u6b21\u6784\u5efaReferenceConfig\\n                    ApacheDubboConfigCache.getInstance().build(metaData);\\n                }\\n            }\\n            //\u672c\u5730\u5185\u5b58\u7f13\u5b58\\n            META_DATA.put(metaData.getPath(), metaData);\\n        }\\n    }\\n\\n    //\u5220\u9664\u5143\u6570\u636e\\n    public void unSubscribe(final MetaData metaData) {\\n        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {\\n            //\u4f7fReferenceConfig\u5931\u6548\\n            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());\\n            META_DATA.remove(metaData.getPath());\\n        }\\n    }\\n}\\n```\\n\\n- org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#initRef()\\n\\n\u901a\u8fc7`metaData`\u6784\u5efa`ReferenceConfig`\u5bf9\u8c61\u3002\\n\\n```java\\npublic final class ApacheDubboConfigCache extends DubboConfigCache {\\n    //......\\n    \\n    public ReferenceConfig<GenericService> initRef(final MetaData metaData) {\\n            try {\\n                //\u5148\u5c1d\u8bd5\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u5b58\u5728\u5c31\u76f4\u63a5\u8fd4\u56de\\n                ReferenceConfig<GenericService> referenceConfig = cache.get(metaData.getPath());\\n                if (StringUtils.isNoneBlank(referenceConfig.getInterface())) {\\n                    return referenceConfig;\\n                }\\n            } catch (ExecutionException e) {\\n                LOG.error(\\"init dubbo ref exception\\", e);\\n            }\\n           //\u4e0d\u5b58\u5728\uff0c\u5c31\u6784\u5efa\\n            return build(metaData);\\n        }\\n\\n        /**\\n         * Build reference config.\\n         */\\n        @SuppressWarnings(\\"deprecation\\")\\n        public ReferenceConfig<GenericService> build(final MetaData metaData) {\\n            if (Objects.isNull(applicationConfig) || Objects.isNull(registryConfig)) {\\n                return new ReferenceConfig<>();\\n            }\\n            ReferenceConfig<GenericService> reference = new ReferenceConfig<>(); //\u65b0\u5efaReferenceConfig\\n            reference.setGeneric(\\"true\\"); //\u6cdb\u5316\u8c03\u7528\\n            reference.setAsync(true);//\u652f\u6301\u5f02\u6b65\\n\\n            reference.setApplication(applicationConfig);//\u8bbe\u7f6e\u5e94\u7528\u914d\u7f6e\\n            reference.setRegistry(registryConfig);//\u8bbe\u7f6e\u6ce8\u518c\u4e2d\u5fc3\u914d\u7f6e\\n            reference.setConsumer(consumerConfig);//\u8bbe\u7f6e\u6d88\u8d39\u8005\u914d\u7f6e\\n            reference.setInterface(metaData.getServiceName());//\u8bbe\u7f6e\u670d\u52a1\u63a5\u53e3\\n            reference.setProtocol(\\"dubbo\\");//\u8bbe\u7f6edubbo\u534f\u8bae\\n            reference.setCheck(false); //\u4e0d\u68c0\u67e5 service provider\\n            reference.setLoadbalance(\\"gray\\");//\u652f\u6301\u7070\u5ea6\\n\\n            Map<String, String> parameters = new HashMap<>(2);\\n            parameters.put(\\"dispatcher\\", \\"direct\\");\\n            reference.setParameters(parameters);//\u81ea\u5b9a\u4e49\u53c2\u6570\\n\\n            String rpcExt = metaData.getRpcExt();//rpc\u6269\u5c55\u53c2\u6570\\n            DubboParam dubboParam = parserToDubboParam(rpcExt);//\u53cd\u5e8f\u5217\u5316\\n            if (Objects.nonNull(dubboParam)) {\\n                if (StringUtils.isNoneBlank(dubboParam.getVersion())) {\\n                    reference.setVersion(dubboParam.getVersion());//\u8bbe\u7f6e\u7248\u672c\\n                }\\n                if (StringUtils.isNoneBlank(dubboParam.getGroup())) {\\n                    reference.setGroup(dubboParam.getGroup());//\u8bbe\u7f6e\u5206\u7ec4\\n                }\\n                if (StringUtils.isNoneBlank(dubboParam.getUrl())) {\\n                    reference.setUrl(dubboParam.getUrl());//\u8bbe\u7f6eurl\\n                }\\n                if (StringUtils.isNoneBlank(dubboParam.getCluster())) {\\n                    reference.setCluster(dubboParam.getCluster());//\u8bbe\u7f6eCluster type\\n                }\\n                Optional.ofNullable(dubboParam.getTimeout()).ifPresent(reference::setTimeout);//timeout\\n                Optional.ofNullable(dubboParam.getRetries()).ifPresent(reference::setRetries);//retires\\n                Optional.ofNullable(dubboParam.getSent()).ifPresent(reference::setSent);//Whether to ack async-sent\\n            }\\n            try {\\n                //\u83b7\u53d6GenericService\\n                Object obj = reference.get();\\n                if (Objects.nonNull(obj)) {\\n                    LOG.info(\\"init apache dubbo reference success there meteData is :{}\\", metaData);\\n                    //\u7f13\u5b58\u5f53\u524d\u7684reference\\n                    cache.put(metaData.getPath(), reference);\\n                }\\n            } catch (Exception e) {\\n                LOG.error(\\"init apache dubbo reference exception\\", e);\\n            }\\n            return reference;\\n        }\\n    //......\\n    }\\n```\\n\\n\\n\\n#### 2.6 \u6267\u884cResponsePlugin\\n\\n- org.apache.shenyu.plugin.response.ResponsePlugin#execute()\\n\\n\u54cd\u5e94\u7ed3\u679c\u7531`ResponsePlugin`\u63d2\u4ef6\u5904\u7406\u3002\\n\\n```java\\n    @Override\\n    public Mono<Void> execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);\\n        assert shenyuContext != null;\\n        // \u6839\u636erpc\u7c7b\u578b\u5904\u7406\u7ed3\u679c\\n        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);\\n    }\\n```\\n\\n\u5904\u7406\u7c7b\u578b\u7531`MessageWriter`\u51b3\u5b9a\uff0c\u7c7b\u7ee7\u627f\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-dubbo-plugin/MessageWriter.png)\\n\\n- MessageWriter\uff1a\u63a5\u53e3\uff0c\u5b9a\u4e49\u6d88\u606f\u5904\u7406\u65b9\u6cd5\uff1b\\n- NettyClientMessageWriter\uff1a\u5904\u7406`Netty`\u8c03\u7528\u7ed3\u679c\uff1b\\n- RPCMessageWriter\uff1a\u5904\u7406`RPC`\u8c03\u7528\u7ed3\u679c\uff1b\\n- WebClientMessageWriter\uff1a\u5904\u7406`WebClient`\u8c03\u7528\u7ed3\u679c\uff1b\\n\\n`Dubbo`\u670d\u52a1\u8c03\u7528\uff0c\u5904\u7406\u7ed3\u679c\u5f53\u7136\u662f`RPCMessageWriter`\u4e86\u3002\\n\\n- org.apache.shenyu.plugin.response.strategy.RPCMessageWriter#writeWith()\\n\\n\u5728`writeWith()`\u65b9\u6cd5\u4e2d\u5904\u7406\u54cd\u5e94\u7ed3\u679c\u3002\\n\\n```java\\n\\npublic class RPCMessageWriter implements MessageWriter {\\n\\n    @Override\\n    public Mono<Void> writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {\\n        return chain.execute(exchange).then(Mono.defer(() -> {\\n            Object result = exchange.getAttribute(Constants.RPC_RESULT); //\u83b7\u53d6\u7ed3\u679c\\n            if (Objects.isNull(result)) { //\u5904\u7406\u5f02\u5e38\\n                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);\\n                return WebFluxResultUtils.result(exchange, error);\\n            }\\n            return WebFluxResultUtils.result(exchange, result);//\u8fd4\u56de\u7ed3\u679c\\n        }));\\n    }\\n}\\n```\\n\\n\u5206\u6790\u81f3\u6b64\uff0c\u5173\u4e8e`Dubbo`\u63d2\u4ef6\u7684\u6e90\u7801\u5206\u6790\u5c31\u5b8c\u6210\u4e86\uff0c\u5206\u6790\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a\\n\\n![](/img/activities/code-analysis-dubbo-plugin/dubbo-execute-zh.png)\\n\\n\\n### 3. \u5c0f\u7ed3\\n\\n\u672c\u6587\u6e90\u7801\u5206\u6790\u4ece`Dubbo`\u670d\u52a1\u6ce8\u518c\u5f00\u59cb\uff0c\u5230`Dubbo`\u63d2\u4ef6\u7684\u670d\u52a1\u8c03\u7528\u3002`Dubbo`\u63d2\u4ef6\u4e3b\u8981\u7528\u6765\u5904\u7406\u5c06`http`\u8bf7\u6c42\u8f6c\u6210`dubbo`\u534f\u8bae,\u4e3b\u8981\u903b\u8f91\u662f\u901a\u8fc7\u6cdb\u5316\u8c03\u7528\u5b9e\u73b0\u3002"},{"id":"/Plugin-SourceCode-Analysis-Mcp-Server-Plugin","metadata":{"permalink":"/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin.md","title":"McpServer \u63d2\u4ef6\u6e90\u7801\u5206\u6790","description":"\u5728 shenyu \u7f51\u5173\u4e2d\uff0c\u542f\u52a8\u8be5\u63d2\u4ef6\uff0cshenyu \u5c06\u6210\u4e3a\u4e00\u4e2a\u529f\u80fd\u4e30\u5bcc\u7684 mcpServer,","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"plugin","permalink":"/zh/blog/tags/plugin"},{"label":"mcp","permalink":"/zh/blog/tags/mcp"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":14.86,"hasTruncateMarker":false,"authors":[{"name":"yusiheng","title":"Apache ShenYu Contributor","url":"https://github.com/478320"}],"frontMatter":{"title":"McpServer \u63d2\u4ef6\u6e90\u7801\u5206\u6790","author":"yusiheng","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/478320","tags":["plugin","mcp","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Dubbo\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin"},"nextItem":{"title":"Param-Mapping\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin"}},"content":"\u5728 shenyu \u7f51\u5173\u4e2d\uff0c\u542f\u52a8\u8be5\u63d2\u4ef6\uff0cshenyu \u5c06\u6210\u4e3a\u4e00\u4e2a\u529f\u80fd\u4e30\u5bcc\u7684 mcpServer,\\n\u4f60\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u914d\u7f6e\u6765\u5c06\u4e00\u4e2a\u670d\u52a1\u4f5c\u4e3a tool \u6ce8\u518c\u5230 shenyu \u7f51\u5173\u4e2d\uff0c\u5e76\u4f7f\u7528\u7f51\u5173\u63d0\u4f9b\u7684\u6269\u5c55\u529f\u80fd\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.7.0.2`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c \u5728\u672c\u7bc7\u4e2d\u6211\u5c06\u8ffd\u8e2a Shenyu Mcp \u63d2\u4ef6\u94fe\u8def\uff0c\u5bf9 Mcp \u63d2\u4ef6\u7684 sse \u901a\u4fe1\u65b9\u5f0f\u8fdb\u884c\u6e90\u7801\u5206\u6790\\n\\n### \u524d\u8a00\\n\\n> shenyu \u7f51\u5173\u7684 mcp \u63d2\u4ef6\u57fa\u4e8e spring-ai-mcp \u6269\u5c55\u800c\u6765\uff0c\u4e3a\u4e86\u66f4\u597d\u7684\u4e86\u89e3 mcp \u63d2\u4ef6\u7684\u5de5\u4f5c\u539f\u7406\\n> \uff0c\u6211\u5c06\u7b80\u5355\u4ecb\u7ecd mcp \u5b98\u65b9\u63d0\u4f9b\u7684 jdk \u4e2d\u5404\u4e2a java \u7c7b\u662f\u5982\u4f55\u534f\u540c\u8fd0\u4f5c\u7684\\n\\n\u6211\u60f3\u5148\u7b80\u5355\u4ecb\u7ecd\u4e09\u4e2a Mcp \u5b98\u65b9\u63d0\u4f9b\u7684 java \u7c7b\\n\\n>1. `McpServer`\\n>\\n>\u8be5\u7c7b\u8d1f\u8d23\u7ba1\u7406\uff0ctool\uff0cResource\uff0cpromote \u7b49\u8d44\u6e90\\n>\\n>2. `TransportProvider`\\n>\\n>\u6839\u636e\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u4e4b\u95f4\u901a\u4fe1\u534f\u8bae\uff0c\u63d0\u4f9b\u4e4b\u76f8\u5bf9\u5e94\u7684\u901a\u8baf\u65b9\u6cd5\\n>\\n>3. `Session`\\n>\\n>\u5904\u7406\u8bf7\u6c42\u6570\u636e\u3001\u54cd\u5e94\u6570\u636e\u548c\u901a\u77e5\u6570\u636e\uff0c\u63d0\u4f9b\u4e00\u4e9b\u57fa\u672c\u65b9\u6cd5\u548c\u5176\u5bf9\u5e94\u7684\u5904\u7406\u5668\uff0c\u67e5\u8be2\u5de5\u5177\uff0c\u8c03\u7528\u5de5\u5177\u90fd\u5728\u6b64\u5904\u6267\u884c\\n\\n### 1. \u670d\u52a1\u6ce8\u518c\\n\\n\u5728 shenyu admin \u7684 McpServer \u4e2d\u63d2\u4ef6\u586b\u5199 endpoint \u548c tool \u4fe1\u606f\u540e\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5c06\u81ea\u52a8\u6ce8\u518c\u5230 shenyu bootstrap \u4e2d\uff0c\\n\u6570\u636e\u540c\u6b65\u6e90\u7801\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51[websocket\u6570\u636e\u540c\u6b65](https://shenyu.incubator.apache.org/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync)\\n\\nshenyu bootstrap \u5c06\u5728 `McpServerPluginDataHandler` \u7684 `handler()` \u65b9\u6cd5\u4e2d\u63a5\u6536\u5230 admin \u540c\u6b65\u6765\u7684\u6570\u636e\u3002\\n\\n`handlerSelector()` \u65b9\u6cd5\u63a5\u6536 url \u6570\u636e\u521b\u5efa McpServer\\n\\n`handlerRule()` \u65b9\u6cd5\u63a5\u6536 tool \u4fe1\u606f\uff0c\u6ce8\u518c tool\\n\\n\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u5171\u540c\u7ec4\u6210\u4e86 Shenyu Mcp \u63d2\u4ef6\u7684\u670d\u52a1\u6ce8\u518c\u90e8\u5206\uff0c\u4e0b\u9762\u6211\u5c06\u5bf9\u8fd9\u4e2a\u4e24\u4e2a\u65b9\u6cd5\uff0c\u8be6\u7ec6\u5c55\u5f00\u5206\u6790\\n\\n#### 1.1 Transport\uff0cMcpServer\u6ce8\u518c\\n\\n\u6211\u4eec\u5148\u6765\u5206\u6790 `handlerSelector()` \u65b9\u6cd5\uff0c\u4e5f\u5c31\u662f McpServer \u7684\u6ce8\u518c\\n\\n* `handlerSelector()` \u65b9\u6cd5 \u5de5\u4f5c\u5185\u5bb9\u5982\u4e0b\\n\\n1. \u6355\u6349\u7528\u6237\u5728 Selector \u4e0a\u7684\u586b\u5199\u7684 url\uff0c\u8fd9\u4e2a url \u5c06\u4f5c\u4e3a\u4e00\u4e2a key \u5b58\u50a8 McpServer TransportProvider \u7b49\u4fe1\u606f\\n2. \u5e8f\u5217\u5316\u521b\u5efa `ShenyuMcpServer`\uff0c`ShenyuMcpServer` \u5c06 SelectorId \u548c\u8fd9\u4e9b url \u4e5f\u5c31\u662f\u8fd9\u4e9b key \u7ed1\u5b9a\uff0c\u4ee5\u6b64\u6765\u5b9e\u73b0 selectorId \u548c key \u7684\u7ed1\u5b9a\u3002\\n\\n> \u6ce8\u610f `ShenyuMcpServer` \u662f Shenyu \u7528\u4e8e\u7ed1\u5b9a SelectorId \u548c url \u7684\u5bf9\u8c61\uff0c\u548c `McpServer` \u6ca1\u6709\u7ee7\u627f\u5173\u7cfb\uff0c\u529f\u80fd\u4e5f\u5b8c\u5168\u4e0d\u540c\\n\\n3. \u8c03\u7528 `ShenyuMcpServerManager` \u7684 `getOrCreateMcpServerTransport()` \u65b9\u6cd5\u6ce8\u518c McpServer TransportProvider\\n\\n```java\\npublic class McpServerPluginDataHandler implements PluginDataHandler {\\n    @Override\\n    public void handlerSelector(final SelectorData selectorData) {\\n        // \u83b7\u53d6URI\\n        String uri = selectorData.getConditionList().stream()\\n                .filter(condition -> Constants.URI.equals(condition.getParamType()))\\n                .map(ConditionData::getParamValue)\\n                .findFirst()\\n                .orElse(null);\\n        \\n        // \u6784\u5efaMcpServer\\n        ShenyuMcpServer shenyuMcpServer = GsonUtils.getInstance().fromJson(Objects.isNull(selectorData.getHandle()) ? DEFAULT_MESSAGE_ENDPOINT : selectorData.getHandle(), ShenyuMcpServer.class);\\n        shenyuMcpServer.setPath(path);\\n        // \u7f13\u5b58shenyuMcpServer\\n        CACHED_SERVER.get().cachedHandle(\\n                selectorData.getId(),\\n                shenyuMcpServer);\\n        String messageEndpoint = shenyuMcpServer.getMessageEndpoint();\\n        // \u5c1d\u8bd5\u83b7\u53d6\u6216\u8005\u6ce8\u518ctransportProvider\\n        shenyuMcpServerManager.getOrCreateMcpServerTransport(uri, messageEndpoint);\\n    }\\n    \\n}\\n```\\n\\n> `ShenyuMcpServerManager` \u8be5\u7c7b\u662f ShenYu \u4e2d McpServer \u7684\u7ba1\u7406\u4e2d\u5fc3\uff0c\u4e0d\u4ec5\u50a8\u5b58\u4e86 `McpAsyncServer` `CompositeTransportProvider` \u7b49\u5185\u5bb9\uff0c\u6ce8\u518c Transport \u548c McpServer\\n\u7684\u65b9\u6cd5\u4e5f\u5728\u5176\u4e2d\\n* `getOrCreateMcpServerTransport()` \u65b9\u6cd5\u5de5\u4f5c\u5185\u5bb9\u5177\u4f53\u5982\u4e0b\\n\\n1. \u5904\u7406\u4f20\u9012\u6765\u7684 url \u53bb\u9664/streamablehttp \u4ee5\u53ca /message\u540e\u7f00 \u4f7f\u5176\u6062\u590d\u4e3a\u539f\u59cb\u7684 url\\n2. \u5c1d\u8bd5\u83b7\u53d6 `CompositeTransportProvider` \u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u662f Transport \u7684\u590d\u5408\u5bf9\u8c61\uff0c\u5305\u542b\u4e86\u591a\u79cd\u534f\u8bae\u5bf9\u5e94\u7684 Transport\\n3. \u5982\u679c\u6ca1\u6709\u83b7\u53d6\u5230\uff0c\u5219\u8c03\u7528 `createSseTransport()` \u65b9\u6cd5\u521b\u5efa `CompositeTransportProvider` \u5bf9\u8c61\\n4. \u521b\u5efa `McpAsyncServer` \u5bf9\u8c61\uff0c\u4fdd\u5b58 Transport \u5bf9\u8c61\u5230 Map \u4e2d\uff0c\u5c06 Transport \u6ce8\u518c\u5230 `McpAsyncServer` \u4e2d\\n\\n```java\\n@Component\\npublic class ShenyuMcpServerManager {\\n    public ShenyuSseServerTransportProvider getOrCreateMcpServerTransport(final String uri, final String messageEndPoint) {\\n        // \u53bb\u9664/streamablehttp \u4ee5\u53ca /message\u540e\u7f00\\n        String normalizedPath = processPath(uri);\\n        return getOrCreateTransport(normalizedPath, SSE_PROTOCOL,\\n                () -> createSseTransport(normalizedPath, messageEndPoint));\\n    }\\n    \\n    private <T> T getOrCreateTransport(final String normalizedPath, final String protocol,\\n                                       final java.util.function.Supplier<T> transportFactory) {\\n        // \u83b7\u53d6\u590d\u5408Transport\u5b9e\u4f8b\\n        CompositeTransportProvider compositeTransport = getOrCreateCompositeTransport(normalizedPath);\\n\\n        T transport = switch (protocol) {\\n            case SSE_PROTOCOL -> (T) compositeTransport.getSseTransport();\\n            case STREAMABLE_HTTP_PROTOCOL -> (T) compositeTransport.getStreamableHttpTransport();\\n            default -> null;\\n        };\\n        // \u5982\u679c\u7f13\u5b58\u4e2d\u6ca1\u6709\u8be5\u5b9e\u4f8b\uff0c\u5219\u9700\u8981\u91cd\u65b0\u521b\u5efa\\n        if (Objects.isNull(transport)) {\\n            // \u8c03\u7528createSseTransport()\u65b9\u6cd5\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u7684transport\u5e76\u5b58\u50a8\\n            transport = transportFactory.get();\\n            // \u521b\u5efaMcpAsyncServer\uff0c\u5e76\u6ce8\u518ctransport\\n            addTransportToSharedServer(normalizedPath, protocol, transport);\\n        }\\n\\n        return transport;\\n    }\\n}\\n```\\n\\n##### 1.1.1 Transport\u6ce8\u518c\\n\\n* `createSseTransport()` \u65b9\u6cd5\\n> \u8be5\u65b9\u6cd5\u5728 `getOrCreateMcpServerTransport()` \u65b9\u6cd5\u88ab\u8c03\u7528\uff0c\u7528\u4e8e\u521b\u5efa Transport\\n\\n```java\\n\\n@Component\\npublic class ShenyuMcpServerManager {\\n    private ShenyuSseServerTransportProvider createSseTransport(final String normalizedPath, final String messageEndPoint) {\\n        String messageEndpoint = normalizedPath + messageEndPoint;\\n        ShenyuSseServerTransportProvider transportProvider = ShenyuSseServerTransportProvider.builder()\\n                .objectMapper(objectMapper)\\n                .sseEndpoint(normalizedPath)\\n                .messageEndpoint(messageEndpoint)\\n                .build();\\n        // \u5411Manager\u7684routeMap\u4e2d\u6ce8\u518ctransportProvider\u7684\u4e24\u4e2a\u51fd\u6570\\n        registerRoutes(normalizedPath, messageEndpoint, transportProvider::handleSseConnection, transportProvider::handleMessage);\\n        return transportProvider;\\n    }\\n}\\n```\\n\\n##### 1.1.2 mcpServer\u6ce8\u518c\\n\\n* `addTransportToSharedServer()` \u65b9\u6cd5\\n> \u8be5\u65b9\u6cd5\u5728 `getOrCreateMcpServerTransport()` \u65b9\u6cd5\u88ab\u8c03\u7528\uff0c\u7528\u4e8e\u521b\u5efa McpServer \u5e76\u4fdd\u5b58\\n\\n\u8be5\u65b9\u6cd5\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 McpServer\u5e76\u5b58\u50a8\u5230 `sharedServerMap` \u4e2d\uff0c\u5e76\u5c06\u4e0a\u4e00\u6b65\u5f97\u5230\u7684 TransportProvider \u5b58\u5165 `compositeTransportMap` \u4e2d\\n\\n```java\\n@Component\\npublic class ShenyuMcpServerManager {\\n    private void addTransportToSharedServer(final String normalizedPath, final String protocol, final Object transportProvider) {\\n        // \u83b7\u53d6\u6216\u8005\u521b\u5efa\u5e76\u6ce8\u518c McpServer\\n        getOrCreateSharedServer(normalizedPath);\\n\\n        // \u5c06\u65b0\u589e\u7684\u4f20\u8f93\u534f\u8bae\u5b58\u8fdbcompositeTransportMap\u4e2d\\n        compositeTransport.addTransport(protocol, transportProvider);\\n        \\n    }\\n\\n    private McpAsyncServer getOrCreateSharedServer(final String normalizedPath) {\\n        return sharedServerMap.computeIfAbsent(normalizedPath, path -> {\\n            // \u83b7\u53d6\u4f20\u8f93\u534f\u8bae\\n            CompositeTransportProvider compositeTransport = getOrCreateCompositeTransport(path);\\n\\n            // \u9009\u62e9Server\u62e5\u6709\u7684\u80fd\u529b\\n            var capabilities = McpSchema.ServerCapabilities.builder()\\n                    .tools(true)\\n                    .logging()\\n                    .build();\\n\\n            // \u521b\u5efaMcpServer\u5e76\u5b58\u50a8\\n            McpAsyncServer server = McpServer\\n                    .async(compositeTransport)\\n                    .serverInfo(\\"MCP Shenyu Server (Multi-Protocol)\\", \\"1.0.0\\")\\n                    .capabilities(capabilities)\\n                    .tools(Lists.newArrayList())\\n                    .build();\\n            \\n            return server;\\n        });\\n    }\\n}\\n```\\n\\n#### 1.2 Tools\u6ce8\u518c\\n\\n* `handlerRule()` \u65b9\u6cd5 \u5de5\u4f5c\u5185\u5bb9\u5982\u4e0b\\n\\n1. \u6355\u6349\u7528\u6237\u5728 Tool \u4e0a\u7684\u586b\u5199\u7684 tool \u914d\u7f6e\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5c06\u5168\u90e8\u7528\u4e8e tool \u7684\u6784\u5efa\\n2. \u5e8f\u5217\u5316\u521b\u5efa `ShenyuMcpServerTool` \u83b7\u53d6 tool \u4fe1\u606f\\n\\n> \u6ce8\u610f `ShenyuMcpServerTool` \u4e5f\u662f Shenyu \u5b58\u50a8 tool \u4fe1\u606f\u7684\u5de5\u5177\uff0c\u548c `McpServerTool` \u6ca1\u6709\u7ee7\u627f\u5173\u7cfb\\n\\n3. \u8c03\u7528 `addTool()` \u65b9\u6cd5\uff0c \u5229\u7528\u8be5 tool \u4fe1\u606f\u521b\u5efa tool\uff0c\u5e76\u6839\u636e SelectorId \u5c06 tool \u6ce8\u518c\u5230\u4e0e\u4e4b\u5339\u914d\u7684 McpServer \u4e2d\\n\\n```java\\npublic class McpServerPluginDataHandler implements PluginDataHandler {\\n    @Override\\n    public void handlerRule(final RuleData ruleData) {\\n        Optional.ofNullable(ruleData.getHandle()).ifPresent(s -> {\\n            // \u5e8f\u5217\u5316\u4e00\u4e2a\u65b0\u7684 ShenyuMcpServerTool\\n            ShenyuMcpServerTool mcpServerTool = GsonUtils.getInstance().fromJson(s, ShenyuMcpServerTool.class);\\n            // \u7f13\u5b58mcpServerTool\\n            CACHED_TOOL.get().cachedHandle(CacheKeyUtils.INST.getKey(ruleData), mcpServerTool);\\n            // \u83b7\u53d6\u5e76\u6784\u5efa mcp schema\\n            List<McpServerToolParameter> parameters = mcpServerTool.getParameters();\\n            String inputSchema = JsonSchemaUtil.createParameterSchema(parameters);\\n            ShenyuMcpServer server = CACHED_SERVER.get().obtainHandle(ruleData.getSelectorId());\\n            if (Objects.nonNull(server)) {\\n                // \u5411Manager\u7684sharedServerMap\u4e2d\u5b58\u50a8Tool\u4fe1\u606f\\n                shenyuMcpServerManager.addTool(server.getPath(),\\n                        StringUtils.isBlank(mcpServerTool.getName()) ? ruleData.getName()\\n                                : mcpServerTool.getName(),\\n                        mcpServerTool.getDescription(),\\n                        mcpServerTool.getRequestConfig(),\\n                        inputSchema);\\n            }\\n        });\\n    }\\n}\\n```\\n\\n* `addTool()`\u65b9\u6cd5\\n> \u8be5\u65b9\u6cd5\u88ab `handlerRule()` \u65b9\u6cd5\u8c03\u7528\uff0c\u7528\u4e8e\u65b0\u589e\u5de5\u5177\\n\\n\u8be5\u65b9\u6cd5\u505a\u4e86\u4e0b\u8ff0\u5de5\u4f5c\\n1. \u5c06\u4e0a\u4e00\u6b65\u4f20\u6765\u7684 tool \u4fe1\u606f\u8f6c\u6362\u4e3a `shenyuToolDefinition` \u5bf9\u8c61\\n2. \u5229\u7528\u8f6c\u6362\u6765\u7684 `shenyuToolDefinition` \u5bf9\u8c61\u521b\u5efa `ShenyuToolCallback` \u5bf9\u8c61\\n> `ShenyuToolCallback` \u91cd\u5199\u4e86 `ToolCallBack` \u7684 `call()` \u65b9\u6cd5\uff0c\u5e76\u5c06\u8be5 `call()` \u65b9\u6cd5\u6ce8\u518c\u5230\u4e86 `AsyncToolSpecification` \u4e2d\uff0c\\n> \u6b64\u540e\u8c03\u7528 tool \u7684 `call()` \u65b9\u6cd5\uff0c\u5219\u5b9e\u9645\u4f1a\u8c03\u7528\u8fd9\u4e2a\u91cd\u5199\u7684 `call()` \u65b9\u6cd5\\n\\n3. \u5c06 `ShenyuToolCallback` \u8f6c\u6362\u4e3a `AsyncToolSpecification` \u5e76\u6ce8\u518c\u5230\u76f8\u5173\u7684 mcpServer \u4e2d\\n\\n```java\\npublic class McpServerPluginDataHandler implements PluginDataHandler {\\n    public void addTool(final String serverPath, final String name, final String description,\\n                        final String requestTemplate, final String inputSchema) {\\n        String normalizedPath = normalizeServerPath(serverPath);\\n        // \u6784\u5efaDefinition\u5bf9\u8c61\\n        ToolDefinition shenyuToolDefinition = ShenyuToolDefinition.builder()\\n                .name(name)\\n                .description(description)\\n                .requestConfig(requestTemplate)\\n                .inputSchema(inputSchema)\\n                .build();\\n        \\n        ShenyuToolCallback shenyuToolCallback = new ShenyuToolCallback(shenyuToolDefinition);\\n\\n        // \u83b7\u53d6\u5230\u5148\u524d\u6ce8\u518c\u7684 McpServer\uff0c \u5e76\u5411\u5176\u4e2d\u6ce8\u518cTool\\n        McpAsyncServer sharedServer = sharedServerMap.get(normalizedPath);\\n        for (AsyncToolSpecification asyncToolSpecification : McpToolUtils.toAsyncToolSpecifications(shenyuToolCallback)) {\\n            sharedServer.addTool(asyncToolSpecification).block();\\n        }        \\n    }\\n}\\n```\\n\\n\u5230\u6b64\u4e3a\u6b62\uff0c\u670d\u52a1\u6ce8\u518c\u5206\u6790\u5b8c\u6bd5\\n\\n\u670d\u52a1\u6ce8\u518c\u4e00\u56fe\u89c8\\n![](/img/activities/code-analysis-mcp-server-plugin/Mcp-server-register-zh.png)\\n\\n### 2. \u63d2\u4ef6\u8c03\u7528\\n\\n\u5ba2\u6237\u7aef\u5148\u540e\u4f1a\u53d1\u9001\u540e\u7f00\u4e3a `/sse` \u548c `/message` \u7684\u4e24\u79cd\u6d88\u606f\uff0c\u8fd9\u4e24\u79cd\u6d88\u606f\u90fd\u4f1a\u88ab `Shenyu McpServer plugin` \u6355\u6349\uff0c`Shenyu McpServer plugin`\\n\u4f1a\u5bf9 `/sse` \u6d88\u606f\u548c `/message` \u6d88\u606f\u505a\u4e0d\u540c\u5904\u7406\u3002\u6536\u5230 `/sse` \u6d88\u606f\u65f6 plugin \u4f1a\u521b\u5efa session \u5bf9\u8c61\u5e76\u4fdd\u5b58\uff0c\u6700\u540e\u8fd4\u56de session id\\n\u4f9b message \u6d88\u606f\u4f7f\u7528\u3002\u6536\u5230 `/message` \u6d88\u606f\u65f6\uff0c\u4f1a\u6839\u636e `/message` \u6d88\u606f\u643a\u5e26\u7684 method \u4fe1\u606f\uff0c\u9009\u62e9\u6267\u884c\u7684\u65b9\u6cd5\\n\u5982\uff1a\u83b7\u53d6\u5de5\u4f5c\u5217\u8868\uff0c\u5de5\u5177\u8c03\u7528\uff0c\u83b7\u53d6\u8d44\u6e90\u5217\u8868\u7b49\u7b49\\n\\n* `doExecute()` \u65b9\u6cd5 \u5de5\u4f5c\u5185\u5bb9\u5982\u4e0b\\n\\n1. \u8def\u5f84\u5339\u914d\uff0c\u5224\u65ad mcp plugin \u662f\u5426\u6ce8\u518c\u8be5\u8def\u5f84\\n2. \u8c03\u7528 `routeByProtocol()` \u65b9\u6cd5\uff0c\u6839\u636e\u8bf7\u6c42\u534f\u8bae\u9009\u62e9\u5408\u9002\u7684\u5904\u7406\u65b9\u6848\\n\\n> \u672c\u7bc7\u662f\u5bf9 sse \u8bf7\u6c42\u65b9\u5f0f\u7684\u89e3\u6790\uff0c\u56e0\u6b64\u63a5\u7740\u8fdb\u5165 `handleSseRequest()` \u65b9\u6cd5\\n\\n```java\\npublic class McpServerPlugin extends AbstractShenyuPlugin {\\n    @Override\\n    protected Mono<Void> doExecute(final ServerWebExchange exchange,\\n                                   final ShenyuPluginChain chain,\\n                                   final SelectorData selector,\\n                                   final RuleData rule) {\\n        final String uri = exchange.getRequest().getURI().getRawPath();\\n        // \u5224\u65ad Mcp \u63d2\u4ef6\u662f\u5426\u6ce8\u518c\u4e86\u8be5\u8def\u7531\u89c4\u5219\uff0c\u6ca1\u6709\u5219\u4e0d\u6267\u884c\\n        if (!shenyuMcpServerManager.canRoute(uri)) {\\n            return chain.execute(exchange);\\n        }\\n        final ServerRequest request = ServerRequest.create(exchange, messageReaders);\\n        // \u6839\u636e uri \u5224\u65ad\u8def\u7531\u534f\u8bae\uff0c\u9009\u62e9\u5bf9\u5e94\u7684\u5904\u7406\u65b9\u6848\\n        return routeByProtocol(exchange, chain, request, selector, uri);\\n    }\\n\\n    private Mono<Void> routeByProtocol(final ServerWebExchange exchange,\\n                                       final ShenyuPluginChain chain,\\n                                       final ServerRequest request,\\n                                       final SelectorData selector,\\n                                       final String uri) {\\n\\n        if (isStreamableHttpProtocol(uri)) {\\n            return handleStreamableHttpRequest(exchange, chain, request, uri);\\n        } else if (isSseProtocol(uri)) {\\n            // \u5904\u7406sse\u8bf7\u6c42\\n            return handleSseRequest(exchange, chain, request, selector, uri);\\n        } \\n    }\\n}\\n```\\n\\n`handlerSseRequest()` \u65b9\u6cd5\\n> \u8be5\u65b9\u6cd5\u7531 `routeByProtocol()` \u65b9\u6cd5\u8c03\u7528\uff0c\u6839\u636e\u8bf7\u6c42\u540e\u7f00\u5224\u65ad\u5ba2\u6237\u7aef\u662f\u8981\u521b\u5efa session \u8fd8\u662f\u8c03\u7528\u5de5\u5177\\n\\n```java\\npublic class McpServerPlugin extends AbstractShenyuPlugin {\\n    private Mono<Void> handleSseRequest(final ServerWebExchange exchange,\\n                                        final ShenyuPluginChain chain,\\n                                        final ServerRequest request,\\n                                        final SelectorData selector,\\n                                        final String uri) {\\n        ShenyuMcpServer server = McpServerPluginDataHandler.CACHED_SERVER.get().obtainHandle(selector.getId());\\n        String messageEndpoint = server.getMessageEndpoint();\\n        // \u83b7\u53d6\u4f20\u8f93\u8005\\n        ShenyuSseServerTransportProvider transportProvider\\n                = shenyuMcpServerManager.getOrCreateMcpServerTransport(uri, messageEndpoint);\\n        // \u6839\u636e\u8bf7\u6c42\u7684\u540e\u7f00\u5224\u65ad\u662f sse \u8fde\u63a5\u8bf7\u6c42\u8fd8\u662f message \u8c03\u7528\u8bf7\u6c42\\n        if (uri.endsWith(messageEndpoint)) {\\n            setupSessionContext(exchange, chain);\\n            return handleMessageEndpoint(exchange, transportProvider, request);\\n        } else {\\n            return handleSseEndpoint(exchange, transportProvider, request);\\n        }\\n    }\\n}\\n```\\n\\n#### 2.1 \u5ba2\u6237\u7aef\u53d1\u9001 sse \u8bf7\u6c42\\n\\n> \u5982\u679c\u6211\u4eec\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u662f\u540e\u7f00\u4e3a `/sse` \u7684\u8bf7\u6c42\uff0c\u90a3\u4e48\u5c06\u4f1a\u6267\u884c `handleSseEndpoint()` \u65b9\u6cd5\\n\\n* `handleSseEndpoint()` \u65b9\u6cd5\u4e3b\u8981\u505a\u4e86\u5982\u4e0b\u5de5\u4f5c\\n\\n1. \u914d\u7f6e sse \u8bf7\u6c42\u5934\\n2. \u8c03\u7528 `ShenyuSseServerTransportProvider` \u7684 `createSseFlux()` \u521b\u5efa sse \u6d41\\n\\n```java\\npublic class McpServerPlugin extends AbstractShenyuPlugin {\\n    private Mono<Void> handleSseEndpoint(final ServerWebExchange exchange,\\n                                         final ShenyuSseServerTransportProvider transportProvider,\\n                                         final ServerRequest request) {\\n        // \u914d\u7f6e sse \u8bf7\u6c42\u5934\\n        configureSseHeaders(exchange);\\n\\n        // \u521b\u5efa sse \u6d41\\n        return exchange.getResponse()\\n                .writeWith(transportProvider\\n                        .createSseFlux(request));\\n    }\\n}\\n```\\n\\n* `createSseFlux()` \u65b9\u6cd5\\n> \u8be5\u65b9\u6cd5\u88ab `handleSseEndpoint()`\u8c03\u7528 \u4e3b\u8981\u7528\u4e8e\u521b\u5efa\u5e76\u4fdd\u5b58 session\\n1. \u521b\u5efa session \uff0c\u521b\u5efa session \u7684\u5de5\u5382\u5728\u521b\u5efa session \u65f6\u4f1a\u5c06\u4e00\u7cfb\u5217 handler \u6ce8\u518c\u5230 session \u4e2d\uff0c\u8fd9\u4e9b handler \u662f\u771f\u6b63\u6267\u884c\\n   callTool \u7684\u5bf9\u8c61\\n2. \u5c06 session \u4fdd\u5b58\uff0csession\u590d\u7528\\n3. \u5c06 session id \u4f5c\u4e3a endpoint \u7684\u8bf7\u6c42\u53c2\u6570\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u5728\u8c03\u7528 message \u65b9\u6cd5\u65f6\u4f1a\u4f7f\u7528\u8be5 endpoint\\n\\n```java\\npublic class ShenyuSseServerTransportProvider implements McpServerTransportProvider {\\n    public Flux<ServerSentEvent<?>> createSseFlux(final ServerRequest request) {\\n        return Flux.<ServerSentEvent<?>>create(sink -> {\\n                    WebFluxMcpSessionTransport sessionTransport = new WebFluxMcpSessionTransport(sink);\\n                    // \u521b\u5efa McpServerSession \u5e76\u6682\u5b58\u63d2\u4ef6\u94fe\u4fe1\u606f\\n                    McpServerSession session = sessionFactory.create(sessionTransport);\\n                    String sessionId = session.getId();\\n                    sessions.put(sessionId, session);\\n\\n                    // \u5c06 session id\u7b49\u4fe1\u606f\u4f20\u9012\u56de\u5ba2\u6237\u7aef\\n                    String endpointUrl = this.baseUrl + this.messageEndpoint + \\"?sessionId=\\" + sessionId;\\n                    ServerSentEvent<String> endpointEvent = ServerSentEvent.<String>builder()\\n                            .event(ENDPOINT_EVENT_TYPE)\\n                            .data(endpointUrl)\\n                            .build();\\n                }).doOnSubscribe(subscription -> LOGGER.info(\\"SSE Flux subscribed\\"))\\n                .doOnRequest(n -> LOGGER.debug(\\"SSE Flux requested {} items\\", n));\\n    }\\n}\\n```\\n\\n#### 2.2 \u5ba2\u6237\u7aef\u53d1\u9001 message \u8bf7\u6c42\\n\\n> \u5982\u679c\u6211\u4eec\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u662f\u540e\u7f00\u4e3a `/message` \u7684\u8bf7\u6c42\uff0c\u90a3\u4e48\u5c06\u4f1a\u6267\u884c \u628a\u5f53\u524d `ShenyuPluginChain` \u4fe1\u606f\u5b58\u5165 session \u4e2d\uff0c\u5e76\u8c03\u7528 `handleMessageEndpoint()` \u65b9\u6cd5\uff0c\\n> \u540e\u7eed\u5de5\u5177\u8c03\u7528\u65f6\u4f1a\u7ee7\u7eed\u6267\u884c\u8be5\u63d2\u4ef6\u94fe\uff0c\u56e0\u6b64 mcp plugin \u540e\u7684\u63d2\u4ef6\u4f1a\u5bf9\u8fdb\u5165 tool \u7684\u8bf7\u6c42\u9020\u6210\u5f71\u54cd\\n\\n* `handleMessageEndpoint()` \u65b9\u6cd5\uff0c\u8c03\u7528 `ShenyuSseServerTransportProvider` \u7684 `handleMessageEndpoint()` \u65b9\u6cd5\\n\\n```\\nif (uri.endsWith(messageEndpoint)) {\\n       setupSessionContext(exchange, chain);\\n       return handleMessageEndpoint(exchange, transportProvider, request);\\n} \\n```\\n\\n```java\\npublic class McpServerPlugin extends AbstractShenyuPlugin {\\n    private Mono<Void> handleMessageEndpoint(final ServerWebExchange exchange,\\n                                             final ShenyuSseServerTransportProvider transportProvider,\\n                                             final ServerRequest request) {\\n        // \u5904\u7406message\u8bf7\u6c42\\n        return transportProvider.handleMessageEndpoint(request)\\n                .flatMap(result -> {\\n                    return exchange.getResponse()\\n                            .writeWith(Mono.just(exchange.getResponse().bufferFactory().wrap(responseBody.getBytes())));\\n                });\\n    }\\n}\\n```\\n\\n* `handleMessageEndpoint()` \u65b9\u6cd5\\n> \u8be5\u65b9\u6cd5\u7531 `McpServerPlugin.handleMessageEndpoint()` \u8c03\u7528\uff0c\u5c06\u8bf7\u6c42\u4ea4\u7ed9 session \u5904\u7406\\n\\nsession \u7684 `handler()` \u65b9\u6cd5\u4f1a\u5bf9 message \u7684\u4e0d\u540c\uff0c\u800c\u8fdb\u884c\u5bf9\u5e94\u7684\u64cd\u4f5c\\n\u4f8b\u5982 \uff1a \u5f53 message \u4e2d method \u662f \\"tools/call\\" \u65f6\uff0c\u5219\u4f1a\u4f7f\u7528\u5de5\u5177\u8c03\u7528\u7684 handler() \u6267\u884c `call()` \u65b9\u6cd5\u8c03\u7528\u5de5\u5177\\n\u76f8\u5173\u6e90\u7801\u5728\u6b64\u4e0d\u8fc7\u591a\u8d58\u8ff0\\n\\n```java\\npublic class ShenyuSseServerTransportProvider implements McpServerTransportProvider {\\n    public Mono<MessageHandlingResult> handleMessageEndpoint(final ServerRequest request) {\\n        // \u83b7\u53d6\u5230session\\n        String sessionId = request.queryParam(\\"sessionId\\").get();\\n        McpServerSession session = sessions.get(sessionId);\\n        return request.bodyToMono(String.class)\\n                .flatMap(body -> {\\n                    McpSchema.JSONRPCMessage message = McpSchema.deserializeJsonRpcMessage(objectMapper, body);\\n                    return session.handle(message);\\n                });\\n    }\\n}\\n```\\n\\n\u81f3\u6b64 `Shenyu Mcp Plugin` \u670d\u52a1\u8c03\u7528\u6e90\u7801\u5206\u6790\u5b8c\u6bd5\\n\\n\u6d41\u7a0b\u56fe\u4e00\u89c8\\n![](/img/activities/code-analysis-mcp-server-plugin/Mcp-server-execute-zh.png)\\n\\n### 3. \u5de5\u5177\u8c03\u7528\\n\\n> \u5982\u679c\u5ba2\u6237\u7aef\u4f20\u9012\u7684\u6d88\u606f\u662f\u8c03\u7528\u5de5\u5177\u7684\u6d88\u606f\uff0c\u90a3\u4e48 session \u5c06\u4f7f\u7528\u5de5\u5177\u8c03\u7528\u7684 handler() \u5e76\u6267\u884c tool \u7684 `call()` \u65b9\u6cd5\uff0c\\n> \u5728\u670d\u52a1\u6ce8\u518c\u4e2d\uff0c\u6211\u4eec\u8bf4\u660e\u4e86 tool \u5728\u88ab\u8c03\u7528\u65f6\uff0c\u5b9e\u9645\u6267\u884c\u7684\u662f `ShenyuToolCallback()` \u7684 `call()` \u65b9\u6cd5\\n\\n\u56e0\u6b64\u6267\u884c\u5de5\u5177\u8c03\u7528\u65f6\u4f1a\u6267\u884c\u4ee5\u4e0b\u65b9\u6cd5\\n* `call()` \u4e3b\u8981\u5de5\u4f5c\u5185\u5bb9\u5982\u4e0b\\n\\n1. \u83b7\u53d6 session id\\n2. \u83b7\u53d6 `requestTemplate` \u5373 shenyu \u63d0\u4f9b\u7684\u989d\u5916\u529f\u80fd\u7684\u914d\u7f6e\u4fe1\u606f\\n3. \u83b7\u53d6\u4e0a\u4e00\u6b65\u6682\u5b58\u7684 shenyu \u63d2\u4ef6\u94fe\uff0c\u5e76\u5c06\u5de5\u5177\u8c03\u7528\u7684\u4fe1\u606f\u4ea4\u7ed9\u63d2\u4ef6\u94fe\u7ee7\u7eed\u6267\u884c\\n4. \u5f02\u6b65\u7b49\u5f85\u5de5\u5177\u54cd\u5e94\\n\\n\u63d2\u4ef6\u94fe\u6267\u884c\u5b8c\u6210\u540e\uff0c\u4f1a\u5c06\u8c03\u7528 tool \u8bf7\u6c42\u771f\u6b63\u7684\u53d1\u9001\u5230 tool \u6240\u5728\u7684\u670d\u52a1\u4e4b\u4e2d\\n\\n```java\\npublic class ShenyuToolCallback implements ToolCallback {\\n    @NonNull\\n    @Override\\n    public String call(@NonNull final String input, final ToolContext toolContext) {\\n        // \u4ece mcp \u8bf7\u6c42\u4e2d\u63d0\u53d6 sessionId\\n        final McpSyncServerExchange mcpExchange = extractMcpExchange(toolContext);\\n        final String sessionId = extractSessionId(mcpExchange);\\n        // \u63d0\u53d6requestTemplate\u4fe1\u606f\\n        final String configStr = extractRequestConfig(shenyuTool);\\n\\n        // \u5229\u7528sessionId \u83b7\u53d6\u5230\u5148\u524d\u6682\u5b58\u7684\u63d2\u4ef6\u6267\u884c\u94fe\\n        final ServerWebExchange originExchange = getOriginExchange(sessionId);\\n        final ShenyuPluginChain chain = getPluginChain(originExchange);\\n\\n        // \u6267\u884c\u5de5\u5177\u8c03\u7528\\n        return executeToolCall(originExchange, chain, sessionId, configStr, input);\\n\\n    }\\n\\n    private String executeToolCall(final ServerWebExchange originExchange,\\n                                   final ShenyuPluginChain chain,\\n                                   final String sessionId,\\n                                   final String configStr,\\n                                   final String input) {\\n\\n        final CompletableFuture<String> responseFuture = new CompletableFuture<>();\\n        final ServerWebExchange decoratedExchange = buildDecoratedExchange(\\n                originExchange, responseFuture, sessionId, configStr, input);\\n        // \u6267\u884c\u63d2\u4ef6\u94fe\uff0c\u8c03\u7528\u5b9e\u9645\u5de5\u5177\\n        chain.execute(decoratedExchange)\\n                .subscribe();\\n\\n        // \u7b49\u5f85\u54cd\u5e94\\n        final String result = responseFuture.get(DEFAULT_TIMEOUT_SECONDS, TimeUnit.SECONDS);\\n        return result;\\n\\n    }\\n}\\n```\\n\\n\u81f3\u6b64Shenyu MCP Plugin \u5de5\u5177\u8c03\u7528\u5206\u6790\u5b8c\u6bd5\\n\\n![](/img/activities/code-analysis-mcp-server-plugin/Mcp-server-tool-call-zh.png)\\n\\n---\\n\\n### 4. \u5c0f\u7ed3\\n\\n\u672c\u6587\u6e90\u7801\u5206\u6790\u4ece mcp \u670d\u52a1\u6ce8\u518c\u5f00\u59cb\uff0c\u5230 mcp \u63d2\u4ef6\u7684\u670d\u52a1\u8c03\u7528\uff0c\u518d\u5230 tool \u7684\u8c03\u7528\u3002\\nmcpServer \u63d2\u4ef6\u8ba9 shenyu \u6210\u4e3a\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\uff0c\u96c6\u4e2d\u7ba1\u7406\u7684 mcpServer\u3002\\n\\n---"},{"id":"/Plugin-SourceCode-Analysis-Param-Mapping-Plugin","metadata":{"permalink":"/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin.md","title":"Param-Mapping\u63d2\u4ef6\u6e90\u7801\u5206\u6790","description":"\u5f00\u59cb\u524d\uff0c\u53ef\u4ee5\u53c2\u8003 \u8fd9\u7bc7\u6587\u7ae0 \u8fd0\u884cshenyu\u7f51\u5173","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"Param-Mapping","permalink":"/zh/blog/tags/param-mapping"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":5.59,"hasTruncateMarker":false,"authors":[{"name":"Kunshuai Zhu","title":"Apache ShenYu Contributor","url":"https://github.com/JooKS-me","imageURL":"https://avatars1.githubusercontent.com/u/62384022?v=4"}],"frontMatter":{"title":"Param-Mapping\u63d2\u4ef6\u6e90\u7801\u5206\u6790","author":"Kunshuai Zhu","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/JooKS-me","author_image_url":"https://avatars1.githubusercontent.com/u/62384022?v=4","tags":["Param-Mapping","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"McpServer \u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"},"nextItem":{"title":"\u6ce8\u518c\u4e2d\u5fc3\u5b9e\u73b0\u539f\u7406\u4e4bHttp\u6ce8\u518c","permalink":"/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register"}},"content":"> \u5f00\u59cb\u524d\uff0c\u53ef\u4ee5\u53c2\u8003 [\u8fd9\u7bc7\u6587\u7ae0](./Start-SourceCode-Analysis-Start-Demo) \u8fd0\u884cshenyu\u7f51\u5173\\n\\n### \u6b63\u6587\\n\\n\u5148\u770b\u4e00\u4e0b\u8fd9\u4e2a\u63d2\u4ef6\u7684\u7ed3\u6784\uff0c\u5982\u4e0b\u56fe\u3002\\n\\n![param-mapping-structure](/img/activities/code-analysis-param-mapping-plugin/param-mapping-structure.png)\\n\\n\u731c\u6d4b\uff1ahandler\u662f\u7528\u6765\u505a\u6570\u636e\u540c\u6b65\u7684\uff1bstrategy\u4e2d\u6587\u610f\u601d\u662f\u7b56\u7565\uff0c\u53ef\u80fd\u662f\u5bf9\u5404\u79cd\u8bf7\u6c42\u4f53\u505a\u4e86\u9002\u914d\uff0c\u5e94\u8be5\u662f\u8fd9\u4e2a\u63d2\u4ef6\u7684\u91cd\u70b9\uff1b`ParamMappingPlugin` \u5e94\u8be5\u662f `ShenyuPlugin` \u7684\u5b9e\u73b0\u3002\\n\\n\u9996\u5148\uff0c\u770b\u4e00\u4e0b `ParamMappingPlugin` \uff0c\u91cc\u9762\u4e3b\u8981\u662f\u5bf9 `doExecute` \u65b9\u6cd5\u7684\u91cd\u5199\u3002\\n\\n```java\\npublic Mono<Void> doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {\\n    ... // paramMappingHandle\u5224\u65ad\u662f\u5426\u4e3a\u7a7a\\n    // \u6839\u636e\u9996\u90e8\u884c\u4e2d\u7684contentType\u786e\u5b9a\u8bf7\u6c42\u4f53\u7c7b\u578b\\n    HttpHeaders headers = exchange.getRequest().getHeaders();\\n    MediaType contentType = headers.getContentType();\\n  \\t// *\\n    return match(contentType).apply(exchange, chain, paramMappingHandle);\\n}\\n```\\n\\n- match\u65b9\u6cd5\u662f\u6839\u636econtentType\u8fd4\u56de\u5bf9\u5e94\u7684 `Operator`\\n\\n  ```java\\n  private Operator match(final MediaType mediaType) {\\n      if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {\\n          return operatorMap.get(MediaType.APPLICATION_JSON.toString());\\n      } else if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {\\n          return operatorMap.get(MediaType.APPLICATION_FORM_URLENCODED.toString());\\n      } else {\\n          return operatorMap.get(Constants.DEFAULT);\\n      }\\n  }\\n  ```\\n\\n  \u4ecematch\u65b9\u6cd5\u7684\u4ee3\u7801\u53ef\u4ee5\u770b\u51fa\uff0c\u76ee\u524d\u6709 `DefaultOperator`\u3001`FormDataOperator`\u3001`JsonOperator`\u4e09\u79cd\uff0c\u652f\u6301 `x-www-form-urlencoded` \u548c `json` \u4e24\u79cd\u683c\u5f0f\u7684\u8bf7\u6c42\u4f53\u3002\\n\\n\u90a3\u4e48\u6211\u4eec\u5c31\u6765\u770b\u4e00\u4e0b\u4e0a\u9762\u4e09\u79cdOperator\u7a76\u7adf\u662f\u600e\u4e48\u6837\u7684\u5427\u3002\\n\\n#### \u4e00\u3001DefaultOperator\\n\\n\u865a\u6643\u4e00\u67aa\uff0c\u5b83\u7684apply\u65b9\u6cd5\u53ea\u662f\u7ee7\u7eed\u6267\u884c\u63d2\u4ef6\u94fe\uff0c\u5e76\u6ca1\u6709\u5b9e\u8d28\u529f\u80fd\u3002\u5f53\u8bf7\u6c42\u4f53\u6ca1\u6709\u5339\u914d\u5230Operator\u65f6\uff0c\u5c31\u4f1a\u901a\u8fc7 `DefaultOperator` \u8df3\u8fc7\u3002\\n\\n#### \u4e8c\u3001FormDataOperator\\n\\n\u8fd9\u4e2a\u7c7b\u662f\u7528\u6765\u5904\u7406 `x-www-form-urlencoded` \u683c\u5f0f\u7684\u8bf7\u6c42\u4f53\u7684\u3002\\n\\n\u4e3b\u8981\u662f\u770bapply\u65b9\u6cd5\uff0c\u4f46\u662f\u8fd9\u4e2aapply\u65b9\u6cd5\u957f\u5f97\u6709\u70b9\u5947\u602a\u3002\\n\\n```java\\npublic Mono<Void> apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {\\n    return exchange.getFormData()\\n            .switchIfEmpty(Mono.defer(() -> Mono.just(new LinkedMultiValueMap<>())))\\n            .flatMap(multiValueMap -> {\\n                ...\\n            });\\n}\\n```\\n\\n\u7701\u7565\u53f7\u4e2d\u7684\u4ee3\u7801\u662f\u5bf9\u8bf7\u6c42\u4f53\u7684\u5904\u7406\uff0c\u5982\u4e0b\u3002\\n\\n```java\\n// \u5224\u7a7a\\nif (Objects.isNull(multiValueMap) || multiValueMap.isEmpty()) {\\n    return shenyuPluginChain.execute(exchange);\\n}\\n// \u5c06form-data\u8f6c\u5316\u6210json\\nString original = GsonUtils.getInstance().toJson(multiValueMap);\\nLOG.info(\\"get from data success data:{}\\", original);\\n// *\u4fee\u6539\u8bf7\u6c42\u4f53*\\nString modify = operation(original, paramMappingHandle);\\nif (StringUtils.isEmpty(modify)) {\\n    return shenyuPluginChain.execute(exchange);\\n}\\n...\\n// \u5c06\u4fee\u6539\u540e\u7684json\uff0c\u8f6c\u6362\u6210LinkedMultiValueMap\u3002\u6ce8\u610f\u4e00\u4e0b\u8fd9\u4e00\u884c\uff0c\u540e\u9762\u4f1a\u63d0\u5230\uff01\\nLinkedMultiValueMap<String, String> modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);\\n...\\nfinal BodyInserter bodyInserter = BodyInserters.fromValue(modifyMap);\\n...\\n// \u4fee\u6539exchange\u4e2d\u7684\u8bf7\u6c42\u4f53\uff0c\u7136\u540e\u7ee7\u7eed\u6267\u884c\u63d2\u4ef6\u94fe\\nreturn bodyInserter.insert(cachedBodyOutputMessage, new BodyInserterContext())\\n        .then(Mono.defer(() -> shenyuPluginChain.execute(exchange.mutate()\\n                .request(new ModifyServerHttpRequestDecorator(httpHeaders, exchange.getRequest(), cachedBodyOutputMessage))\\n                .build())\\n        )).onErrorResume((Function<Throwable, Mono<Void>>) throwable -> release(cachedBodyOutputMessage, throwable));\\n```\\n\\n> PS: \u7701\u7565\u7684\u90e8\u5206\u662f\u8bbe\u7f6e\u8bf7\u6c42\u5934\u7b49\u64cd\u4f5c\u3002\\n\\n\u4e0a\u9762\u6bd4\u8f83\u91cd\u8981\u7684\u5e94\u8be5\u662f\u6253\u661f\u7684\u4fee\u6539\u8bf7\u6c42\u4f53\uff0c\u4e5f\u5c31\u662f `operation` \u65b9\u6cd5\u7684\u8c03\u7528\u3002\u8fd9\u91cc\u56e0\u4e3a\u53c2\u6570\u7c7b\u578b\u7684\u539f\u56e0\uff0c\u4f1a\u5148\u8c03\u7528 `Operator` \u63a5\u53e3\u7684\u9ed8\u8ba4\u65b9\u6cd5\uff08\u800c\u4e0d\u662f `FormDataOperator` \u91cd\u5199\u7684\uff09\u3002\\n\\n```java\\ndefault String operation(final String jsonValue, final ParamMappingHandle paramMappingHandle) {\\n    DocumentContext context = JsonPath.parse(jsonValue);\\n    // \u8c03\u7528\u91cd\u5199\u7684operation\u65b9\u6cd5\uff0c\u6dfb\u52a0addParameterKey\\n    operation(context, paramMappingHandle);\\n    // \u5bf9\u8bbe\u7f6e\u7684replacedParameterKey\u8fdb\u884c\u66ff\u6362\\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getReplaceParameterKeys())) {\\n        paramMappingHandle.getReplaceParameterKeys().forEach(info -> {\\n            context.renameKey(info.getPath(), info.getKey(), info.getValue());\\n        });\\n    }\\n    // \u5bf9\u8bbe\u7f6e\u7684removeParameterKey\u8fdb\u884c\u5220\u9664\\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getRemoveParameterKeys())) {\\n        paramMappingHandle.getRemoveParameterKeys().forEach(info -> {\\n            context.delete(info);\\n        });\\n    }\\n    return context.jsonString();\\n}\\n```\\n\\n\u68b3\u7406\u4e0b\u6765\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd9\u91cc\u5f15\u5165\u7684json\u5de5\u5177[JsonPath](https://github.com/json-path/JsonPath)\u4f7f\u5f97\u8bf7\u6c42\u4f53\u7684\u52a0\u5de5\u53d8\u5f97\u7b80\u5355\u3001\u6e05\u6670\u5f88\u591a\u3002\\n\\n**\u53e6\u5916\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u610f\u5230 `FormDataOperator` \u91cd\u5199\u4e86 `operation(DocumentContext, ParamMappingHandle)` \u65b9\u6cd5\u3002**\\n\\n**\u4e3a\u4ec0\u4e48\u8981\u91cd\u5199\u5462\uff1f** \u63a5\u53e3\u4e2d\u6709\u5bf9\u5e94\u5904\u7406addParameterKey\u7684\u9ed8\u8ba4\u65b9\u6cd5\u554a\u3002\\n\\n```java\\n// Operator\u63a5\u53e3\u4e2d\u7684\u9ed8\u8ba4\u65b9\u6cd5\\ndefault void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {\\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {\\n        paramMappingHandle.getAddParameterKeys().forEach(info -> {\\n            context.put(info.getPath(), info.getKey(), info.getValue()); //\u4e0d\u540c\u4e4b\u5904\\n        });\\n    }\\n}\\n\\n// FormDataOperator\u91cd\u5199\u7684\u65b9\u6cd5\\n@Override\\npublic void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {\\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {\\n        paramMappingHandle.getAddParameterKeys().forEach(info -> {\\n            context.put(info.getPath(), info.getKey(), Arrays.asList(info.getValue()));\\n        });\\n    }\\n}\\n```\\n\\n\u5b9e\u9645\u4e0a\uff0c\u5728 `FormDataOperator#apply` \u4e2d\u6709\u8fd9\u4e48\u4e00\u884c\uff08\u524d\u9762\u6709\u63d0\u5230\uff09\uff1a`LinkedMultiValueMap<String, String> modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);`\\n\\n\u8fd9\u4e00\u884c\u662f\u5c06\u4fee\u6539\u540e\u7684json\u8f6c\u6362\u6210 `LinkedMultiValueMap`\uff0c`GsonUtils#toLinkedMultiValueMap` \u5982\u4e0b\u3002\\n\\n```java\\npublic LinkedMultiValueMap<String, String> toLinkedMultiValueMap(final String json) {\\n    return GSON.fromJson(json, new TypeToken<LinkedMultiValueMap<String, String>>() {\\n    }.getType());\\n}\\n```\\n\\n\u800c `LinkedMultiValueMap` \u7c7b\u4e2d\u7684\u5c5e\u6027 `targetMap` \u5b9a\u4e49\u4e3a\uff1a`private final Map<K, List<V>> targetMap`\\n\\n\u56e0\u6b64\uff0cjson\u5b57\u7b26\u4e32\u4e2d\u7684value\u5fc5\u987b\u662f\u5217\u8868\u5f62\u5f0f\u7684\uff0c\u4e0d\u7136Gson\u5c31\u4f1a\u629b\u51fa\u8f6c\u6362\u9519\u8bef\u7684\u5f02\u5e38\uff0c\u8fd9\u4e5f\u5c31\u662f\u4e3a\u4ec0\u4e48 `FormDataOperator` \u8981\u91cd\u5199operator\u65b9\u6cd5\u3002\\n\\n**\u90a3\u4e48\u4e3a\u4ec0\u4e48\u8981\u7528 `LinkedMultiValueMap` \u5462\uff1f**\\n\\n\u56de\u5230 `FormDataOperator#apply` \u65b9\u6cd5\u7684\u7b2c\u4e00\u884c `exchange.getFormData` \u3002\u800cSpringMVC\u4e2d\uff0c`DefaultServerWebExchange#getFormData` \u7684\u8fd4\u56de\u503c\u7c7b\u578b\u5c31\u662f `Mono<MultiValueMap<String, String>>` \uff0c\u800c `LinkedMultiValueMap` \u662f `MultiValueMap` \u7684\u5b50\u7c7b\u3002\u5e76\u4e14\uff0c`getFormData` \u65b9\u6cd5\u5c31\u662f\u9488\u5bf9 `x-www-form-urlencoded` \u683c\u5f0f\u7684\u8bf7\u6c42\u4f53\u7684\u3002\\n\\n![param-mapping-getFormData](/img/activities/code-analysis-param-mapping-plugin/param-mapping-getFormData.png)\\n\\n#### \u4e09\u3001JsonOperator\\n\\n\u663e\u7136\uff0c\u8fd9\u4e2a\u7c7b\u662f\u7528\u6765\u5904\u7406Json\u683c\u5f0f\u7684\u8bf7\u6c42\u4f53\u7684\u3002\\n\\n```java\\npublic Mono<Void> apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {\\n    ServerRequest serverRequest = ServerRequest.create(exchange, MESSAGE_READERS);\\n    Mono<String> mono = serverRequest.bodyToMono(String.class).switchIfEmpty(Mono.defer(() -> Mono.just(\\"\\"))).flatMap(originalBody -> {\\n        LOG.info(\\"get body data success data:{}\\", originalBody);\\n        // \u8c03\u7528\u9ed8\u8ba4\u7684operation\u65b9\u6cd5\u4fee\u6539\u8bf7\u6c42\u4f53\\n        String modify = operation(originalBody, paramMappingHandle);\\n        return Mono.just(modify);\\n    });\\n    BodyInserter bodyInserter = BodyInserters.fromPublisher(mono, String.class);\\n    ... //\u5904\u7406\u9996\u90e8\u884c\\n    CachedBodyOutputMessage outputMessage = new CachedBodyOutputMessage(exchange, headers);\\n    // \u4fee\u6539exchange\u4e2d\u7684\u8bf7\u6c42\u4f53\uff0c\u7136\u540e\u7ee7\u7eed\u6267\u884c\u63d2\u4ef6\u94fe\\n    return bodyInserter.insert(outputMessage, new BodyInserterContext())\\n            .then(Mono.defer(() -> {\\n                ServerHttpRequestDecorator decorator = new ModifyServerHttpRequestDecorator(headers, exchange.getRequest(), outputMessage);\\n                return shenyuPluginChain.execute(exchange.mutate().request(decorator).build());\\n            })).onErrorResume((Function<Throwable, Mono<Void>>) throwable -> release(outputMessage, throwable));\\n}\\n```\\n\\n`JsonOperator` \u7684\u5904\u7406\u6d41\u7a0b\u4e0e `FormDataOperator` \u5927\u81f4\u7c7b\u4f3c\u3002\\n\\n### \u603b\u7ed3\\n\\n\u6700\u540e\uff0c\u7528\u4e00\u5f20\u56fe\u6765\u7b80\u5355\u603b\u7ed3\u4e00\u4e0b\u3002\\n\\n![param-mapping-summary](/img/activities/code-analysis-param-mapping-plugin/param-mapping-summary.jpg)"},{"id":"/RegisterCenter-SourceCode-Analysis-Http-Register","metadata":{"permalink":"/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/RegisterCenter-SourceCode-Analysis-Http-Register.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/RegisterCenter-SourceCode-Analysis-Http-Register.md","title":"\u6ce8\u518c\u4e2d\u5fc3\u5b9e\u73b0\u539f\u7406\u4e4bHttp\u6ce8\u518c","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"http","permalink":"/zh/blog/tags/http"},{"label":"register center","permalink":"/zh/blog/tags/register-center"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":39.97,"hasTruncateMarker":false,"authors":[{"name":"midnight2104","title":"Apache ShenYu Committer","url":"https://github.com/midnight2104"}],"frontMatter":{"title":"\u6ce8\u518c\u4e2d\u5fc3\u5b9e\u73b0\u539f\u7406\u4e4bHttp\u6ce8\u518c","author":"midnight2104","author_title":"Apache ShenYu Committer","author_url":"https://github.com/midnight2104","tags":["http","register center","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Param-Mapping\u63d2\u4ef6\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin"},"nextItem":{"title":"LoadBalancer SPI \u4ee3\u7801\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI"}},"content":"> [Apache ShenYu](https://shenyu.apache.org/zh/docs/index) \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 `API` \u7f51\u5173\u3002\\n\\n\u5728`ShenYu`\u7f51\u5173\u4e2d\uff0c\u6ce8\u518c\u4e2d\u5fc3\u662f\u7528\u4e8e\u5c06\u5ba2\u6237\u7aef\u4fe1\u606f\u6ce8\u518c\u5230`shenyu-admin`\uff0c`admin`\u518d\u901a\u8fc7\u6570\u636e\u540c\u6b65\u5c06\u8fd9\u4e9b\u4fe1\u606f\u540c\u6b65\u5230\u7f51\u5173\uff0c\u7f51\u5173\u901a\u8fc7\u8fd9\u4e9b\u6570\u636e\u5b8c\u6210\u6d41\u91cf\u7b5b\u9009\u3002\u5ba2\u6237\u7aef\u4fe1\u606f\u4e3b\u8981\u5305\u62ec`\u63a5\u53e3\u4fe1\u606f`\u548c`URI\u4fe1\u606f`\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.5.0`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 [\u5ba2\u6237\u7aef\u63a5\u5165\u539f\u7406](https://shenyu.apache.org/zh/docs/design/register-center-design) \u3002\\n\\n\\n### 1. \u6ce8\u518c\u4e2d\u5fc3\u539f\u7406\\n\\n\u5f53\u5ba2\u6237\u7aef\u542f\u52a8\u65f6\uff0c\u8bfb\u53d6\u63a5\u53e3\u4fe1\u606f\u548c`uri\u4fe1\u606f`\uff0c\u901a\u8fc7\u6307\u5b9a\u7684\u6ce8\u518c\u7c7b\u578b\uff0c\u5c06\u6570\u636e\u53d1\u9001\u5230`shenyu-admin`\u3002\\n\\n![](/img/activities/code-analysis-http-register/register-center.png)\\n\\n\\n\u56fe\u4e2d\u7684\u6ce8\u518c\u4e2d\u5fc3\u9700\u8981\u7528\u6237\u6307\u5b9a\u4f7f\u7528\u54ea\u79cd\u6ce8\u518c\u7c7b\u578b\uff0c`ShenYu`\u5f53\u524d\u652f\u6301`Http`\u3001`Zookeeper`\u3001`Etcd`\u3001`Consul`\u548c`Nacos`\u8fdb\u884c\u6ce8\u518c\u3002\u5177\u4f53\u5982\u4f55\u914d\u7f6e\u8bf7\u53c2\u8003 [\u5ba2\u6237\u7aef\u63a5\u5165\u914d\u7f6e](https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access) \u3002\\n\\n\\n`ShenYu`\u5728\u6ce8\u518c\u4e2d\u5fc3\u7684\u539f\u7406\u8bbe\u8ba1\u4e0a\u5f15\u5165\u4e86`Disruptor`\uff0c`Disruptor`\u961f\u5217\u5728\u5176\u4e2d\u8d77\u5230\u6570\u636e\u4e0e\u64cd\u4f5c\u89e3\u8026\uff0c\u5229\u4e8e\u6269\u5c55\u3002\u5982\u679c\u6ce8\u518c\u8bf7\u6c42\u8fc7\u591a\uff0c\u5bfc\u81f4\u6ce8\u518c\u5f02\u5e38\uff0c\u4e5f\u6709\u6570\u636e\u7f13\u51b2\u4f5c\u7528\u3002\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/shenyu-register-center.png)\\n\\n\\n\\n\u5982\u56fe\u6240\u793a\uff0c\u6ce8\u518c\u4e2d\u5fc3\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff0c\u4e00\u662f\u6ce8\u518c\u4e2d\u5fc3\u5ba2\u6237\u7aef`register-client`\uff0c\u8d1f\u8d23\u5904\u7406\u5ba2\u6237\u7aef\u6570\u636e\u8bfb\u53d6\u3002\u53e6\u4e00\u4e2a\u662f\u6ce8\u518c\u4e2d\u5fc3\u670d\u52a1\u7aef`register-server`\uff0c\u8d1f\u8d23\u5904\u7406\u670d\u52a1\u7aef\uff08\u5c31\u662f`shenyu-admin`\uff09\u6570\u636e\u5199\u5165\u3002\u901a\u8fc7\u6307\u5b9a\u6ce8\u518c\u7c7b\u578b\u8fdb\u884c\u6570\u636e\u53d1\u9001\u548c\u63a5\u6536\u3002\\n\\n- \u5ba2\u6237\u7aef\uff1a\u901a\u5e38\u6765\u8bf4\u5c31\u662f\u4e00\u4e2a\u5fae\u670d\u52a1\uff0c\u53ef\u4ee5\u662f`springmvc`\uff0c`spring-cloud`\uff0c`dubbo`\uff0c`grpc`\u7b49\u3002\\n- `register-client`\uff1a\u6ce8\u518c\u4e2d\u5fc3\u5ba2\u6237\u7aef\uff0c\u8bfb\u53d6\u5ba2\u6237\u63a5\u53e3\u548c`uri`\u4fe1\u606f\u3002\\n- `Disruptor`\uff1a\u6570\u636e\u4e0e\u64cd\u4f5c\u89e3\u8026\uff0c\u6570\u636e\u7f13\u51b2\u4f5c\u7528\u3002\\n- `register-server`\uff1a\u6ce8\u518c\u4e2d\u5fc3\u670d\u52a1\u7aef\uff0c\u8fd9\u91cc\u5c31\u662f`shenyu-admin`\uff0c\u63a5\u6536\u6570\u636e\uff0c\u5199\u5165\u6570\u636e\u5e93\uff0c\u53d1\u6570\u636e\u540c\u6b65\u4e8b\u4ef6\u3002\\n- \u6ce8\u518c\u7c7b\u578b\uff1a\u6307\u5b9a\u6ce8\u518c\u7c7b\u578b\uff0c\u5b8c\u6210\u6570\u636e\u6ce8\u518c\uff0c\u5f53\u524d\u652f\u6301`Http`\u3001`Zookeeper`\u3001`Etcd`\u3001`Consul`\u548c`Nacos`\u3002\\n\\n\\n\\n\u672c\u6587\u5206\u6790\u7684\u662f\u4f7f\u7528`Http`\u7684\u65b9\u5f0f\u8fdb\u884c\u6ce8\u518c\uff0c\u6240\u4ee5\u5177\u4f53\u7684\u5904\u7406\u6d41\u7a0b\u5982\u4e0b\uff1a\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/shenyu-register-center-http.png)\\n\\n\\n\\n\u5728\u5ba2\u6237\u7aef\uff0c\u6570\u636e\u51fa\u961f\u5217\u540e\uff0c\u901a\u8fc7`http`\u4f20\u8f93\u6570\u636e\uff0c\u5728\u670d\u52a1\u7aef\uff0c\u63d0\u4f9b\u76f8\u5e94\u7684\u63a5\u53e3\uff0c\u63a5\u6536\u6570\u636e\uff0c\u7136\u540e\u5199\u5165\u961f\u5217\u3002\\n\\n\\n\\n### 2. \u5ba2\u6237\u7aef\u6ce8\u518c\u6d41\u7a0b\\n\\n\\n\\n\u5f53\u5ba2\u6237\u7aef\u542f\u52a8\u540e\uff0c\u6839\u636e\u76f8\u5173\u914d\u7f6e\uff0c\u8bfb\u53d6\u5c5e\u6027\u4fe1\u606f\uff0c\u7136\u540e\u5199\u5165\u961f\u5217\u3002\u4ee5\u5b98\u65b9\u63d0\u4f9b\u7684 [shenyu-examples-http](https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http) \u4e3a\u4f8b\uff0c\u5f00\u59cb\u6e90\u7801\u5206\u6790\u3002\u5b98\u65b9\u63d0\u4f9b\u7684\u4f8b\u5b50\u662f\u4e00\u4e2a\u7531`springboot`\u6784\u5efa\u7684\u5fae\u670d\u52a1\u3002\u6ce8\u518c\u4e2d\u5fc3\u7684\u76f8\u5173\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51  [\u5ba2\u6237\u7aef\u63a5\u5165\u914d\u7f6e](https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access) \u3002\\n\\n\\n\\n#### 2.1 \u52a0\u8f7d\u914d\u7f6e\uff0c\u8bfb\u53d6\u5c5e\u6027\\n\\n\\n\\n\u5148\u7528\u4e00\u5f20\u56fe\u4e32\u8054\u4e0b\u6ce8\u518c\u4e2d\u5fc3\u5ba2\u6237\u7aef\u521d\u59cb\u5316\u6d41\u7a0b\uff1a\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/client-register-init-zh.png)\\n\\n\\n\\n\u6211\u4eec\u5206\u6790\u7684\u662f\u901a\u8fc7`http`\u7684\u65b9\u5f0f\u8fdb\u884c\u6ce8\u518c\uff0c\u6240\u4ee5\u9700\u8981\u8fdb\u884c\u5982\u4e0b\u914d\u7f6e\uff1a\\n\\n```yaml\\nshenyu:\\n  register:\\n    registerType: http\\n    serverLists: http://localhost:9095\\n  props:\\n    username: admin\\n    password: 123456\\n  client:\\n    http:\\n        props:\\n          contextPath: /http\\n          appName: http\\n          port: 8189  \\n          isFull: false\\n```\\n\\n\u6bcf\u4e2a\u5c5e\u6027\u8868\u793a\u7684\u542b\u4e49\u5982\u4e0b\uff1a\\n\\n- `registerType`: \u670d\u52a1\u6ce8\u518c\u7c7b\u578b\uff0c\u586b\u5199 `http`\u3002\\n- `serverList`: \u4e3a`http`\u6ce8\u518c\u7c7b\u578b\u65f6\uff0c\u586b\u5199`Shenyu-Admin`\u9879\u76ee\u7684\u5730\u5740\uff0c\u6ce8\u610f\u52a0\u4e0a`http://`\uff0c\u591a\u4e2a\u5730\u5740\u7528\u82f1\u6587\u9017\u53f7\u5206\u9694\u3002\\n- `username`: `Shenyu-Admin`\u7528\u6237\u540d\\n- `password`: `Shenyu-Admin`\u7528\u6237\u5bf9\u5e94\u7684\u5bc6\u7801\\n- `port`: \u4f60\u672c\u9879\u76ee\u7684\u542f\u52a8\u7aef\u53e3\uff0c\u76ee\u524d`springmvc/tars/grpc`\u9700\u8981\u8fdb\u884c\u586b\u5199\u3002\\n- `contextPath`: \u4e3a\u4f60\u7684\u8fd9\u4e2a`mvc`\u9879\u76ee\u5728`shenyu`\u7f51\u5173\u7684\u8def\u7531\u524d\u7f00\uff0c \u6bd4\u5982`/order` \uff0c`/product` \u7b49\u7b49\uff0c\u7f51\u5173\u4f1a\u6839\u636e\u4f60\u7684\u8fd9\u4e2a\u524d\u7f00\u6765\u8fdb\u884c\u8def\u7531\u3002\\n- `appName`\uff1a\u4f60\u7684\u5e94\u7528\u540d\u79f0\uff0c\u4e0d\u914d\u7f6e\u7684\u8bdd\uff0c\u4f1a\u9ed8\u8ba4\u53d6 `spring.application.name` \u7684\u503c\u3002\\n- `isFull`: \u8bbe\u7f6e `true` \u4ee3\u8868\u4ee3\u7406\u4f60\u7684\u6574\u4e2a\u670d\u52a1\uff0c`false`\u8868\u793a\u4ee3\u7406\u4f60\u5176\u4e2d\u67d0\u51e0\u4e2a`controller`\uff1b\u76ee\u524d\u9002\u7528\u4e8e`springmvc/springcloud`\u3002\\n\\n\u9879\u76ee\u542f\u52a8\u540e\uff0c\u4f1a\u5148\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u8bfb\u53d6\u5c5e\u6027\u4fe1\u606f\uff0c\u751f\u6210\u76f8\u5e94\u7684`Bean`\u3002\\n\\n\\n\\n\u9996\u5148\u8bfb\u53d6\u5230\u7684\u914d\u7f6e\u6587\u4ef6\u662f `ShenyuSpringMvcClientConfiguration`\uff0c\u5b83\u662f`shenyu` \u5ba2\u6237\u7aef`http`\u6ce8\u518c\u914d\u7f6e\u7c7b\uff0c\u901a\u8fc7`@Configuration`\u8868\u793a\u8fd9\u662f\u4e00\u4e2a\u914d\u7f6e\u7c7b\uff0c\u901a\u8fc7`@ImportAutoConfiguration`\u5f15\u5165\u5176\u4ed6\u914d\u7f6e\u7c7b\u3002\u521b\u5efa`SpringMvcClientEventListener`\uff0c\u4e3b\u8981\u5904\u7406\u5143\u6570\u636e\u548c `URI` \u4fe1\u606f\u3002\\n\\n```java\\n/**\\n * shenyu \u5ba2\u6237\u7aefhttp\u6ce8\u518c\u914d\u7f6e\u7c7b\\n */\\n@Configuration\\n@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)\\n@ConditionalOnProperty(value = \\"shenyu.register.enabled\\", matchIfMissing = true, havingValue = \\"true\\")\\npublic class ShenyuSpringMvcClientConfiguration {\\n    \\n   // \u521b\u5efaSpringMvcClientEventListener\uff0c\u4e3b\u8981\u5904\u7406\u5143\u6570\u636e\u548cURI\u4fe1\u606f\\n   @Bean\\n   public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,\\n                                                                     final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\\n       return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);\\n   }\\n}\\n\\n```\\n\\n\\n\\n`ShenyuClientCommonBeanConfiguration`\u662f`shenyu`\u5ba2\u6237\u7aef\u901a\u7528\u914d\u7f6e\u7c7b\uff0c\u4f1a\u521b\u5efa\u6ce8\u518c\u4e2d\u5fc3\u5ba2\u6237\u7aef\u901a\u7528\u7684`bean`\u3002\\n\\n- \u521b\u5efa`ShenyuClientRegisterRepository`\uff0c\u901a\u8fc7\u5de5\u5382\u7c7b\u521b\u5efa\u800c\u6210\u3002\\n- \u521b\u5efa`ShenyuRegisterCenterConfig`\uff0c\u8bfb\u53d6`shenyu.register`\u5c5e\u6027\u914d\u7f6e\u3002\\n- \u521b\u5efa`ShenyuClientConfig`\uff0c\u8bfb\u53d6`shenyu.client`\u5c5e\u6027\u914d\u7f6e\u3002\\n\\n```java\\n\\n/**\\n * shenyu\u5ba2\u6237\u7aef\u901a\u7528\u914d\u7f6e\u7c7b\\n */\\n@Configuration\\npublic class ShenyuClientCommonBeanConfiguration {\\n    \\n   // \u521b\u5efaShenyuClientRegisterRepository\uff0c\u901a\u8fc7\u5de5\u5382\u7c7b\u521b\u5efa\u800c\u6210\u3002\\n    @Bean\\n    public ShenyuClientRegisterRepository shenyuClientRegisterRepository(final ShenyuRegisterCenterConfig config) {\\n        return ShenyuClientRegisterRepositoryFactory.newInstance(config);\\n    }\\n    \\n\\t// \u521b\u5efaShenyuRegisterCenterConfig\uff0c\u8bfb\u53d6shenyu.register\u5c5e\u6027\u914d\u7f6e\\n    @Bean\\n    @ConfigurationProperties(prefix = \\"shenyu.register\\")\\n    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {\\n        return new ShenyuRegisterCenterConfig();\\n    }\\n    \\n  // \u521b\u5efaShenyuClientConfig\uff0c\u8bfb\u53d6shenyu.client\u5c5e\u6027\u914d\u7f6e\\n    @Bean\\n    @ConfigurationProperties(prefix = \\"shenyu\\")\\n    public ShenyuClientConfig shenyuClientConfig() {\\n        return new ShenyuClientConfig();\\n    }\\n}\\n\\n```\\n\\n\\n\\n#### 2.2 \u7528\u4e8e\u6ce8\u518c\u7684 HttpClientRegisterRepository\\n\\n\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u751f\u6210\u7684`ShenyuClientRegisterRepository`\u662f\u5ba2\u6237\u7aef\u6ce8\u518c\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u5b83\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b83\u7684\u5b9e\u73b0\u7c7b\u5982\u4e0b\u3002\\n\\n![](/img/activities/code-analysis-http-register/shenyu-client-register-repository.png)\\n\\n- `HttpClientRegisterRepository`\uff1a\u901a\u8fc7`http`\u8fdb\u884c\u6ce8\u518c\uff1b\\n- `ConsulClientRegisterRepository`\uff1a\u901a\u8fc7`Consul`\u8fdb\u884c\u6ce8\u518c\uff1b\\n- `EtcdClientRegisterRepository`\uff1a\u901a\u8fc7`Etcd`\u8fdb\u884c\u6ce8\u518c\uff1b\\n- `NacosClientRegisterRepository`\uff1a\u901a\u8fc7`nacos`\u8fdb\u884c\u6ce8\u518c\uff1b\\n- `ZookeeperClientRegisterRepository`\u901a\u8fc7`Zookeeper`\u8fdb\u884c\u6ce8\u518c\u3002\\n\\n\\n\\n\u5177\u4f53\u662f\u54ea\u4e00\u79cd\u65b9\u5f0f\uff0c\u662f\u901a\u8fc7`SPI`\u8fdb\u884c\u52a0\u8f7d\u5b9e\u73b0\u7684\uff0c\u5b9e\u73b0\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n```java\\n\\n/**\\n * \u52a0\u8f7d ShenyuClientRegisterRepository\\n */\\npublic final class ShenyuClientRegisterRepositoryFactory {\\n    \\n    private static final Map<String, ShenyuClientRegisterRepository> REPOSITORY_MAP = new ConcurrentHashMap<>();\\n    \\n    /**\\n     * \u521b\u5efa ShenyuClientRegisterRepository\\n     */\\n    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {\\n        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {\\n            // \u901a\u8fc7SPI\u7684\u65b9\u5f0f\u8fdb\u884c\u52a0\u8f7d\uff0c\u7c7b\u578b\u7531registerType\u51b3\u5b9a\\n            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());\\n            //\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\\n            result.init(shenyuRegisterCenterConfig);\\n            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());\\n            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);\\n            return result;\\n        }\\n        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());\\n    }\\n}\\n```\\n\\n\\n\\n\u52a0\u8f7d\u7c7b\u578b\u901a\u8fc7`registerType`\u6307\u5b9a\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u7c7b\u578b\uff1a\\n\\n```yaml\\nshenyu:\\n  register:\\n    registerType: http\\n    serverLists: http://localhost:9095\\n```\\n\\n\\n\\n\u6211\u4eec\u6307\u5b9a\u7684\u662f`http`\uff0c\u6240\u4ee5\u4f1a\u53bb\u52a0\u8f7d`HttpClientRegisterRepository`\u3002\u5bf9\u8c61\u521b\u5efa\u6210\u529f\u540e\uff0c\u6267\u884c\u7684\u521d\u59cb\u5316\u65b9\u6cd5`init()`\u5982\u4e0b\uff1a\\n\\n```java\\n@Join\\npublic class HttpClientRegisterRepository implements ShenyuClientRegisterRepository {\\n    \\n    @Override\\n    public void init(final ShenyuRegisterCenterConfig config) {\\n        this.username = config.getProps().getProperty(Constants.USER_NAME);\\n        this.password = config.getProps().getProperty(Constants.PASS_WORD);\\n        this.serverList = Lists.newArrayList(Splitter.on(\\",\\").split(config.getServerLists()));\\n        this.setAccessToken();\\n    }\\n  \\n  // \u6682\u65f6\u7701\u7565\u5176\u4ed6\u903b\u8f91\\n}\\n```\\n\\n\u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684`username`\u3001`password`\u548c`serverLists`\uff0c\u5373`sheenyu-admin`\u7684\u8bbf\u95ee\u8d26\u53f7\u3001\u5bc6\u7801\u548c\u5730\u5740\u4fe1\u606f\uff0c\u4e3a\u540e\u7eed\u6570\u636e\u53d1\u9001\u505a\u51c6\u5907\u3002\u7c7b\u6ce8\u89e3`@Join`\u7528\u4e8e`SPI`\u7684\u52a0\u8f7d\u3002\\n\\n\\n\\n> `SPI` \u5168\u79f0\u4e3a `Service Provider Interface`, \u662f `JDK` \u5185\u7f6e\u7684\u4e00\u79cd\u670d\u52a1\u63d0\u4f9b\u53d1\u73b0\u529f\u80fd, \u4e00\u79cd\u52a8\u6001\u66ff\u6362\u53d1\u73b0\u7684\u673a\u5236\u3002\\n>\\n> [shenyu-spi](https://github.com/apache/incubator-shenyu/tree/master/shenyu-spi) \u662f`Apache ShenYu`\u7f51\u5173\u81ea\u5b9a\u4e49\u7684`SPI`\u6269\u5c55\u5b9e\u73b0\uff0c\u8bbe\u8ba1\u548c\u5b9e\u73b0\u539f\u7406\u53c2\u8003\u4e86`Dubbo`\u7684 [SPI\u6269\u5c55\u5b9e\u73b0](https://dubbo.apache.org/zh/docs/v2.7/dev/impls/) \u3002\\n\\n\\n#### 2.3  \u6784\u5efa \u5143\u6570\u636e \u548c URI\u4fe1\u606f \u7684 SpringMvcClientEventListener\\n\\n\u521b\u5efa `SpringMvcClientEventListener`\uff0c\u8d1f\u8d23\u5ba2\u6237\u7aef `\u5143\u6570\u636e` \u548c `URI` \u6570\u636e\u7684\u6784\u5efa\u548c\u6ce8\u518c\uff0c\u5b83\u7684\u521b\u5efa\u662f\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b8c\u6210\u3002\\n\\n```java\\n@Configuration\\n@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)\\n@ConditionalOnProperty(value = \\"shenyu.register.enabled\\", matchIfMissing = true, havingValue = \\"true\\")\\npublic class ShenyuSpringMvcClientConfiguration {\\n     // ......\\n    \\n    //  \u521b\u5efa SpringMvcClientEventListener\\n    @Bean\\n    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,\\n                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\\n        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);\\n    }\\n}\\n```\\n\\n- `SpringMvcClientEventListener`\u7ee7\u627f\u4e86`AbstractContextRefreshedEventListener`\\n\\n![](/img/activities/code-analysis-http-register/shenyu-client-event-listener.png)\\n\\n`AbstractContextRefreshedEventListener`\u662f\u4e00\u4e2a\u62bd\u8c61\u7c7b\uff0c\u5b83\u5b9e\u73b0\u4e86`ApplicationListener`\u63a5\u53e3\uff0c\u5e76\u91cd\u5199\u4e86`onApplicationEvent()`\u65b9\u6cd5\uff0c\u5f53\u6709Spring\u4e8b\u4ef6\u53d1\u751f\u540e\uff0c\u8be5\u65b9\u6cd5\u4f1a\u6267\u884c\u3002\u5b83\u7684\u5b9e\u73b0\u76ee\u524d\u6709\u516b\u79cd\uff0c\u6bcf\u4e00\u79cd\u8868\u793a\u5bf9\u5e94\u7684RPC\u8c03\u7528\u534f\u8bae\u7684 `\u5143\u6570\u636e` \u548c`URI` \u4fe1\u606f\u7684\u6ce8\u518c\u3002\\n\\n- `AlibabaDubboServiceBeanListener`\uff1a\u5904\u7406\u4f7f\u7528`Alibaba Dubbo`\u534f\u8bae\uff1b\\n- `ApacheDubboServiceBeanListener`\uff1a\u5904\u7406\u4f7f\u7528`Apacge Dubbo`\u534f\u8bae\uff1b\\n- `GrpcClientEventListener`\uff1a\u5904\u7406\u4f7f\u7528`grpc`\u534f\u8bae\uff1b\\n- `MotanServiceEventListener`\uff1a\u5904\u7406\u4f7f\u7528`Mortan`\u534f\u8bae\uff1b\\n- `SofaServiceEventListener`\uff1a\u5904\u7406\u4f7f\u7528`Sofa`\u534f\u8bae\uff1b\\n- `SpringMvcClientEventListener`\uff1a\u5904\u7406\u4f7f\u7528`http`\u534f\u8bae\uff1b\\n- `SpringWebSocketClientEventListener`\uff1a\u5904\u7406\u4f7f\u7528`websocket`\u534f\u8bae\uff1b\\n- `TarsServiceBeanEventListener`\uff1a\u5904\u7406\u4f7f\u7528`Tars`\u6ce8\u518c\u7c7b\u578b\uff1b\\n\\n```java\\n// \u5b9e\u73b0\u4e86ApplicationListener\u63a5\u53e3\\npublic abstract class AbstractContextRefreshedEventListener<T, A extends Annotation> implements ApplicationListener<ContextRefreshedEvent> {\\n\\n     //......\\n\\n    //\u6784\u9020\u51fd\u6570\\n    public AbstractContextRefreshedEventListener(final PropertiesConfig clientConfig,\\n                                                 final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\\n        // \u8bfb\u53d6 shenyu.client.http \u914d\u7f6e\u4fe1\u606f\\n        Properties props = clientConfig.getProps();\\n        // appName \u5e94\u7528\u540d\u79f0\\n        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);\\n        // contextPath\u4e0a\u4e0b\u6587\u8def\u5f84\\n        this.contextPath = Optional.ofNullable(props.getProperty(ShenyuClientConstants.CONTEXT_PATH)).map(UriUtils::repairData).orElse(\\"\\");\\n        if (StringUtils.isBlank(appName) && StringUtils.isBlank(contextPath)) {\\n            String errorMsg = \\"client register param must config the appName or contextPath\\";\\n            LOG.error(errorMsg);\\n            throw new ShenyuClientIllegalArgumentException(errorMsg);\\n        }\\n        this.ipAndPort = props.getProperty(ShenyuClientConstants.IP_PORT);\\n        // host\u4fe1\u606f\\n        this.host = props.getProperty(ShenyuClientConstants.HOST);\\n        // port \u5ba2\u6237\u7aef\u7aef\u53e3\u4fe1\u606f\\n        this.port = props.getProperty(ShenyuClientConstants.PORT);\\n        // \u5f00\u59cb\u4e8b\u4ef6\u53d1\u5e03\\n        publisher.start(shenyuClientRegisterRepository);\\n    }\\n\\n    // \u5f53\u6709\u4e0a\u4e0b\u6587\u5237\u65b0\u4e8b\u4ef6ContextRefreshedEvent\u53d1\u751f\u65f6\uff0c\u8be5\u65b9\u6cd5\u4f1a\u6267\u884c\\n    @Override\\n    public void onApplicationEvent(@NonNull final ContextRefreshedEvent event) {\\n        //\u4fdd\u8bc1\u8be5\u65b9\u6cd5\u7684\u5185\u5bb9\u53ea\u6267\u884c\u4e00\u6b21\\n        if (!registered.compareAndSet(false, true)) {\\n            return;\\n        }\\n        final ApplicationContext context = event.getApplicationContext();\\n        // \u83b7\u53d6\u58f0\u660eRPC\u8c03\u7528\u7684\u7c7b\\n        Map<String, T> beans = getBeans(context);\\n        if (MapUtils.isEmpty(beans)) {\\n            return;\\n        }\\n        // \u6784\u5efaURI\u6570\u636e\u5e76\u6ce8\u518c\\n        publisher.publishEvent(buildURIRegisterDTO(context, beans));\\n        // \u6784\u5efa\u5143\u6570\u636e\u5e76\u6ce8\u518c\\n        beans.forEach(this::handle);\\n    }\\n\\n    // \u4ea4\u7ed9\u4e0d\u540c\u7684\u5b50\u7c7b\u5b9e\u73b0\\n    @SuppressWarnings(\\"all\\")\\n    protected abstract URIRegisterDTO buildURIRegisterDTO(ApplicationContext context,\\n                                                          Map<String, T> beans);\\n    \\n    \\n    protected void handle(final String beanName, final T bean) {\\n        Class<?> clazz = getCorrectedClass(bean);\\n        // \u83b7\u53d6\u5f53\u524dbean\u7684\u5bf9\u5e94shenyu\u5ba2\u6237\u7aef\u7684\u6ce8\u89e3\uff08\u5bf9\u5e94\u4e0d\u540c\u7684RPC\u8c03\u7528\u6ce8\u89e3\u4e0d\u4e00\u6837\uff0c\u50cfhttp\u7684\u5c31\u662f@ShenyuSpringMvcClient,\u800c\u50cfSpringCloud\u7684\u5219\u662f@ShenyuSpringCloudClient\uff09\\n        final A beanShenyuClient = AnnotatedElementUtils.findMergedAnnotation(clazz, getAnnotationType());\\n        // \u6839\u636ebean\u83b7\u53d6\u5bf9\u5e94\u7684path\uff08\u4e0d\u540c\u5b50\u7c7b\u5b9e\u73b0\u4e0d\u4e00\u6837\uff09\\n        final String superPath = buildApiSuperPath(clazz, beanShenyuClient);\\n        // \u5982\u679c\u5305\u542bShenyu\u5ba2\u6237\u7aef\u6ce8\u89e3\u6216\u8005path\u4e2d\u5305\u62ec\'*\'\uff0c\u8868\u793a\u6ce8\u518c\u6574\u4e2a\u7c7b\u7684\u63a5\u53e3\\n        if (Objects.nonNull(beanShenyuClient) && superPath.contains(\\"*\\")) {\\n            // \u6784\u5efa\u7c7b\u7684\u5143\u6570\u636e\uff0c\u53d1\u9001\u6ce8\u518c\u4e8b\u4ef6\\n            handleClass(clazz, bean, beanShenyuClient, superPath);\\n            return;\\n        }\\n        // \u83b7\u53d6\u5f53\u524dbean\u7684\u6240\u6709\u65b9\u6cd5\\n        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);\\n        // \u904d\u5386\u65b9\u6cd5\\n        for (Method method : methods) {\\n            // \u6ce8\u518c\u7b26\u5408\u6761\u4ef6\u7684\u65b9\u6cd5\\n            handleMethod(bean, clazz, beanShenyuClient, method, superPath);\\n        }\\n    }\\n\\n    // \u6784\u5efa\u7c7b\u5143\u6570\u636e\u5e76\u6ce8\u518c\u7684\u9ed8\u8ba4\u5b9e\u73b0\\n    protected void handleClass(final Class<?> clazz,\\n                               final T bean,\\n                               @NonNull final A beanShenyuClient,\\n                               final String superPath) {\\n        publisher.publishEvent(buildMetaDataDTO(bean, beanShenyuClient, pathJoin(contextPath, superPath), clazz, null));\\n    }\\n\\n    // \u6784\u5efa\u65b9\u6cd5\u5143\u6570\u636e\u5e76\u6ce8\u518c\u7684\u9ed8\u8ba4\u5b9e\u73b0\\n    protected void handleMethod(final T bean,\\n                                final Class<?> clazz,\\n                                @Nullable final A beanShenyuClient,\\n                                final Method method,\\n                                final String superPath) {\\n        // \u5982\u679c\u65b9\u6cd5\u4e0a\u6709Shenyu\u5ba2\u6237\u7aef\u6ce8\u89e3\uff0c\u5c31\u8868\u793a\u8be5\u65b9\u6cd5\u9700\u8981\u6ce8\u518c\\n        A methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, getAnnotationType());\\n        if (Objects.nonNull(methodShenyuClient)) {\\n            // \u6784\u5efa\u5143\u6570\u636e\uff0c\u53d1\u9001\u6ce8\u518c\u4e8b\u4ef6\\n            publisher.publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));\\n        }\\n    }\\n\\n    // \u4ea4\u7ed9\u4e0d\u540c\u5b50\u7c7b\u5b9e\u73b0\\n    protected abstract MetaDataRegisterDTO buildMetaDataDTO(T bean,\\n                                                            @NonNull A shenyuClient,\\n                                                            String path,\\n                                                            Class<?> clazz,\\n                                                            Method method);\\n}\\n\\n```\\n\\n\u5728\u6784\u9020\u51fd\u6570\u4e2d\u4e3b\u8981\u662f\u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\u3002\\n\\n```yaml\\nshenyu:\\n  client:\\n    http:\\n      props:\\n        contextPath: /http\\n        appName: http\\n        port: 8189\\n        isFull: false\\n```\\n\\n\u6700\u540e\uff0c\u6267\u884c\u4e86`publisher.start()`\uff0c\u5f00\u59cb\u4e8b\u4ef6\u53d1\u5e03\uff0c\u4e3a\u6ce8\u518c\u505a\u51c6\u5907\u3002\\n\\n- ShenyuClientRegisterEventPublisher\\n\\n`ShenyuClientRegisterEventPublisher`\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\uff0c\u4e3b\u8981\u662f\u751f\u6210\u5143\u6570\u636e\u548c`URI`\u8ba2\u9605\u5668\uff08\u540e\u7eed\u7528\u4e8e\u6570\u636e\u53d1\u5e03\uff09\uff0c\u7136\u540e\u542f\u52a8`Disruptor`\u961f\u5217\u3002\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5171\u6709\u65b9\u6cd5`publishEvent()`\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u5411Disruptor\u961f\u5217\u53d1\u6570\u636e\u3002\\n\\n```java\\n\\npublic class ShenyuClientRegisterEventPublisher {\\n    // \u79c1\u6709\u53d8\u91cf\\n    private static final ShenyuClientRegisterEventPublisher INSTANCE = new ShenyuClientRegisterEventPublisher();\\n\\n    private DisruptorProviderManage<DataTypeParent> providerManage;\\n    \\n    /**\\n     * \u516c\u5f00\u9759\u6001\u65b9\u6cd5\\n     *\\n     * @return ShenyuClientRegisterEventPublisher instance\\n     */\\n    public static ShenyuClientRegisterEventPublisher getInstance() {\\n        return INSTANCE;\\n    }\\n    \\n    /**\\n     * Start\u65b9\u6cd5\u6267\u884c\\n     *\\n     * @param shenyuClientRegisterRepository shenyuClientRegisterRepository\\n     */\\n    public void start(final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\\n        // \u521b\u5efa\u5ba2\u6237\u7aef\u6ce8\u518c\u5de5\u5382\u7c7b\\n        RegisterClientExecutorFactory factory = new RegisterClientExecutorFactory();\\n        // \u6dfb\u52a0\u5143\u6570\u636e\u8ba2\u9605\u5668\\n        factory.addSubscribers(new ShenyuClientMetadataExecutorSubscriber(shenyuClientRegisterRepository));\\n        //  \u6dfb\u52a0URI\u8ba2\u9605\u5668\\n        factory.addSubscribers(new ShenyuClientURIExecutorSubscriber(shenyuClientRegisterRepository));\\n        // \u542f\u52a8Disruptor\u961f\u5217\\n        providerManage = new DisruptorProviderManage(factory);\\n        providerManage.startup();\\n    }\\n    \\n    /**\\n     * \u53d1\u5e03\u4e8b\u4ef6\uff0c\u5411Disruptor\u961f\u5217\u53d1\u6570\u636e\\n     *\\n     * @param data the data\\n     */\\n    public <T> void publishEvent(final DataTypeParent data) {\\n        DisruptorProvider<DataTypeParent> provider = providerManage.getProvider();\\n        provider.onData(data);\\n    }\\n}\\n```\\n\\n`AbstractContextRefreshedEventListener`\u7684\u6784\u9020\u51fd\u6570\u903b\u8f91\u5206\u6790\u5b8c\u6210\u4e86\uff0c\u4e3b\u8981\u662f\u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\uff0c\u521b\u5efa`\u5143\u6570\u636e`\u548c`URI`\u8ba2\u9605\u5668\uff0c\u542f\u52a8`Disruptor`\u961f\u5217\u3002\\n\\n`onApplicationEvent()`\u65b9\u6cd5\u662f\u6709`Spring`\u4e8b\u4ef6\u53d1\u751f\u65f6\u4f1a\u6267\u884c\uff0c\u8fd9\u91cc\u7684\u53c2\u6570\u662f`ContextRefreshedEvent`\uff0c\u8868\u793a\u4e0a\u4e0b\u6587\u5237\u65b0\u4e8b\u4ef6\u3002\u5f53`Spring`\u5bb9\u5668\u5c31\u7eea\u540e\u6267\u884c\u6b64\u5904\u903b\u8f91\uff1a\u5148\u6784\u5efa`URI`\u6570\u636e\u5e76\u6ce8\u518c\uff0c\u518d\u6784\u5efa\u5143\u6570\u636e\u5e76\u6ce8\u518c\uff0c\\n\\n\\n\\n> `ContextRefreshedEvent`\u662f`Spring`\u5185\u7f6e\u4e8b\u4ef6\u3002`ApplicationContext`\u88ab\u521d\u59cb\u5316\u6216\u5237\u65b0\u65f6\uff0c\u8be5\u4e8b\u4ef6\u88ab\u89e6\u53d1\u3002\u8fd9\u4e5f\u53ef\u4ee5\u5728 `ConfigurableApplicationContext`\u63a5\u53e3\u4e2d\u4f7f\u7528 `refresh()` \u65b9\u6cd5\u6765\u53d1\u751f\u3002\u6b64\u5904\u7684\u521d\u59cb\u5316\u662f\u6307\uff1a\u6240\u6709\u7684`Bean`\u88ab\u6210\u529f\u88c5\u8f7d\uff0c\u540e\u5904\u7406`Bean`\u88ab\u68c0\u6d4b\u5e76\u6fc0\u6d3b\uff0c\u6240\u6709`Singleton Bean` \u88ab\u9884\u5b9e\u4f8b\u5316\uff0c`ApplicationContext`\u5bb9\u5668\u5df2\u5c31\u7eea\u53ef\u7528\u3002\\n\\n\u518d\u6765\u770b`AbstractContextRefreshedEventListener`\u7684http\u5b9e\u73b0`SpringMvcClientEventListener`\u3002\\n\\n```java\\npublic class SpringMvcClientEventListener extends AbstractContextRefreshedEventListener<Object, ShenyuSpringMvcClient> {\\n    \\n    private final List<Class<? extends Annotation>> mappingAnnotation = new ArrayList<>(3);\\n    \\n    private final Boolean isFull;\\n    \\n    private final String protocol;\\n    \\n    // \u6784\u9020\u51fd\u6570\\n    public SpringMvcClientEventListener(final PropertiesConfig clientConfig,\\n                                        final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {\\n        super(clientConfig, shenyuClientRegisterRepository);\\n        Properties props = clientConfig.getProps();\\n        // \u83b7\u53d6 isFull\\n        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));\\n        // \u8868\u793a\u662fhttp\u534f\u8bae\u7684\u5b9e\u73b0\\n        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);\\n        mappingAnnotation.add(ShenyuSpringMvcClient.class);\\n        mappingAnnotation.add(RequestMapping.class);\\n    }\\n    \\n    @Override\\n    protected Map<String, Object> getBeans(final ApplicationContext context) {\\n        // \u914d\u7f6e\u5c5e\u6027\uff0c\u5982\u679c isFull=true \u7684\u8bdd\uff0c\u8868\u793a\u6ce8\u518c\u6574\u4e2a\u5fae\u670d\u52a1\\n        if (Boolean.TRUE.equals(isFull)) {\\n            getPublisher().publishEvent(MetaDataRegisterDTO.builder()\\n                    .contextPath(getContextPath())\\n                    .appName(getAppName())\\n                    .path(PathUtils.decoratorPathWithSlash(getContextPath()))\\n                    .rpcType(RpcTypeEnum.HTTP.getName())\\n                    .enabled(true)\\n                    .ruleName(getContextPath())\\n                    .build());\\n            return null;\\n        }\\n        // \u5426\u5219\u83b7\u53d6\u5e26Controller\u6ce8\u89e3\u7684bean\\n        return context.getBeansWithAnnotation(Controller.class);\\n    }\\n    \\n    // \u6784\u9020URI\u6570\u636e\\n    @Override\\n    protected URIRegisterDTO buildURIRegisterDTO(final ApplicationContext context,\\n                                                 final Map<String, Object> beans) {\\n        // ...\\n    }\\n    \\n    @Override\\n    protected String buildApiSuperPath(final Class<?> clazz, @Nullable final ShenyuSpringMvcClient beanShenyuClient) {\\n        // \u5982\u679c\u6709\u5e26\u4e0aShenyu\u5ba2\u6237\u7aef\u6ce8\u89e3\uff0c\u5219\u4f18\u5148\u53d6\u6ce8\u89e3\u4e2d\u7684\u4e0d\u4e3a\u7a7a\u7684path\u5c5e\u6027\\n        if (Objects.nonNull(beanShenyuClient) && StringUtils.isNotBlank(beanShenyuClient.path())) {\\n            return beanShenyuClient.path();\\n        }\\n        // \u5982\u679c\u6709\u5e26\u4e0aRequestMapping\u6ce8\u89e3\uff0c\u4e14path\u5c5e\u6027\u4e0d\u4e3a\u7a7a\uff0c\u5219\u8fd4\u56depath\u6570\u7ec4\u7684\u7b2c\u4e00\u4e2a\u503c\\n        RequestMapping requestMapping = AnnotationUtils.findAnnotation(clazz, RequestMapping.class);\\n        if (Objects.nonNull(requestMapping) && ArrayUtils.isNotEmpty(requestMapping.path()) && StringUtils.isNotBlank(requestMapping.path()[0])) {\\n            return requestMapping.path()[0];\\n        }\\n        return \\"\\";\\n    }\\n    \\n    // \u58f0\u660ehttp\u5b9e\u73b0\u7684\u5ba2\u6237\u7aef\u6ce8\u89e3\u662fShenyuSpringMvcClient\\n    @Override\\n    protected Class<ShenyuSpringMvcClient> getAnnotationType() {\\n        return ShenyuSpringMvcClient.class;\\n    }\\n    \\n    @Override\\n    protected void handleMethod(final Object bean, final Class<?> clazz,\\n                                @Nullable final ShenyuSpringMvcClient beanShenyuClient,\\n                                final Method method, final String superPath) {\\n        // \u83b7\u53d6\u5f53\u524dbean\u7684RequestMapping\u6ce8\u89e3\\n        final RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);\\n        // \u83b7\u53d6\u5f53\u524dbean\u7684 ShenyuSpringMvcClient \u6ce8\u89e3\\n        ShenyuSpringMvcClient methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, ShenyuSpringMvcClient.class);\\n        methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;\\n        //\u5982\u679c\u6709 ShenyuSpringMvcClient \u6ce8\u89e3\u5e76\u4e14\u5305\u542bRequestMapping\u6ce8\u89e3\uff08\u8868\u793a\u662f\u4e00\u4e2a\u63a5\u53e3\uff09\uff0c\u5219\u8fdb\u884c\u6ce8\u518c\\n        if (Objects.nonNull(methodShenyuClient) && Objects.nonNull(requestMapping)) {\\n            getPublisher().publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));\\n        }\\n    }\\n    \\n    //...\\n    \\n    // \u6784\u9020\u5143\u6570\u636e\\n    @Override\\n    protected MetaDataRegisterDTO buildMetaDataDTO(final Object bean,\\n                                                   @NonNull final ShenyuSpringMvcClient shenyuClient,\\n                                                   final String path, final Class<?> clazz,\\n                                                   final Method method) {\\n        //...\\n    }\\n}\\n```\\n\\n\\n\u6ce8\u518c\u903b\u8f91\u90fd\u662f\u901a\u8fc7 `publisher.publishEvent()`\u5b8c\u6210\u3002\\n\\n`Controller`\u6ce8\u89e3\u548c`RequestMapping`\u6ce8\u89e3\u662f\u7531`Spring`\u63d0\u4f9b\u7684\uff0c\u8fd9\u4e2a\u5927\u5bb6\u5e94\u8be5\u5f88\u719f\u6089\uff0c\u4e0d\u8fc7\u591a\u8d58\u8ff0\u3002`ShenyuSpringMvcClient` \u6ce8\u89e3\u662f\u7531`Apache ShenYu`\u63d0\u4f9b\u7684\uff0c\u7528\u4e8e\u6ce8\u518c`SpringMvc`\u5ba2\u6237\u7aef\uff0c\u5b83\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a\\n\\n```java\\n\\n/**\\n * shenyu \u5ba2\u6237\u7aef\u63a5\u53e3\uff0c\u7528\u4e8e\u65b9\u6cd5\u4e0a\u6216\u7c7b\u4e0a\\n */\\n@Retention(RetentionPolicy.RUNTIME)\\n@Target({ElementType.TYPE, ElementType.METHOD})\\npublic @interface ShenyuSpringMvcClient {\\n\\n    // path \u6ce8\u518c\u8def\u5f84\\n    @AliasFor(attribute = \\"path\\")\\n    String value() default \\"\\";\\n    \\n    // path \u6ce8\u518c\u8def\u5f84\\n    @AliasFor(attribute = \\"value\\")\\n    String path();\\n    \\n    // ruleName \u89c4\u5219\u540d\u79f0\\n    String ruleName() default \\"\\";\\n    \\n    // desc \u63cf\u8ff0\u4fe1\u606f\\n    String desc() default \\"\\";\\n\\n    // enabled\u662f\u5426\u542f\u7528\\n    boolean enabled() default true;\\n    \\n    // registerMetaData \u6ce8\u518c\u5143\u6570\u636e\\n    boolean  registerMetaData() default false;\\n}\\n\\n```\\n\\n\u5b83\u7684\u4f7f\u7528\u5982\u4e0b\uff1a\\n\\n- \u6ce8\u518c\u6574\u4e2a\u63a5\u53e3\\n\\n```java\\n@RestController\\n@RequestMapping(\\"/test\\")\\n@ShenyuSpringMvcClient(path = \\"/test/**\\")  // \u8868\u793a\u6574\u4e2a\u63a5\u53e3\u6ce8\u518c\\npublic class HttpTestController {\\n //......\\n}\\n```\\n\\n- \u6ce8\u518c\u5f53\u524d\u65b9\u6cd5\\n\\n```java\\n@RestController\\n@RequestMapping(\\"/order\\")\\n@ShenyuSpringMvcClient(path = \\"/order\\")\\npublic class OrderController {\\n\\n    /**\\n     * Save order dto.\\n     *\\n     * @param orderDTO the order dto\\n     * @return the order dto\\n     */\\n    @PostMapping(\\"/save\\")\\n    @ShenyuSpringMvcClient(path = \\"/save\\", desc = \\"Save order\\") // \u6ce8\u518c\u5f53\u524d\u65b9\u6cd5\\n    public OrderDTO save(@RequestBody final OrderDTO orderDTO) {\\n        orderDTO.setName(\\"hello world save order\\");\\n        return orderDTO;\\n    }\\n}\\n```\\n\\n\\n\\n- publisher.publishEvent() \u53d1\u5e03\u6ce8\u518c\u4e8b\u4ef6\\n\\n\u8be5\u65b9\u6cd5\u4f1a\u5c06\u6570\u636e\u53d1\u9001\u5230`Disruptor`\u961f\u5217\u4e2d\uff0c\u5173\u4e8e`Disruptor`\u961f\u5217\u66f4\u591a\u7ec6\u8282\u8fd9\u91cc\u4e0d\u505a\u66f4\u591a\u4ecb\u7ecd\uff0c\u8fd9\u4e0d\u5f71\u54cd\u5206\u6790\u6ce8\u518c\u7684\u6d41\u7a0b\u3002\\n\\n\u5f53\u6570\u636e\u53d1\u9001\u540e\uff0c`Disruptor`\u961f\u5217\u7684\u6d88\u8d39\u8005\u4f1a\u5904\u7406\u6570\u636e\uff0c\u8fdb\u884c\u6d88\u8d39\u3002\\n\\n\\n\\n- QueueConsumer \u6d88\u8d39\u6570\u636e\\n\\n`QueueConsumer`\u662f\u4e00\u4e2a\u6d88\u8d39\u8005\uff0c\u5b83\u5b9e\u73b0\u4e86`WorkHandler`\u63a5\u53e3\uff0c\u5b83\u7684\u521b\u5efa\u8fc7\u7a0b\u5728`providerManage.startup()`\u903b\u8f91\u4e2d\u3002`WorkHandler`\u63a5\u53e3\u662f`disruptor`\u7684\u6570\u636e\u6d88\u8d39\u63a5\u53e3\uff0c\u53ea\u6709\u4e00\u4e2a\u65b9\u6cd5\u662f`onEvent()`\u3002\\n\\n```java\\npackage com.lmax.disruptor;\\n\\npublic interface WorkHandler<T> {\\n    void onEvent(T event) throws Exception;\\n}\\n```\\n\\n`QueueConsumer`\u91cd\u5199\u4e86`onEvent()`\u65b9\u6cd5\uff0c\u4e3b\u8981\u903b\u8f91\u662f\u751f\u6210\u6d88\u8d39\u4efb\u52a1\uff0c\u7136\u540e\u5728\u7ebf\u7a0b\u6c60\u4e2d\u53bb\u6267\u884c\u3002\\n\\n```java\\n\\n/**\\n * \\n * \u961f\u5217\u6d88\u8d39\u8005\\n */\\npublic class QueueConsumer<T> implements WorkHandler<DataEvent<T>> {\\n    \\n\\t// \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n\\n    @Override\\n    public void onEvent(final DataEvent<T> t) {\\n        if (t != null) {\\n            // \u6839\u636e\u4e8b\u4ef6\u7c7b\u578b\u4f7f\u7528\u4e0d\u540c\u7684\u7ebf\u7a0b\u6c60\\n            ThreadPoolExecutor executor = orderly(t);\\n            // \u901a\u8fc7\u5de5\u5382\u521b\u5efa\u961f\u5217\u6d88\u8d39\u4efb\u52a1\\n            QueueConsumerExecutor<T> queueConsumerExecutor = factory.create();\\n            // \u4fdd\u5b58\u6570\u636e\\n            queueConsumerExecutor.setData(t.getData());\\n            // help gc\\n            t.setData(null);\\n            // \u653e\u5728\u7ebf\u7a0b\u6c60\u4e2d\u6267\u884c \u6d88\u8d39\u4efb\u52a1\\n            executor.execute(queueConsumerExecutor);\\n        }\\n    }\\n}\\n```\\n\\n`QueueConsumerExecutor`\u662f\u5728\u7ebf\u7a0b\u6c60\u4e2d\u88ab\u6267\u884c\u7684\u4efb\u52a1\uff0c\u5b83\u5b9e\u73b0\u4e86`Runnable`\u63a5\u53e3\uff0c\u5177\u4f53\u7684\u5b9e\u73b0\u7c7b\u6709\u4e24\u4e2a\uff1a\\n\\n- `RegisterClientConsumerExecutor`\uff1a\u5ba2\u6237\u7aef\u6d88\u8d39\u8005\u6267\u884c\u5668\uff1b\\n- `RegisterServerConsumerExecutor`\uff1a\u670d\u52a1\u7aef\u6d88\u8d39\u8005\u6267\u884c\u5668\u3002\\n\\n\u987e\u540d\u601d\u4e49\uff0c\u4e00\u4e2a\u8d1f\u8d23\u5904\u7406\u5ba2\u6237\u7aef\u4efb\u52a1\uff0c\u4e00\u4e2a\u8d1f\u8d23\u5904\u7406\u670d\u52a1\u7aef\u4efb\u52a1\uff08\u670d\u52a1\u7aef\u5c31\u662f`admin`\uff0c\u5728\u4e0b\u6587\u8fdb\u884c\u5206\u6790\uff09\u3002\\n\\n![](/img/activities/code-analysis-http-register/consumer-executor.png)\\n\\n\\n\\n- RegisterClientConsumerExecutor \u6d88\u8d39\u8005\u6267\u884c\u5668\\n\\n\u91cd\u5199\u7684`run()`\u903b\u8f91\u5982\u4e0b\uff1a\\n\\n```java\\n\\npublic final class RegisterClientConsumerExecutor<T extends DataTypeParent> extends QueueConsumerExecutor<T> {\\n    \\n\\t//...... \\n\\n    @Override\\n    public void run() {\\n        // \u83b7\u53d6\u6570\u636e\\n        final T data = getData();\\n        // \u6839\u636e\u6570\u636e\u7c7b\u578b\u8c03\u7528\u76f8\u5e94\u7684\u5904\u7406\u5668\u8fdb\u884c\u5904\u7406\\n        subscribers.get(data.getType()).executor(Lists.newArrayList(data));\\n    }\\n    \\n}\\n```\\n\\n\u6839\u636e\u4e0d\u540c\u7684\u6570\u636e\u7c7b\u578b\u8c03\u7528\u4e0d\u540c\u7684\u5904\u7406\u5668\u53bb\u6267\u884c\u76f8\u5e94\u7684\u4efb\u52a1\u3002\u6570\u636e\u7c7b\u578b\u6709\u4e24\u79cd\uff0c\u4e00\u4e2a\u662f\u5143\u6570\u636e\uff0c\u8bb0\u5f55\u5ba2\u6237\u7aef\u6ce8\u518c\u4fe1\u606f\u3002\u4e00\u4e2a\u662f`URI`\u6570\u636e\uff0c\u8bb0\u5f55\u5ba2\u6237\u7aef\u670d\u52a1\u4fe1\u606f\u3002\\n\\n```java\\n//\u6570\u636e\u7c7b\u578b\\npublic enum DataType {\\n   // \u5143\u6570\u636e\\n    META_DATA,\\n    \\n   // URI\u6570\u636e\\n    URI,\\n}\\n```\\n\\n\\n\\n- ExecutorSubscriber#executor() \u6267\u884c\u5668\u8ba2\u9605\u8005\\n\\n\u6267\u884c\u5668\u8ba2\u9605\u8005\u4e5f\u5206\u4e3a\u4e24\u7c7b\uff0c\u4e00\u4e2a\u662f\u5904\u7406\u5143\u6570\u636e\uff0c\u4e00\u4e2a\u662f\u5904\u7406`URI`\u3002\u5728\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u5206\u522b\u6709\u4e24\u4e2a\uff0c\u6240\u4ee5\u4e00\u5171\u662f\u56db\u4e2a\u3002\\n\\n![](/img/activities/code-analysis-http-register/executor-subscriber.png)\\n\\n\\n\u5148\u770b\u5143\u6570\u636e\u5904\u7406\\n\\n\\n- ShenyuClientMetadataExecutorSubscriber#executor()\\n\\n\u5ba2\u6237\u7aef\u8fd9\u8fb9\u5bf9\u5143\u6570\u636e\u5904\u7406\u903b\u8f91\u662f\uff1a\u904d\u5386\u5143\u6570\u636e\u4fe1\u606f\uff0c\u8c03\u7528\u63a5\u53e3\u65b9\u6cd5`persistInterface()`\u5b8c\u6210\u6570\u636e\u7684\u53d1\u5e03\u3002\\n\\n```java\\npublic class ShenyuClientMetadataExecutorSubscriber implements ExecutorTypeSubscriber<MetaDataRegisterDTO> {\\n   \\n    //......\\n    \\n    @Override\\n    public DataType getType() {\\n        return DataType.META_DATA; // \u5143\u6570\u636e\\n    }\\n    \\n    @Override\\n    public void executor(final Collection<MetaDataRegisterDTO> metaDataRegisterDTOList) {\\n        for (MetaDataRegisterDTO metaDataRegisterDTO : metaDataRegisterDTOList) {\\n            // \u8c03\u7528\u63a5\u53e3\u65b9\u6cd5persistInterface()\u5b8c\u6210\u6570\u636e\u7684\u53d1\u5e03\\n            shenyuClientRegisterRepository.persistInterface(metaDataRegisterDTO);\\n        }\\n    }\\n}\\n```\\n\\n\\n\\n- ShenyuClientRegisterRepository#persistInterface()\\n\\n`ShenyuClientRegisterRepository`\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u7528\u4e8e\u8868\u793a\u5ba2\u6237\u7aef\u6570\u636e\u6ce8\u518c\uff0c\u5b83\u7684\u5b9e\u73b0\u7c7b\u76ee\u524d\u6709\u4e94\u79cd\uff0c\u6bcf\u4e00\u79cd\u5c31\u8868\u793a\u4e00\u79cd\u6ce8\u518c\u65b9\u6cd5\u3002\\n\\n- `ConsulClientRegisterRepository`\uff1a\u901a\u8fc7`Consul`\u5b9e\u73b0\u5ba2\u6237\u7aef\u6ce8\u518c\uff1b\\n- `EtcdClientRegisterRepository`\uff1a\u901a\u8fc7`Etcd`\u5b9e\u73b0\u5ba2\u6237\u7aef\u6ce8\u518c\uff1b\\n- `HttpClientRegisterRepository`\uff1a\u901a\u8fc7`Http`\u5b9e\u73b0\u5ba2\u6237\u7aef\u6ce8\u518c\uff1b\\n- `NacosClientRegisterRepository`\uff1a\u901a\u8fc7`Nacos`\u5b9e\u73b0\u5ba2\u6237\u7aef\u6ce8\u518c\uff1b\\n- `ZookeeperClientRegisterRepository`\uff1a\u901a\u8fc7`Zookeeper`\u5b9e\u73b0\u5ba2\u6237\u7aef\u6ce8\u518c\uff1b\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/client-register-repository.png)\\n\\n\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c\u6ce8\u518c\u4e2d\u5fc3\u7684\u52a0\u8f7d\u662f\u901a\u8fc7`SPI`\u7684\u65b9\u5f0f\u5b8c\u6210\u7684\u3002\u8fd9\u4e2a\u5728\u524d\u9762\u63d0\u5230\u8fc7\u4e86\uff0c\u5728\u5ba2\u6237\u7aef\u901a\u7528\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u901a\u8fc7\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5c5e\u6027\u5b8c\u6210\u5177\u4f53\u7684\u7c7b\u52a0\u8f7d\u3002\\n\\n```java\\n\\n/**\\n * \u52a0\u8f7d ShenyuClientRegisterRepository\\n */\\npublic final class ShenyuClientRegisterRepositoryFactory {\\n    \\n    private static final Map<String, ShenyuClientRegisterRepository> REPOSITORY_MAP = new ConcurrentHashMap<>();\\n    \\n    /**\\n     * \u521b\u5efa ShenyuClientRegisterRepository\\n     */\\n    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {\\n        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {\\n            // \u901a\u8fc7SPI\u7684\u65b9\u5f0f\u8fdb\u884c\u52a0\u8f7d\uff0c\u7c7b\u578b\u7531registerType\u51b3\u5b9a\\n            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());\\n            //\u6267\u884c\u521d\u59cb\u5316\u64cd\u4f5c\\n            result.init(shenyuRegisterCenterConfig);\\n            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());\\n            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);\\n            return result;\\n        }\\n        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());\\n    }\\n}\\n```\\n\\n\\n\\n\u672c\u6587\u7684\u6e90\u7801\u5206\u6790\u662f\u57fa\u4e8e`Http`\u7684\u65b9\u5f0f\u8fdb\u884c\u6ce8\u518c\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u5206\u6790`HttpClientRegisterRepository`\uff0c\u5176\u4ed6\u7684\u6ce8\u518c\u65b9\u5f0f\u540e\u7eed\u518d\u5206\u6790\u3002`HttpClientRegisterRepository`\u7ee7\u627f\u4e86`FailbackRegistryRepository`\uff0c\u800c`FailbackRegistryRepository`\u672c\u8eab\u4e3b\u8981\u7528\u4e8e\u5bf9`Http`\u6ce8\u518c\u8fc7\u7a0b\u4e2d\u7684\u5931\u8d25\u5f02\u5e38\u7684\u5904\u7406\uff0c\u8fd9\u91cc\u5c31\u7701\u7565\u4e86\u3002\\n\\n\\n\\n\u901a\u8fc7`http`\u7684\u65b9\u5f0f\u6ce8\u518c\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u8c03\u7528\u5de5\u5177\u7c7b\u53d1\u9001`http`\u8bf7\u6c42\u3002\u6ce8\u518c\u5143\u6570\u636e\u548cURI\u90fd\u662f\u8c03\u7528\u7684\u540c\u4e00\u4e2a\u65b9\u6cd5`doRegister()`\uff0c\u6307\u5b9a\u63a5\u53e3\u548c\u7c7b\u578b\u5c31\u597d\u3002\\n\\n- `Constants.URI_PATH`\u7684\u503c`/shenyu-client/register-metadata`\uff1a\u670d\u52a1\u7aef\u63d0\u4f9b\u7684\u63a5\u53e3\u7528\u4e8e\u6ce8\u518c\u5143\u6570\u636e\u3002\\n- `Constants.META_PATH`\u7684\u503c`/shenyu-client/register-uri`\uff1a    \u670d\u52a1\u7aef\u63d0\u4f9b\u7684\u63a5\u53e3\u7528\u4e8e\u6ce8\u518cURI\u3002\\n\\n```java\\n@Join\\npublic class HttpClientRegisterRepository extends FailbackRegistryRepository {\\n\\n    private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientRegisterRepository.class);\\n\\n    private static URIRegisterDTO uriRegisterDTO;\\n\\n    private String username;\\n\\n    private String password;\\n\\n    private List<String> serverList;\\n\\n    private String accessToken;\\n    \\n    public HttpClientRegisterRepository() {\\n    }\\n    \\n    public HttpClientRegisterRepository(final ShenyuRegisterCenterConfig config) {\\n        init(config);\\n    }\\n\\n    @Override\\n    public void init(final ShenyuRegisterCenterConfig config) {\\n        // admin\u7684\u7528\u6237\u540d\\n        this.username = config.getProps().getProperty(Constants.USER_NAME);\\n        // admin\u7684\u7528\u6237\u540d\u5bf9\u5e94\u7684\u5bc6\u7801\\n        this.password = config.getProps().getProperty(Constants.PASS_WORD);\\n        // admin\u670d\u52a1\u5217\u8868\\n        this.serverList = Lists.newArrayList(Splitter.on(\\",\\").split(config.getServerLists()));\\n        // \u8bbe\u7f6e\u8bbf\u95ee\u7684token\\n        this.setAccessToken();\\n    }\\n\\n    /**\\n     * Persist uri.\\n     *\\n     * @param registerDTO the register dto\\n     */\\n    @Override\\n    public void doPersistURI(final URIRegisterDTO registerDTO) {\\n        if (RuntimeUtils.listenByOther(registerDTO.getPort())) {\\n            return;\\n        }\\n        doRegister(registerDTO, Constants.URI_PATH, Constants.URI);\\n        uriRegisterDTO = registerDTO;\\n    }\\n\\n    @Override\\n    public void doPersistInterface(final MetaDataRegisterDTO metadata) {\\n        doRegister(metadata, Constants.META_PATH, Constants.META_TYPE);\\n    }\\n\\n    @Override\\n    public void close() {\\n        if (uriRegisterDTO != null) {\\n            uriRegisterDTO.setEventType(EventType.DELETED);\\n            doRegister(uriRegisterDTO, Constants.URI_PATH, Constants.URI);\\n        }\\n    }\\n\\n    private void setAccessToken() {\\n        for (String server : serverList) {\\n            try {\\n                Optional<?> login = RegisterUtils.doLogin(username, password, server.concat(Constants.LOGIN_PATH));\\n                login.ifPresent(v -> this.accessToken = String.valueOf(v));\\n            } catch (Exception e) {\\n                LOGGER.error(\\"Login admin url :{} is fail, will retry. cause: {} \\", server, e.getMessage());\\n            }\\n        }\\n    }\\n\\n    private <T> void doRegister(final T t, final String path, final String type) {\\n        int i = 0;\\n        // \u904d\u5386admin\u670d\u52a1\u5217\u8868\uff08admin\u53ef\u80fd\u662f\u96c6\u7fa4\uff09\\n        for (String server : serverList) {\\n            i++;\\n            String concat = server.concat(path);\\n            try {\\n                // \u8bbe\u7f6e\u8bbf\u95eetoken\\n                if (StringUtils.isBlank(accessToken)) {\\n                    this.setAccessToken();\\n                    if (StringUtils.isBlank(accessToken)) {\\n                        throw new NullPointerException(\\"accessToken is null\\");\\n                    }\\n                }\\n                // \u8c03\u7528\u5de5\u5177\u7c7b\u53d1\u9001 http \u8bf7\u6c42\\n                RegisterUtils.doRegister(GsonUtils.getInstance().toJson(t), concat, type, accessToken);\\n                return;\\n            } catch (Exception e) {\\n                LOGGER.error(\\"Register admin url :{} is fail, will retry. cause:{}\\", server, e.getMessage());\\n                if (i == serverList.size()) {\\n                    throw new RuntimeException(e);\\n                }\\n            }\\n        }\\n    }\\n}\\n\\n```\\n\\n\\n\\n\u5c06\u6570\u636e\u5e8f\u5217\u5316\u540e\uff0c\u901a\u8fc7`OkHttp`\u53d1\u9001\u6570\u636e\u3002\\n\\n```java\\n\\npublic final class RegisterUtils {\\n   \\n   //...... \\n\\n    // \u901a\u8fc7OkHttp\u53d1\u9001\u6570\u636e\\n    public static void doRegister(final String json, final String url, final String type) throws IOException {\\n        if (!StringUtils.hasLength(accessToken)) {\\n            LOGGER.error(\\"{} client register error accessToken is null, please check the config : {} \\", type, json);\\n            return;\\n        }\\n        Headers headers = new Headers.Builder().add(Constants.X_ACCESS_TOKEN, accessToken).build();\\n        String result = OkHttpTools.getInstance().post(url, json, headers);\\n        if (Objects.equals(SUCCESS, result)) {\\n            LOGGER.info(\\"{} client register success: {} \\", type, json);\\n        } else {\\n            LOGGER.error(\\"{} client register error: {} \\", type, json);\\n        }\\n    }\\n}\\n```\\n\\n\\n\\n\u81f3\u6b64\uff0c\u5ba2\u6237\u7aef\u901a\u8fc7`http`\u7684\u65b9\u5f0f\u6ce8\u518c\u5143\u6570\u636e\u7684\u903b\u8f91\u5c31\u5206\u6790\u5b8c\u4e86\u3002\u5c0f\u7ed3\u4e00\u4e0b\uff1a\u901a\u8fc7\u8bfb\u53d6\u81ea\u5b9a\u4e49\u7684\u6ce8\u89e3\u4fe1\u606f\u6784\u9020\u5143\u6570\u636e\uff0c\u5c06\u6570\u636e\u53d1\u5230`Disruptor`\u961f\u5217\uff0c\u7136\u540e\u4ece\u961f\u5217\u4e2d\u6d88\u8d39\u6570\u636e\uff0c\u5c06\u6d88\u8d39\u8005\u653e\u5230\u7ebf\u7a0b\u6c60\u4e2d\u53bb\u6267\u884c\uff0c\u6700\u7ec8\u901a\u8fc7\u53d1\u9001`http`\u8bf7\u6c42\u5230`admin`\u3002\\n\\n\\n\u518d\u6765\u770b\u770b `URI` \u6570\u636e\u7684\u5904\u7406\\n\\n- ShenyuClientURIExecutorSubscriber#executor()\\n\\n\u4e3b\u8981\u903b\u8f91\u662f\u904d\u5386URI\u6570\u636e\u96c6\u5408\uff0c\u901a\u8fc7`persistURI()`\u65b9\u6cd5\u5b9e\u73b0\u6570\u636e\u6ce8\u518c\u3002\\n\\n```java\\n\\npublic class ShenyuClientURIExecutorSubscriber implements ExecutorTypeSubscriber<URIRegisterDTO> {\\n    \\n    //......\\n    \\n    @Override\\n    public DataType getType() {\\n        return DataType.URI; //\u6570\u636e\u7c7b\u578b\u662fURI\\n    }\\n    \\n    // \u6ce8\u518cURI\u6570\u636e\\n    @Override\\n    public void executor(final Collection<URIRegisterDTO> dataList) {\\n        for (URIRegisterDTO uriRegisterDTO : dataList) {\\n            Stopwatch stopwatch = Stopwatch.createStarted();\\n            while (true) {\\n                try (Socket ignored = new Socket(uriRegisterDTO.getHost(), uriRegisterDTO.getPort())) {\\n                    break;\\n                } catch (IOException e) {\\n                    long sleepTime = 1000;\\n                    // maybe the port is delay exposed\\n                    if (stopwatch.elapsed(TimeUnit.SECONDS) > 5) {\\n                        LOG.error(\\"host:{}, port:{} connection failed, will retry\\",\\n                                uriRegisterDTO.getHost(), uriRegisterDTO.getPort());\\n                        // If the connection fails for a long time, Increase sleep time\\n                        if (stopwatch.elapsed(TimeUnit.SECONDS) > 180) {\\n                            sleepTime = 10000;\\n                        }\\n                    }\\n                    try {\\n                        TimeUnit.MILLISECONDS.sleep(sleepTime);\\n                    } catch (InterruptedException ex) {\\n                        ex.printStackTrace();\\n                    }\\n                }\\n            }\\n            //\u6dfb\u52a0hook\uff0c\u4f18\u96c5\u505c\u6b62\u5ba2\u6237\u7aef \\n            ShenyuClientShutdownHook.delayOtherHooks();\\n            \\n            // \u6ce8\u518cURI\\n            shenyuClientRegisterRepository.persistURI(uriRegisterDTO);\\n        }\\n    }\\n}\\n```\\n\\n\u4ee3\u7801\u4e2d\u7684`while(true)`\u5faa\u73af\u662f\u4e3a\u4e86\u4fdd\u8bc1\u5ba2\u6237\u7aef\u5df2\u7ecf\u6210\u529f\u542f\u52a8\u4e86\uff0c\u901a\u8fc7`host`\u548c`port`\u53ef\u4ee5\u8fde\u63a5\u4e0a\u3002\\n\\n\\n\\n\u540e\u9762\u7684\u903b\u8f91\u662f\uff1a\u6dfb\u52a0`hook`\u51fd\u6570\uff0c\u7528\u4e8e\u4f18\u96c5\u505c\u6b62\u5ba2\u6237\u7aef \u3002\\n\\n\\n\\n\u901a\u8fc7`persistURI()`\u65b9\u6cd5\u5b9e\u73b0\u6570\u636e\u6ce8\u518c\u3002\u6574\u4e2a\u903b\u8f91\u4e5f\u5728\u524d\u9762\u5206\u6790\u8fc7\u4e86\uff0c\u6700\u7ec8\u5c31\u662f\u901a\u8fc7`OkHttp`\u5ba2\u6237\u7aef\u5411`shenyu-admin`\u53d1\u8d77`http`\uff0c\u901a\u8fc7`http`\u7684\u65b9\u5f0f\u6ce8\u518c`URI`\u3002\\n\\n\\n\\n\u5206\u6790\u5230\u8fd9\u91cc\u5c31\u5c06\u5ba2\u6237\u7aef\u7684\u6ce8\u518c\u903b\u8f91\u5206\u6790\u5b8c\u4e86\uff0c\u5c06\u6784\u5efa\u7684\u5143\u6570\u636e\u548cURI\u6570\u636e\u53d1\u9001\u5230`Disruptor`\u961f\u5217\uff0c\u518d\u4ece\u4e2d\u6d88\u8d39\uff0c\u8bfb\u53d6\u6570\u636e\uff0c\u901a\u8fc7`http`\u5411`admin`\u53d1\u9001\u6570\u636e\u3002\\n\\n\\n\\n\u5ba2\u6237\u7aef`\u5143\u6570\u636e`\u548c`URI`\u6ce8\u518c\u6d41\u7a0b\u7684\u6e90\u7801\u5206\u6790\u5b8c\u6210\u4e86\uff0c\u6d41\u7a0b\u56fe\u5982\u4e0b\uff1a\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/client-metadata-uri-register-zh.png)\\n\\n\\n\\n### 3. \u670d\u52a1\u7aef\u6ce8\u518c\u6d41\u7a0b\\n\\n\\n\\n#### 3.1 \u6ce8\u518c\u63a5\u53e3ShenyuClientHttpRegistryController\\n\\n\u4ece\u524d\u9762\u7684\u5206\u6790\u53ef\u4ee5\u77e5\u9053\uff0c\u670d\u52a1\u7aef\u63d0\u4f9b\u4e86\u6ce8\u518c\u7684\u4e24\u4e2a\u63a5\u53e3\uff1a\\n\\n- `/shenyu-client/register-metadata`\uff1a\u670d\u52a1\u7aef\u63d0\u4f9b\u7684\u63a5\u53e3\u7528\u4e8e\u6ce8\u518c\u5143\u6570\u636e\u3002\\n- `/shenyu-client/register-uri`\uff1a    \u670d\u52a1\u7aef\u63d0\u4f9b\u7684\u63a5\u53e3\u7528\u4e8e\u6ce8\u518cURI\u3002\\n\\n\\n\\n\u8fd9\u4e24\u4e2a\u63a5\u53e3\u4f4d\u4e8e`ShenyuClientHttpRegistryController`\u4e2d\uff0c\u5b83\u5b9e\u73b0\u4e86`ShenyuClientServerRegisterRepository`\u63a5\u53e3\uff0c\u662f\u670d\u52a1\u7aef\u6ce8\u518c\u7684\u5b9e\u73b0\u7c7b\u3002\u5b83\u7528`@Join`\u6807\u8bb0\uff0c\u8868\u793a\u901a\u8fc7`SPI`\u8fdb\u884c\u52a0\u8f7d\u3002\\n\\n```java\\n// shenuyu\u5ba2\u6237\u7aef\u63a5\u53e3\\n@RequestMapping(\\"/shenyu-client\\")\\n@Join\\npublic class ShenyuClientHttpRegistryController implements ShenyuClientServerRegisterRepository {\\n\\n    private ShenyuClientServerRegisterPublisher publisher;\\n\\n    @Override\\n    public void init(final ShenyuClientServerRegisterPublisher publisher, final ShenyuRegisterCenterConfig config) {\\n        this.publisher = publisher;\\n    }\\n\\n    @Override\\n    public void close() {\\n        publisher.close();\\n    }\\n    \\n    // \u6ce8\u518c\u5143\u6570\u636e\\n    @PostMapping(\\"/register-metadata\\")\\n    @ResponseBody\\n    public String registerMetadata(@RequestBody final MetaDataRegisterDTO metaDataRegisterDTO) {\\n        publisher.publish(metaDataRegisterDTO);\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n        \\n   // \u6ce8\u518cURI\\n    @PostMapping(\\"/register-uri\\")\\n    @ResponseBody\\n    public String registerURI(@RequestBody final URIRegisterDTO uriRegisterDTO) {\\n        publisher.publish(uriRegisterDTO);\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n}\\n\\n```\\n\\n\u4e24\u4e2a\u6ce8\u518c\u63a5\u53e3\u83b7\u53d6\u5230\u6570\u636e\u597d\uff0c\u5c31\u8c03\u7528\u4e86`publisher.publish()`\u65b9\u6cd5\uff0c\u628a\u6570\u636e\u53d1\u5e03\u5230`Disruptor`\u961f\u5217\u4e2d\u3002\\n\\n\\n\\n- `ShenyuClientServerRegisterRepository`\u63a5\u53e3\\n\\n\\n\\n`ShenyuClientServerRegisterRepository`\u63a5\u53e3\u662f\u670d\u52a1\u6ce8\u518c\u63a5\u53e3\uff0c\u5b83\u6709\u4e94\u4e2a\u5b9e\u73b0\u7c7b\uff0c\u8868\u793a\u6709\u4e94\u79cd\u6ce8\u518c\u65b9\u5f0f\uff1a\\n\\n- `ConsulClientServerRegisterRepository`\uff1a\u901a\u8fc7`Consul`\u5b9e\u73b0\u6ce8\u518c;\\n- `EtcdClientServerRegisterRepository`\uff1a\u901a\u8fc7`Etcd`\u5b9e\u73b0\u6ce8\u518c\uff1b\\n- `NacosClientServerRegisterRepository`\uff1a\u901a\u8fc7`Nacos`\u5b9e\u73b0\u6ce8\u518c\uff1b\\n- `ShenyuClientHttpRegistryController`\uff1a\u901a\u8fc7`Http`\u5b9e\u73b0\u6ce8\u518c\uff1b\\n- `ZookeeperClientServerRegisterRepository`\uff1a\u901a\u8fc7`Zookeeper`\u5b9e\u73b0\u6ce8\u518c\u3002\\n\\n\\n\\n\u5177\u4f53\u7528\u54ea\u4e00\u79cd\u65b9\u5f0f\uff0c\u662f\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\u7684\uff0c\u7136\u540e\u901a\u8fc7`SPI`\u8fdb\u884c\u52a0\u8f7d\u3002\\n\\n\\n\\n\u5728`shenyu-admin`\u4e2d\u7684`application.yml`\u6587\u4ef6\u4e2d\u914d\u7f6e\u6ce8\u518c\u65b9\u5f0f\uff0c`registerType`\u6307\u5b9a\u6ce8\u518c\u7c7b\u578b\uff0c\u5f53\u7528`http`\u8fdb\u884c\u6ce8\u518c\u65f6\uff0c`serverLists`\u4e0d\u9700\u8981\u586b\u5199\uff0c\u66f4\u591a\u914d\u7f6e\u8bf4\u660e\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51  [\u5ba2\u6237\u7aef\u63a5\u5165\u914d\u7f6e](https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access) \u3002\\n\\n```yaml\\nshenyu:\\n  register:\\n    registerType: http \\n    serverLists:\\n```\\n\\n\\n\\n- RegisterCenterConfiguration \u52a0\u8f7d\u914d\u7f6e\\n\\n\u5728\u5f15\u5165\u76f8\u5173\u4f9d\u8d56\u548c\u5c5e\u6027\u914d\u7f6e\u540e\uff0c\u542f\u52a8`shenyu-admin`\u65f6\uff0c\u4f1a\u5148\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u548c\u6ce8\u518c\u4e2d\u5fc3\u76f8\u5173\u7684\u914d\u7f6e\u6587\u4ef6\u7c7b\u662f`RegisterCenterConfiguration`\u3002\\n\\n```java\\n// \u6ce8\u518c\u4e2d\u5fc3\u914d\u7f6e\u7c7b\\n@Configuration\\npublic class RegisterCenterConfiguration {\\n    // \u8bfb\u53d6\u914d\u7f6e\u5c5e\u6027\\n    @Bean\\n    @ConfigurationProperties(prefix = \\"shenyu.register\\")\\n    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {\\n        return new ShenyuRegisterCenterConfig();\\n    }\\n    \\n    //\u521b\u5efaShenyuServerRegisterRepository\uff0c\u7528\u4e8e\u670d\u52a1\u7aef\u6ce8\u518c\\n    @Bean(destroyMethod = \\"close\\")\\n    public ShenyuServerRegisterRepository shenyuServerRegisterRepository(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig, final List<ShenyuClientRegisterService> shenyuClientRegisterService) {\\n        // 1.\u4ece\u914d\u7f6e\u5c5e\u6027\u4e2d\u83b7\u53d6\u6ce8\u518c\u7c7b\u578b\\n        String registerType = shenyuRegisterCenterConfig.getRegisterType();\\n        // 2.\u901a\u8fc7\u6ce8\u518c\u7c7b\u578b\uff0c\u4ee5SPI\u7684\u65b9\u6cd5\u52a0\u8f7d\u5b9e\u73b0\u7c7b\\n        ShenyuClientServerRegisterRepository registerRepository = ExtensionLoader.getExtensionLoader(ShenyuClientServerRegisterRepository.class).getJoin(registerType);\\n        // 3.\u83b7\u53d6publisher\uff0c\u5411Disruptor\u961f\u5217\u4e2d\u5199\u6570\u636e\\n        RegisterClientServerDisruptorPublisher publisher = RegisterClientServerDisruptorPublisher.getInstance();\\n        // 4.\u6ce8\u518cService\uff0c rpcType -> registerService\\n        Map<String, ShenyuClientRegisterService> registerServiceMap = shenyuClientRegisterService.stream().collect(Collectors.toMap(ShenyuClientRegisterService::rpcType, e -> e));\\n        // 5.\u4e8b\u4ef6\u53d1\u5e03\u7684\u51c6\u5907\u5de5\u4f5c\\n        publisher.start(registerServiceMap);\\n        // 6.\u6ce8\u518c\u7684\u521d\u59cb\u5316\u64cd\u4f5c\\n        registerRepository.init(publisher, shenyuRegisterCenterConfig);\\n        return registerRepository;\\n    }\\n}\\n\\n```\\n\\n\u5728\u914d\u7f6e\u7c7b\u4e2d\u751f\u6210\u4e86\u4e24\u4e2a`bean`\uff1a\\n\\n- `shenyuRegisterCenterConfig`\uff1a\u8bfb\u53d6\u5c5e\u6027\u914d\u7f6e\uff1b\\n\\n- `shenyuClientServerRegisterRepository`\uff1a\u7528\u4e8e\u670d\u52a1\u7aef\u6ce8\u518c\u3002\\n\\n\\n\\n\u5728\u521b\u5efa`shenyuClientServerRegisterRepository`\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u8fdb\u884c\u4e86\u4e00\u7cfb\u5217\u7684\u51c6\u5907\u5de5\u4f5c\uff1a\\n\\n- 1.\u4ece\u914d\u7f6e\u5c5e\u6027\u4e2d\u83b7\u53d6\u6ce8\u518c\u7c7b\u578b\u3002\\n- 2.\u901a\u8fc7\u6ce8\u518c\u7c7b\u578b\uff0c\u4ee5`SPI`\u7684\u65b9\u6cd5\u52a0\u8f7d\u5b9e\u73b0\u7c7b\uff1a\u6bd4\u5982\u6307\u5b9a\u7684\u7c7b\u578b\u662f`http`\uff0c\u5c31\u4f1a\u52a0\u8f7d`ShenyuClientHttpRegistryController`\u3002\\n- 3.\u83b7\u53d6`publisher`\uff0c\u5411`Disruptor`\u961f\u5217\u4e2d\u5199\u6570\u636e\u3002\\n- 4.\u6ce8\u518c`Service`\uff0c `rpcType -> registerService`\uff1a\u83b7\u53d6\u6ce8\u518c\u7684`Service`\uff0c\u6bcf\u79cd`rpc`\u90fd\u6709\u5bf9\u5e94\u7684`Service`\u3002\u672c\u6587\u7684\u5ba2\u6237\u7aef\u6784\u5efa\u662f\u901a\u8fc7`springboot`\uff0c\u5c5e\u4e8e`http`\u7c7b\u578b\uff0c\u8fd8\u6709\u5176\u4ed6\u5ba2\u6237\u7aef\u7c7b\u578b\uff1a`dubbo`\uff0c`Spring Cloud`\uff0c`gRPC`\u7b49\u3002\\n- 5.\u4e8b\u4ef6\u53d1\u5e03\u7684\u51c6\u5907\u5de5\u4f5c\uff1a\u6dfb\u52a0\u670d\u52a1\u7aef\u5143\u6570\u636e\u548c`URI`\u8ba2\u9605\u5668\uff0c\u5904\u7406\u6570\u636e\u3002\u5e76\u4e14\u542f\u52a8`Disruptor`\u961f\u5217\u3002\\n- 6.\u6ce8\u518c\u7684\u521d\u59cb\u5316\u64cd\u4f5c\uff1a`http`\u7c7b\u578b\u7684\u6ce8\u518c\u521d\u59cb\u5316\u64cd\u4f5c\u5c31\u662f\u4fdd\u5b58`publisher`\u3002\\n\\n\\n- RegisterServerDisruptorPublisher#publish()\\n\\n\u670d\u52a1\u7aef\u5411`Disruptor`\u961f\u5217\u5199\u5165\u6570\u636e\u7684\u53d1\u5e03\u8005 \uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u6784\u5efa\u3002\\n\\n```java\\n\\npublic class RegisterClientServerDisruptorPublisher implements ShenyuClientServerRegisterPublisher {\\n    //\u79c1\u6709\u5c5e\u6027\\n    private static final RegisterClientServerDisruptorPublisher INSTANCE = new RegisterClientServerDisruptorPublisher();\\n\\n    private DisruptorProviderManage<Collection<DataTypeParent>> providerManage;\\n\\n    //\u516c\u5f00\u9759\u6001\u65b9\u6cd5\u83b7\u53d6\u5b9e\u4f8b\\n    public static RegisterServerDisruptorPublisher getInstance() {\\n        return INSTANCE;\\n    }\\n    \\n   //\u4e8b\u4ef6\u53d1\u5e03\u7684\u51c6\u5907\u5de5\u4f5c\uff0c\u6dfb\u52a0\u670d\u52a1\u7aef\u5143\u6570\u636e\u548cURI\u8ba2\u9605\u5668\uff0c\u5904\u7406\u6570\u636e\u3002\u5e76\u4e14\u542f\u52a8Disruptor\u961f\u5217\u3002\\n    public void start(final Map<String, ShenyuClientRegisterService> shenyuClientRegisterService) {\\n        //\u670d\u52a1\u7aef\u6ce8\u518c\u5de5\u5382\\n        RegisterServerExecutorFactory factory = new RegisterServerExecutorFactory();\\n        //\u6dfb\u52a0URI\u6570\u636e\u8ba2\u9605\u5668\\n        factory.addSubscribers(new URIRegisterExecutorSubscriber(shenyuClientRegisterService));\\n        //\u6dfb\u52a0\u5143\u6570\u636e\u8ba2\u9605\u5668\\n        factory.addSubscribers(new MetadataExecutorSubscriber(shenyuClientRegisterService));\\n        //\u542f\u52a8Disruptor\u961f\u5217\\n        providerManage = new DisruptorProviderManage(factory);\\n        providerManage.startup();\\n    }\\n    \\n    // \u5411\u961f\u5217\u4e2d\u5199\u5165\u6570\u636e\\n    @Override\\n    public void publish(final DataTypeParent data) {\\n        DisruptorProvider<Collection<DataTypeParent>> provider = providerManage.getProvider();\\n        provider.onData(Collections.singleton(data));\\n    }\\n\\n    // \u6279\u91cf\u5411\u961f\u5217\u4e2d\u5199\u5165\u6570\u636e\\n    @Override\\n    public void publish(final Collection<? extends DataTypeParent> dataList) {\\n        DisruptorProvider<Collection<DataTypeParent>> provider = providerManage.getProvider();\\n        provider.onData(dataList.stream().map(DataTypeParent.class::cast).collect(Collectors.toList()));\\n    }\\n    \\n    @Override\\n    public void close() {\\n        providerManage.getProvider().shutdown();\\n    }\\n}\\n```\\n\\n\\n\\n\u914d\u7f6e\u6587\u4ef6\u7684\u52a0\u8f7d\uff0c\u53ef\u770b\u4f5c\u662f\u6ce8\u518c\u4e2d\u5fc3\u670d\u52a1\u7aef\u521d\u59cb\u5316\u6d41\u7a0b\uff0c\u7528\u56fe\u63cf\u8ff0\u5982\u4e0b\uff1a\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/server-register-init-zh.png)\\n\\n\\n\\n\\n\\n#### 3.2 \u6d88\u8d39\u6570\u636eQueueConsumer\\n\\n\\n\\n\u5728\u524d\u9762\u5206\u6790\u4e86\u5ba2\u6237\u7aef`disruptor`\u961f\u5217\u6d88\u8d39\u6570\u636e\u7684\u8fc7\u3002\u670d\u52a1\u7aef\u4e5f\u662f\u4e00\u6837\u7684\u903b\u8f91\uff0c\u53ea\u662f\u5176\u4e2d\u6267\u884c\u4efb\u52a1\u7684\u6267\u884c\u8005\u53d8\u4e86\u3002\\n\\n`QueueConsumer`\u662f\u4e00\u4e2a\u6d88\u8d39\u8005\uff0c\u5b83\u5b9e\u73b0\u4e86`WorkHandler`\u63a5\u53e3\uff0c\u5b83\u7684\u521b\u5efa\u8fc7\u7a0b\u5728`providerManage.startup()`\u903b\u8f91\u4e2d\u3002`WorkHandler`\u63a5\u53e3\u662f`disruptor`\u7684\u6570\u636e\u6d88\u8d39\u63a5\u53e3\uff0c\u53ea\u6709\u4e00\u4e2a\u65b9\u6cd5\u662f`onEvent()`\u3002\\n\\n```java\\npackage com.lmax.disruptor;\\n\\npublic interface WorkHandler<T> {\\n    void onEvent(T event) throws Exception;\\n}\\n```\\n\\n`QueueConsumer`\u91cd\u5199\u4e86`onEvent()`\u65b9\u6cd5\uff0c\u4e3b\u8981\u903b\u8f91\u662f\u751f\u6210\u6d88\u8d39\u4efb\u52a1\uff0c\u7136\u540e\u5728\u7ebf\u7a0b\u6c60\u4e2d\u53bb\u6267\u884c\u3002\\n\\n```java\\n/**\\n * \\n * \u961f\u5217\u6d88\u8d39\u8005\\n */\\npublic class QueueConsumer<T> implements WorkHandler<DataEvent<T>> {\\n    \\n\\t// \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\\n\\n    @Override\\n    public void onEvent(final DataEvent<T> t) {\\n        if (t != null) {\\n            // \u6839\u636e\u4e8b\u4ef6\u7c7b\u578b\u83b7\u53d6\u76f8\u5e94\u7684\u7ebf\u7a0b\u6c60\\n            ThreadPoolExecutor executor = orderly(t);\\n            // \u901a\u8fc7\u5de5\u5382\u521b\u5efa\u961f\u5217\u6d88\u8d39\u4efb\u52a1\\n            QueueConsumerExecutor<T> queueConsumerExecutor = factory.create();\\n            // \u4fdd\u5b58\u6570\u636e\\n            queueConsumerExecutor.setData(t.getData());\\n            // help gc\\n            t.setData(null);\\n            // \u653e\u5728\u7ebf\u7a0b\u6c60\u4e2d\u6267\u884c \u6d88\u8d39\u4efb\u52a1\\n            executor.execute(queueConsumerExecutor);\\n        }\\n    }\\n}\\n```\\n\\n`QueueConsumerExecutor`\u662f\u5728\u7ebf\u7a0b\u6c60\u4e2d\u88ab\u6267\u884c\u7684\u4efb\u52a1\uff0c\u5b83\u5b9e\u73b0\u4e86`Runnable`\u63a5\u53e3\uff0c\u5177\u4f53\u7684\u5b9e\u73b0\u7c7b\u6709\u4e24\u4e2a\uff1a\\n\\n- `RegisterClientConsumerExecutor`\uff1a\u5ba2\u6237\u7aef\u6d88\u8d39\u8005\u6267\u884c\u5668\uff1b\\n- `RegisterServerConsumerExecutor`\uff1a\u670d\u52a1\u7aef\u6d88\u8d39\u8005\u6267\u884c\u5668\u3002\\n\\n\u987e\u540d\u601d\u4e49\uff0c\u4e00\u4e2a\u8d1f\u8d23\u5904\u7406\u5ba2\u6237\u7aef\u4efb\u52a1\uff0c\u4e00\u4e2a\u8d1f\u8d23\u5904\u7406\u670d\u52a1\u7aef\u4efb\u52a1\u3002\\n\\n\\n\\n- `RegisterServerConsumerExecutor#run()`\\n\\n`RegisterServerConsumerExecutor`\u662f\u670d\u52a1\u7aef\u6d88\u8d39\u8005\u6267\u884c\u5668\uff0c\u5b83\u901a\u8fc7`QueueConsumerExecutor`\u95f4\u63a5\u5b9e\u73b0\u4e86`Runnable`\u63a5\u53e3\uff0c\u5e76\u91cd\u5199\u4e86`run()`\u65b9\u6cd5\u3002\\n\\n\\n```java\\n\\npublic final class RegisterServerConsumerExecutor extends QueueConsumerExecutor<Collection<DataTypeParent>> {\\n   // ...\\n\\n    @Override\\n    public void run() {\\n        //\u83b7\u53d6\u4ecedisruptor\u961f\u5217\u4e2d\u62ff\u5230\u7684\u6570\u636e\\n        Collection<DataTypeParent> results = getData()\\n                .stream()\\n                .filter(this::isValidData)\\n                .collect(Collectors.toList());\\n        if (CollectionUtils.isEmpty(results)) {\\n            return;\\n        }\\n        //\u6839\u636e\u7c7b\u578b\u6267\u884c\u64cd\u4f5c\\n        selectExecutor(results).executor(results);\\n    }\\n\\n    // \u6839\u636e\u7c7b\u578b\u83b7\u53d6\u8ba2\u9605\u8005\\n    private ExecutorSubscriber<DataTypeParent> selectExecutor(final Collection<DataTypeParent> list) {\\n        final Optional<DataTypeParent> first = list.stream().findFirst();\\n        return subscribers.get(first.orElseThrow(() -> new RuntimeException(\\"the data type is not found\\")).getType());\\n    }\\n}\\n\\n```\\n\\n\\n\\n- ExecutorSubscriber#executor()\\n\\n\u6267\u884c\u5668\u8ba2\u9605\u8005\u5206\u4e3a\u4e24\u7c7b\uff0c\u4e00\u4e2a\u662f\u5904\u7406\u5143\u6570\u636e\uff0c\u4e00\u4e2a\u662f\u5904\u7406`URI`\u3002\u5728\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u5206\u522b\u6709\u4e24\u4e2a\uff0c\u6240\u4ee5\u4e00\u5171\u662f\u56db\u4e2a\u3002\\n\\n![](/img/activities/code-analysis-http-register/executor-subscriber.png)\\n\\n\\n\\n- MetadataExecutorSubscriber#executor()\\n\\n\u5982\u679c\u662f\u6ce8\u518c\u5143\u6570\u636e\uff0c\u5219\u901a\u8fc7`MetadataExecutorSubscriber#executor()`\u5b9e\u73b0\uff1a\u6839\u636e\u7c7b\u578b\u83b7\u53d6\u6ce8\u518c`Service`\uff0c\u8c03\u7528`register()`\u3002\\n\\n```java\\npublic class MetadataExecutorSubscriber implements ExecutorTypeSubscriber<MetaDataRegisterDTO> {\\n \\n    //......\\n\\n    @Override\\n    public DataType getType() {\\n        return DataType.META_DATA;  // \u5143\u6570\u636e\u7c7b\u578b\\n    }\\n\\n    @Override\\n    public void executor(final Collection<MetaDataRegisterDTO> metaDataRegisterDTOList) {\\n        // \u904d\u5386\u5143\u6570\u636e\u5217\u8868\\n        metaDataRegisterDTOList.forEach(meta -> {\\n            Optional.ofNullable(this.shenyuClientRegisterService.get(meta.getRpcType())) // \u6839\u636e\u7c7b\u578b\u83b7\u53d6\u6ce8\u518cService\\n                    .ifPresent(shenyuClientRegisterService -> {\\n                        // \u5bf9\u5143\u6570\u636e\u8fdb\u884c\u6ce8\u518c\uff0c\u52a0\u9501\u786e\u4fdd\u987a\u5e8f\u6267\u884c\uff0c\u9632\u6b62\u5e76\u53d1\u9519\u8bef\\n                        synchronized (shenyuClientRegisterService) {\\n                            shenyuClientRegisterService.register(meta);\\n                        }\\n                    });\\n        });\\n    }\\n}\\n```\\n\\n\\n\\n- URIRegisterExecutorSubscriber#executor()\\n\\n\u5982\u679c\u662f\u6ce8\u518c\u5143\u6570\u636e\uff0c\u5219\u901a\u8fc7`URIRegisterExecutorSubscriber#executor()`\u5b9e\u73b0\uff1a\u6784\u5efa`URI`\u6570\u636e\uff0c\u6839\u636e\u6ce8\u518c\u7c7b\u578b\u67e5\u627e`Service\uff0c`\u901a\u8fc7`registerURI`\u65b9\u6cd5\u5b9e\u73b0\u6ce8\u518c\u3002\\n\\n```java\\n\\npublic class URIRegisterExecutorSubscriber implements ExecutorTypeSubscriber<URIRegisterDTO> {\\n    //......\\n    \\n    @Override\\n    public DataType getType() {\\n        return DataType.URI; // URI\u6570\u636e\u7c7b\u578b\\n    }\\n    \\n    @Override\\n    public void executor(final Collection<URIRegisterDTO> dataList) {\\n        if (CollectionUtils.isEmpty(dataList)) {\\n            return;\\n        }\\n        // \u6839\u636erpc\u8c03\u7528\u7c7b\u578b\u805a\u96c6\u6570\u636e\\n        final Map<String, List<URIRegisterDTO>> groupByRpcType = dataList.stream()\\n                .filter(data -> StringUtils.isNotBlank(data.getRpcType()))\\n                .collect(Collectors.groupingBy(URIRegisterDTO::getRpcType));\\n        for (Map.Entry<String, List<URIRegisterDTO>> entry : groupByRpcType.entrySet()) {\\n            final String rpcType = entry.getKey();\\n            // \u6839\u636e\u7c7b\u578b\u67e5\u627eService\\n            Optional.ofNullable(shenyuClientRegisterService.get(rpcType))\\n                    .ifPresent(service -> {\\n                        final List<URIRegisterDTO> list = entry.getValue();\\n                        // \u6784\u5efaURI\u6570\u636e\u7c7b\u578b\uff0c\u901a\u8fc7registerURI\u65b9\u6cd5\u5b9e\u73b0\u6ce8\u518c\\n                        Map<String, List<URIRegisterDTO>> listMap = buildData(list);\\n                        listMap.forEach(service::registerURI);\\n                    });\\n        }\\n    }\\n}\\n\\n```\\n\\n\\n\\n- ShenyuClientRegisterService#register()\\n\\n`ShenyuClientRegisterService`\u662f\u6ce8\u518c\u65b9\u6cd5\u63a5\u53e3\uff0c\u5b83\u6709\u591a\u4e2a\u5b9e\u73b0\u7c7b\uff1a\\n\\n![](/img/activities/code-analysis-http-register/client-register-service.png)\\n\\n\\n\\n- `AbstractContextPathRegisterService`\uff1a\u62bd\u8c61\u7c7b\uff0c\u5904\u7406\u90e8\u5206\u516c\u5171\u903b\u8f91\uff1b\\n- `AbstractShenyuClientRegisterServiceImpl`\uff1a\uff1a\u62bd\u8c61\u7c7b\uff0c\u5904\u7406\u90e8\u5206\u516c\u5171\u903b\u8f91\uff1b\\n- `ShenyuClientRegisterDivideServiceImpl`\uff1a`divide`\u7c7b\uff0c\u5904\u7406`http`\u6ce8\u518c\u7c7b\u578b\uff1b\\n- `ShenyuClientRegisterDubboServiceImpl`\uff1a`dubbo`\u7c7b\uff0c\u5904\u7406`dubbo`\u6ce8\u518c\u7c7b\u578b\uff1b\\n- `ShenyuClientRegisterGrpcServiceImpl`\uff1a`gRPC`\u7c7b\uff0c\u5904\u7406`gRPC`\u6ce8\u518c\u7c7b\u578b\uff1b\\n- `ShenyuClientRegisterMotanServiceImpl`\uff1a`Motan`\u7c7b\uff0c\u5904\u7406`Motan`\u6ce8\u518c\u7c7b\u578b\uff1b\\n- `ShenyuClientRegisterSofaServiceImpl`\uff1a`Sofa`\u7c7b\uff0c\u5904\u7406`Sofa`\u6ce8\u518c\u7c7b\u578b\uff1b\\n- `ShenyuClientRegisterSpringCloudServiceImpl`\uff1a`SpringCloud`\u7c7b\uff0c\u5904\u7406`SpringCloud`\u6ce8\u518c\u7c7b\u578b\uff1b\\n- `ShenyuClientRegisterTarsServiceImpl`\uff1a`Tars`\u7c7b\uff0c\u5904\u7406`Tars`\u6ce8\u518c\u7c7b\u578b\uff1b\\n- `ShenyuClientRegisterWebSocketServiceImpl`\uff1a`Websocket`\u7c7b\uff0c\u5904\u7406`Websocket`\u6ce8\u518c\u7c7b\u578b\uff1b\\n\\n\\n\\n\u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u51fa\u6bcf\u79cd\u5fae\u670d\u52a1\u90fd\u6709\u5bf9\u5e94\u7684\u6ce8\u518c\u5b9e\u73b0\u7c7b\uff0c\u672c\u6587\u7684\u6e90\u7801\u5206\u6790\u662f \u4ee5\u5b98\u65b9\u63d0\u4f9b\u7684 [shenyu-examples-http](https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http) \u4e3a\u4f8b\uff0c\u662f\u5c5e`http`\u6ce8\u518c\u7c7b\u578b\uff0c\u6240\u4ee5\u5143\u6570\u636e\u548cURI\u6570\u636e\u7684\u6ce8\u518c\u5b9e\u73b0\u7c7b\u662f `ShenyuClientRegisterDivideServiceImpl`\uff1a\\n\\n- register(): \u6ce8\u518c\u5143\u6570\u636e\\n\\n```java\\npublic abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {\\n    \\n    //......\\n    \\n    public String register(final MetaDataRegisterDTO dto) {\\n        // 1.\u6ce8\u518c\u9009\u62e9\u5668\u4fe1\u606f\\n        String selectorHandler = selectorHandler(dto);\\n        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);\\n        // 2.\u6ce8\u518c\u89c4\u5219\u4fe1\u606f\\n        String ruleHandler = ruleHandler();\\n        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);\\n        ruleService.registerDefault(ruleDTO);\\n        // 3.\u6ce8\u518c\u5143\u6570\u636e\u4fe1\u606f\\n        registerMetadata(dto);\\n        // 4.\u6ce8\u518ccontextPath\\n        String contextPath = dto.getContextPath();\\n        if (StringUtils.isNotEmpty(contextPath)) {\\n            registerContextPath(dto);\\n        }\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n}\\n```\\n\\n\u6574\u4e2a\u6ce8\u518c\u903b\u8f91\u53ef\u4ee5\u5206\u4e3a4\u4e2a\u6b65\u9aa4\uff1a\\n\\n- 1.\u6ce8\u518c\u9009\u62e9\u5668\u4fe1\u606f\\n- 2.\u6ce8\u518c\u89c4\u5219\u4fe1\u606f\\n- 3.\u6ce8\u518c\u5143\u6570\u636e\u4fe1\u606f\\n- 4.\u6ce8\u518c`contextPath`\\n\\n\u5728`admin`\u8fd9\u4e00\u4fa7\u901a\u8fc7\u5ba2\u6237\u7aef\u7684\u5143\u6570\u636e\u4fe1\u606f\u9700\u8981\u6784\u5efa\u9009\u62e9\u5668\u3001\u89c4\u5219\u3001\u5143\u6570\u636e\u548c`ContextPath`\u3002\u5177\u4f53\u7684\u6ce8\u518c\u8fc7\u7a0b\u548c\u7ec6\u8282\u5904\u7406\u8ddf`rpc`\u7c7b\u578b\u6709\u5173\u3002\u6211\u4eec\u5c31\u4e0d\u518d\u7ee7\u7eed\u5411\u4e0b\u8ffd\u8e2a\u4e86\uff0c\u5bf9\u4e8e\u6ce8\u518c\u4e2d\u5fc3\u7684\u903b\u8f91\u5206\u6790\uff0c\u8ddf\u8e2a\u5230\u8fd9\u91cc\u5c31\u591f\u4e86\u3002\\n\\n\\n\\n\u670d\u52a1\u7aef\u5143\u6570\u636e\u6ce8\u518c\u6d41\u7a0b\u7684\u6e90\u7801\u5206\u6790\u5b8c\u4e86\uff0c\u6d41\u7a0b\u56fe\u63cf\u8ff0\u5982\u4e0b\uff1a\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/server-metadata-register-zh.png)\\n\\n\\n\\n- registerURI(): \u6ce8\u518c`URI`\u6570\u636e\\n\\n```java\\npublic abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {\\n\\n    //......\\n    \\n    public String doRegisterURI(final String selectorName, final List<URIRegisterDTO> uriList) {\\n        if (CollectionUtils.isEmpty(uriList)) {\\n            return \\"\\";\\n        }\\n        // \u5bf9\u5e94\u7684\u9009\u62e9\u5668\u662f\u5426\u5b58\u5728\\n        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\\n        if (Objects.isNull(selectorDO)) {\\n            throw new ShenyuException(\\"doRegister Failed to execute,wait to retry.\\");\\n        }\\n        List<URIRegisterDTO> validUriList = uriList.stream().filter(dto -> Objects.nonNull(dto.getPort()) && StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());\\n        // \u5904\u7406\u9009\u62e9\u5668\u4e2d\u7684handler\u4fe1\u606f\\n        String handler = buildHandle(validUriList, selectorDO);\\n        if (handler != null) {\\n            selectorDO.setHandle(handler);\\n            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));\\n            selectorData.setHandle(handler);\\n            // \u66f4\u65b0\u6570\u636e\u5e93\u4e2d\u7684\u8bb0\u5f55\\n            selectorService.updateSelective(selectorDO);\\n            // \u53d1\u5e03\u4e8b\u4ef6\\n            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));\\n        }\\n        return ShenyuResultMessage.SUCCESS;\\n    }\\n}\\n```\\n\\n`admin`\u62ff\u5230`URI`\u6570\u636e\u540e\uff0c\u4e3b\u8981\u662f\u66f4\u65b0\u9009\u62e9\u5668\u4e2d\u7684`handler`\u4fe1\u606f\uff0c\u7136\u540e\u5199\u5165\u5230\u6570\u636e\u5e93\uff0c\u6700\u540e\u53d1\u5e03\u4e8b\u4ef6\u901a\u77e5\u7f51\u5173\u3002\u901a\u77e5\u7f51\u5173\u7684\u903b\u8f91\u662f\u7531\u6570\u636e\u540c\u6b65\u64cd\u4f5c\u5b8c\u6210\uff0c\u8fd9\u5728\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u5df2\u7ecf\u5206\u6790\u8fc7\u4e86\uff0c\u5c31\u4e0d\u518d\u8d58\u8ff0\u3002\\n\\n\\n\\n\u670d\u52a1\u7aef`URI`\u6ce8\u518c\u6d41\u7a0b\u7684\u6e90\u7801\u5206\u6790\u5b8c\u6210\u4e86\uff0c\u7528\u56fe\u63cf\u8ff0\u5982\u4e0b\uff1a\\n\\n\\n\\n![](/img/activities/code-analysis-http-register/server-uri-register-zh.png)\\n\\n\u81f3\u6b64\uff0c\u670d\u52a1\u7aef\u6ce8\u518c\u6d41\u7a0b\u4e5f\u5c31\u5206\u6790\u5b8c\u4e86\uff0c\u4e3b\u8981\u901a\u8fc7\u5bf9\u5916\u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u63a5\u53d7\u5ba2\u6237\u7aef\u7684\u6ce8\u518c\u4fe1\u606f\uff0c\u7136\u540e\u5199\u5165\u5230`Disruptor`\u961f\u5217\uff0c\u518d\u4ece\u4e2d\u6d88\u8d39\u6570\u636e\uff0c\u6839\u636e\u63a5\u6536\u5230\u7684\u5143\u6570\u636e\u548c`URI`\u6570\u636e\u66f4\u65b0`admin`\u7684\u9009\u62e9\u5668\u3001\u89c4\u5219\u3001\u5143\u6570\u636e\u548c\u9009\u62e9\u5668\u7684`handler`\u3002\\n\\n\\n\\n\\n\\n### 4. \u603b\u7ed3\\n\\n\u672c\u6587\u4e3b\u8981\u5bf9`Apache ShenYu`\u7f51\u5173\u4e2d\u7684`http\u6ce8\u518c`\u6a21\u5757\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\uff0c\u5f52\u7eb3\u5982\u4e0b\uff1a\\n\\n- \u6ce8\u518c\u4e2d\u5fc3\u662f\u4e3a\u4e86\u5c06\u5ba2\u6237\u7aef\u4fe1\u606f\u6ce8\u518c\u5230`admin`\uff0c\u65b9\u4fbf\u6d41\u91cf\u7b5b\u9009\uff1b\\n- `http`\u6ce8\u518c\u662f\u5c06\u5ba2\u6237\u7aef\u5143\u6570\u636e\u4fe1\u606f\u548c`URI`\u4fe1\u606f\u6ce8\u518c\u5230`admin`\uff1b\\n- `http`\u670d\u52a1\u7684\u63a5\u5165\u901a\u8fc7\u6ce8\u89e3`@ShenyuSpringMvcClient`\u6807\u8bc6\uff1b\\n- \u6ce8\u518c\u4fe1\u606f\u7684\u6784\u5efa\u4e3b\u8981\u901a\u8fc7`Spring`\u5e94\u7528\u76d1\u542c\u5668`ApplicationListener`\uff1b\\n- \u6ce8\u518c\u7c7b\u578b\u7684\u52a0\u8f7d\u901a\u8fc7`SPI`\u5b8c\u6210\uff1b\\n- \u5f15\u5165`Disruptor`\u961f\u5217\u662f\u4e3a\u4e86\u6570\u636e\u4e0e\u64cd\u4f5c\u89e3\u8026\uff0c\u4ee5\u53ca\u6570\u636e\u7f13\u51b2\u3002\\n- \u6ce8\u518c\u4e2d\u5fc3\u7684\u5b9e\u73b0\u91c7\u7528\u4e86\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff0c\u4f7f\u7528\u6a21\u677f\u65b9\u6cd5\u3001\u5355\u4f8b\u3001\u89c2\u5bdf\u8005\u7b49\u8bbe\u8ba1\u6a21\u5f0f\u3002"},{"id":"/SPI-SourceCode-Analysis-LoadBalance-SPI","metadata":{"permalink":"/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-LoadBalance-SPI.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-LoadBalance-SPI.md","title":"LoadBalancer SPI \u4ee3\u7801\u5206\u6790","description":"\u200b        \u7f51\u5173\u5e94\u7528\u9700\u8981\u652f\u6301\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7684\u65b9\u6848\uff0c\u5305\u62ec\u968f\u673a\u9009\u62e9\u3001Hash\u3001\u8f6e\u8be2\u7b49\u65b9\u5f0f\u3002Apache Shenyu\u7f51\u5173\u4e2d\u4e0d\u4ec5\u5b9e\u73b0\u4e86\u4f20\u7edf\u7f51\u5173\u7684\u8fd9\u4e9b\u5747\u8861\u7b56\u7565\uff0c\u8fd8\u901a\u8fc7\u6d41\u91cf\u9884\u70ed(warmup)\u7b49\u7ec6\u8282\u5904\u7406\uff0c\u5bf9\u670d\u52a1\u5668\u8282\u70b9\u7684\u52a0\u5165\uff0c\u505a\u4e86\u66f4\u5e73\u6ed1\u7684\u6d41\u91cf\u5904\u7406\uff0c\u83b7\u5f97\u4e86\u66f4\u597d\u7684\u6574\u4f53\u7a33\u5b9a\u6027\u3002\u8ba9\u6211\u4eec\u6765\u770b\u770bShenyu\u662f\u662f\u5982\u4f55\u8bbe\u8ba1\u548c\u5b9e\u73b0\u8fd9\u90e8\u5206\u529f\u80fd\u7684\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"load balance","permalink":"/zh/blog/tags/load-balance"},{"label":"SPI","permalink":"/zh/blog/tags/spi"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":17.74,"hasTruncateMarker":false,"authors":[{"name":"Huihui Yin","title":"Apache ShenYu Contributor","url":"https://github.com/changanjennifer/"}],"frontMatter":{"title":"LoadBalancer SPI \u4ee3\u7801\u5206\u6790","author":"Huihui Yin","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/changanjennifer/","tags":["load balance","SPI","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"\u6ce8\u518c\u4e2d\u5fc3\u5b9e\u73b0\u539f\u7406\u4e4bHttp\u6ce8\u518c","permalink":"/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register"},"nextItem":{"title":"MatchStrategy--\u57fa\u4e8eSPI\u7684\u4ee3\u7801\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI"}},"content":"\u200b        \u7f51\u5173\u5e94\u7528\u9700\u8981\u652f\u6301\u591a\u79cd\u8d1f\u8f7d\u5747\u8861\u7684\u65b9\u6848\uff0c\u5305\u62ec\u968f\u673a\u9009\u62e9\u3001Hash\u3001\u8f6e\u8be2\u7b49\u65b9\u5f0f\u3002`Apache Shenyu`\u7f51\u5173\u4e2d\u4e0d\u4ec5\u5b9e\u73b0\u4e86\u4f20\u7edf\u7f51\u5173\u7684\u8fd9\u4e9b\u5747\u8861\u7b56\u7565\uff0c\u8fd8\u901a\u8fc7\u6d41\u91cf\u9884\u70ed(warmup)\u7b49\u7ec6\u8282\u5904\u7406\uff0c\u5bf9\u670d\u52a1\u5668\u8282\u70b9\u7684\u52a0\u5165\uff0c\u505a\u4e86\u66f4\u5e73\u6ed1\u7684\u6d41\u91cf\u5904\u7406\uff0c\u83b7\u5f97\u4e86\u66f4\u597d\u7684\u6574\u4f53\u7a33\u5b9a\u6027\u3002\u8ba9\u6211\u4eec\u6765\u770b\u770bShenyu\u662f\u662f\u5982\u4f55\u8bbe\u8ba1\u548c\u5b9e\u73b0\u8fd9\u90e8\u5206\u529f\u80fd\u7684\u3002\\n\\n> \u672c\u6587\u57fa\u4e8e`shenyu-2.5.0`\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790.\\n\\n[TOC]\\n\\n## LoadBalancer `SPI`\\n\\n`LoadBalancer` SPI \u5b9a\u4e49\u5728***shenyu-loadbalancer***\u6a21\u7ec4\u4e2d\uff0c\u4ee5\u4e0b\u662f\u8fd9\u4e2a\u6838\u5fc3\u63a5\u53e3\u7684\u4ee3\u7801\uff0c\u8fd9\u4e2a\u63a5\u53e3\u5f88\u597d\u7684\u8be0\u91ca\u4e86\u8fd9\u6837\u4e00\u4e2a\u7406\u5ff5\uff1a\u8d1f\u8f7d\u5747\u8861\u662f\u5728\u4e00\u7cfb\u5217\u670d\u52a1\u5668\u8282\u70b9\u4e2d\u9009\u51fa\u6700\u5408\u9002\u7684\u8282\u70b9\uff0c\u4e5f\u5c31\u662f\u9009\u62e9\u7b56\u7565\u3002\u505a\u6d41\u91cf\u8f6c\u53d1\u3001\u8def\u7531\u548c\u8d1f\u8f7d\u5747\u8861\u662f`LoadBalance SPI`\u7684\u57fa\u672c\u529f\u80fd\\n\\n```java\\n@SPI\\npublic interface LoadBalancer {\\n\\n    /**\\n     * this is select one for upstream list.\\n     *\\n     * @param upstreamList upstream list\\n     * @param ip ip\\n     * @return upstream\\n     */\\n    Upstream select(List<Upstream> upstreamList, String ip);\\n}\\n```\\n\\n\u63a5\u53e3\u4e2d\uff0cupstreamList\u662f\u53ef\u9009\u8def\u7531\u7684\u4e00\u7ec4\u670d\u52a1\u5668\u8282\u70b9\uff0c`Upstream` \u662f\u670d\u52a1\u5668\u8282\u70b9\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5b83\u5305\u62ec\u7684\u91cd\u8981\u5143\u7d20\u6709\uff1a\u534f\u8bae\u3001url \u3001\u6743\u91cd\u3001\u65f6\u95f4\u6233\uff0cwarmup\uff0c\u5065\u5eb7\u72b6\u6001\u7b49\u3002\\n\\n```java\\npublic class Upstream {\\n    /**\\n     * protocol.\\n     */\\n    private final String protocol;\\n\\n    /**\\n     * url.\\n     */\\n    private String url;\\n\\n    /**\\n     * weight.\\n     */\\n    private final int weight;\\n\\n    /**\\n     * false close, true open.\\n     */\\n    private boolean status;\\n\\n    /**\\n     * startup time.\\n     */\\n    private final long timestamp;\\n\\n    /**\\n     * warmup.\\n     */\\n    private final int warmup;\\n\\n    /**\\n     * healthy.\\n     */\\n    private boolean healthy;\\n\\n    /**\\n     * lastHealthTimestamp.\\n     */\\n    private long lastHealthTimestamp;\\n\\n    /**\\n     * lastUnhealthyTimestamp.\\n     */\\n    private long lastUnhealthyTimestamp;\\n\\n    /**\\n     * group.\\n     */\\n    private String group;\\n\\n    /**\\n     * version.\\n     */\\n    private String version;\\n}\\n\\n```\\n\\n## Design of LoadBalance module`\\n\\n\u56fe1\u662f`LoadBalancer`\u6a21\u7ec4\u7684\u7c7b\u56fe\uff1a\\n\\n![loadbalancer-class-diagram](/img/activities/code-analysis-loadbalance-spi/loadBalancer-class-diagram.png)\\n\\n\u4ece\u7c7b\u56fe\u4e0a\u53ef\u4ee5\u770b\u51fa`LoadBalance`\u7684\u8bbe\u8ba1\u6982\u8981\uff1a\\n\\n1. \u62bd\u8c61\u7c7b`AbstractLoadBalancer`\u7ee7\u627f\u81ea`LoadBalancer` SPI\u63a5\u53e3\uff0c\u5e76\u63d0\u4f9b\u9009\u62e9\u7684\u6a21\u677f\u65b9\u6cd5\uff0c\u53ca\u6743\u91cd\u8ba1\u7b97\u3002\\n\\n2. \u4e09\u4e2a\u5b9e\u505a\u7c7b\u7ee7\u627f`AbstractLoadBalancer`\uff0c \u5b9e\u73b0\u5404\u81ea\u7684\u903b\u8f91\u5904\u7406\u3002\\n\\n   - `RandomLoadBalancer` -\u52a0\u6743\u968f\u673a\u9009\u62e9 Weight Random\\n   - `HashLoadBalancer`  - \u4e00\u81f4\u6027Hash\\n   - `RoundRobinLoadBalancer` -\u52a0\u6743\u8f6e\u8be2\uff08Weight Round Robin per-packet)\\n\\n3. \u7531\u5de5\u5382\u7c7b`LoadBalancerFactory` \u5b9e\u73b0\u5bf9\u5916\u7684\u9759\u6001\u8c03\u7528\u65b9\u6cd5\u3002\\n\\n   \u53e6\u5916\u6839\u636e`Apache Sheny SPI`\u89c4\u8303\uff0c\u5728`SHENYU_DIERECTORY`\u4e2d\u7684\u6dfb\u52a0profile\uff0c\u914d\u7f6e`LoadBalance`\u7684\u5b9e\u73b0\u7c7b\uff0c\u914d\u7f6ekey=class\u5f62\u5f0f\uff0c\u5de6\u8fb9\u7684operator\u8981\u548c`LoadBalanceEnum`\u4e2d\u7684\u5b9a\u4e49\u4e00\u81f4\u3002\\n\\n```properties\\nrandom=org.apache.shenyu.loadbalancer.spi.RandomLoadBalancer\\nroundRobin=org.apache.shenyu.loadbalancer.spi.RoundRobinLoadBalancer\\nhash=org.apache.shenyu.loadbalancer.spi.HashLoadBalancer\\n```\\n\\n`LoadBalanceEnum`\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a\\n\\n```java\\npublic enum LoadBalanceEnum {\\n    /**\\n     * Hash load balance enum.\\n     */\\n    HASH(1, \\"hash\\", true),\\n\\n    /**\\n     * Random load balance enum.\\n     */\\n    RANDOM(2, \\"random\\", true),\\n\\n    /**\\n     * Round robin load balance enum.\\n     */\\n    ROUND_ROBIN(3, \\"roundRobin\\", true);\\n\\n    private final int code;\\n    private final String name;\\n    private final boolean support;\\n}\\n```\\n\\n## AbstractLoadBalancer\\n\\n\u8fd9\u4e2a\u62bd\u8c61\u7c7b\u5b9e\u505a\u4e86`LoadBalancer`\u63a5\u53e3, \u5b9a\u4e49\u4e86\u62bd\u8c61\u65b9\u6cd5`doSelect()`\u7559\u7ed9\u5b9e\u4f5c\u7c7b\u5904\u7406\uff0c\u5728\u6a21\u677f\u65b9\u6cd5`select()` \u4e2d\u5148\u8fdb\u884c\u6821\u9a8c\uff0c\u4e4b\u540e\u8c03\u7528\u7531\u5b9e\u4f5c\u7c7b\u5b9e\u73b0\u7684`doSelect()`\u65b9\u6cd5\u3002\\n\\n```java\\npublic abstract class AbstractLoadBalancer implements LoadBalancer {\\n    /**\\n     * Do select divide upstream.\\n     *\\n     * @param upstreamList the upstream list\\n     * @param ip           the ip\\n     * @return the divide upstream\\n     */\\n    protected abstract Upstream doSelect(List<Upstream> upstreamList, String ip);\\n\\n    @Override\\n    public Upstream select(final List<Upstream> upstreamList, final String ip) {\\n        if (CollectionUtils.isEmpty(upstreamList)) {\\n            return null;\\n        }\\n        if (upstreamList.size() == 1) {\\n            return upstreamList.get(0);\\n        }\\n        return doSelect(upstreamList, ip);\\n    }\\n}\\n```\\n\\n\u6743\u91cd\u7684\u5904\u7406\u65b9\u6cd5`getWeight()`\u7684\u903b\u8f91\u662f\uff1a\u5f53\u6709\u65f6\u95f4\u6233\uff0c\u5e76\u4e14\u5f53\u524d\u65f6\u95f4\u4e0e\u65f6\u95f4\u6233\u95f4\u9694\u5728\u6d41\u91cf\u9884\u70edwarmup\u65f6\u95f4\u5185\uff0c\u6743\u91cd\u8ba1\u7b97\u7684\u516c\u5f0f\u4e3a\uff1a\\n$$ {1-1}\\nww = min(1,uptime/(warmup/weight))\\n$$\\n\u4ece\u516c\u5f0f\u53ef\u4ee5\u770b\u51fa\uff0c\u6700\u7ec8\u7684\u6743\u503c\uff0c\u4e0e\u8bbe\u7f6e\u7684weight\u6210\u6b63\u6bd4\uff0c\u65f6\u95f4\u95f4\u9694\u8d8a\u63a5\u8fd1warmup\u65f6\u95f4\uff0c\u6743\u91cd\u5c31\u8d8a\u5927\u3002\u4e5f\u5c31\u662f\u8bf4\u7b49\u5f85\u7684\u65f6\u95f4\u8d8a\u957f\uff0c\u88ab\u5206\u6d3e\u7684\u6743\u91cd\u8d8a\u9ad8\u3002\u6ca1\u6709\u65f6\u95f4\u6233\u65f6\u7b49\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0c\u8fd4\u56de`Upstream`\u8bbe\u7f6e\u7684`weight`\u503c\u3002\\n\\n\u8003\u8651\u6d41\u91cf\u9884\u70ed(warmup)\u7684\u6838\u5fc3\u601d\u60f3\u662f\u907f\u514d\u5728\u6dfb\u52a0\u65b0\u670d\u52a1\u5668\u548c\u542f\u52a8\u65b0JVM\u65f6\u7f51\u5173\u6027\u80fd\u4e0d\u4f73\u3002\\n\\n\u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u4e09\u4e2a\u5b9e\u505a\u7c7b\u7684\u5b9e\u73b0\u3002\\n\\n## RandomLoadBalancer\\n\\n\u8fd9\u91cc\u968f\u673a`LoadBalancer` \u53ef\u4ee5\u5904\u7406\u4e24\u79cd\u60c5\u51b5\uff1a\\n\\n1. \u6ca1\u6709\u6743\u91cd\uff1a\u6240\u6709\u670d\u52a1\u5668\u90fd\u6ca1\u6709\u8bbe\u5b9a\u6743\u91cd\uff0c\u6216\u8005\u6743\u91cd\u90fd\u4e00\u6837\uff0c \u4f1a\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u3002\\n2. \u6709\u6743\u91cd\uff1a\u670d\u52a1\u5668\u8bbe\u5b9a\u6709\u4e0d\u540c\u7684\u6743\u91cd\uff0c\u4f1a\u6839\u636e\u6743\u91cd\uff0c\u8fdb\u884c\u968f\u673a\u9009\u62e9\u3002\\n\\n\u4e0b\u9762\u662f\u6709\u6743\u91cd\u65f6\u7684\u968f\u673a\u9009\u62e9\u4ee3\u7801`random()`\uff1a \u904d\u5386\u5168\u90e8\u670d\u52a1\u5668\u5217\u8868\uff0c\u5f53\u968f\u673a\u503c\u5c0f\u4e8e\u67d0\u4e2a\u670d\u52a1\u5668\u6743\u91cd\u65f6\uff0c\u8fd9\u4e2a\u670d\u52a1\u5668\u88ab\u9009\u4e2d\uff08\u8fd9\u91cc\u63d0\u524d\u8ba1\u7b97\u4e86\u524d\u4e00\u534a\u670d\u52a1\u5668\u7684\u6743\u91cd\u548c\uff0c\u5982\u679c\u968f\u673a\u503c\u5927\u4e8e`halfLengthTotalWeight`\uff0c\u5219\u904d\u5386\u4ece`(weights.length + 1) / 2`\u5f00\u59cb\uff0c\u63d0\u9ad8\u4e86\u5c0f\u6548\u7387\uff09\u3002 \u82e5\u904d\u5386\u540e\u6ca1\u6709\u6ee1\u8db3\u6761\u4ef6\uff0c\u5c31\u5728\u5168\u90e8\u670d\u52a1\u5668\u5217\u8868\u4e2d\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u8fd4\u56de\u3002\u8fd9\u91cc`getWeight(final Upstream upstream)` \u65b9\u6cd5\u662f\u5728`AbstractLoadBalancer` \u4e2d\u5b9a\u4e49\u7684\uff0c\u6309\u516c\u5f0f\u8ba1\u7b97\u6743\u91cd\u3002\\n\\n```java\\n@Override\\npublic Upstream doSelect(final List<Upstream> upstreamList, final String ip) {\\n    int length = upstreamList.size();\\n    // every upstream has the same weight?\\n    boolean sameWeight = true;\\n    // the weight of every upstream\\n    int[] weights = new int[length];\\n    int firstUpstreamWeight = getWeight(upstreamList.get(0));\\n    weights[0] = firstUpstreamWeight;\\n    // init the totalWeight\\n    int totalWeight = firstUpstreamWeight;\\n    int halfLengthTotalWeight = 0;\\n    for (int i = 1; i < length; i++) {\\n        int currentUpstreamWeight = getWeight(upstreamList.get(i));\\n        if (i <= (length + 1) / 2) {\\n            halfLengthTotalWeight = totalWeight;\\n        }\\n        weights[i] = currentUpstreamWeight;\\n        totalWeight += currentUpstreamWeight;\\n        if (sameWeight && currentUpstreamWeight != firstUpstreamWeight) {\\n            // Calculate whether the weight of ownership is the same.\\n            sameWeight = false;\\n        }\\n    }\\n    if (totalWeight > 0 && !sameWeight) {\\n        return random(totalWeight, halfLengthTotalWeight, weights, upstreamList);\\n    }\\n    return random(upstreamList);\\n}\\n\\nprivate Upstream random(final int totalWeight, final int halfLengthTotalWeight, final int[] weights, final List<Upstream> upstreamList) {\\n    // If the weights are not the same and the weights are greater than 0, then random by the total number of weights.\\n    int offset = RANDOM.nextInt(totalWeight);\\n    int index = 0;\\n    int end = weights.length;\\n    if (offset >= halfLengthTotalWeight) {\\n        index = (weights.length + 1) / 2;\\n        offset -= halfLengthTotalWeight;\\n    } else {\\n        end = (weights.length + 1) / 2;\\n    }\\n    // Determine which segment the random value falls on\\n    for (; index < end; index++) {\\n        offset -= weights[index];\\n        if (offset < 0) {\\n            return upstreamList.get(index);\\n        }\\n    }\\n    return random(upstreamList);\\n}\\n```\\n\\n\u56e0\u6b64\uff0c\u5f53\u91c7\u7528`RandomLoadBalancer`\u65f6\uff0c\u662f\u6309\u6743\u91cd\u968f\u673a\u5206\u6d3e\u670d\u52a1\u5668\u7684\u3002\\n\\n## HashLoadBalancer\\n\\n`Apache Shenyu`\u7684`HashLoadBalancer` \u4e2d\u91c7\u7528\u4e86\u4e00\u81f4\u6027hash\u7b97\u6cd5\uff0c\u4f7f\u7528\u6709\u5e8fhash\u73af\uff0c\u5c06key\u4e0e\u670d\u52a1\u5668\u8282\u70b9\u7684hash\u6620\u5c04\u7f13\u5b58\u8d77\u6765\u3002\u5bf9\u4e8e\u8bf7\u6c42\u7684ip\u5730\u5740\uff0c\u8ba1\u7b97\u51fa\u5176`hash`\u503c\uff0c \u5728hash\u73af\u4e0a\u987a\u65f6\u9488\u67e5\u627e\u8ddd\u79bb\u8fd9\u4e2akey\u7684hash\u503c\u6700\u8fd1\u7684\u8282\u70b9\uff0c\u5c06\u5176\u4f5c\u4e3a\u8981\u8def\u7531\u7684\u8282\u70b9\u3002\u4e00\u81f4\u6027hash\u89e3\u51b3\u4e86\u4f20\u7edf\u53d6\u4f59hash\u7b97\u6cd5\u7684\u53ef\u4f38\u7f29\u6027\u5dee\u7684\u95ee\u9898\u3002\\n\\n`HashLoadBalancer`\u4e2d\u7684\u91c7\u7528\u7684\u662f\u52a0\u5bc6\u7684\u5355\u5411MD5\u6563\u5217\u51fd\u6570\uff0c\u8fd9\u4e2ahash\u51fd\u6570\u4f1ahash\u540e\u4ea7\u751f\u4e0d\u53ef\u9884\u671f\u4f46\u786e\u5b9a\u6027\u7684()\u7684\u7ed3\u679c\uff0c\u8f93\u51fa\u4e3a32-bit\u7684\u957f\u6574\u6570\u3002`hash`\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```java\\nprivate static long hash(final String key) {\\n    // md5 byte\\n    MessageDigest md5;\\n    try {\\n        md5 = MessageDigest.getInstance(\\"MD5\\");\\n    } catch (NoSuchAlgorithmException e) {\\n        throw new ShenyuException(\\"MD5 not supported\\", e);\\n    }\\n    md5.reset();\\n    byte[] keyBytes;\\n    keyBytes = key.getBytes(StandardCharsets.UTF_8);\\n    md5.update(keyBytes);\\n    byte[] digest = md5.digest();\\n    // hash code, Truncate to 32-bits\\n    long hashCode = (long) (digest[3] & 0xFF) << 24\\n            | ((long) (digest[2] & 0xFF) << 16)\\n            | ((long) (digest[1] & 0xFF) << 8)\\n            | (digest[0] & 0xFF);\\n    return hashCode & 0xffffffffL;\\n}\\n```\\n\\n\u518d\u770b\u4e00\u4e0b`HashLoadBalancer`\u7684\u9009\u62e9\u51fd\u6570`doSelect()`\u7684\u5b9e\u73b0\uff1a\\n\\n```java\\n    private static final int VIRTUAL_NODE_NUM = 5;\\n\\n    @Override\\n    public Upstream doSelect(final List<Upstream> upstreamList, final String ip) {\\n        final ConcurrentSkipListMap<Long, Upstream> treeMap = new ConcurrentSkipListMap<>();\\n        upstreamList.forEach(upstream -> IntStream.range(0, VIRTUAL_NODE_NUM).forEach(i -> {\\n            long addressHash = hash(\\"SHENYU-\\" + upstream.getUrl() + \\"-HASH-\\" + i);\\n            treeMap.put(addressHash, upstream);\\n        }));\\n        long hash = hash(ip);\\n        SortedMap<Long, Upstream> lastRing = treeMap.tailMap(hash);\\n        if (!lastRing.isEmpty()) {\\n            return lastRing.get(lastRing.firstKey());\\n        }\\n        return treeMap.firstEntry().getValue();\\n    }\\n```\\n\\n\u8fd9\u4e2a\u65b9\u6cd5\u4e2d\uff0c\u751f\u6210\u5e26\u865a\u62df\u670d\u52a1\u5668\u8282\u70b9\u7684hash\u73af\uff0c \u4e00\u4e2a\u5b9e\u9645\u8282\u70b9\u4f1a\u751f\u62105\u4e2a\u865a\u62df\u8282\u70b9\uff0c\u56e0\u6b64\u6574\u4e2ahash\u73af\u7684\u5747\u5300\u6027\u5927\u5927\u589e\u52a0\uff0c\u964d\u4f4e\u6570\u636e\u503e\u659c\u7684\u53d1\u751f\u3002\\n\\n\u4e3a\u4e86\u5b9e\u73b0hash\u73af\u7684\u6709\u5e8f\u6027\u53ca\u987a\u65f6\u9488\u67e5\u627e\u529f\u80fd\uff0c\u4ee3\u7801\u4e2d\u4f7f\u7528Java \u7684[ConcurrentSkipListMap](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html) \u6765\u5b58\u50a8\u5e26\u865a\u62df\u8282\u70b9\u7684\u670d\u52a1\u5668\u8282\u70b9\u53ca\u5176hash\u503c\uff0c \u5b83\u65e2\u80fd\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168\uff0c\u53c8\u80fd\u4fdd\u8bc1\u6570\u636e\u7684\u6709\u5e8f\u6027\uff0c\u652f\u6301\u9ad8\u5e76\u53d1\u3002 \u53e6\u5916\uff0c`ConcurrentSkipListMap`\u63d0\u4f9b\u4e86\u4e00\u4e2a`tailMap(K fromKey)`\u65b9\u6cd5\uff0c\u53ef\u4ece`map`\u4e2d\u67e5\u627e\u6bd4`fromKey`\u5927\u7684\u503c\u7684\u96c6\u5408\uff0c\u4f46\u5e76\u4e0d\u9700\u8981\u904d\u5386\u6574\u4e2a\u6570\u636e\u7ed3\u6784\u3002\\n\\n\u4e0a\u8ff0\u4ee3\u7801\u4e2d\uff0c\u751f\u6210hash\u73af\u4e4b\u540e\uff0c\u5c31\u662f\u8c03\u7528`ConcurrentSkipListMap`\u7684`tailMap()`\u65b9\u6cd5\uff0c\u627e\u5230\u5927\u4e8e\u7b49\u4e8e\u8bf7\u6c42\u7684ip\u7684hash\u503c\u7684\u5b50\u96c6\uff0c\u8fd9\u4e2a\u5b50\u96c6\u7684\u7b2c\u4e00\u4e2a\u5c31\u662f\u8981\u8def\u7531\u7684\u670d\u52a1\u5668\u8282\u70b9\u3002\u91c7\u7528\u4e86\u5408\u9002\u7684\u6570\u636e\u7ed3\u6784\uff0c\u8fd9\u91cc\u7684\u4ee3\u7801\u770b\u4e0a\u53bb\u662f\u4e0d\u662f\u7279\u522b\u7684\u7b80\u6d01\u6d41\u7545\uff1f\\n\\n## RoundRobinLoadBalancer\\n\\nRound-robin\u8f6e\u8be2\u65b9\u6cd5\u7684\u539f\u59cb\u5b9a\u4e49\u662f\u987a\u5e8f\u5faa\u73af\u5c06\u8bf7\u6c42\u4f9d\u6b21\u5faa\u73af\u5730\u8fde\u63a5\u5230\u6bcf\u4e2a\u670d\u52a1\u5668\u3002\u5f53\u67d0\u4e2a\u670d\u52a1\u5668\u53d1\u751f\u6545\u969c\uff08\u4f8b\u5982\uff1a\u4e00\u5206\u949f\u8fde\u63a5\u4e0d\u4e0a\u7684\u670d\u52a1\u5668)\uff0c\u4ece\u5019\u9009\u961f\u5217\u4e2d\u53d6\u51fa\uff0c\u4e0d\u53c2\u4e0e\u4e0b\u4e00\u6b21\u7684\u8f6e\u8be2\uff0c\u76f4\u5230\u5176\u6062\u590d\u6b63\u5e38\u3002\u5728 `RoundRobinLoadBalancer`\u4e2d\u5b9e\u73b0\u7684\u662f\u7ec4\u5185\u52a0\u6743\u8f6e\u8be2\uff08`Weight Round Robin per-packet`)\u65b9\u6cd5\uff1a\\n\\n\u4e3a\u4e86\u8ba1\u7b97\u548c\u5b58\u50a8\u6bcf\u4e2a\u670d\u52a1\u5668\u8282\u70b9\u7684\u8f6e\u8be2\u6b21\u6570\uff0c\u5728\u8fd9\u4e2a\u7c7b\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u9759\u6001\u5185\u90e8\u7c7b`WeigthRoundRobin`\uff0c\u6211\u4eec\u5148\u770b\u4e00\u4e0b\u5b83\u7684\u4e3b\u8981\u4ee3\u7801\uff08\u53bb\u6389\u4e86\u6ce8\u91ca\uff09\uff1a\\n\\n```java\\nprotected static class WeightedRoundRobin {\\n\\n    private int weight;\\n    \\n    private final AtomicLong current = new AtomicLong(0);\\n\\n    private long lastUpdate;\\n\\n    void setWeight(final int weight) {\\n        this.weight = weight;\\n        current.set(0);\\n    }\\n    long increaseCurrent() {\\n        return current.addAndGet(weight);\\n    }\\n\\n    void sel(final int total) {\\n        current.addAndGet(-1 * total);\\n    }\\n    void setLastUpdate(final long lastUpdate) {\\n        this.lastUpdate = lastUpdate;\\n    }\\n}\\n```\\n\\n\u8bf7\u91cd\u70b9\u5173\u6ce8\u8fd9\u51e0\u4e2a\u65b9\u6cd5\uff1a\\n\\n- `setWeight(final int weight)` \uff0c\u4e3a\u5bf9\u8c61\u8bbe\u5b9a\u6743\u91cd\uff0c\u5e76\u5c06current\u91cd\u7f6e\u4e3a0.\\n\\n- `increaseCurrent()` : \u5bf9`AtomicLong`\u7c7b\u578b\u7684\u5bf9\u8c61`current`\uff0c\u7d2f\u52a0\u5176\u6743\u91cd\u503c\u3002\\n\\n- `sel(final int total)`:   `current`\u51cf\u53bb\u4f20\u5165\u7684 `total`\u503c\u3002\\n\\n\u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e0b\u5e26\u6743\u91cd\u7684\u8f6e\u8be2\u8fc7\u7a0b\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002\\n\u9996\u5148\u5b9a\u4e49\u4e86\u4e00\u4e2a`ConcurrentMap`\u7c7b\u578b\u5bf9\u8c61`methodWeightMap` \u4e24\u5c42\u5bf9\u8c61\u6765\u5b58\u50a8\u670d\u52a1\u5668\u5217\u8868\u4e0e\u5176\u5404\u4e2a\u660e\u7ec6\u8282\u70b9\u7684\u8f6e\u8be2\u8d44\u6599\u3002\\n\\n```java\\nprivate final ConcurrentMap<String, ConcurrentMap<String, WeightedRoundRobin>> methodWeightMap = new ConcurrentHashMap<>(16);\\n```\\n\\n\u8fd9\u4e2amap\u5bf9\u8c61\u7b2c\u4e00\u5c42\u7684key\u4e3a\u5f53\u524d\u670d\u52a1\u5668\u5217\u8868\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684`upstreamUrl`,  \u7b2c\u4e8c\u4e2a\u5bf9\u8c61`ConcurrentMap<String, WeightedRoundRobin>`\u5b58\u50a8\u4e86\u7ec4\u5185\u5404\u4e2a\u670d\u52a1\u5668\u8282\u70b9\u7684\u8f6e\u8be2\u60c5\u51b5\uff0c\u5185\u5c42Map\u7684key\u4e3a\u7ec4\u5185\u6bcf\u4e2a\u670d\u52a1\u5668\u7684`upstreamUrl`\u3002`Map`\u5bf9\u8c61\u4f7f\u7528`JUC`\u7684`ConcurrentHashMap`\uff0c\u4e0d\u4ec5\u5b58\u53d6\u9ad8\u6548\uff0c\u800c\u4e14\u7ebf\u7a0b\u5b89\u5168\uff0c\u652f\u6301\u9ad8\u5e76\u53d1\u3002\\n\\n\u5185\u5c42map\u7684\u6bcf\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684`WeighedRoundRobin`\u4f5c\u4e3a\u9759\u6001\u5185\u90e8\u7c7b\u80fd\u786e\u4fdd\u7ebf\u7a0b\u5b89\u5168\uff0c\u5e76\u5b9e\u73b0\u7ec4\u5185\u7684\u52a0\u6743\u8f6e\u8be2\u9009\u62e9\u529f\u80fd\u3002\u4e0b\u9762\u662f\u8fd9\u4e2a\u7c7b\u7684`doSelect()`\u65b9\u6cd5\u7684\u4ee3\u7801\u3002\\n\\n```java\\n@Override\\npublic Upstream doSelect(final List<Upstream> upstreamList, final String ip) {\\n    String key = upstreamList.get(0).getUrl();\\n    ConcurrentMap<String, WeightedRoundRobin> map = methodWeightMap.get(key);\\n    if (Objects.isNull(map)) {\\n        methodWeightMap.putIfAbsent(key, new ConcurrentHashMap<>(16));\\n        map = methodWeightMap.get(key);\\n    }\\n    int totalWeight = 0;\\n    long maxCurrent = Long.MIN_VALUE;\\n    long now = System.currentTimeMillis();\\n    Upstream selectedInvoker = null;\\n    WeightedRoundRobin selectedWeightedRoundRobin = null;\\n    for (Upstream upstream : upstreamList) {\\n        String rKey = upstream.getUrl();\\n        WeightedRoundRobin weightedRoundRobin = map.get(rKey);\\n        int weight = getWeight(upstream);\\n        if (Objects.isNull(weightedRoundRobin)) {\\n            weightedRoundRobin = new WeightedRoundRobin();\\n            weightedRoundRobin.setWeight(weight);\\n            map.putIfAbsent(rKey, weightedRoundRobin);\\n        }\\n        if (weight != weightedRoundRobin.getWeight()) {\\n            // weight changed.\\n            weightedRoundRobin.setWeight(weight);\\n        }\\n        long cur = weightedRoundRobin.increaseCurrent();\\n        weightedRoundRobin.setLastUpdate(now);\\n        if (cur > maxCurrent) {\\n            maxCurrent = cur;\\n            selectedInvoker = upstream;\\n            selectedWeightedRoundRobin = weightedRoundRobin;\\n        }\\n        totalWeight += weight;\\n    }\\n    ......  //erase the section which handles the time-out upstreams. \\n    if (selectedInvoker != null) {\\n        selectedWeightedRoundRobin.sel(totalWeight);\\n        return selectedInvoker;\\n    }\\n    // should not happen here\\n    return upstreamList.get(0);\\n}\\n```\\n\\n\u4e3e\u4f8b\uff0c\u82e5\u670d\u52a1\u5668\u7ec4`upstreamUrl` \u5206\u522b\u4e3a\uff1a LIST = [upstream-20, upstream-50, upstream-30]\u65f6\uff0c\u7ecf\u8fc7\u4e00\u8f6e\u6267\u884c\u540e\uff0c\u5efa\u7acb\u7684`methodWeightMap` \u8d44\u6599\u5982\u4e0b\uff1a\\n\\n![methodWeightMap](/img/activities/code-analysis-loadbalance-spi/methodWeightMap.png)\\n\\n\u5047\u8bbe\u4e0a\u8ff0\u7684LIST\u4e2d\uff0c\u5404\u4e2a\u670d\u52a1\u5668\u8282\u70b9\u7684\u6743\u91cd\u6570\u7ec4\u4e3a: [20,50,30], \u4e0b\u56fe\u662f\u5185\u90e8\u7c7bcurrent \u503c\u53d8\u5316\u548c\u8f6e\u8be2\u9009\u62e9\u8fc7\u7a0b\uff1a\\n\\n![weighted-roundrobin-demo](/img/activities/code-analysis-loadbalance-spi/weighted-roundrobin-demo.png)\\n\\n\u6bcf\u4e00\u8f6e\uff0c\u9009\u62e9\u503ccurrent\u6700\u5927\u7684\u670d\u52a1\u5668\u8282\u70b9\uff1a\\n\\n- Round1:\\n  - \u5bf9\u5f53\u524d\u670d\u52a1\u5668LIST\u505a\u904d\u5386\uff0c\u5f53\u670d\u52a1\u5668\u8282\u70b9\u7684weightedRoundRobin \u4e3anull\u65f6\uff0ccurrent\u88ab\u7f6e\u4e3a\u5404\u81ea\u7684\u6743\u91cd\uff1b \u4e0d\u4e3anull\u65f6\uff0c\u7d2f\u52a0\u5404\u81ea\u7684\u6743\u91cd\u3002\\n  - \u5373\uff1a\u904d\u5386\u540ecurrent \u5206\u522b\u4e3a [20, 50,30] \uff0c \u4f1a\u9009\u62e9Stream-50, Stream-50\u5bf9\u5e94\u7684WeightRoundRobin\u9759\u6001\u7c7b\u505a sel(-total)\u5904\u7406\uff0ccurrent \u66f4\u65b0\u4e3a[20,-50, 30].\\n- Round 2  \u904d\u5386\u540e\u7684current\u662f[40,0,60],  \u4f1a\u9009\u62e9Stream-30\uff0c current\u5206\u522b\u66f4\u65b0\u4e3a[40,0,-40].\\n- Round 3  \u904d\u5386\u540e\u7684current\u662f[60,50,-10],  \u4f1a\u9009\u62e9Stream-20\uff0ccurrent\u5206\u522b\u66f4\u65b0\u4e3a[-40,50,-10].\\n\\n\u4e2d\u95f4\u8fdb\u884c\u4e86\u5bb9\u9519\u5904\u7406\uff0c \u5f53\u670d\u52a1\u5668\u7684\u4e2a\u6570\u4e0emap\u4e2a\u6570\u4e0d\u4e00\u6837\uff0c\u5c31\u5bf9methodWeightMap \u52a0\u9501\u505a\u5904\u7406\u3002 \u7528\u5148copy \u540emodify\u7684\u65b9\u5f0f\uff0c \u628a\u8d85\u65f6\u7684\u670d\u52a1\u5668remove\u6389\uff0c\u5373\u79fb\u9664\u6389\u53d1\u751f\u6545\u969c\u7684\u670d\u52a1\u5668\uff0c\u5e76\u66f4\u65b0Map\u8d44\u6599\u3002\u5982\u4e0b\u662f\u5f02\u5e38\u65f6\u7684\u5904\u7406\u4ee3\u7801\uff1a\\n\\n```Java\\n    if (!updateLock.get() && upstreamList.size() != map.size() && updateLock.compareAndSet(false, true)) {\\n        try {\\n            // copy -> modify -> update reference.\\n            ConcurrentMap<String, WeightedRoundRobin> newMap = new ConcurrentHashMap<>(map);\\n            newMap.entrySet().removeIf(item -> now - item.getValue().getLastUpdate() > recyclePeriod);\\n            methodWeightMap.put(key, newMap);\\n        } finally {\\n            updateLock.set(false);\\n        }\\n    }\\n    if (Objects.nonNull(selectedInvoker)) {\\n        selectedWeightedRoundRobin.sel(totalWeight);\\n        return selectedInvoker;\\n    }\\n    // should not happen here.\\n    return upstreamList.get(0);\\n```\\n\\n## LoadBalancerFactory\\n\\n\u5728\u8fd9\u4e2a\u5de5\u5382\u7c7b\u4e2d\uff0c\u63d0\u4f9b\u4e86\u8c03\u7528`LoadBalancer`\u7684\u9759\u6001\u65b9\u6cd5, \u5176\u4e2d`ExtensionLoader` \u662f`Apache Shenyu`\u7684`SPI`\u6267\u884c\u5165\u53e3\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cLoadBalancer\u6a21\u7ec4\u662f\u53ef\u914d\u7f6e\u3001\u53ef\u6269\u5c55\u7684\u3002\u8fd9\u4e2a\u9759\u6001\u65b9\u6cd5\u4e2d\u7684`algorithm`\u53d8\u91cf\u662f`LoadBalanceEnum`\u4e2d\u5b9a\u4e49`name`\u679a\u4e3e\u7c7b\u578b\u3002\\n\\n```java\\n/**\\n * Selector upstream.\\n *\\n * @param upstreamList the upstream list\\n * @param algorithm    the loadBalance algorithm\\n * @param ip           the ip\\n * @return the upstream\\n */\\npublic static Upstream selector(final List<Upstream> upstreamList, final String algorithm, final String ip) {\\n    LoadBalancer loadBalance = ExtensionLoader.getExtensionLoader(LoadBalancer.class).getJoin(algorithm);\\n    return loadBalance.select(upstreamList, ip);\\n}\\n```\\n\\n## Using of LoadBalancer module\\n\\n\u4e0a\u9762\u8bf4\u660e\u4e86`LoadBalancer` SPI\u63a5\u53e3\u53ca\u4e09\u4e2a\u5b9e\u4f5c\u7c7b\u3002\u4e0b\u9762\u770b\u4e00\u4e0b`LoadBalancer`\u5728`Apache Shenyu`\u4e2d\u662f\u5982\u4f55\u88ab\u8c03\u7528\u7684\u3002`DividePlugin`\u662f\u8def\u7531\u9009\u62e9\u63d2\u4ef6\uff0c\u6240\u6709\u7684Http\u8bf7\u6c42\u90fd\u7531\u8be5\u63d2\u4ef6\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u5904\u7406\u3002\u5f53\u8bf7\u6c42\u5934rpcType = http, \u4e14\u5f00\u542f\u8be5\u63d2\u4ef6\u65f6\uff0c\u5b83\u5c06\u6839\u636e\u8bf7\u6c42\u53c2\u6570\u5339\u914d\u89c4\u5219\uff0c\u6700\u7ec8\u4ea4\u7531\u4e0b\u6e38\u63d2\u4ef6\u8fdb\u884c\u54cd\u5e94\u5f0f\u4ee3\u7406\u8c03\u7528\u3002\\n\\n\u5728`DividePlugin`\u7684`doExecute`\u65b9\u6cd5\u4e2d\uff0c\u5148\u5bf9\u8981\u8f6c\u53d1\u7684\u8bf7\u6c42\u7684Header\u5927\u5c0f\u3001content\u957f\u5ea6\u7b49\u505a\u6821\u9a8c\uff0c\\n\\n```java\\n@Override\\nprotected Mono<Void> doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {\\n   ......\\n}\\n```\\n\\n\u63a5\u53e3\u65b9\u6cd5\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f`ShenyuPluginChain` \u7c7b\u578b\uff0c\u4ee3\u8868`plugin`\u7684\u8c03\u7528\u94fe\uff0c\u5177\u4f53\u53ef\u53c2\u89c1`Apache Sheyu` \u7684`plugin`\u7684\u8c03\u7528\u673a\u5236\u3002\u7b2c\u4e09\u4e2a`SelectorData`\u7c7b\u578b\u7684\u53c2\u6570\u662f\u9009\u62e9\u5668\uff0c \u7b2c\u56db\u4e2a\u662f`RuldData`\u7c7b\u578b\uff0c\u4ee3\u8868\u89c4\u5219\u3002\u5206\u522b\u8bf7\u67e5\u770b\u5bf9\u5e94\u7684\u4ee3\u7801\u3002\\n\\n \u4e0b\u9762\u7ed9\u51fa\u4e86`doExecute`()\u65b9\u6cd5\u4e2d\uff0c\u6709\u5173`LoadBalancer`\u8c03\u7528\u7684\u4ee3\u7801\u7247\u6bb5\uff1a\\n\\n```java\\n   //\u53d6\u5230\u8981\u8def\u7531\u7684\u670d\u52a1\u5668\u8282\u70b9\u5217\u8868\u3002\\n   List<Upstream> upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());\\n    ... \\n    //\u53d6\u5230\u8bf7\u6c42\u7684ip\\n    String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();\\n\\n    //\u8c03\u7528Util\u65b9\u6cd5\uff0c\u6267\u884cLoadBalancer\u5904\u7406\\n    Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);\\n```\\n\\n  \u8fd9\u91cc`UpstreamCacheManager` \u662f\u7f13\u5b58\u7684\u8981\u8def\u7531\u7684\u670d\u52a1\u5668\u8282\u70b9 \uff0c `ruleHandle.getLoadBalance()`\u53d6\u5230\u7684\u662f`LoadBalanceEnum`\u5b9a\u4e49\u7684\u679a\u4e3ename, \u5982`random, hash, roundRobin`\u7b49.\\n\\n  \u7ecf\u8fc7\u5c01\u88c5\uff0c\u8c03\u7528\u8d1f\u8f7d\u5747\u8861\u529f\u80fd\u975e\u5e38\u7684\u65b9\u4fbf\u3002  \u672a\u6765\u589e\u52a0\u65b0\u7684`LoadBalancer`\u7c7b\uff0c\u8fd9\u4e9b\u8c03\u7528\u7684`Plugin`\u4ee3\u7801\u5b8c\u5168\u4e0d\u9700\u8981\u53d8\u66f4\u3002\\n\\n## Summary\\n\\n\u7ecf\u8fc7\u4e0a\u9762\u7684\u4ee3\u7801\u89e3\u8bfb\uff0c\u4ece\u8bbe\u8ba1\u89d2\u5ea6\u603b\u7ed3`LoadBalancer` \u6a21\u7ec4\u5177\u6709\u5982\u4e0b\u7684\u7279\u70b9\uff1a\\n\\n1. \u53ef\u6269\u5c55\u6027\uff1a\u9762\u5411\u63a5\u53e3\u7684\u8bbe\u8ba1\uff0c\u53ca\u57fa\u4e8eApache Shenyu SPI\u7684\u5b9e\u73b0\uff0c\u4f7f\u5f97\u7cfb\u7edf\u5177\u6709\u826f\u597d\u7684\u53ef\u6269\u5c55\u6027\u3002\u53ef\u4ee5\u65b9\u4fbf\u7684\u6269\u5c55\u4e3a\u5176\u4ed6\u7684\u52a8\u6001\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u5982\u6700\u5c11\u8fde\u63a5\u65b9\u5f0f(least connection)\u3001\u6700\u5feb\u6a21\u5f0f( fastest)\u3002\u5e76\u652f\u6301\u96c6\u7fa4\u5904\u7406\uff0c\u5177\u6709\u826f\u597d\u7684\u53ef\u6269\u5c55\u6027\u3002\\n2. \u53ef\u4f38\u7f29\u6027\uff1a\u91c7\u7528\u7684\u4e00\u81f4\u6027hash\u3001\u6743\u91cd\u968f\u673a\u548c\u6743\u91cd\u8f6e\u8be2\u7b97\u6cd5\uff0c\u90fd\u53ef\u4ee5\u65e0\u7f1d\u652f\u6301\u96c6\u7fa4\u6269\u5bb9\u6216\u7f29\u5bb9\u3002\\n\\n3. \u6d41\u91cf\u9884\u70ed\u7b49\u66f4\u7ec6\u81f4\u7684\u8bbe\u8ba1\uff0c\u80fd\u5e26\u6765\u6574\u4f53\u4e0a\u66f4\u4e3a\u5e73\u6ed1\u7684\u8d1f\u8f7d\u5747\u8861\u3002"},{"id":"/SPI-SourceCode-Analysis-MatchStrategy-SPI","metadata":{"permalink":"/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-MatchStrategy-SPI.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-MatchStrategy-SPI.md","title":"MatchStrategy--\u57fa\u4e8eSPI\u7684\u4ee3\u7801\u5206\u6790","description":"Apache Shenyu \u7f51\u5173\u7684\u5404\u4e2aPlugin\uff08\u5305\u62ecDubbo, gRPC,Spring-cloud\u7b49) \u4e2d\uff0crouting\u53c2\u6570\u5747\u8bbe\u8ba1\u4e3a\u53ef\u4ee5\u63a5\u53d7\u591a\u4e2a\u6761\u4ef6\u7684\u7ec4\u5408\u3002 \u4e3a\u4e86\u5b9e\u73b0\u8fd9\u6837\u7684\u76ee\u7684\uff0c\u9075\u5faa\u5176SPI\u7684\u673a\u5236\u8fdb\u884c\u5c06\u53c2\u6570\u53ca\u884c\u4e3a\u62bd\u8c61\u4e3a\u5982\u4e0b\u4e09\u90e8\u5206\uff0c\u8fd9\u4e9bSPI \u5728shenyu-plugin-base\u6a21\u7ec4\u4e2d\u5b9e\u73b0","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"SPI","permalink":"/zh/blog/tags/spi"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":6.145,"hasTruncateMarker":false,"authors":[{"name":"Huihui Yin","title":"Apache ShenYu Contributor"}],"frontMatter":{"title":"MatchStrategy--\u57fa\u4e8eSPI\u7684\u4ee3\u7801\u5206\u6790","author":"Huihui Yin","author_title":"Apache ShenYu Contributor","categories":"Apache ShenYu","tags":["SPI","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"LoadBalancer SPI \u4ee3\u7801\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI"},"nextItem":{"title":"PredicateJudge-- \u57fa\u4e8eSPI\u7684\u8bbe\u8ba1\u5b9e\u73b0\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI"}},"content":"`Apache Shenyu` \u7f51\u5173\u7684\u5404\u4e2a`Plugin`\uff08\u5305\u62ec`Dubbo`, `gRPC`,`Spring-cloud`\u7b49) \u4e2d\uff0c`routing`\u53c2\u6570\u5747\u8bbe\u8ba1\u4e3a\u53ef\u4ee5\u63a5\u53d7\u591a\u4e2a\u6761\u4ef6\u7684\u7ec4\u5408\u3002 \u4e3a\u4e86\u5b9e\u73b0\u8fd9\u6837\u7684\u76ee\u7684\uff0c\u9075\u5faa\u5176`SPI`\u7684\u673a\u5236\u8fdb\u884c\u5c06\u53c2\u6570\u53ca\u884c\u4e3a\u62bd\u8c61\u4e3a\u5982\u4e0b\u4e09\u90e8\u5206\uff0c\u8fd9\u4e9b`SPI` \u5728***shenyu-plugin-base***\u6a21\u7ec4\u4e2d\u5b9e\u73b0\\n\\n- `ParameterData`-\u53c2\u6570\u8d44\u6599\\n- `PredictJudge`-\u65ad\u8a00\\n- `MatchStrategy`-\u5339\u914d\u7b56\u7565\\n\\n\u76f8\u5bf9\u800c\u8a00\uff0c\u5339\u914d\u7b56\u7565\u662f\u9700\u8981\u6269\u5c55\u70b9\u6700\u5c11\u7684\u90e8\u5206\u3002\u60f3\u8c61\u4e00\u4e0b\uff0c\u5bf9\u591a\u4e2a\u6761\u4ef6\u7684\u7ec4\u5408\u5224\u65ad\uff0c\u6700\u5e38\u89c1\u7684\u51e0\u79cd\u89c4\u5219\u662f\uff1a\u5168\u90e8\u90fd\u6ee1\u8db3\u3001\u81f3\u5c11\u6ee1\u8db3\u4e00\u4e2a\u6761\u4ef6\u3001\u81f3\u5c11\u6ee1\u8db3\u7b2c\u4e00\u4e2a\uff0c\u6216\u8005\u5927\u90e8\u5206\u6ee1\u8db3\u7b49\u7b49\u3002 \u5e76\u4e14\u8981\u505a\u5230\u5bf9\u5404\u79cd`plugin`\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u53c2\u6570\uff0c\u5982`IP`, `header`, `uri`\u7b49\u3002\u9488\u5bf9\u8fd9\u4e9b\u9700\u6c42\uff0c\u5982\u4f55\u5c06`MatchStrategy`\u8bbe\u8ba1\u5f97\u7b80\u5355\u6613\u7528\u4e14\u5bb9\u6613\u6269\u5c55\uff1f\\n\\n## MatchStrategy\\n\\n`MatchStrategy`\u7684\u5b9e\u73b0\u4ee3\u7801\u5728***shenyu-plugin-base***\u6a21\u7ec4\u4e2d\uff0c\u57fa\u4e8e`Apache Shenyu`\u7684`SPI`\u521b\u5efa\u673a\u5236\uff0c \u8bbe\u8ba1\u4e0a\u7ed3\u5408\u4e86\u5de5\u5382\u6a21\u5f0f\u548c\u7b56\u7565\u6a21\u5f0f\uff0c\u6574\u4f53`MatchStrategy`\u7684\u8bbe\u8ba1\u7c7b\u56fe\u5982\u4e0b\u4e0b\uff1a\\n\\n![MatchStrategy-class-diagram](/img/activities/code-analysis-matchstrategy-spi/MatchStrategy-class-diagram.PNG)\\n\\n\u4ee5\u63a5\u53e3`MatchStrategy`\u4e3a\u57fa\u7840\uff0c\u8bbe\u8ba1\u5b9e\u73b0\u7c7b\uff0c\u5e76\u7531\u62bd\u8c61\u7c7b`AbstractMatchStrategy`\u5b9e\u73b0\u516c\u5171\u65b9\u6cd5\uff0c\u7531\u5de5\u5382\u7c7b`MatchStrategyFactory`\u63d0\u4f9b\u521b\u5efa\u548c\u5916\u90e8\u8c03\u7528\u529f\u80fd\u3002\\n\\n## MatchStrategy Interface\\n\\n\u9996\u5148\u6765\u770b`MatchStrategy` `SPI`\u63a5\u53e3\u7684\u5b9a\u4e49\uff1a\\n\\n```java\\n@SPI\\npublic interface MatchStrategy {\\n\\n    Boolean match(List<ConditionData> conditionDataList, ServerWebExchange exchange);\\n}\\n```\\n\\n@`SPI` `annotation`\u4ee3\u8868\u8fd9\u662f\u4e00\u4e2a`SPI`\u63a5\u53e3\u3002`ServerWebExchange` \u662f `org.springframework.web.server.ServerWebExchange` ,\u4ee3\u8868`HTTP`\u7684 `request-response`  \u7684\u4ea4\u4e92\u5185\u5bb9\u3002`ConditionData`\u7684\u4ee3\u7801\u5982\u4e0b\uff0c\u66f4\u591a\u8bf4\u660e\u53ef\u4ee5\u53c2\u8003`PredicateJudge`[\u4ee3\u7801\u5206\u6790](https://shenyu.apache.org/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI/)\u4e2d\u7684\u8bf4\u660e\uff0c\\n\\n```java\\npublic class ConditionData {\\n\\n    private String paramType;\\n    private String operator;\\n\\n    private String paramName;\\n    private String paramValue;\\n}\\n```\\n\\n## AbstractMatchStrategy\\n\\n\u5728\u62bd\u8c61\u7c7b`AbstractMatchStrategy`\u4e2d\uff0c\u5b9a\u4e49`MatchStrategy`\u7684\u516c\u5171\u65b9\u6cd5\uff0c \u7528`buildRealData`\u65b9\u6cd5\u4e2d\uff0c\u7528`ParameterData`\u5de5\u5382\u7c7b`ParameterDataFactory`\uff0c\u5c06\u591a\u79cd\u53c2\u6570\u5982  `Ip`, `Cookie`, `Header`,`uri`\u7b49\u8d44\u6599\u90fd\u4ee5\u7edf\u4e00\u7684\u63a5\u53e3\u65b9\u6cd5\u6765\u5448\u73b0\u3002\u8fd9\u4e9b\u53c2\u6570\u683c\u5f0f\u53ca\u89c4\u5219\u7684\u4fee\u6539\uff0c\u4e0d\u4f1a\u5f71\u54cd\u5230\u5bf9\u53c2\u6570\u89c4\u5219\u5339\u914d`MatchStrategy`\u7684\u8c03\u7528\u3002\\n\\n```java\\npublic abstract class AbstractMatchStrategy {\\n\\n    public String buildRealData(final ConditionData condition, final ServerWebExchange exchange) {\\n        return ParameterDataFactory.builderData(condition.getParamType(), condition.getParamName(), exchange);\\n    }\\n}\\n```\\n\\n## \u5b9e\u73b0\u7c7b\u53caProfile\\n\\n\u57fa\u4e8e\u4e0a\u8ff0\u63a5\u53e3\u5b9a\u4e49, ***shenyu-plugin-base*** \u6a21\u7ec4\u63d0\u4f9b\u4e86\u4e24\u4e2a`MatchStrategy`\u5b9e\u73b0\u7c7b\\n\\n- `AndMatchStrategy`-\u591a\u4e2a\u6761\u4ef6 AND\\n\\n- `OrMatchStrategy`- \u591a\u4e2a\u6761\u4ef6 OR\\n\\n  \u5e76\u5728`SHENYU_DIRECTORY`\u76ee\u5f55\u4e0b\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5bf9\u5b9e\u4f5c\u7c7b\u505a\u4e86\u914d\u7f6e\u3002\u5728\u7cfb\u7edf\u542f\u52a8\u65f6\u4f1a\u7531\u9876\u5c42`SPI`\u4ee5`key-value`\u5f62\u5f0f\u52a0\u8f7d\u5e76`cache`\u8d77\u6765\u3002\\n\\n```properties\\nand=org.apache.shenyu.plugin.base.condition.strategy.AndMatchStrategy\\nor=org.apache.shenyu.plugin.base.condition.strategy.OrMatchStrategy\\n```\\n\\n \u4e24\u4e2a\u5b9e\u73b0\u7c7b`AndMatchStrategy` \u7ee7\u627f`AbstractMatchStrategy` \u5e76\u5b9e\u505a\u4e86`MatchStrategy`\u3002\\n\\n### AndMatchStrategy-  \u201c\u4e0e\u201d\u7684\u5173\u7cfb\\n\\n  \u7531\u4e8e`PredicateJudge`\u5c01\u88c5\u4e86\u6761\u4ef6\u5224\u65ad\u7684\u591a\u6837\u6027\uff0c`ConditionData`\u548c`ParameData`\u5c01\u88c5\u4e86\u591a\u79cd\u53c2\u6570\u3002\u90a3\u4e48\u5bf9\u4e8e\u591a\u4e2a\u6761\u4ef6\u7684\u5339\u914d\u6765\u8bf4\uff0c\u91c7\u7528`Stream`\u6d41\u5904\u7406\u53ca`lamda`\u8868\u8fbe\u5f0f\uff0c\u975e\u5e38\u7b80\u6d01\u9ad8\u6548\u8fbe\u6210\u4e86\uff1a\u5168\u90e8\u6761\u4ef6\u90fd\u6ee1\u8db3\uff0c\u5373\\"AND\\"\u7684\u903b\u8f91\u3002\\n\\n```java\\n@Join\\npublic class AndMatchStrategy extends AbstractMatchStrategy implements MatchStrategy {\\n\\n    @Override\\n    public Boolean match(final List<ConditionData> conditionDataList, final ServerWebExchange exchange) {\\n        return conditionDataList\\n                .stream()\\n                .allMatch(condition -> PredicateJudgeFactory.judge(condition, buildRealData(condition, exchange)));\\n    }\\n}\\n```\\n\\n`OrMatchStrategy`\u662f\u540c\u6837\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u5b9e\u73b0: \u81f3\u5c11\u6ee1\u8db3\u4e00\u4e2a\u6761\u4ef6\\"OR\\"\u7684\u89c4\u5219\uff0c\u5728\u6b64\u4e0d\u505a\u8d58\u8ff0\u3002\\n\\n## MatchStrategyFactory\\n\\n\u8fd9\u662f`MatchStrategy`\u7684\u5de5\u5382\u7c7b\uff0c\u5b9e\u73b0\u4e86\u4e24\u4e2a\u65b9\u6cd5\uff0c\u4e00\u4e2a\u662f`newInstance()`\u65b9\u6cd5\u6839\u636e\u7b56\u7565\u4ee3\u7801\u548c\u540d\u79f0\uff0c\u8fd4\u56de\u7531`SPI` `ExtensionLoader`\u6309key\u6765\u52a0\u8f7d\u5bf9\u5e94\u7684`MatchStrategy`\u5b9e\u73b0\u7c7b\u3002\\n\\n```java\\n    public static MatchStrategy newInstance(final Integer strategy) {\\n        String matchMode = MatchModeEnum.getMatchModeByCode(strategy);\\n        return ExtensionLoader.getExtensionLoader(MatchStrategy.class).getJoin(matchMode);\\n    }\\n```\\n\\n\u5728`MatchModeEnum` \u4e2d\u5b9a\u4e49\u4e86match\u7b56\u7565\u7684code\u548cname\u3002 \u8c03\u7528\u65f6\u7531\u7b56\u7565\u540d\u79f0\uff0c\u5982\\"and\\",\\"or\\"\uff0c\u6839\u636e\u542f\u52a8\u65f6SPI\u52a0\u8f7d\u7684key-value\u8d44\u6599\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u5b9e\u73b0\u7c7b\uff1a\\n\\n```java\\nAND(0, \\"and\\"),  \\nOR(1, \\"or\\");\\n```\\n\\n\u53e6\u4e00\u4e2a\u662f`match()`\u65b9\u6cd5\uff0c\u8c03\u7528\u5b9e\u4f5c\u7c7b\u7684`match`\u65b9\u6cd5\u3002\\n\\n```java\\n    public static boolean match(final Integer strategy, final List<ConditionData> conditionDataList, final ServerWebExchange exchange) {\\n        return newInstance(strategy).match(conditionDataList, exchange);\\n    }\\n```\\n\\n## \u8c03\u7528\u65b9\u5f0f\\n\\n\u5728`shenyu-plugin`\u6a21\u7ec4\u7684\u5404\u4e2a`plugin`\u7684\u57fa\u7c7b`AbstractShenyuPlugin` \u4e2d\uff0c\u5b9a\u4e49\u4e86\u4e24\u4e2a\u9009\u62e9\u7684\u65b9\u6cd5\uff1a`filterSelector` \u548c`filterRule` \u5b83\u4eec\u90fd\u8c03\u7528\u4e86`MatchStrategyFactory` \u65b9\u6cd5\uff0c\u4e0b\u9762\u662f`AbstractShenyuPlugin`\u4e2d`filterSelector`\u65b9\u6cd5\u7684\u4ee3\u7801\uff1a\\n\\n```java\\n    private Boolean filterSelector(final SelectorData selector, final ServerWebExchange exchange) {        if (selector.getType() == SelectorTypeEnum.CUSTOM_FLOW.getCode()) {            if (CollectionUtils.isEmpty(selector.getConditionList())) {                return false;            }            return MatchStrategyFactory.match(selector.getMatchMode(), selector.getConditionList(), exchange);        }        return true;    }\\n```\\n\\n\u8fd9\u6bb5\u4ee3\u7801\u4e2d\uff0c\u5148\u68c0\u6d4b\u53c2\u6570\u5339\u914d\u6761\u4ef6`SelectorData`\u662f\u5426\u4e3a\u7a7a\uff0c\u4e4b\u540e\u8c03\u7528`MatchStrategyFactory`\u7684`match`\u65b9\u6cd5\uff0c\u5de5\u5382\u65b9\u6cd5\u5c06\u8c03\u7528\u5bf9\u5e94\u7684\u5b9e\u4f5c\u7c7b\u7684`match`\u65b9\u6cd5\u3002\u540c\u7406\uff0c\u5982\u4e0b\u662f`AbstractShenyuPlugin`\u4e2d `filterRule` \u65b9\u6cd5\\n\\n```java\\n    private Boolean filterRule(final RuleData ruleData, final ServerWebExchange exchange) {        return ruleData.getEnabled() && MatchStrategyFactory.match(ruleData.getMatchMode(), ruleData.getConditionDataList(), exchange);    }\\n```\\n\\n\u4e5f\u540c\u6837\u662f\u8c03\u7528`MatchStrategyFactory`\u7684`match`\u65b9\u6cd5\uff0c\u770b\u4e0a\u53bb\u662f\u4e0d\u662f\u7279\u522b\u7684\u7b80\u6d01\u751a\u81f3\u662f\u7b80\u5355\uff1f \u5728`PredicteJudge`\u7684[\u4ee3\u7801\u5206\u6790](https://shenyu.apache.org/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI/)\u6587\u4e2d\uff0c\u5bf9`shenyu-plugin`\u5982\u4f55\u505a\u53c2\u6570\u8c03\u7528\u65b9\u9762\u505a\u4e86\u66f4\u8fdb\u4e00\u6b65\u7684\u63cf\u8ff0\u3002\\n\\n## Summary\\n\\n\u7531\u4e8e\u5e94\u7528\u4e86`Apache shenyu`\u7684`SPI`\u6846\u67b6\uff0c\u4f7f\u5f97\u6574\u4f53\u4e0a\u5177\u6709\u677e\u8026\u5408\u3001\u6613\u4e8e\u6269\u5c55\u7684\u7279\u70b9\u3002\u5728\u591a\u4e2a\u53c2\u6570\u89c4\u5219\u7b56\u7565\u65b9\u9762\uff0c`MatchStrategy`\u63d0\u4f9b\u4e86\u826f\u597d\u7684\u8bbe\u8ba1\uff0c\u867d\u7136\u76ee\u524d\u53ea\u63d0\u4f9b\u4e86\u4e24\u4e2aAND \u548cOR\u7684\u5b9e\u73b0\u7c7b\uff0c\u4f46\u672a\u6765\u53ef\u4ee5\u5f88\u8f7b\u677e\u5730\u6269\u5c55\u4e3a\u66f4\u591a`MatchStrategy`\u89c4\u5219\uff0c\u4f8b\u5982 `firstOf`\uff1a\u5373\u5fc5\u987b\u6ee1\u8db3\u7b2c\u4e00\u4e2a\u6761\u4ef6\uff0c\u6216`mostOf`-\u6ee1\u8db3\u5927\u90e8\u5206\u6761\u4ef6\u7b49\u66f4\u591a\u590d\u6742\u7b56\u7565\uff0c\u800c\u5176\u4ed6\u8c03\u7528\u90e8\u5206\u7684\u4ee3\u7801\u5b8c\u5168\u4e0d\u53d7\u5f71\u54cd\u3002 \\n\\n\u6709\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u53bb\u9605\u8bfb`Shenyu plugin`\u7684\u6e90\u7801\u4e86\u89e3\u66f4\u591a\u5185\u5bb9\u3002"},{"id":"/SPI-SourceCode-Analysis-PredicateJudge-SPI","metadata":{"permalink":"/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-PredicateJudge-SPI.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-PredicateJudge-SPI.md","title":"PredicateJudge-- \u57fa\u4e8eSPI\u7684\u8bbe\u8ba1\u5b9e\u73b0\u5206\u6790","description":"\u7075\u6d3b\u7684\u63d2\u4ef6\u548c\u89c4\u5219\u5b9a\u4e49\uff0c\u662fShenyu\u7f51\u5173\u7684\u4e00\u5927\u7279\u8272\u3002\u5b83\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u652f\u6301\u591a\u79cd\u7f51\u7edc\u534f\u8bae\u548c\u591a\u79cd\u6d41\u884c\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5982Dubbo, gRPC\u548c Spring-Cloud \u7b49\u3002 \u4e3a\u4e86\u5b9e\u73b0\u5bf9\u5404\u79cd\u534f\u8bae\u53ca\u63d2\u4ef6\u7684\u914d\u7f6e\u89c4\u5219\u7684\u89e3\u6790\uff0c\u7f51\u5173\u5728\u89c4\u5219\u7b56\u7565\u89e3\u6790\u65b9\u9762\uff0c\u91c7\u7528\u4e86\u4f18\u96c5\u7684SPI(Service Provider Interface)\u5b9e\u73b0\uff0c\u5f53\u6dfb\u52a0\u65b0\u7684\u63d2\u4ef6\u65f6\uff0c\u89c4\u5219\u89e3\u6790\u90e8\u5206\u53ef\u4ee5\u6cbf\u7528\u73b0\u6709\u5b9e\u73b0\u6216\u91c7\u7528SPI\u673a\u5236\u5feb\u901f\u5b9e\u73b0\uff0c\u5177\u6709\u826f\u597d\u7684\u53ef\u6269\u5c55\u6027\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"SPI","permalink":"/zh/blog/tags/spi"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":7.51,"hasTruncateMarker":false,"authors":[{"name":"Huihui Yin","title":"Apache ShenYu Contributor"}],"frontMatter":{"title":"PredicateJudge-- \u57fa\u4e8eSPI\u7684\u8bbe\u8ba1\u5b9e\u73b0\u5206\u6790","author":"Huihui Yin","author_title":"Apache ShenYu Contributor","tags":["SPI","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"MatchStrategy--\u57fa\u4e8eSPI\u7684\u4ee3\u7801\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI"},"nextItem":{"title":"RateLimiter SPI \u4ee3\u7801\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI"}},"content":"\u7075\u6d3b\u7684\u63d2\u4ef6\u548c\u89c4\u5219\u5b9a\u4e49\uff0c\u662f[Shenyu\u7f51\u5173](http://shenyu.apache.org/)\u7684\u4e00\u5927\u7279\u8272\u3002\u5b83\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u652f\u6301\u591a\u79cd\u7f51\u7edc\u534f\u8bae\u548c\u591a\u79cd\u6d41\u884c\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u5982Dubbo, gRPC\u548c Spring-Cloud \u7b49\u3002 \u4e3a\u4e86\u5b9e\u73b0\u5bf9\u5404\u79cd\u534f\u8bae\u53ca\u63d2\u4ef6\u7684\u914d\u7f6e\u89c4\u5219\u7684\u89e3\u6790\uff0c\u7f51\u5173\u5728\u89c4\u5219\u7b56\u7565\u89e3\u6790\u65b9\u9762\uff0c\u91c7\u7528\u4e86\u4f18\u96c5\u7684`SPI`(Service Provider Interface)\u5b9e\u73b0\uff0c\u5f53\u6dfb\u52a0\u65b0\u7684\u63d2\u4ef6\u65f6\uff0c\u89c4\u5219\u89e3\u6790\u90e8\u5206\u53ef\u4ee5\u6cbf\u7528\u73b0\u6709\u5b9e\u73b0\u6216\u91c7\u7528`SPI`\u673a\u5236\u5feb\u901f\u5b9e\u73b0\uff0c\u5177\u6709\u826f\u597d\u7684\u53ef\u6269\u5c55\u6027\u3002\\n\\n\\n## `SPI` \u7684\u9876\u5c42\u8bbe\u8ba1\\n\\nShenyu\u7684`SPI`\u91c7\u7528\u63a5\u53e3+ \u5de5\u5382\u6a21\u5f0f+\u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\uff0c\u6765\u5b9e\u73b0\u6a21\u7ec4\u7684\u52a8\u6001\u52a0\u8f7d\u3002\u5728\u5176***shen-`SPI`***-\u6a21\u7ec4\uff0c\u505a\u4e86`SPI`\u7684\u9876\u5c42\u8bbe\u8ba1\u3002\u5b9a\u4e49\u4e86@ Join \uff0c@`SPI` \u4e24\u4e2aannotation\u3002 \u5176\u4e2d@Join  \u4ee3\u8868\u6b64\u7c7b\u4f1a\u52a0\u5165\u6269\u5c55\u673a\u5236\uff0c\u76f8\u5f53\u4e8e\u662f\u505a\u7533\u8bf7\u6ce8\u518c\u3002 @`SPI` \u6807\u660e\u5f53\u524d\u7c7b\u4e3a`SPI`\u529f\u80fd\u6269\u5c55\u7c7b\u3002\\n\\nFig 1 classes in the ***shenyu-spi***\\n\\n![toplevel-SPI](/img/activities/code-analysis-predicatejudge-spi/toplevel-SPI.png)\\n\\n\u914d\u7f6e\u6587\u4ef6\u65b9\u9762\uff0c\u5b9a\u4e49`SPI`\u52a0\u8f7d\u7684\u76ee\u5f55\u4e3a `META-INF/shenyu/`\\n\\n```java\\nSHENYU_DIRECTORY = \\"META-INF/shenyu/\\";\\n```\\n\\n\u7cfb\u7edf\u542f\u52a8\u65f6\uff0c\u4f1a\u626b\u63cf `SHENYU_DIRECTORY` \u4e0b\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u7531 `ExtensionLoader` \u7c7b\u6765\u52a0\u8f7d\u6240\u914d\u7f6e\u7684`SPI`\u6269\u5c55\u7c7b\uff0c\u5e76cache\u5230\u5185\u5b58\u4e2d\u3002  \u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u4e3a key=class\u7684\u5f62\u5f0f\u3002 \u5728\u7cfb\u7edf\u6267\u884c\u671f\u95f4\uff0c \u7531`ExtensionFactory`\u7684\u5b9e\u73b0\u7c7b\uff0c\u8fd4\u56dekey\u6240\u5bf9\u5e94\u7684`SPI`\u5b9e\u73b0\u7c7b\u3002 \\n\\n## shenyu-plugin\u7684`SPI` \u5b9e\u73b0\\n\\n\u5728***shenyu-plugin***\u6a21\u7ec4\u4e2d\uff0c\u6309\u7167\u63d2\u4ef6\u673a\u5236\uff0c\u5b9e\u73b0\u4e86\u5404\u79cd\u8bf7\u6c42\u8f6c\u53d1\u529f\u80fd\uff0c\u5305\u62ec\u652f\u6301request, redirect, response, rewrite\u7b49http\u534f\u8bae\u529f\u80fd\uff0c\u53ca gRPC, dubbo, hystrix\u7b49\u5fae\u670d\u52a1\u6846\u67b6\uff0c \u5e76\u4e14\u63d2\u4ef6\u529f\u80fd\u8fd8\u5728\u4e0d\u65ad\u589e\u52a0\u4e2d\u3002\u5982\u679c\u5728\u5404\u81ea\u7684\u529f\u80fd\u63d2\u4ef6\u5b9e\u505a\u7c7b\u4e2d\uff0c\u8fd8\u8981\u505a\u5bf9routing \u53c2\u6570\u7684\u89e3\u6790\u7b49\u5904\u7406\uff0c\u4e0d\u4ec5\u4f1a\u9020\u6210\u7a0b\u5e8f\u7684\u5197\u4f59\uff0c\u800c\u4e14\u5f53\u8981\u652f\u6301\u5404\u81ea\u5339\u914d\u89c4\u5219\uff0c\u5982\u901a\u914d\u7b26\u3001\u6b63\u5219\u8868\u8fbe\u5f0f\u3001SpEL\u89e3\u6790\u7b49\uff0c\u4f1a\u9020\u6210\u9891\u7e41\u5bf9\u63d2\u4ef6\u6838\u5fc3\u4ee3\u7801\u7684\u4fee\u6539\u3002\u56e0\u6b64\uff0c\u5728***shenyu-plugin***\u6a21\u7ec4\u4e2d\uff0c\u5c06routing\u53c2\u6570\u89e3\u6790\u505a\u4e86\u66f4\u9ad8\u4e00\u5c42\u7684\u62bd\u8c61\uff0c\u5e76\u6309\u7167`SPI`\u673a\u5236\u505a\u4e86\u89c4\u5219\u89e3\u6790\u7684\u5b9e\u73b0\u3002\u89e3\u6790\u7531\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a\\n\\n- `ParameterData`-\u53c2\u6570\u8d44\u6599,  \\n\\n- `PredictJudge`-\u65ad\u8a00\\n\\n- `MatchStrategy`-\u5339\u914d\u7b56\u7565\u4e09\u4e2a`SPI`\u5b9e\u73b0\u3002\\n\\n  \u8fd9\u4e9b\u6269\u5c55\u7c7b\u5b9a\u4e49\u5728 ***shenyu-plugin-base*** module\u4e2d\uff0c\u7ecf\u8fc7\u8fd9\u6837\u62bd\u8c61\u540e\uff0c\u6bcf\u4e2a\u63d2\u4ef6\u5b9e\u73b0\u4e2d\uff0crouting \u53c2\u6570\u89e3\u6790\u7684\u529f\u80fd\u5168\u90e8\u7531AbstractShenyuPlugin \u6765\u8c03\u7528\u4e0a\u8ff0\u4e09\u4e2a`SPI`\u5de5\u5382\u7c7b\u6765\u5b9a\u4e49\u548c\u5b9e\u73b0\u3002\u505a\u5230\u4e86\u529f\u80fd\u7684\u4e13\u4e00\uff0c\u5e76\u6613\u4e8e\u6269\u5c55\uff0c\u7b26\u5408SOLID\u539f\u5219\u3002\\n\\n\u672c\u8282\u5c31\u5176\u4e2d\u7684`PredictJudge`-\u65ad\u8a00\u505a\u8be6\u7ec6\u89e3\u6790\u3002\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2amodule\u4e2d\u7684pom\u6587\u4ef6\u4e2d\uff0c\u6dfb\u52a0\u4e86\u5bf9***shenyu-`SPI`***\u7684\u4f9d\u8d56\\n\\n```xml\\n<dependency>\\n    <groupId>org.apache.shenyu</groupId>\\n    <artifactId>shenyu-spi</artifactId>\\n    <version>${project.version}</version>\\n</dependency>\\n```\\n\\n### PredicateJudge `SPI` \u8bbe\u8ba1\\n\\nPredicateJudge `SPI` \u5b9e\u73b0\u7528\u6765\u89e3\u6790\u5224\u65ad\u5404\u7c7b\u89c4\u5219\uff0c\u5f53\u7f51\u5173\u4e2d\u914d\u7f6e\u7684\u3002\u8fd9\u4e2a\u7c7b\u547d\u540d\u548c\u529f\u80fd\u90fd\u7c7b\u4f3c\u4e8ejava \u7684[Predicate](https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html)  \uff0c\u4f46\u5bf9\u63a5\u53d7\u884c\u4e3a\u505a\u4e86\u66f4\u8fdb\u4e00\u6b65\u7684\u62bd\u8c61\u3002\u8fd9\u4e2a`SPI`\u901a\u8fc7\u4e00\u4e2a\u5de5\u5382\u548c\u7b56\u7565\u6a21\u5f0f\u5b9e\u73b0\uff0c\u9996\u5148\u6765\u770b`PredicateJudge` `SPI`\u63a5\u53e3\u7684\u5b9a\u4e49\uff1a\\n\\n```java\\n@SPI\\n@FunctionalInterface\\npublic interface PredicateJudge {\\n\\n    /**\\n     * judge conditionData and realData is match.\\n     *\\n     * @param conditionData {@linkplain ConditionData}\\n     * @param realData       realData\\n     * @return true is pass  false is not pass.\\n     */\\n    Boolean judge(ConditionData conditionData, String realData);\\n}\\n```\\n\\n\u8fd9\u90e8\u5206\u7684\u7c7b\u56fe\u5982\u4e0b\uff1a\\n\\nFig 2-Predicate class diagram\\n\\n![predicate-class-diagram](/img/activities/code-analysis-predicatejudge-spi/predicate-class-diagram.png)\\n\\n`PredicateJudgeFactory`\u7684\u91cd\u8981\u65b9\u6cd5\u5982\u4e0b\uff1a\\n\\n```java\\n    public static PredicateJudge newInstance(final String operator) {\\n        return ExtensionLoader.getExtensionLoader(PredicateJudge.class).getJoin(processSpecialOperator(operator));\\n    }\\n```\\n\\n```java\\n    public static Boolean judge(final ConditionData conditionData, final String realData) {\\n        if (Objects.isNull(conditionData) || StringUtils.isBlank(realData)) {\\n            return false;\\n        }\\n        return newInstance(conditionData.getOperator()).judge(conditionData, realData);\\n    }\\n```\\n\\n\u8fd9\u91cc`ConditionData`\u5b9a\u4e49\u5982\u4e0b\u5305\u542b\u5c5e\u6027\u56db\u4e2aString\u7c7b\u578b\u7684\u5c5e\u6027\uff1a `paramType, operator,paramName,paramValue`\\n\\n#### ParamTypeEnum\\n\\n\u53c2\u6570 `paramType`\u5fc5\u987b\u4e3a\u7cfb\u7edf\u4e2d\u679a\u4e3e\u7c7b\u578b `ParamTypeEnum`\uff0c\u9ed8\u8ba4\u652f\u6301\u7684`paramType`\u6709\uff1a\\n\\n```java\\npost, uri,query, host, ip,header, cookie,req_method\\n```\\n\\n#### OperatorEnum\\n\\n `operator` \u5fc5\u987b\u4e3a\u679a\u4e3e\u7c7b\u578b `OperatorEnum` \uff0c\u76ee\u524d\u652f\u6301\u7684\u64cd\u4f5c\u7b26\u6709\uff1a\uff08\u6ce8\u610f\uff0c\u4e25\u683c\u533a\u5206\u5927\u5c0f\u5199)\\n\\n```java\\n   match, =,regex, >,<, contains, SpEL,  Groovy, TimeBefore,TimeAfter\\n```\\n\\n\u57fa\u4e8e\u4ee5\u4e0a\u7684\u89c4\u5219, plugin \u6a21\u7ec4\u5b9e\u73b0\u4e86\u5982\u4e0b8\u4e2a `PredicateJudge` \u5b9e\u73b0\u7c7b\uff0c\u5206\u522b\u5b9e\u73b0\u4e0a\u8ff0operator\u7684\u903b\u8f91\u5339\u914d\u89c4\u5219.\\n\\n| Implementation class        | Rule denotes \u89c4\u5219\u8bf4\u660e                                | corespondece operator |\\n| --------------------------- | ---------------------------------------------------- | --------------------- |\\n| `ContainsPredicateJudge`    | \u5305\u542b\u5173\u7cfb \\"contains\\"\uff0c \u5b9e\u9645\u7ed3\u679c\uff0c\u9700\u8981\u5305\u542b\u6240\u5b9a\u89c4\u5219\u7684\u503c | contains              |\\n| `EqualsPredicateJudge`      | \u76f8\u7b49\\"=\\"\uff0c                                            | =                     |\\n| `MatchPredicateJudge`       | \u7528\u4e8eURI \u8def\u5f84\u5339\u914d\u7684\u5904\u7406                               | match                 |\\n| `TimerAfterPredicateJudge`  | \u5f53\u524dlocal\u65f6\u95f4\u662f\u5426\u665a\u4e8e\u8bbe\u5b9a\u7684\u65f6\u95f4                      | TimeAfter             |\\n| `TimerBeforePredicateJudge` | \u5f53\u524dlocal\u65f6\u95f4\u662f\u5426\u65e9\u4e8e\u8bbe\u5b9a\u7684\u65f6\u95f4                      | TimeBefore            |\\n| `GroovyPredicateJudge`      | Groovy,\u8bbe\u5b9aParamName\u7684\u503c\uff0c\u4e0e\u8bbe\u5b9aParamValue\u76f8\u540c       | Groovy                |\\n| `RegexPredicateJudge`       | \u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u8d44\u6599                                   | regex                 |\\n\\n### \u8c03\u7528\u65b9\u6cd5\\n\\n\u5f53\u8981\u505a\u4e00\u7ec4\u53c2\u6570\u7684\u89e3\u6790\u65f6\uff0c\u53ea\u9700\u8981\u8c03\u7528`PredicateJudgeFactory`\u7684judge\u65b9\u6cd5\u5373\u53ef\uff1a\\n\\n```java\\nPredicateJudgeFactory.judge(final ConditionData conditionData, final String realData);\\n```\\n\\n### `SPI`\u914d\u7f6e\u6587\u4ef6\\n\\n\u8fd9\u4e9b`PredicateJudge`\u5b9e\u73b0\u7c7b\u5728  `SHENYU_DIRECTORY` \u4e2d\u7684config\u6587\u4ef6\u4e2d\u505a\u4e86\u914d\u7f6e\uff0c\u5728\u542f\u52a8\u65f6\u4f1a\u52a0\u52a0\u8f7d\u5e76cache\u5230\u5185\u5b58\u4e2d\u3002\\n\\n`PredicateJudge`\u6587\u4ef6\u7684\u5185\u5bb9\u5982\u4e0b\uff0c\u4e3akey=class\u5f62\u5f0f\uff0c\u5de6\u8fb9\u7684operator\u8981\u548c`ParamEnum`\u4e2d\u7684\u5b9a\u4e49\u4e00\u81f4\u3002\\n\\n```properties\\nequals=org.apache.shenyu.plugin.base.condition.judge.EqualsPredicateJudge\\n\\ncontains=org.apache.shenyu.plugin.base.condition.judge.ContainsPredicateJudge\\nGroovy=org.apache.shenyu.plugin.base.condition.judge.GroovyPredicateJudge\\nmatch=org.apache.shenyu.plugin.base.condition.judge.MatchPredicateJudge\\nregex=org.apache.shenyu.plugin.base.condition.judge.RegexPredicateJudge\\nSpEL=org.apache.shenyu.plugin.base.condition.judge.SpELPredicateJudge\\nTimeAfter=org.apache.shenyu.plugin.base.condition.judge.TimerAfterPredicateJudge\\nTimeBefore=org.apache.shenyu.plugin.base.condition.judge.TimerBeforePredicateJudge\\n```\\n\\n## PredicateJudge `SPI`\u5728\u7f51\u5173Plugin\u4e2d\u7684\u4f7f\u7528\\n\\n\u7f51\u5173\u7cfb\u7edf\u4e2d\uff0c\u5927\u90e8\u5206\u7684Plugin \u90fd\u7ee7\u627f\u81ea`AbstractShenyuPlugin`\uff0c\u8fd9\u4e2a\u62bd\u8c61\u7c7b\u4e2d\uff0c\u5728\u505a\u9009\u62e9\u548c\u89c4\u5219\u89e3\u6790\u65f6\uff0c\u8c03\u7528\u4e86\u4e0a\u8ff0`SPI`\u4e2d\u7684`MatchStrategy`\uff0c\u7ee7\u800c\u5728\u7b56\u7565\u5224\u65ad\u65f6\u8c03\u7528`PredicateJudge` \u7684\u5404\u4e2a\u65ad\u8a00\u7c7b\u6765\u5904\u7406\u3002\\n\\nPlugin\u4e0e`SPI` \u7684\u7c7b\u56fe\u5982\u4e0b:\\n\\nFig 3- class diagram of plugins with PredicateJudge and `MatchStrategy` `SPI`\\n\\n![plugin-SPI-class-diagram](/img/activities/code-analysis-predicatejudge-spi/plugin-SPI-class-diagram.png)\\n\\n\u4ece\u5ba2\u6237\u7aef\u53d1\u6765\u7684\u8bf7\u6c42\uff0c\u5728\u7cfb\u7edf\u4e2d\u8c03\u7528\u89c4\u5219\u90e8\u5206\u7684`SPI`\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a\\n\\nFig 4- flow chart for Shenyu gateway filter  with parameter processing\\n\\n![SPI-flow-diagram](/img/activities/code-analysis-predicatejudge-spi/SPI-flow-diagram.png)\\n\\n- \u7cfb\u7edf\u542f\u52a8\u65f6\uff0c\u4f1a\u52a0\u8f7d\u76ee\u5f55\u4e0b\u914d\u7f6e\u7684`SPI`\u8d44\u6599\u5230\u5185\u5b58\u4e2d\\n- \u5f53client\u6709\u65b0\u7684\u8bf7\u6c42\u53d1\u5230Apache shenyu \u7f51\u5173\u7cfb\u7edf\u65f6\uff0c\u5728\u7f51\u5173\u5185\u90e8\uff0c\u4f1a\u8c03\u7528\u5bf9\u5e94\u7684plugin\\n- \u5bf9\u5b9e\u9645\u8bf7\u6c42\u8d44\u6599\u505a\u89c4\u5219\u5339\u914d\u65f6\uff0c\u4f1a\u6839\u636e\u6240\u5305\u542b\u7684operator,\u8c03\u7528\u7684\u5bf9\u5e94\u7684PredicateJudge\u5b9e\u73b0\u7c7b\\n\\n## \u5176\u4ed6\\n\\n### PredicateJudge  \u5224\u65ad\u7ed3\u679c\u4e3e\u4f8b\\n\\n#### ContainsPredicateJudge- \\" contains\u201c rule\\n\\n \u4e3e\u4f8b\uff1a\u7ed9\u5b9a\u4e00\u7ec4\u53c2\u6570\uff08ConditionData \uff09\uff0c paramType=\\"uri\\", paramValue \u662f \\"/http/**\\"\\n\\n\u5f53\u5e94\u7528 ContainsPredicateJudge\u5305\u542b\u5173\u7cfb\u65f6\uff0c\u5224\u65ad\u7ed3\u679c\u5982\u4e0b\u8868\uff1a\\n\\n| ConditionData  (operator=\\"contains\\") | real data             | judge result |\\n| ------------------------------------ | --------------------- | ------------ |\\n| paramType=\\"uri\\",    \\"/http/**\\"       | \\"/http/**/test\\"       | true         |\\n|                                      | \\"/test/http/**/other\\" | true         |\\n|                                      | \\"/http1/**\\"           | false        |\\n\\n\u5176\u4ed6\u7684\u51e0\u4e2aPredicateJudge\u7684\u5177\u4f53\u529f\u80fd\u53ef\u53c2\u8003\u5176\u4ee3\u7801\u548c\u6d4b\u8bd5\u7c7b."},{"id":"/SPI-SourceCode-Analysis-RateLimiter-SPI","metadata":{"permalink":"/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-RateLimiter-SPI.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-RateLimiter-SPI.md","title":"RateLimiter SPI \u4ee3\u7801\u5206\u6790","description":"\u9650\u6d41\u662f\u7f51\u5173\u5fc5\u5907\u7684\u529f\u80fd\uff0c\u7528\u6765\u5e94\u5bf9\u9ad8\u5e76\u53d1\u8bf7\u6c42\u7684\u573a\u666f\u3002\u5f53\u7cfb\u7edf\u53d7\u5230\u5f02\u5e38\u653b\u51fb\uff0c\u77ed\u671f\u5185\u805a\u96c6\u4e86\u5927\u91cf\u7684\u6d41\u91cf\uff1b\u5f53\u6709\u5927\u91cf\u4f4e\u7ea7\u522b\u7684\u8bf7\u6c42\uff0c\u5904\u7406\u8fd9\u4e9b\u8bf7\u6c42\u4f1a\u5f71\u54cd\u5173\u952e\u4e1a\u52a1\u7684\u5904\u7406\uff0c\u9700\u8981\u9650\u5236\u8fd9\u4e9b\u8bf7\u6c42\u7684\u8bbf\u95ee\u901f\u5ea6; \u6216\u8005\u7cfb\u7edf\u5185\u90e8\u51fa\u73b0\u4e00\u4e9b\u5f02\u5e38\uff0c\u4e0d\u80fd\u6ee1\u8d1f\u8377\u7684\u670d\u52a1\u6574\u4e2a\u5e94\u7528\u8bf7\u6c42\u7b49\u7b49\u3002\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u90fd\u9700\u8981\u542f\u7528\u9650\u6d41\u6765\u4fdd\u62a4\u7cfb\u7edf\u3002\u53ef\u4ee5\u62d2\u7edd\u670d\u52a1\u3001\u7b49\u5f85\u6216\u964d\u7ea7\u5904\u7406\uff0c\u5c06\u6d41\u91cf\u9650\u5236\u5230\u7cfb\u7edf\u53ef\u63a5\u53d7\u7684\u91cf\uff0c\u6216\u8005\u53ea\u5141\u8bb8\u67d0\u4e9b\u57df\u540d(\u6216\u67d0\u4e9b\u4e1a\u52a1)\u7684\u8bf7\u6c42\u4f18\u5148\u5904\u7406\u3002","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"rate limiter","permalink":"/zh/blog/tags/rate-limiter"},{"label":"SPI","permalink":"/zh/blog/tags/spi"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":21.52,"hasTruncateMarker":false,"authors":[{"name":"Huihui Yin","title":"Apache ShenYu Contributor","url":"https://github.com/changanjennifer/"}],"frontMatter":{"title":"RateLimiter SPI \u4ee3\u7801\u5206\u6790","author":"Huihui Yin","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/changanjennifer/","tags":["rate limiter","SPI","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"PredicateJudge-- \u57fa\u4e8eSPI\u7684\u8bbe\u8ba1\u5b9e\u73b0\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI"},"nextItem":{"title":"\u793e\u533a\u65b0\u4eba\u5f00\u53d1\u8005\u542f\u52a8\u53ca\u5f00\u53d1\u9632\u8e29\u5751\u6307\u5357","permalink":"/zh/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor"}},"content":"\u9650\u6d41\u662f\u7f51\u5173\u5fc5\u5907\u7684\u529f\u80fd\uff0c\u7528\u6765\u5e94\u5bf9\u9ad8\u5e76\u53d1\u8bf7\u6c42\u7684\u573a\u666f\u3002\u5f53\u7cfb\u7edf\u53d7\u5230\u5f02\u5e38\u653b\u51fb\uff0c\u77ed\u671f\u5185\u805a\u96c6\u4e86\u5927\u91cf\u7684\u6d41\u91cf\uff1b\u5f53\u6709\u5927\u91cf\u4f4e\u7ea7\u522b\u7684\u8bf7\u6c42\uff0c\u5904\u7406\u8fd9\u4e9b\u8bf7\u6c42\u4f1a\u5f71\u54cd\u5173\u952e\u4e1a\u52a1\u7684\u5904\u7406\uff0c\u9700\u8981\u9650\u5236\u8fd9\u4e9b\u8bf7\u6c42\u7684\u8bbf\u95ee\u901f\u5ea6; \u6216\u8005\u7cfb\u7edf\u5185\u90e8\u51fa\u73b0\u4e00\u4e9b\u5f02\u5e38\uff0c\u4e0d\u80fd\u6ee1\u8d1f\u8377\u7684\u670d\u52a1\u6574\u4e2a\u5e94\u7528\u8bf7\u6c42\u7b49\u7b49\u3002\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u90fd\u9700\u8981\u542f\u7528\u9650\u6d41\u6765\u4fdd\u62a4\u7cfb\u7edf\u3002\u53ef\u4ee5\u62d2\u7edd\u670d\u52a1\u3001\u7b49\u5f85\u6216\u964d\u7ea7\u5904\u7406\uff0c\u5c06\u6d41\u91cf\u9650\u5236\u5230\u7cfb\u7edf\u53ef\u63a5\u53d7\u7684\u91cf\uff0c\u6216\u8005\u53ea\u5141\u8bb8\u67d0\u4e9b\u57df\u540d(\u6216\u67d0\u4e9b\u4e1a\u52a1)\u7684\u8bf7\u6c42\u4f18\u5148\u5904\u7406\u3002\\n\\n   \u9488\u5bf9\u4ee5\u4e0a\u7684\u573a\u666f\u9700\u6c42\uff0c\u5728\u8bbe\u8ba1\u4e00\u4e2a`API`\u7f51\u5173\u7684\u9650\u6d41\u529f\u80fd\u65f6\uff0c\u5c31\u9700\u8981\u8003\u8651\u5982\u4e0b\u7684\u6269\u5c55\u70b9\uff1a\\n\\n1. \u53ef\u4ee5\u652f\u6301\u591a\u79cd\u9650\u6d41\u7684\u7b97\u6cd5\uff0c\u5e76\u6613\u4e8e\u6269\u5c55\u3002\\n2. \u8981\u53ef\u4ee5\u652f\u6301\u591a\u79cd\u9650\u6d41\u7684\u65b9\u5f0f\uff0c\u80fd\u533a\u5206\u7528\u6237\u7fa4\u3001\u9ad8\u4f4e\u4f18\u5148\u7ea7\u7684\u8bf7\u6c42\u3002\\n3. \u8981\u652f\u6301\u9ad8\u5e76\u53d1\uff0c\u80fd\u5feb\u901f\u7684\u505a\u51fa\u9650\u5236\u6216\u901a\u8fc7\u7684\u51b3\u7b56\u3002\\n4. \u8981\u6709\u5bb9\u9519\u5904\u7406\uff0c\u5982\u679c\u9650\u6d41\u7a0b\u5e8f\u51fa\u9519\uff0c\u7f51\u5173\u7cfb\u7edf\u80fd\u7ee7\u7eed\u6267\u884c\u3002\\n\\n \u672c\u6587\u4f1a\u5148\u4ecb\u7ecdshenyu\u7f51\u5173\u9650\u6d41\u90e8\u5206\u7684\u603b\u4f53\u6280\u672f\u67b6\u6784\uff0c\u4e4b\u540e\u91cd\u70b9\u5206\u6790`RateLimiter` SPI\u6269\u5c55\u5b9e\u73b0\u7684\u4ee3\u7801\u3002\\n\\n> This article based on `shenyu-2.4.0` version of the source code analysis.\\n\\n## RateLimiter  \u603b\u4f53\u8bbe\u8ba1\u8bf4\u660e\\n\\n\u200b        WebFlux\u662fSpring \u63d0\u4f9b\u7684\u57fa\u4e8eReactor\u6a21\u578b\u7684\u5f02\u6b65\u975e\u963b\u585e\u6846\u67b6\uff0c\u80fd\u63d0\u5347\u541e\u5410\u91cf\uff0c\u4f7f\u7cfb\u7edf\u6709\u66f4\u597d\u7684\u53ef\u4f38\u7f29\u6027\u3002Apache Shenyu\u7f51\u5173\u7684\u63d2\u4ef6\u529f\u80fd\u57fa\u4e8eWebFlux\u6846\u67b6\u5b9e\u73b0\u7684\u3002RateLimiter\u529f\u80fd\u662f\u5728`ratelimiter-plugin`\u4e2d\u5b9e\u73b0\u3002\u5728\u9650\u6d41\u8fc7\u7a0b\u4e2d\uff0c\u5e38\u7528\u7684\u7b97\u6cd5\u6709\u4ee4\u724c\u6876\u3001\u6f0f\u6876\u7b49\u7b97\u6cd5\uff0c\u8fd9\u4e9b\u7b97\u6cd5\u6267\u884c\u4e2d\uff0c\u9700\u8981\u68c0\u6838\u8bf7\u6c42\u7684\u6765\u6e90\uff0c\u5bf9\u5df2\u4f7f\u7528\u7684\u6d41\u91cf\u505a\u8ba1\u6570\u53ca\u903b\u8f91\u8ba1\u7b97\uff0c\u5224\u5b9a\u662f\u5426\u5141\u8bb8\u901a\u8fc7\u3002\u4e3a\u4e86\u63d0\u9ad8\u5e76\u53d1\u53ca\u6027\u80fd\uff0c \u5c06\u8ba1\u6570\u548c\u7b97\u6cd5\u903b\u8f91\u5904\u7406\uff0c\u90fd\u653e\u5230redis\u4e2d\u3002Java\u4ee3\u7801\u8d1f\u8d23\u505a\u6570\u636e\u53c2\u6570\u7684\u4f20\u9012\u3002\u5728\u8c03\u7528redis\u65f6\uff0c[lua](https://www.lua.org/)\u811a\u672c\u53ef\u4ee5\u5e38\u9a7b\u5728redis\u5185\u5b58\u4e2d\uff0c\u80fd\u51cf\u5c11\u7f51\u7edc\u5f00\u9500\uff0c\u5e76\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u6267\u884c\uff0c\u5177\u6709\u539f\u5b50\u6027\u3002[Spring Data Redis](https://spring.io/projects/spring-data-redis) \u63d0\u4f9b\u4e86\u5bf9[redis\u547d\u4ee4](https://redis.io/commands)\u6267\u884c\u7684\u62bd\u8c61\uff0c\u6267\u884c\u5e8f\u5217\u5316\uff0c\u53ca\u81ea\u52a8\u4f7f\u7528redis \u811a\u672c\u7f13\u5b58\u3002\u5728\u8fd9\u4e2aplugin\u4e2d\uff0c\u7531\u4e8e\u91c7\u7528\u4e86reactor \u975e\u963b\u585e\u6846\u67b6\uff0c\u6240\u4ee5\u91c7\u7528Spring Redis Reactive\u7c7b\u5e93\u5b9e\u73b0\u5bf9redis\u7684\u529f\u80fd\u8c03\u7528\u3002\\n\\n\u200b        \u8fd9\u4e2aplugin\u4e2d\u7684\u7c7b\u5305\u56fe\u5982\u4e0b\uff0c\u91cd\u70b9\u6807\u51fa\u4e86\u4e0e`RateLimiter` `SPI`\u76f8\u5173\u7684\u4e24\u4e2apackage: resolver \u548calgorithm.\\n\\n![ratelimiter-package-diagram](/img/activities/code-analysis-ratelimiter-spi/ratelimiter-package-diagram.png)\\n\\n## RateLimiter SPI\u7684\u8bbe\u8ba1\\n\\n\u7531\u4e8e\u91c7\u7528\u4e86Spring data+ Redis +lua\u67b6\u6784\u5b9e\u73b0\u4e86\u9ad8\u5e76\u53d1\u7684\u9700\u6c42\u3002 \u5982\u4f55\u505a\u5230\u5bf9\u7b97\u6cd5\u548c\u9650\u6d41\u65b9\u5f0f\u7684\u6269\u5c55\u5462\uff1f Shenyu ratelimiter  plugin\u4e2d\u8bbe\u8ba1\u4e86\u4e24\u4e2aSPI\u6765\u5b9e\u73b0\u8fd9\u4e24\u4e2a\u9700\u6c42\uff1a\\n\\n- `RateLimiterAlgorithm`\uff1a\u7528\u6765\u6269\u5c55\u4e0d\u540c\u7684\u9650\u6d41\u7b97\u6cd5\u3002\\n- `RateLimiterKeyResolver`\uff1a \u7528\u4e8e\u6269\u5c55\u83b7\u53d6\u8bf7\u6c42\u7684\u5173\u952e\u4fe1\u606f\uff0c\u7528\u4e8e\u533a\u5206\u6d41\u91cf\uff0c\u4f8b\u5982\u6309IP \u5730\u5740\u3001\u6309\u67d0\u4e00\u6bb5\u57df\u540d\u7b49\u6765\u533a\u5206\u8bbf\u95ee\u7684\u8bf7\u6c42\u3002\\n\\nSPI\u7684\u5177\u4f53\u5b9e\u4f5c\u7c7b\u4e0e\u914d\u7f6e\u4fe1\u606f\u4f4d\u4e8e\uff1a`SHENYU_DIRECTORY`\u76ee\u5f55\u4e0b (\u9ed8\u8ba4\u5728`/META-INF/shenyu`)\u4e0b\u3002\\n\\n### RateLimiterKeyResolver\\n\\n\u83b7\u53d6\u8bf7\u6c42\u7684\u5173\u952e\u4fe1\u606f\uff0c\u7528\u4e8e\u5206\u7ec4\u9650\u6d41\uff0c\u4f8b\u5982\u6309URL/ \u7528\u6237 / IP \u7b49\uff0c `RateLimiterKeyResolver` \u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a\\n\\n```java\\n@SPI\\npublic interface RateLimiterKeyResolver {\\n\\n    /**\\n     * get Key resolver\'s name.\\n     *\\n     * @return Key resolver\'s name\\n     */\\n    String getKeyResolverName();\\n\\n    /**\\n     * resolve.\\n     *\\n     * @param exchange exchange the current server exchange {@linkplain ServerWebExchange}\\n     * @return rate limiter key\\n     */\\n    String resolve(ServerWebExchange exchange);\\n}\\n\\n```\\n\\n`@SPI`\u5c06\u5f53\u524dinterface \u6ce8\u518c\u4e3aShenyu SPI \u63a5\u53e3\u3002resolve(ServerWebExchange exchange)\u65b9\u6cd5\u7528\u6765\u63d0\u4f9b\u89e3\u6790\u65b9\u5f0f\u3002\\n\\nRateLimiterKeyResolver  SPI \u63d0\u4f9b\u4e86\u4e24\u79cdkey resolver, `WholeKeyResolve`\u548c `RemoteAddrKeyResolver`\uff0c\u5176\u4e2d`RemoteAddrKeyResolver`\u4e2d\u7684`resolve`\u65b9\u6cd5\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```java\\n    @Override\\n    public String resolve(final ServerWebExchange exchange) {\\n        return Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();\\n    }\\n```\\n\\n\u5176key\u503c\u4e3a\u8bf7\u6c42\u7684IP\u5730\u5740\u3002 \u57fa\u4e8eSPI\u53ca\u5de5\u5382\u7c7b\u7684\u5b9e\u73b0\uff0c\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u7684\u6269\u5c55\u5b9e\u73b0\u65b0\u7684key resolver\uff0c\u5982URL,\u7528\u6237\u7b49\u7b49\u3002\\n\\n### RateLimiterAlgorithm SPI\\n\\n`RateLimiterAlgorithm` SPI \u7528\u6765\u5b9e\u73b0\u5bf9\u4e0d\u540c\u9650\u6d41\u7b97\u6cd5\u7684\u8bc6\u522b\u3001\u52a0\u8f7d\u548c\u5b9a\u4e49\uff0c\u5176\u7c7b\u56fe\u5982\u4e0b\uff1a\\n\\n![ratelimiteral-class-diagram](/img/activities/code-analysis-ratelimiter-spi/ratelimiteral-class-diagram.png)\\n\\n\u672c\u6a21\u7ec4\u4f7f\u7528\u4e86\u5de5\u5382\u6a21\u5f0f\uff0c\u63d0\u4f9b\u4e86\u63a5\u53e3\u7c7b\u3001\u62bd\u8c61\u7c7b\u548c\u5de5\u5382\u7c7b\uff0c\u63d0\u4f9b\u4e864\u4e2a\u5b9e\u73b0\u7c7b\uff0c\u5176\u4e2d\u5b9e\u73b0\u7c7b\u5bf9\u5e94\u7684Lua\u811a\u672c\u5728 `RateLimitEnum` \u4e2d\u505a\u4e86\u5b9a\u4e49\uff0c\u653e\u7f6e\u5728 `/META-INF/scripts` \u76ee\u5f55\u4e0b\u3002\u63a5\u53e3`RateLimiterAlgorithm`\u7684\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```java\\n@SPI\\npublic interface RateLimiterAlgorithm<T> {\\n    \\n    RedisScript<T> getScript();\\n    List<String> getKeys(String id);\\n    \\n    /**\\n     * Callback string.\\n     *\\n     * @param script the script\\n     * @param keys the keys\\n     * @param scriptArgs the script args\\n     */\\n    default void callback(final RedisScript<?> script, final List<String> keys, final List<String> scriptArgs) {\\n    }\\n}\\n```\\n\\n`@SPI` \u5c06\u8fd9\u4e2a\u63a5\u53e3\u6ce8\u518c\u4e3ashenyu SPI, \u5176\u4e2d\u5b9a\u4e49\u4e86\u4e09\u4e2a\u65b9\u6cd5\uff1a\\n\\n- `getScript()` \u65b9\u6cd5\u8fd4\u56de\u4e00\u4e2a `RedisScript`\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u5c06\u4f20\u9012\u7ed9Redis\u3002\\n- `getKeys(String id)` \u8fd4\u56de\u4e00\u4e2a\u952e\u503c\u7684List.\\n- `callback()`\u56de\u8c03\u51fd\u6570\u7528\u4e8e\u5f02\u6b65\u5904\u7406\u4e00\u4e9b\u9700\u8981\u5728\u8fd4\u56de\u540e\u505a\u7684\u5904\u7406\uff0c\u7f3a\u7701\u662f\u7a7a\u65b9\u6cd5\u3002\\n\\n#### \u62bd\u8c61\u7c7b AbstractRateLimiterAlgorithm\\n\\n\u5728\u8fd9\u4e2a\u7c7b\u4e2d\uff0c\u5b9e\u73b0\u4e86\u63a5\u53e3\u7684\u6a21\u677f\u65b9\u6cd5\uff0c\u4f7f\u7528\u53c2\u6570\u7c7b\u578b\u4e3a`List<Long>`,  \u62bd\u8c61\u65b9\u6cd5getScriptName() \u548cgetKeyName() \u7559\u7ed9\u5404\u4e2a\u5b9e\u4f5c\u7c7b\u6765\u5b9e\u73b0\u3002\u5982\u4e0b\u7684getScript() \u662f\u8fd9\u4e2a\u7c7b\u4e2d\u8bfb\u53d6lua\u811a\u672c\u7684\u5904\u7406\u4ee3\u7801\u3002\\n\\n```java\\n    public RedisScript<List<Long>> getScript() {\\n        if (!this.initialized.get()) {\\n            DefaultRedisScript redisScript = new DefaultRedisScript<>();\\n            String scriptPath = \\"/META-INF/scripts/\\" + getScriptName();\\n            redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(scriptPath)));\\n            redisScript.setResultType(List.class);\\n            this.script = redisScript;\\n            initialized.compareAndSet(false, true);\\n            return redisScript;\\n        }\\n        return script;\\n    }\\n```\\n\\n`AtomicBoolean`\u7c7b\u578b\u7684\u53d8\u91cf`initialized` \u7528\u6765\u6807\u8bb0lua\u811a\u672c\u662f\u5426\u6709\u88ab\u52a0\u8f7d\u3002 \u5982\u679c\u8fd8\u6ca1\u6709\u52a0\u8f7d\uff0c\u5c31\u4ece/META-INF/scripts/\u76ee\u5f55\u4e0b\uff0c\u8bfb\u53d6`scriptName`\u6307\u5b9a\u7684Lua\u6587\u4ef6\uff0c\u52a0\u8f7d\u6210`RedisScript`\u5bf9\u8c61\u3002\u6307\u5b9a\u7ed3\u679c\u4e3a`List`\u7c7b\u578b\uff0c \u8bbe\u5b9a\u91cf`initialized`\u4e3atrue,\u907f\u514d\u91cd\u590d\u52a0\u8f7d\u3002 \u8fd4\u56de `RedisScript`\u5bf9\u8c61\u3002\\n\\n`AbstractRateLimiterAlgorithm`\u4e2d`getKeys()`\u7684\u4ee3\u7801\u5982\u4e0b\uff0c\\n\\n```java\\n    @Override\\n    public List<String> getKeys(final String id) {\\n        String prefix = getKeyName() + \\".{\\" + id;\\n        String tokenKey = prefix + \\"}.tokens\\";\\n        String timestampKey = prefix + \\"}.timestamp\\";\\n        return Arrays.asList(tokenKey, timestampKey);\\n    }\\n```\\n\\n\u8fd9\u4e2a\u6a21\u677f\u65b9\u6cd5\u4e2d\uff0c\u4ea7\u751f\u4e86\u4e24\u4e2a\u5b57\u7b26\u4e32\uff0c\u5176\u4e2d\uff0c`tokenKey`\u4f1a\u4f5c\u4e3aKey\u4f20\u9012\u7ed9`redis`, \u6307\u5411\u4e00\u4e2a\u6709\u5e8f\u96c6\u5408\u3002 `timestampKey`\u662f\u4e00\u4e2a\u4ee5\u4f20\u5165id \u4e3a\u8bc6\u522b\u7684\u5b57\u7b26\u4e32\u3002\\n\\n\u53ef\u4ee5\u4ece\u4e0a\u9762\u7684\u7c7b\u56fe\u4e2d\u770b\u5230\uff0c`ConcurrentRateLimiterAlgorithm` \u548c`SlidingWindowRateLimiterAlgorithm` \u6709\u8986\u5199`getKeys(String id)`\u65b9\u6cd5\uff0c\u800c\u4e24\u5916\u4e24\u4e2a\u7b97\u6cd5\u7a0b\u5e8f\uff0c\u5219\u91c7\u7528\u7684\u662f\u62bd\u8c61\u7c7b\u4e2d\u7684\u5b9e\u73b0\u3002\u4e5f\u53ea\u6709 `ConcurrentRateLimiterAlgorithm` \u91cd\u5199\u4e86`callback()`\u65b9\u6cd5\u3002\u4e0b\u6587\u4e2d\u6211\u4eec\u4f1a\u5bf9\u6b64\u505a\u8fdb\u4e00\u6b65\u7684\u5206\u6790\u3002\\n\\n#### \u5de5\u5382\u7c7bRateLimiterAlgorithmFactory\\n\\n`RateLimiterAlgorithmFactory` \u4e2d\u4f9d\u636e\u7b97\u6cd5\u540d\u79f0\uff0c\u83b7\u53d6RateLimiterAlgorithm\u5b9e\u4f8b\u7684\u65b9\u6cd5\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```java\\npublic static RateLimiterAlgorithm<?> newInstance(final String name) {\\n    return Optional.ofNullable(ExtensionLoader.getExtensionLoader(RateLimiterAlgorithm.class).getJoin(name)).orElse(new TokenBucketRateLimiterAlgorithm());\\n}\\n```\\n\\n\u6309\u7167Apache shenyu SPI\u7684\u89c4\u5219\uff0c\u7531\u52a0\u8f7d\u5668`ExtensionLoader`\u83b7\u5f97\u5b9e\u4f5c\u7c7b\uff0c\u5f53\u627e\u4e0d\u5230\u7b97\u6cd5\u65f6\uff0c\u9ed8\u8ba4\u8fd4\u56de\u4ee4\u724c\u6876\u7b97\u6cd5\u5b9e\u73b0\u7c7b\u3002\\n\\n### \u4e0eRedis\u505a\u8d44\u6599\u4ea4\u4e92\\n\\n\u4ece\u4e0a\u9762\u4ee3\u7801\u6211\u4eec\u4e86\u89e3\u5230Apache Shenyu\u7f51\u5173\u4e2d\uff0cRateLimiter SPI \u7684\u57fa\u672c\u6269\u5c55\u70b9\uff0c\u5728Shenyu\u7f51\u5173\u8fd0\u884c\u4e2d\uff0c\u5e94\u7528ReactiveRedisTemplate \u6765\u5f02\u6b65\u6267\u884c\u5bf9redis\u7684\u8c03\u7528\u5904\u7406\u3002\u5b9e\u73b0\u4ee3\u7801\u5728RedisRateLimiter\u7c7b\u7684isAllowed()\u65b9\u6cd5\u4e2d\uff0c\u5176\u90e8\u5206\u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```java\\n    public Mono<RateLimiterResponse> isAllowed(final String id, final RateLimiterHandle limiterHandle) {\\n        // get parameters that will pass to redis from RateLimiterHandle Object\\n        double replenishRate = limiterHandle.getReplenishRate();\\n        double burstCapacity = limiterHandle.getBurstCapacity();\\n        double requestCount = limiterHandle.getRequestCount();\\n        // get the current used RateLimiterAlgorithm\\n        RateLimiterAlgorithm<?> rateLimiterAlgorithm = RateLimiterAlgorithmFactory.newInstance(limiterHandle.getAlgorithmName());\\n        \\n        ........\\n        Flux<List<Long>> resultFlux = Singleton.INST.get(ReactiveRedisTemplate.class).execute(script, keys, scriptArgs);\\n        return resultFlux.onErrorResume(throwable -> Flux.just(Arrays.asList(1L, -1L)))\\n                .reduce(new ArrayList<Long>(), (longs, l) -> {\\n                    longs.addAll(l);\\n                    return longs;\\n                }).map(results -> {\\n                    boolean allowed = results.get(0) == 1L;\\n                    Long tokensLeft = results.get(1);\\n                    return new RateLimiterResponse(allowed, tokensLeft);\\n                })\\n                .doOnError(throwable -> log.error(\\"Error occurred while judging if user is allowed by RedisRateLimiter:{}\\", throwable.getMessage()))\\n                .doFinally(signalType -> rateLimiterAlgorithm.callback(script, keys, scriptArgs));\\n    }\\n```\\n\\nPOJO \u5bf9\u8c61RateLimiterHandle \u4e2d\uff0c\u5b9a\u4e49\u4e86\u9650\u6d41\u6240\u9700\u7684\u5c5e\u6027\u7b97\u6cd5\u540d\u79f0, \u901f\u5f55\uff0c\u5bb9\u91cf\uff0c\u8bf7\u6c42\u7684\u6570\u91cf \u3002\u9996\u5148 \u4ecelimiterHandle \u5305\u88c5\u7c7b\u4e2d\u53d6\u5f97\u9700\u8981\u4f20\u5165redis\u7684\u51e0\u4e2a\u53c2\u6570\u3002\u4e4b\u540e\u4eceRateLimiterAlgorithmFactory \u4ece\u5de5\u5382\u7c7b\u53d6\u5f97\u5f53\u524d\u914d\u7f6e\u7684\u9650\u6d41\u7b97\u6cd5\u3002 \u4e4b\u540e\u505aKey\u503c\u548c\u53c2\u6570\u7684\u4f20\u9012\u3002\\n\\n\u4e3a\u4e86\u66f4\u65b9\u4fbf\u9605\u8bfb\uff0c\u4e0b\u56fe\u7ed9\u51fa\u4e86java\u4ee3\u7801\u4e0eredis\u6267\u884c\u53c2\u6570\u8f93\u5165\u3001\u8f93\u51fa\u7684\u4f20\u9012\u8fc7\u7a0b\u3002\u5de6\u8fb9\u662f`isAllowed`() \u51fd\u6570\u7684\u540e\u534a\u90e8\u5206\u4ee3\u7801\uff0c\u53f3\u8fb9\u662f\u4e00\u4e2aLua\u811a\u672c\u7684\u8f93\u5165\u8f93\u51fa\u4ee3\u7801\u3002\\n\\n\u4e0b\u9762\u8bf4\u660eJava\u4ee3\u7801\u7684\u6267\u884c\u8fc7\u7a0b\uff1a\\n\\n1. \u4ece`getKeys()`\u65b9\u6cd5\u83b7\u5f97\u4e24\u4e2a\u952e\u503c`List<String>`. \u5176\u4e2d\u7b2c\u4e00\u4e2aKey\u4f1a\u6620\u5c04\u4e3aRedis\u4e2d\u7684\u6709\u5e8f\u96c6\u5408\u3002\\n\\n2. \u8bbe\u5b9a4\u4e2a\u53c2\u6570\uff1a\u901f\u7387 replenishRate ,\u5bb9\u91cf burstCapacity, \u65f6\u95f4\u6233\uff0c \u8fd4\u56de\u5f53\u524djava \u7eaa\u5143\u79d2\u6570(\u957f\u6574\u6570)EpochSecond, \u8bf7\u6c42\u7684\u6570\u91cf requestcount.\\n\\n3. \u6309\u6240\u8bbe\u5b9a\u7684\u811a\u672c\u3001Key\u503c\u3001\u53c2\u6570\u8c03\u7528`ReactiveRedisTemplate`\u529f\u80fd\uff0c\u6267\u884credis\u5904\u7406\u3002\u8fd4\u56de\u53c2\u6570\u662f`Flux<List<Long>>`\u7c7b\u578b\\n\\n4. \u901a\u8fc7reduce\u65b9\u6cd5\u5c06\u5176\u8fd4\u56de\u503c\u4ece`Flux<ArrayList<Long>>` \u7c7b\u578b\u8f6c\u6362\u4e3a`Mono<ArrayList<Long>>`\uff0c\u518d\u7ecf\u8fc7map\u65b9\u6cd5\uff0c\u8f6c\u6362\u4e3a`Mono<RateLimiterResponse>`\u8fd4\u56de\u3002\\n\\n     \u8fd4\u56de\u7ed3\u679c\u6709\u4e24\u4e2a\u8d44\u6599\uff0callowed =1, \u4ee3\u8868\u5141\u8bb8\u901a\u8fc7\uff0c0-\u4e0d\u901a\u8fc7\uff1b\u800c\u7b2c\u4e8c\u4e2a\u8fd4\u56de\u53c2\u6570tokensLeft\uff0c\u662f\u53ef\u7528\u7684\u5269\u4f59\u8bf7\u6c42\u6570\u91cf\u3002\\n\\n5.\u5bb9\u9519\u6027\u65b9\u9762\uff0c\u7531\u4e8e\u4f7f\u7528\u7684\u662freactor \u7684\u975e\u963b\u585e\u901a\u8baf\u6a21\u578b\uff0c\u5f53\u53d1\u751f\u9519\u8bef\u65f6\uff0c\u4f1a\u6267\u884conErrorResume()\u8bed\u53e5\uff0cFlux.just\u4ea7\u751f\u8fd4\u56de\u8d44\u6599\uff0c \u9ed8\u8ba4\u4e3a`allowed`=1, \u4ee3\u8868\u5141\u8bb8\u901a\u8fc7\uff0c \u5e76\u4e22\u51fa\u9519\u8bef\u65e5\u5fd7\u3002\\n\\n6.\u4e4b\u540e\u6267\u884cdoFinally()\u65b9\u6cd5,\u6267\u884c\u7b97\u6cd5\u5b9e\u73b0\u7c7b\u7684callback\u65b9\u6cd5\u3002\\n\\n![io-with-lua](/img/activities/code-analysis-ratelimiter-spi/io-with-lua.png)\\n\\n## 4\u79cd\u9650\u6d41\u7b97\u6cd5\\n\\n\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86\u7f51\u5173\u4e2d\u5982\u4f55\u901a\u8fc7Java\u4ee3\u7801\u5982\u4f55\u4e0eRedis \u505a\u901a\u8baf\uff0c\u8fd9\u4e00\u8282\u6211\u4eec\u901a\u8fc7\u7b80\u8981\u5206\u6790\u7f51\u5173\u4e2d\u63d0\u4f9b\u76844\u79cd\u9650\u6d41\u7b97\u6cd5\u4e2d\u7684\u4e00\u4e9b\u4ee3\u7801\uff0c\u6765\u7406\u89e3\u5982\u4f55\u5f00\u53d1\u4f7f\u7528`RateLimiter SPI`\u7684\u63a5\u53e3\u65b9\u6cd5,\u5e76\u4e0eRedis\u6709\u6548\u534f\u4f5c\u3002\\n\\n`Ratelimiter SPI`\u76ee\u524d\u63d0\u4f9b\u4e864\u79cd\u9650\u6d41\u7b97\u6cd5:\\n\\n| Algorithm name            | Java class                          | Lua script file                        |\\n| ------------------------- | ----------------------------------- | -------------------------------------- |\\n| Request rate limiter      | `TokenBucketRateLimiterAlgorithm`   | request_rate_limiter.lua               |\\n| Slide window rate limiter | `SlidingWindowRateLimiterAlgorithm` | liding_window_request_rate_limiter.lua |\\n| Concurrent rate limiter   | `ConcurrentRateLimiterAlgorithm`    | concurrent_request_rate_limiter.lua    |\\n| Leaky bucket algorithm    | `LeakyBucketRateLimiterAlgorithm`   | request_leaky_rate_limiter.lua         |\\n\\n1. \u4ee4\u724c\u6876\u9650\u6d41\uff1a\u6309\u8bf7\u6c42\u6570\u91cf\u9650\u6d41\uff0c\u8bbe\u7f6e\u6bcf\u79d2N\u4e2a\u8bf7\u6c42\uff0c\u8d85\u8fc7N\u7684\u8bf7\u6c42\u4f1a\u62d2\u7edd\u670d\u52a1\u3002\u7b97\u6cd5\u5b9e\u73b0\u65f6\uff0c\u4ee5\u65f6\u95f4\u95f4\u9694\u8ba1\u7b97\u5300\u901f\u4ea7\u751f\u4ee4\u724c\u7684\u6570\u91cf\u3002\u82e5\u6bcf\u6b21\u8bf7\u6c42\u7684\u6570\u91cf\uff0c\u5c0f\u4e8e\u6876\u5185\u4ee4\u724c\u7684\u6570\u91cf\uff0c\u5219\u5141\u8bb8\u901a\u8fc7\u3002 \u65f6\u95f4\u7a97\u53e3\u4e3a 2*\u5bb9\u79ef/\u901f\u7387\u3002\\n2. \u6ed1\u52a8\u7a97\u53e3\u9650\u6d41\uff1a\u4e0e\u4ee4\u724c\u6876\u9650\u6d41\u4e0d\u540c\u5728\u4e8e\uff0c\u5176\u7a97\u53e3\u5927\u5c0f\u6bd4\u4ee4\u724c\u6876\u7684\u7a97\u53e3\u5c0f\uff0c\u4e3a\u4e00\u4e2a\u5bb9\u79ef/\u901f\u7387\u3002\u5e76\u4e14\u6bcf\u6b21\u79fb\u52a8\u5411\u540e\u4e00\u4e2a\u65f6\u95f4\u65f6\u95f4\u7a97\u53e3\u3002\u5176\u4ed6\u9650\u6d41\u539f\u7406\u4e0e\u4ee4\u724c\u6876\u7c7b\u4f3c\u3002\\n3. \u5e76\u53d1\u7684\u8bf7\u6c42\u901f\u7387\u9650\u6d41\uff1a\u4e25\u683c\u9650\u5236\u5e76\u53d1\u8bbf\u95ee\u91cf\u4e3aN\u4e2a\u8bf7\u6c42\uff0c\u5927\u4e8eN\u7684\u8bf7\u6c42\u4f1a\u88ab\u62d2\u7edd\u3002\u6bcf\u6b21\u5f53\u6709\u65b0\u8bf7\u6c42\uff0c\u67e5\u770b\u8ba1\u6570\u662f\u5426\u5927\u4e8eN, \u82e5\u5c0f\u4e8eN\u5219\u5141\u8bb8\u901a\u8fc7\uff0c\u8ba1\u6570\u52a01\u3002 \u5f53\u8fd9\u4e2a\u8bf7\u6c42\u8c03\u7528\u7ed3\u675f\u65f6\uff0c\u4f1a\u91ca\u653e\u8fd9\u4e2a\u4fe1\u53f7\uff08\u8ba1\u6570\u51cf1\uff09\\n4. \u6f0f\u6876\u7b97\u6cd5:  \u76f8\u5bf9\u4e8e\u4ee4\u724c\u6876\u7b97\u6cd5\uff0c\u6f0f\u6876\u7b97\u6cd5\u6709\u52a9\u4e8e\u51cf\u5c11\u6d41\u91cf\u805a\u96c6\uff0c\u5b9e\u73b0\u66f4\u4e3a\u5e73\u6ed1\u7684\u9650\u6d41\u5904\u7406\u3002 \u6f0f\u6876\u7b97\u6cd5\u5f3a\u5236\u4ee5\u5e38\u6570N\u7684\u901f\u7387\u8f93\u51fa\u6d41\u91cf\uff0c\u5176\u4ee5\u6f0f\u6876\u4e3a\u6a21\u578b\uff0c\u53ef\u6f0f\u6c34\u7684\u91cf\u4e3a\u65f6\u95f4\u95f4\u9694 *\u901f\u7387\u3002\u82e5\u53ef\u6f0f\u6c34\u91cf>\u5df2\u4f7f\u7528\u91cf\uff0c\u5219\u5df2\u4f7f\u7528\u91cf\u8bbe\u4e3a0( \u6e05\u7a7a\u6f0f\u6876)\uff0c\u5426\u5219\u5df2\u4f7f\u7528\u91cf\u8981\u51cf\u53bb\u53ef\u6f0f\u6c34\u91cf\u3002  \u82e5\u8bf7\u6c42\u6570\u91cf+ \u5df2\u4f7f\u7528\u91cf< \u603b\u5bb9\u91cf\uff0c\u5219\u5141\u8bb8\u8bf7\u6c42\u901a\u8fc7\u3002\\n\\n\u4e0b\u9762\u4ee5 \u5e76\u884c\u9650\u6d41\u7b97\u6cd5\u4e3a\u4f8b\uff0c\u89e3\u8bfbLua\u548cJava\u4ee3\u7801\uff0c\u67e5\u770bcallback \u65b9\u6cd5\u7684\u4f7f\u7528\u3002 \u901a\u8fc7\u89e3\u8bfb\u4ee4\u724c\u6876\u548c\u6ed1\u52a8\u7a97\u53e3\u7b97\u6cd5\u4ee3\u7801\uff0c\u4e86\u89e3getKey()\u65b9\u6cd5\u7684\u4f7f\u7528\u3002\\n\\n### \u5e76\u53d1\u8bf7\u6c42\u6570\u9650\u6d41\u4e2d\u4f7f\u7528callback\u65b9\u6cd5\\n\\n\u9996\u5148`ConcurrentRateLimiterAlgorithm` \u7684`getKeys()` \u65b9\u6cd5\u8986\u5199\u4e86\u62bd\u8c61\u7c7b\u4e2d\u7684\u6a21\u677f\u65b9\u6cd5\uff1a\\n\\n```java\\n    @Override\\n    public List<String> getKeys(final String id) {\\n        String tokenKey = getKeyName() + \\".{\\" + id + \\"}.tokens\\";\\n        String requestKey = UUIDUtils.getInstance().generateShortUuid();\\n        return Arrays.asList(tokenKey, requestKey);\\n    }\\n```\\n\\n\u7b2c\u4e8c\u4e2a\u5143\u7d20 requestKey \u662f\u4e00\u4e2along\u578b\u4e0d\u91cd\u590d\u503c(\u7531\u4e00\u4e2a\u5206\u5e03\u5f0fID\u4ea7\u751f\u5668\u4ea7\u751f\u7684\uff0c\u9012\u589e\uff0c\u6bd4\u5f53\u524d\u65f6\u95f4EpochSecond\u5c0f)\uff0c \u76f8\u5e94\u7684concurrent_request_rate_limiter.lua\u7684\u4ee3\u7801\uff1a\\n\\n```lua\\nlocal key = KEYS[1]\\n\\nlocal capacity = tonumber(ARGV[2])\\nlocal timestamp = tonumber(ARGV[3])\\nlocal id = KEYS[2]\\n```\\n\\n\u8fd9\u91ccid \u5373\u662f\u53d6\u5f97\u4e0a\u9762\u7684getKeys()\u65b9\u6cd5\u4ea7\u751f\u7684requestKey\uff0c \u4e00\u4e2auuid.  \u540e\u7eed\u7684\u5904\u7406\u5982\u4e0b\uff1a\\n\\n```lua\\nlocal count = redis.call(\\"zcard\\", key)\\nlocal allowed = 0\\n\\nif count < capacity then\\n  redis.call(\\"zadd\\", key, timestamp, id)\\n  allowed = 1\\n  count = count + 1\\nend\\nreturn { allowed, count }\\n```\\n\\n\u5148\u7528zcard\u547d\u4ee4\u7edf\u8ba1redis\u4e2dkey\u503c\u6240\u5bf9\u5e94\u7684\u6709\u5e8f\u96c6\u5408\u4e2d\u7684\u5143\u7d20\u4e2a\u6570\uff0c\u82e5\u5143\u7d20\u603b\u6570count\u5c0f\u4e8e\u5bb9\u91cf\uff0c\u5219\u5141\u8bb8\u901a\u8fc7\uff0c\u5e76\u7528zadd key score member\u65b9\u6cd5\uff0c\u5411key\u6240\u5728\u7684\u6709\u5e8f\u96c6\u5408\u4e2d\uff0c\u6dfb\u52a0\u4e00\u4e2a\u5143\u7d20id, \u5176score\u4e3atimestamp.  \u5219\u6b64\u65f6\u5143\u7d20\u7684\u603b\u4e2a\u6570count\u5b9e\u9645\u4e3acount+1.  \\n\\n\u4ee5\u4e0a\u7684\u4ee3\u7801\u90fd\u662f\u5728redis\u4e2d\u4f5c\u4e3a\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\u6765\u6267\u884c\u7684\u3002\u5f53\u540c\u4e00\u4e2akey (\u4f8b\u5982Ip\u4e0b)\u6709\u5927\u91cf\u5e76\u53d1\u8bf7\u6c42\u65f6\uff0credis\u8bb0\u5f55\u7684\u8be5ip\u7684\u6709\u5e8f\u96c6\u5408\u7684\u6570\u91cfcount\u4e5f\u5728\u4e0d\u65ad\u7d2f\u52a0\u4e2d\u3002\u5f53\u8d85\u8fc7\u5bb9\u91cf\u9650\u5236\uff0c\u5219\u4f1a\u62d2\u7edd\u670d\u52a1\u3002\\n\\n\u5e76\u53d1\u8bf7\u6c42\u6570\u9650\u6d41\u7b97\u6cd5\u4e2d\uff0c\u8981\u6c42\u5f53\u8bf7\u6c42\u8c03\u7528\u7ed3\u675f\u65f6\uff0c\u8981\u91ca\u653e\u8fd9\u4e2a\u4fe1\u53f7\u91cf\uff0clua\u4ee3\u7801\u4e2d\u5e76\u6ca1\u6709\u505a\u8fd9\u4e2a\u5904\u7406\u3002\\n\\n\u6211\u4eec\u6765\u770b\u770b `ConcurrentRateLimiterAlgorithm`\u7c7b\u4e2d\u7684\u56de\u8c03\u51fd\u6570\uff1a\\n\\n```java\\n    @Override\\n    @SuppressWarnings(\\"unchecked\\")\\n    public void callback(final RedisScript<?> script, final List<String> keys, final List<String> scriptArgs) {\\n        Singleton.INST.get(ReactiveRedisTemplate.class).opsForZSet().remove(keys.get(0), keys.get(1)).subscribe();\\n    }\\n```\\n\\n\u8fd9\u91cc\u505a\u4e86\u4e00\u4e2a\u5f02\u6b65\u7684\u8ba2\u9605\u5904\u7406\uff0c\u901a\u8fc7`ReactiveRedisTemplate`\u5220\u9664redis\u4e2d(key, id)\u7684\u5143\u7d20\uff0c\u7b49\u5f85\u8c03\u7528\u7ed3\u675f\u540e\uff0c\u91ca\u653e\u8fd9\u4e2a\u4fe1\u53f7\u3002\u8fd9\u4e2aremove\u7684\u5904\u7406\u4e0d\u80fd\u653e\u5230lua\u811a\u672c\u4e2d\u6267\u884c\uff0c\u5426\u5219\u903b\u8f91\u5c31\u662f\u9519\u8bef\u7684\u3002\u8fd9\u4e5f\u6b63\u662f`RateLimiterAlgorithm` SPI \u8bbe\u8ba1`callback`\u65b9\u6cd5\u7684\u7528\u610f\u3002\\n\\n### \u4ee4\u724c\u6876\u7b97\u6cd5\u4e2d\u4f7f\u7528getKeys()\\n\\n\u5bf9\u5e94\u7684Lua \u4ee3\u7801\u5982\u4e0b\uff1a\\n\\n```java\\nlocal tokens_key = KEYS[1]\\nlocal timestamp_key = KEYS[2]\\n```\\n\\n\u7701\u7565\u83b7\u53d6\u53c2\u6570\u7684\u4ee3\u7801\\n\\n```lua\\nlocal fill_time = capacity/rate\\nlocal ttl = math.floor(fill_time*2)\\n```\\n\\n\u65f6\u95f4\u7a97\u53e3ttl \u5927\u6982\u662f 2* \u5bb9\u91cf/\u901f\u7387.\\n\\n```lua\\nlocal last_tokens = tonumber(redis.call(\\"get\\", tokens_key))\\nif last_tokens == nil then\\n  last_tokens = capacity\\nend\\n```\\n\\n\u4ece\u6709\u5e8f\u96c6\u5408\u4e2d\u53d6\u5f97\u4e0a\u6b21\u4f7f\u7528\u7684token,\u5982\u679c\u6ca1\u6709\u5219last_tokens = \u5bb9\u91cf\u3002\\n\\n```lua\\nlocal last_refreshed = tonumber(redis.call(\\"get\\", timestamp_key))\\nif last_refreshed == nil then\\n  last_refreshed = 0\\nend\\n```\\n\\n\u4ee5timestamp_key\u4e3akey,\u4ece\u6709\u5e8f\u96c6\u5408\u4e2d\u53d6\u5f97\u4e0a\u6b21\u5237\u65b0\u65f6\u95f4\uff0c\u9ed8\u8ba4\u4e3a0.\\n\\n```lua\\nlocal delta = math.max(0, now-last_refreshed)\\nlocal filled_tokens = math.min(capacity, last_tokens+(delta*rate))\\nlocal allowed = filled_tokens >= requested\\nlocal allowed_num = 0\\nif allowed then\\n  new_tokens = filled_tokens - requested\\n  allowed_num = 1\\nend\\n\\n```\\n\\n\u65f6\u95f4\u95f4\u9694*\u901f\u7387\u5300\u901f\u4ea7\u751f\u4ee4\u724c\uff0c\u82e5\u4ee4\u724c\u6570\u91cf>\u8bf7\u6c42\u6570\u91cf\uff0c\u5219allowed=1, \u5e76\u4e14\u66f4\u65b0\u4ee4\u724c\u6570\u91cf\u3002\\n\\n```lua\\nredis.call(\\"setex\\", tokens_key, ttl, new_tokens)\\nredis.call(\\"setex\\", timestamp_key, ttl, now)\\n\\nreturn { allowed_num, new_tokens }\\n```\\n\\n\u8fd9\u91ccnow\u662f\u4f20\u5165\u7684\u5f53\u524d\u65f6\u95f4(EpochSecond)\uff0c\u8bbe\u7f6e`tokens_key`\u6240\u5bf9\u5e94\u7684\u6709\u5e8f\u96c6\u5408\u7684\u503c\u4e3a `new_tokens`\uff08\u5373\u65b0\u4ee4\u724c\u6570\u91cf) \uff0c \u8fc7\u671f\u65f6\u95f4\u4e3a`ttl`\u3002 \u66f4\u65b0\u96c6\u5408\u4e2d\uff0c`timestamp_key`\u7684\u503c\u4e3a\u5f53\u524d\u65f6\u95f4\uff0c\u8fc7\u671f\u65f6\u95f4\u4e3a`ttl`.\\n\\n### \u6ed1\u52a8\u7a97\u53e3\u7b97\u6cd5\u4e2d\u4f7f\u7528`getKeys`\u65b9\u6cd5\\n\\n\u5728`SlidingWindowRateLimiterAlgorithm` \u7684`getKeys()`\u540c\u6837\u8986\u5199\u4e86\u7236\u7c7b\uff0c\u4ee3\u7801\u4e0e`ConcurrentRateLimiterAlgorithm` \u65b9\u6cd5\u4ee3\u7801\u4e00\u81f4\u3002\\n\\n\u5982\u4e0b\u4e3a\u6ed1\u52a8\u7a97\u53e3\u7b97\u6cd5\u7684Lua\u4ee3\u7801\uff0c\u7701\u7565\u4e86\u5176\u4ed6\u53c2\u6570\u7684\u63a5\u6536\u4ee3\u7801\u3002\\n\\n```lua\\nlocal timestamp_key = KEYS[2]\\n...... \\nlocal window_size = tonumber(capacity / rate)\\nlocal window_time = 1\\n```\\n\\n\u8bbe\u5b9a\u7a97\u53e3\u5927\u5c0f\u4e3a\u5bb9\u79ef/\u901f\u7387\u3002\\n\\n```lua\\nlocal last_requested = 0\\nlocal exists_key = redis.call(\'exists\', tokens_key)\\nif (exists_key == 1) then\\n    last_requested = redis.call(\'zcard\', tokens_key)\\nend\\n```\\n\\n\u83b7\u53d6\u5f53\u524dkey \u7684\u57fa\u6570\\n\\n```lua\\nlocal remain_request = capacity - last_requested\\nlocal allowed_num = 0\\nif (last_requested < capacity) then\\n    allowed_num = 1\\n    redis.call(\'zadd\', tokens_key, now, timestamp_key)\\nend\\n```\\n\\n\u8ba1\u7b97\u5269\u4f59\u53ef\u7528\u91cf = \u5bb9\u91cf \u51cf\u53bb\u5df2\u4f7f\u7528\u91cf\uff0c\u82e5`last_requested` < capacity ,\u5219\u5141\u8bb8\u901a\u8fc7\uff0c\u5e76\u4e14\u5728`tokens_key`\u4e3akey\u7684\u6709\u5e8f\u96c6\u5408\u4e2d\uff0c\u589e\u52a0\u4e00\u4e2a \u5143\u7d20\uff08key =`timestam_key`,value= `now`)\\n\\n```lua\\nredis.call(\'zremrangebyscore\', tokens_key, 0, now - window_size / window_time)\\nredis.call(\'expire\', tokens_key, window_size)\\n\\nreturn { allowed_num, remain_request }\\n```\\n\\n\u524d\u9762\u5df2\u7ecf\u8bbe\u5b9a`window_time`=1, \u7528Redis\u7684 `zremrangebyscore`\u547d\u4ee4\uff0c\u79fb\u9664\u6709\u5e8f\u96c6\u5408\u4e2d\uff0cscore\u4e3a[0- \u5f53\u524d\u65f6\u95f4-\u7a97\u53e3\u5927\u5c0f]\u7684\u5143\u7d20\uff0c\u5373\u79fb\u52a8\u4e00\u4e2a\u7a97\u53e3\u5927\u5c0f\u3002\u8bbe\u5b9atokens_key\u7684\u8fc7\u671f\u65f6\u95f4\u4e3a\u7a97\u53e3\u5927\u5c0f\u3002\\n\\n\u5728`AbstractRateLimiterAlgorithm`\u7684\u6a21\u677f\u65b9\u6cd5\u4e2d\uff0c`getKeys(final String id)` \u7ed9\u51fa\u7684\u7b2c\u4e8c\u4e2a\u503c(\u4ee5`secondKey`\u6307\u4ee3)\uff0c\u662f\u62fc\u63a5\u4e86\\\\{id} (\u5373resolve key)\u7684\u4e00\u4e2a\u56fa\u5b9a\u5b57\u7b26\u4e32\u3002\u4ece\u4e0a\u9762\u4e09\u4e2a\u7b97\u6cd5\u4ee3\u7801\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u4ee4\u724c\u6876\u7b97\u6cd5\u4e2d\uff0c`secondKey`\u5728Lua\u4ee3\u7801\u6267\u884c\u4e2d\u4f1a\u66f4\u65b0\u4e3a\u6700\u65b0\u7684\u65f6\u95f4\uff0c\u6240\u4ee5\u65e0\u6240\u8c13\u4f20\u5165\u7684\u503c\u3002\u800c\u5728\u5e76\u53d1\u9650\u6d41\u7b97\u6cd5\u4e2d\uff0c\u4f1a\u4ee5\u6b64`secondKey`\u4e3a\u6761\u4ef6\uff0c\u5728java `callback`\u65b9\u6cd5\u4e2d\u79fb\u9664\u5bf9\u5e94\u7684\u5143\u7d20\u3002\u800c\u5728\u6ed1\u52a8\u7a97\u53e3\u7b97\u6cd5\u4e2d\uff0c\u8fd9\u4e2a`secondKey`\u7684\u503c\uff0c\u4f1a\u4f5c\u4e3a\u4e00\u4e2a\u65b0\u5143\u7d20\u7684key, \u589e\u52a0\u5230\u5f53\u524d\u6709\u5e8f\u96c6\u5408\u4e2d\uff0c\u5e76\u5728\u505a\u7a97\u53e3\u6ed1\u52a8\u4e2d\uff0c\u8fc7\u671f\u7684\u8d44\u6599\u4f1a\u88ab\u5220\u9664\u6389\u3002\\n\\n\u603b\u4e4b\uff0c\u5f53\u8bbe\u8ba1\u65b0\u7684\u9650\u6d41\u7b97\u6cd5\u65f6\uff0c\u8981\u6839\u636e\u7b97\u6cd5\u9700\u8981\u4ed4\u7ec6\u8bbe\u8ba1`getKey()`\u65b9\u6cd5\u3002\\n\\n## \u5982\u4f55\u8c03\u7528 RateLimiter SPI\\n\\n\u5728`RateLimiter` Plug\u4e2d\u7684`doExecute()`\u65b9\u6cd5\u4e2d\uff0c\u4f20\u5165\u7684\u4e09\u4e2a\u53c2\u6570 exchange \u4e3a\u8bf7\u6c42\u7684\u8fde\u63a5\uff0c chain \u4e3ashenyu\u63d2\u4ef6\u7684\u8c03\u7528\u94fe\uff0cselector \u662f\u9009\u62e9\u5668\uff0crule\u662f\u7cfb\u7edf\u4e2d\u914d\u7f6e\u7684\u89c4\u5219\u53c2\u6570\u8d44\u6599\u3002\\n\\n```java\\nprotected Mono<Void> doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {\\n    RateLimiterHandle limiterHandle = RatelimiterRuleHandleCache.getInstance()\\n        .obtainHandle(CacheKeyUtils.INST.getKey(rule));\\n    String resolverKey = Optional.ofNullable(limiterHandle.getKeyResolverName())\\n        .flatMap(name -> Optional.of(\\"-\\" + RateLimiterKeyResolverFactory.newInstance(name).resolve(exchange)))\\n        .orElse(\\"\\");\\n    return redisRateLimiter.isAllowed(rule.getId() + resolverKey, limiterHandle)\\n        .flatMap(response -> {\\n            if (!response.isAllowed()) {\\n                exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);\\n                Object error = ShenyuResultWrap.error(ShenyuResultEnum.TOO_MANY_REQUESTS.getCode(), ShenyuResultEnum.TOO_MANY_REQUESTS.getMsg(), null);\\n                return WebFluxResultUtils.result(exchange, error);\\n            }\\n            return chain.execute(exchange);\\n        });\\n}\\n```\\n\\n1.\u9996\u5148\uff0c\u4ece\u7f13\u5b58\u4e2d\uff0c\u53d6\u5f97\u7cfb\u7edf\u8bbe\u5b9a\u7684\u9650\u6d41\u53c2\u6570`RateLimiterHandle`\u5b9e\u4f8b `limiterHandle`.\\n2.\u6839\u636ename\u6307\u5b9a\u7684Resolver \u83b7\u5f97\u8bf7\u6c42\u7684\u8fde\u63a5Key\u4fe1\u606f\uff08\u5982\u5730\u5740\u7b49).\\n3.\u8c03\u7528 RedisRateLimiter\u7684 isAllowed\u65b9\u6cd5, \u83b7\u53d6\u8fd4\u56de\u503c\u540e\uff0c\\n4.\u82e5`isAllowd`=false,\u505a\u9519\u8bef\u5904\u7406\\n5.\u5982\u679c `isAllowed`=true\uff0creturn chain.execute(exchange)\uff0c \u5bf9\u8be5\u8bf7\u6c42\u505a\u540e\u7eed\u5904\u7406\uff0c\u4f20\u9012\u5230\u8c03\u7528\u94fe\u7684\u4e0b\u4e00\u5173\u3002\\n\\n## Summary\\n\\n\u6574\u4e2a`RateLimiter` plugin\u6846\u67b6\u57fa\u4e8eSpring WebFlux\u5f00\u53d1\uff0c\u7528redis \u548clua\u811a\u672c\u505a\u9650\u6d41\u8ba1\u6570\u53ca\u6838\u5fc3\u903b\u8f91\u5904\u7406\uff0c\u652f\u6301\u9ad8\u5e76\u53d1\u53ca\u5f39\u6027\u6269\u5c55\u3002\\n\\n1. `RateLimiter` `SPI` \u63d0\u4f9b\u4e86\u4e24\u4e2a`SPI` \u63a5\u53e3\uff0c\u901a\u8fc7\u5e94\u7528\u9762\u5411\u63a5\u53e3\u8bbe\u8ba1\u53ca\u5404\u79cd\u8bbe\u8ba1\u6a21\u5f0f\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u589e\u52a0\u65b0\u7684\u9650\u6d41\u7b97\u6cd5\uff0c\u4ee5\u53ca\u5404\u79cd\u6d41\u91cf\u89e3\u6790\u89c4\u5219\u3002\\n\\n2. \u63d0\u4f9b\u4e86\u4ee4\u724c\u6876\u3001\u5e76\u53d1\u901f\u7387\u9650\u6d41\u3001\u6ed1\u52a8\u7a97\u53e3\u3001\u6f0f\u68764\u79cd\u9650\u6d41\u7b97\u6cd5\u3002\u5728\u8bbe\u8ba1\u7b97\u6cd5\u5b9e\u73b0\u65f6\uff0c\u9700\u8981\u6839\u636e\u7b97\u6cd5\u7279\u5f81\u8bbe\u8ba1KEY\u503c\uff0c\u7528Lua\u811a\u672c\u5b9e\u73b0\u5728redis\u4e2d\u8981\u5904\u7406\u7684\u903b\u8f91\uff0c\u8bbe\u8ba1`callback()`\u65b9\u6cd5\u505a\u540e\u7eed\u7684\u6570\u636e\u5904\u7406\u3002\\n3. \u54cd\u5e94\u5f0f\u7f16\u7a0b\uff0c\u5b9e\u73b0\u8fc7\u7a0b\u7b80\u6d01\u9ad8\u6548\u3002"},{"id":"/Start-SourceCode-Analysis-Start-Demo-for-Contributor","metadata":{"permalink":"/zh/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor.md","title":"\u793e\u533a\u65b0\u4eba\u5f00\u53d1\u8005\u542f\u52a8\u53ca\u5f00\u53d1\u9632\u8e29\u5751\u6307\u5357","description":"\u524d\u8a00","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"first-start","permalink":"/zh/blog/tags/first-start"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":7.4,"hasTruncateMarker":false,"authors":[{"name":"Yuxuan Zhang","title":"Apache ShenYu Contributor","url":"https://github.com/zuobiao-zhou","imageURL":"https://avatars.githubusercontent.com/u/61108539?s=400&u=f065b78a2944f2cea9160de7f7df054e2f157867&v=4"}],"frontMatter":{"title":"\u793e\u533a\u65b0\u4eba\u5f00\u53d1\u8005\u542f\u52a8\u53ca\u5f00\u53d1\u9632\u8e29\u5751\u6307\u5357","author":"Yuxuan Zhang","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/zuobiao-zhou","author_image_url":"https://avatars.githubusercontent.com/u/61108539?s=400&u=f065b78a2944f2cea9160de7f7df054e2f157867&v=4","tags":["first-start","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"RateLimiter SPI \u4ee3\u7801\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI"},"nextItem":{"title":"Apache ShenYu \u542f\u52a8\u793a\u4f8b","permalink":"/zh/blog/Start-SourceCode-Analysis-Start-Demo"}},"content":"## \u524d\u8a00\\n\\n\u4f5c\u4e3a `Shenyu` \u793e\u533a\u521d\u6765\u4e4d\u5230\u7684\u5f00\u53d1\u8005\uff0c\u6211\u5728\u6309\u7167\u76f8\u5173\u6559\u7a0b\u8fdb\u884c\u9879\u76ee\u542f\u52a8\u53ca\u5f00\u53d1\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9047\u5230\u4e86\u4e00\u4e9b\u6559\u7a0b\u4e2d\u5e76\u672a\u63d0\u53ca\u5230\u7684 \u201c\u5751\u201d \uff0c \u6211\u5c06\u6211\u542f\u52a8`shenyu` , `shenyu-dashboard`, `shenyu-website` \u7684\u8be6\u7ec6\u6b65\u9aa4\u8bb0\u5f55\u5728\u8fd9\u7bc7\u535a\u5ba2\u4e2d\uff0c\u5e0c\u671b\u53ef\u4ee5\u5e2e\u5230\u793e\u533a\u4e2d\u66f4\u591a\u7684\u65b0\u4eba\u5f00\u53d1\u8005\u3002\\n\\n## \u73af\u5883\u51c6\u5907\\n\\n- \u672c\u5730\u6b63\u786e\u5b89\u88c5 `JDK17` \u6216\u66f4\u9ad8\u7248\u672c\\n- \u672c\u5730\u6b63\u786e\u5b89\u88c5 `Git`\\n- \u672c\u5730\u6b63\u786e\u5b89\u88c5`Maven3.63` \u6216\u66f4\u9ad8\u7248\u672c\\n- \u9009\u62e9\u4e00\u6b3e\u5f00\u53d1\u5de5\u5177\uff0c\u672c\u6587\u4f7f\u7528 `IDEA` \u4e3a\u4f8b\\n\\n## ShenYu \u540e\u7aef\u542f\u52a8\u6307\u5357\\n\\n\\n\\n### \u5b89\u88c5\u5e76\u914d\u7f6eMaven\\n\\nMaven\u662f\u4e00\u4e2a\u8de8\u5e73\u53f0\u7684\u9879\u76ee\u7ba1\u7406\u5de5\u5177\u3002\u4f5c\u4e3aApache\u7ec4\u7ec7\u9876\u7ea7\u5f00\u6e90\u9879\u76ee\uff0c\u5176\u4e3b\u8981\u670d\u52a1\u4e8e\u57fa\u4e8eJava\u5e73\u53f0\u7684\u9879\u76ee\u521b\u5efa\uff0c\u4f9d\u8d56\u7ba1\u7406\u548c\u9879\u76ee\u4fe1\u606f\u7ba1\u7406\u3002\\n\\n1. [\u4e0b\u8f7d maven](https://maven.apache.org/download.cgi)\uff0c\u5e76\u89e3\u538b\u5230\u4e00\u4e2a\u6ca1\u6709\u4e2d\u6587\u6ca1\u6709\u7a7a\u683c\u7684\u8def\u5f84\u4e0b\u3002\\n\\n    ![](/img/activities/start-demo-for-contributor/maven-install.png)\\n\\n2. \u5c06 `maven` \u76ee\u5f55\u4e0b\u7684 `bin` \u76ee\u5f55\u6dfb\u52a0\u81f3\u73af\u5883\u53d8\u91cf\u4e2d\u3002\u4ee5 `Windows` \u4e3a\u4f8b\uff0c\u82e5\u4e0b\u8f7d\u76ee\u5f55\u4e3a `E:\\\\apache-maven-3.9.1` \uff0c\u5219\u5c06`E:\\\\apache-maven-3.9.1\\\\bin` \u6dfb\u52a0\u81f3 `Path` \u7cfb\u7edf\u53d8\u91cf\u4e2d\u3002\\n\\n3. \u9a8c\u8bc1\u662f\u5426\u5b89\u88c5\u6210\u529f\u3002\u5728\u547d\u4ee4\u884c\u7a97\u53e3\u4e2d\u8f93\u5165 `mvn -v` \uff0c\u82e5\u51fa\u73b0 Maven \u7248\u672c\u53ca Java \u7248\u672c\u5373\u4e3a\u5b89\u88c5\u6210\u529f\u3002\u5982\u4e0b\u6240\u793a\uff1a\\n\\n    ```shell\\n    C:\\\\Users\\\\pc>mvn -v\\n    Apache Maven 3.9.1 (2e178502fcdbffc201671fb2537d0cb4b4cc58f8)\\n    Maven home: E:\\\\apache-maven-3.9.1\\n    Java version: 18.0.1.1, vendor: Oracle Corporation, runtime: C:\\\\Program Files\\\\Java\\\\jdk-18.0.1.1\\n    Default locale: zh_CN, platform encoding: UTF-8\\n    OS name: \\"windows 10\\", version: \\"10.0\\", arch: \\"amd64\\", family: \\"windows\\"\\n    ```\\n\\n4. \u4e3a\u4e86\u52a0\u5feb\u9879\u76ee\u76f8\u5173\u4f9d\u8d56\u7684\u4e0b\u8f7d\u901f\u5ea6\uff0c\u9700\u8981\u66f4\u6539 Maven \u955c\u50cf\uff0c\u6b64\u5904\u6dfb\u52a0\u963f\u91cc\u4e91\u7b49\u955c\u50cf\u3002\u5c06 `conf/settings.xml` \u4e2d `<mirrors> </mirrors>` \u6807\u7b7e\u5bf9\u66f4\u6539\u4e3a\u4ee5\u4e0b\u5185\u5bb9\uff1a\\n\\n    ```xml\\n    <mirrors>\\n        <mirror>\\n        <id>alimaven</id>\\n        <name>aliyun maven</name>\\n        <url>http://maven.aliyun.com/nexus/content/groups/public/</url>\\n        <mirrorOf>central</mirrorOf>\\n        </mirror>\\n    \\n        <mirror>\\n        <id>alimaven</id>\\n        <mirrorOf>central</mirrorOf>\\n        <name>aliyun maven</name>\\n        <url>http://maven.aliyun.com/nexus/content/repositories/central/</url>\\n        </mirror>\\n    \\n        <mirror>\\n        <id>maven</id>\\n        <mirrorOf>central</mirrorOf>\\n        <name>name_</name>\\n        <url>http://repo1.maven.org/maven2</url>\\n        </mirror> \\n    \\n        <mirror>\\n        <id>junit</id>\\n        <mirrorOf>central</mirrorOf>\\n        <name>junit address/</name>\\n        <url>http://jcenter.bintray.com/</url>\\n        </mirror>\\n    </mirrors>\\n    ```\\n\\n    \u5e76\u5728 `</mirrors>` \u4e0b\u4e00\u884c\u6dfb\u52a0 `<localRepository>E:/maven_local_repository</localRepository>`\u8bbe\u7f6e Maven \u672c\u5730\u4ed3\u5e93\u4f4d\u7f6e\u3002\u5177\u4f53\u4f4d\u7f6e\u53ef\u81ea\u884c\u6307\u5b9a\u3002\\n\\n### \u62c9\u53d6 ShenYu \u4ee3\u7801\\n\\n1. \u5728 Github \u4e0a Fork [ShenYu](https://github.com/apache/shenyu) \u4ed3\u5e93\u5230\u81ea\u5df1\u7684\u5b58\u50a8\u5e93\u4e2d\uff0c\u4ee5\u540e\u53ef\u5728\u6b64\u4ed3\u5e93\u4e2d\u8fdb\u884c\u5f00\u53d1\u5e76\u63d0\u4ea4 PR\\n2. \u4f7f\u7528 Git \u5c06\u4e0a\u4e00\u6b65 Fork \u7684\u4ed3\u5e93\u4e0b\u8f7d\u5230\u672c\u5730\uff1a\\n\\n    ```shell\\n    git clone git@github.com:${YOUR_USERNAME}/${TARGET_REPO}.git\\n    ```\\n\\n    \u82e5\u63d0\u793a\u6587\u4ef6\u540d\u8fc7\u957f\uff0c\u5219\u901a\u8fc7\u547d\u4ee4\u884c\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a\\n\\n    ```shell\\n    git config --global core.longpaths true\\n    ```\\n\\n\\tTips: \u5982\u679c\u63d0\u793a\u5982\u4e0b\u9519\u8bef\u6216\u8005\u7f51\u7edc\u4e0d\u597d\u65e0\u6cd5\u62c9\u53d6\u5168\u90e8\u4ee3\u7801\uff1a\\n\\t\\n\\t``` tex\\n\\tRPC failed; curl 92 HTTP/2 stream 5 was not closed cleanly: CANCEL (err 8) 2057 bytes of body are still expected fetch-pack: unexpected disconnect while reading sideband packet early EOF fetch-pack: invalid index-pack output\\n\\t```\\n\\t\\n\\t\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u5148\u62c9\u53d6\u4e00\u4e2a\u7248\u672c\u7684\u4ee3\u7801,\u7136\u540e\u5728\u83b7\u53d6\u5168\u91cf\u4ee3\u7801.\\n\\t\\n\\t``` shell\\n\\tgit clone https://github.com/apache/shenyu.git --depth 1\\n\\tcd ./shenyu\\n\\tgit fetch --unshallow\\n\\t```\\n\\t\\n\\t\\n\\n### ShenYu \u521d\u542f\u52a8\\n\\n#### \u51c6\u5907\u5de5\u4f5c\\n\\n1. \u5728 `shenyu` \u76ee\u5f55\u4e0b\u4f7f\u7528 Maven \u8fdb\u884c\u7f16\u8bd1\uff1a\\n\\n    ```shell\\n    mvn clean install -Dmaven.javadoc.skip=true -B -Drat.skip=true -Djacoco.skip=true -DskipITs -DskipTests\\n    ```\\n\\n2. \u914d\u7f6e IDEA \u73af\u5883\u3002\u4f7f\u7528 IDEA \u6253\u5f00 `shenyu` \u9879\u76ee\uff0c\u70b9\u51fb\u5de6\u4e0a\u89d2 `File` -> `Settings` \uff0c\u6309\u7167\u4e0b\u56fe\u914d\u7f6e  Maven \u3002\u5176\u4e2d `User settings file` \u9009\u62e9\u4f60\u7684 `settings.xml` \u6240\u5728\u76ee\u5f55\uff0c `Local repository` \u4f1a\u81ea\u52a8\u52a0\u8f7d `settings.xml` \u4e2d\u8bbe\u7f6e\u7684 `localRepository` \u8def\u5f84\uff1a\\n\\n    ![](/img/activities/start-demo-for-contributor/idea-config.png)\\n\\n3. \u6b64\u65f6\uff0cIDEA \u4f1a\u81ea\u52a8\u4e0b\u8f7d\u9879\u76ee\u76f8\u5173\u4f9d\u8d56\uff0c\u9700\u7b49\u5f85\u4e00\u4f1a\uff0c\u5b8c\u6210\u540e\u5982\u4e0b\u56fe\u6240\u793a\uff1a\\n\\n    ![](/img/activities/start-demo-for-contributor/project-without-example.png)\\n\\n    \u53ef\u4ee5\u53d1\u73b0\uff0c `shenyu-e2e`, `shenyu-examples`, `shenyu-integrated-test` \u6ca1\u6709\u88ab IDEA \u6807\u8bb0\u4e3a Maven \u9879\u76ee\uff0c\u9700\u624b\u52a8\u6dfb\u52a0\u3002\u5206\u522b\u9009\u4e2d\u5305\u4e2d\u7684 `pom.xml` \u6587\u4ef6\uff0c\u53f3\u952e\u70b9\u51fb `Add as Maven Project` \u3002\\n    \u82e5 shenyu-e2e \u6784\u5efa\u5931\u8d25\uff0c\u5219\u5c06\u5176 `pom.xml` \u4e2d `<relativePath>./pom.xml</relativePath>` \u6539\u4e3a `<relativePath/>` \u3002\\n\\n#### \u542f\u52a8\u7f51\u5173\u670d\u52a1\\n\\n1. \u542f\u52a8 `shenyu-admin` \u63a7\u5236\u53f0\uff08\u9ed8\u8ba4\u4f7f\u7528H2\u6570\u636e\u5e93\uff09\\n\\n    ![](/img/activities/start-demo-for-contributor/admin.png)\\n\\n2. \u542f\u52a8 `shenyu-bootstrap`\\n\\n    ![](/img/activities/start-demo-for-contributor/bootstrap.png)\\n\\n> \u5230\u8fd9\u4e00\u6b65\uff0cshenyu\u7f51\u5173\u5df2\u7ecf\u542f\u52a8\u3002\\n>\\n> \u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u6d4f\u89c8\u5668\uff0c\u8bbf\u95eeadmin\u63a7\u5236\u53f0\uff1a[http://localhost:9095/](http://localhost:9095/)\\n>\\n> \u9ed8\u8ba4\u8d26\u53f7\uff1aadmin \uff0c\u9ed8\u8ba4\u5bc6\u7801\uff1a123456\\n\\n#### \u542f\u52a8\u5e94\u7528\u670d\u52a1\\n\\nApache ShenYu\u63d0\u4f9b\u4e86Http\u3001Dubbo\u3001SpringCloud\u7b49\u5e94\u7528\u63a5\u5165shenyu\u7f51\u5173\u7684\u6837\u4f8b\uff0c\u4f4d\u4e8e `shenyu-example` \u6a21\u5757\uff0c\u8fd9\u91cc\u4ee5Http\u670d\u52a1\u4e3a\u4f8b\u3002\\n\\n\u542f\u52a8 `shenyu-examples-http`\u3002\\n\\n![](/img/activities/start-demo-for-contributor/shenyu-examples-http.png)\\n\\n\u8fd9\u65f6\uff0c`shenyu-examples-http` \u4f1a\u81ea\u52a8\u628a\u52a0 `@ShenyuSpringMvcClient` \u6ce8\u89e3\u7684\u63a5\u53e3\u65b9\u6cd5\uff0c\u4ee5\u53caapplication.yml\u4e2d\u7684\u76f8\u5173\u914d\u7f6e\u6ce8\u518c\u5230\u7f51\u5173\u3002\u6211\u4eec\u6253\u5f00 [admin\u63a7\u5236\u53f0](http://localhost:9095/)\uff0c\u5373\u53ef\u5728`\u63d2\u4ef6\u5217\u8868 -> Proxy -> divide` \u4e2d\u770b\u5230\u76f8\u5173\u914d\u7f6e\u3002\\n\\n#### \u6d4b\u8bd5Http\u8bf7\u6c42\\n\\n\u4e0b\u9762\u4f7f\u7528 `IDEA HTTP Client Plugin` \u6a21\u62df http \u7684\u65b9\u5f0f\u6765\u8bbf\u95ee http \u670d\u52a1\u3002\\n- \u672c\u5730\u8bbf\u95ee\uff0c\u4e0d\u4f7f\u7528 shenyu \u4ee3\u7406\\n\\n    ![](/img/activities/start-demo-for-contributor/shenyu-http-test-api-local.png)\\n\\n- \u4f7f\u7528 shenyu \u4ee3\u7406\\n\\n    ![](/img/activities/start-demo-for-contributor/shenyu-http-test-api.png)\\n\\n### \u4f7f\u7528\u66f4\u591a\u63d2\u4ef6\\n\\n\u6211\u4eec\u53ef\u4ee5\u53c2\u8003 [\u5b98\u65b9\u6587\u6863](https://shenyu.apache.org/zh/docs/index)\u5de6\u4fa7`\u63d2\u4ef6\u96c6\u5408`\uff0c\u6765\u4f7f\u7528\u6240\u9700\u8981\u63d2\u4ef6\u3002\\n\\n## Shenyu \u524d\u7aef\u542f\u52a8\u6307\u5357\\n\\n### \u5b89\u88c5 Node.js\\n\\n#### \u4e0b\u8f7d\\n\\n1. \u5728[\u5b98\u7f51](https://nodejs.org/en)\u4e0b\u8f7d\u5e76\u5b89\u88c5Node.js \uff0c\u9009\u62e9 `LTS` \u7248\u672c\u5373\u53ef\\n2. \u5b89\u88c5\u65f6\uff0c\u9664\u4e86\u8bbe\u7f6e\u5b89\u88c5\u8def\u5f84\uff0c\u5176\u4ed6\u4e00\u76f4\u70b9 `Next` \u5373\u53ef\\n3. \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u5728\u547d\u4ee4\u884c\u4e2d\u8fdb\u884c\u9a8c\u8bc1\uff1a\\n  \\n    ```shell\\n    C:\\\\Users\\\\pc>node -v\\n    v12.22.12\\n    \\n    C:\\\\Users\\\\pc>npm -v\\n    6.14.16\\n    ```\\n\\n#### \u6362\u6e90\\n\\n\u4e3a\u4e86\u52a0\u5feb npm \u4e0b\u8f7d\u901f\u5ea6\uff0c\u9700\u8981\u8fdb\u884c\u6362\u6e90\uff1a\\n\\n```shell\\n# \u67e5\u770b\u5f53\u524d\u6e90\\nnpm config get registry\\n# \u6362\u4e3a\u4e2d\u56fd npmmirror \u955c\u50cf\u6e90\\nnpm config set registry https://registry.npmmirror.com\\n# \u67e5\u770b\u662f\u5426\u6362\u6e90\u6210\u529f\\nnpm config get registry\\n```\\n\\n### \u62c9\u53d6 ShenYu Dashboard \u4ee3\u7801\\n\\n1. Fork [ShenYu Dashboard](https://github.com/apache/shenyu-dashboard) \u4ed3\u5e93\\n2. \u4f7f\u7528 Git \u4e0b\u8f7d\u5230\u672c\u5730\uff1a\\n\\n    ```shell\\n    git clone git@github.com:${YOUR_USERNAME}/${TARGET_REPO}.git\\n    ```\\n\\n### \u524d\u540e\u7aef\u8054\u5408\u5f00\u53d1\\n\\n1. \u5728\u540e\u7aef\u4ed3\u5e93 `shenyu` \u7684 `shenyu-admin/src/main/resources/application.yml` \u6587\u4ef6\u4e2d\u6309\u4e0b\u56fe\u6240\u793a\u6dfb\u52a0 `enablePrintApiLog: true` \uff0c\u4ee5\u5728\u540e\u7aef\u63a7\u5236\u53f0\u663e\u793a\u524d\u7aef\u63a5\u53e3\u88ab\u8c03\u7528\u7684\u65e5\u5fd7\u3002\\n\\n    ![](/img/activities/start-demo-for-contributor/enable-api-log.png)\\n\\n2. \u542f\u52a8 `ShenyuAdminBootstrap`\\n\\n3. \u5207\u6362\u81f3\u524d\u7aef\u4ed3\u5e93 `shenyu-dashboard` \uff0c\u6253\u5f00 `README` \uff0c\u4f9d\u6b21\u70b9\u51fb `npm install`, `npm start` \u6216\u901a\u8fc7\u547d\u4ee4\u884c\u8f93\u5165\u4e0a\u8ff0\u547d\u4ee4\u5373\u53ef\u901a\u8fc7 [http://localhost:8000](http://localhost:8000) \u8bbf\u95ee\u524d\u7aef\u754c\u9762\uff0c\u5e76\u53ef\u5728\u540e\u7aef\u63a7\u5236\u53f0\u4e2d\u663e\u793a\u524d\u7aef\u63a5\u53e3\u88ab\u8c03\u7528\u7684\u65e5\u5fd7\uff0c\u5b9e\u73b0\u524d\u540e\u7aef\u8054\u5408\u5f00\u53d1\u3002\\n\\n    ![](/img/activities/start-demo-for-contributor/admin-log.png)\\n\\n### \u6253\u5305\u524d\u7aef\u4ee3\u7801\\n\\n\u6267\u884c `README` \u4e2d `npm build` \u547d\u4ee4\uff0c\u5e76\u5c06 dist \u6587\u4ef6\u5939\u4e0b\u751f\u6210\u7684\u6240\u6709\u6587\u4ef6\u590d\u5236\u5230\u540e\u7aef\u4ed3\u5e93\u4e2d `shenyu-admin/src/main/resources/static/` \u76ee\u5f55\u4e0b\u3002\\n\\n## \u4e3a Shenyu \u5b98\u7f51\u505a\u8d21\u732e\\n\\n\u6309\u7167 [shenyu-website](https://github.com/apache/shenyu-website) \u4e2d `README` \u8fdb\u884c\u64cd\u4f5c\u5373\u53ef\u3002\\n\\n### \u5c0f\u8d34\u58eb\\n\\n1. \u53ef\u4ee5\u4e3a `yarn` \u8fdb\u884c\u6362\u6e90\uff0c\u6d41\u7a0b\u540c `npm`\\n2. \u5efa\u8bae\u4e0b\u8f7d `Node` [\u5b98\u7f51](https://nodejs.org/en)\u4e2d `LTS` \u7248\u672c\\n3. `Windows` \u7cfb\u7edf\u65e0\u6cd5\u8fdb\u884c\u90e8\u7f72\uff0c\u5982\u9700\u5bf9\u4f60\u7684\u66f4\u6539\u8fdb\u884c\u9a8c\u8bc1\uff0c\u53ef\u4ee5\u5728Linux \u865a\u62df\u673a\u6216\u670d\u52a1\u5668\u4e0a\u8fdb\u884c\u90e8\u7f72"},{"id":"/Start-SourceCode-Analysis-Start-Demo","metadata":{"permalink":"/zh/blog/Start-SourceCode-Analysis-Start-Demo","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Start-SourceCode-Analysis-Start-Demo.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/Start-SourceCode-Analysis-Start-Demo.md","title":"Apache ShenYu \u542f\u52a8\u793a\u4f8b","description":"\u73af\u5883\u51c6\u5907","date":"2025-12-08T10:21:50.000Z","formattedDate":"2025\u5e7412\u67088\u65e5","tags":[{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":1.905,"hasTruncateMarker":false,"authors":[{"name":"Kunshuai Zhu","title":"Apache ShenYu Contributor","url":"https://github.com/JooKS-me","imageURL":"https://avatars1.githubusercontent.com/u/62384022?v=4"}],"frontMatter":{"title":"Apache ShenYu \u542f\u52a8\u793a\u4f8b","author":"Kunshuai Zhu","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/JooKS-me","author_image_url":"https://avatars1.githubusercontent.com/u/62384022?v=4","tags":["Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"\u793e\u533a\u65b0\u4eba\u5f00\u53d1\u8005\u542f\u52a8\u53ca\u5f00\u53d1\u9632\u8e29\u5751\u6307\u5357","permalink":"/zh/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor"},"nextItem":{"title":"SPI\u8bbe\u8ba1\u5b9e\u73b0\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/SPI-SourceCode-Analysis-SPI"}},"content":"### \u73af\u5883\u51c6\u5907\\n\\n- \u672c\u5730\u6b63\u786e\u5b89\u88c5JDK1.8+\\n- \u672c\u5730\u6b63\u786e\u5b89\u88c5Git\\n- \u672c\u5730\u6b63\u786e\u5b89\u88c5Maven\\n- \u9009\u62e9\u4e00\u6b3e\u5f00\u53d1\u5de5\u5177\uff0c\u6bd4\u5982IDEA\\n\\n### \u62c9\u53d6ShenYu\u4ee3\u7801\\n\\n\u4f7f\u7528Git\u62c9\u53d6\u4ee3\u7801\\n\\n```shell\\ngit clone https://github.com/apache/incubator-shenyu.git\\n```\\n\\n### \u7f16\u8bd1\u4ee3\u7801\\n\\n\u4f7f\u7528Maven\u8fdb\u884c\u7f16\u8bd1\\n\\n```shell\\ncd incubator-shenyu\\nmvn clean install -Dmaven.javadoc.skip=true -B -Drat.skip=true -Djacoco.skip=true -DskipITs -DskipTests\\n```\\n\\n### \u542f\u52a8\u7f51\u5173\u670d\u52a1\\n\\n\u4f7f\u7528\u5f00\u53d1\u5de5\u5177\uff0c\u4ee5IDEA\u4e3a\u4f8b\u3002\\n\\n\u542f\u52a8 `shenyu-admin` \u63a7\u5236\u53f0\uff08\u9ed8\u8ba4\u4f7f\u7528H2\u6570\u636e\u5e93\uff09\\n\\n![start-demo-admin](/img/activities/start-demo/start-demo-admin.png)\\n\\n\u542f\u52a8 `shenyu-bootstrap`\\n\\n![start-demo-bootstrap](/img/activities/start-demo/start-demo-bootstrap.png)\\n\\n> \u5230\u8fd9\u4e00\u6b65\uff0cshenyu\u7f51\u5173\u5df2\u7ecf\u542f\u52a8\u3002\\n>\\n> \u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u6d4f\u89c8\u5668\uff0c\u8bbf\u95eeadmin\u63a7\u5236\u53f0\uff1a[http://localhost:9095/](http://localhost:9095/\uff0c\u9ed8\u8ba4\u8d26\u53f7\u5bc6\u7801\u4e3a\uff1aadmin/123456)\\n\\n### \u542f\u52a8\u5e94\u7528\u670d\u52a1\\n\\nApache ShenYu\u63d0\u4f9b\u4e86Http\u3001Dubbo\u3001SpringCloud\u7b49\u5e94\u7528\u63a5\u5165shenyu\u7f51\u5173\u7684\u6837\u4f8b\uff0c\u4f4d\u4e8e `shenyu-example` \u6a21\u5757\uff0c\u8fd9\u91cc\u4ee5Http\u670d\u52a1\u4e3a\u4f8b\u3002\\n\\n\u82e5 `shenyu-example` \u672a\u88abIDEA\u6807\u8bb0\u4e3aMaven\u9879\u76ee\uff0c\u53ef\u4ee5\u53f3\u952e\u70b9\u51fb `shenyu-example` \u76ee\u5f55\u4e0b\u7684 `pom.xml` \u6587\u4ef6\uff0c\u5c06\u5176\u6dfb\u52a0\u4e3aMaven\u9879\u76ee\u3002\\n\\n![start-demo-maven](/img/activities/start-demo/start-demo-maven.png)\\n\\n\u542f\u52a8 `shenyu-examples-http`\u3002\\n\\n![start-demo-examples-http](/img/activities/start-demo/start-demo-examples-http.png)\\n\\n\u8fd9\u65f6\uff0c`shenyu-examples-http` \u4f1a\u81ea\u52a8\u628a\u52a0 `@ShenyuSpringMvcClient` \u6ce8\u89e3\u7684\u63a5\u53e3\u65b9\u6cd5\uff0c\u4ee5\u53caapplication.yml\u4e2d\u7684\u76f8\u5173\u914d\u7f6e\u6ce8\u518c\u5230\u7f51\u5173\u3002\u6211\u4eec\u6253\u5f00admin\u63a7\u5236\u53f0\uff0c\u5373\u53ef\u5728divide\u3001context_path\u4e2d\u770b\u5230\u76f8\u5173\u914d\u7f6e\u3002\\n\\n### \u6d4b\u8bd5Http\u8bf7\u6c42\\n\\n\u4e0b\u9762\u4f7f\u7528`postman`\u6a21\u62df`http`\u7684\u65b9\u5f0f\u6765\u8bf7\u6c42\u4f60\u7684`http`\u670d\u52a1\uff1a\\n\\n![start-demo-post-http](/img/activities/start-demo/start-demo-post-http.png)\\n\\n### \u4f7f\u7528\u66f4\u591a\u63d2\u4ef6\\n\\n\u6211\u4eec\u53ef\u4ee5\u53c2\u8003 [\u5b98\u65b9\u6587\u6863](https://shenyu.apache.org/zh/docs/index)\uff0c\u6765\u4f7f\u7528\u5176\u4ed6\u7684\u63d2\u4ef6\u3002\\n\\n\u8fd9\u91cc\u4ee5\u4f7f\u7528 param-mapping \u63d2\u4ef6\u4e3a\u4f8b\u3002\\n\\n\u5728 `BasicConfig -> Plugin` \u7f16\u8f91 param-mapping \u63d2\u4ef6\uff0c\u8bbe\u7f6e `status`\u3002\\n\\n![start-demo-plugin](/img/activities/start-demo/start-demo-plugin.png)\\n\\n\u5728 `PluginList -> http process` \u914d\u7f6e\u9009\u62e9\u5668\u548c\u89c4\u5219\u3002\\n\\n![start-demo-selector](/img/activities/start-demo/start-demo-selector.png)\\n\\n![start-demo-rules](/img/activities/start-demo/start-demo-rules.png)\\n\\n\u7136\u540e\u4f7f\u7528 `postman` \u5411 `/http/test/payment` \u53d1\u8d77http\u8bf7\u6c42\u3002\\n\\n![start-demo-post-param-mapping](/img/activities/start-demo/start-demo-post-param-mapping.png)"},{"id":"/SPI-SourceCode-Analysis-SPI","metadata":{"permalink":"/zh/blog/SPI-SourceCode-Analysis-SPI","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-SPI.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/SPI-SourceCode-Analysis-SPI.md","title":"SPI\u8bbe\u8ba1\u5b9e\u73b0\u6e90\u7801\u5206\u6790","description":"\u80cc\u666f","date":"2022-09-12T00:00:00.000Z","formattedDate":"2022\u5e749\u670812\u65e5","tags":[{"label":"SPI","permalink":"/zh/blog/tags/spi"},{"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":21.275,"hasTruncateMarker":false,"authors":[{"name":"Throwable","url":"https://github.com/zjcscut/"}],"frontMatter":{"title":"SPI\u8bbe\u8ba1\u5b9e\u73b0\u6e90\u7801\u5206\u6790","author":"Throwable","author_url":"https://github.com/zjcscut/","tags":["SPI","Apache ShenYu"],"date":"2022-09-12T00:00:00.000Z"},"unlisted":false,"prevItem":{"title":"Apache ShenYu \u542f\u52a8\u793a\u4f8b","permalink":"/zh/blog/Start-SourceCode-Analysis-Start-Demo"}},"content":"## \u80cc\u666f\\n\\n\u6700\u8fd1\u7814\u8bfb`Apache`\u5f00\u6e90\u9879\u76ee`Shenyu`\u7f51\u5173\u7684\u6e90\u7801\uff0c\u7f51\u5173\u7684\u591a\u4e2a\u6838\u5fc3\u7ec4\u4ef6\u52a0\u8f7d\u90fd\u7528\u5230\u4e86`SPI`\u6a21\u5757\u3002\u672c\u6587\u5c31`Shenyu`\u4e2d\u7684`SPI`\u8bbe\u8ba1\u548c\u6e90\u7801\u5b9e\u73b0\u8fdb\u884c\u5206\u6790\u3002\\n\\n## \u4ec0\u4e48\u662fSPI\\n\\n`SPI`\u5c31\u662f`Service Provider Interface`\uff0c\u76f4\u8bd1\\"\u670d\u52a1\u63d0\u4f9b\u65b9\u63a5\u53e3\\"\uff0c\u662f\u4e00\u79cd\u52a8\u6001\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff0c\u53ef\u4ee5\u57fa\u4e8e\u63a5\u53e3\u8fd0\u884c\u65f6\u52a8\u6001\u52a0\u8f7d\u63a5\u53e3\u7684\u5b9e\u73b0\u7c7b\uff08\u4e5f\u5c31\u662f\u63a5\u53e3\u7f16\u7a0b + \u7b56\u7565\u6a21\u5f0f + \u914d\u7f6e\u6587\u4ef6\u7684\u4e00\u79cd\u5f00\u53d1\u6a21\u5f0f\uff09\u3002\u6700\u5e38\u89c1\u7684\u5c31\u662f`JDK`\u5185\u7f6e\u7684\u6570\u636e\u5e93\u9a71\u52a8\u63a5\u53e3`java.sql.Driver`\uff0c\u4e0d\u540c\u7684\u5382\u5546\u53ef\u4ee5\u5bf9\u8be5\u63a5\u53e3\u5b8c\u6210\u4e0d\u540c\u7684\u5b9e\u73b0\uff0c\u4f8b\u5982`MySQL`\uff08`MySQL`\u9a71\u52a8\u5305\u4e2d\u7684`com.mysql.jdbc.Driver`\uff09\u3001`PostgreSQL`\uff08`PostgreSQL`\u9a71\u52a8\u5305\u4e2d\u7684`org.postgresql.Driver`\uff09\u7b49\u7b49\u3002\\n\\n![spi-jdk-api-diagram](/img/activities/code-analysis-spi/spi-jdk-api-diagram.png)\\n\\n`JDK`\u5185\u7f6e\u7684`SPI`\u4f7f\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a\\n\\n- \u5728\u7c7b\u8def\u5f84\u7684`META-INF/services`\u76ee\u5f55\u521b\u5efa\u4e00\u4e2a\u4ee5\u63a5\u53e3\u5168\u9650\u5b9a\u540d\u79f0\u547d\u540d\u7684\u6587\u4ef6\uff08\u672c\u8d28\u662f\u4e00\u4e2a`properties`\uff09\u6587\u4ef6\uff0c\u4f8b\u5982\u547d\u540d\u4e3a`java.sql.Driver`\\n- \u8be5\u6587\u4ef6\u4e2d\u53ef\u4ee5\u6307\u5b9a\u5177\u4f53\u7684\u5b9e\u73b0\u7c7b\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e2a\u5b9e\u73b0\u7c7b\u7684\u5168\u7c7b\u578b\u9650\u5b9a\u540d\u4e3a\u5355\u72ec\u4e00\u884c\uff0c\u4f8b\u5982`META-INF/services/java.sql.Driver`\u4e2d\uff1a\\n\\n```java\\n# META-INF/services/java.sql.Driver\u6587\u4ef6\u5185\u5bb9\\ncom.mysql.jdbc.Driver\\norg.postgresql.Driver\\n```\\n\\n- \u6700\u540e\u901a\u8fc7`java.util.ServiceLoader`\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u52a0\u8f7d\uff0c\u5b9e\u4f8b\u5316\u63a5\u53e3\u7684\u5bf9\u5e94\u5b9e\u73b0\u7c7b\uff08\u8fd9\u91cc\u9690\u542b\u4e86\u4e00\u4e2a\u7ea6\u5b9a\uff0c**\u6240\u6709\u5b9e\u73b0\u7c7b\u5fc5\u987b\u63d0\u4f9b\u65e0\u53c2\u6784\u9020\u51fd\u6570**\uff09\\n\\n\u5e95\u5c42\u7684\u5b9e\u73b0\u6d89\u53ca\u5230\u7c7b\u52a0\u8f7d\u3001\u53cc\u4eb2\u59d4\u6258\u6a21\u578b\u7b49\u5185\u5bb9\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5c55\u5f00\u3002\u57fa\u4e8e\u8fd9\u79cd\u8bbe\u8ba1\u601d\u8def\uff0c\u5f88\u591a\u4e3b\u6d41\u6846\u67b6\u4e86\u81ea\u5b9e\u73b0\u4e86\u4e00\u5957`SPI`\u6269\u5c55\uff0c\u4f8b\u5982`Dubbo`\u7684`SPI`\u6269\u5c55\u6a21\u5757\uff0c\u5c31\u662f\u8bfb\u53d6\u7c7b\u8def\u5f84\u4e0b`META-INF/services/dubbo`\u76ee\u5f55\u7684\u6587\u4ef6\u5185\u5bb9\u8fdb\u884c\u7c7b\u52a0\u8f7d\u3002`Shenyu-SPI`\u6a21\u5757\u4e5f\u662f\u6cbf\u7528\u7c7b\u4f3c\u7684\u8bbe\u8ba1\u601d\u8def\u3002\\n\\n## shenyu-spi\u6e90\u7801\u5206\u6790\\n\\n`shenyu-spi`\u6a21\u5757\u5341\u5206\u7cbe\u70bc\uff0c\u4ee3\u7801\u7ed3\u6784\u5982\u4e0b\uff1a\\n\\n```properties\\n- shenyu-spi[module]\\n  - org.apache.shenyu.spi[package]\\n    -- ExtensionFactory\\n    -- ExtensionLoader\\n    -- Join\\n    -- SPI\\n    -- SpiExtensionFactory\\n```\\n\\n\u8fd9\u4e9b\u7c7b\u529f\u80fd\u5982\u4e0b\uff1a\\n\\n- `ExtensionFactory`\uff1a`SPI`\u52a0\u8f7d\u5668\u5de5\u5382\uff0c\u672c\u8eab\u4e5f\u662f\u4e00\u4e2a`SPI`\uff0c\u7528\u4e8e\u57fa\u4e8e`SPI`\u673a\u5236\u52a0\u8f7d`ExtensionLoader`\u5b9e\u4f8b\u540c\u65f6\u57fa\u4e8e`ExtensionLoader`\u5b9e\u4f8b\u83b7\u53d6\u9ed8\u8ba4\u7684`SPI`\u6807\u8bc6\u63a5\u53e3\u5b9e\u73b0\\n- `SpiExtensionFactory`\uff1a\u5176\u5b9e\u5c31\u662f`ExtensionFactory`\u7684\u4e00\u4e2a\u5b9e\u73b0\u7c7b\\n- `SPI`\uff1a\u6807\u8bc6\u6ce8\u89e3\uff0c\u7528\u4e8e\u6807\u8bc6`SPI`\uff0c\u7528\u4e8e\u63a5\u53e3\u4e0a\\n- `Join`\uff1a\u6807\u8bc6\u6ce8\u89e3\uff0c\u7528\u4e8e\u5b9e\u73b0\u7c7b\u4e0a\uff0c\u7528\u4e8e\u6807\u8bc6\u8be5\u7c7b\u52a0\u5165`SPI`\u7cfb\u7edf\\n- `ExtensionLoader`\uff1a`SPI`\u52a0\u8f7d\u5668\uff0c\u7c7b\u6bd4`java.util.ServiceLoader`\uff0c\u7528\u4e8e\u52a0\u8f7d`SPI`\u4e2d\u63a5\u53e3\u7684\u5b9e\u73b0\u7c7b\\n\\n\u63a5\u4e0b\u6765\u7ec6\u770b\u6bcf\u4e2a\u7c7b\u7684\u6e90\u7801\u5b9e\u73b0\u3002\\n\\n### @SPI\\n\\n`org.apache.shenyu.spi.SPI`\u4f5c\u4e3a\u4e00\u4e2a\u6807\u8bc6\u6ce8\u89e3\uff0c\u4e3b\u8981\u7528\u4e8e**\u63a5\u53e3**\u4e0a\uff0c\u4e5f\u5c31\u662f\u53ea\u6709\u4f7f\u7528\u4e86`@SPI`\u7684\u63a5\u53e3\u624d\u80fd\u88ab`shenyu-spi`\u52a0\u8f7d\u3002\u8fd9\u4e2a\u7c7b\u7684\u6ce8\u91ca\u4e2d\u63cf\u8ff0\u5230\uff1a\u6240\u6709`SPI`\u7cfb\u7edf\u76f8\u5173\u53c2\u8003`Apache Dubbo`\u7684\u5b9e\u73b0\uff08\u8fd9\u4e00\u70b9\u6bd4\u8f83\u5408\u60c5\u7406\uff0c\u5176\u5b9e`SPI`\u6269\u5c55\u5df2\u7ecf\u662f\u4e00\u79cd\u6210\u719f\u7684\u65b9\u6848\uff0c\u5b9e\u73b0\u4e0a\u5927\u540c\u5c0f\u5f02\uff09\u3002\u8be5\u6ce8\u89e3\u53ea\u6709\u4e00\u4e2a\u65b9\u6cd5\uff1a\\n\\n```java\\n@Documented\\n@Retention(RetentionPolicy.RUNTIME)\\n@Target(ElementType.TYPE)\\npublic @interface SPI {\\n\\n    /**\\n     * Value string.\\n     *\\n     * @return the string\\n     */\\n    String value() default \\"\\";\\n}\\n```\\n\\n\u552f\u4e00\u7684`value()`\u65b9\u6cd5\u7528\u4e8e\u6307\u5b9a\u9ed8\u8ba4\u7684`SPI`\u5b9e\u73b0\uff08\u53ef\u9009\u7684\uff09\uff0c\u540e\u6587\u5728\u5c55\u5f00`ExtensionLoader`\u65f6\u5019\u4f1a\u8bf4\u660e\u3002\\n\\n### @Join\\n\\n`org.apache.shenyu.spi.Join`\u4e5f\u662f\u4e00\u4e2a\u6807\u8bc6\u6ce8\u89e3\uff0c\u4e3b\u8981\u7528\u5728\u4f7f\u7528\u4e86`@SPI`\u6ce8\u89e3\u7684\u63a5\u53e3\u7684**\u5b9e\u73b0\u7c7b**\u4e0a\uff0c\u7528\u4e8e\u6807\u8bc6\u8be5\u7c7b\u52a0\u5165`SPI`\u7cfb\u7edf\u4e2d\u800c\u540e\u53ef\u4ee5\u88ab`ExtensionLoader`\u52a0\u8f7d\u3002\u8be5\u6ce8\u89e3\u4e5f\u53ea\u6709\u4e00\u4e2a\u65b9\u6cd5\uff1a\\n\\n```java\\n@Documented\\n@Retention(RetentionPolicy.RUNTIME)\\n@Target(ElementType.TYPE)\\npublic @interface Join {\\n    \\n    /**\\n     * It will be sorted according to the current serial number..\\n     * @return int.\\n     */\\n    int order() default 0;\\n}\\n```\\n\\n\u552f\u4e00\u7684`order()`\u65b9\u6cd5\u7528\u4e8e\u6307\u5b9a\u5177\u4f53\u7684\u987a\u5e8f\u53f7\uff0c\u5355\u4e2a\u4f7f\u7528\u4e86`@SPI`\u7684\u63a5\u53e3\u5b58\u5728\u591a\u4e2a\u4f7f\u7528\u4e86`@Join`\u7684\u5b9e\u73b0\u7c7b\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u987a\u5e8f\u53f7\u5c31\u786e\u5b9a\u4e86\u8fd9\u4e9b\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\u7684\u6392\u5e8f\uff08\u987a\u5e8f\u53f7\u5c0f\u7684\u6392\u5728\u524d\u9762\uff09\u3002\\n\\n### ExtensionLoader\\n\\n`ExtensionLoader`\u5c31\u662f\\"\u7c7b\u578b\u6269\u5c55\u52a0\u8f7d\u5668\\"\uff0c\u5c31\u662f\u6574\u4e2a`SPI`\u6a21\u5757\u7684\u6838\u5fc3\u3002\u5148\u770b\u5176\u6210\u5458\u5c5e\u6027\uff1a\\n\\n```java\\npublic final class ExtensionLoader<T> {\\n    \\n    // SLF4J\u65e5\u5fd7\u53e5\u67c4\\n    private static final Logger LOG = LoggerFactory.getLogger(ExtensionLoader.class);\\n    \\n    // SPI\u914d\u7f6e\u6587\u4ef6\u57fa\u4e8e\u7c7b\u8def\u5f84\u4e0b\u7684\u76f8\u5bf9\u76ee\u5f55\\n    private static final String SHENYU_DIRECTORY = \\"META-INF/shenyu/\\";\\n    \\n    // @SPI\u6807\u8bc6\u63a5\u53e3\u7c7b\u578b -> ExtensionLoader\u5b9e\u4f8b\u7684\u7f13\u5b58 => \u6ce8\u610f\u8fd9\u4e2a\u662f\u4e00\u4e2a\u5168\u5c40\u7684\u9759\u6001\u53d8\u91cf\\n    private static final Map<Class<?>, ExtensionLoader<?>> LOADERS = new ConcurrentHashMap<>();\\n    \\n    // \u5f53\u524d@SPI\u6807\u8bc6\u63a5\u53e3\u7c7b\u578b\\n    private final Class<T> clazz;\\n    \\n    // \u7c7b\u52a0\u8f7d\u5668\u5b9e\u4f8b\\n    private final ClassLoader classLoader;\\n    \\n    // \u5f53\u524dExtensionLoader\u7f13\u5b58\u7684\u5df2\u52a0\u8f7d\u7684\u5b9e\u73b0\u7c7b\u4fe1\u606f\uff0c\u4f7f\u7528\u503c\u6301\u6709\u5668\u5305\u88c5\uff0c\u662f\u4e00\u4e2aHashMap\uff0c\u6620\u5c04\u5173\u7cfb\uff1a\u5b9e\u73b0\u7c7b\u522b\u540d -> \u5b9e\u73b0\u7c7b\u4fe1\u606f\\n    private final Holder<Map<String, ClassEntity>> cachedClasses = new Holder<>();\\n    \\n    // \u5f53\u524dExtensionLoader\u7f13\u5b58\u7684\u5df2\u52a0\u8f7d\u7684\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\u7684\u503c\u5305\u88c5\u5668\uff0c\u4f7f\u7528\u503c\u6301\u6709\u5668\u5305\u88c5\uff0c\u6620\u5c04\u5173\u7cfb\uff1a\u5b9e\u73b0\u7c7b\u522b\u540d -> \u503c\u6301\u6709\u5668\u5305\u88c5\u7684\u5b9e\u73b0\u7c7b\u5b9e\u4f53\\n    private final Map<String, Holder<Object>> cachedInstances = new ConcurrentHashMap<>();\\n    \\n    // \u5f53\u524dExtensionLoader\u7f13\u5b58\u7684\u5df2\u52a0\u8f7d\u7684\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\uff0c\u4f7f\u7528\u503c\u6301\u6709\u5668\u5305\u88c5\uff0c\u6620\u5c04\u5173\u7cfb\uff1a\u5b9e\u73b0\u7c7b\u7c7b\u578b -> \u5b9e\u73b0\u7c7b\u5b9e\u4f53\\n    private final Map<Class<?>, Object> joinInstances = new ConcurrentHashMap<>();\\n    \\n    // \u7f13\u5b58\u9ed8\u8ba4\u540d\u79f0\uff0c\u6765\u6e90\u4e8e@SPI\u6ce8\u89e3\u7684value()\u65b9\u6cd5\u975e\u7a7a\u767d\u8fd4\u56de\u503c\uff0c\u7528\u4e8e\u52a0\u8f7d\u9ed8\u8ba4\u7684\u63a5\u53e3\u5b9e\u73b0\\n    private String cachedDefaultName;\\n    \\n    // Holder\u6bd4\u8f83\u5668\uff0c\u6309\u7167Holder\u7684order\u964d\u5e8f\uff0c\u4e5f\u5c31\u662f\u987a\u5e8f\u53f7\u5c0f\u7684\u6392\u5728\u524d\u9762\\n    private final Comparator<Holder<Object>> holderComparator = (o1, o2) -> {\\n        if (o1.getOrder() > o2.getOrder()) {\\n            return 1;\\n        } else if (o1.getOrder() < o2.getOrder()) {\\n            return -1;\\n        } else {\\n            return 0;\\n        }\\n    };\\n    \\n    // ClassEntity\u6bd4\u8f83\u5668\uff0c\u6309\u7167ClassEntity\u7684order\u964d\u5e8f\uff0c\u4e5f\u5c31\u662f\u987a\u5e8f\u53f7\u5c0f\u7684\u6392\u5728\u524d\u9762\\n    private final Comparator<ClassEntity> classEntityComparator = (o1, o2) -> {\\n        if (o1.getOrder() > o2.getOrder()) {\\n            return 1;\\n        } else if (o1.getOrder() < o2.getOrder()) {\\n            return -1;\\n        } else {\\n            return 0;\\n        }\\n    };\\n    \\n    // \u6682\u65f6\u7701\u7565\u5176\u4ed6\u4ee3\u7801\\n\\n    // \u503c\u6301\u6709\u5668\uff0c\u7b80\u5355VO\uff0c\u7528\u6765\u5b58\u50a8\u6cdb\u578b\u503c\u548c\u503c\u52a0\u8f7d\u987a\u5e8f\\n    public static class Holder<T> {\\n        \\n        // \u8fd9\u91cc\u7684\u503c\u5f15\u7528\u662fvolatile\u4fee\u9970\uff0c\u4fbf\u4e8e\u67d0\u7ebf\u7a0b\u66f4\u53d8\u53e6\u4e00\u7ebf\u7a0b\u9a6c\u4e0a\u8bfb\u5230\u6700\u65b0\u7684\u503c\\n        private volatile T value;\\n        \\n        private Integer order;\\n        // \u7701\u7565setter\u548cgetter\u4ee3\u7801\\n    }\\n    \\n    // \u7c7b\u5b9e\u4f53\uff0c\u4e3b\u8981\u5b58\u653e\u52a0\u8f7d\u7684\u5b9e\u73b0\u7c7b\u7684\u4fe1\u606f\\n    static final class ClassEntity {\\n        \\n        // \u540d\u79f0\uff0c\u8fd9\u91cc\u662f\u6307SPI\u5b9e\u73b0\u7c7b\u7684\u522b\u540d\uff0c\u4e0d\u662f\u7c7b\u540d\\n        private String name;\\n        \\n        // \u52a0\u8f7d\u987a\u5e8f\u53f7\\n        private Integer order;\\n        \\n        // SPI\u5b9e\u73b0\u7c7b\\n        private Class<?> clazz;\\n        \\n        private ClassEntity(final String name, final Integer order, final Class<?> clazz) {\\n            this.name = name;\\n            this.order = order;\\n            this.clazz = clazz;\\n        }\\n        // \u7701\u7565setter\u548cgetter\u4ee3\u7801\\n    }\\n}\\n```\\n\\n\u5206\u6790\u5b8c\u6210\u5458\u5c5e\u6027\uff0c\u4e0d\u96be\u53d1\u73b0\u4e0b\u9762\u51e0\u70b9\uff1a\\n\\n- `ExtensionLoader`\u4f1a\u5b58\u5728\u4e00\u4e2a\u5168\u5c40\u7684\u9759\u6001\u7f13\u5b58`LOADERS`\uff0c\u7f13\u5b58\u5df2\u7ecf\u521b\u5efa\u7684`ExtensionLoader`\u5b9e\u4f8b\u4ee5\u9632\u6b62\u91cd\u590d\u521b\u5efa\u7684\u6027\u80fd\u5f00\u9500\\n- \u6bcf\u4e2a`@SPI`\u6807\u8bb0\u7684\u63a5\u53e3\u5982\u679c\u4f7f\u7528`ExtensionLoader`\u8fdb\u884c\u52a0\u8f7d\uff0c\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u5168\u65b0\u7684`ExtensionLoader`\u5b9e\u4f8b\\n- `@SPI`\u6807\u8bb0\u7684\u63a5\u53e3\u5982\u679c\u6709\u591a\u4e2a\u5b9e\u73b0\uff0c\u90a3\u4e48\u6700\u7ec8\u83b7\u53d6\u5230\u8fd9\u4e9b\u5b9e\u73b0\u5b9e\u4f8b\u7684\u65f6\u5019\u662f\u6709\u5e8f\u7684\\n\\n\u63a5\u7740\u770b\u5176\u6784\u9020\u51fd\u6570\u548c\u9759\u6001\u5de5\u5382\u65b9\u6cd5\uff1a\\n\\n```java\\n// \u79c1\u6709\u6784\u9020\u51fd\u6570\uff0c\u9700\u8981\u5165\u53c2\u4e3a@SPI\u6807\u8bc6\u7684\u63a5\u53e3\u7c7b\u578b\u548c\u7c7b\u52a0\u8f7d\u5668\u5b9e\u4f8b\\nprivate ExtensionLoader(final Class<T> clazz, final ClassLoader cl) {\\n    // \u6210\u5458\u53d8\u91cfclazz\u8d4b\u503c\\n    this.clazz = clazz;\\n    // \u6210\u5458\u53d8\u91cfclassLoader\u8d4b\u503c\\n    this.classLoader = cl;\\n    // \u8fd9\u91cc\u5bf9\u4e8e\u975eExtensionFactory\u63a5\u53e3\u7c7b\u578b\u4f1a\u61d2\u52a0\u8f7d\u4e00\u4e2a\u7528\u4e8e\u52a0\u8f7dExtensionFactory\u7684ExtensionLoader\\n    if (!Objects.equals(clazz, ExtensionFactory.class)) {\\n        ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getExtensionClassesEntity();\\n    }\\n}\\n\\n// \u5b9e\u4f8b\u5316getExtensionLoader\uff0c\u9759\u6001\u5de5\u5382\u65b9\u6cd5\uff0c\u9700\u8981\u5165\u53c2\u4e3a@SPI\u6807\u8bc6\u7684\u63a5\u53e3\u7c7b\u578b\u548c\u7c7b\u52a0\u8f7d\u5668\u5b9e\u4f8b\\npublic static <T> ExtensionLoader<T> getExtensionLoader(final Class<T> clazz, final ClassLoader cl) {\\n    // \u524d\u7f00\u6821\u9a8c\uff0c\u63a5\u53e3\u7c7b\u578b\u5fc5\u987b\u975e\u7a7a\u5e76\u4e14\u5fc5\u987b\u5b58\u5728@SPI\u6ce8\u89e3\uff0c\u5426\u5219\u629b\u51fa\u5f02\u5e38\u4e2d\u65ad\\n    Objects.requireNonNull(clazz, \\"extension clazz is null\\");\\n    if (!clazz.isInterface()) {\\n        throw new IllegalArgumentException(\\"extension clazz (\\" + clazz + \\") is not interface!\\");\\n    }\\n    if (!clazz.isAnnotationPresent(SPI.class)) {\\n        throw new IllegalArgumentException(\\"extension clazz (\\" + clazz + \\") without @\\" + SPI.class + \\" Annotation\\");\\n    }\\n    // \u4ece\u7f13\u5b58LOADERS\u4e2d\u52a0\u8f7dExtensionLoader\u5b9e\u4f8b\uff0c\u4e0d\u5b58\u5728\u5219\u521b\u5efa\uff0c\u5178\u578b\u7684\u61d2\u52a0\u8f7d\u6a21\u5f0f\\n    ExtensionLoader<T> extensionLoader = (ExtensionLoader<T>) LOADERS.get(clazz);\\n    if (Objects.nonNull(extensionLoader)) {\\n        return extensionLoader;\\n    }\\n    LOADERS.putIfAbsent(clazz, new ExtensionLoader<>(clazz, cl));\\n    return (ExtensionLoader<T>) LOADERS.get(clazz);\\n}\\n\\n// \u5b9e\u4f8b\u5316getExtensionLoader\uff0c\u9759\u6001\u5de5\u5382\u65b9\u6cd5\uff0c\u9700\u8981\u5165\u53c2\u4e3a@SPI\u6807\u8bc6\u7684\u63a5\u53e3\u7c7b\u578b\uff0c\u4f7f\u7528ExtensionLoader\u7c7b\u7684\u7c7b\u52a0\u8f7d\u5668\\npublic static <T> ExtensionLoader<T> getExtensionLoader(final Class<T> clazz) {\\n    return getExtensionLoader(clazz, ExtensionLoader.class.getClassLoader());\\n}\\n```\\n\\n`ExtensionLoader`\u4f7f\u7528\u4e86\u79c1\u6709\u6784\u9020\u5668\uff0c\u4f7f\u7528\u4e86\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u548c\u61d2\u52a0\u8f7d\u6a21\u5f0f\u3002\u521d\u59cb\u5316`ExtensionLoader`\u5b8c\u6210\u540e\u5e76\u4e0d\u4f1a\u89e6\u53d1\u7c7b\u52a0\u8f7d\u5de5\u4f5c\uff0c\u771f\u6b63\u7684\u626b\u63cf\u548c\u52a0\u8f7d\u884c\u4e3a\u5ef6\u8fdf\u5230\u8c03\u7528`getJoin`\u7cfb\u5217\u65b9\u6cd5\u6267\u884c\uff0c\u8fd9\u91cc\u626b\u7801\u548c\u52a0\u8f7d\u6240\u6709\u5b9e\u73b0\u7c7b\u4fe1\u606f\u7684\u65b9\u6cd5\u8c03\u7528\u94fe\uff1a\\n\\n```java\\n// \u52a0\u8f7d\u6240\u6709\u6269\u5c55\u7c7b\u4fe1\u606f\uff0c\u8fd9\u91cc\u91c7\u7528\u4e86DCL\uff08\u53cc\u91cd\u9501\u6821\u9a8c\uff09\u9632\u6b62\u5e76\u53d1\u52a0\u8f7d\\nprivate Map<String, ClassEntity> getExtensionClassesEntity() {\\n    // \u7f13\u5b58\u4e0d\u5b58\u5728\\n    Map<String, ClassEntity> classes = cachedClasses.getValue();\\n    if (Objects.isNull(classes)) {\\n        // \u52a0\u9501\u540e\u518d\u68c0\u67e5\u4e00\u6b21\u7f13\u5b58\\n        synchronized (cachedClasses) {\\n            classes = cachedClasses.getValue();\\n            if (Objects.isNull(classes)) {\\n                // \u6700\u7ec8\u786e\u8ba4\u7f13\u5b58\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u884c\u52a0\u8f7d\uff0c\u5e76\u4e14\u6807\u8bb0\u987a\u5e8f\u53f7\u4e3a0\\n                classes = loadExtensionClass();\\n                cachedClasses.setValue(classes);\\n                cachedClasses.setOrder(0);\\n            }\\n        }\\n    }\\n    return classes;\\n}\\n\\n// \u52a0\u8f7d\u5f53\u524dExtensionLoader\u4e2dclazz\u7684\u6240\u6709SPI\u7cfb\u7edf\u5185\u7684\u5b9e\u73b0\u7c7b\\nprivate Map<String, ClassEntity> loadExtensionClass() {\\n    SPI annotation = clazz.getAnnotation(SPI.class);\\n    if (Objects.nonNull(annotation)) {\\n        // \u8fd9\u91cc\u5c31\u662f\u524d\u9762\u63d0\u5230\uff0c\u5982\u679c@SPI\u6ce8\u89e3\u7684value()\u65b9\u6cd5\u975e\u7a7a\u767d\u8fd4\u56de\u503c\u4f1a\u4f5c\u4e3a\u9ed8\u8ba4\u5b9e\u73b0\u7684\u522b\u540d\\n        // \u4e5f\u5c31\u662f\u5982\u679c\u53ea\u4f7f\u7528\u4e86@SPI\uff0c\u90a3\u4e48\u5c31\u65e0\u6cd5\u83b7\u53d6\u9ed8\u8ba4\u5b9e\u73b0\\n        // \u5982\u679c\u4f7f\u7528\u4e86@SPI(\\"foo\\")\uff0c\u53ef\u4ee5\u901a\u8fc7\u522b\u540dfoo\u53bb\u6620\u5c04\u548c\u83b7\u53d6\u9ed8\u8ba4\u5b9e\u73b0\\n        String value = annotation.value();\\n        if (StringUtils.isNotBlank(value)) {\\n            cachedDefaultName = value;\\n        }\\n    }\\n    // \u521d\u59cb\u5316\u4e00\u4e2aHashmap\u5bb9\u5668\u7528\u4e8e\u5b58\u50a8\u52a0\u8f7d\u7684\u5b9e\u73b0\u7c7b\u4fe1\u606f\uff0c\u8fd9\u4e2a\u53d8\u91cf\u4f1a\u900f\u4f20\u5230\u4e0b\u4e00\u4e2a\u65b9\u6cd5\u94fe\\n    Map<String, ClassEntity> classes = new HashMap<>(16);\\n    // \u52a0\u8f7d\u76ee\u5f55\u4e2d\u7684\u5c5e\u6027\u6587\u4ef6\\n    loadDirectory(classes);\\n    return classes;\\n}\\n\\n// \u52a0\u8f7d\u76ee\u5f55\u4e2d\u7684\u5c5e\u6027\u6587\u4ef6\uff0c\u5e76\u4e14\u52a0\u8f7d\u6587\u4ef6\u4e2d\u7684\u5b9e\u73b0\u7c7b\uff0c\u76ee\u6807\u76ee\u5f55\uff1aMETA-INF/shenyu/\\nprivate void loadDirectory(final Map<String, ClassEntity> classes) {\\n    // \u6587\u4ef6\u540d => META-INF/shenyu/$className\\n    String fileName = SHENYU_DIRECTORY + clazz.getName();\\n    try {\\n        // \u8fd9\u91cc\u4f7f\u7528\u7c7b\u52a0\u8f7d\u5668\u52a0\u8f7d\u6587\u4ef6\u8d44\u6e90\uff0c\u5982\u679c\u4f20\u5165\u7684\u7c7b\u52a0\u8f7d\u5668\u4e3a\u7a7a\u4f1a\u4f7f\u7528\u7cfb\u7edf\u7c7b\u52a0\u8f7d\u5668\\n        Enumeration<URL> urls = Objects.nonNull(this.classLoader) ? classLoader.getResources(fileName)\\n                : ClassLoader.getSystemResources(fileName);\\n        // \u904d\u5386\u89e3\u6790\u7684\u6587\u4ef6URL\u96c6\u5408\\n        if (Objects.nonNull(urls)) {\\n            while (urls.hasMoreElements()) {\\n                URL url = urls.nextElement();\\n                // \u901a\u8fc7\u6587\u4ef6URL\u52a0\u8f7d\u8d44\u6e90\\n                loadResources(classes, url);\\n            }\\n        }\\n    } catch (IOException t) {\\n        LOG.error(\\"load extension class error {}\\", fileName, t);\\n    }\\n}\\n\\n// \u52a0\u8f7d\u6587\u4ef6\u8d44\u6e90\uff0c\u89e3\u6790\u6587\u4ef6\u5e76\u4e14\u52a0\u8f7d\u5b9e\u73b0\u7c7b\u5b58\u50a8\u5230classes\u4e2d\\nprivate void loadResources(final Map<String, ClassEntity> classes, final URL url) throws IOException {\\n    // \u8bfb\u53d6URL\u6587\u4ef6\u8d44\u6e90\uff0c\u52a0\u8f7d\u5230Properties\u4e2d\uff0c\u6bcf\u884c\u683c\u5f0f\u4e3aname=classPath\\n    try (InputStream inputStream = url.openStream()) {\\n        Properties properties = new Properties();\\n        properties.load(inputStream);\\n        properties.forEach((k, v) -> {\\n            String name = (String) k;\\n            String classPath = (String) v;\\n            if (StringUtils.isNotBlank(name) && StringUtils.isNotBlank(classPath)) {\\n                try {\\n                    // \u57fa\u4e8ename\u548cclassPath\u8fdb\u884c\u7c7b\u52a0\u8f7d\\n                    loadClass(classes, name, classPath);\\n                } catch (ClassNotFoundException e) {\\n                    throw new IllegalStateException(\\"load extension resources error\\", e);\\n                }\\n            }\\n        });\\n    } catch (IOException e) {\\n        throw new IllegalStateException(\\"load extension resources error\\", e);\\n    }\\n}\\n\\n// \u57fa\u4e8ename\uff08\u522b\u540d\uff09\u548cclassPath\uff08\u7c7b\u5168\u9650\u5b9a\u540d\u79f0\uff09\u8fdb\u884c\u7c7b\u52a0\u8f7d\\nprivate void loadClass(final Map<String, ClassEntity> classes,\\n                        final String name, final String classPath) throws ClassNotFoundException {\\n    // \u7c7b\u521d\u59cb\u5316\uff0c\u5e76\u4e14\u786e\u5b9a\u5b9e\u73b0\u7c7b\u5fc5\u987b\u662f\u5f53\u524d@SPI\u6ce8\u89e3\u6807\u8bc6\u63a5\u53e3\u7684\u5b50\u7c7b\\n    Class<?> subClass = Objects.nonNull(this.classLoader) ? Class.forName(classPath, true, this.classLoader) : Class.forName(classPath);\\n    if (!clazz.isAssignableFrom(subClass)) {\\n        throw new IllegalStateException(\\"load extension resources error,\\" + subClass + \\" subtype is not of \\" + clazz);\\n    }\\n    // \u5b9e\u73b0\u7c7b\u5fc5\u987b\u5b58\u5728\u6ce8\u89e3@Join\\n    if (!subClass.isAnnotationPresent(Join.class)) {\\n        throw new IllegalStateException(\\"load extension resources error,\\" + subClass + \\" without @\\" + Join.class + \\" annotation\\");\\n    }\\n    // \u5982\u679c\u7f13\u5b58\u4e2d\u4e0d\u5b58\u5728\u540c\u6837\u522b\u540d\u7684\u5b9e\u73b0\u7c7b\u624d\u8fdb\u884c\u7f13\u5b58\uff0c\u5df2\u7ecf\u5b58\u5728\u5219\u6821\u9a8c\u65e7\u7684\u7c7b\u578b\u548c\u5f53\u524d\u5b9e\u73b0\u7c7b\u578b\u662f\u5426\u4e00\u81f4\\n    ClassEntity oldClassEntity = classes.get(name);\\n    if (Objects.isNull(oldClassEntity)) {\\n        // \u521b\u5efa\u7c7b\u4fe1\u606f\u5b9e\u4f53\u4fdd\u5b58\u522b\u540d\u3001\u987a\u5e8f\u53f7\u548c\u5b9e\u73b0\u7c7b\u5e76\u4e14\u7f13\u5b58\uff0c\u6620\u5c04\u5173\u7cfb\uff1a\u522b\u540d -> \u7c7b\u4fe1\u606f\u5b9e\u4f53\\n        Join joinAnnotation = subClass.getAnnotation(Join.class);\\n        ClassEntity classEntity = new ClassEntity(name, joinAnnotation.order(), subClass);\\n        classes.put(name, classEntity);\\n    } else if (!Objects.equals(oldClassEntity.getClazz(), subClass)) {\\n        throw new IllegalStateException(\\"load extension resources error,Duplicate class \\" + clazz.getName() + \\" name \\"\\n                + name + \\" on \\" + oldClassEntity.getClazz().getName() + \\" or \\" + subClass.getName());\\n    }\\n}\\n```\\n\\n\u901a\u8fc7\u65b9\u6cd5\u94fe`getExtensionClassesEntity -> loadExtensionClass -> loadDirectory -> loadResources -> loadClass`\u6700\u7ec8\u5f97\u5230\u4e00\u4e2a\u522b\u540d`->`\u5b9e\u73b0\u7c7b\u4fe1\u606f\u7684\u6620\u5c04\uff0c\u7528\u4e8e\u540e\u7eed\u7684\u5b9e\u4f8b\u5316\uff0c\u89c1`getJoin()`\u65b9\u6cd5\uff1a\\n\\n```java\\n// \u57fa\u4e8e\u522b\u540d\u83b7\u53d6\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\\npublic T getJoin(final String name) {\\n    // \u522b\u540d\u5fc5\u987b\u4e3a\u975e\u7a7a\u767d\u5b57\u7b26\u4e32\\n    if (StringUtils.isBlank(name)) {\\n        throw new NullPointerException(\\"get join name is null\\");\\n    }\\n    // \u8fd9\u91cc\u4e5f\u4f7f\u7528DCL\u53bbcachedInstances\u7f13\u5b58\u4e2d\u53d6\u522b\u540d\u5bf9\u5e94\u7684\u503c\u6301\u6709\u5668\uff0c\u503c\u6301\u6709\u5668\u4e3a\u7a7a\u5219\u521b\u5efa\\n    Holder<Object> objectHolder = cachedInstances.get(name);\\n    if (Objects.isNull(objectHolder)) {\\n        cachedInstances.putIfAbsent(name, new Holder<>());\\n        objectHolder = cachedInstances.get(name);\\n    }\\n    Object value = objectHolder.getValue();\\n    if (Objects.isNull(value)) {\\n        synchronized (cachedInstances) {\\n            // \u52a0\u9501\u540e\u518d\u6b21\u5224\u65ad\u503c\u6301\u6709\u5668\u4e2d\u7684\u503c\u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u7684\u65f6\u5019\u5219\u8fdb\u884c\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\u5316\\n            value = objectHolder.getValue();\\n            if (Objects.isNull(value)) {\\n                Holder<T> pair = createExtension(name);\\n                value = pair.getValue();\\n                int order = pair.getOrder();\\n                // \u5b9e\u4f8b\u5316\u5b8c\u6210\u540e\u66f4\u65b0\u503c\u6301\u6709\u5668\u7f13\u5b58\\n                objectHolder.setValue(value);\\n                objectHolder.setOrder(order);\\n            }\\n        }\\n    }\\n    return (T) value;\\n}\\n\\n// \u57fa\u4e8e\u522b\u540d\u641c\u7d22\u5df2\u7ecf\u52a0\u8f7d\u7684\u5b9e\u73b0\u7c7b\u4fe1\u606f\uff0c\u5e76\u4e14\u5b9e\u4f8b\u5316\u5bf9\u5e94\u7684\u5b9e\u73b0\u7c7b\u8fdb\u884c\u503c\u5305\u88c5\\nprivate Holder<T> createExtension(final String name) {\\n    // \u52a0\u8f7d\u8be5@SPI\u6807\u8bc6\u63a5\u53e3\u7684\u6240\u6709\u5b9e\u73b0\u7c7b\u4fe1\u606f\u5e76\u4e14\u83b7\u53d6\u5bf9\u5e94\u522b\u540d\u7684\u5b9e\u73b0\u7c7b\u4fe1\u606f\\n    ClassEntity classEntity = getExtensionClassesEntity().get(name);\\n    if (Objects.isNull(classEntity)) {\\n        throw new IllegalArgumentException(\\"name is error\\");\\n    }\\n    Class<?> aClass = classEntity.getClazz();\\n    // \u5982\u679c\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\u7f13\u5b58\u4e2d\u5df2\u7ecf\u5b58\u5728\uff0c\u5219\u76f4\u63a5\u5c01\u88c5\u4e3a\u503c\u5305\u88c5\u5668\u8fd4\u56de\uff0c\u5426\u5219\u8fdb\u884c\u5b9e\u4f8b\u5316\\n    Object o = joinInstances.get(aClass);\\n    if (Objects.isNull(o)) {\\n        try {\\n            // \u53cd\u5c04\u5b9e\u4f8b\u5316\u5e76\u4e14\u7f13\u5b58\u8be5\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\\n            joinInstances.putIfAbsent(aClass, aClass.newInstance());\\n            o = joinInstances.get(aClass);\\n        } catch (InstantiationException | IllegalAccessException e) {\\n            throw new IllegalStateException(\\"Extension instance(name: \\" + name + \\", class: \\"\\n                    + aClass + \\")  could not be instantiated: \\" + e.getMessage(), e);\\n            \\n        }\\n    }\\n    Holder<T> objectHolder = new Holder<>();\\n    objectHolder.setOrder(classEntity.getOrder());\\n    objectHolder.setValue((T) o);\\n    return objectHolder;\\n}\\n```\\n\\n\u4ece`createExtension()`\u65b9\u6cd5\u4e2d\u53ef\u4ee5\u770b\u5230\u6700\u7ec8\u662f\u4f7f\u7528\u53cd\u5c04\u65b9\u5f0f\u5b9e\u4f8b\u5316\u5b9e\u73b0\u7c7b\uff0c\u53cd\u5c04\u65b9\u6cd5`newInstance()`\u8981\u6c42\u8be5\u7c7b\u5fc5\u987b\u63d0\u4f9b\u65e0\u53c2\u6784\u9020\u51fd\u6570\uff0c\u56e0\u4e3a\u8fd9\u91cc\u6709\u4e00\u70b9\u9690\u542b\u7684\u7ea6\u5b9a\uff1a`SPI`\u5b9e\u73b0\u7c7b**\u5fc5\u987b\u63d0\u4f9b\u65e0\u53c2\u6784\u9020\u51fd\u6570**\uff0c\u5426\u5219\u4f1a\u5b9e\u4f8b\u5316\u5931\u8d25\u3002\u5269\u4f59\u7684`getDefaultJoin()`\u548c`getJoins()`\u662f\u57fa\u4e8e`getJoin()`\u65b9\u6cd5\u8fdb\u884c\u6269\u5c55\uff0c\u529f\u80fd\u5e76\u4e0d\u590d\u6742\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5c55\u5f00\u5206\u6790\u4e86\u3002\u53e6\u5916\uff0c\u5728`getJoin()`\u65b9\u6cd5\u7528\u5230\u4e86\u591a\u7ea7\u7f13\u5b58\uff1a\\n\\n- `cachedInstances`\uff1a\u901a\u8fc7\u522b\u540d\u5c31\u53ef\u4ee5\u641c\u7d22\u5230\u5bf9\u5e94\u7684\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\\n- `joinInstances`\uff1a\u522b\u540d\u67e5\u627e\u5931\u8d25\uff0c\u5219\u52a0\u8f7d\u6240\u6709\u5b9e\u73b0\u7c7b\u4fe1\u606f\uff0c\u7136\u540e\u901a\u8fc7\u522b\u540d\u5b9a\u4f4d\u5b9e\u73b0\u7c7b\u7c7b\u578b\uff0c\u518d\u901a\u8fc7\u5b9e\u73b0\u7c7b\u7c7b\u578b\u67e5\u627e\u6216\u8005\u521b\u5efa\u5e76\u7f13\u5b58\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\u540e\u66f4\u65b0`cachedInstances`\u7f13\u5b58\\n\\n\u5230\u6b64\uff0c`ExtensionLoader`\u7684\u6e90\u7801\u5206\u6790\u5b8c\u6bd5\u3002\u8fd9\u91cc\u518d\u901a\u8fc7\u4e00\u4e2a`ExtensionLoader`\u5b9e\u4f8b\u6210\u5458\u5c5e\u6027\u5185\u5b58\u5e03\u5c40\u56fe\u53ef\u4ee5\u52a0\u6df1\u7406\u89e3\uff1a\\n\\n![spi-attr-memory-debug](/img/activities/code-analysis-spi/spi-attr-memory-debug.png)\\n\\n### ExtensionFactory\\n\\n`ExtensionFactory`\u662f\u5de5\u5382\u6a21\u5f0f\u91cc\u9762\u7684\u5de5\u5382\u63a5\u53e3\uff0c\u8be5\u63a5\u53e3\u5b9a\u4e49\u4e86\u4e00\u4e2a\u83b7\u53d6`SPI`\u5b9e\u73b0\uff08**\u9ed8\u8ba4\u5b9e\u73b0\uff0c\u552f\u4e00**\uff09\u5b9e\u4f8b\u7684\u65b9\u6cd5\uff1a\\n\\n```java\\n@SPI(\\"spi\\")\\npublic interface ExtensionFactory {\\n\\n    /**\\n     * Gets Extension.\\n     *\\n     * @param <T>   the type parameter\\n     * @param key   \u6b64\u53c2\u6570\u6682\u65f6\u6ca1\u6709\u4f7f\u7528\uff0c\u731c\u6d4b\u662f\u9884\u7559\u7528\u4e8e\u6620\u5c04@SPI\u7684value()\\n     * @param clazz @SPI\u6807\u8bc6\u7684\u63a5\u53e3\u7c7b\u578b\\n     * @return the extension\\n     */\\n    <T> T getExtension(String key, Class<T> clazz);\\n}\\n```\\n\\n\u63a5\u7740\u770b\u5176\u5b9e\u73b0\u7c7b`SpiExtensionFactory`\u7684\u4ee3\u7801\uff1a\\n\\n```java\\n@Join\\npublic class SpiExtensionFactory implements ExtensionFactory {\\n\\n    @Override\\n    public <T> T getExtension(final String key, final Class<T> clazz) {\\n        return Optional.ofNullable(clazz)   // \u5165\u53c2clazz\u975e\u7a7a\\n                .filter(Class::isInterface)  // \u5165\u53c2clazz\u5fc5\u987b\u662f\u63a5\u53e3\\n                .filter(cls -> cls.isAnnotationPresent(SPI.class))  // \u5165\u53c2clazz\u5fc5\u987b\u88ab@SPI\u6807\u8bc6\\n                .map(ExtensionLoader::getExtensionLoader)  // \u57fa\u4e8eclazz\u8fd9\u4e2a\u63a5\u53e3\u7c7b\u578b\u5b9e\u4f8b\u5316ExtensionLoader\\n                .map(ExtensionLoader::getDefaultJoin)  // \u83b7\u53d6\u8be5@SPI\u6807\u8bc6\u63a5\u53e3\u7684\u9ed8\u8ba4\u5b9e\u73b0\uff0c\u4e0d\u5b58\u5728\u5219\u8fd4\u56deNULL\\n                .orElse(null);\\n    }\\n}\\n```\\n\\n\u8fd9\u91cc\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff1a`ExtensionFactory`\u672c\u8eab\u4e5f\u662f`SPI`\u7cfb\u7edf\u7684\u4e00\u90e8\u5206\u3002\u56e0\u6b64\u4f7f\u7528`ExtensionFactory`\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u5b9e\u4f8b\u5316\uff1a\\n\\n```java\\nExtensionFactory extensionFactory = new SpiExtensionFactory();\\n```\\n\\n\u4e5f\u53ef\u4ee5\u57fa\u4e8e`ExtensionLoader`\u8fdb\u884c\u52a0\u8f7d\uff1a\\n\\n```java\\n# \u5728\u7c7b\u8def\u5f84META-INF/services/shenyu\u76ee\u5f55\u4e0b\u6dfb\u52a0\u4e00\u4e2a\u5c5e\u6027\u6587\u4ef6org.apache.shenyu.spi.ExtensionFactory\uff0c\u5185\u5bb9\u662f\\nspi=org.apache.shenyu.spi.SpiExtensionFactory\\n\\n# \u7136\u540e\u57fa\u4e8eExtensionLoader\u8fdb\u884c\u52a0\u8f7d\\nExtensionFactory extensionFactory = ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getDefaultJoin();\\n```\\n\\n\u5f97\u5230`ExtensionFactory`\u5b9e\u4f8b\u540e\u5c31\u53ef\u4ee5\u57fa\u4e8e`@SPI`\u63a5\u53e3\u52a0\u8f7d\u5176\u9ed8\u8ba4\u5b9e\u73b0\u7c7b\u7684\u5b9e\u4f8b\u3002\\n\\n## \u6269\u5c55\u548c\u5efa\u8bae\\n\\n\u4e0b\u9762\u662f\u4e2a\u4eba\u7684\u4e00\u4e9b\u89c1\u89e3\u3002\u76ee\u524d\u6765\u770b\uff0c`Shenyu`\u4e2d\u7684`SPI`\u6a21\u5757\u529f\u80fd\u662f\u5b8c\u5907\u7684\uff0c\u5efa\u8bae\u8003\u8651\u5f15\u5165\u4e24\u4e2a\u5e38\u7528\u7684\u529f\u80fd\uff1a\\n\\n- \u53ef\u4ee5\u5728`Join`\u6ce8\u89e3\u4e2d\u6dfb\u52a0\u5c5e\u6027\u6807\u8bb0`SPI`\u63a5\u53e3\u5b9e\u73b0\u7c7b\u751f\u6210\u7684\u5b9e\u4f8b\u662f\u5355\u4f8b\u8fd8\u662f\u5168\u65b0\u5b9e\u4f8b\uff0c\u7c7b\u4f3c\u4e8e`Spring`\u4e2d\u7684`Scope`\u58f0\u660e\uff08`singleton`\u6216\u8005`prototype`\uff09\u90a3\u6837\uff0c\u4f8b\u5982\uff1a\\n\\n```java\\n@Documented\\n@Retention(RetentionPolicy.RUNTIME)\\n@Target(ElementType.TYPE)\\npublic @interface Join {\\n    \\n    /**\\n     * It will be sorted according to the current serial number..\\n     * @return int.\\n     */\\n    int order() default 0;\\n\\n    /**\\n     * The join class instance should be singleton or not\\n     * @return true or false\\n     */\\n    boolean isSingleton() default true;\\n}\\n```\\n\\n- **\u53ef\u9009\u5730**\u8ba9`SPI`\u7684\u5b9e\u73b0\u7c7b\u5b9e\u73b0\u4e00\u4e2a\u521d\u59cb\u5316\u5668\u63a5\u53e3\uff0c\u5728\u8be5\u5b9e\u73b0\u7c7b\u5b9e\u4f8b\u5316\u540e\u56de\u8c03\u521d\u59cb\u5316\u5668\u63a5\u53e3\u65b9\u6cd5\uff0c\u4f8b\u5982\uff1a\\n\\n```java\\npublic interface ExtensionInitializer {\\n    \\n    void init();  \\n}\\n\\n/**\\n * demo\\n */\\n@SPI\\npublic interface JdbcSPI {\\n\\n    String getClassName();\\n}\\n\\n@Join\\npublic class MysqlSPI implements JdbcSPI, ExtensionInitializer {\\n\\n    @Override\\n    public void init() {\\n        // callback when MysqlSPI instance init\\n    }\\n    \\n    @Override\\n    public String getClassName() {\\n        return \\"mysql\\";\\n    }\\n}\\n```\\n\\n\u5982\u679c\u6dfb\u52a0\u4e86\u8fd9\u4e24\u70b9\uff0c\u80fd\u591f\u6ee1\u8db3\u5f88\u591a\u73b0\u5b9e\u573a\u666f\u7684\u9700\u6c42\u3002\u53e6\u5916\uff0c`ExtensionLoader`\u4e2d\u7684\u4e24\u5904\u6bd4\u8f83\u5668\u6210\u5458\u53d8\u91cf\u53ef\u4ee5\u8fdb\u884c\u4ee3\u7801\u7cbe\u7b80\uff0c\u4f8b\u5982\u5bf9`classEntityComparator`\u800c\u8a00\uff1a\\n\\n```java\\nprivate final Comparator<ClassEntity> classEntityComparator = (o1, o2) -> {\\n    if (o1.getOrder() > o2.getOrder()) {\\n        return 1;\\n    } else if (o1.getOrder() < o2.getOrder()) {\\n        return -1;\\n    } else {\\n        return 0;\\n    }\\n};\\n\\n// \u53ef\u4ee5\u7cbe\u7b80\u4e3aComparator\u63d0\u4f9b\u7684\u9759\u6001\u5de5\u5382\u65b9\u6cd5\u548c\u65b9\u6cd5\u5f15\u7528\\nprivate final Comparator<ClassEntity> classEntityComparator = Comparator.comparing(ClassEntity::getOrder);\\n```\\n\\n## \u5c0f\u7ed3\\n\\n\u57fa\u4e8e`Java`\u539f\u751f`SPI`\u8bbe\u8ba1\u601d\u8def\u4e0a\u8bbe\u8ba1\u51fa\u6765\u7684`SPI`\u6846\u67b6\u5177\u5907\u4e86\u677e\u8026\u5408\u3001\u9ad8\u6613\u7528\u6027\u548c\u9ad8\u6269\u5c55\u6027\u7684\u7279\u70b9\uff0c\u5e76\u4e14\u6dfb\u52a0\u4e86\u52a0\u8f7d\u5b9e\u4f8b\u7f13\u5b58\u3001\u5e76\u53d1\u5b89\u5168\u7b49\u7279\u6027\uff0c\u586b\u8865\u4e86\u539f\u751f`JDK`\u4e2d`SPI`\u7684\u4e00\u4e9b\u7f3a\u9677\uff0c`Shenyu`\u7684`SPI`\u6a21\u5757\u4e5f\u662f\u5982\u6b64\u3002\u6b63\u662f\u7531\u4e8e\u6b64\u5f3a\u5927\u7684`SPI`\u6a21\u5757\u7684\u5b58\u5728\uff0c`Shenyu`\u4e2d\u7684\u5176\u4ed6\u6a21\u5757\u5982`Plugin`\u6a21\u5757\u53ef\u4ee5\u5b9e\u73b0\u5feb\u901f\u63d2\u62d4\u5f0f\u914d\u7f6e\uff0c\u8ba9\u52a0\u8f7d\u4e00\u4e2a\u5168\u65b0\u5f00\u53d1\u7684\u63d2\u4ef6\u5b9e\u4f8b\u53d8\u5f97\u66f4\u52a0\u5bb9\u6613\u3002"}]}')}}]);