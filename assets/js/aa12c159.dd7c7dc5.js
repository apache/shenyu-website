"use strict";(self.webpackChunkshenyu_website=self.webpackChunkshenyu_website||[]).push([[12929],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||o;return n?a.createElement(m,r(r({ref:t},p),{},{components:n})):a.createElement(m,r({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:i,r[1]=s;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},50542:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=n(87462),i=(n(67294),n(3905));const o={title:"WebSocket Data Synchronization Source Code Analysis",author:"midnight2104",author_title:"Apache ShenYu Committer",author_url:"https://github.com/midnight2104",tags:["websocket","data sync","Apache ShenYu"]},r=void 0,s={permalink:"/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync",editUrl:"https://github.com/apache/shenyu-website/edit/main/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync.md",source:"@site/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync.md",title:"WebSocket Data Synchronization Source Code Analysis",description:"In ShenYu gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for ZooKeeper, WebSocket, http long poll, Nacos, etcd and Consul. The main content of this article is based on WebSocket data synchronization source code analysis.",date:"2023-04-17T14:23:53.114Z",formattedDate:"April 17, 2023",tags:[{label:"websocket",permalink:"/blog/tags/websocket"},{label:"data sync",permalink:"/blog/tags/data-sync"},{label:"Apache ShenYu",permalink:"/blog/tags/apache-shen-yu"}],readingTime:21.225,truncated:!1,prevItem:{title:"Nacos Data Synchronization Source Code Analysis",permalink:"/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync"},nextItem:{title:"ZooKeeper Data Synchronization Source Code Analysis",permalink:"/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync"}},l=[{value:"1. About WebSocket Communication",id:"1-about-websocket-communication",children:[]},{value:"2. Admin Data Sync",id:"2-admin-data-sync",children:[]},{value:"3. Gateway Data Sync",id:"3-gateway-data-sync",children:[]},{value:"4. The Gateway Establishes a Websocket Connection with Admin",id:"4-the-gateway-establishes-a-websocket-connection-with-admin",children:[]},{value:"5. Summary",id:"5-summary",children:[]}],c={toc:l},p="wrapper";function d(e){let{components:t,...o}=e;return(0,i.kt)(p,(0,a.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"In ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu")," gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for ",(0,i.kt)("inlineCode",{parentName:"p"},"ZooKeeper"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"WebSocket"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"http long poll"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"Nacos"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Consul"),". The main content of this article is based on ",(0,i.kt)("inlineCode",{parentName:"p"},"WebSocket")," data synchronization source code analysis."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This paper based on ",(0,i.kt)("inlineCode",{parentName:"p"},"shenyu-2.4.0")," version of the source code analysis, the official website of the introduction of please refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/docs/design/data-sync/"},"Data Synchronization Design")," .")),(0,i.kt)("h3",{id:"1-about-websocket-communication"},"1. About WebSocket Communication"),(0,i.kt)("p",null,"The WebSocket protocol was born in 2008 and became an international standard in 2011. It can be two-way communication, the server can take the initiative to push information to the client, the client can also take the initiative to send information to the server. The WebSocket protocol is based on the TCP protocol and belongs to the application layer, with low performance overhead and high communication efficiency. The protocol identifier is ",(0,i.kt)("inlineCode",{parentName:"p"},"ws"),"."),(0,i.kt)("h3",{id:"2-admin-data-sync"},"2. Admin Data Sync"),(0,i.kt)("p",null,"Let's trace the source code from a real case, such as adding a selector data in the background management system:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(51180).Z})),(0,i.kt)("h4",{id:"21-accept-changed-data"},"2.1 Accept Changed Data"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"SelectorController.createSelector()")),(0,i.kt)("p",null,"Enter the createSelector() method of the ",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorController")," class, which validates data, adds or updates data, and returns results."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Validated\n@RequiredArgsConstructor\n@RestController\n@RequestMapping("/selector")\npublic class SelectorController {\n    \n    @PostMapping("")\n    public ShenyuAdminResult createSelector(@Valid @RequestBody final SelectorDTO selectorDTO) { // @Valid \u6570\u6821\u9a8c\n        // create or update data\n        Integer createCount = selectorService.createOrUpdate(selectorDTO);\n        // return result\n        return ShenyuAdminResult.success(ShenyuResultMessage.CREATE_SUCCESS, createCount);\n    }\n    \n    // ......\n}\n')),(0,i.kt)("h4",{id:"22-handle-data"},"2.2 Handle Data"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"SelectorServiceImpl.createOrUpdate()")),(0,i.kt)("p",null,"Convert data in the ",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorServiceImpl")," class using the ",(0,i.kt)("inlineCode",{parentName:"p"},"createOrUpdate()")," method, save it to the database, publish the event, update ",(0,i.kt)("inlineCode",{parentName:"p"},"upstream"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"@RequiredArgsConstructor\n@Service\npublic class SelectorServiceImpl implements SelectorService {\n    // eventPublisher\n    private final ApplicationEventPublisher eventPublisher;\n    \n    @Override\n    @Transactional(rollbackFor = Exception.class)\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\n        int selectorCount;\n        // build data DTO --\x3e DO\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\n        // insert or update ?\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\n            //  insert into data\n            selectorCount = selectorMapper.insertSelective(selectorDO);\n            // insert into condition data\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\n            });\n            // check selector add\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\n                dataPermissionDTO.setDataId(selectorDO.getId());\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\n            }\n\n        } else {\n            // update data, delete and then insert\n            selectorCount = selectorMapper.updateSelective(selectorDO);\n            //delete rule condition then add\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\n                selectorConditionMapper.insertSelective(selectorConditionDO);\n            });\n        }\n        // publish event\n        publishEvent(selectorDO, selectorConditionDTOs);\n\n        // update upstream\n        updateDivideUpstream(selectorDO);\n        return selectorCount;\n    }\n    \n    \n    // ......\n    \n}\n\n")),(0,i.kt)("p",null,"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"Service")," class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization."),(0,i.kt)("p",null,"The logic of the ",(0,i.kt)("inlineCode",{parentName:"p"},"publishEvent()"),"  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"       private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\n        // find plugin of selector\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\n        // build condition data\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\n        // publish event\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\n    }\n")),(0,i.kt)("p",null,"Change data released by ",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher.PublishEvent()")," is complete, the ",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher")," object is a ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher")," class, The fully qualified class name is ",(0,i.kt)("inlineCode",{parentName:"p"},"org.springframework.context.ApplicationEventPublisher"),". Here we see that publishing data is done through ",(0,i.kt)("inlineCode",{parentName:"p"},"Spring")," related functionality."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),"\uff1a"),(0,i.kt)("p",{parentName:"blockquote"},"When a state change, the publisher calls ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher")," of ",(0,i.kt)("inlineCode",{parentName:"p"},"publishEvent")," method to release an event, ",(0,i.kt)("inlineCode",{parentName:"p"},"Spring")," container broadcast event for all observers, The observer's ",(0,i.kt)("inlineCode",{parentName:"p"},"onApplicationEvent")," method is called to pass the event object to the observer. There are two ways to call ",(0,i.kt)("inlineCode",{parentName:"p"},"publishEvent")," method, one is to implement the interface by the container injection ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher")," object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference."),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ApplicationEventPublisher"),": publish event;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ApplicationEvent"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"Spring")," event, record the event source, time, and data;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ApplicationListener"),": event listener, observer."))),(0,i.kt)("p",null,"In Spring event publishing mechanism, there are three objects,"),(0,i.kt)("p",null,"An object is a publish event ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),", in ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu")," through the constructor in the injected a ",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher"),"."),(0,i.kt)("p",null,"The other object is ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEvent")," , inherited from ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu")," through ",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedEvent"),", representing the event object."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public class DataChangedEvent extends ApplicationEvent {\n//......\n}\n")),(0,i.kt)("p",null,"The last object is ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationListener")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu")," in through ",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedEventDispatcher")," class implements this interface, as the event listener, responsible for handling the event object."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n    //......\n    \n}\n")),(0,i.kt)("h4",{id:"23-dispatch-data"},"2.3 Dispatch Data"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"DataChangedEventDispatcher.onApplicationEvent()")),(0,i.kt)("p",null,"Released when the event is completed, will automatically enter the ",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedEventDispatcher")," class ",(0,i.kt)("inlineCode",{parentName:"p"},"onApplicationEvent()")," method of handling events."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n  /**\n     * This method is called when there are data changes\n   * @param event\n     */\n    @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // Iterate through the data change listener (usually using a data synchronization approach is fine)\n      for (DataChangedListener listener : listeners) {\n            // What kind of data has changed\n        switch (event.getGroupKey()) {\n                case APP_AUTH: // app auth data\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\n                    break;\n                case PLUGIN:  // plugin data\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\n                    break;\n                case RULE:    // rule data\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\n                    break;\n                case SELECTOR:   // selector data\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\n                    break;\n                case META_DATA:  // metadata\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\n                    break;\n                default:  // Other types throw exception\n                  throw new IllegalStateException("Unexpected value: " + event.getGroupKey());\n            }\n        }\n    }\n    \n}\n')),(0,i.kt)("p",null,"When there is a data change, the ",(0,i.kt)("inlineCode",{parentName:"p"},"onApplicationEvent")," method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing."),(0,i.kt)("p",null,"ShenYu groups all the data into five categories: APP_AUTH, PLUGIN, RULE, SELECTOR and META_DATA."),(0,i.kt)("p",null,"Here the data change listener (",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedListener"),") is an abstraction of the data synchronization policy. Its concrete implementation is:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(74907).Z})),(0,i.kt)("p",null,"These implementation classes are the synchronization strategies currently supported by ShenYu:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"WebsocketDataChangedListener"),": data synchronization based on Websocket; "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ZookeeperDataChangedListener"),":data synchronization based on Zookeeper; "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ConsulDataChangedListener"),": data synchronization based on Consul;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EtcdDataDataChangedListener"),"\uff1adata synchronization based on etcd;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"HttpLongPollingDataChangedListener"),"\uff1adata synchronization based on http long polling;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"NacosDataChangedListener"),"\uff1adata synchronization based on nacos;")),(0,i.kt)("p",null,"Given that there are so many implementation strategies, how do you decide which to use?"),(0,i.kt)("p",null,"Because this paper is based on ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," data synchronization source code analysis, so here to ",(0,i.kt)("inlineCode",{parentName:"p"},"WebsocketDataChangedListener")," as an example, the analysis of how it is loaded and implemented."),(0,i.kt)("p",null,"A global search in the source code project shows that its implementation is done in the ",(0,i.kt)("inlineCode",{parentName:"p"},"DataSyncConfiguration")," class."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * Data Sync Configuration\n * By springboot conditional assembly\n * The type Data sync configuration.\n */\n@Configuration\npublic class DataSyncConfiguration {\n    \n /**\n     * The WebsocketListener(default strategy).\n     */\n    @Configuration\n    @ConditionalOnProperty(name = "shenyu.sync.websocket.enabled", havingValue = "true", matchIfMissing = true)\n    @EnableConfigurationProperties(WebsocketSyncProperties.class)\n    static class WebsocketListener {\n\n        /**\n         * Config event listener data changed listener.\n         * @return the data changed listener\n         */\n        @Bean\n        @ConditionalOnMissingBean(WebsocketDataChangedListener.class)\n        public DataChangedListener websocketDataChangedListener() {\n            return new WebsocketDataChangedListener();\n        }\n\n        /**\n         * Websocket collector.\n         * Websocket collector class: establish a connection, send a message, close the connection and other operations\n         * @return the websocket collector\n         */\n        @Bean\n        @ConditionalOnMissingBean(WebsocketCollector.class)\n        public WebsocketCollector websocketCollector() {\n            return new WebsocketCollector();\n        }\n\n        /**\n         * Server endpoint exporter \n         *\n         * @return the server endpoint exporter\n         */\n        @Bean\n        @ConditionalOnMissingBean(ServerEndpointExporter.class)\n        public ServerEndpointExporter serverEndpointExporter() {\n            return new ServerEndpointExporter();\n        }\n    }\n    \n    //......\n}\n\n')),(0,i.kt)("p",null,"This configuration class is implemented through the ",(0,i.kt)("inlineCode",{parentName:"p"},"SpringBoot")," conditional assembly class. The ",(0,i.kt)("inlineCode",{parentName:"p"},"WebsocketListener")," class has several annotations:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"@Configuration"),": Configuration file, application context;")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},'@ConditionalOnProperty(name = "shenyu.sync.websocket.enabled", havingValue = "true", matchIfMissing = true)'),": attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," is used for data synchronization. Note, however, the ",(0,i.kt)("inlineCode",{parentName:"p"},"matchIfMissing = true")," attribute, which means that this configuration class will work if you don't have the following configuration. Data synchronization based on ",(0,i.kt)("inlineCode",{parentName:"p"},"webSocket")," is officially recommended and the default."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-properties"},"shenyu:  \n  sync:\n    websocket:\n      enabled: true\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"@EnableConfigurationProperties"),"\uff1aenable configuration properties;"))),(0,i.kt)("p",null,"When we take the initiative to configuration, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," data synchronization, ",(0,i.kt)("inlineCode",{parentName:"p"},"WebsocketDataChangedListener")," is generated. So in the event handler ",(0,i.kt)("inlineCode",{parentName:"p"},"onApplicationEvent()"),", it goes to the corresponding ",(0,i.kt)("inlineCode",{parentName:"p"},"listener"),". In our case, a selector is to increase the new data, the data by adopting the ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket"),", so, the code will enter the ",(0,i.kt)("inlineCode",{parentName:"p"},"WebsocketDataChangedListener")," selector data change process."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'    @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // Iterate through the data change listener (usually using a data synchronization approach is fine)\n        for (DataChangedListener listener : listeners) {\n            // What kind of data has changed\n             switch (event.getGroupKey()) {\n                    \n                // other logic is omitted\n              case SELECTOR:   // selector data\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // WebsocketDataChangedListener handle selector data\n                    break;\n         }\n    }\n')),(0,i.kt)("h4",{id:"24-websocket-data-changed-listener"},"2.4 Websocket Data Changed Listener"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"WebsocketDataChangedListener.onSelectorChanged()")),(0,i.kt)("p",null,"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"onSelectorChanged()")," method, the data is encapsulated into ",(0,i.kt)("inlineCode",{parentName:"p"},"WebsocketData")," and then sent via ",(0,i.kt)("inlineCode",{parentName:"p"},"webSocketCollector.send()"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"    // selector data has been updated\n    @Override\n    public void onSelectorChanged(final List<SelectorData> selectorDataList, final DataEventTypeEnum eventType) {\n        // build WebsocketData \n        WebsocketData<SelectorData> websocketData =\n                new WebsocketData<>(ConfigGroupEnum.SELECTOR.name(), eventType.name(), selectorDataList);\n        // websocket send data\n        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);\n    }\n")),(0,i.kt)("h4",{id:"25-websocket-send-data"},"2.5 Websocket Send Data"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"WebsocketCollector.send()")),(0,i.kt)("p",null,"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"send()")," method, the type of synchronization is determined and processed according to the different types."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Slf4j\n@ServerEndpoint(value = "/websocket", configurator = WebsocketConfigurator.class)\npublic class WebsocketCollector {\n    \n/**\n     * Send.\n     *\n     * @param message the message\n     * @param type    the type\n     */\n    public static void send(final String message, final DataEventTypeEnum type) {\n        if (StringUtils.isNotBlank(message)) {\n            // If it\'s MYSELF (first full synchronization)\n          if (DataEventTypeEnum.MYSELF == type) {\n                // get the session from ThreadLocal\n            Session session = (Session) ThreadLocalUtil.get(SESSION_KEY);\n                if (session != null) {\n                    // send full data to the session\n                   sendMessageBySession(session, message);\n                }\n            } else {\n                // subsequent incremental synchronization\n                // synchronize change data to all sessions\n               SESSION_SET.forEach(session -> sendMessageBySession(session, message));\n            }\n        }\n    }\n\n    private static void sendMessageBySession(final Session session, final String message) {\n        try {\n            // The message is sent through the Websocket session\n           session.getBasicRemote().sendText(message);\n        } catch (IOException e) {\n            log.error("websocket send result is exception: ", e);\n        }\n    }\n}\n')),(0,i.kt)("p",null,"The example we give is a new operation, an incremental synchronization, so it goes"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"SESSION_SET.forEach(session -> sendMessageBySession(session, message));")),(0,i.kt)("p",null,"then through"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"session.getBasicRemote().sendText(message);")),(0,i.kt)("p",null,"the data was sent out."),(0,i.kt)("p",null,"At this point, when data changes occur on the admin side, the changed data is increments sent to the gateway through the ",(0,i.kt)("inlineCode",{parentName:"p"},"WebSocket"),"."),(0,i.kt)("p",null,"At this point, do you have any questions? For example, where does session come from? How does the gateway establish a connection with admin?"),(0,i.kt)("p",null,"Don't worry, let's do the synchronization analysis on the gateway side."),(0,i.kt)("p",null,"However, before continuing with the source code analysis, let's use a diagram to string together the above analysis process."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(95431).Z})),(0,i.kt)("h3",{id:"3-gateway-data-sync"},"3. Gateway Data Sync"),(0,i.kt)("p",null,"Assume ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu")," gateway is already in normal operation, using the data synchronization mode is also ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket"),". How does the gateway receive and process new selector data from admin and send it to the gateway via WebSocket? Let's continue our source code analysis to find out."),(0,i.kt)("h4",{id:"31-websocketclient-accept-data"},"3.1 WebsocketClient Accept Data"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"ShenyuWebsocketClient.onMessage()")),(0,i.kt)("p",null,"There is a ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenyuWebsocketClient")," class on the gateway, which inherits from ",(0,i.kt)("inlineCode",{parentName:"p"},"WebSocketClient")," and can establish a connection and communicate with ",(0,i.kt)("inlineCode",{parentName:"p"},"WebSocket"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public final class ShenyuWebsocketClient extends WebSocketClient {\n  // ......\n}\n")),(0,i.kt)("p",null,"After sending data via ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," on the admin side, ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenyuWebsocketClient")," can receive data via ",(0,i.kt)("inlineCode",{parentName:"p"},"onMessage()")," and then process it itself."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public final class ShenyuWebsocketClient extends WebSocketClient {\n      // execute after receiving the message\n    @Override\n    public void onMessage(final String result) {\n        // handle accept data\n        handleResult(result);\n    }\n    \n    private void handleResult(final String result) {\n        // data deserialization\n        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);\n        // which data types, plug-ins, selectors, rules...\n        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());\n        // which operation type, update, delete...      \n        String eventType = websocketData.getEventType();\n        String json = GsonUtils.getInstance().toJson(websocketData.getData());\n\n        // handle data\n        websocketDataHandler.executor(groupEnum, json, eventType);\n    }\n}\n")),(0,i.kt)("p",null,"After receiving the data, first has carried on the deserialization operation, read the data type and operation type, then hand over to ",(0,i.kt)("inlineCode",{parentName:"p"},"websocketDataHandler.executor()")," for processing."),(0,i.kt)("h4",{id:"32-execute-websocket-data-handler"},"3.2 Execute Websocket Data Handler"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"WebsocketDataHandler.executor()")),(0,i.kt)("p",null,"A ",(0,i.kt)("inlineCode",{parentName:"p"},"Websocket")," data handler is created in factory mode, providing one handler for each data type:"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"plugin --\x3e PluginDataHandler;"),(0,i.kt)("p",{parentName:"blockquote"},"selector --\x3e SelectorDataHandler;"),(0,i.kt)("p",{parentName:"blockquote"},"rule --\x3e RuleDataHandler;"),(0,i.kt)("p",{parentName:"blockquote"},"auth --\x3e AuthDataHandler;"),(0,i.kt)("p",{parentName:"blockquote"},"metadata --\x3e MetaDataHandler.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"\n/**\n * Create Websocket data handlers through factory mode\n * The type Websocket cache handler.\n */\npublic class WebsocketDataHandler {\n\n    private static final EnumMap<ConfigGroupEnum, DataHandler> ENUM_MAP = new EnumMap<>(ConfigGroupEnum.class);\n\n    /**\n     * Instantiates a new Websocket data handler.\n     * @param pluginDataSubscriber the plugin data subscriber\n     * @param metaDataSubscribers  the meta data subscribers\n     * @param authDataSubscribers  the auth data subscribers\n     */\n    public WebsocketDataHandler(final PluginDataSubscriber pluginDataSubscriber,\n                                final List<MetaDataSubscriber> metaDataSubscribers,\n                                final List<AuthDataSubscriber> authDataSubscribers) {\n        // plugin --\x3e PluginDataHandler\n        ENUM_MAP.put(ConfigGroupEnum.PLUGIN, new PluginDataHandler(pluginDataSubscriber));\n        // selector --\x3e SelectorDataHandler\n        ENUM_MAP.put(ConfigGroupEnum.SELECTOR, new SelectorDataHandler(pluginDataSubscriber));\n        // rule --\x3e RuleDataHandler\n        ENUM_MAP.put(ConfigGroupEnum.RULE, new RuleDataHandler(pluginDataSubscriber));\n        // auth --\x3e AuthDataHandler\n        ENUM_MAP.put(ConfigGroupEnum.APP_AUTH, new AuthDataHandler(authDataSubscribers));\n        // metadata --\x3e MetaDataHandler\n        ENUM_MAP.put(ConfigGroupEnum.META_DATA, new MetaDataHandler(metaDataSubscribers));\n    }\n\n    /**\n     * Executor.\n     *\n     * @param type      the type\n     * @param json      the json\n     * @param eventType the event type\n     */\n    public void executor(final ConfigGroupEnum type, final String json, final String eventType) {\n        // find the corresponding data handler based on the data type\n        ENUM_MAP.get(type).handle(json, eventType);\n    }\n}\n\n")),(0,i.kt)("p",null,"Different data types have different ways of handling data, so there are different implementation classes. But they also have the same processing logic between them, so they can be implemented through the template approach to design patterns. The same logic is placed in the ",(0,i.kt)("inlineCode",{parentName:"p"},"handle()")," method of the abstract class, and the different logic is handed over to the respective implementation class."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(33965).Z})),(0,i.kt)("p",null,"In our case, a new selector is added, so it will be passed to the ",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorDataHandler")," for data processing."),(0,i.kt)("h4",{id:"33-determine-the-event-type"},"3.3 Determine the Event Type"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"AbstractDataHandler.handle()")),(0,i.kt)("p",null,"Implement common logical handling of data changes: invoke different methods based on different operation types."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"\npublic abstract class AbstractDataHandler<T> implements DataHandler {\n\n    /**\n     * Convert list.\n     * The different logic is implemented by the respective implementation classes\n     * @param json the json\n     * @return the list\n     */\n    protected abstract List<T> convert(String json);\n\n    /**\n     * Do refresh.\n     * The different logic is implemented by the respective implementation classes\n     * @param dataList the data list\n     */\n    protected abstract void doRefresh(List<T> dataList);\n\n    /**\n     * Do update.\n     * The different logic is implemented by the respective implementation classes\n     * @param dataList the data list\n     */\n    protected abstract void doUpdate(List<T> dataList);\n\n    /**\n     * Do delete.\n     * The different logic is implemented by the respective implementation classes\n     * @param dataList the data list\n     */\n    protected abstract void doDelete(List<T> dataList);\n\n    // General purpose logic, abstract class implementation\n    @Override\n    public void handle(final String json, final String eventType) {\n        List<T> dataList = convert(json);\n        if (CollectionUtils.isNotEmpty(dataList)) {\n            DataEventTypeEnum eventTypeEnum = DataEventTypeEnum.acquireByName(eventType);\n            switch (eventTypeEnum) {\n                case REFRESH:\n                case MYSELF:\n                    doRefresh(dataList);  //Refreshes data and synchronizes all data\n                    break;\n                case UPDATE:\n                case CREATE:\n                    doUpdate(dataList); // Update or create data, incremental synchronization\n                    break;\n                case DELETE:\n                    doDelete(dataList);  // delete data\n                    break;\n                default:\n                    break;\n            }\n        }\n    }\n}\n")),(0,i.kt)("p",null,"New selector data, new operation, through ",(0,i.kt)("inlineCode",{parentName:"p"},"switch-case")," into ",(0,i.kt)("inlineCode",{parentName:"p"},"doUpdate()")," method."),(0,i.kt)("h4",{id:"34-enter-the-specific-data-handler"},"3.4 Enter the Specific Data Handler"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"SelectorDataHandler.doUpdate()")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"\n/**\n * The type Selector data handler.\n */\n@RequiredArgsConstructor\npublic class SelectorDataHandler extends AbstractDataHandler<SelectorData> {\n\n    private final PluginDataSubscriber pluginDataSubscriber;\n\n    //......\n\n    // update data\n    @Override\n    protected void doUpdate(final List<SelectorData> dataList) {\n        dataList.forEach(pluginDataSubscriber::onSelectorSubscribe);\n    }\n}\n")),(0,i.kt)("p",null,"Iterate over the data and enter the ",(0,i.kt)("inlineCode",{parentName:"p"},"onSelectorSubscribe()")," method."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"PluginDataSubscriber.onSelectorSubscribe()")),(0,i.kt)("p",null,"It has no additional logic and calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"subscribeDataHandler()")," method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information\n */\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\n    //......\n     // handle selector data\n    @Override\n    public void onSelectorSubscribe(final SelectoData selectorData) {\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\n    }    \n    \n    // A subscription data handler that handles updates or deletions of data\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\n        Optional.ofNullable(classData).ifPresent(data -> {\n            // plugin data\n            if (data instanceof PluginData) {\n                PluginData pluginData = (PluginData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // update\n                    // save the data to gateway memory\n                     BaseDataCache.getInstance().cachePluginData(pluginData);\n                    // If each plugin has its own processing logic, then do it\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete\n                    // delete the data from gateway memory\n                    BaseDataCache.getInstance().removePluginData(pluginData);\n                    // If each plugin has its own processing logic, then do it\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\n                }\n            } else if (data instanceof SelectorData) {  // selector data\n                SelectorData selectorData = (SelectorData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // update\n                    // save the data to gateway memory\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\n                    // If each plugin has its own processing logic, then do it \n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete\n                    // delete the data from gateway memory\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\n                    // If each plugin has its own processing logic, then do it\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\n                }\n            } else if (data instanceof RuleData) {  // rule data\n                RuleData ruleData = (RuleData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // update\n                    // save the data to gateway memory\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\n                    // If each plugin has its own processing logic, then do it\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\n                } else if (dataType == DataEventTypeEnum.DELETE) { // delete\n                    // delete the data from gateway memory\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\n                    // If each plugin has its own processing logic, then do it\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\n                }\n            }\n        });\n    }\n    \n}\n")),(0,i.kt)("p",null,"Adding a selector will enter the following logic:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"// save the data to gateway memory\nBaseDataCache.getInstance().cacheSelectData(selectorData);\n// If each plugin has its own processing logic, then do it\nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n")),(0,i.kt)("p",null,"One is to save the data to the gateway's memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the ",(0,i.kt)("inlineCode",{parentName:"p"},"SELECTOR_MAP")," Map. In the subsequent use, also from this data."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public final class BaseDataCache {\n    // private instance\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\n    // private constructor\n    private BaseDataCache() {\n    }\n    \n    /**\n     * Gets instance.\n     *  public method\n     * @return the instance\n     */\n    public static BaseDataCache getInstance() {\n        return INSTANCE;\n    }\n    \n    /**\n      * A Map of the cache selector data\n     * pluginName -> SelectorData.\n     */\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\n    \n    public void cacheSelectData(final SelectorData selectorData) {\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\n    }\n        \n   /**\n     * cache selector data.\n     * @param data the selector data\n     */\n    private void selectorAccept(final SelectorData data) {\n        String key = data.getPluginName();\n        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\n            resultList.add(data);\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\n            SELECTOR_MAP.put(key, collect);\n        } else {  // Add new operations directly to Map\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\n        }\n    }\n    \n}\n")),(0,i.kt)("p",null,"Second, if each plugin has its own processing logic, then do it. Through the ",(0,i.kt)("inlineCode",{parentName:"p"},"IDEA")," editor, you can see that after adding a selector, there are the following plugins and processing. We're not going to expand it here."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(38982).Z})),(0,i.kt)("p",null,"After the above source tracing, and through a practical case, in the ",(0,i.kt)("inlineCode",{parentName:"p"},"admin")," side to add a selector data, will ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," data synchronization process analysis cleared."),(0,i.kt)("p",null,"Let's use the following figure to concatenate the data synchronization process on the gateway side:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(8886).Z})),(0,i.kt)("p",null,"The data synchronization process has been analyzed, but there are still some problems that have not been analyzed, that is, how does the gateway establish a connection with admin?"),(0,i.kt)("h3",{id:"4-the-gateway-establishes-a-websocket-connection-with-admin"},"4. The Gateway Establishes a Websocket Connection with Admin"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"websocket config")),(0,i.kt)("p",null,"With the following configuration in the gateway configuration file and the dependency introduced, the ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," related service is started."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"shenyu:\n    file:\n      enabled: true\n    cross:\n      enabled: true\n    dubbo :\n      parameter: multi\n    sync:\n        websocket :  # Use websocket for data synchronization\n          urls: ws://localhost:9095/websocket   # websocket address of admin\n")),(0,i.kt)("p",null,"Add a dependency on websocket in the gateway."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"\x3c!--shenyu data sync start use websocket--\x3e\n<dependency>\n    <groupId>org.apache.shenyu</groupId>\n    <artifactId>shenyu-spring-boot-starter-sync-data-websocket</artifactId>\n    <version>${project.version}</version>\n</dependency>\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Websocket Data Sync Config")),(0,i.kt)("p",null,"The associated bean is created by conditional assembly of springboot. In the gateway started, if we configure the ",(0,i.kt)("inlineCode",{parentName:"p"},"shenyu.sync.websocket.urls"),", then ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," data synchronization configuration will be loaded. The dependency loading is done through the ",(0,i.kt)("inlineCode",{parentName:"p"},"springboot starter"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'\n/**\n * WebsocketSyncDataService\n * Conditional injection is implemented through SpringBoot\n * Websocket sync data configuration for spring boot.\n */\n@Configuration\n@ConditionalOnClass(WebsocketSyncDataService.class)\n@ConditionalOnProperty(prefix = "shenyu.sync.websocket", name = "urls")\n@Slf4j\npublic class WebsocketSyncDataConfiguration {\n\n    /**\n     * Websocket sync data service.\n     * @param websocketConfig   the websocket config\n     * @param pluginSubscriber the plugin subscriber\n     * @param metaSubscribers   the meta subscribers\n     * @param authSubscribers   the auth subscribers\n     * @return the sync data service\n     */\n    @Bean\n    public SyncDataService websocketSyncDataService(final ObjectProvider<WebsocketConfig> websocketConfig, final ObjectProvider<PluginDataSubscriber> pluginSubscriber,\n                                           final ObjectProvider<List<MetaDataSubscriber>> metaSubscribers, final ObjectProvider<List<AuthDataSubscriber>> authSubscribers) {\n        log.info("you use websocket sync shenyu data.......");\n        return new WebsocketSyncDataService(websocketConfig.getIfAvailable(WebsocketConfig::new), pluginSubscriber.getIfAvailable(),\n                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));\n    }\n\n    /**\n     * Config websocket config.\n     *\n     * @return the websocket config\n     */\n    @Bean\n    @ConfigurationProperties(prefix = "shenyu.sync.websocket")\n    public WebsocketConfig websocketConfig() {\n        return new WebsocketConfig();  \n    }\n}\n')),(0,i.kt)("p",null,"Start a new ",(0,i.kt)("inlineCode",{parentName:"p"},"spring.factories")," file in the ",(0,i.kt)("inlineCode",{parentName:"p"},"resources/META-INF")," directory of your project and specify the configuration classes in the file."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(31772).Z})),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"WebsocketSyncDataService")),(0,i.kt)("p",null,"The following things are done in 'WebsocketSyncDataService' :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Read configuration ",(0,i.kt)("inlineCode",{parentName:"p"},"urls"),', which represent the admin side of the synchronization address, if there are more than one, use "," split;')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Create a scheduling thread pool, with each ",(0,i.kt)("inlineCode",{parentName:"p"},"admin")," assigned one to perform scheduled tasks;")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Create ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenyuWebsocketClient"),", assign one to each ",(0,i.kt)("inlineCode",{parentName:"p"},"admin"),", set up ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," communication with ",(0,i.kt)("inlineCode",{parentName:"p"},"admin"),";")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Start connection with admin end ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket"),";")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Executes a scheduled task every 10 seconds. The main function is to determine whether the ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket")," connection has been disconnected, if so, try to reconnect. If not, a ",(0,i.kt)("inlineCode",{parentName:"p"},"ping-pong")," test is performed."))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'\n/**\n * Websocket sync data service.\n */\n@Slf4j\npublic class WebsocketSyncDataService implements SyncDataService, AutoCloseable {\n\n    private final List<WebSocketClient> clients = new ArrayList<>();\n\n    private final ScheduledThreadPoolExecutor executor;\n\n    /**\n     * Instantiates a new Websocket sync cache.\n     * @param websocketConfig      the websocket config\n     * @param pluginDataSubscriber the plugin data subscriber\n     * @param metaDataSubscribers  the meta data subscribers\n     * @param authDataSubscribers  the auth data subscribers\n     */\n    public WebsocketSyncDataService(final WebsocketConfig websocketConfig,\n                                    final PluginDataSubscriber pluginDataSubscriber,\n                                    final List<MetaDataSubscriber> metaDataSubscribers,\n                                    final List<AuthDataSubscriber> authDataSubscribers) {\n        // If there are multiple synchronization addresses on the admin side, use commas (,) to separate them\n        String[] urls = StringUtils.split(websocketConfig.getUrls(), ",");\n        // Create a scheduling thread pool, one for each admin\n        executor = new ScheduledThreadPoolExecutor(urls.length, ShenyuThreadFactory.create("websocket-connect", true));\n        for (String url : urls) {\n            try {\n                //Create a WebsocketClient and assign one to each admin\n                clients.add(new ShenyuWebsocketClient(new URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));\n            } catch (URISyntaxException e) {\n                log.error("websocket url({}) is error", url, e);\n            }\n        }\n        try {\n            for (WebSocketClient client : clients) {\n                // Establish a connection with the WebSocket Server\n                boolean success = client.connectBlocking(3000, TimeUnit.MILLISECONDS);\n                if (success) {\n                    log.info("websocket connection is successful.....");\n                } else {\n                    log.error("websocket connection is error.....");\n                }\n\n                // Run a scheduled task every 10 seconds\n                // The main function is to check whether the WebSocket connection is disconnected. If the connection is disconnected, retry the connection.\n                // If it is not disconnected, the ping-pong test is performed\n                executor.scheduleAtFixedRate(() -> {\n                    try {\n                        if (client.isClosed()) {\n                            boolean reconnectSuccess = client.reconnectBlocking();\n                            if (reconnectSuccess) {\n                                log.info("websocket reconnect server[{}] is successful.....", client.getURI().toString());\n                            } else {\n                                log.error("websocket reconnection server[{}] is error.....", client.getURI().toString());\n                            }\n                        } else {\n                            client.sendPing();\n                            log.debug("websocket send to [{}] ping message successful", client.getURI().toString());\n                        }\n                    } catch (InterruptedException e) {\n                        log.error("websocket connect is error :{}", e.getMessage());\n                    }\n                }, 10, 10, TimeUnit.SECONDS);\n            }\n            /* client.setProxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress("proxyaddress", 80)));*/\n        } catch (InterruptedException e) {\n            log.info("websocket connection...exception....", e);\n        }\n\n    }\n\n    @Override\n    public void close() {\n        // close websocket client\n        for (WebSocketClient client : clients) {\n            if (!client.isClosed()) {\n                client.close();\n            }\n        }\n        // close threadpool\n        if (Objects.nonNull(executor)) {\n            executor.shutdown();\n        }\n    }\n}\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"ShenyuWebsocketClient")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"WebSocket")," client created in ",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu")," to communicate with the ",(0,i.kt)("inlineCode",{parentName:"p"},"admin")," side. After the connection is successfully established for the first time, full data is synchronized and incremental data is subsequently synchronized."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'\n/**\n * The type shenyu websocket client.\n */\n@Slf4j\npublic final class ShenyuWebsocketClient extends WebSocketClient {\n    \n    private volatile boolean alreadySync = Boolean.FALSE;\n    \n    private final WebsocketDataHandler websocketDataHandler;\n    \n    /**\n     * Instantiates a new shenyu websocket client.\n     * @param serverUri             the server uri  \n     * @param pluginDataSubscriber the plugin data subscriber \n     * @param metaDataSubscribers   the meta data subscribers \n     * @param authDataSubscribers   the auth data subscribers \n     */\n    public ShenyuWebsocketClient(final URI serverUri, final PluginDataSubscriber pluginDataSubscriber,final List<MetaDataSubscriber> metaDataSubscribers, final List<AuthDataSubscriber> authDataSubscribers) {\n        super(serverUri);\n        this.websocketDataHandler = new WebsocketDataHandler(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);\n    }\n\n    // Execute after the connection is successfully established\n    @Override\n    public void onOpen(final ServerHandshake serverHandshake) {\n        // To prevent re-execution when reconnecting, use alreadySync to determine\n        if (!alreadySync) {\n            // Synchronize all data, type MYSELF\n            send(DataEventTypeEnum.MYSELF.name());\n            alreadySync = true;\n        }\n    }\n\n    // Execute after receiving the message\n    @Override\n    public void onMessage(final String result) {\n        // handle data\n        handleResult(result);\n    }\n    \n    // Execute after shutdown\n    @Override\n    public void onClose(final int i, final String s, final boolean b) {\n        this.close();\n    }\n    \n    // Execute after error\n    @Override\n    public void onError(final Exception e) {\n        this.close();\n    }\n    \n    @SuppressWarnings("ALL")\n    private void handleResult(final String result) {\n        // Data deserialization\n        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);\n        // Which data types, plugins, selectors, rules...\n        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());\n        // Which operation type, update, delete...\n        String eventType = websocketData.getEventType();\n        String json = GsonUtils.getInstance().toJson(websocketData.getData());\n\n        // handle data\n        websocketDataHandler.executor(groupEnum, json, eventType);\n    }\n}\n\n')),(0,i.kt)("h3",{id:"5-summary"},"5. Summary"),(0,i.kt)("p",null,"This paper through a practical case, the data synchronization principle of websocket source code analysis. The main knowledge points involved are as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"WebSocket")," supports bidirectional communication and has good performance. It is recommended.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Complete event publishing and listening via ",(0,i.kt)("inlineCode",{parentName:"p"},"Spring"),";")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Support multiple synchronization strategies through abstract ",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedListener")," interface, interface oriented programming;")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Use factory mode to create ",(0,i.kt)("inlineCode",{parentName:"p"},"WebsocketDataHandler")," to handle different data types;")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Implement ",(0,i.kt)("inlineCode",{parentName:"p"},"AbstractDataHandler")," using template method design patterns to handle general operation types;")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Use singleton design pattern to cache data class ",(0,i.kt)("inlineCode",{parentName:"p"},"BaseDataCache"),";")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Loading of configuration classes via conditional assembly of SpringBoot and starter loading mechanism."))))}d.isMDXComponent=!0},51180:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/add-selector-93ff1008c1b0b4627dd3329abc92a7bd.png"},74907:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"},33965:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/data-handler-313ae788eadfdabf405cdc55c74dbb21.png"},38982:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"},95431:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/websocket-data-sync-admin-en-e19e1829e21c675463bd2df0e79528fa.png"},8886:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/websocket-data-sync-gateway-en-3703ea52c109a681e970cbf79108280d.png"},31772:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/websocket-springboot-starter-2cfd149ba2fb69ab514241e061fc22c9.png"}}]);