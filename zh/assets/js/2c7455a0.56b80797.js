"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[73038],{2572(e,n,t){t.d(n,{A:()=>a});const a=t.p+"assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"},16658(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>o});var a=t(39980),i=t(74848),l=t(28453);const r={title:"ZooKeeper\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790",author:"midnight2104",author_title:"Apache ShenYu Committer",author_url:"https://github.com/midnight2104",tags:["zookeeper","data sync","Apache ShenYu"]},s=void 0,c={authorsImageUrls:[void 0]},o=[{value:"1. \u5173\u4e8eZooKeeper",id:"1-\u5173\u4e8ezookeeper",level:3},{value:"2. Admin\u6570\u636e\u540c\u6b65",id:"2-admin\u6570\u636e\u540c\u6b65",level:3},{value:"2.1 \u63a5\u6536\u6570\u636e",id:"21-\u63a5\u6536\u6570\u636e",level:4},{value:"2.2 \u5904\u7406\u6570\u636e",id:"22-\u5904\u7406\u6570\u636e",level:4},{value:"2.3 \u5206\u53d1\u6570\u636e",id:"23-\u5206\u53d1\u6570\u636e",level:4},{value:"2.4 Zookeeper\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668",id:"24-zookeeper\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668",level:4},{value:"3. \u7f51\u5173\u6570\u636e\u540c\u6b65",id:"3-\u7f51\u5173\u6570\u636e\u540c\u6b65",level:3},{value:"3.1 ZkClient\u63a5\u6536\u6570\u636e",id:"31-zkclient\u63a5\u6536\u6570\u636e",level:4},{value:"3.2 \u5904\u7406\u6570\u636e",id:"32-\u5904\u7406\u6570\u636e",level:4},{value:"3.3 \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005",id:"33-\u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005",level:4},{value:"3.4 \u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58",id:"34-\u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58",level:4},{value:"4. Admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316",id:"4-admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316",level:3},{value:"5. \u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316",id:"5-\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316",level:3},{value:"6. \u603b\u7ed3",id:"6-\u603b\u7ed3",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/zh/docs/index",children:"Apache ShenYu"})," \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 ",(0,i.jsx)(n.code,{children:"API"})," \u7f51\u5173\u3002"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002",(0,i.jsx)(n.code,{children:"Apache ShenYu"})," \u7f51\u5173\u5f53\u524d\u652f\u6301",(0,i.jsx)(n.code,{children:"ZooKeeper"}),"\u3001",(0,i.jsx)(n.code,{children:"WebSocket"}),"\u3001",(0,i.jsx)(n.code,{children:"Http\u957f\u8f6e\u8be2"}),"\u3001",(0,i.jsx)(n.code,{children:"Nacos"})," \u3001",(0,i.jsx)(n.code,{children:"Etcd"})," \u548c ",(0,i.jsx)(n.code,{children:"Consul"})," \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"ZooKeeper"}),"\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\u672c\u6587\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"shenyu-2.4.0"}),"\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 ",(0,i.jsx)(n.a,{href:"https://shenyu.apache.org/zh/docs/design/data-sync",children:"\u6570\u636e\u540c\u6b65\u539f\u7406"})," \u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"1-\u5173\u4e8ezookeeper",children:"1. \u5173\u4e8eZooKeeper"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://zh.wikipedia.org/wiki/Apache_ZooKeeper",children:(0,i.jsx)(n.code,{children:"Apache ZooKeeper"})}),"\u662f",(0,i.jsx)(n.code,{children:"Apache"}),"\u8f6f\u4ef6\u57fa\u91d1\u4f1a\u7684\u4e00\u4e2a\u8f6f\u4ef6\u9879\u76ee\uff0c\u5b83\u4e3a\u5927\u578b\u5206\u5e03\u5f0f\u8ba1\u7b97\u63d0\u4f9b\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u914d\u7f6e\u670d\u52a1\u3001\u540c\u6b65\u670d\u52a1\u548c\u547d\u540d\u6ce8\u518c\u3002",(0,i.jsx)(n.code,{children:"ZooKeeper"}),"\u8282\u70b9\u5c06\u5b83\u4eec\u7684\u6570\u636e\u5b58\u50a8\u4e8e\u4e00\u4e2a\u5206\u5c42\u7684\u540d\u5b57\u7a7a\u95f4\uff0c\u975e\u5e38\u7c7b\u4f3c\u4e8e\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u6216\u4e00\u4e2a\u524d\u7f00\u6811\u7ed3\u6784\u3002\u5ba2\u6237\u7aef\u53ef\u4ee5\u5728\u8282\u70b9\u8bfb\u5199\uff0c\u4ece\u800c\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u62e5\u6709\u4e00\u4e2a\u5171\u4eab\u7684\u914d\u7f6e\u670d\u52a1\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"2-admin\u6570\u636e\u540c\u6b65",children:"2. Admin\u6570\u636e\u540c\u6b65"}),"\n",(0,i.jsxs)(n.p,{children:["\u6211\u4eec\u4ece\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\u8fdb\u884c\u6e90\u7801\u8ffd\u8e2a\uff0c\u6bd4\u5982\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u5bf9",(0,i.jsx)(n.code,{children:"Divide"}),"\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff1a"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(96368).A+"",width:"2385",height:"1185"})}),"\n",(0,i.jsx)(n.h4,{id:"21-\u63a5\u6536\u6570\u636e",children:"2.1 \u63a5\u6536\u6570\u636e"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"SelectorController.createSelector()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u8fdb\u5165",(0,i.jsx)(n.code,{children:"SelectorController"}),"\u7c7b\u4e2d\u7684",(0,i.jsx)(n.code,{children:"updateSelector()"}),"\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Validated\n@RequiredArgsConstructor\n@RestController\n@RequestMapping("/selector")\npublic class SelectorController {\n    \n    @PutMapping("/{id}")\n    public ShenyuAdminResult updateSelector(@PathVariable("id") final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {\n        // \u8bbe\u7f6e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636eid\n        selectorDTO.setId(id);\n        // \u521b\u5efa\u6216\u66f4\u65b0\u64cd\u4f5c\n        Integer updateCount = selectorService.createOrUpdate(selectorDTO);\n        // \u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\n        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);\n    }\n    \n    // ......\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"22-\u5904\u7406\u6570\u636e",children:"2.2 \u5904\u7406\u6570\u636e"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"SelectorServiceImpl.createOrUpdate()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"SelectorServiceImpl"}),"\u7c7b\u4e2d\u901a\u8fc7",(0,i.jsx)(n.code,{children:"createOrUpdate()"}),"\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u66f4\u65b0",(0,i.jsx)(n.code,{children:"upstream"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@RequiredArgsConstructor\n@Service\npublic class SelectorServiceImpl implements SelectorService {\n    // \u8d1f\u8d23\u4e8b\u4ef6\u53d1\u5e03\u7684eventPublisher\n    private final ApplicationEventPublisher eventPublisher;\n    \n    @Override\n    @Transactional(rollbackFor = Exception.class)\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\n        int selectorCount;\n        // \u6784\u5efa\u6570\u636e DTO --\x3e DO\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\n        // \u5224\u65ad\u662f\u6dfb\u52a0\u8fd8\u662f\u66f4\u65b0\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\n            // \u63d2\u5165\u9009\u62e9\u5668\u6570\u636e\n            selectorCount = selectorMapper.insertSelective(selectorDO);\n            // \u63d2\u5165\u9009\u62e9\u5668\u4e2d\u7684\u6761\u4ef6\u6570\u636e\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\n            });\n            // check selector add\n            // \u6743\u9650\u68c0\u67e5\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\n                dataPermissionDTO.setDataId(selectorDO.getId());\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\n            }\n\n        } else {\n            // \u66f4\u65b0\u6570\u636e\uff0c\u5148\u5220\u9664\u518d\u65b0\u589e\n            selectorCount = selectorMapper.updateSelective(selectorDO);\n            //delete rule condition then add\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\n                selectorConditionMapper.insertSelective(selectorConditionDO);\n            });\n        }\n        // \u53d1\u5e03\u4e8b\u4ef6\n        publishEvent(selectorDO, selectorConditionDTOs);\n\n        // \u66f4\u65b0upstream\n        updateDivideUpstream(selectorDO);\n        return selectorCount;\n    }\n    \n    \n    // ......\n    \n}\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"Serrvice"}),"\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u6df1\u5165\u8ffd\u8e2a\u4e86\u3002\u5173\u4e8e\u66f4\u65b0",(0,i.jsx)(n.code,{children:"upstream"}),"\u64cd\u4f5c\uff0c\u653e\u5230\u540e\u9762\u5bf9\u5e94\u7684\u7ae0\u8282\u4e2d\u8fdb\u884c\u5206\u6790\uff0c\u91cd\u70b9\u5173\u6ce8\u53d1\u5e03\u4e8b\u4ef6\u7684\u64cd\u4f5c\uff0c\u5b83\u4f1a\u6267\u884c\u6570\u636e\u540c\u6b65\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"publishEvent()"}),"\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u6784\u5efa\u6761\u4ef6\u6570\u636e\uff0c\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"       private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\n        // \u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\n        // \u6784\u5efa\u6761\u4ef6\u6570\u636e\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\n        // \u53d1\u5e03\u53d8\u66f4\u6570\u636e\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\n    }\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7",(0,i.jsx)(n.code,{children:"eventPublisher.publishEvent()"}),"\u5b8c\u6210\uff0c\u8fd9\u4e2a",(0,i.jsx)(n.code,{children:"eventPublisher"}),"\u5bf9\u8c61\u662f\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"ApplicationEventPublisher"}),"\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f",(0,i.jsx)(n.code,{children:"org.springframework.context.ApplicationEventPublisher"}),"\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7",(0,i.jsx)(n.code,{children:"Spring"}),"\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\u5173\u4e8e",(0,i.jsx)(n.code,{children:"ApplicationEventPublisher"}),"\uff1a"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"ApplicationEventPublisher"})," \u7684 ",(0,i.jsx)(n.code,{children:"publishEvent"})," \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c",(0,i.jsx)(n.code,{children:"Spring"}),"\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 ",(0,i.jsx)(n.code,{children:"onApplicationEvent"})," \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"publishEvent"}),"\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 ",(0,i.jsx)(n.code,{children:"ApplicationEventPublisher"})," \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ApplicationEventPublisher"}),"\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ApplicationEvent"}),"\uff1a",(0,i.jsx)(n.code,{children:"Spring"})," \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ApplicationListener"}),"\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\uff1b"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"Spring"}),"\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c"]}),"\n",(0,i.jsxs)(n.p,{children:["\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684",(0,i.jsx)(n.code,{children:"ApplicationEventPublisher"}),"\uff0c\u5728",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"eventPublisher"}),"\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f",(0,i.jsx)(n.code,{children:"ApplicationEvent"}),"\uff0c\u5728",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u4e2d\u901a\u8fc7",(0,i.jsx)(n.code,{children:"DataChangedEvent"}),"\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class DataChangedEvent extends ApplicationEvent {\n//......\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u6700\u540e\u4e00\u4e2a\u662f ",(0,i.jsx)(n.code,{children:"ApplicationListener"}),"\uff0c\u5728",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u4e2d\u901a\u8fc7",(0,i.jsx)(n.code,{children:"DataChangedEventDispatcher"}),"\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n    //......\n    \n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"23-\u5206\u53d1\u6570\u636e",children:"2.3 \u5206\u53d1\u6570\u636e"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"DataChangedEventDispatcher.onApplicationEvent()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230",(0,i.jsx)(n.code,{children:"DataChangedEventDispatcher"}),"\u7c7b\u4e2d\u7684",(0,i.jsx)(n.code,{children:"onApplicationEvent()"}),"\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n  /**\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\n     * @param event\n     */\n    @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\n        for (DataChangedListener listener : listeners) {\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\n            switch (event.getGroupKey()) {\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\n                    break;\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\n                    break;\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\n                    break;\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\n                    break;\n                case META_DATA:  // \u5143\u6570\u636e\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\n                    break;\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\n                    throw new IllegalStateException("Unexpected value: " + event.getGroupKey());\n            }\n        }\n    }\n    \n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528",(0,i.jsx)(n.code,{children:"onApplicationEvent"}),"\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ShenYu"}),"\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u662f\u4e94\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u548c\u5143\u6570\u636e\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08",(0,i.jsx)(n.code,{children:"DataChangedListener"}),"\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u5b83\u7684\u5177\u4f53\u5b9e\u73b0\u6709\uff1a"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(2572).A+"",width:"1966",height:"482"})}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd9\u51e0\u4e2a\u5b9e\u73b0\u7c7b\u5c31\u662f\u5f53\u524d",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u652f\u6301\u7684\u540c\u6b65\u7b56\u7565\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"WebsocketDataChangedListener"}),"\uff1a\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"websocket"}),"\u7684\u6570\u636e\u540c\u6b65\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ZookeeperDataChangedListener"}),"\uff1a\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"zookeeper"}),"\u7684\u6570\u636e\u540c\u6b65\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ConsulDataChangedListener"}),"\uff1a\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"consul"}),"\u7684\u6570\u636e\u540c\u6b65\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EtcdDataDataChangedListener"}),"\uff1a\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"etcd"}),"\u7684\u6570\u636e\u540c\u6b65\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"HttpLongPollingDataChangedListener"}),"\uff1a\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"http\u957f\u8f6e\u8be2"}),"\u7684\u6570\u636e\u540c\u6b65\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"NacosDataChangedListener"}),"\uff1a\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"nacos"}),"\u7684\u6570\u636e\u540c\u6b65\uff1b"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u65e2\u7136\u6709\u8fd9\u4e48\u591a\u79cd\u5b9e\u73b0\u7b56\u7565\uff0c\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u5462\uff1f"}),"\n",(0,i.jsxs)(n.p,{children:["\u56e0\u4e3a\u672c\u6587\u662f\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"Zookeeper"}),"\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ee5",(0,i.jsx)(n.code,{children:"ZookeeperDataChangedListener"}),"\u4e3a\u4f8b\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u88ab\u52a0\u8f7d\u5e76\u5b9e\u73b0\u7684\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u901a\u8fc7\u5728\u6e90\u7801\u5de5\u7a0b\u4e2d\u8fdb\u884c\u5168\u5c40\u641c\u7d22\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u7684\u5b9e\u73b0\u662f\u5728",(0,i.jsx)(n.code,{children:"DataSyncConfiguration"}),"\u7c7b\u5b8c\u6210\u7684\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'/**\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\n * The type Data sync configuration.\n */\n@Configuration\npublic class DataSyncConfiguration {\n    \n    \n    /**\n     * zookeeper\u6570\u636e\u540c\u6b65\n     * The type Zookeeper listener.\n     */\n    @Configuration\n    @ConditionalOnProperty(prefix = "shenyu.sync.zookeeper", name = "url")  // \u6761\u4ef6\u5c5e\u6027\uff0c\u6ee1\u8db3\u624d\u4f1a\u88ab\u52a0\u8f7d\n    @Import(ZookeeperConfiguration.class)\n    static class ZookeeperListener {\n\n        /**\n         * Config event listener data changed listener.\n         * \u521b\u5efaZookeeper\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\n         * @param zkClient the zk client\n         * @return the data changed listener\n         */\n        @Bean\n        @ConditionalOnMissingBean(ZookeeperDataChangedListener.class)\n        public DataChangedListener zookeeperDataChangedListener(final ZkClient zkClient) {\n            return new ZookeeperDataChangedListener(zkClient);\n        }\n\n        /**\n         * Zookeeper data init zookeeper data init.\n         *  \u521b\u5efa Zookeeper \u6570\u636e\u521d\u59cb\u5316\u7c7b\n         * @param zkClient        the zk client\n         * @param syncDataService the sync data service\n         * @return the zookeeper data init\n         */\n        @Bean\n        @ConditionalOnMissingBean(ZookeeperDataInit.class)\n        public ZookeeperDataInit zookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {\n            return new ZookeeperDataInit(zkClient, syncDataService);\n        }\n    }\n    \n    //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\n}\n\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u662f\u901a\u8fc7",(0,i.jsx)(n.code,{children:"SpringBoot"}),"\u6761\u4ef6\u88c5\u914d\u7c7b\u5b9e\u73b0\u7684\u3002\u5728",(0,i.jsx)(n.code,{children:"ZookeeperListener"}),"\u7c7b\u4e0a\u9762\u6709\u51e0\u4e2a\u6ce8\u89e3\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"@Configuration"}),"\uff1a\u914d\u7f6e\u6587\u4ef6\uff0c\u5e94\u7528\u4e0a\u4e0b\u6587\uff1b"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:'@ConditionalOnProperty(prefix = "shenyu.sync.zookeeper", name = "url")'}),"\uff1a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u91c7\u7528",(0,i.jsx)(n.code,{children:"zookeeper"}),"\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-properties",children:"shenyu:  \n  sync:\n     zookeeper:\n          url: localhost:2181\n          sessionTimeout: 5000\n          connectionTimeout: 2000\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"@Import(ZookeeperConfiguration.class)"}),"\uff1a\u5bfc\u5165\u53e6\u4e00\u4e2a\u7c7b",(0,i.jsx)(n.code,{children:"ZookeeperConfiguration"}),"\uff1b"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"  @EnableConfigurationProperties(ZookeeperProperties.class)  // \u542f\u7528zk\u5c5e\u6027\u914d\u7f6e\u7c7b\n  public class ZookeeperConfiguration {\n\n    /**\n     * register zkClient in spring ioc.\n     * \u5411 Spring IOC \u5bb9\u5668\u6ce8\u518c zkClient\n     * @param zookeeperProp the zookeeper configuration\n     * @return ZkClient {@linkplain ZkClient}\n        */\n      @Bean\n      @ConditionalOnMissingBean(ZkClient.class)\n      public ZkClient zkClient(final ZookeeperProperties zookeeperProp) {\n        return new ZkClient(zookeeperProp.getUrl(), zookeeperProp.getSessionTimeout(), zookeeperProp.getConnectionTimeout()); // \u8bfb\u53d6zk\u914d\u7f6e\u4fe1\u606f\uff0c\u5e76\u521b\u5efazkClient\n      }\n  }\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Data\n@ConfigurationProperties(prefix = "shenyu.sync.zookeeper") // zk\u5c5e\u6027\u914d\u7f6e\npublic class ZookeeperProperties {\n\n    private String url;\n\n    private Integer sessionTimeout;\n\n    private Integer connectionTimeout;\n\n    private String serializer;\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u5f53\u6211\u4eec\u4e3b\u52a8\u914d\u7f6e\uff0c\u91c7\u7528",(0,i.jsx)(n.code,{children:"zookeeper"}),"\u8fdb\u884c\u6570\u636e\u540c\u6b65\u65f6\uff0c",(0,i.jsx)(n.code,{children:"zookeeperDataChangedListener"}),"\u5c31\u4f1a\u751f\u6210\u3002\u6240\u4ee5\u5728\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5",(0,i.jsx)(n.code,{children:"onApplicationEvent()"}),"\u4e2d\uff0c\u5c31\u4f1a\u5230\u76f8\u5e94\u7684",(0,i.jsx)(n.code,{children:"listener"}),"\u4e2d\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u662f\u5bf9\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u6570\u636e\u540c\u6b65\u91c7\u7528\u7684\u662f",(0,i.jsx)(n.code,{children:"zookeeper"}),"\uff0c\u6240\u4ee5\uff0c\u4ee3\u7801\u4f1a\u8fdb\u5165\u5230",(0,i.jsx)(n.code,{children:"ZookeeperDataChangedListener"}),"\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'    @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\n        for (DataChangedListener listener : listeners) {\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\n            switch (event.getGroupKey()) {\n                    \n                // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\n                    \n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // \u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u4f1a\u8fdb\u5165\u5230ZookeeperDataChangedListener\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\n                    break;\n         }\n    }\n'})}),"\n",(0,i.jsx)(n.h4,{id:"24-zookeeper\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668",children:"2.4 Zookeeper\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"ZookeeperDataChangedListener.onSelectorChanged()"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"onSelectorChanged()"}),"\u65b9\u6cd5\u4e2d\uff0c\u5224\u65ad\u64cd\u4f5c\u7c7b\u578b\uff0c\u662f\u5237\u65b0\u540c\u6b65\u8fd8\u662f\u66f4\u65b0\u6216\u521b\u5efa\u540c\u6b65\u3002\u6839\u636e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636e\u4fe1\u606f\u5224\u65ad\u8282\u70b9\u662f\u5426\u5728",(0,i.jsx)(n.code,{children:"zk"}),"\u4e2d\u3002"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'\n/**\n * \u4f7f\u7528 zookeeper \u53d1\u5e03\u53d8\u66f4\u6570\u636e\n */\npublic class ZookeeperDataChangedListener implements DataChangedListener {\n    \n    // \u9009\u62e9\u5668\u4fe1\u606f\u53d1\u751f\u6539\u53d8\n    @Override\n    public void onSelectorChanged(final List<SelectorData> changed, final DataEventTypeEnum eventType) {\n        // \u5237\u65b0\u64cd\u4f5c\n        if (eventType == DataEventTypeEnum.REFRESH && !changed.isEmpty()) {\n            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());\n            deleteZkPathRecursive(selectorParentPath);\n        }\n        // \u53d1\u751f\u53d8\u66f4\u7684\u6570\u636e\n        for (SelectorData data : changed) {\n            // \u6784\u5efa\u9009\u62e9\u5668\u6570\u636e\u7684\u771f\u5b9e\u8def\u5f84\n            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());\n            // \u5982\u679c\u662f\u5220\u9664\u64cd\u4f5c\n            if (eventType == DataEventTypeEnum.DELETE) {\n                // \u5220\u9664\u5f53\u524d\u6570\u636e\n                deleteZkPath(selectorRealPath);\n                continue;\n            }\n            // \u7236\u8282\u70b9\u8def\u5f84\n            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(data.getPluginName());\n            // \u521b\u5efa\u7236\u8282\u70b9\n            createZkNode(selectorParentPath);\n            // \u63d2\u5165\u6216\u66f4\u65b0\u6570\u636e\n            insertZkNode(selectorRealPath, data);\n        }\n    }\n\n\t// \u521b\u5efa zk \u8282\u70b9\n    private void createZkNode(final String path) {\n        // \u4e0d\u5b58\u5728\u624d\u521b\u5efa\n        if (!zkClient.exists(path)) {\n            zkClient.createPersistent(path, true);\n        }\n    }\n\n    // \u63d2\u5165zk\u8282\u70b9\n    private void insertZkNode(final String path, final Object data) {\n        // \u521b\u5efa\u8282\u70b9\n        createZkNode(path);\n        // \u901a\u8fc7 zkClient \u5199\u5165\u6570\u636e\n        zkClient.writeData(path, null == data ? "" : GsonUtils.getInstance().toJson(data));\n    }\n    \n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u53ea\u8981\u5c06\u53d8\u52a8\u7684\u6570\u636e\u6b63\u786e\u5199\u5165\u5230",(0,i.jsx)(n.code,{children:"zk"}),"\u7684\u8282\u70b9\u4e0a\uff0c",(0,i.jsx)(n.code,{children:"admin"}),"\u8fd9\u8fb9\u7684\u64cd\u4f5c\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u5728\u4f7f\u7528",(0,i.jsx)(n.code,{children:"zk"}),"\u8fdb\u884c\u6570\u636e\u540c\u6b65\u65f6\uff0c",(0,i.jsx)(n.code,{children:"zk"}),"\u7684\u8282\u70b9\u662f\u901a\u8fc7\u7cbe\u5fc3\u8bbe\u8ba1\u7684\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728\u6211\u4eec\u5f53\u524d\u7684\u6848\u4f8b\u4e2d\uff0c\u5bf9",(0,i.jsx)(n.code,{children:"Divide"}),"\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff0c\u5c31\u4f1a\u5bf9\u56fe\u4e2d\u7684\u7279\u5b9a\u8282\u70b9\u66f4\u65b0\u3002"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(86305).A+"",width:"1704",height:"1140"})}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u4eec\u7528\u65f6\u5e8f\u56fe\u5c06\u4e0a\u9762\u7684\u66f4\u65b0\u6d41\u7a0b\u4e32\u8054\u8d77\u6765\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(89452).A+"",width:"2401",height:"880"})}),"\n",(0,i.jsx)(n.h3,{id:"3-\u7f51\u5173\u6570\u636e\u540c\u6b65",children:"3. \u7f51\u5173\u6570\u636e\u540c\u6b65"}),"\n",(0,i.jsxs)(n.p,{children:["\u5047\u8bbe",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u7f51\u5173\u5df2\u7ecf\u5728\u6b63\u5e38\u8fd0\u884c\uff0c\u4f7f\u7528\u7684\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e5f\u662f",(0,i.jsx)(n.code,{children:"zookeeper"}),"\u3002\u90a3\u4e48\u5f53\u5728",(0,i.jsx)(n.code,{children:"admin"}),"\u7aef\u66f4\u65b0\u9009\u62e9\u5668\u6570\u636e\u540e\uff0c\u5e76\u4e14\u5411",(0,i.jsx)(n.code,{children:"zk"}),"\u53d1\u9001\u4e86\u53d8\u66f4\u7684\u6570\u636e\uff0c\u90a3\u7f51\u5173\u662f\u5982\u4f55\u63a5\u6536\u5e76\u5904\u7406\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7ee7\u7eed\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u4e00\u63a2\u7a76\u7adf\u3002"]}),"\n",(0,i.jsx)(n.h4,{id:"31-zkclient\u63a5\u6536\u6570\u636e",children:"3.1 ZkClient\u63a5\u6536\u6570\u636e"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ZkClient.subscribeDataChanges()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728\u7f51\u5173\u7aef\u6709\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"ZookeeperSyncDataService"}),"\u7c7b\uff0c\u5b83\u901a\u8fc7",(0,i.jsx)(n.code,{children:"ZkClient"}),"\u8ba2\u9605\u4e86\u6570\u636e\u8282\u70b9\uff0c\u5f53\u6570\u636e\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u53ef\u4ee5\u611f\u77e5\u5230\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"/**\n * \u4f7f\u7528 zookeeper \u7f13\u5b58\u6570\u636e\n */\npublic class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {\n    \nprivate void subscribeSelectorDataChanges(final String path) {\n       // zkClient\u8ba2\u9605\u6570\u636e\u8282\u70b9\n        zkClient.subscribeDataChanges(path, new IZkDataListener() {\n            @Override\n            public void handleDataChange(final String dataPath, final Object data) {\n                cacheSelectorData(GsonUtils.getInstance().fromJson(data.toString(), SelectorData.class)); // \u8282\u70b9\u6570\u636e\u88ab\u66f4\u65b0\n            }\n\n            @Override\n            public void handleDataDeleted(final String dataPath) {\n                unCacheSelectorData(dataPath);  // \u8282\u70b9\u6570\u636e\u88ab\u5220\u9664\n            }\n        });\n    }\n \n    // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ZooKeeper"}),"\u7684",(0,i.jsx)(n.code,{children:"Watch"}),"\u673a\u5236\uff0c\u4f1a\u7ed9\u8ba2\u9605\u7684\u5ba2\u6237\u7aef\u53d1\u9001\u8282\u70b9\u53d8\u66f4\u901a\u77e5\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u66f4\u65b0\u9009\u62e9\u5668\u4fe1\u606f\uff0c\u5c31\u4f1a\u8fdb\u5165\u5230",(0,i.jsx)(n.code,{children:"handleDataChange()"}),"\u65b9\u6cd5\u3002\u901a\u8fc7",(0,i.jsx)(n.code,{children:"cacheSelectorData()"}),"\u53bb\u5904\u7406\u6570\u636e\u3002"]}),"\n",(0,i.jsx)(n.h4,{id:"32-\u5904\u7406\u6570\u636e",children:"3.2 \u5904\u7406\u6570\u636e"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ZookeeperSyncDataService.cacheSelectorData()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u7ecf\u8fc7\u5224\u7a7a\u903b\u8f91\u4e4b\u540e\uff0c\u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684\u64cd\u4f5c\u53c8\u4ea4\u7ed9\u4e86",(0,i.jsx)(n.code,{children:"PluginDataSubscriber"}),"\u5904\u7406\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"    private void cacheSelectorData(final SelectorData selectorData) {\n        Optional.ofNullable(selectorData)\n                .ifPresent(data -> Optional.ofNullable(pluginDataSubscriber).ifPresent(e -> e.onSelectorSubscribe(data)));\n    }\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"PluginDataSubscriber"}),"\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b83\u53ea\u6709\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"CommonPluginDataSubscriber"}),"\u5b9e\u73b0\u7c7b\uff0c\u8d1f\u8d23\u5904\u7406\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\u3002"]}),"\n",(0,i.jsx)(n.h4,{id:"33-\u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005",children:"3.3 \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"PluginDataSubscriber.onSelectorSubscribe()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5b83\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528",(0,i.jsx)(n.code,{children:"subscribeDataHandler()"}),"\u65b9\u6cd5\u3002\u5728\u65b9\u6cd5\u4e2d\uff0c\u66f4\u5177\u6570\u636e\u7c7b\u578b\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u6216\u89c4\u5219\uff09\uff0c\u64cd\u4f5c\u7c7b\u578b\uff08\u66f4\u65b0\u6216\u5220\u9664\uff09\uff0c\u53bb\u6267\u884c\u4e0d\u540c\u903b\u8f91\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"/**\n * \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\n * The type Common plugin data subscriber.\n */\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\n    //......\n     // \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\n    @Override\n    public void onSelectorSubscribe(final SelectorData selectorData) {\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\n    }    \n    \n    // \u8ba2\u9605\u6570\u636e\u5904\u7406\u5668\uff0c\u5904\u7406\u6570\u636e\u7684\u66f4\u65b0\u6216\u5220\u9664\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\n        Optional.ofNullable(classData).ifPresent(data -> {\n            // \u63d2\u4ef6\u6570\u636e\n            if (data instanceof PluginData) {\n                PluginData pluginData = (PluginData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cachePluginData(pluginData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removePluginData(pluginData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\n                }\n            } else if (data instanceof SelectorData) {  // \u9009\u62e9\u5668\u6570\u636e\n                SelectorData selectorData = (SelectorData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\n                }\n            } else if (data instanceof RuleData) {  // \u89c4\u5219\u6570\u636e\n                RuleData ruleData = (RuleData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\n                } else if (dataType == DataEventTypeEnum.DELETE) { // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\n                }\n            }\n        });\n    }\n    \n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"34-\u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58",children:"3.4 \u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58"}),"\n",(0,i.jsx)(n.p,{children:"\u90a3\u4e48\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684\u903b\u8f91\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"// \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\nBaseDataCache.getInstance().cacheSelectData(selectorData);\n// \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    \nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u4e00\u662f\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u7684\u5185\u5b58\u4e2d\u3002",(0,i.jsx)(n.code,{children:"BaseDataCache"}),"\u662f\u6700\u7ec8\u7f13\u5b58\u6570\u636e\u7684\u7c7b\uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\u3002\u9009\u62e9\u5668\u6570\u636e\u5c31\u5b58\u5230\u4e86",(0,i.jsx)(n.code,{children:"SELECTOR_MAP"}),"\u8fd9\u4e2a",(0,i.jsx)(n.code,{children:"Map"}),"\u4e2d\u3002\u5728\u540e\u7eed\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e5f\u662f\u4ece\u8fd9\u91cc\u62ff\u6570\u636e\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public final class BaseDataCache {\n    // \u79c1\u6709\u53d8\u91cf\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\n  \t// \u79c1\u6709\u6784\u9020\u5668\n    private BaseDataCache() {\n    }\n    \n    /**\n     * Gets instance.\n     *  \u516c\u5f00\u65b9\u6cd5\n     * @return the instance\n     */\n    public static BaseDataCache getInstance() {\n        return INSTANCE;\n    }\n    \n    /**\n    *  \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684Map\n     * pluginName -> SelectorData.\n     */\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\n    \n    public void cacheSelectData(final SelectorData selectorData) {\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\n    }\n        \n   /**\n     * cache selector data.\n     * \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\n     * @param data the selector data\n     */\n    private void selectorAccept(final SelectorData data) {\n        String key = data.getPluginName();\n        if (SELECTOR_MAP.containsKey(key)) { // \u66f4\u65b0\u64cd\u4f5c\uff0c\u5148\u5220\u9664\u518d\u63d2\u5165\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\n            resultList.add(data);\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\n            SELECTOR_MAP.put(key, collect);\n        } else {  // \u65b0\u589e\u64cd\u4f5c\uff0c\u76f4\u63a5\u653e\u5230Map\u4e2d\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\n        }\n    }\n    \n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u4e8c\u662f\u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\u3002  \u901a\u8fc7",(0,i.jsx)(n.code,{children:"idea"}),"\u7f16\u8f91\u5668\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u540e\uff0c\u6709\u5982\u4e0b\u7684\u63d2\u4ef6\u8fd8\u6709\u5904\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u5c55\u5f00\u4e86\u3002"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(19972).A+"",width:"2456",height:"617"})}),"\n",(0,i.jsxs)(n.p,{children:["\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u6e90\u7801\u8ffd\u8e2a\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\uff0c\u5728",(0,i.jsx)(n.code,{children:"admin"}),"\u7aef\u65b0\u589e\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u5c31\u5c06",(0,i.jsx)(n.code,{children:"zookeeper"}),"\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5206\u6790\u6e05\u695a\u4e86\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u4eec\u8fd8\u662f\u901a\u8fc7\u65f6\u5e8f\u56fe\u5c06\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u6d41\u7a0b\u4e32\u8054\u4e00\u4e0b\uff1a"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(73429).A+"",width:"1620",height:"807"})}),"\n",(0,i.jsxs)(n.p,{children:["\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5df2\u7ecf\u5206\u6790\u5b8c\u4e86\uff0c\u4e3a\u4e86\u4e0d\u8ba9\u540c\u6b65\u6d41\u7a0b\u88ab\u6253\u65ad\uff0c\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\u5c31\u5ffd\u7565\u4e86\u5176\u4ed6\u903b\u8f91\u3002\u6211\u4eec\u8fd8\u9700\u8981\u5206\u6790",(0,i.jsx)(n.code,{children:"Admin"}),"\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\u548c\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\u7684\u6d41\u7a0b\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"4-admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316",children:"4. Admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316"}),"\n",(0,i.jsxs)(n.p,{children:["\u5f53",(0,i.jsx)(n.code,{children:"admin"}),"\u542f\u52a8\u540e\uff0c\u4f1a\u5c06\u5f53\u524d\u7684\u6570\u636e\u4fe1\u606f\u5168\u91cf\u540c\u6b65\u5230",(0,i.jsx)(n.code,{children:"zk"}),"\u4e2d\uff0c\u5b9e\u73b0\u903b\u8f91\u5982\u4e0b\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"\n/**\n * Zookeeper \u6570\u636e\u521d\u59cb\u5316\n */\npublic class ZookeeperDataInit implements CommandLineRunner {\n\n    private final ZkClient zkClient;\n\n    private final SyncDataService syncDataService;\n\n    /**\n     * Instantiates a new Zookeeper data init.\n     *\n     * @param zkClient        the zk client\n     * @param syncDataService the sync data service\n     */\n    public ZookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {\n        this.zkClient = zkClient;\n        this.syncDataService = syncDataService;\n    }\n\n    @Override\n    public void run(final String... args) {\n        String pluginPath = DefaultPathConstants.PLUGIN_PARENT;\n        String authPath = DefaultPathConstants.APP_AUTH_PARENT;\n        String metaDataPath = DefaultPathConstants.META_DATA;\n        // \u5224\u65adzk\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\n        if (!zkClient.exists(pluginPath) && !zkClient.exists(authPath) && !zkClient.exists(metaDataPath)) {\n            syncDataService.syncAll(DataEventTypeEnum.REFRESH);\n        }\n    }\n}\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5224\u65ad",(0,i.jsx)(n.code,{children:"zk"}),"\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u884c\u540c\u6b65\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ZookeeperDataInit"}),"\u5b9e\u73b0\u4e86",(0,i.jsx)(n.code,{children:"CommandLineRunner"}),"\u63a5\u53e3\u3002\u5b83\u662f",(0,i.jsx)(n.code,{children:"springboot"}),"\u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u4f1a\u5728\u6240\u6709 ",(0,i.jsx)(n.code,{children:"Spring Beans"}),"\u521d\u59cb\u5316\u4e4b\u540e\u6267\u884c",(0,i.jsx)(n.code,{children:"run()"}),"\u65b9\u6cd5\uff0c\u5e38\u7528\u4e8e\u9879\u76ee\u4e2d\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"SyncDataService.syncAll()"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u4ece\u6570\u636e\u5e93\u67e5\u8be2\u6570\u636e\uff0c\u7136\u540e\u8fdb\u884c\u5168\u91cf\u6570\u636e\u540c\u6b65\uff0c\u6240\u6709\u7684\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002\u4e3b\u8981\u662f\u901a\u8fc7",(0,i.jsx)(n.code,{children:"eventPublisher"}),"\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u3002\u8fd9\u91cc\u5c31\u8ddf\u524d\u9762\u63d0\u5230\u7684\u540c\u6b65\u903b\u8f91\u5c31\u53c8\u8054\u7cfb\u8d77\u6765\u4e86\uff0c",(0,i.jsx)(n.code,{children:"eventPublisher"}),"\u901a\u8fc7",(0,i.jsx)(n.code,{children:"publishEvent()"}),"\u53d1\u5e03\u5b8c\u4e8b\u4ef6\u540e\uff0c\u6709",(0,i.jsx)(n.code,{children:"ApplicationListener"}),"\u6267\u884c\u4e8b\u4ef6\u53d8\u66f4\u64cd\u4f5c\uff0c\u5728",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u4e2d\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684",(0,i.jsx)(n.code,{children:"DataChangedEventDispatcher"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Service\npublic class SyncDataServiceImpl implements SyncDataService {\n    // \u4e8b\u4ef6\u53d1\u5e03\n    private final ApplicationEventPublisher eventPublisher;\n    \n     /***\n     * \u5168\u91cf\u6570\u636e\u540c\u6b65\n     * @param type the type\n     * @return\n     */\n    @Override\n    public boolean syncAll(final DataEventTypeEnum type) {\n        // \u540c\u6b65\u8ba4\u8bc1\u4fe1\u606f\n        appAuthService.syncData();\n        // \u540c\u6b65\u63d2\u4ef6\u4fe1\u606f\n        List<PluginData> pluginDataList = pluginService.listAll();\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));\n        // \u540c\u6b65\u9009\u62e9\u5668\u4fe1\u606f\n        List<SelectorData> selectorDataList = selectorService.listAll();\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));\n        // \u540c\u6b65\u89c4\u5219\u4fe1\u606f\n        List<RuleData> ruleDataList = ruleService.listAll();\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));\n        // \u540c\u6b65\u5143\u6570\u636e\u4fe1\u606f\n        metaDataService.syncData();\n        return true;\n    }\n    \n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"5-\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316",children:"5. \u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316"}),"\n",(0,i.jsxs)(n.p,{children:["\u7f51\u5173\u8fd9\u8fb9\u7684\u6570\u636e\u540c\u6b65\u521d\u59cb\u5316\u64cd\u4f5c\u4e3b\u8981\u662f\u8ba2\u9605",(0,i.jsx)(n.code,{children:"zk"}),"\u4e2d\u7684\u8282\u70b9\uff0c\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u6536\u5230\u53d8\u66f4\u6570\u636e\u3002\u8fd9\u4f9d\u8d56\u4e8e",(0,i.jsx)(n.code,{children:"ZooKeeper"}),"\u7684",(0,i.jsx)(n.code,{children:"Watch"}),"\u673a\u5236\u3002\u5728",(0,i.jsx)(n.code,{children:"ShenYu"}),"\u4e2d\uff0c\u8d1f\u8d23",(0,i.jsx)(n.code,{children:"zk"}),"\u6570\u636e\u540c\u6b65\u7684\u662f",(0,i.jsx)(n.code,{children:"ZookeeperSyncDataService"}),"\uff0c\u4e5f\u5728\u524d\u9762\u63d0\u5230\u8fc7\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ZookeeperSyncDataService"}),"\u7684\u529f\u80fd\u903b\u8f91\u662f\u5728\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\uff1a\u5bf9",(0,i.jsx)(n.code,{children:"zk"}),"\u4e2d\u7684",(0,i.jsx)(n.code,{children:"shenyu"}),"\u6570\u636e\u540c\u6b65\u8282\u70b9\u5b8c\u6210\u8ba2\u9605\u3002\u8fd9\u91cc\u7684\u8ba2\u9605\u5206\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u5df2\u7ecf\u5b58\u5728\u7684\u8282\u70b9\u4e0a\u9762\u6570\u636e\u53d1\u751f\u66f4\u65b0\uff0c\u8fd9\u901a\u8fc7",(0,i.jsx)(n.code,{children:"zkClient.subscribeDataChanges()"}),"\u65b9\u6cd5\u5b9e\u73b0\uff1b\u53e6\u4e00\u7c7b\u662f\u5f53\u524d\u8282\u70b9\u4e0b\u6709\u65b0\u589e\u6216\u5220\u9664\u8282\u70b9\uff0c\u5373\u5b50\u8282\u70b9\u53d1\u751f\u53d8\u5316\uff0c\u8fd9\u901a\u8fc7",(0,i.jsx)(n.code,{children:"zkClient.subscribeChildChanges()"}),"\u65b9\u6cd5\u5b9e\u73b0\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ZookeeperSyncDataService"}),"\u7684\u4ee3\u7801\u6709\u70b9\u591a\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5\u63d2\u4ef6\u6570\u636e\u7684\u8bfb\u53d6\u548c\u8ba2\u9605\u8fdb\u884c\u8ffd\u8e2a\uff0c\u5176\u4ed6\u7c7b\u578b\u7684\u6570\u636e\u64cd\u4f5c\u539f\u7406\u662f\u4e00\u6837\u7684\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"\n/**\n *  zookeeper \u6570\u636e\u540c\u6b65\u670d\u52a1\n */\npublic class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {\n    // \u5728\u5b9e\u4f8b\u5316\u7684\u65f6\u5019\uff0c\u5b8c\u6210\u4ecezk\u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u5e76\u8ba2\u9605\u8282\u70b9\n    public ZookeeperSyncDataService( /*\u7701\u7565\u6784\u9020\u53c2\u6570\u53c2\u6570*/ ) {\n        this.zkClient = zkClient;\n        this.pluginDataSubscriber = pluginDataSubscriber;\n        this.metaDataSubscribers = metaDataSubscribers;\n        this.authDataSubscribers = authDataSubscribers;\n        // \u8ba2\u9605\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\n        watcherData();\n        // \u8ba2\u9605\u8ba4\u8bc1\u6570\u636e\n        watchAppAuth();\n        // \u8ba2\u9605\u5143\u6570\u636e\n        watchMetaData();\n    }\n    \n    private void watcherData() {\n        // \u63d2\u4ef6\u8282\u70b9\u8def\u5f84\n        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;\n        // \u6240\u6709\u63d2\u4ef6\u8282\u70b9\n        List<String> pluginZKs = zkClientGetChildren(pluginParent);\n        for (String pluginName : pluginZKs) {\n            // \u8ba2\u9605\u5f53\u524d\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\n            watcherAll(pluginName);\n        }\n        // \u8ba2\u9605\u5b50\u8282\u70b9\uff08\u65b0\u589e\u6216\u5220\u9664\u4e00\u4e2a\u63d2\u4ef6\uff09\n        zkClient.subscribeChildChanges(pluginParent, (parentPath, currentChildren) -> {\n            if (CollectionUtils.isNotEmpty(currentChildren)) {\n                for (String pluginName : currentChildren) {\n                    // \u9700\u8981\u8ba2\u9605\u5b50\u8282\u70b9\u7684\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\n                    watcherAll(pluginName);\n                }\n            }\n        });\n    }\n    \n    private void watcherAll(final String pluginName) {\n        // \u8ba2\u9605\u63d2\u4ef6\u6570\u636e\n        watcherPlugin(pluginName);\n        // \u8ba2\u9605\u9009\u62e9\u5668\u6570\u636e\n        watcherSelector(pluginName);\n        // \u8ba2\u9605\u89c4\u5219\u6570\u636e\n        watcherRule(pluginName);\n    }\n\n    private void watcherPlugin(final String pluginName) {\n        // \u5f53\u524d\u63d2\u4ef6\u8def\u5f84\n        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);\n        // \u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u5c31\u521b\u5efa\n        if (!zkClient.exists(pluginPath)) {\n            zkClient.createPersistent(pluginPath, true);\n        }\n        // \u8bfb\u53d6zk\u4e0a\u5f53\u524d\u8282\u70b9\u6570\u636e\uff0c\u5e76\u53cd\u5e8f\u5217\u5316\n        PluginData pluginData = null == zkClient.readData(pluginPath) ? null\n                : GsonUtils.getInstance().fromJson((String) zkClient.readData(pluginPath), PluginData.class);\n        // \u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d\n        cachePluginData(pluginData);\n        // \u8ba2\u9605\u63d2\u4ef6\u8282\u70b9\n        subscribePluginDataChanges(pluginPath, pluginName);\n    }\n    \n   private void cachePluginData(final PluginData pluginData) {\n       // \u7701\u7565\u5b9e\u73b0\u903b\u8f91\uff0c\u5176\u5b9e\u5c31\u662f CommonPluginDataSubscriber \u4e2d\u7684\u64cd\u4f5c\uff0c\u8ddf\u524d\u9762\u90fd\u80fd\u8054\u7cfb\u8d77\u6765\n    }\n    \n    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {\n        // \u8ba2\u9605\u6570\u636e\u53d8\u66f4\uff1a\u66f4\u65b0\u6216\u5220\u9664\n        zkClient.subscribeDataChanges(pluginPath, new IZkDataListener() {\n\n            @Override\n            public void handleDataChange(final String dataPath, final Object data) {  // \u66f4\u65b0\u64cd\u4f5c\n                 // \u7701\u7565\u5b9e\u73b0\u903b\u8f91\uff0c\u5176\u5b9e\u5c31\u662f CommonPluginDataSubscriber \u4e2d\u7684\u64cd\u4f5c\uff0c\u8ddf\u524d\u9762\u90fd\u80fd\u8054\u7cfb\u8d77\u6765\n            }\n\n            @Override\n            public void handleDataDeleted(final String dataPath) {   // \u5220\u9664\u64cd\u4f5c\n                  // \u7701\u7565\u5b9e\u73b0\u903b\u8f91\uff0c\u5176\u5b9e\u5c31\u662f CommonPluginDataSubscriber \u4e2d\u7684\u64cd\u4f5c\uff0c\u8ddf\u524d\u9762\u90fd\u80fd\u8054\u7cfb\u8d77\u6765\n\n            }\n        });\n    }\n    \n}    \n"})}),"\n",(0,i.jsx)(n.p,{children:"\u4e0a\u9762\u7684\u6e90\u4ee3\u7801\u4e2d\u90fd\u7ed9\u51fa\u4e86\u6ce8\u91ca\uff0c\u76f8\u4fe1\u5927\u5bb6\u53ef\u4ee5\u770b\u660e\u767d\u3002\u8ba2\u9605\u63d2\u4ef6\u6570\u636e\u7684\u4e3b\u8981\u903b\u8f91\u5982\u4e0b\uff1a"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u6784\u9020\u5f53\u524d\u63d2\u4ef6\u8def\u5f84"}),"\n",(0,i.jsx)(n.li,{children:"\u8def\u5f84\u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u5c31\u521b\u5efa"}),"\n",(0,i.jsx)(n.li,{children:"\u8bfb\u53d6zk\u4e0a\u5f53\u524d\u8282\u70b9\u6570\u636e\uff0c\u5e76\u53cd\u5e8f\u5217\u5316"}),"\n",(0,i.jsx)(n.li,{children:"\u63d2\u4ef6\u6570\u636e\u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d"}),"\n",(0,i.jsx)(n.li,{children:"\u8ba2\u9605\u63d2\u4ef6\u8282\u70b9"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"6-\u603b\u7ed3",children:"6. \u603b\u7ed3"}),"\n",(0,i.jsxs)(n.p,{children:["\u672c\u6587\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\uff0c\u5bf9",(0,i.jsx)(n.code,{children:"zookeeper"}),"\u7684\u6570\u636e\u540c\u6b65\u539f\u7406\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u57fa\u4e8e",(0,i.jsx)(n.code,{children:"zookeeper"}),"\u7684\u6570\u636e\u540c\u6b65\uff0c\u4e3b\u8981\u662f\u901a\u8fc7",(0,i.jsx)(n.code,{children:"watch"}),"\u673a\u5236\u5b9e\u73b0\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:["\u901a\u8fc7",(0,i.jsx)(n.code,{children:"Spring"}),"\u5b8c\u6210\u4e8b\u4ef6\u53d1\u5e03\u548c\u76d1\u542c\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:["\u901a\u8fc7\u62bd\u8c61",(0,i.jsx)(n.code,{children:"DataChangedListener"}),"\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u540c\u6b65\u7b56\u7565\uff0c\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:["\u4f7f\u7528\u5355\u4f8b\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0\u7f13\u5b58\u6570\u636e\u7c7b",(0,i.jsx)(n.code,{children:"BaseDataCache"}),"\uff1b"]}),"\n",(0,i.jsxs)(n.li,{children:["\u901a\u8fc7",(0,i.jsx)(n.code,{children:"SpringBoot"}),"\u7684\u6761\u4ef6\u88c5\u914d\u548c",(0,i.jsx)(n.code,{children:"starter"}),"\u52a0\u8f7d\u673a\u5236\u5b9e\u73b0\u914d\u7f6e\u7c7b\u7684\u52a0\u8f7d\u3002"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},19972(e,n,t){t.d(n,{A:()=>a});const a=t.p+"assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"},28453(e,n,t){t.d(n,{R:()=>r,x:()=>s});var a=t(96540);const i={},l=a.createContext(i);function r(e){const n=a.useContext(l);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(l.Provider,{value:n},e.children)}},39980(e){e.exports=JSON.parse('{"permalink":"/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync","editUrl":"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync.md","title":"ZooKeeper\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","description":"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002","date":"2025-12-17T02:20:20.000Z","tags":[{"inline":true,"label":"zookeeper","permalink":"/zh/blog/tags/zookeeper"},{"inline":true,"label":"data sync","permalink":"/zh/blog/tags/data-sync"},{"inline":true,"label":"Apache ShenYu","permalink":"/zh/blog/tags/apache-shen-yu"}],"readingTime":25.66,"hasTruncateMarker":false,"authors":[{"name":"midnight2104","title":"Apache ShenYu Committer","url":"https://github.com/midnight2104","key":null,"page":null}],"frontMatter":{"title":"ZooKeeper\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","author":"midnight2104","author_title":"Apache ShenYu Committer","author_url":"https://github.com/midnight2104","tags":["zookeeper","data sync","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"WebSocket\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790","permalink":"/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync"},"nextItem":{"title":"e2e\u6d4b\u8bd5\u8be6\u89e3","permalink":"/zh/blog/E2eTest-Analysis"}}')},73429(e,n,t){t.d(n,{A:()=>a});const a=t.p+"assets/images/zk-sync-sequence-gateway-zh-0494aedc4de3f64c781fe8bb6c4b69bc.png"},86305(e,n,t){t.d(n,{A:()=>a});const a=t.p+"assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"},89452(e,n,t){t.d(n,{A:()=>a});const a=t.p+"assets/images/zk-sync-sequence-admin-zh-afad1ef642b7130231c2ceacce236b34.png"},96368(e,n,t){t.d(n,{A:()=>a});const a=t.p+"assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"}}]);