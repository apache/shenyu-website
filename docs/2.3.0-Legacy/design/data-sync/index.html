<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Data Synchronization Design | Apache ShenYu</title><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//docs/2.3.0-Legacy/design/data-sync"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="2.3.0-Legacy"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-2.3.0-Legacy"><meta data-react-helmet="true" property="og:title" content="Data Synchronization Design | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Data Synchronization Design"><meta data-react-helmet="true" property="og:description" content="Data Synchronization Design"><meta data-react-helmet="true" name="keywords" content="soul"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//docs/2.3.0-Legacy/design/data-sync"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//docs/2.3.0-Legacy/design/data-sync" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/docs/2.3.0-Legacy/design/data-sync" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//docs/2.3.0-Legacy/design/data-sync" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ca78636b.css">
<link rel="preload" href="/assets/js/runtime~main.5d774744.js" as="script">
<link rel="preload" href="/assets/js/main.872faa15.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/document">Docs</a><a class="navbar__item navbar__link" href="/community/contributor-guide">Community</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/event">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/2.3.0-Legacy/design/data-sync" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/docs/2.3.0-Legacy/design/data-sync" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/2.3.0-Legacy/index">Soul Introduction</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.3.0-Legacy/team">Team Introduction</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Design</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.3.0-Legacy/design/database-design">Database Design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.3.0-Legacy/design/config">Configuration Flow Introduction</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/2.3.0-Legacy/design/data-sync">Data Synchronization Design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.3.0-Legacy/design/meta-data">MetaData Concept Design</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Admin</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Users Guide</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Register Center</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Quick Start</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Plugins</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Developer Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/2.3.0-Legacy/doc-download">Doc Download</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for Apache ShenYu <b>2.3.0-Legacy</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/design/data-sync">latest version</a></b> (2.7.0).</div></div><div class="docItemContainer_oiyr"><article><span class="badge badge--secondary">Version: 2.3.0-Legacy</span><div class="tocCollapsible_aw-L tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_dC7a">Data Synchronization Design</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="description"></a>Description<a class="hash-link" href="#description" title="Direct link to heading">#</a></h2><p>This article mainly explains three ways of database synchronization and their principles.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="preface"></a>Preface<a class="hash-link" href="#preface" title="Direct link to heading">#</a></h2><p>Gateway is the entrance of request and it is a very important part in micro service architecture, therefore the importance of gateway high availability is self-evident. When we use gateway, we have to change configuration such as flow rule, route rule for satisfying business requirement. Therefore, the dynamic configuration of the gateway is an important factor to ensure the high availability of the gateway. Then, how does <code>Soul</code> support dynamic configuration?</p><p>Anyone who has used <code>Soul</code> knows, <code>Soul</code> plugin are hot swap,and the selector, rule of all plugins are dynamic configured, they take effect immediately without restarting service.But during using <code>Soul</code> gateway, users also report many problems</p><ul><li>Rely on <code>zookeeper</code>, this troubles users who use <code>etcd</code> <code>consul</code> and <code>nacos</code> registry</li><li>Rely on <code>redis</code>,<code>influxdb</code>, I have not used the limiting plugin, monitoring plugin, why do I need these</li></ul><p>Therefore,we have done a partial reconstruction of <code>Soul</code>,after two months of version iteration,we released version <code>2.0</code></p><ul><li>Data Synchronization removes the strong dependence on <code>zookeeper</code>,and we add <code>http long polling</code> and <code>websocket</code></li><li>Limiting plugin and monitoring plugin realize real dynamic configuration,we use <code>admin</code> backend for dynamic configuration instead of <code>yml</code> configuration before</li></ul><p><em>Q: Someone may ask me,why don&#x27;t you use configuration center for synchronization?</em>  </p><p>First of all, it will add extra costs, not only for maintenance, but also make <code>Soul</code> heavy; In addition, using configuration center, data format is uncontrollable and it is not convenient for <code>soul-admin</code> to do configuration management.</p><p><em>Q: Someone may also ask,dynamic configuration update?Every time I can get latest data from database or redis,why are you making it complicated?</em></p><p>As a gateway, soul cached all the configuration in the <code>HashMap</code> of JVM in order to provide higher response speed and we use local cache for every request, It&#x27;s very fast. So this article can also be understood as three ways of memory synchronization in a distributed environment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="principle-analysis"></a>Principle Analysis<a class="hash-link" href="#principle-analysis" title="Direct link to heading">#</a></h2><p>This is a HD uncoded image, it shows the flow of <code>Soul</code> data synchronization, when <code>Soul</code> gateway starts, it will synchronize configuration data from the configuration service and support push-pull mode to obtain configuration change information, and update the local cache.When administrator changes user,rule,plugin,flow configuration in the backend, modified information will synchronize to the <code>Soul</code> gateway through the push-pull mode,whether it is the push mode or the pull mode depends on the configuration.About the configuration synchronization module, it is actually a simplified configuration center.
<img src="https://bestkobe.gitee.io/images/soul/soul-config-processor.png?_t=201908032316" alt="Soul Data Synchronization Flow Chart"></p><p>At version <code>1.x</code> ,configuration service depends on <code>zookeeper</code>,management backend <code>push</code> the modified information to gateway.But version <code>2.x</code> supports <code>webosocket</code>,<code>http</code>,<code>zookeeper</code>,it can specify the corresponding synchronization strategy through <code>soul.sync.strategy</code> and use <code>webosocket</code> synchronization strategy by default which can achieve second-level data synchronization.But,note that <code>soul-web</code> and <code>soul-admin</code> must use the same synchronization mechanism.</p><p>As showing picture below,<code>soul-admin</code> will issue a configuration change notification through <code>EventPublisher</code> after users change configuration,<code>EventDispatcher</code> will handle this modification and send configuration to corresponding event handler according to configured synchronization strategy(http,websocket,zookeeper)</p><ul><li>If it is a <code>websocket</code> synchronization strategy,it will push modified data to <code>soul-web</code>,and corresponding <code>WebsocketCacheHandler</code> handler will handle <code>admin</code> data push at the gateway layer</li><li>If it is a  <code>zookeeper</code> synchronization strategy,it will push modified data to <code>zookeeper</code>,and the <code>ZookeeperSyncCache</code> will monitor the data changes of <code>zookeeper</code> and process them</li><li>If it is a  <code>http</code> synchronization strategy,<code>soul-web</code> proactively initiates long polling requests,90 seconds timeout by default,if there is no modified data in <code>soul-admin</code>,http request will be blocked,if there is a data change, it will respond to the changed data information,if there is no data change after 60 seconds,then respond with empty data,gateway continue to make http request after getting response,this kind of request will repeat
<img src="https://bestkobe.gitee.io/images/soul/config-strage-processor.png?_t=201908032339" alt="Soul Configuration Synchronization Strategy Flow Chart"></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="zookeeper-synchronization"></a>Zookeeper Synchronization<a class="hash-link" href="#zookeeper-synchronization" title="Direct link to heading">#</a></h2><p>The zookeeper-based synchronization principle is very simple,it mainly depends on <code>zookeeper</code> watch mechanism,<code>soul-web</code> will monitor the configured node,when <code>soul-admin</code> starts,all the data will be written to <code>zookeeper</code>,it will incrementally update the nodes of <code>zookeeper</code> when data changes,at the same time, <code>soul-web</code> will monitor the node for configuration information, and update the local cache once the information changes</p><p><img src="https://yu199195.github.io/images/soul/soul-zookeeper.png" alt="Zookeeper Node Design"></p><p><code>soul</code> writes the configuration information to the zookeeper node,and it is meticulously designed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="websocket-synchronization"></a>WebSocket Synchronization<a class="hash-link" href="#websocket-synchronization" title="Direct link to heading">#</a></h2><p>The mechanism of <code>websocket</code> and <code>zookeeper</code> is similar,when the gateway and the <code>admin</code> establish a <code>websocket</code> connection,<code>admin</code> will push all data at once,it will automatically push incremental data to <code>soul-web</code> through <code>websocket</code> when configured data changes</p><p>When we use websocket synchronization,pay attention to reconnect after disconnection,which also called keep heartbeat.<code>soul</code> uses <code>java-websocket</code> ,a third-party library,to connect to <code>websocket</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketSyncCache extends WebsocketCacheHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The Client.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private WebSocketClient client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketSyncCache(final SoulConfig.WebsocketConfig websocketConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ScheduledThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SoulThreadFactory.create(&quot;websocket-connect&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         client = new WebSocketClient(new URI(websocketConfig.getUrl())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void onOpen(final ServerHandshake serverHandshake) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  //....</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void onMessage(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  //....</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //connect</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        client.connectBlocking();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //reconnect after disconnection,using scheduling thread pool,execute every 30 seconds</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor.scheduleAtFixedRate(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (client != null &amp;&amp; client.isClosed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    client.reconnectBlocking();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, 10, 30, TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="http-long-polling"></a>Http Long Polling<a class="hash-link" href="#http-long-polling" title="Direct link to heading">#</a></h2><p>The mechanism of zookeeper and websocket data synchronization is relatively simple,but http synchronization will be relatively complicated.Soul borrows the design ideas of <code>Apollo</code> and <code>Nacos</code> and realizes <code>http</code> long polling data synchronization using their advantages.Note that this is not traditional ajax long polling.</p><p><img src="https://bestkobe.gitee.io/images/soul/http-long-polling.png?_t=201908032339" alt="http long polling"></p><p>http long polling mechanism as above,soul-web gateway requests admin configuration services,timeout is 90 seconds,it means gateway layer request configuration service will wait at most 90 seconds,this is convenient for admin configuration service to respond modified data in time,and therefore we realize near real-time push.</p><p>After the http request reaches soul-admin, it does not respond immediately,but uses the asynchronous mechanism of Servlet3.0 to asynchronously respond to the data.First of all,put long polling request task <code>LongPollingClient</code> into <code>BlocingQueue</code>,and then start scheduling task,execute after 60 seconds,this aims to remove the long polling request from the queue after 60 seconds,even there is no configured data change.Because even if there is no configuration change,gateway also need to know,otherwise it will wait,and there is a 90 seconds timeout when the gateway requests configuration services.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public void doLongPolling(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // since soul-web may not receive notification of a configuration change, MD5 value may be different,so respond immediately</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;ConfigGroupEnum&gt; changedGroup = compareMD5(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String clientIp = getRemoteIp(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (CollectionUtils.isNotEmpty(changedGroup)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.generateResponse(response, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Servlet3.0 asynchronously responds to http request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final AsyncContext asyncContext = request.startAsync();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncContext.setTimeout(0L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduler.execute(new LongPollingClient(asyncContext, clientIp, 60));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">class LongPollingClient implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LongPollingClient(final AsyncContext ac, final String ip, final long timeoutTime) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // omit......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // join a scheduled task, if there is no configuration change within 60 seconds, it will be executed after 60 seconds and respond to http requests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.asyncTimeoutFuture = scheduler.schedule(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // clients are blocked queue,saved the request from soul-web</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clients.remove(LongPollingClient.this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;ConfigGroupEnum&gt; changedGroups = HttpLongPollingDataChangedListener.compareMD5((HttpServletRequest) asyncContext.getRequest());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            sendResponse(changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, timeoutTime, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        clients.add(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If the administrator changes the configuration data during this period,the long polling requests in the queue will be removed one by one, and respond which groupâ€™s data has changed(we distribute plugins, rules, flow configuration , user configuration data into different groups).After gateway receives response,it only knows which Group has changed its configuration,it need to request again to get group configuration data.Someone may ask,why don&#x27;t you write out the changed data directly?We also discussed this issue deeply during development, because the http long polling mechanism can only guarantee quasi real-time,if gateway layer does not handle it in time,or administrator updates configuration frequently,we probably missed some configuration change push.For security, we only inform that a certain Group information has changed.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// soul-admin configuration changed,remove the requests from the queue one by one and respond to them</span></span><span class="token-line" style="color:#393A34"><span class="token plain">class DataChangeTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataChangeTask(final ConfigGroupEnum groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.groupKey = groupKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Iterator&lt;LongPollingClient&gt; iter = clients.iterator(); iter.hasNext(); ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LongPollingClient client = iter.next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                iter.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.sendResponse(Collections.singletonList(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;data change error.&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When <code>soul-web</code> gateway layer receives the http response information,pull modified information(if exists),and then request <code>soul-admin</code> configuration service again,this will repeatedly execute.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="storage-address"></a>Storage Address<a class="hash-link" href="#storage-address" title="Direct link to heading">#</a></h2><p>github: <a href="https://github.com/dromara/soul" target="_blank" rel="noopener noreferrer">https://github.com/dromara/soul</a></p><p>gitee: <a href="https://gitee.com/dromara/soul" target="_blank" rel="noopener noreferrer">https://gitee.com/dromara/soul</a></p><p>There also have video tutorials on the project homepage,you can go to watch it if needed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="at-last"></a>At Last<a class="hash-link" href="#at-last" title="Direct link to heading">#</a></h2><p>This article introduces that,in order to optimize the response speed, <code>soul</code> as a highly available micro service gateway, its three ways to cache the configuration rule selector data locally.After learning this article,I believe you have a certain understanding of the popular configuration center,it may be easier to learn their codes,I believe you can also write a distributed configuration center.Version 3.0 is already under planning,and I believe it will definitely surprise you.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/apache/shenyu-website/edit/main/versioned_docs/version-2.3.0-Legacy/design/data-sync.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_wj+Z"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/2.3.0-Legacy/design/config"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Configuration Flow Introduction</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/2.3.0-Legacy/design/meta-data"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">MetaData Concept Design Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#description" class="table-of-contents__link">Description</a></li><li><a href="#preface" class="table-of-contents__link">Preface</a></li><li><a href="#principle-analysis" class="table-of-contents__link">Principle Analysis</a></li><li><a href="#zookeeper-synchronization" class="table-of-contents__link">Zookeeper Synchronization</a></li><li><a href="#websocket-synchronization" class="table-of-contents__link">WebSocket Synchronization</a></li><li><a href="#http-long-polling" class="table-of-contents__link">Http Long Polling</a></li><li><a href="#storage-address" class="table-of-contents__link">Storage Address</a></li><li><a href="#at-last" class="table-of-contents__link">At Last</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.5d774744.js"></script>
<script src="/assets/js/main.872faa15.js"></script>
</body>
</html>