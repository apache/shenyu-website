<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">AiTokenLimiter Plugin | Apache ShenYu</title><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/docs/plugin-center/ai/ai-token-limiter"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:version" content="2.7.0.1"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-2.7.0.1"><meta data-react-helmet="true" property="og:title" content="AiTokenLimiter Plugin | Apache ShenYu"><meta data-react-helmet="true" name="description" content="AiTokenLimiter Plugin"><meta data-react-helmet="true" property="og:description" content="AiTokenLimiter Plugin"><meta data-react-helmet="true" name="keywords" content="AiTokenLimiter"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/docs/plugin-center/ai/ai-token-limiter"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//docs/plugin-center/ai/ai-token-limiter" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/docs/plugin-center/ai/ai-token-limiter" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//docs/plugin-center/ai/ai-token-limiter" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.cc2d0c98.css">
<link rel="preload" href="/zh/assets/js/runtime~main.4363bf8b.js" as="script">
<link rel="preload" href="/zh/assets/js/main.74cb2516.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a class="navbar__item navbar__link" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">åŸºé‡‘ä¼š</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">è®¸å¯</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">æ´»åŠ¨</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">å®‰å…¨</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">èµåŠ©</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">éšç§</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">è‡´è°¢</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/docs/plugin-center/ai/ai-token-limiter" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/docs/plugin-center/ai/ai-token-limiter" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢ (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh/docs/index">Apache ShenYu ä»‹ç»</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Design</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deployment</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Quick Start</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Guide</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Plugin Center</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Http Process</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Proxy</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Fault Tolerance</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Security</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Observability</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Common</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Cache</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Mock</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Ai</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/plugin-center/ai/ai-prompt">AiPrompt Plugin</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/plugin-center/ai/ai-proxy">AiProxy Plugin</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/zh/docs/plugin-center/ai/ai-token-limiter">AiTokenLimiter Plugin</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Developer</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Benchmark Test</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><span class="badge badge--secondary">Version: 2.7.0.1</span><div class="tocCollapsible_aw-L tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_dC7a">AiTokenLimiter Plugin</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>The <strong>aiTokenLimiter</strong> plugin is used to track token consumption from LLM responses and enforce rate limiting via Redis. After each response, aiTokenLimiter calculates the number of tokens used and accumulates counts by user or business dimension. If the preset threshold is exceeded, subsequent requests can be rejected or throttled. Note that ShenYuâ€™s rate limiting is typically implemented using Redis to store token buckets or sliding-window states; aiTokenLimiter likewise relies on Redis to record and check token usage. It is most commonly paired with <strong>aiProxy</strong> for token-based rate limiting.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="plugin-configuration"></a>Plugin Configuration<a class="hash-link" href="#plugin-configuration" title="Direct link to heading">#</a></h2><p>When configuring the plugin in the ShenYu admin console, you first create a <strong>Selector</strong>, then a <strong>Rule</strong>. A <strong>Selector</strong> matches request conditions (e.g., path, headers), while a <strong>Rule</strong> defines plugin parameters or forwarding targets. For more details, see <a href="/zh/docs/user-guide/admin-usage/selector-and-rule">Selector and Rule Management</a>.</p><p>Key fields for <strong>aiTokenLimiter</strong>:</p><ul><li><strong>Selector</strong>: Defines which requests to match. For example, set <code>Pattern</code> to <code>/**</code> to match all requests, or specify a particular route.</li><li><strong>Rule</strong>: Configure plugin parameters:<ul><li><code>timeWindowSeconds</code>: Length of the rate-limiting window (in seconds). Within this window, the plugin tallies total token usage and compares it against <code>tokenLimit</code>.</li><li><code>keyName</code>: Field name in the request used as the rate-limiting â€œdimension key,â€ in conjunction with <code>aiTokenLimitType</code> (e.g., HEADER, PARAMETER, COOKIE).</li><li><code>tokenLimit</code>: Maximum number of tokens allowed within the time window. The plugin counts downstream LLM <strong>completion tokens</strong> (the tokens consumed by generated content). Once this limit is exceeded, further requests receive an HTTP 429 response.</li></ul></li></ul><p>Example screenshots of <strong>aiTokenLimiter</strong> setup in the admin interface:</p><p><img alt="ai-token-limiter-selector" src="/zh/assets/images/ai-token-limiter-selector-zh-050f076c8987cb9c9c834684cc01aa17.png"></p><p><img alt="ai-token-limiter-rule" src="/zh/assets/images/ai-token-limiter-rule-zh-672a88bbeb70045a60ecfcc39d406ea6.png"></p><blockquote><p><strong>Note:</strong> The <strong>aiTokenLimiter</strong> plugin depends on <strong>aiProxy</strong>. In a typical flow, apply <strong>AiPrompt</strong> (if injecting a prompt), then <strong>AiTokenLimiter</strong> (for token counting/rate limiting), and finally <strong>AiProxy</strong> (to forward the request to the LLM). Ensure that <strong>AiTokenLimiter</strong>â€™s <strong>sort</strong> value is <strong>less than</strong> <strong>AiProxy</strong> and <strong>greater than</strong> <strong>AiPrompt</strong> in the â€œPlugin Managementâ€ list.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="api-usage"></a>API Usage<a class="hash-link" href="#api-usage" title="Direct link to heading">#</a></h2><p>With <strong>AiProxy</strong> and <strong>AiTokenLimiter</strong> enabled, send requests through the ShenYu gateway (e.g., via Postman) to proxy LLM calls:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --location --request POST </span><span class="token string" style="color:#e3116c">&#x27;http://localhost:9195/ai/proxy/v1/chat/completions&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">--header </span><span class="token string" style="color:#e3116c">&#x27;Content-Type: application/json&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">--data-raw </span><span class="token string" style="color:#e3116c">&#x27;{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;model&quot;: &quot;gpt-4o-mini&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;messages&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;role&quot;: &quot;user&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;content&quot;: &quot;æˆ‘äºæ€æˆ®ä¹‹ä¸­ç››æ”¾ï¼Œäº¦å¦‚é»æ˜ä¸­çš„èŠ±æœµ&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Example request (before rate limiting):
<img alt="ai-proxy-api" src="/zh/assets/images/ai-token-limiter-api-before-cc7312a27b9b44ef36834bc9c28127d3.png"></p><p>If you set tokenLimit=10 and make another request within 60 seconds, AiTokenLimiter will intercept it, return HTTP 429, and indicate that the token usage limit has been reached. Please try again later.</p><p>Example response (after rate limiting):
<img alt="ai-proxy-api" src="/zh/assets/images/ai-token-limiter-api-after-7fc54594554eb138101ed65ab48c8ce5.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/apache/shenyu-website/edit/main/versioned_docs/version-2.7.0.1/plugin-center/ai/ai-token-limiter.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æœ¬æ–‡æ¡£</a></div><div class="col lastUpdated_wj+Z"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/docs/plugin-center/ai/ai-proxy"><div class="pagination-nav__sublabel">ä¸Šä¸€ç¯‡</div><div class="pagination-nav__label">Â« AiProxy Plugin</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/docs/developer/spi/custom-load-balance"><div class="pagination-nav__sublabel">ä¸‹ä¸€ç¯‡</div><div class="pagination-nav__label">è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#plugin-configuration" class="table-of-contents__link">Plugin Configuration</a></li><li><a href="#api-usage" class="table-of-contents__link">API Usage</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/zh/assets/js/runtime~main.4363bf8b.js"></script>
<script src="/zh/assets/js/main.74cb2516.js"></script>
</body>
</html>