<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">One post tagged with &quot;ext&quot; | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;ext&quot; | Apache ShenYu"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//blog/tags/ext"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//blog/tags/ext"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/ext" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/tags/ext" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/ext" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ca78636b.css">
<link rel="preload" href="/assets/js/runtime~main.1a6efc0b.js" as="script">
<link rel="preload" href="/assets/js/main.c24cd29a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/document">Docs</a><a class="navbar__item navbar__link" href="/community/contributor-guide">Community</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/event">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/ext" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/tags/ext" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><header class="margin-bottom--xl"><h1>One post tagged with &quot;ext&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Loader-SourceCode-Analysis-ExtLoader">Extension plugin loading logic</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-12-04T07:56:04.723Z">December 4, 2024</time> Â· 8 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/hql0312" target="_blank" rel="noopener noreferrer">hql0312</a></div><small class="avatar__subtitle">hql0312 Coder</small></div></div></header><div class="markdown"><blockquote><p>This article is based on the source code analysis of version &#x27;shenyu-2.6.1&#x27;</p></blockquote><header><h1 class="h1Heading_dC7a">Content</h1></header><p>Shenyu provides a mechanism to customize its own plugins or modify existing plugins, which is implemented internally through the configuration of extPlugin. It needs to meet the following two pointsï¼š</p><ol><li>Implement interface <code>ShenyuPlugin</code> or <code>PluginDataHandler</code>.</li><li>After packaging the implemented package, place it in the corresponding path of &#x27;shenyu. extPlugin. path&#x27;.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="entry"></a>Entry<a class="hash-link" href="#entry" title="Direct link to heading">#</a></h2><p>The class that truly implements this logic is&#x27; ShenyuLoaderService &#x27;. Now let&#x27;s take a look at how this class handles it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuLoaderService(final ShenyuWebHandler webHandler, final CommonPluginDataSubscriber subscriber, final ShenyuConfig shenyuConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Information subscription for plugin information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.subscriber = subscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The WebHandler encapsulated by Shenyu contains all the plugin logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.webHandler = webHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // configuration information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.shenyuConfig = shenyuConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The configuration information of the extension plugin, such as path, whether it is enabled, how many threads are enabled to process, and the frequency of loading checks</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtPlugin config = shenyuConfig.getExtPlugin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If enabled, create a scheduled task to check and load</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (config.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a scheduled task with a specified thread name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScheduledThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(config.getThreads(), ShenyuThreadFactory.create(&quot;plugin-ext-loader&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a task to be executed at a fixed frequency, with a default time of 30 seconds and execution every 300 seconds</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.scheduleAtFixedRate(() -&gt; loadExtOrUploadPlugins(null), config.getScheduleDelay(), config.getScheduleTime(), TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This class has the following properties:</p><p><code>WebHandler</code>: This class is the entry point for shenyu to process requests, referencing all plugin data. After the extension plugin is loaded, it needs to be updated.</p><p><code>Subscriber</code>: This class is the entry point for the subscription of plugins, referencing the subscription processing classes of all plugins. After the extension configuration is loaded, synchronous updates are also required.</p><p><code>Executor</code>: A scheduled task will be created inside&#x27; ShenyuLoaderService &#x27;to periodically scan and load jar packages under the specified path, facilitating the loading of extended plugins and achieving dynamic discovery
By default, it will scan every 300 seconds after 30 seconds of startup.</p><p>Meanwhile, the decision to enable extension plugin functionality can be made through the configuration of <code>shenyu. extPlugin. enabled</code>.</p><p>The above configurations can be adjusted in the configuration file:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extPlugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Storage directory for extension plugins</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Is the extension function enabled</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">threads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Number of threads loaded by scanning</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleTime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The frequency of task execution</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleDelay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># How long after the task starts to execute</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Next, let&#x27;s take a look at the loading logicï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   public void loadExtOrUploadPlugins(final PluginData uploadedJarResource) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;ShenyuLoaderResult&gt; plugins = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Obtain the holding object of ShenyuPluginClassloader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuPluginClassloaderHolder singleton = ShenyuPluginClassloaderHolder.getSingleton();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(uploadedJarResource)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If the parameter is empty, load all jar packages from the extended directory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // PluginJar: Data containing the ShenyuPlugin interface and PluginDataHandler interface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;PluginJarParser.PluginJar&gt; uploadPluginJars = ShenyuExtPathPluginJarLoader.loadExtendPlugins(shenyuConfig.getExtPlugin().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Traverse all pending plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (PluginJarParser.PluginJar extPath : uploadPluginJars) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;shenyu extPlugin find new {} to load&quot;, extPath.getAbsolutePath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Use the loader of the extension plugin to load the specified plugin, facilitating subsequent loading and unloading</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPluginClassLoader extPathClassLoader = singleton.createPluginClassLoader(extPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Using ShenyuPluginClassLoader for loading</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // The main logic is to determine whether to implement ShenyuPlugin interface, PluginDataHandler interface, or identify annotations such as @ Component \ @ Service. If so, register as SpringBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Construct ShenyuLoaderResult object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    plugins.addAll(extPathClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Load the specified jar, with the same logic as loading all</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginJarParser.PluginJar pluginJar = PluginJarParser.parseJar(Base64.getDecoder().decode(uploadedJarResource.getPluginJar()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu upload plugin jar find new {} to load&quot;, pluginJar.getJarKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuPluginClassLoader uploadPluginClassLoader = singleton.createPluginClassLoader(pluginJar);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                plugins.addAll(uploadPluginClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Add the extended plugins to the plugin list of ShenyuWebHandler, and subsequent requests will go through the added plugin content</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            loaderPlugins(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;shenyu plugins load has error &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic processed by this method:</p><ol><li><p>Check if the parameter uploadedJarResource has a value. If not, all will be loaded. Otherwise, load the specified resource jar package for processing.</p></li><li><p>Retrieve the specified jar package from <code>shenyu. extPlugin. path</code> and encapsulate it as a PluginJar object, which contains the following information about the jar package:</p><ul><li><p>version: version information</p></li><li><p>groupId: The groupId of the package</p></li><li><p>artifactId: The artifactId of the package</p></li><li><p>absolutePath: Absolute path</p></li><li><p>clazzMap: Bytecode corresponding to class</p></li><li><p>resourceMap: Bytecode of jar package</p></li></ul></li><li><p>Create a corresponding ClassLoader using <code>ShenyuPluginClassloaderHolder</code>, with the corresponding class being &#x27;ShenyuPluginClassLoader&#x27;, and load the corresponding class accordingly.</p><ul><li>Call <code>ShenyuPluginClassLoader. loadUploadedJarPlugins</code> to load the corresponding class and register it as a Spring Bean, which can be managed using the Spring container</li></ul></li><li><p>Call the <code>loaderPlugins</code> method to update the extended plugin to&#x27;<code>webHandler</code> and <code>subscriber</code>.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="plugin-registration"></a>Plugin Registration<a class="hash-link" href="#plugin-registration" title="Direct link to heading">#</a></h2><p>For the content in the provided jar package, the loader will only handle classes of the specified interface type, and the implementation logic is in the <code>ShenyuPluginClassLoader.loadUploadedJarPlugins()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;ShenyuLoaderResult&gt; loadUploadedJarPlugins() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuLoaderResult&gt; results = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All class mapping relationships</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; names = pluginJar.getClazzMap().keySet();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Traverse all classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        names.forEach(className -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Try creating objects and, if possible, add them to the Spring container</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                instance = getOrCreateSpringBean(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(instance)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Building the ShenyuLoaderResult object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.add(buildResult(instance));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;The class successfully loaded into a upload-Jar-plugin {} is registered as a spring bean&quot;, className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ClassNotFoundException | IllegalAccessException | InstantiationException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.warn(&quot;Registering upload-Jar-plugins succeeds spring bean fails:{}&quot;, className, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This method is responsible for building all eligible objects and encapsulating them into a <code>ShenyuLoaderResult</code> object. This object is encapsulated for the created object and will be processed in the method <code>buildResult()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuLoaderResult buildResult(final Object instance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuLoaderResult result = new ShenyuLoaderResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Does the created object implement ShenyuPlugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (instance instanceof ShenyuPlugin) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setShenyuPlugin((ShenyuPlugin) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Does the created object implement PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (instance instanceof PluginDataHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setPluginDataHandler((PluginDataHandler) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Simultaneously enter the method <code>getOrCreatSpringBean()</code> for further analysis:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; T getOrCreateSpringBean(final String className) throws ClassNotFoundException, IllegalAccessException, InstantiationException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Confirm if it has been registered. If so, do not process it and return directly</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SpringBeanUtils.getInstance().existBean(className)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Double check,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            T inst = SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(inst)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Using ShenyuPluginClassLoader to load classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Class&lt;?&gt; clazz = Class.forName(className, false, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Exclude ShenyuPlugin subclass and PluginDataHandler subclass</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // without adding @Component @Service annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Confirm if it is a subclass of ShenyuPlugin or PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean next = ShenyuPlugin.class.isAssignableFrom(clazz)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || PluginDataHandler.class.isAssignableFrom(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If not, confirm if @ Component and @ Service annotations are identified</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Annotation[] annotations = clazz.getAnnotations();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    next = Arrays.stream(annotations).anyMatch(e -&gt; e.annotationType().equals(Component.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            || e.annotationType().equals(Service.class));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If the above content is met, register the bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    GenericBeanDefinition beanDefinition = new GenericBeanDefinition();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setBeanClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setAutowireCandidate(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Registering beans</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String beanName = SpringBeanUtils.getInstance().registerBean(beanDefinition, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // create object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inst = SpringBeanUtils.getInstance().getBeanByClassName(beanName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return inst;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic is roughly as follows:</p><ol><li>Check if the interface <code>ShenyuPlugin</code> or <code>PluginDataHandler</code> has been implemented. If not, check if <code>@Component</code> or <code>@Service</code> has been identified`.</li><li>If the condition of 1 is met, register the object in the Spring container and return the created object.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="sync-data"></a>Sync Data<a class="hash-link" href="#sync-data" title="Direct link to heading">#</a></h2><p>After the plugin registration is successful, the plugin is only instantiated, but it will not take effect yet because it has not been added to Shenyu&#x27;s plugin chain. The synchronization logic is implemented by the <code>loaderPlugins()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void loaderPlugins(final List&lt;ShenyuLoaderResult&gt; results) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get all objects that implement the interface ShenyuPlugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; shenyuExtendPlugins = results.stream().map(ShenyuLoaderResult::getShenyuPlugin).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Synchronize updating plugins in webHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        webHandler.putExtPlugins(shenyuExtendPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get all objects that implement the interface PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginDataHandler&gt; handlers = results.stream().map(ShenyuLoaderResult::getPluginDataHandler).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Synchronize updating handlers in subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscriber.putExtendPluginDataHandler(handlers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of this method processes two data points:</p><ol><li>Synchronize the data that implements the <code>ShenyuPlugin</code> interface to the plugins list of  <code>webHandler</code>.</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtPlugins(final List&lt;ShenyuPlugin&gt; extPlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(extPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Filter out newly added plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuAddPlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().noneMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Filter out updated plugins and determine if they have the same name as the old one, then it is an update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuUpdatePlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().anyMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If there is no data, skip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(shenyuAddPlugins) &amp;&amp; CollectionUtils.isEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Copy old data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // copy new list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; newPluginList = new ArrayList&lt;&gt;(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add new plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add extend plugin from pluginData or shenyu ext-lib</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sourcePlugins.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add new data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuAddPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuAddPlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto add extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newPluginList.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Modify updated data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuUpdatePlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto update extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ShenyuPlugin updatePlugin : shenyuUpdatePlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; newPluginList.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (newPluginList.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        newPluginList.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; this.sourcePlugins.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (this.sourcePlugins.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.sourcePlugins.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // REORDER</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        plugins = sortPlugins(newPluginList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li>Synchronize the data that implements the <code>PluginDataHandler</code> interface to the handlers list of the <code>subscriber</code>.</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtendPluginDataHandler(final List&lt;PluginDataHandler&gt; handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(handlers)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Traverse all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (PluginDataHandler handler : handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String pluginNamed = handler.pluginNamed();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update existing PluginDataHandler list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MapUtils.computeIfAbsent(handlerMap, pluginNamed, name -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu auto add extends plugin data handler name is :{}&quot;, pluginNamed);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, the analysis of the loading process of the extension plugin is completed.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/blog/tags/ext">ext</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Extension plugin loading logic" href="/blog/Loader-SourceCode-Analysis-ExtLoader"><b>Read More</b></a></div></footer></article></main></div></div></div></div>
<script src="/assets/js/runtime~main.1a6efc0b.js"></script>
<script src="/assets/js/main.c24cd29a.js"></script>
</body>
</html>