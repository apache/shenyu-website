<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Blog | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Blog | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//blog/page/2"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//blog/page/2"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/page/2" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.6bd5fa92.css">
<link rel="preload" href="/assets/js/runtime~main.2e9d71d1.js" as="script">
<link rel="preload" href="/assets/js/main.95312033.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/document">Docs</a><a class="navbar__item navbar__link" href="/community/contributor-guide">Community</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/event">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeper Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-21T03:49:52.511Z">July 21, 2023</time> ¬∑ 18 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>etcd</code> and <code>Consul</code>. The main content of this article is based on <code>WebSocket</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-zookeeper"></a>1. About ZooKeeper<a class="hash-link" href="#1-about-zookeeper" title="Direct link to heading">#</a></h3><p>Apache ZooKeeper is a software project of the Apache Software Foundation that provides open source distributed configuration services, synchronization services, and naming registries for large-scale distributed computing. ZooKeeper nodes store their data in a hierarchical namespace, much like a file system or a prefix tree structure. Clients can read and write on nodes and thus have a shared configuration service in this way.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>We traced the source code from a real case, such as updating a selector data in the <code>Divide</code> plugin to a weight of 90 in a background administration system:</p><p><img src="/assets/images/update-selector-en-4efb58e488bd424a54213d31929d7eb1.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-data"></a>2.1 Accept Data<a class="hash-link" href="#21-accept-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set the current selector data ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>Ôºö</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: <code>APP_AUTH</code>, <code>PLUGIN</code>, <code>RULE</code>, <code>SELECTOR</code> and <code>META_DATA</code>.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket;</li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper;</li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>Ôºödata synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>Ôºödata synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>Ôºödata synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>zookeeper</code> data synchronization source code analysis, so here to <code>ZookeeperDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data Sync Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * By springboot conditional assembly</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * zookeeper data sunc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Zookeeper listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)  // The condition property is loaded only when it is met</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(ZookeeperConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class ZookeeperListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener zookeeperDataChangedListener(final ZkClient zkClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataChangedListener(zkClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Zookeeper data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the zookeeper data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ZookeeperDataInit zookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataInit(zkClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // other code is omitted......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the SpringBoot conditional assembly class. The ZookeeperListener class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>ZooKeeper</code> is used for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     zookeeper:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          sessionTimeout: 5000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          connectionTimeout: 2000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(ZookeeperConfiguration.class)</code>Ôºöimport <code>ZookeeperConfiguration</code>;</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  @EnableConfigurationProperties(ZookeeperProperties.class)  // enable zookeeper properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public class ZookeeperConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register zkClient in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zookeeperProp the zookeeper configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ZkClient {@linkplain ZkClient}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @ConditionalOnMissingBean(ZkClient.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      public ZkClient zkClient(final ZookeeperProperties zookeeperProp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ZkClient(zookeeperProp.getUrl(), zookeeperProp.getSessionTimeout(), zookeeperProp.getConnectionTimeout()); // ËØªÂèñzkÈÖçÁΩÆ‰ø°ÊÅØÔºåÂπ∂ÂàõÂª∫zkClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.zookeeper&quot;) // zookeeper properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When we take the initiative to configuration, use the <code>zookeeper</code> data synchronization, <code>zookeeperDataChangedListener</code> is generated. So in the event handler <code>onApplicationEvent()</code>, it goes to the corresponding <code>listener</code>. In our case, it is a selector data update, data synchronization is <code>zookeeper</code>, so, the code will enter the <code>ZookeeperDataChangedListener</code> selector data change process.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // what kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // other code logic is omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // In our case, will enter the ZookeeperDataChangedListener selector data change process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-zookeeper-data-changed-listener"></a>2.4 Zookeeper Data Changed Listener<a class="hash-link" href="#24-zookeeper-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>ZookeeperDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, determine the type of action, whether to refresh synchronization or update or create synchronization. Determine whether the node is in <code>zk</code> based on the current selector data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * use ZooKeeper to publish change data</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The selector information changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // refresh</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            deleteZkPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // changed data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // build selector real path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                deleteZkPath(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // selector parent path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(data.getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create parent node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createZkNode(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert or update data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            insertZkNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create zk node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void createZkNode(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create only if it does not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(path, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // insert zk node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void insertZkNode(final String path, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create zk node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        createZkNode(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // write data by zkClient </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.writeData(path, null == data ? &quot;&quot; : GsonUtils.getInstance().toJson(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As long as the changed data is correctly written to the <code>zk</code> node, the <code>admin</code> side of the operation is complete. <code>ShenYu</code> uses <code>zk</code> for data synchronization, <code>zk</code> nodes are carefully designed.</p><p>In our current case, updating one of the selector data in the <code>Divide</code> plugin with a weight of 90 updates specific nodes in the graph.</p><p><img src="/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>We series the above update flow with a sequence diagram.</p><p><img src="/assets/images/zk-sync-sequence-admin-en-ae0fe50fed54ce6e1d66a9a0ca5ff6b7.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume that the ShenYu gateway is already running properly, and the data synchronization mode is also <code>Zookeeper</code>. How does the gateway receive and process the selector data after updating it on the admin side and sending the changed data to ZK? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-zkclient-accept-data"></a>3.1 ZkClient Accept Data<a class="hash-link" href="#31-zkclient-accept-data" title="Direct link to heading">#</a></h4><ul><li>ZkClient.subscribeDataChanges()</li></ul><p>There is a <code>ZookeeperSyncDataService</code> class on the gateway, which subscribing to the data node through <code>ZkClient</code> and can sense when the data changes.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ZookeeperSyncDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // zkClient subscribe data </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(path, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cacheSelectorData(GsonUtils.getInstance().fromJson(data.toString(), SelectorData.class)); // zk node data changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                unCacheSelectorData(dataPath);  // zk node data deleted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ZooKeeper&#x27;s  <code>Watch</code> mechanism notifies subscribing clients of node changes. In our case, updating the selector information goes to the <code>handleDataChange()</code> method. <code>cacheSelectorData()</code> is used to process data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-handle-data"></a>3.2 Handle Data<a class="hash-link" href="#32-handle-data" title="Direct link to heading">#</a></h4><ul><li>ZookeeperSyncDataService.cacheSelectorData()</li></ul><p>The data is not null, and caching the selector data is again handled by <code>PluginDataSubscriber</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code> is an interface, it is only a <code>CommonPluginDataSubscriber</code> implementation class, responsible for data processing plugin, selector and rules.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-common-plugin-data-subscriber"></a>3.3 Common Plugin Data Subscriber<a class="hash-link" href="#33-common-plugin-data-subscriber" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-data-cached-to-memory"></a>3.4 Data cached to Memory<a class="hash-link" href="#34-data-cached-to-memory" title="Direct link to heading">#</a></h4><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracking, and through a practical case, in the <code>admin</code> end to update a selector data, the <code>ZooKeeper</code> data synchronization process analysis is clear.</p><p>Let&#x27;s series the data synchronization process on the gateway side through the sequence diagram:</p><p><img src="/assets/images/zk-sync-sequence-gateway-en-b061b46cd625eef35e95dd0b3eb20a27.png"></p><p>The data synchronization process has been analyzed. In order to prevent the synchronization process from being interrupted, other logic is ignored during the analysis. We also need to analyze the process of Admin synchronization data initialization and gateway synchronization operation initialization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin-data-sync--initialization"></a>4. Admin Data Sync  initialization<a class="hash-link" href="#4-admin-data-sync--initialization" title="Direct link to heading">#</a></h3><p>When <code>admin</code> starts, the current data will be fully synchronized to <code>zk</code>, the implementation logic is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Zookeeper data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ZkClient zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine whether data exists in zk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath) &amp;&amp; !zkClient.exists(authPath) &amp;&amp; !zkClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check whether there is data in <code>zk</code>, if not, then synchronize.</p><p><code>ZookeeperDataInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>SpringBoot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> initializations and is often used for initialization operations in a project.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, and then perform full data synchronization, all authentication information, plugin information, selector information, rule information, and metadata information. Synchronous events are published primarily through <code>eventPublisher</code>. After publishing the event via <code>publishEvent()</code>, the <code>ApplicationListener</code> performs the event change operation. In <code>ShenYu</code> is mentioned in <code>DataChangedEventDispatcher</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * sync all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-gateway-data-sync-init"></a>5. Gateway Data Sync Init<a class="hash-link" href="#5-gateway-data-sync-init" title="Direct link to heading">#</a></h3><p>The initial operation of data synchronization on the gateway side is mainly the node in the subscription <code>zk</code>. When there is a data change, the changed data will be received. This relies on the <code>Watch</code> mechanism of <code>ZooKeeper</code>. In <code>ShenYu</code>, the one responsible for <code>zk</code> data synchronization is <code>ZookeeperSyncDataService</code>, also mentioned earlier.</p><p>The function logic of <code>ZookeeperSyncDataService</code> is completed in the process of instantiation: the subscription to <code>Shenyu</code> data synchronization node in <code>zk</code> is completed. Subscription here is divided into two kinds, one kind is existing node data updated above, through this <code>zkClient.subscribeDataChanges()</code> method; Another kind is under the current node, add or delete nodes change namely child nodes, it through <code>zkClient.subscribeChildChanges()</code> method.</p><p><code>ZookeeperSyncDataService</code> code is a bit too much, here we use plugin data read and subscribe to track, other types of data operation principle is the same.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *  zookeeper sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // At instantiation time, the data is read from the ZK and the node is subscribed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperSyncDataService(/* omit the construction argument */ ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch plugin, selector and rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin node path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // all plugin nodes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; pluginZKs = zkClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // watch plugin, selector, rule data node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //subscribing to child nodes (adding or removing a plugin)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeChildChanges(pluginParent, (parentPath, currentChildren) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isNotEmpty(currentChildren)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (String pluginName : currentChildren) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // you need to subscribe to all plugin, selector, and rule data for the child node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create if not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(pluginPath, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read the current node data on zk and deserialize it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = null == zkClient.readData(pluginPath) ? null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : GsonUtils.getInstance().fromJson((String) zkClient.readData(pluginPath), PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // cached into gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // subscribe plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private void cachePluginData(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //omit implementation logic, is actually the CommonPluginDataSubscriber operation, can connect with the front</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // subscribe data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(pluginPath, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {  // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                 //omit implementation logic, is actually the CommonPluginDataSubscriber operation, can connect with the front</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {   // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  // Omit implementation logic, is actually the CommonPluginDataSubscriber operation, can connect with the front</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above source code is given comments, I believe you can understand. The main logic for subscribing to plug-in data is as follows:</p><blockquote><ol><li>Create the current plugin path</li><li>Create a path if it does not exist</li><li>Read the current node data on zK and deserialize it</li><li>The plugin data is cached in the gateway memory</li><li>Subscribe to the plug-in node</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-summary"></a>6. Summary<a class="hash-link" href="#6-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, <code>Zookeeper</code> data synchronization principle source code analysis. The main knowledge points involved are as follows:</p><ul><li><p>Data synchronization based on <code>ZooKeeper</code> is mainly implemented through <code>watch</code> mechanism;</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of <code>SpringBoot</code> and <code>starter</code> loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/zookeeper">zookeeper</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Code Analysis For Context-Path Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-21T03:49:52.511Z">July 21, 2023</time> ¬∑ 3 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>Before starting, you can refer to <a href="/blog/page/start-demo">this article</a> to start the gateway</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="body"></a>Body<a class="hash-link" href="#body" title="Direct link to heading">#</a></h3><p>First, look at the <code>ContextPathPlugin#doExecute</code> method, which is the core of this plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. get the contextMappingHandle from the JVM cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ContextMappingHandle contextMappingHandle = ContextPathPluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. set shenyu context according to contextMappingHandle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    buildContextPath(shenyuContext, contextMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li><p>Get the <code>contextMappingHandle</code> from the JVM cache</p><p>The <code>contextMappingHandle</code> here is an instance of the <code>ContextMappingHandle</code> class, which has two member variables: <code>contextPath</code> and <code>addPrefix</code></p><p>These two variables have appeared in the Rules form in the Admin before, and they are updated when the data is synchronized.</p></li><li><p>Set shenyu context according to contextMappingHandle</p><p>Below is the source code of the <code>ContextPathPlugin#buildContextPath</code> method</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void buildContextPath(final ShenyuContext context, final ContextMappingHandle handle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String realURI = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. set the context path of shenyu, remove the prefix of the real URI according to the length of the contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNoneBlank(handle.getContextPath())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setContextPath(handle.getContextPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setModule(handle.getContextPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        realURI = context.getPath().substring(handle.getContextPath().length());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // add prefix</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNoneBlank(handle.getAddPrefix())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(realURI)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            realURI = handle.getAddPrefix() + realURI;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            realURI = handle.getAddPrefix() + context.getPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.setRealUrl(realURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>Set the context path of shenyu, <strong>remove the prefix of the real URI according to the length of the contextPath</strong></p><p>You may be wondering whether <strong>there is a problem with the so-called &quot;according to the length of the contextPath&quot; here</strong>?</p><p>In fact, such a judgment is not a problem, because the request will be processed by the plugin only after it is matched by the Selector and Rules. Therefore, under the premise of setting up Selector and Rules, it is completely possible to meet the needs of converting a specific contextPath.</p></li></ul></li></ol><p>Then, the <code>ContextPathPlugin</code> class has a more important method <code>skip</code>, part of the code is shown below. We can find: <strong>If it is a call to the RPC service, the context_path plugin will be skipped directly.</strong></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Boolean skip(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Objects.equals(rpcType, RpcTypeEnum.DUBBO.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.GRPC.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.TARS.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.MOTAN.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.SOFA.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, the context-path plugin has another class <code>ContextPathPluginDataHandler</code>. The function of this class is to subscribe to the data of the plug-in. When the plugin configuration is modified, deleted, or added, the data is modified, deleted, or added to the JVM cache.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/context-path">Context-Path</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/IntegrationTest-Analysis">Integration Test Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-21T03:49:52.511Z">July 21, 2023</time> ¬∑ 7 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>This article will provide an in-depth analysis of Apache ShenYu&#x27;s integration tests.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-are-integration-tests"></a>What are integration tests?<a class="hash-link" href="#what-are-integration-tests" title="Direct link to heading">#</a></h3><p>Integration testing is also called E2E (End To End) testing in some projects. It is mainly used to test whether each module can meet expectations after being assembled into a system.</p><p>Apache ShenYu puts integration tests in continuous integration, using GitHub Actions to trigger each time a Pull Request or Merge is submitted to the main branch. This can greatly reduce the maintenance cost of the project and improve the stability of Apache ShenYu.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-automate-integration-testing"></a>How to automate integration testing?<a class="hash-link" href="#how-to-automate-integration-testing" title="Direct link to heading">#</a></h3><p>In Apache ShenYu, the main steps of integration testing are embodied in the script of the GitHub Action workflow, as shown below, which is located at <a href="https://github.com/apache/shenyu/tree/master/.github/workflows" target="_blank" rel="noopener noreferrer">~/.github/workflows</a> directory.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> it</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> master</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matrix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alibaba</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Next, I will start from this yaml file and take you to analyze the entire process of automated integration testing.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="triggering-the-workflow"></a>Triggering the workflow<a class="hash-link" href="#triggering-the-workflow" title="Direct link to heading">#</a></h3><p>Since we specified <code>pull_request</code> and <code>push.branch: master</code> in <code>on</code>, this workflow will be triggered when we submit pull_request or merge branch to master (push).</p><p>For more usage of GitHub Action, you can refer to the documentation of <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreferrer">GitHub Action</a>, which will not be introduced in detail here.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="initialize-the-environment"></a>Initialize the environment<a class="hash-link" href="#initialize-the-environment" title="Direct link to heading">#</a></h3><ul><li>pull code</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>set skip flag</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set Skip Env Var</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./.github/actions/skip</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ci</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When something unrelated to functionality occurs (such as changing documentation), integration tests are skipped to save resources.</p><ul><li>Cache maven repos, install Java</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cache Maven Repos</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="build-the-entire-project-while-building-the-docker-image"></a>Build the entire project while building the docker image<a class="hash-link" href="#build-the-entire-project-while-building-the-docker-image" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">./mvnw -B clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Prelease,docker -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Dmaven.test.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the above command, -P is followed by <code>release,docker</code>, which means that the relevant profile configuration in the pom file will be activated.</p><p>The two profiles, release and docker, currently only exist in several submodules under <code>shenyu-dist</code>. The following will take the <a href="https://github.com/apache/shenyu/tree/master/shenyu-dist/shenyu-admin-dist" target="_blank" rel="noopener noreferrer">shenyu-dist-admin</a> module as an example to introduce profiles as release and docker The specific content of the configuration. Also, integration tests only use the <code>shenyu-admin</code> image built in this step.</p><ul><li><p>First is release</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">release</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.maven.plugins</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven-assembly-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">package</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">single</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.basedir}/src/main/assembly/binary.xml</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">posix</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When -P is followed by release, the above <code>maven-assembly-plugin</code> plugin is activated. In executions, the execution timing of the plugin is bound to the maven life cycle package, which means that it will be triggered when we execute <code>mvn install</code>.</p><p>The <code>binary.xml</code> we wrote is specified in the configuration, and the <code>maven-assembly-plugin</code> plugin will copy the required files and package them according to this file. You can click the link to view the file: [shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml](<a href="https://github.com/apache/shenyu/blob/master/shenyu-" target="_blank" rel="noopener noreferrer">https://github.com/apache/shenyu/blob/master/shenyu-</a> dist/shenyu-admin-dist/src/main/assembly/binary.xml)</p><p>According to this file, the plugin will &quot;copy&quot; the packaged jar packages, configuration files, startup scripts, etc. under other modules, and finally make them into a compressed package in <code>tar.gz</code> format.</p></li><li><p>then docker</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">docker</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.spotify</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dockerfile-maven-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${dockerfile-maven-plugin.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-version</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache/shenyu-admin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}-admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Similar to the release above, here is the activation of the <code>dockerfile-maven-plugin</code> plugin. When <code>mvn install -Pdocker</code>, the plugin will use the dockerfile we wrote to build the docker image.</p></li></ul><p>It should be noted that the dockerfile-maven-plugin currently has limited support for aarch64 architecture devices, and the following error will occur when running the plugin on aarch64 architecture machines. And when I wrote this article, it has not been maintained for a long time, which means that the problem of aarch64 architecture devices using this plugin will not be solved in the short term.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Failed to execute goal com.spotify:dockerfile-maven-plugin:1.4.6:build </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tag-latest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> on project shenyu-admin-dist: Could not build image: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: java.lang.UnsatisfiedLinkError: could not load FFI provider jnr.ffi.provider.jffi.Provider: ExceptionInInitializerError: Can&#x27;t overwrite cause with java.lang.UnsatisfiedLinkError: java.lang.UnsatisfiedLinkError: /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: dlopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib, </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: no suitable image found.  Did find:</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here is a temporary solution:</p><ol><li><p>Open a new shell, enter the following command, and use socat to route the unix socket to the tcp port</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">socat TCP-LISTEN:2375,range</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1/32,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>Set environment variables</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">DOCKER_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tcp://127.0.0.1:2375</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="build-the-examples-module"></a>Build the examples module<a class="hash-link" href="#build-the-examples-module" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build examples</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pexample </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.javadoc.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.test.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Considering the need for release, the current pom file in the project root directory does not contain the example submodule, so the examples module is additionally built in the above step.</p><p>Similar to the above, this line of command will also use the maven plugin to build an image for our subsequent docker orchestration.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="build-custom-gateways"></a>Build custom gateways<a class="hash-link" href="#build-custom-gateways" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build integrated tests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">DskipTests </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In order to subdivide the integration tests of different functions of Apache ShenYu, we will build a gateway customized by the integration test module in this step. The so-called &quot;customization&quot; is to introduce the minimum required dependencies in the pom file, and then replace the default <code>shenyu-bootstrap</code>. Similar to the above two steps, this step will also build the docker image.</p><p>It is worth noting that the way of packaging and building here is slightly different from that of the <code>shenyu-dist</code> module, which you can find by comparing the pom file.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="run-docker-compose"></a>Run docker compose<a class="hash-link" href="#run-docker-compose" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Start docker compose</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose.yml up </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">d</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this step, docker will be arranged according to the different <code>docker-compose.yml</code> files written under the integration test module.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3.9&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-zk</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">6.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpine</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">redis</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-examples-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2048M</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-integrated-test-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">condition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service_healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">healthcheck</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CMD&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;wget&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://shenyu-integrated-test-http:9195/actuator/health&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">retries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example, the <code>docker-compose.yml</code> under the <code>shenyu-integrated-test-http</code> module starts zookeeper, redis, example, admin, gateway and other services in sequence. Among them, the mirrors of example, admin, and gateway are built by us before.</p><p>Among them, docker-compose uses depends_on to determine the topological relationship between services, and most services have corresponding health checks, and the next service will not be started until the health check passes.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="run-the-health-check-and-wait-for-docker-compose-to-start"></a>Run the health check and wait for docker-compose to start<a class="hash-link" href="#run-the-health-check-and-wait-for-docker-compose-to-start" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Wait for docker compose start up completely</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/script/healthcheck.sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this step, the host will run the <code>healthcheck.sh</code> script, and then use the curl command to access the health status interface <code>/actuator/health</code> of each service list (in the services.list file), until the service status is normal. will continue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="run-tests"></a>run tests<a class="hash-link" href="#run-tests" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw test </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/pom.xml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">continue-on-error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This step is to use the maven test command to execute the test classes in the <code>/src/test/</code> directory one by one.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="view-docker-compose-logs"></a>View Docker Compose logs<a class="hash-link" href="#view-docker-compose-logs" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Check test result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    docker-compose -f ./shenyu-integrated-test/${{ matrix.case }}/docker-compose.yml logs --tail=&quot;all&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    if [[ ${{steps.test.outcome}} == &quot;failure&quot; ]]; then</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Failed&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 1</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    else</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Successful&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 0</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    fi</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is an error in the workflow, the log of docker compose can help us to better troubleshoot the problem, so in this step, we will print the log of docker compose.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/integration-test">Integration Test</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Divide-Plugin">Code Analysis For Divide Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-21T03:49:52.511Z">July 21, 2023</time> ¬∑ 21 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>The <code>ShenYu</code> gateway uses the <code>divide</code> plugin to handle <code>http</code> requests. You can see the official documentation <a href="https://shenyu.apache.org/docs/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Quick start with Http</a> to learn how to use this plugin.</p><blockquote><p>This article is based on <code>shenyu-2.4.3</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/docs/user-guide/http-proxy" target="_blank" rel="noopener noreferrer">Http Proxy</a> for the introduction of the official website.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-register-service"></a>1. Register Service<a class="hash-link" href="#1-register-service" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--declaration-of-registration-interface"></a>1.1  Declaration of registration interface<a class="hash-link" href="#11--declaration-of-registration-interface" title="Direct link to heading">#</a></h4><p>Use the annotation <code>@ShenyuSpringMvcClient</code> to register the service to the gateway. The simple <code>demo</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)  // API</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/findById&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/findById&quot;, desc = &quot;Find by id&quot;) // method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO findById(@RequestParam(&quot;id&quot;) final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return build(id, &quot;hello world findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>define annotation:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //desc info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //is enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //register MetaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-scan-annotation"></a>1.2 Scan annotation<a class="hash-link" href="#12-scan-annotation" title="Direct link to heading">#</a></h4><p>Annotation scanning is done through <code>SpringMvcClientBeanPostProcessor</code>, which implements the <code>BeanPostProcessor</code> interface and is a post-processor provided by <code>Spring</code>.</p><p>During constructor instantiation.</p><ul><li>Read the property configuration</li><li>Add annotations, read <code>path</code> information</li><li>Start the registry and register with <code>shenyu-admin</code></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientBeanPostProcessor implements BeanPostProcessor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Constructor instantiation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientBeanPostProcessor(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. read Properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;http register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. add annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PostMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(GetMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(DeleteMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PutMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. start register cneter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // override post process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>SpringMvcClientBeanPostProcessor#postProcessAfterInitialization()</li></ul><p>Rewrite post-processor logic: read annotation information, construct metadata objects and <code>URI</code> objects, and register them with <code>shenyu-admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. If the all service is registered or is not a Controller class, it is not handled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull) || !hasAnnotation(bean.getClass(), Controller.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Read the annotations on the class ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuSpringMvcClient beanShenyuClient = AnnotationUtils.findAnnotation(bean.getClass(), ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1 build  superPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.2 whether to register the entire class method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // build the metadata object and register it with shenyu-admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(beanShenyuClient, pathJoin(contextPath, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. read all methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3.1 read the annotations on the method ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuSpringMvcClient methodShenyuClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If there is no annotation on the method, use the annotation on the class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // 3.2 Build path information, build metadata objects, register with shenyu-admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(methodShenyuClient, buildApiPath(method, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><ol><li>If you are registering the whole service or not <code>Controller</code> class, do not handle it</li></ol></li><li><ol start="2"><li>read the annotation on the class <code>ShenyuSpringMvcClient</code>, if the whole class is registered, build the metadata object here and register it with <code>shenyu-admin</code>.</li></ol></li><li><ol start="3"><li>Annotation on the handler method <code>ShenyuSpringMvcClient</code>, build <code>path</code> information for the specific method, build the metadata object and then register it with <code>shenyu-admin</code></li></ol></li></ul><p>There are two methods here that take <code>path</code> and need special instructions.</p><ul><li>buildApiSuperPath()</li></ul><p>Construct <code>SuperPath</code>: first take the <code>path</code> property from the annotation <code>ShenyuSpringMvcClient</code> on the class, if not, take the <code>path</code> information from the <code>RequestMapping</code> annotation on the current class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiSuperPath(@NonNull final Class&lt;?&gt; method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // First take the path property from the annotation ShenyuSpringMvcClient on the class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return shenyuSpringMvcClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Take the path information from the RequestMapping annotation of the current class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>buildApiPath()</li></ul><p>Build <code>path</code>: first read the annotation <code>ShenyuSpringMvcClient</code> on the method and build it if it exists; otherwise get the <code>path</code> information from other annotations on the method; complete <code>path = contextPath(context information) + superPath(class information) + methodPath(method information)</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiPath(@NonNull final Method method, @NonNull final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Read the annotation ShenyuSpringMvcClient on the method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.1 If path exists, build</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //1.2  path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, shenyuSpringMvcClient.path());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Get path information from other annotations on the method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String path = getPathByMethod(method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // 2.1 path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return pathJoin(contextPath, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>getPathByMethod()</li></ul><p>Get <code>path</code> information from other annotations on the method, other annotations include.</p><ul><li>ShenyuSpringMvcClient</li><li>PostMapping</li><li>GetMapping</li><li>DeleteMapping</li><li>PutMapping</li><li>RequestMapping</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getPathByMethod(@NonNull final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through interface annotations to get path information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class&lt;? extends Annotation&gt; mapping : mappingAnnotation) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String pathByAnnotation = getPathByAnnotation(AnnotationUtils.findAnnotation(method, mapping), pathAttributeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(pathByAnnotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return pathByAnnotation;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After the scanning annotation is finished, construct the metadata object and send the object to <code>shenyu-admin</code> to complete the registration.</p><ul><li>Metadata </li></ul><p>Includes the rule information of the currently registered method: contextPath, appName, registration path, description information, registration type, whether it is enabled, rule name and whether to register metadata.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private MetaDataRegisterDTO buildMetaDataDTO(@NonNull final ShenyuSpringMvcClient shenyuSpringMvcClient, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path) // Registered path, used when gateway rules match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(shenyuSpringMvcClient.desc()) // desc info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.HTTP.getName()) // divide plugin, http type when default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuSpringMvcClient.enabled()) // is enabled?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(StringUtils.defaultIfBlank(shenyuSpringMvcClient.ruleName(), path))//rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .registerMetaData(shenyuSpringMvcClient.registerMetaData()) // whether to register metadata information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The specific registration logic is implemented by the registration center, which has been analyzed in the previous articles and will not be analyzed in depth here.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-register-uri-data"></a>1.3 Register URI Data<a class="hash-link" href="#13-register-uri-data" title="Direct link to heading">#</a></h4><p><code>ContextRegisterListener</code> is responsible for registering the client&#x27;s <code>URI</code> information to <code>shenyu-admin</code>, it implements the <code>ApplicationListener</code> interface, when the context refresh event <code>ContextRefreshedEvent</code> occurs, the <code>onApplicationEvent()</code> method is executed to implement the registration logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ContextRegisterListener implements ApplicationListener&lt;ContextRefreshedEvent&gt;, BeanFactoryAware {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Constructor instantiation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ContextRegisterListener(final PropertiesConfig clientConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read Properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String errorMsg = &quot;http register param must config the contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = Integer.parseInt(Optional.ofNullable(props.getProperty(ShenyuClientConstants.PORT)).orElseGet(() -&gt; &quot;-1&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execute application events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // The method is guaranteed to be executed once</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. If you are registering for the entire service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Build metadata and register</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // get port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final int mergedPort = port &lt;= 0 ? PortUtils.findPort(beanFactory) : port;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. Constructing URI data and registering</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(mergedPort));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage() + &quot;please config ${shenyu.client.http.props.port} in xml/yml !&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // build URI data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private URIRegisterDTO buildURIRegisterDTO(final int port) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(this.contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .protocol(protocol) // protocol</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .host(IpUtils.isCompleteHost(this.host) ? this.host : IpUtils.getHost(this.host)) //host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .port(port) // port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName()) // divide plugin, default registration http type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // build MetaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .path(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ruleName(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="14-handle-registration-information"></a>1.4 Handle registration information<a class="hash-link" href="#14-handle-registration-information" title="Direct link to heading">#</a></h4><p>The metadata and <code>URI</code> data registered by the client through the registry are processed in <code>shenyu-admin</code>, which is responsible for storing to the database and synchronizing to the <code>shenyu</code> gateway. The client registration processing logic of <code>Divide</code> plugin is in <code>ShenyuClientRegisterDivideServiceImpl</code>. The inheritance relationship is as follows.</p><p><img src="/assets/images/ShenyuClientRegisterDivideServiceImpl-4d9351b1efbb545cde2a3a172e35f59c.png"></p><ul><li>ShenyuClientRegisterService: client registration service, top-level interface.</li><li>FallbackShenyuClientRegisterService: registration failure, provides retry operation.</li><li>AbstractShenyuClientRegisterServiceImpl: abstract class, implements part of the public registration logic;</li><li>AbstractContextPathRegisterService: abstract class, responsible for registering <code>ContextPath</code>.</li><li>ShenyuClientRegisterDivideServiceImpl: implementation of the <code>Divide</code> plug-in registration.</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="141-register-service"></a>1.4.1 Register Service<a class="hash-link" href="#141-register-service" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</li></ul><p>The metadata <code>MetaDataRegisterDTO</code> object registered by the client through the registry is picked up and dropped in the <code>register()</code> method of <code>shenyu-admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadat</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1411-register-selector"></a>1.4.1.1 Register Selector<a class="hash-link" href="#1411-register-selector" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>Build <code>contextPath</code>, find if the selector information exists, if it does, return <code>id</code>; if it doesn&#x27;t, create the default selector information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Find if selector information exists by name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a default selector message if it does not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Default Selector Information</li></ul><p>Construct the default selector information and its conditional properties here.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build selector </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //register default Selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //build</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //build the conditional properties of the default selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build Default Selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // default CUSTOM_FLOW</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //default  AND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) //default 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build default selector conditional properties</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // default URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // default match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // default /contextPath/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Register default selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector condition  info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert selector information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // insert selector condition information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Publish synchronization events to synchronize selection information and its conditional attributes to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1412-register-rule"></a>1.4.1.2 Register Rule<a class="hash-link" href="#1412-register-rule" title="Direct link to heading">#</a></h6><p>In the second step of registering the service, start building the default rules and then register the rules.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default rule handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register Metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>default rule handle</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default rule handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DivideRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Divide</code> plugin default rule handle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DivideRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * load balance: default RANDOM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadBalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * retry strategy: default CURRENT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String retryStrategy = RetryEnum.CURRENT.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * retry: default 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int retry = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  retry: default 3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  retry: default  10240 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long headerMaxSize = Constants.HEADER_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  retry: default 102400 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long requestMaxSize = Constants.REQUEST_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>build default rule info</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // build default rule info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  build default rule info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId) //selector Id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) //rule Name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) // default and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) // default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1) //default 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) // default URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //if the path conatins *, default match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // default = </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>Registration rules: insert records to the database and publish events to the gateway for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert rule into database </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //insert rule condition into database </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());           </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish events to the gateway for data synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1413-register-metadata"></a>1.4.1.3 Register Metadata<a class="hash-link" href="#1413-register-metadata" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDivideServiceImpl#registerMetadata()</li></ul><p>Insert or update metadata and then publish sync events to the gateway.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dto.isRegisterMetaData()) { </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // save or update MetaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event to  gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1414-register-contextpath"></a>1.4.1.4 Register ContextPath<a class="hash-link" href="#1414-register-contextpath" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractContextPathRegisterService#registerContextPath()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerContextPath(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set contextPath for selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPathSelectorId = getSelectorService().registerDefault(dto, PluginEnum.CONTEXT_PATH.getName(), &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ContextMappingRuleHandle handle = new ContextMappingRuleHandle();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handle.setContextPath(PathUtils.decoratorContextPath(dto.getContextPath()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set contextPath for rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getRuleService().registerDefault(buildContextPathDefaultRuleDTO(contextPathSelectorId, dto, handle.toJson()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="142-register-uri"></a>1.4.2 Register URI<a class="hash-link" href="#142-register-uri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>The server side receives the <code>URI</code> information registered by the client and processes it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Retry after registration failure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>Get a valid <code>URI</code> from the <code>URI</code> registered by the client, update the corresponding selector <code>handle</code> property, and send a selector update event to the gateway.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get selector </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // gte valid URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update the handle property of the selector to the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Send selector update events to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The source code analysis on service registration is completed as well as the analysis flow chart is as follows.</p><p><img src="/assets/images/divide-register-zh-0697d4849e6ae1dbd2f15a0fd528cd32.png"></p><p>The next step is to analyze how the <code>divide</code> plugin initiates a call to the <code>http</code> service based on this information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-call-http-service"></a>2. Call Http Service<a class="hash-link" href="#2-call-http-service" title="Direct link to heading">#</a></h3><p>The <code>divide</code> plugin is the core processing plugin used by the gateway to handle <code>http protocol</code> requests.</p><p>Take the case provided on the official website <a href="https://shenyu.apache.org/docs/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Quick start with Http</a> as an example, a direct connection request is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:8189/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After proxying through the <code>ShenYu</code> gateway, the request is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/http/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The services proxied by the <code>ShenYu</code> gateway are still able to request the previous services, where the <code>divide</code> plugin comes into play. The class inheritance relationship is as follows.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAGoCAIAAAB0UFO8AAAACXBIWXMAAB2HAAAdhwGP5fFlAAAgAElEQVR42u2d3ZfbRJqH59/ZEzLbsJCAp+3uzhchBAwmgkzmsz07aJpZDwPj7IbgkJAYw5yFHQeyNHhgLvoqc9V3PefsXmf+o9nrLVm2VJKqSiVZsmX5+R2dnO6O7JLen97Hr0pV5R+cKkKNqU4tXVtT0W7Zwl/8Jc4ltfsDLKRd/MVf/AXBWEiK4i/+gmAspF38xV/iDIKxkBTFX/wFwVhIu/iLv8QZBGMhKUq7+AuCsZAUJc74S5xBMBaSorSLvyAYC0lR4oy/xBkE0y4pSrv4C4KxkBQlzvhLnEEw7ZKitIu/IBgLSVHijL/EGQTTLv7SLv6CYCwkRYkz/uIvCKZd/KVd/AXBWEiKEmf8BcFYSLv4i7/EGQRjISmKv/gLgrGQdvEXf4kzCMZCUpR28RcEYyEpSpzxlziDYCwkRWkXf0EwFpKixBl/iTMIxkJSlHbxd40R3EAIIbQibTSCbyGElqtOpyOX3mijOyLEBXFwcHADIVS+RK7JCKYjgr5gD8HiythGCJUvkWsgGASDYIRAMAgGwQiBYBAMgkEwQiAYBINghEAwCAbBCCEQDIJBMEIgGASDYIQQCAbBIBghEAyCQTBCCASDYBCMEAgGwSAYIQSCQfCSEbx3pXl5v3X1vVb79k7n/q7YxA/iV/FH8V8kG0IgGASXguDz15rtD3be+GTXsIkdxG6kHEIgGAQXhuCdi9uv3kyBr7yJncVL6qf24Pivf/u72A4HDlhZx9A1Gk5/fHw4HnY7DRAMgtcDwedebb5+d9eev/4mXiJeuBZ0aHR6XlqePPEZEWyHR5O+64BgFcUmI+U2EGhzqozg7njm8uOjYbvRAMEguOoIFhh940Fm/s62B1WnsKBJd3wcI6+8xRIVBE+D1hslPq4iQTs5HrkOCAbBIHhRBO9c3M5R/8Zq4cr2SHjV3NETibbHUkE3K4pBsBnBh0fH/pYEcSxEVemI6AxH3gFP+nREgODqIzhT/6+hXzj1AnU+333r4V6wXX13ZwlZEUBBVG1911F3UAx6IFiH4GQh2e70RvNPNS+qHUIHgkFwXgSfv9ZcnL/+Zh4j4XyxJ/PX3y44zZI5EpbAI7eRldogWHcvLwf28bhH6EAwCM6JYPP4s2da/xTbzCPVDA35zA1+vfSzlvj12me7Zd+QzroaTibdBgguDMG62IJgEAyCMyB470pKCXyu+9zZl0778BU/iF/N+xtmbcQQ3GzF/1JlBDc6TncwnHYfD7uuk/qEx3sA6Pr7T/pur63pkRS7tTvTbf6GXkOzFw77iYYandn+KcefeM/pXxr6KCl2SEdwsIPUF6FDcL5jiO2gjEzsZHWBzRdwEAyCy0Xw5f2WTQ9Dav0bbOINLRGs/Eu5z5Ss6zKZI8rRFNPBAFqq9lWjLwTIkmNUszYU9mtL9/7mz4+gx0D3ISSRNLJDgQjOfQxBZ/3o6IlyPEbDnSgDovskWMRZEAyCi0fwK+/vFItg8YaVQrCcdfYUlhK1F/R4ekMCpEFascdQISykfWKjCJJ8ydpQalGfhF2JCLbuiFgEwUErQTTkkIrqNS+CszkLgkFwKQhOnYicFcGG7mAZuMnncsmtjEJ4CpRJ6owpmdp+ukr3reG7xdJefkIVeYlUbelIMX9g6ChpLr8qGPGqLNZCLM5fUh6Cw5Jc2qFYBMvexW4j2u4kws2MCLYPOAgGwSUiuPPxbrEIFm9YNQRvJ4YG+zPiDCA2F866UtTwJEpikHoIlxKpyoZ0t96xNwzerSQEy8WpsqukEASbO17kY8iBYMuAg2AQXBMEJ3G8NATPStHBJDY7WbeGgLK+M/PU3Jspo1OGQrENhftL71YsgqePsyLzvG3Yl+8YlH3NMYWz4DIi2D7gIBgE16QjYrUITvYJLDLL1s98dS+t5h5WuYNlQ7pKM1bHKSlfSCeA5cTughGcFlLDPYHN4zj7gINgEFyHx3FVQLAOxLF8y5GoUnmlWdpG1R2cjwg6NiU/GMpDsPKjq2AEqz5RQDAIZlBazkFp1UFwcqhT1lm2BgSnbqkPr9IRrCJaSDHNQ8L8HREn8qoaw77bs+lGXxzBNrM8QDAIXm8Ep07NOP+rM89fmU3NED+IX3NPzagaghNjGJySq+BgpcfeggiW0RM+dkv8pewREUtDsIGGIBgErzeCt5c4QbmCCI7k8GLFab6JufkRnODjvBdC/4xubRFMFQyC64zgpS3TU28Em8eKFY7gWM9vgDDl+yj7iFNHYhWI4HzHYBNS3ag1EAyC1wbB20tcrLLSCF7sKVnqoLTCERxgS7zWfx8d4FJmcwQRKB/BmY5B4rIG3JrV2kAwCF4zBNd4yXYvjfWzMHQrSORLVHmMqmZRBafrFkaE8O5+PJz/0LOv9JMRKBXB+Y7BHFJ5WAsIBsFrjODt+n5xUVhJHR3733g2Wyir05NnamT91gzNQAV5Nu1E/na16UJrXnOWpLAkQmK6bfonjTzNt+3Gll8oE8H5jkGe/yZ9lPpfAxgZZwKCQfBaI3i7pl/fGVvkRTNKLF4m539KltZcsQg21I9mWEeH95b+OC73MUwZPTEN7+Nx3FogeKsI+QjeWjfxJfaizkoudSjPL0jyZbEu2p56sUrR1qBnM5csExGCHVJHYsTWtfE/e+RHeWUjOMcx6Bz01kubBrPiIyK20FQg+Eamy+j8tWbqxGWxg/34h8pUxE7b7XWnW3Ix7+LR35m11S2zLfNIA2UQ5hForNCIHMcQ2if38FjMoFumQLAawXRE5LiY9q40L++3rr7Xat/e6dzfFZv4Qfwq/mg5/wItsad7qV/VXqFbHIvpGytEMB0R9AXnRzACQFX/BFp4YTMQDIJBMMoNoDwjkWv5CZR7hXUQDIJBMMpZAC744Gg9TtOdeM/rFF9jGj7zrE4JDIJBMAjehM7f6PfRVaYALAnBsW+NS37PW6U+gUAwCAbBtUew9PWgmml4dT3f1AHdIBgEg2BU8gOo2YqXw6rRp0wQO1132JfWLO66TjU/e0AwCAbBCIFgEAyCEQLBIBgEg2CEQDAIBsEIgWAQDIIRQiAYBINghEAwCAbBCCEQDILLRPDBwcENhFD5ErkGgkFwHMFo7dT/6PdiIw5rKhAMgkN10BrqJ3dfExtxWFO1Wi0QDILRuurM7jO//PI1sYkfiMa6CwSDYLRmeq1/8ZdfvSY28QPRAMEgeEMRvGntVsTfWQk8RXCphTD+kkcgGAtJ0fj5BiVw2YUw/pJHIBgLSdHI+UZK4JILYfwlj0AwFpKikfONlcClFsL4Sx6BYCwkRcPzVZTAZRbC+EsegWAsJEXD81WWwOUVwvhLHoFgLCRFZ+erLYFLK4TxlzwCwVhIis7O11ACl1QI4y95BIKxkBT1zrdx4YypBC6nEMZf8ggEYyEp6p3v6zcvpfC3hEIYf8kjEIyFpOgpqxK4hEIYf8kjEIyFpOgpyxK48EIYf8kjEIyFm56iKQMhyiyE8Zc8AsFYuOkpmjoQorxCGH/JIxCMhRudoplL4EILYfwlj0AwFm50iuYogQsshPGXPALBWLi5KZqzBC6uEMZf8ggEY+HmpmjuErioQhh/ySMQjIUbmqILlcAFFcL4Sx4tD8FbRci3cAvVVMv0N9NYYN0m3gTXyN+1EAhG1fL3zPaz5u1l95yArPjXvBuukb/rgWBuZGh3vfy99IuWQLD4F3/piKAvGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/JXxCMhaQoCMZf8hcE0y4Ixl/yFwRjISkKgvEXBGMh7a6Nv89ffFbwV/yLvyAYBGMhKUqc8Zc4g2DaJUVpF39BMBaSosQZf4kzCKbd2qYofcEgGARjISm6svNlRAQIBsFYSIqCYPwlziAYC0Ew/pK/IBgLSVEQjL/EGQTTLgjGX/IXBGMhKQqC8Zc4g2DaBcH4S/6CYCwkRUEw/pK/IJh2QTD+kr8gGAtJURCMv+QvCKZdEIy/5C8IxkJS1Pp8WSMCBINgLCRFiTP+EmcQjIWkKO3iLwjGQlKUOOMvcQbBtFv/FKUvGASDYCwkRVd2voyIAMEgGAtJURCMv8QZBGMhCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/J30ojeKsI+RZuoZqqUv5e3t8VCBb/4kst/d00gWAEgvGX/F0dgrmRoV06IvCX/KUvGAtJURCMvyAYC2m32v6yRgQIBsFYSIoSZ/wlziAYC0lR2sVfEIyFpChxxl/iDIJpt/4pSl8wCAbBWEiKrux8GREBgkEwFpKiIBh/iTMIxkIQjL/kLwjGQlIUBOMvcQbBtAuC8Zf8BcFYSIqCYPwlziCYdkEw/pK/IBgLSVEQjL/kLwimXRCMv+QvCMZCUhQE4y/5C4JpFwTjL/kLgrGQFLU+X9aIAMEgGAtJUeKMv8QZBGMhKUq7+AuCsZAUJc74S5xBMO3WP0XpCwbBIBgLSdGVnS8jIkAwCMZCUhQE4y9xBsFYCILxl/wFwVhIioJg/CXOIJh2QTD+kr8gGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxl/wFwbQLgvGX/AXBWEiKgmD8JX9BMO2CYPwlf0EwFpKi1ufLGhEgGASrLbyFEEL1UqfTWScEHxwc3EAIofWXoNn6IVgc9zZCCK2/BM2WgeBGcQLBCKG6IrhRjkAwQgitDsF0RCCE0Mo6IkAwQgiBYIQQAsEgGCGEQDBCCIFgEIwQAsEgGCGEQDAIRgiBYBCMEEIgeGEEN5ut5r8NWsPvFNu9w2YHpiOEQHAZCG7ttD7+Rg3f2Lb/Oy4IhBAILhLBVvCVttpb3h4c//Vvfxfb4cAhAQgsoQvUaDj98fHheNjtNEAwCM5y6XR6/fFkNN1Srx5IkT22x4cnT/ygBdvh0aTvOgRWRbHZpRjfBgJtTpWvye545vLjo2G7sSQK1xbBd0afL4Lg8xcurmMRYXMRQwp7mnTHxzHyylssUQnsNGi9UeLjKhK0k+OR64DgmiPY7b336ZffLoLg4OXrUXccPZEu8UnXePUs53IXR9V2h6OjJyO3Udm4GY4wHtWjY6mgmxXFINiM4MOjY39LgjgWoqp0RHTE9XDs3d/QEbEIgls7OwKgiyP4o0+/SA2f8/nuWw/3gu3quzsruW58IgTXupl6y7ncg1Yqi2DzEQb/K6q2vuuoOygGPRCsQ3CykGx3eqP5p5oX1Q6hqymCH/zXo0IQLLZz586b+PvFnsxff7vgNFdy9zQlxYzFj8c9ELzIEcolsP3xg2AzgmOBla9SEFwfBDdbLZ+eSgQ3733z1N7l081L8nbWvaVD8Mf/+dAQO5+5wa+XftYSv177bHd1V/zs+o6VGCA4M4LnNxapvTogOBOCdbEFwfVB8O9u3tYh+Ow7gxh8g+3pV64rEWzuEY4huNmK/2UZV7w7ka9dm0s5uY/33Mkd+g+y+26vndYRJu7Bu4Oh3zEqbsZjj7nbHUds3RBwjv+XtrSb1w/r/zFIQvGerrfF8rYh3sqdj/cYDLuubYq24wfZsD/CohDsHfzsGLwjT33C4xsxSjMiGb1plGYN9RMNNRLx10Qs/p7TvzT0l4Fih3QEBztIhYLuus13DInrRxGZ2MnqApsv4BuN4ACdMQQ3P/rvWc37TnSO3IM/n77wsq4KFtvVV9uWCFb+peSKI172huzQP9KVL3fdQ//DsbaEGR09MYwNCD4SlFtQb0aPoSe/Z7iPOzlUtqV6pB6h2GByeKI9SJsjjDxTsq7LUgM7PXItVfsqI8QxJ0cZZm0o7NfW91DFIChdWuoPIYmkkR0KRHDuYwgKheS16l88wTUQC4juk2ARZ0HwDMFP7bwo+PvCuw8y9QWL7eD3/eoiuBPv/G1Y9EXI15M0Cif+5DqZQjK8xPvLD7sXQHCvH82TJATDZ+snClLruhrlF2ZF8HbGcX6Gk4odttIXDxaJkzUMccnaUGpRn4RdiQi27ohYBMFBK/LlGro8zo3gbM6C4BDBfgmc9XGceVyEDNzkc7nktpzezNSSR4bLtOCNPtZ3wxIymg9S8eLG7hYjYwNsOiLCa3qaGNP5SP4+sx4Dv7nkPKXw7JKfEPKjnsRBeuPP5qW9XVdJBIuPjzLMeQnSVbpvDd8t5ot82JGXSNWWjhTB8StpLr8q+KxVf3SZPssLRrDSwWIRLHsXu42QL+8cCLYPOAguDMGf/OnraiJYd4Ga785i15Pyoglv06R30N275Xscl34MDXUHn6HMVx72Ig8MVTW1CcTmwllXihq673UnKzdk+SzRbF8yFCUhWC5OlXVDIQg2VyHyMeRAcFEPb0GwLYLvf/6lTRxXgGB9UplLHmnEa8ptaSQny0FwjqtW+c4Nu9EgWcdsKHuWdWsIGCp03RGmfl7GHreW0VC4v/RuxSJ4+oEamedtw758x6Dsa9YlSFYE2wccBGsQ/ODPWRF8886DaiLYwNkQl6orJsfDmUT94hSG4Iz3bo1IB0JDUYlYTy21HzaXfAKTb5ZtOII72UuriYNyB8uGdJVm7HyVlC+kE8ByYnfBCO6kj45f5HFc1mQEwTMEP/1jVyD4qZ0Xk8x97tc3DQj+effXFURwyrNgYyFgM3BNeY0G15nfN9o3gtgSweYnXf4cYm9E2pFioZwIglUcKQrBOhDHXpgjUaXySrO0jao7OB8RdGxKfjCUh2DdaJYiEWxxJYDgEhH84ItHunHBp3dno4Cf/dUfmve+aX706OzBh/5ICXlcWgzBzVarggiOdDvOZ+LLm6FTMjeClcVg7GleUQhOXSLHpjOxWAQnhzplnWVrQHDqlvrwKh3BKqKFFNM8JMzfEXEir6ox7Lu9bsbpQvmOIfflDYKLQfAbb143zI5LTo1LdlDEEGwZx2UiOPmYaPGbPvuOZn/xxhiIDbV2PgSHvXUe5f0Enj2gM48DyTGfOGvaRMcwOCVXwcFKj70FESzbmuzij+9Z2oiIpSHY1MUPgktdI8KA4OkcjUdPd34hWCw28cP27T8Z+oL33XeqiGCpW1ZZAscK4az3y7ZVqvScyjB2NQeCLfuyV1IFG45wEQRnmpibH8EJPs57IfTP6NYWwVTBK0Nw9ze/LWqZHvs4LhPBlnmre+Rl83LLS0pXDy6IYMvXKvuCy3gcVx6Cs44zWZwIcs9vgDDl+yj7iBU9y6UhON8x2IQ0a2qA4MzrBX/68JvFEdxx3qoggm3G3JiTxDzCZttipFSmgiIHgk2DPTRrmNmHpWAEL/aULFOoCyFCuLTpwPHfRxexlNkcmlHYZSA40zFIl70G3JrV2kBwkQj2lwxeBMG3Ph5tV1L25V5ql6VuOoBy1GSjo16LRPcA2rLOzfq/hkHy6eOdO7ZH6KWxfhaGbgWJfIkqR1vzieh03cKIEN7dj4fzH3pZr7TI9LMyEZzvGMwhlR/zguASv7joxZeuLILgyiow26b30Hy/nJxoEH3cH00td+I9444tUu5qK45IhTKbcxxOeLPtC5bGMKWOCYtNUB5FlsXyHiHG0thwhNIo42P/G8/awfxpuQc847dmaAYqyLNpJ/Kyc9NB0F5zWbuSLOfmpE0OVE/zDUxfBoLzHYM8/036KFU8SQbBfH1nvgdxlrfbaatSqZc9MyNVuamqacX4UMvHUIYhH14empZa7430Y0XiCNYfYWyRF827TXTrV2R+SpbWXLEINtSPZlhHh/eW/jgu9zFMGT0xXQY8jlsqggcP7fnbfP3HVUZwajeuTdUcW3kvuUaicgKucuk/8xyN5MqW9iMBlOOC/THI5j5c3WKVXj3rOhmO0DV9Po1US8Qu1kXbUy9WmbjzKIQI9vdSsXVtZo5Lj/LKRnCOY9A56A1wnAaTERFLRbBQc+9866NHKcXvfm97UzWdhDZdMb3jpPYvB2urp+4c3k17++dZ1lo+sOx3DI7lcZqP0OsEd+fLyXecsr9YN2t4F+nOsn90GQSz3VnZd6DkO4bQPrmHJ/tcyvK0EQgOWfzyay3331sfjj3s3vmq9YdR86fuNkIb9YmbfT2NmqlS36q1WQhGCFX/a/3KvudbZGGzdUXwVhECwQgtDKA8I5Fr+QmUb4X1shG8VY5AMEKVKAAXeXC0NqfpTvynxImvMQ2feVakBF4egumIQGhlSPI6f6PfRzeu88Nn5Zccxr7nrTqfQPQFI7QJCH6i+7bA2p9v6oBuEAyCESq3/6E/W/FyWCn6lAxip+uv9z9fszjfyEgQDIIRQrUVCEYIIRAMghFCIBgEI4QQCAbBCCEQDIIRQggEg2CEEAiuBIIPDg5uIITQ+kvQbP0QjFDZev/el2IjDmg5WicEdxAqX2+OnoiNOKDlqNVqrQ2CTyFUsp49d+36d/8Qm/iBaKD1EghGa6+XP/yf69//n9jED0QDgeAVI1h5SrRbuCri76wEniK41EIYf8kjEIyFpGj8fIMSuOxCGH/JIxCMhaRo5HwjJXDJhTD+kkcgGAtJ0cj5xkrgUgth/CWPQDAWkqLh+SpK4DILYfwlj0AwFpKi4fkqS+DyCmH8JY9AMBaSorPz1ZbApRXC+EsegWAsJEVn52sogUsqhPGXPALBWEiKeuf7/KXrphK4nEIYf8kjEIyFpKh3vlcH/5vC3xIKYfwlj0AwFpKip6xK4BIKYfwlj0AwFpKipyxL4MILYfwlj0AwFm56iqYMhCizEMZf8ggEY+Gmp2jqQIjyCmH8JY9AMBZudIpmLoELLYTxlzwCwVi40SmaowQusBDGX/IIBGPh5qZozhK4uEIYf8kjEIyFm5uiuUvgogph/CWPQDAWbmiKLlQCF1QI4y95BIKxcENTdMESuJBCGH/JIxCMhRuaok+/cOHpxkV/e671ktiCX/3t4m//IiAr/o39PbK9cAF/yV8QjIWkaPHne+5fHwoEi3/xFwSDYCwkRUEw/hLnBRC8VYR8C7dQTVUpfy+8/ZVAsPgXX2rp76YJBCMQjL/k7+oQzI0M7dIRgb/kL33BWEiKgmD8BcFYSLsgGH/JIxCMhaQoCAbBIBgLaRcE4y9xBsFYSIqCYBAMgrGQFAXB+EucQTAWgmD8BcEgGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/JXxCMhaQoCMZf8hcE0y4Ixl/yFwRjISkKgvEXBGMh7YJg/CWPQDAWkqIgGASDYCykXRCMv+QRCMZCUhQEg2AQjIWkKAjGX+IMgrEQBINgEAyCsZAUBcH4S5xBMBaCYPwlf0EwFpKiIBh/iTMIpl0QjL/kLwjGQlIUBOMvcQbBtAuC8Zf8BcFYSIqCYPwlf0Ew7YJg/CV/QTAWkqIgGH/JXxBMuyAYf8lfEIyFpCgIxl8QjIW0C4LxlzwCwVhIioJgEAyCsZB2QTD+EmcQjIWkKAgGwXVE8FYR8i3cQjVVpfy98PZXAsHiX3yppb+bJhCMQDD+kr+rQzA3MrRLRwT+kr/0BWMhKQqC8RcEYyHtgmD8JY9AMBaSoiAYBINgLKRdEIy/xBkEYyEpCoJBMAjGQlIUBOMvcQbBWAiC8RcEg2AsJEVBMP4SZxBMuyAYf8lfEIyFpCgIxl/iDIJpFwTjL/kLgrGQFAXB+EucQTDtgmD8JX9BMBaSoiAYf8lfEEy7IBh/yV8QjIWkKAjGXxCMhbQLgvGXPALBWEiKgmAQDIKxkHZBMP6SRyAYC0lREAyCQTAWkqIgGH+JMwjGQhAMgkEwCMZCUhQE4y9xBsFYCILxl/wFwVhIioJg/CXOIJh2QTD+kr8gGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxl/wFwbS77v6eefHngr/iX/wFwSC4hhbeQggVoU6nA4JBcB4EHxwc3EAI5ZXIIBAMgvMjWFxD2wihvBIZBIJBMAhGCASDYBCMEAgGwSAYBCMEgkEwCEYIBIPgOYIbKCoQjFCxCIYqBoFgEIwQCF4dgumIoCMCIToi6AsGwQiBYBAMgkEwQiAYBINghEAwCAbBCCEQDIKrj+Ar7eZ+r/nesHl73Lo/EZv4wft1vyf+i7REIBgEg+BSENy89tPmB39qffIXwyZ2ELuRnAgEg2AQXByCL15u3fyjGb6R7eYfxUs2IQkbDac/Pj4cD7udxkrep+FO/vq3v4vt8bi3kgi0B8f+ARwOnBoYAYJBcPUQ/Oq11t2vM/DX3+5+LV5YeXpORupt2HWddiM9mbvjJzMCHg1t9i/8fQpEsCkgA4E2p8oILsoIEAyCK4Zgwd8H32Xmr789+K7KFG40eqOTWd7qtsdHk77rbAyCUwLy+OR4lIgGCAbBILg0BF+8nKf+jdXCVe2RsEFwAGLd7W2jMxwdHR8KUi/YEZH3fUpC8KF3MN6WjEYMtVXpiCjICBAMgiuE4Gz9v4Z+4TQ5n+++9XAv2K6+u7NMBCfrJnFL3u70+uNjuQBcZm6vFsHJgIhojI6eKENREQTzOA4E1w3BzWs/LYC//jAJ4xgJ54s9mb/+dsFprhDBUm3V62vQs1EInvUUB6GQ2gLBIBgEl4Ng/fiz5vC7swcfbrV/8tS5K6daF09feu3pN35xtne3NfxeN1LN0JDP3ODXSz9riV+vfbZbBQT76FlJP2PVEOzf7B/6O5xMuvMdQDAIBsElIPhKW8ff7btfb71yXZA3uT3jdLWv0s/aiCG42Yr/ZbUIjhWAIzfZZTHd5u/Q6Mz+Yn7D+KsSf1ER0Om6Q3/ARn8+YMMGwd6nyOyFk77ba+v6tVMRHOwg3RDoEDyPg+l0UndInu+0V0QRKF0AlQYp3xYEg+AKIbi539PVv1uvvCVo+89Xromyd/vOI/HHH9159Hzv7vQv97SF837PEsHKv6wWwRHSRXdOAij4i4GJQVkdAN1cSzakrtjY+AQzgv3RsqoHjIrxswUiODfVj0IAAAYoSURBVPjQkutlzVspdshxvroAyn+f3tAcq962AYJBcMUQ/P4nSpKe+c0Hgr8/fPnN5v1v4/+r6YWYIfj9T9YbwSr6KDNfebeeSh8DgoM3nNMzMlBBVHM6BHsgk14YG+GQPLwCOyIWQXD8fE+sztcCwWG3vheKaBP5evlBMAguDcGajmC/C+L53w8zP5HTdwfLwE0+l0tuK0Kwui9CgWB9r0WsoJZhob2dlwaKxUrXthtFVRRJ8mEI+sg9HkElmHhJSkDCAl/aoVgEG893YjjfVATPHXGUH1H5etJBMAguC8Gtj79VkvT0nvf8TVECp24ff7vWCFb2HmgBZOwc8N/HcmiXuVtDLhgtkRTlY+QYUkZESG2lRyAvggs/XxnByU/E1FsWEAyC64/gJI7XHsGGu+zgvywIouv9SGW0uadVV4krAxIMkc7EvnwItjnfcHRKRgSbR9rl64sAwSB4NR0RLxTaEVE/BOt2lvfX/T0CsqBGM4x2UFXcqS9U7mA3Yzsxa6NABOc9X8vHcfa2gmAQXNXHcW/f8oZDvPRG89438WFnd75q3jvM8ThuLRBs3xdsIqMeTOYODcOQWyW2pNJPtw6RqXa2XyCiYATbnC8IBsGbPCit9cn3P7zieNMxLrbP/vaONyht+P2Pbo+fe/s/Tp+/Kmrk5v1J1kFpa4LglL7LxGM0BYMCXCZxoHwfm1kPZgRbLH8h9zmE/QDyonF9t2dYAbJABFudLwgGwZuAYNPUjDuPfvjym8qpGf/ykwPd0DTLL9SoLoKtxwUb+hz8vyi7Hc0INtAhbxUcrELZUyA4yyTAMhBsOl8QDII3AsHGCcqiFj7z9i1R8z6199JTu5dPX379metvv9D/bMGO4Moi2DDOzGY8rw+LkEqq5vJXwSok5Zs0XB0EUwWDYBC8vGV6qo/gcCCt3cMoJYYCIitTPcfgNtOIiFwLRxSIYN3YO/NosNznC4JBcA0RvL3ExSori+DIRAbrDoQkCkV6z3sh1FVhyogIHcg0q5elDkpbGoJT56eoR0RkPF8QDILrieANWbJdOxnMHcqL5NpXr6pRwMNZRayp71JBJl6YPEh5xYPYO5tfOPt0cZ3yEKzrPY8NvYh9SOQ+XxAMguuI4O2N+OKi6AAAbzuMrhFjMzPCnOGPp4sS5HifyHww6cs7GtEV5Q2zjecvlItrpzvwJvtmnaCc7cg1U43j86pjE5Tzni8IBsE1RfB2jb++0+qLiw41VaRlhgfFoBltNiMr1EPKXMMyPRHYKV5eJoINRz69pdB2lbSliNmfLwgGwfVF8HY9v8TegGCvaPWW1k1fTDYdwWmr9ti8j9wlEvtsSFmsMlE8hhAc9NoZV0rLdeST2MfA4+nXu5l7q5Pn662XNjCdLwgGwbVG8HyMhHGk2mz8mf34B5TtM6PjtN1e15sokfn7Kdqd6Qunr13+F39MV0n3Wm9nWYdBeb42M+iWJhAMgpeK4JmutJv7veZ7w+btcev+RGziB+/X/Z7l/AuEcstm+gYIBsG1RjBCK+s7WmhhMxAMgkEwQgWUwIt/VykIBsEgGKFEnetOvOd1iQeh8nPFipTAIBgEg2BUQwTHvjUu+T1vVegFBsEgGASjOiLYOJZZnqwBgtcMwVtFyEfwVi0EglGFQex03WFfWrO4665gLF1WBG8hvUAwCEYIBK8OwXRE0BGBEB0R9AWDYIRAMAgGwSAYIRAMgkEwQiAYBINghBAIBsEgGCEQDII3AcEHBwc3EEJ5JTIIBIPg/AhGCC0uEAyC86iDECpCrVYLBINghFBFBYJBMEIIBINgLKx2u/iLv8QZBGMhKUq7+AuCsZAUJc74S5xBMBaSorSLvyAYC0lR4oy/xBkE0y4pSrv4C4KxkBQlzvhLnEEw7ZKitIu/IBgLSVHijL/EGQTTLv7SLv6CYCwkRYkz/uIvCKZd/KVd/AXBWEiKEmf8BcFYSLv4i7/EGQRjISmKv/gLgrGQdvEXf4kzCMZCUpR28RcEYyEpSpzxlziDYCwkRWkXf0EwFpKixBl/iTMIJkVJUdrFXxCMhaQoccZf4gyCaZcUpV38BcFYSIoSZ/wlziCYdvGXdvG3su3+P1nK/SpJ8iNQAAAAAElFTkSuQmCC"></p><ul><li>ShenyuPlugin: top-level interface, defining interface methods.</li><li>AbstractShenyuPlugin: abstract class that implements the common logic of the pluin.</li><li>DividePlugin: Divide pluin.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-request"></a>2.1 Accept Request<a class="hash-link" href="#21-accept-request" title="Direct link to heading">#</a></h4><p>After passing the <code>ShenYu</code> gateway proxy, the request entry is <code>ShenyuWebHandler</code>, which implements the <code>org.springframework.web.server.WebHandler</code> interface.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * hanlde web reuest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // execute plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Instantiating the default plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Execute each plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // get current plugin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // is skip ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If skipped, execute the next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // execute current plugin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-matching-rule"></a>2.2 Matching rule<a class="hash-link" href="#22-matching-rule" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>Execute the matching logic for selectors and rules in the <code>execute()</code> method.</p><ul><li>Matching selectors.</li><li>Matching rules.</li><li>Execute the plugin.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // selector </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // rule </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match rule </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // execute </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-execute-divide-plugin"></a>2.3 Execute Divide Plugin<a class="hash-link" href="#23-execute-divide-plugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.divide.DividePlugin#doExecute()</li></ul><p>Execute the specific logic of the <code>divide</code> plugin in the <code>doExecute()</code> method.</p><ul><li>Checks the <code>header</code> size.</li><li>Checking the <code>request</code> size.</li><li>Obtaining the list of services.</li><li>implementing load balancing.</li><li>Set request <code>url</code>, timeout time, retry policy.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // shenyu Context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get the handle property of the rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DivideRuleHandle ruleHandle = DividePluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long headerSize = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // check header size</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (List&lt;String&gt; multiHeader : exchange.getRequest().getHeaders().values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String value : multiHeader) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                headerSize += value.getBytes(StandardCharsets.UTF_8).length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (headerSize &gt; ruleHandle.getHeaderMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request header is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_HEADER_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // check request size</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (exchange.getRequest().getHeaders().getContentLength() &gt; ruleHandle.getRequestMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request entity is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_ENTITY_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide upstream configuration errorÔºö {}&quot;, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // request ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // load balance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide has no upstream&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String domain = upstream.buildDomain();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_DOMAIN, domain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set timeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_TIME_OUT, ruleHandle.getTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_RETRY, ruleHandle.getRetry());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set retry </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.RETRY_STRATEGY, ruleHandle.getRetryStrategy());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.LOAD_BALANCE, ruleHandle.getLoadBalance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.DIVIDE_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-do-request"></a>2.4 Do Request<a class="hash-link" href="#24-do-request" title="Direct link to heading">#</a></h4><p>By default, the <code>WebClientPlugin</code> initiates a call request to the <code>http</code> service with the following class inheritance relationship.</p><p><img src="/assets/images/WebClientPlugin-64ae237cda7fd819160795669ee2e2bd.png"></p><ul><li>ShenyuPlugin: top-level plug-in, defining plug-in methods.</li><li>AbstractHttpClientPlugin: abstract class that implements the public logic of request invocation.</li><li>WebClientPlugin: initiating requests through <code>WebClient</code>.</li><li>NettyHttpClientPlugin: initiating requests through <code>Netty</code>.</li></ul><p>Initiate the request call.</p><ul><li>org.apache.shenyu.plugin.httpclient.AbstractHttpClientPlugin#execute()</li></ul><p>Initiate the request call in the <code>execute()</code> method.</p><ul><li>Get the specified timeout, number of retries</li><li>Initiate the request</li><li>Retry after failure according to the specified retry policy</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractHttpClientPlugin&lt;R&gt; implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static final Logger LOG = LoggerFactory.getLogger(AbstractHttpClientPlugin.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // shenyu Context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final URI uri = exchange.getAttribute(Constants.HTTP_URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get time out</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final long timeout = (long) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_TIME_OUT)).orElse(3000L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Duration duration = Duration.ofMillis(timeout);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get retry times</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int retryTimes = (int) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_RETRY)).orElse(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get retry strategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String retryStrategy = (String) Optional.ofNullable(exchange.getAttribute(Constants.RETRY_STRATEGY)).orElseGet(RetryEnum.CURRENT::getName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;The request urlPath is {}, retryTimes is {}, retryStrategy is {}&quot;, uri.toASCIIString(), retryTimes, retryStrategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build header</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final HttpHeaders httpHeaders = buildHttpHeaders(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // do request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;R&gt; response = doRequest(exchange, exchange.getRequest().getMethodValue(), uri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Retry Policy CURRENT, retries the current service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RetryEnum.CURRENT.getName().equals(retryStrategy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //old version of DividePlugin and SpringCloudPlugin will run on this</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response.retryWhen(Retry.anyOf(TimeoutException.class, ConnectTimeoutException.class, ReadTimeoutException.class, IllegalStateException.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .retryMax(retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .backoff(Backoff.exponential(Duration.ofMillis(200), Duration.ofSeconds(20), 2, true)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Retry for other services</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Exclude services that have already been called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Set&lt;URI&gt; exclude = Sets.newHashSet(uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // resend</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resend(response, exchange, duration, httpHeaders, exclude, retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; clientResponse,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final int retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;R&gt; result = clientResponse;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Retry according to the specified number of retries</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; retryTimes; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = resend(result, exchange, duration, httpHeaders, exclude);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; response,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response.onErrorResume(th -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String selectorId = exchange.getAttribute(Constants.DIVIDE_SELECTOR_ID);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String loadBalance = exchange.getAttribute(Constants.LOAD_BALANCE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Check available services</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selectorId)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .stream().filter(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String trimUri = data.getUrl().trim();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (URI needToExclude : exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // exclude already called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if ((needToExclude.getHost() + &quot;:&quot; + needToExclude.getPort()).equals(trimUri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // requets ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Load Balance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Upstream upstream = LoadBalancerFactory.selector(upstreamList, loadBalance, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final URI newUri = RequestUrlUtils.buildRequestUri(exchange, upstream.buildDomain());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Exclude uri that has already been called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exclude.add(newUri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // Make another call</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doRequest(exchange, exchange.getRequest().getMethodValue(), newUri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.httpclient.WebClientPlugin#doRequest()</li></ul><p>Initiate a real request call via <code>webClient</code> in the <code>doRequest()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;ClientResponse&gt; doRequest(final ServerWebExchange exchange, final String httpMethod, final URI uri,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final HttpHeaders httpHeaders, final Flux&lt;DataBuffer&gt; body) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return webClient.method(HttpMethod.valueOf(httpMethod)).uri(uri) // uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .headers(headers -&gt; headers.addAll(httpHeaders)) // header</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .body(BodyInserters.fromDataBuffers(body))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .exchange() // request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnSuccess(res -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (res.statusCode().is2xxSuccessful()) { // success</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else { // error</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.ERROR.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getResponse().setStatusCode(res.statusCode());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.CLIENT_RESPONSE_ATTR, res);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-response-result"></a>2.5 Response Result<a class="hash-link" href="#25-response-result" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>The response results are handled by the <code>ResponsePlugin</code> plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Processing results according to rpc type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The processing type is determined by <code>MessageWriter</code> and the class inheritance relationship is as follows.</p><p><img src="/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriter: interface, defining message processing methods.</li><li>NettyClientMessageWriter: processing of <code>Netty</code> call results.</li><li>RPCMessageWriter: processing the results of <code>RPC</code> calls.</li><li>WebClientMessageWriter: processing <code>WebClient</code> call results.</li></ul><p>The default is to initiate <code>http</code> requests via <code>WebCient</code>.</p><ul><li>org.apache.shenyu.plugin.response.strategy.WebClientMessageWriter#writeWith()</li></ul><p>Process the response results in the <code>writeWith()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // get response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerHttpResponse response = exchange.getResponse();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientResponse clientResponse = exchange.getAttribute(Constants.CLIENT_RESPONSE_ATTR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(clientResponse)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //cookies and headers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getCookies().putAll(clientResponse.cookies());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getHeaders().putAll(clientResponse.headers().asHttpHeaders());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // image, pdf or stream does not do format processing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Handling special response types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clientResponse.headers().contentType().isPresent()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String media = clientResponse.headers().contentType().get().toString().toLowerCase();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (media.matches(COMMON_BIN_MEDIA_TYPE_REGEX)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return response.writeWith(clientResponse.body(BodyExtractors.toDataBuffers()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Handling general response types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clientResponse = ResponseUtils.buildClientResponse(response, clientResponse.body(BodyExtractors.toDataBuffers()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return clientResponse.bodyToMono(byte[].class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap(originData -&gt; WebFluxResultUtils.result(exchange, originData))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Analysis to this point, the source code analysis on <code>Divide</code> plugin is complete, the analysis flow chart is as follows.</p><p><img src="/assets/images/divide-execute-zh-c145705430fc3aec6e561cc4ad183a05.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-summary"></a>3. Summary<a class="hash-link" href="#3-summary" title="Direct link to heading">#</a></h3><p>The source code analysis in this article starts from the <code>http</code> service registration to the <code>divide</code> plugin service calls. The <code>divide</code> plugin is mainly used to handle <code>http</code> requests. Some of the source code does not enter the in-depth analysis, such as the implementation of load balancing, service probe live, will continue to analyze in the following.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/blog/tags/divide">divide</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin">Code Analysis For Param-Mapping Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-21T03:49:52.511Z">July 21, 2023</time> ¬∑ 5 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>Before starting, you can refer to <a href="/blog/page/Start-SourceCode-Analysis-Start-Demo">this article</a> to start the gateway</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="body"></a>Body<a class="hash-link" href="#body" title="Direct link to heading">#</a></h3><p>Let&#x27;s take a look at the structure of this plugin first, as shown in the figure below.</p><p><img alt="param-mapping-structure" src="/assets/images/param-mapping-structure-1d2b4243e835eeff74fc6ea114dcbee7.png"></p><p>Guess: handler is used for data synchronization; strategy may be adapted to various request bodies, which should be the focus of this plugin; <code>ParamMappingPlugin</code> should be the implementation of <code>ShenyuPlugin</code>.</p><p>First, take a look at the <code>ParamMappingPlugin</code>, the focus is on the override of the <code>doExecute</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... // judge whether paramMappingHandle is null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Determine the request body type according to the contentType in the header line</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpHeaders headers = exchange.getRequest().getHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaType contentType = headers.getContentType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return match(contentType).apply(exchange, chain, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>The match method returns the corresponding <code>Operator</code> according to contentType</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private Operator match(final MediaType mediaType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return operatorMap.get(MediaType.APPLICATION_JSON.toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return operatorMap.get(MediaType.APPLICATION_FORM_URLENCODED.toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return operatorMap.get(Constants.DEFAULT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As can be seen from the code of the match method, there are currently three types of <code>DefaultOperator</code>, <code>FormDataOperator</code>, and <code>JsonOperator</code>, which support the request body in two formats: <code>x-www-form-urlencoded</code> and <code>json</code>.</p></li></ul><p>So let&#x27;s take a look at what the above three operators are like.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-defaultoperator"></a>1. DefaultOperator<a class="hash-link" href="#1-defaultoperator" title="Direct link to heading">#</a></h4><p>Nothing happens, its apply method just continues to execute the plug-in chain, and has no real function. When the request body does not match the Operator, it will be skipped by <code>DefaultOperator</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-formdataoperator"></a>2. FormDataOperator<a class="hash-link" href="#2-formdataoperator" title="Direct link to heading">#</a></h4><p>This class is used to process the request body in the format of <code>x-www-form-urlencoded</code>.</p><p>Mainly depends on the <code>apply</code> method, but it looks a bit strange.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;Void&gt; apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return exchange.getFormData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .switchIfEmpty(Mono.defer(() -&gt; Mono.just(new LinkedMultiValueMap&lt;&gt;())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .flatMap(multiValueMap -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The code in the ellipsis is the processing of the request body, as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// judge whether it is empty</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (Objects.isNull(multiValueMap) || multiValueMap.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return shenyuPluginChain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// convert form-data to json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">String original = GsonUtils.getInstance().toJson(multiValueMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG.info(&quot;get from data success data:{}&quot;, original);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// *modify request body*</span></span><span class="token-line" style="color:#393A34"><span class="token plain">String modify = operation(original, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (StringUtils.isEmpty(modify)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return shenyuPluginChain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Convert the modified json into LinkedMultiValueMap. Pay attention to this line, it will be mentioned later!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">LinkedMultiValueMap&lt;String, String&gt; modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">final BodyInserter bodyInserter = BodyInserters.fromValue(modifyMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// modify the request body in the exchange, and then continue to execute the plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return bodyInserter.insert(cachedBodyOutputMessage, new BodyInserterContext())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .then(Mono.defer(() -&gt; shenyuPluginChain.execute(exchange.mutate()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .request(new ModifyServerHttpRequestDecorator(httpHeaders, exchange.getRequest(), cachedBodyOutputMessage))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        )).onErrorResume((Function&lt;Throwable, Mono&lt;Void&gt;&gt;) throwable -&gt; release(cachedBodyOutputMessage, throwable));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p>PS: The omitted part is to set the request first and other operations.</p></blockquote><p>The more important thing above should be the modification request body of the star, that is, the call of the <code>operation</code> method. Here, because of the parameter type, the default method of the <code>Operator</code> interface will be called first (instead of being overridden by the <code>FormDataOperator</code>).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">default String operation(final String jsonValue, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DocumentContext context = JsonPath.parse(jsonValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // call the override operation method and add addParameterKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    operation(context, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // replace the related replacedParameterKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getReplaceParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getReplaceParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.renameKey(info.getPath(), info.getKey(), info.getValue());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Delete the related removeParameterKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getRemoveParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getRemoveParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.delete(info);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return context.jsonString();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After sorting it out, we can find that the json tool <a href="https://github.com/json-path/JsonPath" target="_blank" rel="noopener noreferrer">JsonPath</a> imported here makes the processing of the request body much simpler and clearer.</p><p><strong>In addition, we can notice that the <code>FormDataOperator</code> overrides the <code>operation(DocumentContext, ParamMappingHandle)</code> method.</strong></p><p><strong>Why override it?</strong> There is a default method for handling addParameterKey in the interface.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Default method in Operator interface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">default void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getAddParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.put(info.getPath(), info.getKey(), info.getValue()); //‰∏çÂêå‰πãÂ§Ñ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// method overridden by FormDataOperator</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getAddParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.put(info.getPath(), info.getKey(), Arrays.asList(info.getValue()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In fact, there is such a line in <code>FormDataOperator#apply</code> (mentioned earlier):
<code>LinkedMultiValueMap&lt;String, String&gt; modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);</code></p><p>This line converts the modified json into <code>LinkedMultiValueMap</code>, <code>GsonUtils#toLinkedMultiValueMap</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public LinkedMultiValueMap&lt;String, String&gt; toLinkedMultiValueMap(final String json) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return GSON.fromJson(json, new TypeToken&lt;LinkedMultiValueMap&lt;String, String&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }.getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The attribute <code>targetMap</code> in the <code>LinkedMultiValueMap</code> class is defined as: <code>private final Map&lt;K, List&lt;V&gt;&gt; targetMap</code></p><p>Therefore, the value in the json string must be in the form of a list, otherwise Gson will throw a conversion error exception, which is why the <code>FormDataOperator</code> must override the operator method.</p><p><strong>But why use <code>LinkedMultiValueMap</code>?</strong></p><p>Go back to the first line <code>exchange.getFormData</code> of the <code>FormDataOperator#apply</code> method. In SpringMVC, the return value type of <code>DefaultServerWebExchange#getFormData</code> is <code>Mono&lt;MultiValueMap&lt;String, String&gt;&gt;</code>, and <code>LinkedMultiValueMap</code> is a subclass of <code>MultiValueMap</code>. And, the <code>getFormData</code> method is for the request body in the format of <code>x-www-form-urlencoded</code>.</p><p><img alt="param-mapping-getFormData" src="/assets/images/param-mapping-getFormData-04b664908cd5f52d149eb1098d5648c9.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="‰∏âjsonoperator"></a>‰∏â„ÄÅJsonOperator<a class="hash-link" href="#‰∏âjsonoperator" title="Direct link to heading">#</a></h4><p>Obviously, this class is used to process the request body in Json format.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;Void&gt; apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerRequest serverRequest = ServerRequest.create(exchange, MESSAGE_READERS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mono&lt;String&gt; mono = serverRequest.bodyToMono(String.class).switchIfEmpty(Mono.defer(() -&gt; Mono.just(&quot;&quot;))).flatMap(originalBody -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;get body data success data:{}&quot;, originalBody);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // call the default operation method to modify the request body</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String modify = operation(originalBody, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.just(modify);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    BodyInserter bodyInserter = BodyInserters.fromPublisher(mono, String.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... //process the header line</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    CachedBodyOutputMessage outputMessage = new CachedBodyOutputMessage(exchange, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // modify the request body in the exchange, and then continue to execute the plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return bodyInserter.insert(outputMessage, new BodyInserterContext())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ServerHttpRequestDecorator decorator = new ModifyServerHttpRequestDecorator(headers, exchange.getRequest(), outputMessage);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return shenyuPluginChain.execute(exchange.mutate().request(decorator).build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            })).onErrorResume((Function&lt;Throwable, Mono&lt;Void&gt;&gt;) throwable -&gt; release(outputMessage, throwable));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The processing flow of <code>JsonOperator</code> is roughly similar to that of <code>FormDataOperator</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>Finally, use a picture to briefly summarize.</p><p><img alt="param-mapping-summary" src="/assets/images/param-mapping-summary-490cf9ee499bf9efc03d0c963b39118c.jpg"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/param-mapping">Param-Mapping</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/RegisterCenter-SourceCode-Analysis-Http-Register">Register Center Source Code Analysis of Http Register</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-21T03:49:52.511Z">July 21, 2023</time> ¬∑ 29 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, the registration center is used to register the client information to <code>shenyu-admin</code>, <code>admin</code> then synchronizes this information to the gateway through data synchronization, and the gateway completes traffic filtering through these data. The client information mainly includes <code>interface information</code> and <code>URI information</code>.</p><blockquote><p>This article is based on <code>shenyu-2.5.0</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/docs/design/register-center-design" target="_blank" rel="noopener noreferrer">Client Access Principles</a> for the introduction of the official website.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-registration-center-principle"></a>1. Registration Center Principle<a class="hash-link" href="#1-registration-center-principle" title="Direct link to heading">#</a></h3><p>When the client starts, it reads the interface information and <code>uri information</code>, and sends the data to <code>shenyu-admin</code> by the specified registration type.</p><p><img src="/assets/images/register-center-en-d38e8150e48eec9bef3727dbadc124ec.png"></p><p>The registration center in the figure requires the user to specify which registration type to use. <code>ShenYu</code> currently supports <code>Http</code>, <code>Zookeeper</code>, <code>Etcd</code>, <code>Consul</code> and <code>Nacos</code> for registration. Please refer to <a href="https://shenyu.apache.org/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">Client Access Configuration</a> for details on how to configure them.</p><p><code>ShenYu</code> introduces <code>Disruptor</code> in the principle design of the registration center, in which the <code>Disruptor</code> queue plays a role in decoupling data and operations, which is conducive to expansion. If too many registration requests lead to registration exceptions, it also has a data buffering role.</p><p><img src="/assets/images/shenyu-register-center-en-732853d1dc114c56034d14f70e92be06.png"></p><p>As shown in the figure, the registration center is divided into two parts, one is the registration center client <code>register-client</code>, the load processing client data reading. The other is the registration center server <code>register-server</code>, which is loaded to handle the server side (that is <code>shenyu-admin</code>) data writing. Data is sent and received by specifying the registration type.</p><ul><li>Client: Usually it is a microservice, which can be <code>springmvc</code>, <code>spring-cloud</code>, <code>dubbo</code>, <code>grpc</code>, etc.</li><li><code>register-client</code>: register the central client, read the client interface and <code>uri</code> information.</li><li><code>Disruptor</code>: decoupling data from operations, data buffering role.</li><li><code>register-server</code>: registry server, here is <code>shenyu-admin</code>, receive data, write to database, send data synchronization events.</li><li>registration-type: specify the registration type, complete data registration, currently supports <code>Http</code>, <code>Zookeeper</code>, <code>Etcd</code>, <code>Consul</code> and <code>Nacos</code>.</li></ul><p>This article analyzes the use of <code>Http</code> for registration, so the specific processing flow is as follows.</p><p><img src="/assets/images/shenyu-register-center-http-en-2bf3e3a1e2c72d3fca6059fae46886f8.png"></p><p>On the client side, after the data is out of the queue, the data is transferred via <code>http</code> and on the server side, the corresponding interface is provided to receive the data and then write it to the queue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-client-registration-process"></a>2. Client Registration Process<a class="hash-link" href="#2-client-registration-process" title="Direct link to heading">#</a></h3><p>When the client starts, it reads the attribute information according to the relevant configuration, and then writes it to the queue. Let&#x27;s take the official <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> as an example and start the source code analysis . The official example is a microservice built by <code>springboot</code>. For the configuration of the registration center, please refer to the official website <a href="https://shenyu.apache.org/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">client access configuration</a> .</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-load-configuration-read-properties"></a>2.1 Load configuration, read properties<a class="hash-link" href="#21-load-configuration-read-properties" title="Direct link to heading">#</a></h4><p>Let&#x27;s start with a diagram that ties together the initialization process of the registry client.</p><p><img src="/assets/images/client-register-init-en-782b6467880bcb85cee72f2beba708c5.png"></p><p>We are analyzing registration by means of <code>http</code>, so the following configuration is required.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Each attribute indicates the following meaning.</p><ul><li><code>registerType</code>: the service registration type, fill in <code>http</code>.</li><li><code>serverList</code>: The address of the <code>Shenyu-Admin</code> project to fill in for the <code>http</code> registration type, note the addition of <code>http://</code> and separate multiple addresses with English commas.</li><li><code>username</code>: The username of the <code>Shenyu-Admin</code></li><li><code>password</code>: The password of the <code>Shenyu-Admin</code></li><li><code>port</code>: the start port of your project, currently <code>springmvc/tars/grpc</code> needs to be filled in.</li><li><code>contextPath</code>: the routing prefix for your <code>mvc</code> project in <code>shenyu</code> gateway, such as <code>/order</code>, <code>/product</code>, etc. The gateway will route according to your prefix.</li><li><code>appName</code>: the name of your application, if not configured, it will take the value of <code>spring.application.name</code> by default.</li><li><code>isFull</code>: set <code>true</code> to proxy your entire service, <code>false</code> to proxy one of your <code>controllers</code>; currently applies to <code>springmvc/springcloud</code>.</li></ul><p>After the project starts, it will first load the configuration file, read the property information and generate the corresponding <code>Bean</code>.</p><p>The first configuration file read is <code>ShenyuSpringMvcClientConfiguration</code>, which is the <code>http</code> registration configuration class for the <code>shenyu</code> client, indicated by <code>@Configuration</code> which is a configuration class, and by <code>@ImportAutoConfiguration</code> which is a configuration class. to introduce other configuration classes. Create <code>SpringMvcClientEventListener</code>, which mainly handles metadata and <code>URI</code> information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Shenyu SpringMvc Client Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create SpringMvcClientEventListener to handle metadata and URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuClientCommonBeanConfiguration</code> is a <code>shenyu</code> client common configuration class that will create the <code>bean</code> common to the registry client.</p><ul><li>Create <code>ShenyuClientRegisterRepository</code>, which is created by factory class.</li><li>Create <code>ShenyuRegisterCenterConfig</code>, which reads the <code>shenyu.register</code> property configuration.</li><li>Create <code>ShenyuClientConfig</code>, read the <code>shenyu.client</code> property configuration.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Shenyu Client Common Bean Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientCommonBeanConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // create ShenyuClientRegisterRepository by factory </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientRegisterRepository shenyuClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuClientRegisterRepositoryFactory.newInstance(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create ShenyuRegisterCenterConfig to read shenyu.register properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // create ShenyuClientConfig to read shenyu.client properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientConfig shenyuClientConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuClientConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-httpclientregisterrepository"></a>2.2 HttpClientRegisterRepository<a class="hash-link" href="#22-httpclientregisterrepository" title="Direct link to heading">#</a></h4><p>The <code>ShenyuClientRegisterRepository</code> generated in the configuration file above is a concrete implementation of the client registration, which is an interface with the following implementation class.</p><p><img src="/assets/images/shenyu-client-register-repository-dba8edf50af1be31d8b53c9573b1e015.png"></p><ul><li><code>HttpClientRegisterRepository</code>: registration via <code>http</code>.</li><li><code>ConsulClientRegisterRepository</code>: registration via <code>Consul</code>.</li><li><code>EtcdClientRegisterRepository</code>: registration via <code>Etcd</code>; <code>EtcdClientRegisterRepository</code>: registration via <code>Etcd</code>.</li><li><code>NacosClientRegisterRepository</code>: registration via <code>nacos</code>; <code>NacosClientRegisterRepository</code>: registration via <code>nacos</code>.</li><li><code>ZookeeperClientRegisterRepository</code>: registration through <code>Zookeeper</code>.</li></ul><p>The specific way which is achieved by loading through <code>SPI</code>, the implementation logic is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * load ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Loading by means of SPI, type determined by registerType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //init ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The load type is specified by <code>registerType</code>, which is the type we specify in the configuration file at</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We specified <code>http</code>, so it will go to load <code>HttpClientRegisterRepository</code>. After the object is successfully created, the initialization method <code>init()</code> is executed as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository implements ShenyuClientRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Read <code>username</code>, <code>password</code> and <code>serverLists</code> from the configuration file, the username, password and address of <code>sheenyu-admin</code>, in preparation for subsequent data sending. The class annotation <code>@Join</code> is used for <code>SPI</code> loading.</p><blockquote><p><code>SPI</code>, known as <code>Service Provider Interface</code>, is a service provider discovery feature built into the <code>JDK</code>, a mechanism for dynamic replacement discovery.</p><p><a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-spi" target="_blank" rel="noopener noreferrer">shenyu-spi</a> is a custom <code>SPI</code> extension implementation for the <code>Apache ShenYu</code> gateway, designed and implemented with reference to Dubbo <a href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/" target="_blank" rel="noopener noreferrer">SPI extension implementation</a>.</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-springmvcclienteventlistener"></a>2.3 SpringMvcClientEventListener<a class="hash-link" href="#23-springmvcclienteventlistener" title="Direct link to heading">#</a></h4><p>Create <code>SpringMvcClientEventListener</code>, which is responsible for the construction and registration of client-side metadata and <code>URI</code> data, and its creation is done in the configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create SpringMvcClientEventListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>SpringMvcClientEventListener</code> implements the <code>AbstractContextRefreshedEventListener</code></p><p><img src="/assets/images/shenyu-client-event-listener-0cd56409c59f2546a285a6426f9c8fee.png"></p><p>The <code>AbstractContextRefreshedEventListener</code> is an abstract class. it implements the <code>ApplicationListener</code> interface and overrides the <code>onApplicationEvent()</code> method, which is executed when a Spring event occurs. It has several implementation classes, which support different kind of <code>RPC</code> styles.</p><ul><li><code>AlibabaDubboServiceBeanListener</code>Ôºöhandles <code>Alibaba Dubbo</code> protocol.</li><li><code>ApacheDubboServiceBeanListener</code>Ôºöhandles <code>Apache Dubbo</code> protocol.</li><li><code>GrpcClientEventListener</code>Ôºöhandles <code>grpc</code> protocol.</li><li><code>MotanServiceEventListener</code>Ôºöhandles <code>Motan</code> protocol.</li><li><code>SofaServiceEventListener</code>Ôºöhandles <code>Sofa</code> protocol.</li><li><code>SpringMvcClientEventListener</code>Ôºöhandles <code>http</code> protocol.</li><li><code>SpringWebSocketClientEventListener</code>Ôºöhandles <code>Websocket</code> protocol.</li><li><code>TarsServiceBeanEventListener</code>Ôºöhandles <code>Tars</code> protocol.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractContextRefreshedEventListener&lt;T, A extends Annotation&gt; implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Instantiation is done through the constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractContextRefreshedEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read shenyu.client.http properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // appName </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = Optional.ofNullable(props.getProperty(ShenyuClientConstants.CONTEXT_PATH)).map(UriUtils::repairData).orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;client register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.ipAndPort = props.getProperty(ShenyuClientConstants.IP_PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // This method is executed when a context refresh event(ContextRefreshedEvent), occurs</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The contents of the method are guaranteed to be executed only once</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ApplicationContext context = event.getApplicationContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the specific beans </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, T&gt; beans = getBeans(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (MapUtils.isEmpty(beans)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build URI data and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildURIRegisterDTO(context, beans));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build metadata and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        beans.forEach(this::handle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;all&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract URIRegisterDTO buildURIRegisterDTO(ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                          Map&lt;String, T&gt; beans);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handle(final String beanName, final T bean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = getCorrectedClass(bean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final A beanShenyuClient = AnnotatedElementUtils.findMergedAnnotation(clazz, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(clazz, beanShenyuClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleClass(clazz, bean, beanShenyuClient, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleMethod(bean, clazz, beanShenyuClient, method, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // default implementation. build URI data and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleClass(final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               @NonNull final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildMetaDataDTO(bean, beanShenyuClient, pathJoin(contextPath, superPath), clazz, null));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // default implementation. build metadata and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        A methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ÊûÑÂª∫ÂÖÉÊï∞ÊçÆÔºåÂèëÈÄÅÊ≥®ÂÜå‰∫ã‰ª∂</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract MetaDataRegisterDTO buildMetaDataDTO(T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            @NonNull A shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            String path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Method method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the constructor, the main purpose is to read the property information and then perform the checksum.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, publisher.start() is executed to start event publishing and prepare for registration.</p><p>ShenyuClientRegisterEventPublisher is implemented via singleton pattern, mainly generating metadata and URI subscribers (subsequently used for data publishing), and then starting the Disruptor queue. A common method publishEvent() is provided to publish events and send data to the Disruptor queue.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientRegisterEventPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuClientRegisterEventPublisher INSTANCE = new ShenyuClientRegisterEventPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;DataTypeParent&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterEventPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientExecutorFactory factory = new RegisterClientExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientMetadataExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientURIExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publishEvent(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;DataTypeParent&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of the constructor of <code>AbstractContextRefreshedEventListener</code> is analyzed, it mainly reads the property configuration, creates metadata and URI subscribers, and starts the Disruptor queue.</p><p>The <code>onApplicationEvent()</code> method is executed when a <code>Spring</code> event occurs, the parameter here is <code>ContextRefreshedEvent</code>, which means the context refresh event. </p><blockquote><p><code>ContextRefreshedEvent</code> is a <code>Spring</code> built-in event. It is fired when the <code>ApplicationContext</code> is initialized or refreshed. This can also happen in the <code>ConfigurableApplicationContext</code> interface using the <code>refresh()</code> method. Initialization here means that all <code>Bean</code>s have been successfully loaded, post-processing <code>Bean</code>s have been detected and activated, all <code>Singleton Bean</code>s have been pre-instantiated, and the <code>ApplicationContext</code> container is ready to be used.</p></blockquote><ul><li><code>SpringMvcClientEventListener</code>: the <code>http</code> implementation of <code>AbstractContextRefreshedEventListener</code>:</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientEventListener extends AbstractContextRefreshedEventListener&lt;Object, ShenyuSpringMvcClient&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;Class&lt;? extends Annotation&gt;&gt; mappingAnnotation = new ArrayList&lt;&gt;(3);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Boolean isFull;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÊûÑÈÄ†ÂáΩÊï∞</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(clientConfig, shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get isFull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // http protocol</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Map&lt;String, Object&gt; getBeans(final ApplicationContext context) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configuration attribute, if isFull=true, means register the whole microservice</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .contextPath(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .appName(getAppName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .path(PathUtils.decoratorPathWithSlash(getContextPath()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ruleName(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get bean with Controller annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context.getBeansWithAnnotation(Controller.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected URIRegisterDTO buildURIRegisterDTO(final ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final Map&lt;String, Object&gt; beans) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String buildApiSuperPath(final Class&lt;?&gt; clazz, @Nullable final ShenyuSpringMvcClient beanShenyuClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; StringUtils.isNotBlank(beanShenyuClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return beanShenyuClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(clazz, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Only the first path is supported temporarily</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Class&lt;ShenyuSpringMvcClient&gt; getAnnotationType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuSpringMvcClient.class;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final Object bean, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final ShenyuSpringMvcClient beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method, final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get RequestMapping annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get ShenyuSpringMvcClient annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // the result of ReflectionUtils#getUniqueDeclaredMethods contains method such as hashCode, wait, toSting</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add Objects.nonNull(requestMapping) to make sure not register wrong method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient) &amp;&amp; Objects.nonNull(requestMapping)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÊûÑÈÄ†ÂÖÉÊï∞ÊçÆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected MetaDataRegisterDTO buildMetaDataDTO(final Object bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   @NonNull final ShenyuSpringMvcClient shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final String path, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The registration logic is done through <code>publisher.publishEvent()</code>. </p><p>The <code>Controller</code> annotation and the <code>RequestMapping</code> annotation are provided by <code>Spring</code>, which you should be familiar with, so I won&#x27;t go into details. The <code>ShenyuSpringMvcClient</code> annotation is provided by <code>Apache ShenYu</code> to register the <code>SpringMvc</code> client, which is defined as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;path&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;value&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ruleName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // desc info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register MetaData </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean  registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It is used as follows.</p><ul><li>register the entire interface</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/test/**&quot;)  // register the entire interface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpTestController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>register current method</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Save order dto.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param orderDTO the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/save&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/save&quot;, desc = &quot;Save order&quot;) // register current method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO save(@RequestBody final OrderDTO orderDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDTO.setName(&quot;hello world save order&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>publisher.publishEvent()</li></ul><p>This method sends the data to the <code>Disruptor</code> queue. More details about the <code>Disruptor</code> queue are not described here, which does not affect the flow of analyzing the registration.</p><p>When the data is sent, the consumers of the <code>Disruptor</code> queue will process the data for consumption.</p><p>This method sends the data to the <code>Disruptor</code> queue. More details about the <code>Disruptor</code> queue are not described here, which does not affect the flow of analyzing the registration.</p><ul><li>QueueConsumer</li></ul><p><code>QueueConsumer</code> is a consumer that implements the <code>WorkHandler</code> interface, which is created in the <code>providerManage.startup()</code> logic. The <code>WorkHandler</code> interface is the data consumption interface for <code>Disruptor</code>, and the only method is <code>onEvent()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>QueueConsumer</code> overrides the <code>onEvent()</code> method, and the main logic is to generate the consumption task and then go to the thread pool to execute it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * QueueConsumer</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use different thread pools based on DataEvent type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create queue consumption tasks via factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // put in the thread pool to execute the consumption task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code> is the task that is executed in the thread pool, it implements the <code>Runnable</code> interface, and there are two specific implementation classes.</p><ul><li><code>RegisterClientConsumerExecutor</code>Ôºöthe client-side consumer executor.</li><li><code>RegisterServerConsumerExecutor</code>Ôºöserver-side consumer executor.</li></ul><p>As the name implies, one is responsible for handling client-side tasks, and one is responsible for handling server-side tasks (the server side is <code>admin</code>, which is analyzed below).</p><p><img src="/assets/images/consumer-executor-f7ad67d35abaa5a2fac94ef913445a19.png"></p><ul><li>RegisterClientConsumerExecutor</li></ul><p>The logic of the rewritten <code>run()</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterClientConsumerExecutor&lt;T extends DataTypeParent&gt; extends QueueConsumerExecutor&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final T data = getData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // call the appropriate processor for processing according to the data type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribers.get(data.getType()).executor(Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Different processors are called to perform the corresponding tasks based on different data types. There are two types of data, one is metadata, which records the client registration information. One is the <code>URI</code> data, which records the client service information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum DataType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    URI,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>The actuator subscribers are divided into two categories, one that handles metadata and one that handles <code>URIs</code>. There are two on the client side and two on the server side, so there are four in total.</p><p><img src="/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><p>Here is the registration metadata information, so the execution class is <code>ShenyuClientMetadataExecutorSubscriber</code>.</p><ul><li>ShenyuClientMetadataExecutorSubscriber#executor()</li></ul><p>The metadata processing logic on the client side is: iterate through the metadata information and call the interface method <code>persistInterface()</code> to finish publishing the data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientMetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (MetaDataRegisterDTO metaDataRegisterDTO : metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // call the interface method persistInterface() to finish publishing the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistInterface(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The two registration interfaces get the data well and call the <code>publish()</code> method to publish the data to the <code>Disruptor</code> queue.</p><ul><li><code>ShenyuServerRegisterRepository</code></li></ul><p>The <code>ShenyuServerRegisterRepository</code> interface is a service registration interface, which has five implementation classes, indicating five types of registration.</p><ul><li><code>ConsulServerRegisterRepository</code>: registration is achieved through <code>Consul</code>;</li><li><code>EtcdServerRegisterRepository</code>: registration through <code>Etcd</code>.</li><li><code>NacosServerRegisterRepository</code>: registration through <code>Nacos</code>.</li><li><code>ShenyuHttpRegistryController</code>: registration via <code>Http</code>; <code>ShenyuHttpRegistryController</code>: registration via <code>Http</code>.</li><li><code>ZookeeperServerRegisterRepository</code>: registration through <code>Zookeeper</code>.</li></ul><p><img src="/assets/images/client-register-repository-61756e3284c1d3a27083b25d393edf9c.png"></p><p>As you can see from the diagram, the loading of the registry is done by means of SPI. This was mentioned earlier, and the specific class loading is done in the client-side generic configuration file by specifying the properties in the configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * load ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // loading by means of SPI, type determined by registerType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // perform initialization operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The source code analysis in this article is based on the Http way of registration, so we first analyze the HttpClientRegisterRepository, and the other registration methods will be analyzed afterwards.</p><p>Registration by way of <code>http</code> is very simple, it is to call the tool class to send http requests. The registration metadata and URI are both called by the same method <code>doRegister()</code>, specifying the interface and type.</p><ul><li><code>Constants.URI_PATH</code> = <code>/shenyu-client/register-metadata</code>: the interface provided by the server for registering metadata.</li><li><code>Constants.META_PATH</code> = <code>/shenyu-client/register-uri</code>: Server-side interface for registering URIs.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository extends FailbackRegistryRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientRegisterRepository.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static URIRegisterDTO uriRegisterDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;String&gt; serverList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        init(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin paaword</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin server address</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set access token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Persist uri.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param registerDTO the register dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistURI(final URIRegisterDTO registerDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RuntimeUtils.listenByOther(registerDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(registerDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uriRegisterDTO = registerDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistInterface(final MetaDataRegisterDTO metadata) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(metadata, Constants.META_PATH, Constants.META_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uriRegisterDTO != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            uriRegisterDTO.setEventType(EventType.DELETED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRegister(uriRegisterDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setAccessToken() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional&lt;?&gt; login = RegisterUtils.doLogin(username, password, server.concat(Constants.LOGIN_PATH));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                login.ifPresent(v -&gt; this.accessToken = String.valueOf(v));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Login admin url :{} is fail, will retry. cause: {} &quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void doRegister(final T t, final String path, final String type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // iterate through the list of admin services (admin may be clustered)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            i++;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String concat = server.concat(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ËÆæÁΩÆËÆøÈóÆtoken</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new NullPointerException(&quot;accessToken is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // calling the tool class to send http requests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RegisterUtils.doRegister(GsonUtils.getInstance().toJson(t), concat, type, accessToken);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Register admin url :{} is fail, will retry. cause:{}&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (i == serverList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Serialize the data and send it via OkHttp.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Sending data via OkHttp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void doRegister(final String json, final String url, final String type) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasLength(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error accessToken is null, please check the config : {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Headers headers = new Headers.Builder().add(Constants.X_ACCESS_TOKEN, accessToken).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result = OkHttpTools.getInstance().post(url, json, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.equals(SUCCESS, result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;{} client register success: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, the logic of the client registering metadata by means of <code>http</code> is finished. To summarize: construct metadata by reading custom annotation information, send the data to the <code>Disruptor</code> queue, then consume the data from the queue, put the consumer into the thread pool to execute, and finally send an <code>http</code> request to the <code>admin</code>.</p><p>Similarly, <code>ShenyuClientURIExecutorSubscriber</code> is the execution class of registering <code>URI</code> information.</p><ul><li>ShenyuClientURIExecutorSubscriber#executor()</li></ul><p>The main logic is to iterate through the URI data collection and implement data registration through the persistURI() method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientURIExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (URIRegisterDTO uriRegisterDTO : dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Stopwatch stopwatch = Stopwatch.createStarted();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (Socket ignored = new Socket(uriRegisterDTO.getHost(), uriRegisterDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long sleepTime = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // maybe the port is delay exposed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 5) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;host:{}, port:{} connection failed, will retry&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                uriRegisterDTO.getHost(), uriRegisterDTO.getPort());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If the connection fails for a long time, Increase sleep time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 180) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sleepTime = 10000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TimeUnit.MILLISECONDS.sleep(sleepTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ex.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.delayOtherHooks();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistURI(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>while(true)</code> loop in the code is to ensure that the client has been successfully started and can connect via <code>host</code> and <code>port</code>.</p><p>The logic behind it is: add the <code>hook</code> function for gracefully stopping the client .</p><p>Data registration is achieved through the <code>persistURI()</code> method. The whole logic is also analyzed in the previous section, and ultimately it is the <code>OkHttp</code> client that initiates <code>http</code> to <code>shenyu-admin</code> and registers the <code>URI</code> by way of <code>http</code>.</p><p>The analysis of the registration logic of the client is finished here, and the metadata and URI data constructed are sent to the <code>Disruptor</code> queue, from which they are then consumed, read, and sent to <code>admin</code> via <code>http</code>.</p><p>The source code analysis of the client-side metadata and <code>URI</code> registration process is complete, with the following flow chart.</p><p><img src="/assets/images/client-metadata-uri-register-en-7ccc8df4fc77fdf28480f15a6de6022b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-server-side-registration-process"></a>3. Server-side registration process<a class="hash-link" href="#3-server-side-registration-process" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-shenyuhttpregistrycontroller"></a>3.1 ShenyuHttpRegistryController<a class="hash-link" href="#31-shenyuhttpregistrycontroller" title="Direct link to heading">#</a></h4><p>From the previous analysis, we know that the server side provides two interfaces for registration.</p><ul><li><code>/shenyu-client/register-metadata</code>: The interface provided by the server side is used to register metadata.</li><li><code>/shenyu-client/register-uri</code>: The server-side interface is provided for registering URIs.</li></ul><p>These two interfaces are located in <code>ShenyuHttpRegistryController</code>, which implements the <code>ShenyuServerRegisterRepository</code> interface and is the implementation class for server-side registration. It is marked with <code>@Join</code> to indicate loading via <code>SPI</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/shenyu-client&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuHttpRegistryController implements ShenyuServerRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuServerRegisterPublisher publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuServerRegisterPublisher publisher, final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.publisher = publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register Metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-metadata&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerMetadata(@RequestBody final MetaDataRegisterDTO metaDataRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-uri&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(@RequestBody final URIRegisterDTO uriRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The exact method used is specified by the configuration file and then loaded via <code>SPI</code>.</p><p>In the <code>application.yml</code> file in <code>shenyu-admin</code> configure the registration method, <code>registerType</code> specify the registration type, when registering with <code>http</code>, <code>serverLists</code> do not need to be filled in, for more configuration instructions you can refer to the official website <a href="https://shenyu.apache.org/zh/docs/user-guide/register-center-access" target="_blank" rel="noopener noreferrer">Client Access Configuration</a>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>RegisterCenterConfiguration </li></ul><p>After introducing the relevant dependencies and properties configuration, when starting <code>shenyu-admin</code>, the configuration file will be loaded first, and the configuration file class related to the registration center is <code>RegisterCenterConfiguration</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterCenterConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //create ShenyuServerRegisterRepository to register in admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuServerRegisterRepository shenyuServerRegisterRepository(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig, final List&lt;ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. get the registration type from the configuration property</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String registerType = shenyuRegisterCenterConfig.getRegisterType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. load the implementation class by registering the type with the SPI method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuServerRegisterRepository registerRepository = ExtensionLoader.getExtensionLoader(ShenyuServerRegisterRepository.class).getJoin(registerType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. get the publisher and write data to the Disruptor queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerDisruptorPublisher publisher = RegisterServerDisruptorPublisher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. ShenyuClientRegisterService, rpcType -&gt; registerService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuClientRegisterService&gt; registerServiceMap = shenyuClientRegisterService.stream().collect(Collectors.toMap(ShenyuClientRegisterService::rpcType, e -&gt; e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. start publisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(registerServiceMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. init registerRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRepository.init(publisher, shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerRepository;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Two <code>bean</code>s are generated in the configuration class.</p><ul><li><p><code>shenyuRegisterCenterConfig</code>: to read the attribute configuration.</p></li><li><p><code>shenyuServerRegisterRepository</code>: for server-side registration.</p></li></ul><p>In the process of creating <code>shenyuServerRegisterRepository</code>, a series of preparations are also performed.</p><ul><li><ol><li>get the registration type from the configuration property.</li></ol></li><li><ol start="2"><li>Load the implementation class by the registration type with the <code>SPI</code> method: for example, if the specified type is <code>http</code>, <code>ShenyuHttpRegistryController</code> will be loaded.</li></ol></li><li><ol start="3"><li>Get <code>publisher</code> and write data to the <code>Disruptor</code> queue.</li></ol></li><li><ol start="4"><li>Register <code>Service</code>, <code>rpcType -&gt; registerService</code>: get the registered <code>Service</code>, each <code>rpc</code> has a corresponding <code>Service</code>. The client for this article is built through <code>springboot</code>, which belongs to the <code>http</code> type, and other client types: <code>dubbo</code>, <code>Spring Cloud</code>, <code>gRPC</code>, etc.</li></ol></li><li><ol start="5"><li>Preparation for event publishing: add server-side metadata and <code>URI</code> subscribers, process the data. And start the <code>Disruptor</code> queue.</li></ol></li><li><ol start="6"><li>Initialization operation for registration: <code>http</code> type registration initialization operation is to save <code>publisher</code>.</li></ol></li></ul><ul><li>RegisterClientServerDisruptorPublisher#publish()</li></ul><p>The server-side publisher that writes data to the <code>Disruptor</code> queue , built via the singleton pattern.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterClientServerDisruptorPublisher implements ShenyuServerRegisterPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final RegisterClientServerDisruptorPublisher INSTANCE = new     private static final RegisterClientServerDisruptorPublisher INSTANCE = new RegisterServerDisruptorPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static RegisterClientServerDisruptorPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //prepare for event publishing, add server-side metadata and URI subscribers, process data. And start the Disruptor queue.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final Map&lt;String, ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerExecutorFactory factory = new RegisterServerExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add URI data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new URIRegisterExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add Metadata subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new MetadataExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //start Disruptor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write data to queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publish(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Object&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(Collections.singleton(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write data to queue on batch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final Collection&lt;? extends DataTypeParent&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(dataList.stream().map(DataTypeParent.class::cast).collect(Collectors.toList()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.getProvider().shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The loading of the configuration file, which can be seen as the initialization process of the registry server, is described in the following diagram.</p><p><img src="/assets/images/server-register-init-en-c20ecd9991817e159730a8aea38db110.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-queueconsumer"></a>3.2 QueueConsumer<a class="hash-link" href="#32-queueconsumer" title="Direct link to heading">#</a></h4><p>In the previous analysis of the client-side <code>disruptor</code> queue consumption of data over. The server side has the same logic, except that the executor performing the task changes.</p><p>The <code>QueueConsumer</code> is a consumer that implements the <code>WorkHandler</code> interface, which is created in the <code>providerManage.startup()</code> logic. The <code>WorkHandler</code> interface is the data consumption interface for <code>disruptor</code>, and the only method is <code>onEvent()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T var1) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>QueueConsumer</code> overrides the <code>onEvent()</code> method, and the main logic is to generate the consumption task and then go to the thread pool to execute it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * QueueConsumer</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use different thread pools based on DataEvent type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create queue consumption tasks via factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // put in the thread pool to execute the consumption task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code> is the task that is executed in the thread pool, it implements the <code>Runnable</code> interface, and there are two specific implementation classes.</p><ul><li><code>RegisterClientConsumerExecutor</code>: the client-side consumer executor.</li><li><code>RegisterServerConsumerExecutor</code>: server-side consumer executor.</li></ul><p>As the name implies, one is responsible for handling client-side tasks and one is responsible for handling server-side tasks.</p><ul><li><code>RegisterServerConsumerExecutor#run()</code></li></ul><p><code>RegisterServerConsumerExecutor</code> is a server-side consumer executor that indirectly implements the <code>Runnable</code> interface via <code>QueueConsumerExecutor</code> and overrides the <code>run()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterServerConsumerExecutor extends QueueConsumerExecutor&lt;List&lt;DataTypeParent&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get the data from the disruptor queue and check data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;DataTypeParent&gt; results = getData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(this::isValidData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //execute operations according to type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getType(results).executor(results);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get subscribers by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ExecutorSubscriber&lt;DataTypeParent&gt; selectExecutor(final Collection&lt;DataTypeParent&gt; list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Optional&lt;DataTypeParent&gt; first = list.stream().findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return subscribers.get(first.orElseThrow(() -&gt; new RuntimeException(&quot;the data type is not found&quot;)).getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>The actuator subscribers are divided into two categories, one that handles metadata and one that handles <code>URIs</code>. There are two on the client side and two on the server side, so there are four in total.</p><p><img src="/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><ul><li>MetadataExecutorSubscriber#executor()</li></ul><p>In case of registering metadata, this is achieved by <code>MetadataExecutorSubscriber#executor()</code>: get the registered <code>Service</code> according to the type and call <code>register()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class MetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Traversing the metadata list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataRegisterDTOList.forEach(meta -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(this.shenyuClientRegisterService.get(meta.getRpcType())) // Get registered Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(shenyuClientRegisterService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Registration of metadata, locking to ensure sequential execution and prevent concurrent errors</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            shenyuClientRegisterService.register(meta);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>URIRegisterExecutorSubscriber#executor()</li></ul><p>In case of registration metadata, this is achieved by <code>URIRegisterExecutorSubscriber#executor()</code>: construct <code>URI</code> data, find <code>Service</code> according to the registration type, and achieve registration by the <code>registerURI</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class URIRegisterExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        findService(dataList).ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; groupByRpcType = dataList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(data -&gt; StringUtils.isNotBlank(data.getRpcType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.groupingBy(URIRegisterDTO::getRpcType));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, List&lt;URIRegisterDTO&gt;&gt; entry : groupByRpcType.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String rpcType = entry.getKey();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Get registered Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(shenyuClientRegisterService.get(rpcType))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final List&lt;URIRegisterDTO&gt; list = entry.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Build URI data types and register them with the registerURI method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(list);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Find Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Optional&lt;ShenyuClientRegisterService&gt; findService(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dataList.stream().map(dto -&gt; shenyuClientRegisterService.get(dto.getRpcType())).findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterService#register()</li></ul><p><code>ShenyuClientRegisterService</code> is the registration method interface, which has several implementation classes.</p><p><img src="/assets/images/client-register-service-949e3110cb57db2f250dafdc41446eb4.png"></p><ul><li><code>AbstractContextPathRegisterService</code>: abstract class, handling part of the public logic.</li><li><code>AbstractShenyuClientRegisterServiceImpl</code>: : abstract class, handles part of the public logic.</li><li><code>ShenyuClientRegisterDivideServiceImpl</code>: <code>divide</code> class, handles <code>http</code> registration types.</li><li><code>ShenyuClientRegisterDubboServiceImpl</code>: <code>dubbo</code> class, handles <code>dubbo</code> registration types.</li><li><code>ShenyuClientRegisterGrpcServiceImpl</code>: <code>gRPC</code> class, handles <code>gRPC</code> registration types.</li><li><code>ShenyuClientRegisterMotanServiceImpl</code>: <code>Motan</code> class, handles <code>Motan</code> registration types.</li><li><code>ShenyuClientRegisterSofaServiceImpl</code>: <code>Sofa</code> class, handles <code>Sofa</code> registration types.</li><li><code>ShenyuClientRegisterSpringCloudServiceImpl</code>: <code>SpringCloud</code> class, handles <code>SpringCloud</code> registration types.</li><li><code>ShenyuClientRegisterTarsServiceImpl</code>: <code>Tars</code> class, handles <code>Tars</code> registration types.</li><li><code>ShenyuClientRegisterWebSocketServiceImpl</code>Ôºö <code>Websocket</code> classÔºåhandles <code>Websocket</code> registration types.</li></ul><p>From the above, we can see that each microservice has a corresponding registration implementation class. The source code analysis in this article is based on the official <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> as an example, it is of <code>http</code> registration type, so the registration implementation class for metadata and URI data is <code>ShenyuClientRegisterDivideServiceImpl</code>: <code>ShenyuClientRegisterDivideServiceImpl</code>.</p><ul><li>register(): </li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.register selector information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.register rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.register metadata information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.register contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The whole registration logic can be divided into 4 steps.</p><ul><li><ol><li>Register selector information</li></ol></li><li><ol start="2"><li>Register rule information</li></ol></li><li><ol start="3"><li>Register metadata information</li></ol></li><li><ol start="4"><li>Register `contextPath</li></ol></li></ul><p>This side of <code>admin</code> requires the construction of selectors, rules, metadata and <code>ContextPath</code> through the metadata information of the client. The specific registration process and details of processing are related to the <code>rpc</code> type. We will not continue to track down the logical analysis of the registration center, tracking to this point is enough.</p><p>The source code of the server-side metadata registration process is analyzed and the flow chart is described as follows.</p><p><img src="/assets/images/server-metadata-register-en-8290907a57a1189a4b5863f3c47254bb.png"></p><ul><li>registerURI()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Does the corresponding selector exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Handle handler information in the selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(uriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Update records in the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish Event to gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After <code>admin</code> gets the <code>URI</code> data, it mainly updates the <code>handler</code> information in the selector, then writes it to the database, and finally publishes the event notification gateway. The logic of notifying the gateway is done by the data synchronization operation, which has been analyzed in the previous article, so we will not repeat it.</p><p>The source code analysis of the server-side <code>URI</code> registration process is complete and is described in the following diagram.</p><p><img src="/assets/images/server-uri-register-en-6026d791dbc404cadee04b237add0691.png"></p><p>At this point, the server-side registration process is also analyzed, mainly through the interface provided externally, accept the registration information from the client, and then write to the <code>Disruptor</code> queue, and then consume data from it, and update the <code>admin</code> selector, rules, metadata and selector <code>handler</code> according to the received metadata and <code>URI</code> data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-summary"></a>4. Summary<a class="hash-link" href="#4-summary" title="Direct link to heading">#</a></h3><p>This article focuses on the <code>http registration</code> module of the <code>Apache ShenYu</code> gateway for source code analysis. The main knowledge points involved are summarized as follows.</p><ul><li>The register center is for registering client information to <code>admin</code> to facilitate traffic filtering.</li><li><code>http</code> registration is to register client metadata information and <code>URI</code> information to <code>admin</code>.</li><li><code>http</code> service access is identified by the annotation <code>@ShenyuSpringMvcClient</code>.</li><li>construction of the registration information mainly through the application listener <code>ApplicationListener</code>.</li><li>loading of the registration type is done through <code>SPI</code>.</li><li>The <code>Disruptor</code> queue was introduced to decouple data from operations, and data buffering.</li><li>The implementation of the registry uses interface-oriented programming, using design patterns such as template methods, singleton, and observer.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/http">http</a><a class="margin-horiz--sm" href="/blog/tags/register-center">register center</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin">Code Analysis For Dubbo Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-21T03:49:52.511Z">July 21, 2023</time> ¬∑ 22 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive <code>API</code> gateway.</p></blockquote><p>The <code>Apache ShenYu</code> gateway uses the <code>dubbo</code> plugin to make calls to the <code>dubbo</code> service. You can see the official documentation <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo" target="_blank" rel="noopener noreferrer">Dubbo Quick Start</a> to learn how to use the plugin.</p><blockquote><p>This article is based on <code>shenyu-2.4.3</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/zh/docs/user-guide/dubbo-proxy/" target="_blank" rel="noopener noreferrer">Dubbo Service Access</a> for the introduction of the official website.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-service-registration"></a>1. Service Registration<a class="hash-link" href="#1-service-registration" title="Direct link to heading">#</a></h3><p>Take the example provided on the official website <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-dubbo/shenyu-examples-apache-dubbo-service" target="_blank" rel="noopener noreferrer">shenyu-examples-dubbo</a>. Suppose your <code>dubbo</code> service is defined as follows (<code>spring-dubbo.xml</code>).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">xsi</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">dubbo</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://code.alibabatech.com/schema/dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xsi:</span><span class="token tag attr-name" style="color:#00a4db">schemaLocation</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://code.alibabatech.com/schema/dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       https://code.alibabatech.com/schema/dubbo/dubbo.xsd</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">application</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">test-dubbo-service</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">registry</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">${dubbo.registry.address}</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">protocol</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">port</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">20888</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">service</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">timeout</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">10000</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">interface</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">org.apache.shenyu.examples.dubbo.api.service.DubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Declare the application service name, register the center address, use the <code>dubbo</code> protocol, declare the service interface, and the corresponding interface implementation class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * DubboTestServiceImpl.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the interface implementation class, use the annotation <code>@ShenyuDubboClient</code> to register the service with <code>shenyu-admin</code>. The role of this annotation and its rationale will be analyzed later.</p><p>The configuration information in the configuration file <code>application.yml</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8011</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">servlet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">context-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">main</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">allow-bean-definition-overriding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2181</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># dubbo registry</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dubbo  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the configuration file, declare the registry address used by <code>dubbo</code>. The <code>dubbo</code> service registers with <code>shenyu-admin</code>, using the method <code>http</code>, and the registration address is <code>http://localhost:9095</code>.</p><p>See <a href="https://shenyu.apache.org/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">Application Client Access</a> for more information on the use of the registration method.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--declaration-of-registration-interface"></a>1.1  Declaration of registration interface<a class="hash-link" href="#11--declaration-of-registration-interface" title="Direct link to heading">#</a></h4><p>Use the annotation <code>@ShenyuDubboClient</code> to register the service to the gateway. The simple <code>demo</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// dubbo sevice</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;) // need to be registered method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>annotation definition:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Works on classes and methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuDubboClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //desc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-scan-annotation-information"></a>1.2 Scan annotation information<a class="hash-link" href="#12-scan-annotation-information" title="Direct link to heading">#</a></h4><p>Annotation scanning is done through the <code>ApacheDubboServiceBeanListener</code>, which implements the <code>ApplicationListener&lt;ContextRefreshedEvent&gt;</code> interface and starts executing the event handler method when a context refresh event occurs during the <code>Spring</code> container startup <code>onApplicationEvent()</code>.</p><p>During constructor instantiation.</p><ul><li>Read property configuration</li><li>Start the thread pool</li><li>Start the registry for registering with <code>shenyu-admin</code></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboServiceBeanListener implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApacheDubboServiceBeanListener(final PropertiesConfig clientConfig, final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.Read property configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(&quot;apache dubbo client must config the contextPath or appName&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = contextPath;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = appName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.Start the thread pool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executorService = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder().setNameFormat(&quot;shenyu-apache-dubbo-client-thread-pool-%d&quot;).build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.Start the registry for registering with `shenyu-admin`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Context refresh event, execute method logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ApacheDubboServiceBeanListener#onApplicationEvent()</li></ul><p>Rewritten method logic: read <code>Dubbo</code> service <code>ServiceBean</code>, build metadata object and <code>URI</code> object, and register it with <code>shenyu-admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //read ServiceBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ServiceBean&gt; serviceBean = contextRefreshedEvent.getApplicationContext().getBeansOfType(ServiceBean.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (serviceBean.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //The method is guaranteed to be executed only once</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //handle metadata </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, ServiceBean&gt; entry : serviceBean.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler(entry.getValue());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //handle URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceBean.values().stream().findFirst().ifPresent(bean -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(bean));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>handler()</p><p>In the <code>handler()</code> method, read all methods from the <code>serviceBean</code>, determine if there is a <code>ShenyuDubboClient</code> annotation on the method, build a metadata object if it exists, and register the method with <code>shenyu-admin</code> through the registry.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void handler(final ServiceBean&lt;?&gt; serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get proxy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object refProxy = serviceBean.getRef();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = refProxy.getClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (AopUtils.isAopProxy(refProxy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clazz = AopUtils.getTargetClass(refProxy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //all methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //read ShenyuDubboClient annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuDubboClient shenyuDubboClient = method.getAnnotation(ShenyuDubboClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(shenyuDubboClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //build meatdata and registry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(serviceBean, shenyuDubboClient, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildMetaDataDTO()</p><p>Constructs a metadata object where the necessary information for method registration is constructed and subsequently used for selector or rule matching.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO(final ServiceBean&lt;?&gt; serviceBean, final ShenyuDubboClient shenyuDubboClient, final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //app name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = buildAppName(serviceBean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = contextPath + shenyuDubboClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //desc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String desc = shenyuDubboClient.desc();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //service name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String serviceName = serviceBean.getInterface();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configRuleName = shenyuDubboClient.ruleName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleName = (&quot;&quot;.equals(configRuleName)) ? path : configRuleName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //method name </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String methodName = method.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //parameter Types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] parameterTypesClazz = method.getParameterTypes();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String parameterTypes = Arrays.stream(parameterTypesClazz).map(Class::getName).collect(Collectors.joining(&quot;,&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .serviceName(serviceName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .methodName(methodName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(ruleName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(desc)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .parameterTypes(parameterTypes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcExt(buildRpcExt(serviceBean)) //dubbo ext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuDubboClient.enabled())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildRpcExt()</p><p> <code>dubbo</code> ext information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   private String buildRpcExt(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       DubboRpcExt build = DubboRpcExt.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .group(StringUtils.isNotEmpty(serviceBean.getGroup()) ? serviceBean.getGroup() : &quot;&quot;)//group</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .version(StringUtils.isNotEmpty(serviceBean.getVersion()) ? serviceBean.getVersion() : &quot;&quot;)//version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .loadbalance(StringUtils.isNotEmpty(serviceBean.getLoadbalance()) ? serviceBean.getLoadbalance() : Constants.DEFAULT_LOADBALANCE)//load balance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .retries(Objects.isNull(serviceBean.getRetries()) ? Constants.DEFAULT_RETRIES : serviceBean.getRetries())//retry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .timeout(Objects.isNull(serviceBean.getTimeout()) ? Constants.DEFAULT_CONNECT_TIMEOUT : serviceBean.getTimeout())//time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .sent(Objects.isNull(serviceBean.getSent()) ? Constants.DEFAULT_SENT : serviceBean.getSent())//sent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .cluster(StringUtils.isNotEmpty(serviceBean.getCluster()) ? serviceBean.getCluster() : Constants.DEFAULT_CLUSTER)//cluster</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .url(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return GsonUtils.getInstance().toJson(build);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><ul><li><p>buildURIRegisterDTO()</p><p>Construct <code>URI</code> objects to register information about the service itself, which can be subsequently used for service probing live.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private URIRegisterDTO buildURIRegisterDTO(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(this.contextPath) //context path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(buildAppName(serviceBean))//app name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())//dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost()) //host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))//port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The specific registration logic is implemented by the registration center, please refer to <a href="https://shenyu.apache.org/zh/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">Client Access Principles</a> .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//To the registration center, post registration events   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">publisher.publishEvent();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-processing-registration-information"></a>1.3 Processing registration information<a class="hash-link" href="#13-processing-registration-information" title="Direct link to heading">#</a></h4><p>The metadata and <code>URI</code> data registered by the client through the registry are processed at the <code>shenyu-admin</code> end, which is responsible for storing to the database and synchronizing to the <code>shenyu</code> gateway. The client-side registration processing logic of the <code>Dubbo</code> plugin is in the <code>ShenyuClientRegisterDubboServiceImpl</code>. The inheritance relationship is as follows.</p><p><img src="/assets/images/ShenyuClientRegisterDubboServiceImpl-a48cc4b745cb6a47ee000cf08d4cff04.png"></p><ul><li>ShenyuClientRegisterService: client registration service, top-level interface.</li><li>FallbackShenyuClientRegisterService: registration failure, provides retry operation.</li><li>AbstractShenyuClientRegisterServiceImpl: abstract class, implements part of the public registration logic.</li><li>ShenyuClientRegisterDubboServiceImpl: implementation of the <code>Dubbo</code> plugin registration.</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="131-registration-service"></a>1.3.1 Registration Service<a class="hash-link" href="#131-registration-service" title="Direct link to heading">#</a></h5><ul><li><p>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</p><p>The metadata <code>MetaDataRegisterDTO</code> object registered by the client through the registry is picked up and dropped in the <code>register()</code> method of <code>shenyu-admin</code>.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1311-register-selector"></a>1.3.1.1 Register Selector<a class="hash-link" href="#1311-register-selector" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>Construct <code>contextPath</code>, find if the selector information exists, if it does, return <code>id</code>; if it doesn&#x27;t, create the default selector information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Find if selector information exists by name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a default selector message if it does not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>Default selector information</p><p>Construct the default selector information and its conditional properties here.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //register default selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //build selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //build the conditional properties of the default selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build default selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // default type cutom</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //default match mode</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //enable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //log</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build default selector conditional properties</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // default URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // default  match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Register default selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector conditional properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert selector information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // inserting selector conditional properties to the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Publish synchronization events to synchronize selection information and its conditional attributes to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1312-registration-rules"></a>1.3.1.2 Registration Rules<a class="hash-link" href="#1312-registration-rules" title="Direct link to heading">#</a></h6><p>In the second step of registering the service, start building the default rules and then register the rules.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. handle selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. handle rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. reigster metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ÈªòËÆ§ËßÑÂàôÂ§ÑÁêÜÂ±ûÊÄß</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Dubbo</code> plugin default rule handling properties.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * dubbo version.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String version;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * group.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String group;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * retry.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer retries = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * loadbalance:RANDOM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadbalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * timeout default 3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>build default rule</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>Registration rules: insert records to the database and publish events to the gateway for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert rule information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //insert  rule body conditional attributes into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());     </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish events to the gateway for data synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1313-register-metadata"></a>1.3.1.3 Register Metadata<a class="hash-link" href="#1313-register-metadata" title="Direct link to heading">#</a></h6><p>Metadata is mainly used for <code>RPC</code> service calls.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDubboServiceImpl#registerMetadata()</p><p>Insert or update metadata and then publish sync events to the gateway.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // get metaDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //insert or update metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish sync events to gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="132-register-uri"></a>1.3.2 Register URI<a class="hash-link" href="#132-register-uri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>The server side receives the <code>URI</code> information registered by the client and processes it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Retry after registration failure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>Get a valid <code>URI</code> from the <code>URI</code> registered by the client, update the corresponding selector <code>handle</code> property, and send a selector update event to the gateway.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // gte valid URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update the handle property of the selector to the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Send selector update events to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The source code analysis on service registration is completed as well as the analysis flow chart is as follows.</p><p><img src="/assets/images/dubbo-register-en-37db6c1d92c1763193e88e60de554e93.png"></p><p>The next step is to analyze how the <code>dubbo</code> plugin initiates calls to the <code>http</code> service based on this information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-service-invocation"></a>2. Service Invocation<a class="hash-link" href="#2-service-invocation" title="Direct link to heading">#</a></h3><p>The <code>dubbo</code> plugin is the core processing plugin used by the <code>ShenYu</code> gateway to convert <code>http</code> requests into the <code>dubbo protocol</code> and invoke the <code>dubbo</code> service.</p><p>Take the case provided by the official website <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo/" target="_blank" rel="noopener noreferrer">Quick Start with Dubbo</a> as an example, a <code>dubbo</code> service is registered with <code>shenyu-admin</code> through the registry, and then requested through the <code>ShenYu</code> gateway proxy, the request is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/dubbo/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The class inheritance relationship in the <code>Dubbo</code> plugin is as follows.</p><p><img src="/assets/images/ApacheDubboPlugin-286a36694f3fa121e7d3c7d67d08b833.png"></p><ul><li>ShenyuPlugin: top-level interface, defining interface methods.</li><li>AbstractShenyuPlugin: abstract class that implements plugin common logic.</li><li>AbstractDubboPlugin: dubbo plugin abstract class, implementing <code>dubbo</code> common logic.</li><li>ApacheDubboPlugin: ApacheDubbo plugin.</li></ul><blockquote><p>ShenYu Gateway supports ApacheDubbo and AlibabaDubbo\</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-receive-requests"></a>2.1 Receive requests<a class="hash-link" href="#21-receive-requests" title="Direct link to heading">#</a></h4><p>After passing the <code>ShenYu</code> gateway proxy, the request entry is <code>ShenyuWebHandler</code>, which implements the <code>org.springframework.web.server.WebHandler</code> interface.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * hanlde request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // execute default plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * execute.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // get plugin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // execute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-match-rule"></a>2.2 Match Rule<a class="hash-link" href="#22-match-rule" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>Execute the matching logic for selectors and rules in the <code>execute()</code> method.</p><ul><li>Matching selectors.</li><li>Matching rules.</li><li>Execute the plugin.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // execute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-execute-globalplugin"></a>2.3 Execute GlobalPlugin<a class="hash-link" href="#23-execute-globalplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.global.GlobalPlugin#execute()</li></ul><p><code>GlobalPlugin</code> is a global plugin that constructs contextual information in the <code>execute()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // shenyu context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ShenyuContextBuilder builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // build context information to be passed into the exchange</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = builder.build(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.CONTEXT, shenyuContext);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.global.DefaultShenyuContextBuilder#build()</li></ul><p>Build the default context information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DefaultShenyuContextBuilder implements ShenyuContextBuilder {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext build(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String, MetaData&gt; buildData = buildData(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //wrap ShenyuContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return decoratorMap.get(buildData.getLeft()).decorator(buildDefaultContext(exchange.getRequest()), buildData.getRight());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Pair&lt;String, MetaData&gt; buildData(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get the metadata according to the requested uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = MetaDataCache.getInstance().obtain(request.getURI().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; Boolean.TRUE.equals(metaData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.META_DATA, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(metaData.getRpcType(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(RpcTypeEnum.HTTP.getName(), new MetaData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //set the default context information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuContext buildDefaultContext(final ServerHttpRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appKey = request.getHeaders().getFirst(Constants.APP_KEY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sign = request.getHeaders().getFirst(Constants.SIGN);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = new ShenyuContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = request.getURI().getPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setPath(path); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setAppKey(appKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setSign(sign);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setTimestamp(timestamp);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setStartDateTime(LocalDateTime.now());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -&gt; shenyuContext.setHttpMethod(httpMethod.name()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.dubbo.common.context.DubboShenyuContextDecorator#decorator()</li></ul><p>wrap <code>ShenyuContext</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboShenyuContextDecorator implements ShenyuContextDecorator {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext decorator(final ShenyuContext shenyuContext, final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setModule(metaData.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setMethod(metaData.getServiceName()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setContextPath(metaData.getContextPath()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setRpcType(RpcTypeEnum.DUBBO.getName()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String rpcType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RpcTypeEnum.DUBBO.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-execute-rpcparamtransformplugin"></a>2.4 Execute RpcParamTransformPlugin<a class="hash-link" href="#24-execute-rpcparamtransformplugin" title="Direct link to heading">#</a></h4><p>The <code>RpcParamTransformPlugin</code> is responsible for reading the parameters from the <code>http</code> request, saving them in the <code>exchange</code> and passing them to the <code>rpc</code> service.</p><ul><li>org.apache.shenyu.plugin.base.RpcParamTransformPlugin#execute()</li></ul><p>In the <code>execute()</code> method, the core logic of the plugin is executed: get the request information from <code>exchange</code> and process the parameters according to the form of content passed in by the request.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class RpcParamTransformPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get request information from exchange</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerHttpRequest request = exchange.getRequest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuContext)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MediaType mediaType = request.getHeaders().getContentType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return body(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return formData(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //query</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return query(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; body(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(body -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, resolveBodyFromRequest(body));//Ëß£ÊûêbodyÔºå‰øùÂ≠òÂà∞exchange‰∏≠</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; formData(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(map -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String param = resolveBodyFromRequest(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LinkedMultiValueMap&lt;String, String&gt; linkedMultiValueMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        linkedMultiValueMap = BodyParamUtils.buildBodyParams(URLDecoder.decode(param, StandardCharsets.UTF_8.name())); //Ê†ºÂºèÂåñÊï∞ÊçÆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (UnsupportedEncodingException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return Mono.error(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.toMap(() -&gt; linkedMultiValueMap));// ‰øùÂ≠òÂà∞exchange‰∏≠</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //query</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; query(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.ofString(() -&gt; serverHttpRequest.getURI().getQuery()));//‰øùÂ≠òÂà∞exchange‰∏≠</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-execute-dubboplugin"></a>2.5 Execute DubboPlugin<a class="hash-link" href="#25-execute-dubboplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.dubbo.common.AbstractDubboPlugin#doExecute()</li></ul><p>In the <code>doExecute()</code> method, the main purpose is to check the metadata and parameters.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //param</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String param = exchange.getAttribute(Constants.PARAM_TRANSFORM);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //metaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = exchange.getAttribute(Constants.META_DATA);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check metaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!checkMetaData(metaData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot; path is : {}, meta data have error : {}&quot;, shenyuContext.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.META_DATA_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; StringUtils.isNoneBlank(metaData.getParameterTypes()) &amp;&amp; StringUtils.isBlank(param)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.DUBBO_HAVE_BODY_PARAM, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set rpcContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.rpcContext(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //dubbo invoke</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.doDubboInvoker(exchange, chain, selector, rule, metaData, param);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.ApacheDubboPlugin#doDubboInvoker()</li></ul><p>Set special context information in the <code>doDubboInvoker()</code> method, and then start the dubbo generalization call.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPlugin extends AbstractDubboPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doDubboInvoker(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final RuleData rule,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final MetaData metaData,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final String param) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set the current selector and rule information, and request address for dubbo graying support</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_RULE_ID, rule.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_REMOTE_ADDRESS, Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //dubbo generic invoker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;Object&gt; result = dubboProxyService.genericInvoker(param, metaData, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //execute next plugin in chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.then(chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.proxy.ApacheDubboProxyService#genericInvoker()</li></ul><p><code>genericInvoker()</code> method.</p><ul><li>Gets the <code>ReferenceConfig</code> object.</li><li>Gets the generalization service <code>GenericService</code> object.</li><li>Constructs the request parameter <code>pair</code> object.</li><li>Initiates an asynchronous generalization invocation.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboProxyService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Generic invoker object.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Object&gt; genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.Get the ReferenceConfig object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReferenceConfig&lt;GenericService&gt; reference = ApacheDubboConfigCache.getInstance().get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Failure of the current cache information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Reinitialization with metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference = ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.Get the GenericService object of the generalization service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        GenericService genericService = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.Constructing the request parameter pair object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String[], Object[]&gt; pair;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(metaData.getParameterTypes()) || ParamCheckUtils.dubboBodyIsEmpty(body)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = new ImmutablePair&lt;&gt;(new String[]{}, new Object[]{});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4.Initiating asynchronous generalization calls</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.fromFuture(invokeAsync(genericService, metaData.getMethodName(), pair.getLeft(), pair.getRight()).thenApply(ret -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //handle result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(ret)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = Constants.DUBBO_RPC_RESULT_EMPTY;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.RPC_RESULT, ret);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ret;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        })).onErrorMap(exception -&gt; exception instanceof GenericException ? new ShenyuException(((GenericException) exception).getExceptionMessage()) : new ShenyuException(exception));//Â§ÑÁêÜÂºÇÂ∏∏</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Generalized calls, asynchronous operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private CompletableFuture&lt;Object&gt; invokeAsync(final GenericService genericService, final String method, final String[] parameterTypes, final Object[] args) throws GenericException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        genericService.$invoke(method, parameterTypes, args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object resultFromFuture = RpcContext.getContext().getFuture();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFromFuture instanceof CompletableFuture ? (CompletableFuture&lt;Object&gt;) resultFromFuture : CompletableFuture.completedFuture(resultFromFuture);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Calling the <code>dubbo</code> service at the gateway can be achieved by generalizing the call.</p><p>The <code>ReferenceConfig</code> object is the key object to support generalization calls , and its initialization operation is done during data synchronization. There are two parts of data involved here, one is the synchronized plugin <code>handler</code> information and the other is the synchronized plugin metadata information.</p><ul><li>org.apache.shenyu.plugin.dubbo.common.handler.AbstractDubboPluginDataHandler#handlerPlugin()</li></ul><p>When the plugin data is updated, the data synchronization module synchronizes the data from <code>shenyu-admin</code> to the gateway. The initialization operation is performed in <code>handlerPlugin()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Initializing the configuration cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   protected abstract void initConfigCache(DubboRegisterConfig dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerPlugin(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(pluginData) &amp;&amp; Boolean.TRUE.equals(pluginData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Data deserialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig dubboRegisterConfig = GsonUtils.getInstance().fromJson(pluginData.getConfig(), DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig exist = Singleton.INST.get(DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || !dubboRegisterConfig.equals(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Perform initialization operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.initConfigCache(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Singleton.INST.single(DubboRegisterConfig.class, dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.handler.ApacheDubboPluginDataHandler#initConfigCache()</li></ul><p>Perform initialization operations.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPluginDataHandler extends AbstractDubboPluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void initConfigCache(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //perform initialization operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().init(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //cached results before failure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().invalidateAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#init()</li></ul><p>In the initialization, set <code>registryConfig</code> and <code>consumerConfig</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ApplicationConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(applicationConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            applicationConfig = new ApplicationConfig(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //When the protocol or address changes, you need to update the registryConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (needUpdateRegistryConfig(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RegistryConfig registryConfigTemp = new RegistryConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setProtocol(dubboRegisterConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setId(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setRegister(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setAddress(dubboRegisterConfig.getRegister());            Optional.ofNullable(dubboRegisterConfig.getGroup()).ifPresent(registryConfigTemp::setGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfig = registryConfigTemp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(consumerConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            consumerConfig = ApplicationModel.getConfigManager().getDefaultConsumer().orElseGet(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConsumerConfig consumerConfig = new ConsumerConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                consumerConfig.refresh();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return consumerConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getThreadpool()).ifPresent(consumerConfig::setThreadpool); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getCorethreads()).ifPresent(consumerConfig::setCorethreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getThreads()).ifPresent(consumerConfig::setThreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getQueues()).ifPresent(consumerConfig::setQueues);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Does the registration configuration need to be updated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean needUpdateRegistryConfig(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getRegister(), registryConfig.getAddress())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.subscriber.ApacheDubboMetaDataSubscriber#onSubscribe()</li></ul><p>When the metadata is updated, the data synchronization module synchronizes the data from <code>shenyu-admin</code> to the gateway. The metadata update operation is performed in the <code>onSubscribe()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboMetaDataSubscriber implements MetaDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //local memory cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, MetaData&gt; META_DATA = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //update metaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Whether the corresponding metadata exists</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaData exist = META_DATA.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || Objects.isNull(ApacheDubboConfigCache.getInstance().get(metaData.getPath()))) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // initRef</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The corresponding metadata has undergone an update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!Objects.equals(metaData.getServiceName(), exist.getServiceName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getRpcExt(), exist.getRpcExt())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getParameterTypes(), exist.getParameterTypes())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getMethodName(), exist.getMethodName())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //Build ReferenceConfig again based on the latest metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApacheDubboConfigCache.getInstance().build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //local memory cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.put(metaData.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //dalete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void unSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //‰ΩøReferenceConfigÂ§±Êïà</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.remove(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#initRef()</li></ul><p>Build <code>ReferenceConfig</code> objects from <code>metaData</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ReferenceConfig&lt;GenericService&gt; initRef(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //First try to get it from the cache, and return it directly if it exists</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ReferenceConfig&lt;GenericService&gt; referenceConfig = cache.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(referenceConfig.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return referenceConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init dubbo ref exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //build if not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Build reference config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @SuppressWarnings(&quot;deprecation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ReferenceConfig&lt;GenericService&gt; build(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(applicationConfig) || Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ReferenceConfig&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ReferenceConfig&lt;GenericService&gt; reference = new ReferenceConfig&lt;&gt;(); //ReferenceConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setGeneric(&quot;true&quot;); //generic invoke</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setAsync(true);//async</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setApplication(applicationConfig);//applicationConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setRegistry(registryConfig);//registryConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setConsumer(consumerConfig);//consumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setInterface(metaData.getServiceName());//serviceName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setProtocol(&quot;dubbo&quot;);//dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setCheck(false); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setLoadbalance(&quot;gray&quot;);//gray</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            parameters.put(&quot;dispatcher&quot;, &quot;direct&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setParameters(parameters);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String rpcExt = metaData.getRpcExt();//rpc ext param</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboParam dubboParam = parserToDubboParam(rpcExt);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(dubboParam)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getVersion())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setVersion(dubboParam.getVersion());//version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getGroup())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setGroup(dubboParam.getGroup());//group</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getUrl())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setUrl(dubboParam.getUrl());//url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getCluster())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setCluster(dubboParam.getCluster());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getTimeout()).ifPresent(reference::setTimeout);//timeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getRetries()).ifPresent(reference::setRetries);//retires</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getSent()).ifPresent(reference::setSent);//Whether to ack async-sent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get GenericService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object obj = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(obj)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;init apache dubbo reference success there meteData is :{}&quot;, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //cache reference</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    cache.put(metaData.getPath(), reference);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init apache dubbo reference exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return reference;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="26-execute-responseplugin"></a>2.6 Execute ResponsePlugin<a class="hash-link" href="#26-execute-responseplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>The response results are handled by the <code>ResponsePlugin</code> plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handle results according to rpc type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The processing type is determined by <code>MessageWriter</code> and the class inheritance relationship is as follows.</p><p><img src="/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriter: interface, defining message processing methods.</li><li>NettyClientMessageWriter: processing of <code>Netty</code> call results.</li><li>RPCMessageWriter: processing the results of <code>RPC</code> calls.</li><li>WebClientMessageWriter: processing the results of <code>WebClient</code> calls.</li></ul><p><code>Dubbo</code> service call, the processing result is <code>RPCMessageWriter</code> of course.</p><ul><li>org.apache.shenyu.plugin.response.strategy.RPCMessageWriter#writeWith()</li></ul><p>Process the response results in the <code>writeWith()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RPCMessageWriter implements MessageWriter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object result = exchange.getAttribute(Constants.RPC_RESULT); //result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(result)) { </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point in the analysis, the source code analysis of the <code>Dubbo</code> plugin is complete, and the analysis flow chart is as follows.</p><p><img src="/assets/images/dubbo-execute-en-230f6fe5b81c0ab5d10ed68025c16020.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-summary"></a>3. Summary<a class="hash-link" href="#3-summary" title="Direct link to heading">#</a></h3><p>The source code analysis in this article starts from <code>Dubbo</code> service registration to <code>Dubbo</code> plug-in service calls. The <code>Dubbo</code> plugin is mainly used to handle the conversion of <code>http</code> requests to the <code>dubbo</code> protocol, and the main logic is implemented through generalized calls.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/blog/tags/dubbo">dubbo</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-SPI">SPI Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-09-12T00:00:00.000Z">September 12, 2022</time> ¬∑ 18 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zjcscut/" target="_blank" rel="noopener noreferrer">Throwable</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="background"></a>background<a class="hash-link" href="#background" title="Direct link to heading">#</a></h2><p>Recently,when I read the source code of open source project Apache Shenyu API gateway,I find and many core components of the gateway are loaded with the SPI module. Here I will analyzes the source code of <code>SPI</code> module in <code>Shenyu</code> gateway.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-is-spi"></a>what is SPI<a class="hash-link" href="#what-is-spi" title="Direct link to heading">#</a></h2><p><code>SPI</code> means &#x27;Service Provider Interface&#x27;, which is a dynamic Service discovery mechanism. We can dynamically load the implementation class of the Interface based on the runtime of the Interface (that is, a development mode of Interface programming + strategy  pattern + configuration file) with it. The most common is the built-in database Driver interface &#x27;java.sql.Driver&#x27; in JDK. Different vendors can implement this interface differently. For example, &#x27;MySQL&#x27; (&#x27;com.mysql.jdbc.Driver&#x27; in the &#x27;MySQL&#x27; Driver package),&#x27; PostgreSQL&#x27; (&#x27;org.postgresql.driver&#x27; in the &#x27;PostgreSQL&#x27; Driver package), etc.</p><p><img alt="spi-jdk-api-diagram" src="/assets/images/spi-jdk-api-diagram-en-a4e0940e14c7a579fafb7727894d905f.png"></p><p>The JDK&#x27;s built-in &#x27;SPI&#x27; can be used as follows:</p><ul><li><p>In the &#x27;META-INF/services&#x27; directory of the classpath, create a file named with the fully qualified name of the interface (essentially a &#x27;properties&#x27; file) whose implementation classes you want the SPI loader to load , for example if you want to load the SQL driver implementation classes mentioned above then create a file named &#x27;java.sql.Driver&#x27; since those classes implement the &#x27;java.sql.driver&#x27; interface.</p></li><li><p>In this file we can add entries for all the specific implementations of the interface . For example for the above driver class scenario we would add entries as shown in below code snippet in the file <code>META-INF/services/java.sql.Driver</code></p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># content of file META-INF/services/java.sql.Driver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">com.mysql.jdbc.Driver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">org.postgresql.Driver</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Finally load the file with &#x27;java.util.ServiceLoader&#x27; to instantiate the corresponding implementation class of the interface</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceLoader&lt;Driver&gt; loader = ServiceLoader.load(Driver.class)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The underlying implementation involves classloading, the parent delegate model, and so on, which I won&#x27;t expand here. Based on this design idea, many mainstream frameworks self-implemented a set of &#x27;SPI&#x27; extension, such as &#x27;Dubbo SPI&#x27; extension module, which would read the &#x27;META-INF/services/dubbo&#x27; directory file content in the classppath for class loading. The &#x27;shenyu-spi&#x27; module also follows this similar design idea.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="source-code-of-shenyu-spi"></a>source code of shenyu-spi<a class="hash-link" href="#source-code-of-shenyu-spi" title="Direct link to heading">#</a></h2><p>The &#x27;shenyu-spi&#x27; module is very concise, and the code structure is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">- shenyu-spi[module]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  - org.apache.shenyu.spi[package]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SpiExtensionFactory</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Ëøô‰∫õÁ±ªÂäüËÉΩÂ¶Ç‰∏ãÔºö</p><ul><li>&#x27;ExtensionFactory&#x27; : &#x27;SPI&#x27; loader Factory, used to load an &#x27;ExtensionLoader&#x27; instance based on the &#x27;SPI&#x27; mechanism and to obtain the default &#x27;SPI&#x27; identity implementation based on the &#x27;ExtensionLoader&#x27; instance</li><li>&#x27;SpiExtensionFactory&#x27; : is an implementation of &#x27;ExtensionFactory&#x27;</li><li>&#x27;SPI&#x27; : identification annotation, used to identify &#x27;SPI&#x27;, used on the interface</li><li>&#x27;Join&#x27; : identification annotation, used on the implementation class, used to identify the class joining the SPI system</li><li>&#x27;ExtensionLoader&#x27; : &#x27;SPI&#x27; loader, analogous to &#x27;java.util.ServiceLoader&#x27;, used to load the implementation class of the interface in &#x27;SPI&#x27;</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi"></a>@SPI<a class="hash-link" href="#spi" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.SPI</code> is an identification annotation which is used for identifying an interface as a &#x27;SPI&#x27; interface.That is, only interfaces that use &#x27;@SPI&#x27; annotation can be loaded by &#x27;shenyu-spi&#x27;. The class&#x27;s annotation describes the implementation of Apache Dubbo, a reference to all the SPI systems (which makes sense, since the SPI extension is already a mature scheme with much the same implementation). This annotation has only one method:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface SPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Value string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the string</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The unique &#x27;value()&#x27; method is used to specify the default &#x27;SPI&#x27; implementation (optional), as will be shown later when analyzing &#x27;ExtensionLoader&#x27;.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="join"></a>@Join<a class="hash-link" href="#join" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.Join</code> is an identification annotation too. When this annotation is used on a class it specifies that  the class contains &#x27;SPI&#x27; implementation and to indicate that the class is added to the SPI system and can be loaded by ExtensionLoader. This annotation has two methods:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Indicates that the object joined by @Join is a singleton,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * otherwise a completely new instance is created each time.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true or false.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isSingleton() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The unique &#x27;order()&#x27; method is used to specify the specific sequence number. If a single interface that annotated with &#x27;@SPI&#x27; has multiple implementation classes that annotated with &#x27;@Join&#x27;, the sequence number determines the order of these implementation class instances (the smaller one comes first).</p><p>The isSingleton() method indicates whether the class that the implementation class is a singleton class or not. That is if it is a singleton class it will be instantiated only once else it will create a new instance everytime . </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionloader"></a>ExtensionLoader<a class="hash-link" href="#extensionloader" title="Direct link to heading">#</a></h3><p>&#x27;ExtensionLoader&#x27; is the core of the &#x27;SPI&#x27; module. Look at it&#x27;s attributes first:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ExtensionLoader&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SLF4JÊó•ÂøóÂè•ÊüÑ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(ExtensionLoader.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SPIÈÖçÁΩÆÊñá‰ª∂Âü∫‰∫éÁ±ªË∑ØÂæÑ‰∏ãÁöÑÁõ∏ÂØπÁõÆÂΩï</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // @SPIÊ†áËØÜÊé•Âè£Á±ªÂûã -&gt; ExtensionLoaderÂÆû‰æãÁöÑÁºìÂ≠ò =&gt; Ê≥®ÊÑèËøô‰∏™ÊòØ‰∏Ä‰∏™ÂÖ®Â±ÄÁöÑÈùôÊÄÅÂèòÈáè</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; LOADERS = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂΩìÂâç@SPIÊ†áËØÜÊé•Âè£Á±ªÂûã</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Class&lt;T&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Á±ªÂä†ËΩΩÂô®ÂÆû‰æã</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ClassLoader classLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂΩìÂâçExtensionLoaderÁºìÂ≠òÁöÑÂ∑≤Âä†ËΩΩÁöÑÂÆûÁé∞Á±ª‰ø°ÊÅØÔºå‰ΩøÁî®ÂÄºÊåÅÊúâÂô®ÂåÖË£ÖÔºåÊòØ‰∏Ä‰∏™HashMapÔºåÊò†Â∞ÑÂÖ≥Á≥ªÔºöÂÆûÁé∞Á±ªÂà´Âêç -&gt; ÂÆûÁé∞Á±ª‰ø°ÊÅØ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Holder&lt;Map&lt;String, ClassEntity&gt;&gt; cachedClasses = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂΩìÂâçExtensionLoaderÁºìÂ≠òÁöÑÂ∑≤Âä†ËΩΩÁöÑÂÆûÁé∞Á±ªÂÆû‰æãÁöÑÂÄºÂåÖË£ÖÂô®Ôºå‰ΩøÁî®ÂÄºÊåÅÊúâÂô®ÂåÖË£ÖÔºåÊò†Â∞ÑÂÖ≥Á≥ªÔºöÂÆûÁé∞Á±ªÂà´Âêç -&gt; ÂÄºÊåÅÊúâÂô®ÂåÖË£ÖÁöÑÂÆûÁé∞Á±ªÂÆû‰Ωì</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂΩìÂâçExtensionLoaderÁºìÂ≠òÁöÑÂ∑≤Âä†ËΩΩÁöÑÂÆûÁé∞Á±ªÂÆû‰æãÔºå‰ΩøÁî®ÂÄºÊåÅÊúâÂô®ÂåÖË£ÖÔºåÊò†Â∞ÑÂÖ≥Á≥ªÔºöÂÆûÁé∞Á±ªÁ±ªÂûã -&gt; ÂÆûÁé∞Á±ªÂÆû‰Ωì</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;Class&lt;?&gt;, Object&gt; joinInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÁºìÂ≠òÈªòËÆ§ÂêçÁß∞ÔºåÊù•Ê∫ê‰∫é@SPIÊ≥®Ëß£ÁöÑvalue()ÊñπÊ≥ïÈùûÁ©∫ÁôΩËøîÂõûÂÄºÔºåÁî®‰∫éÂä†ËΩΩÈªòËÆ§ÁöÑÊé•Âè£ÂÆûÁé∞</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String cachedDefaultName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // HolderÊØîËæÉÂô®ÔºåÊåâÁÖßHolderÁöÑorderÈôçÂ∫èÔºå‰πüÂ∞±ÊòØÈ°∫Â∫èÂè∑Â∞èÁöÑÊéíÂú®ÂâçÈù¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;Holder&lt;Object&gt;&gt; holderComparator = Comparator.comparing(Holder::getOrder);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ClassEntityÊØîËæÉÂô®ÔºåÊåâÁÖßClassEntityÁöÑorderÈôçÂ∫èÔºå‰πüÂ∞±ÊòØÈ°∫Â∫èÂè∑Â∞èÁöÑÊéíÂú®ÂâçÈù¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;ClassEntity&gt; classEntityComparator = Comparator.comparing(ClassEntity::getOrder);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÊöÇÊó∂ÁúÅÁï•ÂÖ∂‰ªñ‰ª£Á†Å</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂÄºÊåÅÊúâÂô®ÔºåÁÆÄÂçïVOÔºåÁî®Êù•Â≠òÂÇ®Ê≥õÂûãÂÄºÂíåÂÄºÂä†ËΩΩÈ°∫Â∫è</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class Holder&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ËøôÈáåÁöÑÂÄºÂºïÁî®ÊòØvolatile‰øÆÈ•∞Ôºå‰æø‰∫éÊüêÁ∫øÁ®ãÊõ¥ÂèòÂè¶‰∏ÄÁ∫øÁ®ãÈ©¨‰∏äËØªÂà∞ÊúÄÊñ∞ÁöÑÂÄº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private volatile T value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean isSingleton;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ÁúÅÁï•setterÂíågetter‰ª£Á†Å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Á±ªÂÆû‰ΩìÔºå‰∏ªË¶ÅÂ≠òÊîæÂä†ËΩΩÁöÑÂÆûÁé∞Á±ªÁöÑ‰ø°ÊÅØ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final class ClassEntity {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ÂêçÁß∞ÔºåËøôÈáåÊòØÊåáSPIÂÆûÁé∞Á±ªÁöÑÂà´ÂêçÔºå‰∏çÊòØÁ±ªÂêç</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Âä†ËΩΩÈ°∫Â∫èÂè∑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Boolean isSingleton;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // SPIÂÆûÁé∞Á±ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Class&lt;?&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private ClassEntity(final String name, final Integer order, final Class&lt;?&gt; clazz, final boolean isSingleton) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.name = name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.order = order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.isSingleton = isSingleton;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ÁúÅÁï•setterÂíågetter‰ª£Á†Å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After analyzing the attributes, it is not difficult to find the following points:</p><ul><li>&#x27;ExtensionLoader&#x27; There will be a global static cache &#x27;LOADERS&#x27; to cache already created instances of &#x27;ExtensionLoader&#x27; to prevent the performance overhead of repeated creation</li><li>Each &#x27;@SPI&#x27; interface that is loaded using &#x27;ExtensionLoader&#x27; generates a new instance of &#x27;ExtensionLoader&#x27;</li><li>&#x27;@SPI&#x27; interfaces that have multiple implementations are eventually acquired in order</li></ul><p>Then look at it&#x27;s constructors and static factory methods:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ÁßÅÊúâÊûÑÈÄ†ÂáΩÊï∞ÔºåÈúÄË¶ÅÂÖ•ÂèÇ‰∏∫@SPIÊ†áËØÜÁöÑÊé•Âè£Á±ªÂûãÂíåÁ±ªÂä†ËΩΩÂô®ÂÆû‰æã</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private ExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÊàêÂëòÂèòÈáèclazzËµãÂÄº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÊàêÂëòÂèòÈáèclassLoaderËµãÂÄº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.classLoader = cl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ËøôÈáåÂØπ‰∫éÈùûExtensionFactoryÊé•Âè£Á±ªÂûã‰ºöÊáíÂä†ËΩΩ‰∏Ä‰∏™Áî®‰∫éÂä†ËΩΩExtensionFactoryÁöÑExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Objects.equals(clazz, ExtensionFactory.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getExtensionClassesEntity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// ÂÆû‰æãÂåñgetExtensionLoaderÔºåÈùôÊÄÅÂ∑•ÂéÇÊñπÊ≥ïÔºåÈúÄË¶ÅÂÖ•ÂèÇ‰∏∫@SPIÊ†áËØÜÁöÑÊé•Âè£Á±ªÂûãÂíåÁ±ªÂä†ËΩΩÂô®ÂÆû‰æã</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂâçÁºÄÊ†°È™åÔºåÊé•Âè£Á±ªÂûãÂøÖÈ°ªÈùûÁ©∫Âπ∂‰∏îÂøÖÈ°ªÂ≠òÂú®@SPIÊ≥®Ëß£ÔºåÂê¶ÂàôÊäõÂá∫ÂºÇÂ∏∏‰∏≠Êñ≠</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Objects.requireNonNull(clazz, &quot;extension clazz is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isInterface()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) is not interface!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAnnotationPresent(SPI.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) without @&quot; + SPI.class + &quot; Annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ‰ªéÁºìÂ≠òLOADERS‰∏≠Âä†ËΩΩExtensionLoaderÂÆû‰æãÔºå‰∏çÂ≠òÂú®ÂàôÂàõÂª∫ÔºåÂÖ∏ÂûãÁöÑÊáíÂä†ËΩΩÊ®°Âºè</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExtensionLoader&lt;T&gt; extensionLoader = (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(extensionLoader)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extensionLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOADERS.putIfAbsent(clazz, new ExtensionLoader&lt;&gt;(clazz, cl));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// ÂÆû‰æãÂåñgetExtensionLoaderÔºåÈùôÊÄÅÂ∑•ÂéÇÊñπÊ≥ïÔºåÈúÄË¶ÅÂÖ•ÂèÇ‰∏∫@SPIÊ†áËØÜÁöÑÊé•Âè£Á±ªÂûãÔºå‰ΩøÁî®ExtensionLoaderÁ±ªÁöÑÁ±ªÂä†ËΩΩÂô®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getExtensionLoader(clazz, ExtensionLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>&#x27;ExtensionLoader&#x27; uses a private constructor, static factory methods, and lazy loading mode. Class loading is not triggered after initializing &#x27;ExtensionLoader&#x27;. The actual scanning and loading is delayed until the &#x27;getJoin&#x27; series methods are called, where the code is swept and all the method call chains that implement class information are loaded:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Âä†ËΩΩÊâÄÊúâÊâ©Â±ïÁ±ª‰ø°ÊÅØÔºåËøôÈáåÈááÁî®‰∫ÜDCLÔºàÂèåÈáçÈîÅÊ†°È™åÔºâÈò≤Ê≠¢Âπ∂ÂèëÂä†ËΩΩ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; getExtensionClassesEntity() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÁºìÂ≠ò‰∏çÂ≠òÂú®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Âä†ÈîÅÂêéÂÜçÊ£ÄÊü•‰∏ÄÊ¨°ÁºìÂ≠ò</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedClasses) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ÊúÄÁªàÁ°ÆËÆ§ÁºìÂ≠ò‰∏çÂ≠òÂú®ÔºåÂàôËøõË°åÂä†ËΩΩÔºåÂπ∂‰∏îÊ†áËÆ∞È°∫Â∫èÂè∑‰∏∫0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                classes = loadExtensionClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setValue(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setOrder(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Âä†ËΩΩÂΩìÂâçExtensionLoader‰∏≠clazzÁöÑÊâÄÊúâSPIÁ≥ªÁªüÂÜÖÁöÑÂÆûÁé∞Á±ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; loadExtensionClass() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SPI annotation = clazz.getAnnotation(SPI.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(annotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ËøôÈáåÂ∞±ÊòØÂâçÈù¢ÊèêÂà∞ÔºåÂ¶ÇÊûú@SPIÊ≥®Ëß£ÁöÑvalue()ÊñπÊ≥ïÈùûÁ©∫ÁôΩËøîÂõûÂÄº‰ºö‰Ωú‰∏∫ÈªòËÆ§ÂÆûÁé∞ÁöÑÂà´Âêç</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ‰πüÂ∞±ÊòØÂ¶ÇÊûúÂè™‰ΩøÁî®‰∫Ü@SPIÔºåÈÇ£‰πàÂ∞±Êó†Ê≥ïËé∑ÂèñÈªòËÆ§ÂÆûÁé∞</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Â¶ÇÊûú‰ΩøÁî®‰∫Ü@SPI(&quot;foo&quot;)ÔºåÂèØ‰ª•ÈÄöËøáÂà´ÂêçfooÂéªÊò†Â∞ÑÂíåËé∑ÂèñÈªòËÆ§ÂÆûÁé∞</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String value = annotation.value();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cachedDefaultName = value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂàùÂßãÂåñ‰∏Ä‰∏™HashmapÂÆπÂô®Áî®‰∫éÂ≠òÂÇ®Âä†ËΩΩÁöÑÂÆûÁé∞Á±ª‰ø°ÊÅØÔºåËøô‰∏™ÂèòÈáè‰ºöÈÄè‰º†Âà∞‰∏ã‰∏Ä‰∏™ÊñπÊ≥ïÈìæ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = new HashMap&lt;&gt;(16);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Âä†ËΩΩÁõÆÂΩï‰∏≠ÁöÑÂ±ûÊÄßÊñá‰ª∂</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadDirectory(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Âä†ËΩΩÁõÆÂΩï‰∏≠ÁöÑÂ±ûÊÄßÊñá‰ª∂ÔºåÂπ∂‰∏îÂä†ËΩΩÊñá‰ª∂‰∏≠ÁöÑÂÆûÁé∞Á±ªÔºåÁõÆÊ†áÁõÆÂΩïÔºöMETA-INF/shenyu/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadDirectory(final Map&lt;String, ClassEntity&gt; classes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Êñá‰ª∂Âêç =&gt; META-INF/shenyu/$className</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = SHENYU_DIRECTORY + clazz.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ËøôÈáå‰ΩøÁî®Á±ªÂä†ËΩΩÂô®Âä†ËΩΩÊñá‰ª∂ËµÑÊ∫êÔºåÂ¶ÇÊûú‰º†ÂÖ•ÁöÑÁ±ªÂä†ËΩΩÂô®‰∏∫Á©∫‰ºö‰ΩøÁî®Á≥ªÁªüÁ±ªÂä†ËΩΩÂô®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;URL&gt; urls = Objects.nonNull(this.classLoader) ? classLoader.getResources(fileName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : ClassLoader.getSystemResources(fileName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ÈÅçÂéÜËß£ÊûêÁöÑÊñá‰ª∂URLÈõÜÂêà</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(urls)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (urls.hasMoreElements()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                URL url = urls.nextElement();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ÈÄöËøáÊñá‰ª∂URLÂä†ËΩΩËµÑÊ∫ê</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                loadResources(classes, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.error(&quot;load extension class error {}&quot;, fileName, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Âä†ËΩΩÊñá‰ª∂ËµÑÊ∫êÔºåËß£ÊûêÊñá‰ª∂Âπ∂‰∏îÂä†ËΩΩÂÆûÁé∞Á±ªÂ≠òÂÇ®Âà∞classes‰∏≠</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadResources(final Map&lt;String, ClassEntity&gt; classes, final URL url) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ËØªÂèñURLÊñá‰ª∂ËµÑÊ∫êÔºåÂä†ËΩΩÂà∞Properties‰∏≠ÔºåÊØèË°åÊ†ºÂºè‰∏∫name=classPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (InputStream inputStream = url.openStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.load(inputStream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.forEach((k, v) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String name = (String) k;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String classPath = (String) v;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(name) &amp;&amp; StringUtils.isNotBlank(classPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Âü∫‰∫énameÂíåclassPathËøõË°åÁ±ªÂä†ËΩΩ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    loadClass(classes, name, classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (ClassNotFoundException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Âü∫‰∫énameÔºàÂà´ÂêçÔºâÂíåclassPathÔºàÁ±ªÂÖ®ÈôêÂÆöÂêçÁß∞ÔºâËøõË°åÁ±ªÂä†ËΩΩ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadClass(final Map&lt;String, ClassEntity&gt; classes,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String name, final String classPath) throws ClassNotFoundException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Á±ªÂàùÂßãÂåñÔºåÂπ∂‰∏îÁ°ÆÂÆöÂÆûÁé∞Á±ªÂøÖÈ°ªÊòØÂΩìÂâç@SPIÊ≥®Ëß£Ê†áËØÜÊé•Âè£ÁöÑÂ≠êÁ±ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; subClass = Objects.nonNull(this.classLoader) ? Class.forName(classPath, true, this.classLoader) : Class.forName(classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAssignableFrom(subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; subtype is not of &quot; + clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ÂÆûÁé∞Á±ªÂøÖÈ°ªÂ≠òÂú®Ê≥®Ëß£@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!subClass.isAnnotationPresent(Join.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; without @&quot; + Join.class + &quot; annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Â¶ÇÊûúÁºìÂ≠ò‰∏≠‰∏çÂ≠òÂú®ÂêåÊ†∑Âà´ÂêçÁöÑÂÆûÁé∞Á±ªÊâçËøõË°åÁºìÂ≠òÔºåÂ∑≤ÁªèÂ≠òÂú®ÂàôÊ†°È™åÊóßÁöÑÁ±ªÂûãÂíåÂΩìÂâçÂÆûÁé∞Á±ªÂûãÊòØÂê¶‰∏ÄËá¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity oldClassEntity = classes.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(oldClassEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ÂàõÂª∫Á±ª‰ø°ÊÅØÂÆû‰Ωì‰øùÂ≠òÂà´Âêç„ÄÅÈ°∫Â∫èÂè∑ÂíåÂÆûÁé∞Á±ªÂπ∂‰∏îÁºìÂ≠òÔºåÊò†Â∞ÑÂÖ≥Á≥ªÔºöÂà´Âêç -&gt; Á±ª‰ø°ÊÅØÂÆû‰Ωì</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Join joinAnnotation = subClass.getAnnotation(Join.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassEntity classEntity = new ClassEntity(name, joinAnnotation.order(), subClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classes.put(name, classEntity);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (!Objects.equals(oldClassEntity.getClazz(), subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,Duplicate class &quot; + clazz.getName() + &quot; name &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                + name + &quot; on &quot; + oldClassEntity.getClazz().getName() + &quot; or &quot; + subClass.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Processing with the chain of method &#x27;getExtensionClassesEntity - &gt; loadExtensionClass - &gt; loadDirectory - &gt; loadResources - &gt; LoadClass&#x27;,it will create a mapping of &#x27;alias&#x27; to &#x27;implementation class information&#x27; for subsequent instantiations, as shown in the &#x27;getJoin()&#x27; method:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Âü∫‰∫éÂà´ÂêçËé∑ÂèñÂÆûÁé∞Á±ªÂÆû‰æã</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public T getJoin(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Âà´ÂêçÂøÖÈ°ª‰∏∫ÈùûÁ©∫ÁôΩÂ≠óÁ¨¶‰∏≤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(name)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NullPointerException(&quot;get join name is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ËøôÈáå‰πü‰ΩøÁî®DCLÂéªcachedInstancesÁºìÂ≠ò‰∏≠ÂèñÂà´ÂêçÂØπÂ∫îÁöÑÂÄºÊåÅÊúâÂô®ÔºåÂÄºÊåÅÊúâÂô®‰∏∫Á©∫ÂàôÂàõÂª∫</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;Object&gt; objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(objectHolder)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedInstances.putIfAbsent(name, new Holder&lt;&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedInstances) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Âä†ÈîÅÂêéÂÜçÊ¨°Âà§Êñ≠ÂÄºÊåÅÊúâÂô®‰∏≠ÁöÑÂÄºÊòØÂê¶Â≠òÂú®Ôºå‰∏çÂ≠òÂú®ÁöÑÊó∂ÂÄôÂàôËøõË°åÂÆûÁé∞Á±ªÂÆû‰æãÂåñ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Holder&lt;T&gt; pair = createExtension(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                value = pair.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                int order = pair.getOrder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ÂÆû‰æãÂåñÂÆåÊàêÂêéÊõ¥Êñ∞ÂÄºÊåÅÊúâÂô®ÁºìÂ≠ò</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setValue(value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setOrder(order);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (T) value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Âü∫‰∫éÂà´ÂêçÊêúÁ¥¢Â∑≤ÁªèÂä†ËΩΩÁöÑÂÆûÁé∞Á±ª‰ø°ÊÅØÔºåÂπ∂‰∏îÂÆû‰æãÂåñÂØπÂ∫îÁöÑÂÆûÁé∞Á±ªËøõË°åÂÄºÂåÖË£Ö</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Holder&lt;T&gt; createExtension(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Âä†ËΩΩËØ•@SPIÊ†áËØÜÊé•Âè£ÁöÑÊâÄÊúâÂÆûÁé∞Á±ª‰ø°ÊÅØÂπ∂‰∏îËé∑ÂèñÂØπÂ∫îÂà´ÂêçÁöÑÂÆûÁé∞Á±ª‰ø°ÊÅØ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity classEntity = getExtensionClassesEntity().get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;name is error&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; aClass = classEntity.getClazz();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Â¶ÇÊûúÂÆûÁé∞Á±ªÂÆû‰æãÁºìÂ≠ò‰∏≠Â∑≤ÁªèÂ≠òÂú®ÔºåÂàôÁõ¥Êé•Â∞ÅË£Ö‰∏∫ÂÄºÂåÖË£ÖÂô®ËøîÂõûÔºåÂê¶ÂàôËøõË°åÂÆû‰æãÂåñ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(o)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ÂèçÂ∞ÑÂÆû‰æãÂåñÂπ∂‰∏îÁºìÂ≠òËØ•ÂÆûÁé∞Á±ªÂÆû‰æã</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            joinInstances.putIfAbsent(aClass, aClass.newInstance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InstantiationException | IllegalAccessException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Extension instance(name: &quot; + name + &quot;, class: &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + aClass + &quot;)  could not be instantiated: &quot; + e.getMessage(), e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;T&gt; objectHolder = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setOrder(classEntity.getOrder());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setValue((T) o);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return objectHolder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see from the &#x27;createExtension()&#x27; method, we end up using reflection to instantiate the implementation class. The reflection method &#x27;newInstance()&#x27; requires that the class must provide a no-argument constructor because of an implicit convention: The &#x27;SPI&#x27; implementation class <strong>must provide a no-argument constructor</strong> or the instantiation will fail. The rest methods, such as &#x27;getDefaultJoin()&#x27; and &#x27;getJoins()&#x27; are uncomplicated extensions of &#x27;getJoin()&#x27;, so we won&#x27;t analyze them here. In addition, the &#x27;getJoin()&#x27; method uses a multilevel cache:</p><ul><li>&#x27;cachedInstances&#x27; : Search for the corresponding implementation class instance by alias</li><li>&#x27;joinInstances&#x27; : If the alias lookup fails, load all the implementation class information, locate the implementation class type by the alias, and update the&#x27; cachedInstances&#x27; cache by either finding the implementation class type or creating and caching the implementation class instance</li></ul><p>This completes the source code analysis of &#x27;ExtensionLoader&#x27;. Here&#x27;s another example of an &#x27;ExtensionLoader&#x27; instance member property memory layout diagram to help you understand:</p><p><img alt="spi-attr-memory-debug" src="/assets/images/spi-attr-memory-debug-fbcf742eb342ba1aa47e9395bf8ffc0c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionfactory"></a>ExtensionFactory<a class="hash-link" href="#extensionfactory" title="Direct link to heading">#</a></h3><p>&#x27;ExtensionFactory&#x27; is the factory interface inside the factory pattern, which defines a method to get an instance of the &#x27;SPI&#x27; implementation (the <strong>default implementation, or the only implementation</strong>) :</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI(&quot;spi&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets Extension.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt;   the type parameter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param key   Ê≠§ÂèÇÊï∞ÊöÇÊó∂Ê≤°Êúâ‰ΩøÁî®ÔºåÁåúÊµãÊòØÈ¢ÑÁïôÁî®‰∫éÊò†Â∞Ñ@SPIÁöÑvalue()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param clazz @SPIÊ†áËØÜÁöÑÊé•Âè£Á±ªÂûã</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the extension</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getExtension(String key, Class&lt;T&gt; clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s look the class &#x27;SpiExtensionFactory&#x27; :</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpiExtensionFactory implements ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; T getExtension(final String key, final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Optional.ofNullable(clazz)   // ÂÖ•ÂèÇclazzÈùûÁ©∫</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Class::isInterface)  // ÂÖ•ÂèÇclazzÂøÖÈ°ªÊòØÊé•Âè£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(cls -&gt; cls.isAnnotationPresent(SPI.class))  // ÂÖ•ÂèÇclazzÂøÖÈ°ªË¢´@SPIÊ†áËØÜ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getExtensionLoader)  // Âü∫‰∫éclazzËøô‰∏™Êé•Âè£Á±ªÂûãÂÆû‰æãÂåñExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getDefaultJoin)  // Ëé∑ÂèñËØ•@SPIÊ†áËØÜÊé•Âè£ÁöÑÈªòËÆ§ÂÆûÁé∞Ôºå‰∏çÂ≠òÂú®ÂàôËøîÂõûNULL</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It&#x27;s worth noting here that the &#x27;ExtensionFactory&#x27; itself is part of the &#x27;SPI&#x27; system. So when using &#x27;ExtensionFactory&#x27; you can instantiate it directly:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = new SpiExtensionFactory();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It can also be loaded based on an &#x27;ExtensionLoader&#x27;:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># the content of META-INF/services/shenyu/org.apache.shenyu.spi.ExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">spi=org.apache.shenyu.spi.SpiExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># then load it with ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getDefaultJoin();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Once you have an &#x27;ExtensionFactory&#x27; instance, you can load an instance of its default implementation class based on the &#x27;@SPI&#x27; interface.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="Â∞èÁªì"></a>Â∞èÁªì<a class="hash-link" href="#Â∞èÁªì" title="Direct link to heading">#</a></h2><p>The &#x27;SPI&#x27; extension framework based on the design idea of &#x27;Java&#x27; native &#x27;SPI&#x27; has the characteristics of loose coupling, high usability and high scalability, a loading instance cache system, concurrency security and other features to fill some defects of &#x27;SPI&#x27; in the native &#x27;JDK&#x27;, Shenyu SPI module is the same. Base on this powerful &#x27;SPI&#x27; module, other modules in &#x27;Shenyu&#x27; such as the &#x27;Plugin&#x27; module can be configured quickly and pluggable, making it easier to load a newly developed Plugin instance.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog"><div class="pagination-nav__label">¬´ Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div></div>
<script src="/assets/js/runtime~main.2e9d71d1.js"></script>
<script src="/assets/js/main.95312033.js"></script>
</body>
</html>