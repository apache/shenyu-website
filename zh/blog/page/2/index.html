<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Blog | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Blog | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/page/2"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/page/2"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/page/2" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.6bd5fa92.css">
<link rel="preload" href="/zh/assets/js/runtime~main.a7fede36.js" as="script">
<link rel="preload" href="/zh/assets/js/main.e868eba5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalancer SPI ä»£ç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T06:06:58.415Z">2023å¹´8æœˆ15æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>â€‹        ç½‘å…³åº”ç”¨éœ€è¦æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡çš„æ–¹æ¡ˆï¼ŒåŒ…æ‹¬éšæœºé€‰æ‹©ã€Hashã€è½®è¯¢ç­‰æ–¹å¼ã€‚<code>Apache Shenyu</code>ç½‘å…³ä¸­ä¸ä»…å®ç°äº†ä¼ ç»Ÿç½‘å…³çš„è¿™äº›å‡è¡¡ç­–ç•¥ï¼Œè¿˜é€šè¿‡æµé‡é¢„çƒ­(warmup)ç­‰ç»†èŠ‚å¤„ç†ï¼Œå¯¹æœåŠ¡å™¨èŠ‚ç‚¹çš„åŠ å…¥ï¼Œåšäº†æ›´å¹³æ»‘çš„æµé‡å¤„ç†ï¼Œè·å¾—äº†æ›´å¥½çš„æ•´ä½“ç¨³å®šæ€§ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹Shenyuæ˜¯æ˜¯å¦‚ä½•è®¾è®¡å’Œå®ç°è¿™éƒ¨åˆ†åŠŸèƒ½çš„ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.5.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æ.</p></blockquote><p>[TOC]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalancer-spi"></a>LoadBalancer <code>SPI</code><a class="hash-link" href="#loadbalancer-spi" title="Direct link to heading">#</a></h2><p><code>LoadBalancer</code> SPI å®šä¹‰åœ¨<strong><em>shenyu-loadbalancer</em></strong>æ¨¡ç»„ä¸­ï¼Œä»¥ä¸‹æ˜¯è¿™ä¸ªæ ¸å¿ƒæ¥å£çš„ä»£ç ï¼Œè¿™ä¸ªæ¥å£å¾ˆå¥½çš„è¯ é‡Šäº†è¿™æ ·ä¸€ä¸ªç†å¿µï¼šè´Ÿè½½å‡è¡¡æ˜¯åœ¨ä¸€ç³»åˆ—æœåŠ¡å™¨èŠ‚ç‚¹ä¸­é€‰å‡ºæœ€åˆé€‚çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯é€‰æ‹©ç­–ç•¥ã€‚åšæµé‡è½¬å‘ã€è·¯ç”±å’Œè´Ÿè½½å‡è¡¡æ˜¯<code>LoadBalance SPI</code>çš„åŸºæœ¬åŠŸèƒ½</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface LoadBalancer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * this is select one for upstream list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream select(List&lt;Upstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥å£ä¸­ï¼ŒupstreamListæ˜¯å¯é€‰è·¯ç”±çš„ä¸€ç»„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œ<code>Upstream</code> æ˜¯æœåŠ¡å™¨èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…æ‹¬çš„é‡è¦å…ƒç´ æœ‰ï¼šåè®®ã€url ã€æƒé‡ã€æ—¶é—´æˆ³ï¼Œwarmupï¼Œå¥åº·çŠ¶æ€ç­‰ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class Upstream {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * protocol.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * weight.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * false close, true open.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean status;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * startup time.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final long timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * warmup.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int warmup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * healthy.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean healthy;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * lastHealthTimestamp.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastHealthTimestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * lastUnhealthyTimestamp.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUnhealthyTimestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * group.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String group;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * version.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String version;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-loadbalance-module"></a>Design of LoadBalance module`<a class="hash-link" href="#design-of-loadbalance-module" title="Direct link to heading">#</a></h2><p>å›¾1æ˜¯<code>LoadBalancer</code>æ¨¡ç»„çš„ç±»å›¾ï¼š</p><p><img alt="loadbalancer-class-diagram" src="/zh/assets/images/loadBalancer-class-diagram-7fa8d2dd07f1210da7d25fa787b69d5f.png"></p><p>ä»ç±»å›¾ä¸Šå¯ä»¥çœ‹å‡º<code>LoadBalance</code>çš„è®¾è®¡æ¦‚è¦ï¼š</p><ol><li><p>æŠ½è±¡ç±»<code>AbstractLoadBalancer</code>ç»§æ‰¿è‡ª<code>LoadBalancer</code> SPIæ¥å£ï¼Œå¹¶æä¾›é€‰æ‹©çš„æ¨¡æ¿æ–¹æ³•ï¼ŒåŠæƒé‡è®¡ç®—ã€‚</p></li><li><p>ä¸‰ä¸ªå®åšç±»ç»§æ‰¿<code>AbstractLoadBalancer</code>ï¼Œ å®ç°å„è‡ªçš„é€»è¾‘å¤„ç†ã€‚</p><ul><li><code>RandomLoadBalancer</code> -åŠ æƒéšæœºé€‰æ‹© Weight Random</li><li><code>HashLoadBalancer</code>  - ä¸€è‡´æ€§Hash</li><li><code>RoundRobinLoadBalancer</code> -åŠ æƒè½®è¯¢ï¼ˆWeight Round Robin per-packet)</li></ul></li><li><p>ç”±å·¥å‚ç±»<code>LoadBalancerFactory</code> å®ç°å¯¹å¤–çš„é™æ€è°ƒç”¨æ–¹æ³•ã€‚</p><p>å¦å¤–æ ¹æ®<code>Apache Sheny SPI</code>è§„èŒƒï¼Œåœ¨<code>SHENYU_DIERECTORY</code>ä¸­çš„æ·»åŠ profileï¼Œé…ç½®<code>LoadBalance</code>çš„å®ç°ç±»ï¼Œé…ç½®key=classå½¢å¼ï¼Œå·¦è¾¹çš„operatorè¦å’Œ<code>LoadBalanceEnum</code>ä¸­çš„å®šä¹‰ä¸€è‡´ã€‚</p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">random=org.apache.shenyu.loadbalancer.spi.RandomLoadBalancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">roundRobin=org.apache.shenyu.loadbalancer.spi.RoundRobinLoadBalancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hash=org.apache.shenyu.loadbalancer.spi.HashLoadBalancer</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>LoadBalanceEnum</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum LoadBalanceEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Hash load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HASH(1, &quot;hash&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Random load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RANDOM(2, &quot;random&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Round robin load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ROUND_ROBIN(3, &quot;roundRobin&quot;, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int code;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final boolean support;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractloadbalancer"></a>AbstractLoadBalancer<a class="hash-link" href="#abstractloadbalancer" title="Direct link to heading">#</a></h2><p>è¿™ä¸ªæŠ½è±¡ç±»å®åšäº†<code>LoadBalancer</code>æ¥å£, å®šä¹‰äº†æŠ½è±¡æ–¹æ³•<code>doSelect()</code>ç•™ç»™å®ä½œç±»å¤„ç†ï¼Œåœ¨æ¨¡æ¿æ–¹æ³•<code>select()</code> ä¸­å…ˆè¿›è¡Œæ ¡éªŒï¼Œä¹‹åè°ƒç”¨ç”±å®ä½œç±»å®ç°çš„<code>doSelect()</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractLoadBalancer implements LoadBalancer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do select divide upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Upstream doSelect(List&lt;Upstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream select(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (upstreamList.size() == 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doSelect(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æƒé‡çš„å¤„ç†æ–¹æ³•<code>getWeight()</code>çš„é€»è¾‘æ˜¯ï¼šå½“æœ‰æ—¶é—´æˆ³ï¼Œå¹¶ä¸”å½“å‰æ—¶é—´ä¸æ—¶é—´æˆ³é—´éš”åœ¨æµé‡é¢„çƒ­warmupæ—¶é—´å†…ï¼Œæƒé‡è®¡ç®—çš„å…¬å¼ä¸ºï¼š
$$ {1-1}
ww = min(1,uptime/(warmup/weight))
$$
ä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œæœ€ç»ˆçš„æƒå€¼ï¼Œä¸è®¾ç½®çš„weightæˆæ­£æ¯”ï¼Œæ—¶é—´é—´éš”è¶Šæ¥è¿‘warmupæ—¶é—´ï¼Œæƒé‡å°±è¶Šå¤§ã€‚ä¹Ÿå°±æ˜¯è¯´ç­‰å¾…çš„æ—¶é—´è¶Šé•¿ï¼Œè¢«åˆ†æ´¾çš„æƒé‡è¶Šé«˜ã€‚æ²¡æœ‰æ—¶é—´æˆ³æ—¶ç­‰å…¶ä»–æƒ…å†µä¸‹ï¼Œè¿”å›<code>Upstream</code>è®¾ç½®çš„<code>weight</code>å€¼ã€‚</p><p>è€ƒè™‘æµé‡é¢„çƒ­(warmup)çš„æ ¸å¿ƒæ€æƒ³æ˜¯é¿å…åœ¨æ·»åŠ æ–°æœåŠ¡å™¨å’Œå¯åŠ¨æ–°JVMæ—¶ç½‘å…³æ€§èƒ½ä¸ä½³ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‰ä¸ªå®åšç±»çš„å®ç°ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="randomloadbalancer"></a>RandomLoadBalancer<a class="hash-link" href="#randomloadbalancer" title="Direct link to heading">#</a></h2><p>è¿™é‡Œéšæœº<code>LoadBalancer</code> å¯ä»¥å¤„ç†ä¸¤ç§æƒ…å†µï¼š</p><ol><li>æ²¡æœ‰æƒé‡ï¼šæ‰€æœ‰æœåŠ¡å™¨éƒ½æ²¡æœ‰è®¾å®šæƒé‡ï¼Œæˆ–è€…æƒé‡éƒ½ä¸€æ ·ï¼Œ ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªã€‚</li><li>æœ‰æƒé‡ï¼šæœåŠ¡å™¨è®¾å®šæœ‰ä¸åŒçš„æƒé‡ï¼Œä¼šæ ¹æ®æƒé‡ï¼Œè¿›è¡Œéšæœºé€‰æ‹©ã€‚</li></ol><p>ä¸‹é¢æ˜¯æœ‰æƒé‡æ—¶çš„éšæœºé€‰æ‹©ä»£ç <code>random()</code>ï¼š éå†å…¨éƒ¨æœåŠ¡å™¨åˆ—è¡¨ï¼Œå½“éšæœºå€¼å°äºæŸä¸ªæœåŠ¡å™¨æƒé‡æ—¶ï¼Œè¿™ä¸ªæœåŠ¡å™¨è¢«é€‰ä¸­ï¼ˆè¿™é‡Œæå‰è®¡ç®—äº†å‰ä¸€åŠæœåŠ¡å™¨çš„æƒé‡å’Œï¼Œå¦‚æœéšæœºå€¼å¤§äº<code>halfLengthTotalWeight</code>ï¼Œåˆ™éå†ä»<code>(weights.length + 1) / 2</code>å¼€å§‹ï¼Œæé«˜äº†å°æ•ˆç‡ï¼‰ã€‚ è‹¥éå†åæ²¡æœ‰æ»¡è¶³æ¡ä»¶ï¼Œå°±åœ¨å…¨éƒ¨æœåŠ¡å™¨åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªè¿”å›ã€‚è¿™é‡Œ<code>getWeight(final Upstream upstream)</code> æ–¹æ³•æ˜¯åœ¨<code>AbstractLoadBalancer</code> ä¸­å®šä¹‰çš„ï¼ŒæŒ‰å…¬å¼è®¡ç®—æƒé‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int length = upstreamList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // every upstream has the same weight?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean sameWeight = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // the weight of every upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int[] weights = new int[length];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int firstUpstreamWeight = getWeight(upstreamList.get(0));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    weights[0] = firstUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // init the totalWeight</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int totalWeight = firstUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int halfLengthTotalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 1; i &lt; length; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int currentUpstreamWeight = getWeight(upstreamList.get(i));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (i &lt;= (length + 1) / 2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            halfLengthTotalWeight = totalWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weights[i] = currentUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalWeight += currentUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (sameWeight &amp;&amp; currentUpstreamWeight != firstUpstreamWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Calculate whether the weight of ownership is the same.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            sameWeight = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (totalWeight &gt; 0 &amp;&amp; !sameWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return random(totalWeight, halfLengthTotalWeight, weights, upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return random(upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Upstream random(final int totalWeight, final int halfLengthTotalWeight, final int[] weights, final List&lt;Upstream&gt; upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // If the weights are not the same and the weights are greater than 0, then random by the total number of weights.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int offset = RANDOM.nextInt(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int index = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int end = weights.length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (offset &gt;= halfLengthTotalWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = (weights.length + 1) / 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        offset -= halfLengthTotalWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        end = (weights.length + 1) / 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Determine which segment the random value falls on</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (; index &lt; end; index++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        offset -= weights[index];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (offset &lt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return upstreamList.get(index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return random(upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å› æ­¤ï¼Œå½“é‡‡ç”¨<code>RandomLoadBalancer</code>æ—¶ï¼Œæ˜¯æŒ‰æƒé‡éšæœºåˆ†æ´¾æœåŠ¡å™¨çš„ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="hashloadbalancer"></a>HashLoadBalancer<a class="hash-link" href="#hashloadbalancer" title="Direct link to heading">#</a></h2><p><code>Apache Shenyu</code>çš„<code>HashLoadBalancer</code> ä¸­é‡‡ç”¨äº†ä¸€è‡´æ€§hashç®—æ³•ï¼Œä½¿ç”¨æœ‰åºhashç¯ï¼Œå°†keyä¸æœåŠ¡å™¨èŠ‚ç‚¹çš„hashæ˜ å°„ç¼“å­˜èµ·æ¥ã€‚å¯¹äºè¯·æ±‚çš„ipåœ°å€ï¼Œè®¡ç®—å‡ºå…¶<code>hash</code>å€¼ï¼Œ åœ¨hashç¯ä¸Šé¡ºæ—¶é’ˆæŸ¥æ‰¾è·ç¦»è¿™ä¸ªkeyçš„hashå€¼æœ€è¿‘çš„èŠ‚ç‚¹ï¼Œå°†å…¶ä½œä¸ºè¦è·¯ç”±çš„èŠ‚ç‚¹ã€‚ä¸€è‡´æ€§hashè§£å†³äº†ä¼ ç»Ÿå–ä½™hashç®—æ³•çš„å¯ä¼¸ç¼©æ€§å·®çš„é—®é¢˜ã€‚</p><p><code>HashLoadBalancer</code>ä¸­çš„é‡‡ç”¨çš„æ˜¯åŠ å¯†çš„å•å‘MD5æ•£åˆ—å‡½æ•°ï¼Œè¿™ä¸ªhashå‡½æ•°ä¼šhashåäº§ç”Ÿä¸å¯é¢„æœŸä½†ç¡®å®šæ€§çš„()çš„ç»“æœï¼Œè¾“å‡ºä¸º32-bitçš„é•¿æ•´æ•°ã€‚<code>hash</code>ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private static long hash(final String key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // md5 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MessageDigest md5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5 = MessageDigest.getInstance(&quot;MD5&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (NoSuchAlgorithmException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShenyuException(&quot;MD5 not supported&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] keyBytes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyBytes = key.getBytes(StandardCharsets.UTF_8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.update(keyBytes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] digest = md5.digest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // hash code, Truncate to 32-bits</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long hashCode = (long) (digest[3] &amp; 0xFF) &lt;&lt; 24</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[2] &amp; 0xFF) &lt;&lt; 16)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[1] &amp; 0xFF) &lt;&lt; 8)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | (digest[0] &amp; 0xFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return hashCode &amp; 0xffffffffL;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å†çœ‹ä¸€ä¸‹<code>HashLoadBalancer</code>çš„é€‰æ‹©å‡½æ•°<code>doSelect()</code>çš„å®ç°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int VIRTUAL_NODE_NUM = 5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConcurrentSkipListMap&lt;Long, Upstream&gt; treeMap = new ConcurrentSkipListMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        upstreamList.forEach(upstream -&gt; IntStream.range(0, VIRTUAL_NODE_NUM).forEach(i -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long addressHash = hash(&quot;SHENYU-&quot; + upstream.getUrl() + &quot;-HASH-&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            treeMap.put(addressHash, upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hash = hash(ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SortedMap&lt;Long, Upstream&gt; lastRing = treeMap.tailMap(hash);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!lastRing.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return lastRing.get(lastRing.firstKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return treeMap.firstEntry().getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œç”Ÿæˆå¸¦è™šæ‹ŸæœåŠ¡å™¨èŠ‚ç‚¹çš„hashç¯ï¼Œ ä¸€ä¸ªå®é™…èŠ‚ç‚¹ä¼šç”Ÿæˆ5ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå› æ­¤æ•´ä¸ªhashç¯çš„å‡åŒ€æ€§å¤§å¤§å¢åŠ ï¼Œé™ä½æ•°æ®å€¾æ–œçš„å‘ç”Ÿã€‚</p><p>ä¸ºäº†å®ç°hashç¯çš„æœ‰åºæ€§åŠé¡ºæ—¶é’ˆæŸ¥æ‰¾åŠŸèƒ½ï¼Œä»£ç ä¸­ä½¿ç”¨Java çš„<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html" target="_blank" rel="noopener noreferrer">ConcurrentSkipListMap</a> æ¥å­˜å‚¨å¸¦è™šæ‹ŸèŠ‚ç‚¹çš„æœåŠ¡å™¨èŠ‚ç‚¹åŠå…¶hashå€¼ï¼Œ å®ƒæ—¢èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåˆèƒ½ä¿è¯æ•°æ®çš„æœ‰åºæ€§ï¼Œæ”¯æŒé«˜å¹¶å‘ã€‚ å¦å¤–ï¼Œ<code>ConcurrentSkipListMap</code>æä¾›äº†ä¸€ä¸ª<code>tailMap(K fromKey)</code>æ–¹æ³•ï¼Œå¯ä»<code>map</code>ä¸­æŸ¥æ‰¾æ¯”<code>fromKey</code>å¤§çš„å€¼çš„é›†åˆï¼Œä½†å¹¶ä¸éœ€è¦éå†æ•´ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œç”Ÿæˆhashç¯ä¹‹åï¼Œå°±æ˜¯è°ƒç”¨<code>ConcurrentSkipListMap</code>çš„<code>tailMap()</code>æ–¹æ³•ï¼Œæ‰¾åˆ°å¤§äºç­‰äºè¯·æ±‚çš„ipçš„hashå€¼çš„å­é›†ï¼Œè¿™ä¸ªå­é›†çš„ç¬¬ä¸€ä¸ªå°±æ˜¯è¦è·¯ç”±çš„æœåŠ¡å™¨èŠ‚ç‚¹ã€‚é‡‡ç”¨äº†åˆé€‚çš„æ•°æ®ç»“æ„ï¼Œè¿™é‡Œçš„ä»£ç çœ‹ä¸Šå»æ˜¯ä¸æ˜¯ç‰¹åˆ«çš„ç®€æ´æµç•…ï¼Ÿ</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="roundrobinloadbalancer"></a>RoundRobinLoadBalancer<a class="hash-link" href="#roundrobinloadbalancer" title="Direct link to heading">#</a></h2><p>Round-robinè½®è¯¢æ–¹æ³•çš„åŸå§‹å®šä¹‰æ˜¯é¡ºåºå¾ªç¯å°†è¯·æ±‚ä¾æ¬¡å¾ªç¯åœ°è¿æ¥åˆ°æ¯ä¸ªæœåŠ¡å™¨ã€‚å½“æŸä¸ªæœåŠ¡å™¨å‘ç”Ÿæ•…éšœï¼ˆä¾‹å¦‚ï¼šä¸€åˆ†é’Ÿè¿æ¥ä¸ä¸Šçš„æœåŠ¡å™¨)ï¼Œä»å€™é€‰é˜Ÿåˆ—ä¸­å–å‡ºï¼Œä¸å‚ä¸ä¸‹ä¸€æ¬¡çš„è½®è¯¢ï¼Œç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚åœ¨ <code>RoundRobinLoadBalancer</code>ä¸­å®ç°çš„æ˜¯ç»„å†…åŠ æƒè½®è¯¢ï¼ˆ<code>Weight Round Robin per-packet</code>)æ–¹æ³•ï¼š</p><p>ä¸ºäº†è®¡ç®—å’Œå­˜å‚¨æ¯ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹çš„è½®è¯¢æ¬¡æ•°ï¼Œåœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±»<code>WeigthRoundRobin</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å®ƒçš„ä¸»è¦ä»£ç ï¼ˆå»æ‰äº†æ³¨é‡Šï¼‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected static class WeightedRoundRobin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicLong current = new AtomicLong(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setWeight(final int weight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.weight = weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.set(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long increaseCurrent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return current.addAndGet(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void sel(final int total) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.addAndGet(-1 * total);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setLastUpdate(final long lastUpdate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.lastUpdate = lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯·é‡ç‚¹å…³æ³¨è¿™å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li><p><code>setWeight(final int weight)</code> ï¼Œä¸ºå¯¹è±¡è®¾å®šæƒé‡ï¼Œå¹¶å°†currenté‡ç½®ä¸º0.</p></li><li><p><code>increaseCurrent()</code> : å¯¹<code>AtomicLong</code>ç±»å‹çš„å¯¹è±¡<code>current</code>ï¼Œç´¯åŠ å…¶æƒé‡å€¼ã€‚</p></li><li><p><code>sel(final int total)</code>:   <code>current</code>å‡å»ä¼ å…¥çš„ <code>total</code>å€¼ã€‚</p></li></ul><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹å¸¦æƒé‡çš„è½®è¯¢è¿‡ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ã€‚
é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<code>ConcurrentMap</code>ç±»å‹å¯¹è±¡<code>methodWeightMap</code> ä¸¤å±‚å¯¹è±¡æ¥å­˜å‚¨æœåŠ¡å™¨åˆ—è¡¨ä¸å…¶å„ä¸ªæ˜ç»†èŠ‚ç‚¹çš„è½®è¯¢èµ„æ–™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt; methodWeightMap = new ConcurrentHashMap&lt;&gt;(16);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªmapå¯¹è±¡ç¬¬ä¸€å±‚çš„keyä¸ºå½“å‰æœåŠ¡å™¨åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„<code>upstreamUrl</code>,  ç¬¬äºŒä¸ªå¯¹è±¡<code>ConcurrentMap&lt;String, WeightedRoundRobin&gt;</code>å­˜å‚¨äº†ç»„å†…å„ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹çš„è½®è¯¢æƒ…å†µï¼Œå†…å±‚Mapçš„keyä¸ºç»„å†…æ¯ä¸ªæœåŠ¡å™¨çš„<code>upstreamUrl</code>ã€‚<code>Map</code>å¯¹è±¡ä½¿ç”¨<code>JUC</code>çš„<code>ConcurrentHashMap</code>ï¼Œä¸ä»…å­˜å–é«˜æ•ˆï¼Œè€Œä¸”çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒé«˜å¹¶å‘ã€‚</p><p>å†…å±‚mapçš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„<code>WeighedRoundRobin</code>ä½œä¸ºé™æ€å†…éƒ¨ç±»èƒ½ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå¹¶å®ç°ç»„å†…çš„åŠ æƒè½®è¯¢é€‰æ‹©åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªç±»çš„<code>doSelect()</code>æ–¹æ³•çš„ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String key = upstreamList.get(0).getUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(map)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodWeightMap.putIfAbsent(key, new ConcurrentHashMap&lt;&gt;(16));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int totalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long maxCurrent = Long.MIN_VALUE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long now = System.currentTimeMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream selectedInvoker = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WeightedRoundRobin selectedWeightedRoundRobin = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Upstream upstream : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rKey = upstream.getUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WeightedRoundRobin weightedRoundRobin = map.get(rKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int weight = getWeight(upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(weightedRoundRobin)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin = new WeightedRoundRobin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.putIfAbsent(rKey, weightedRoundRobin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (weight != weightedRoundRobin.getWeight()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // weight changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long cur = weightedRoundRobin.increaseCurrent();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weightedRoundRobin.setLastUpdate(now);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cur &gt; maxCurrent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            maxCurrent = cur;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedInvoker = upstream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedWeightedRoundRobin = weightedRoundRobin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalWeight += weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......  //erase the section which handles the time-out upstreams. </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (selectedInvoker != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWeightedRoundRobin.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸¾ä¾‹ï¼Œè‹¥æœåŠ¡å™¨ç»„<code>upstreamUrl</code> åˆ†åˆ«ä¸ºï¼š LIST = [upstream-20, upstream-50, upstream-30]æ—¶ï¼Œç»è¿‡ä¸€è½®æ‰§è¡Œåï¼Œå»ºç«‹çš„<code>methodWeightMap</code> èµ„æ–™å¦‚ä¸‹ï¼š</p><p><img alt="methodWeightMap" src="/zh/assets/images/methodWeightMap-90b4a77aedffd8cd88bc12b9551739ad.png"></p><p>å‡è®¾ä¸Šè¿°çš„LISTä¸­ï¼Œå„ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹çš„æƒé‡æ•°ç»„ä¸º: [20,50,30], ä¸‹å›¾æ˜¯å†…éƒ¨ç±»current å€¼å˜åŒ–å’Œè½®è¯¢é€‰æ‹©è¿‡ç¨‹ï¼š</p><p><img alt="weighted-roundrobin-demo" src="/zh/assets/images/weighted-roundrobin-demo-cec02fd422fb01ef73e882e0966a8cec.png"></p><p>æ¯ä¸€è½®ï¼Œé€‰æ‹©å€¼currentæœ€å¤§çš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼š</p><ul><li>Round1:<ul><li>å¯¹å½“å‰æœåŠ¡å™¨LISTåšéå†ï¼Œå½“æœåŠ¡å™¨èŠ‚ç‚¹çš„weightedRoundRobin ä¸ºnullæ—¶ï¼Œcurrentè¢«ç½®ä¸ºå„è‡ªçš„æƒé‡ï¼› ä¸ä¸ºnullæ—¶ï¼Œç´¯åŠ å„è‡ªçš„æƒé‡ã€‚</li><li>å³ï¼šéå†åcurrent åˆ†åˆ«ä¸º [20, 50,30] ï¼Œ ä¼šé€‰æ‹©Stream-50, Stream-50å¯¹åº”çš„WeightRoundRobiné™æ€ç±»åš sel(-total)å¤„ç†ï¼Œcurrent æ›´æ–°ä¸º[20,-50, 30].</li></ul></li><li>Round 2  éå†åçš„currentæ˜¯[40,0,60],  ä¼šé€‰æ‹©Stream-30ï¼Œ currentåˆ†åˆ«æ›´æ–°ä¸º[40,0,-40].</li><li>Round 3  éå†åçš„currentæ˜¯[60,50,-10],  ä¼šé€‰æ‹©Stream-20ï¼Œcurrentåˆ†åˆ«æ›´æ–°ä¸º[-40,50,-10].</li></ul><p>ä¸­é—´è¿›è¡Œäº†å®¹é”™å¤„ç†ï¼Œ å½“æœåŠ¡å™¨çš„ä¸ªæ•°ä¸mapä¸ªæ•°ä¸ä¸€æ ·ï¼Œå°±å¯¹methodWeightMap åŠ é”åšå¤„ç†ã€‚ ç”¨å…ˆcopy åmodifyçš„æ–¹å¼ï¼Œ æŠŠè¶…æ—¶çš„æœåŠ¡å™¨removeæ‰ï¼Œå³ç§»é™¤æ‰å‘ç”Ÿæ•…éšœçš„æœåŠ¡å™¨ï¼Œå¹¶æ›´æ–°Mapèµ„æ–™ã€‚å¦‚ä¸‹æ˜¯å¼‚å¸¸æ—¶çš„å¤„ç†ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Java"><pre tabindex="0" class="prism-code language-Java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    if (!updateLock.get() &amp;&amp; upstreamList.size() != map.size() &amp;&amp; updateLock.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // copy -&gt; modify -&gt; update reference.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = new ConcurrentHashMap&lt;&gt;(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; recyclePeriod);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodWeightMap.put(key, newMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateLock.set(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(selectedInvoker)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWeightedRoundRobin.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalancerfactory"></a>LoadBalancerFactory<a class="hash-link" href="#loadbalancerfactory" title="Direct link to heading">#</a></h2><p>åœ¨è¿™ä¸ªå·¥å‚ç±»ä¸­ï¼Œæä¾›äº†è°ƒç”¨<code>LoadBalancer</code>çš„é™æ€æ–¹æ³•, å…¶ä¸­<code>ExtensionLoader</code> æ˜¯<code>Apache Shenyu</code>çš„<code>SPI</code>æ‰§è¡Œå…¥å£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLoadBalanceræ¨¡ç»„æ˜¯å¯é…ç½®ã€å¯æ‰©å±•çš„ã€‚è¿™ä¸ªé™æ€æ–¹æ³•ä¸­çš„<code>algorithm</code>å˜é‡æ˜¯<code>LoadBalanceEnum</code>ä¸­å®šä¹‰<code>name</code>æšä¸¾ç±»å‹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Selector upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param algorithm    the loadBalance algorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @return the upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Upstream selector(final List&lt;Upstream&gt; upstreamList, final String algorithm, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LoadBalancer loadBalance = ExtensionLoader.getExtensionLoader(LoadBalancer.class).getJoin(algorithm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return loadBalance.select(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="using-of-loadbalancer-module"></a>Using of LoadBalancer module<a class="hash-link" href="#using-of-loadbalancer-module" title="Direct link to heading">#</a></h2><p>ä¸Šé¢è¯´æ˜äº†<code>LoadBalancer</code> SPIæ¥å£åŠä¸‰ä¸ªå®ä½œç±»ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹<code>LoadBalancer</code>åœ¨<code>Apache Shenyu</code>ä¸­æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚<code>DividePlugin</code>æ˜¯è·¯ç”±é€‰æ‹©æ’ä»¶ï¼Œæ‰€æœ‰çš„Httpè¯·æ±‚éƒ½ç”±è¯¥æ’ä»¶è¿›è¡Œè´Ÿè½½å‡è¡¡å¤„ç†ã€‚å½“è¯·æ±‚å¤´rpcType = http, ä¸”å¼€å¯è¯¥æ’ä»¶æ—¶ï¼Œå®ƒå°†æ ¹æ®è¯·æ±‚å‚æ•°åŒ¹é…è§„åˆ™ï¼Œæœ€ç»ˆäº¤ç”±ä¸‹æ¸¸æ’ä»¶è¿›è¡Œå“åº”å¼ä»£ç†è°ƒç”¨ã€‚</p><p>åœ¨<code>DividePlugin</code>çš„<code>doExecute</code>æ–¹æ³•ä¸­ï¼Œå…ˆå¯¹è¦è½¬å‘çš„è¯·æ±‚çš„Headerå¤§å°ã€contenté•¿åº¦ç­‰åšæ ¡éªŒï¼Œ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥å£æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>ShenyuPluginChain</code> ç±»å‹ï¼Œä»£è¡¨<code>plugin</code>çš„è°ƒç”¨é“¾ï¼Œå…·ä½“å¯å‚è§<code>Apache Sheyu</code> çš„<code>plugin</code>çš„è°ƒç”¨æœºåˆ¶ã€‚ç¬¬ä¸‰ä¸ª<code>SelectorData</code>ç±»å‹çš„å‚æ•°æ˜¯é€‰æ‹©å™¨ï¼Œ ç¬¬å››ä¸ªæ˜¯<code>RuldData</code>ç±»å‹ï¼Œä»£è¡¨è§„åˆ™ã€‚åˆ†åˆ«è¯·æŸ¥çœ‹å¯¹åº”çš„ä»£ç ã€‚</p><p> ä¸‹é¢ç»™å‡ºäº†<code>doExecute</code>()æ–¹æ³•ä¸­ï¼Œæœ‰å…³<code>LoadBalancer</code>è°ƒç”¨çš„ä»£ç ç‰‡æ®µï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //å–åˆ°è¦è·¯ç”±çš„æœåŠ¡å™¨èŠ‚ç‚¹åˆ—è¡¨ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å–åˆ°è¯·æ±‚çš„ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è°ƒç”¨Utilæ–¹æ³•ï¼Œæ‰§è¡ŒLoadBalancerå¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  è¿™é‡Œ<code>UpstreamCacheManager</code> æ˜¯ç¼“å­˜çš„è¦è·¯ç”±çš„æœåŠ¡å™¨èŠ‚ç‚¹ ï¼Œ <code>ruleHandle.getLoadBalance()</code>å–åˆ°çš„æ˜¯<code>LoadBalanceEnum</code>å®šä¹‰çš„æšä¸¾name, å¦‚<code>random, hash, roundRobin</code>ç­‰.</p><p>  ç»è¿‡å°è£…ï¼Œè°ƒç”¨è´Ÿè½½å‡è¡¡åŠŸèƒ½éå¸¸çš„æ–¹ä¾¿ã€‚  æœªæ¥å¢åŠ æ–°çš„<code>LoadBalancer</code>ç±»ï¼Œè¿™äº›è°ƒç”¨çš„<code>Plugin</code>ä»£ç å®Œå…¨ä¸éœ€è¦å˜æ›´ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>ç»è¿‡ä¸Šé¢çš„ä»£ç è§£è¯»ï¼Œä»è®¾è®¡è§’åº¦æ€»ç»“<code>LoadBalancer</code> æ¨¡ç»„å…·æœ‰å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š</p><ol><li><p>å¯æ‰©å±•æ€§ï¼šé¢å‘æ¥å£çš„è®¾è®¡ï¼ŒåŠåŸºäºApache Shenyu SPIçš„å®ç°ï¼Œä½¿å¾—ç³»ç»Ÿå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚å¯ä»¥æ–¹ä¾¿çš„æ‰©å±•ä¸ºå…¶ä»–çš„åŠ¨æ€çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¦‚æœ€å°‘è¿æ¥æ–¹å¼(least connection)ã€æœ€å¿«æ¨¡å¼( fastest)ã€‚å¹¶æ”¯æŒé›†ç¾¤å¤„ç†ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚</p></li><li><p>å¯ä¼¸ç¼©æ€§ï¼šé‡‡ç”¨çš„ä¸€è‡´æ€§hashã€æƒé‡éšæœºå’Œæƒé‡è½®è¯¢ç®—æ³•ï¼Œéƒ½å¯ä»¥æ— ç¼æ”¯æŒé›†ç¾¤æ‰©å®¹æˆ–ç¼©å®¹ã€‚</p></li><li><p>æµé‡é¢„çƒ­ç­‰æ›´ç»†è‡´çš„è®¾è®¡ï¼Œèƒ½å¸¦æ¥æ•´ä½“ä¸Šæ›´ä¸ºå¹³æ»‘çš„è´Ÿè½½å‡è¡¡ã€‚</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/load-balance">load balance</a><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register">æ³¨å†Œä¸­å¿ƒå®ç°åŸç†ä¹‹Httpæ³¨å†Œ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T06:06:58.415Z">2023å¹´8æœˆ15æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ³¨å†Œä¸­å¿ƒæ˜¯ç”¨äºå°†å®¢æˆ·ç«¯ä¿¡æ¯æ³¨å†Œåˆ°<code>shenyu-admin</code>ï¼Œ<code>admin</code>å†é€šè¿‡æ•°æ®åŒæ­¥å°†è¿™äº›ä¿¡æ¯åŒæ­¥åˆ°ç½‘å…³ï¼Œç½‘å…³é€šè¿‡è¿™äº›æ•°æ®å®Œæˆæµé‡ç­›é€‰ã€‚å®¢æˆ·ç«¯ä¿¡æ¯ä¸»è¦åŒ…æ‹¬<code>æ¥å£ä¿¡æ¯</code>å’Œ<code>URIä¿¡æ¯</code>ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.5.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/register-center-design" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-æ³¨å†Œä¸­å¿ƒåŸç†"></a>1. æ³¨å†Œä¸­å¿ƒåŸç†<a class="hash-link" href="#1-æ³¨å†Œä¸­å¿ƒåŸç†" title="Direct link to heading">#</a></h3><p>å½“å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œè¯»å–æ¥å£ä¿¡æ¯å’Œ<code>uriä¿¡æ¯</code>ï¼Œé€šè¿‡æŒ‡å®šçš„æ³¨å†Œç±»å‹ï¼Œå°†æ•°æ®å‘é€åˆ°<code>shenyu-admin</code>ã€‚</p><p><img src="/zh/assets/images/register-center-6df3139bde6babdb3360f928f93bf737.png"></p><p>å›¾ä¸­çš„æ³¨å†Œä¸­å¿ƒéœ€è¦ç”¨æˆ·æŒ‡å®šä½¿ç”¨å“ªç§æ³¨å†Œç±»å‹ï¼Œ<code>ShenYu</code>å½“å‰æ”¯æŒ<code>Http</code>ã€<code>Zookeeper</code>ã€<code>Etcd</code>ã€<code>Consul</code>å’Œ<code>Nacos</code>è¿›è¡Œæ³¨å†Œã€‚å…·ä½“å¦‚ä½•é…ç½®è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><p><code>ShenYu</code>åœ¨æ³¨å†Œä¸­å¿ƒçš„åŸç†è®¾è®¡ä¸Šå¼•å…¥äº†<code>Disruptor</code>ï¼Œ<code>Disruptor</code>é˜Ÿåˆ—åœ¨å…¶ä¸­èµ·åˆ°æ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œåˆ©äºæ‰©å±•ã€‚å¦‚æœæ³¨å†Œè¯·æ±‚è¿‡å¤šï¼Œå¯¼è‡´æ³¨å†Œå¼‚å¸¸ï¼Œä¹Ÿæœ‰æ•°æ®ç¼“å†²ä½œç”¨ã€‚</p><p><img src="/zh/assets/images/shenyu-register-center-679a8ce3a7173b5f7a29f312448efa47.png"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ³¨å†Œä¸­å¿ƒåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€æ˜¯æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯<code>register-client</code>ï¼Œè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯æ•°æ®è¯»å–ã€‚å¦ä¸€ä¸ªæ˜¯æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯<code>register-server</code>ï¼Œè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ï¼ˆå°±æ˜¯<code>shenyu-admin</code>ï¼‰æ•°æ®å†™å…¥ã€‚é€šè¿‡æŒ‡å®šæ³¨å†Œç±»å‹è¿›è¡Œæ•°æ®å‘é€å’Œæ¥æ”¶ã€‚</p><ul><li>å®¢æˆ·ç«¯ï¼šé€šå¸¸æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå¯ä»¥æ˜¯<code>springmvc</code>ï¼Œ<code>spring-cloud</code>ï¼Œ<code>dubbo</code>ï¼Œ<code>grpc</code>ç­‰ã€‚</li><li><code>register-client</code>ï¼šæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯ï¼Œè¯»å–å®¢æˆ·æ¥å£å’Œ<code>uri</code>ä¿¡æ¯ã€‚</li><li><code>Disruptor</code>ï¼šæ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œæ•°æ®ç¼“å†²ä½œç”¨ã€‚</li><li><code>register-server</code>ï¼šæ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯ï¼Œè¿™é‡Œå°±æ˜¯<code>shenyu-admin</code>ï¼Œæ¥æ”¶æ•°æ®ï¼Œå†™å…¥æ•°æ®åº“ï¼Œå‘æ•°æ®åŒæ­¥äº‹ä»¶ã€‚</li><li>æ³¨å†Œç±»å‹ï¼šæŒ‡å®šæ³¨å†Œç±»å‹ï¼Œå®Œæˆæ•°æ®æ³¨å†Œï¼Œå½“å‰æ”¯æŒ<code>Http</code>ã€<code>Zookeeper</code>ã€<code>Etcd</code>ã€<code>Consul</code>å’Œ<code>Nacos</code>ã€‚</li></ul><p>æœ¬æ–‡åˆ†æçš„æ˜¯ä½¿ç”¨<code>Http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥å…·ä½“çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/shenyu-register-center-http-540b66ff202c41000b463cfae8403699.png"></p><p>åœ¨å®¢æˆ·ç«¯ï¼Œæ•°æ®å‡ºé˜Ÿåˆ—åï¼Œé€šè¿‡<code>http</code>ä¼ è¾“æ•°æ®ï¼Œåœ¨æœåŠ¡ç«¯ï¼Œæä¾›ç›¸åº”çš„æ¥å£ï¼Œæ¥æ”¶æ•°æ®ï¼Œç„¶åå†™å…¥é˜Ÿåˆ—ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹"></a>2. å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹<a class="hash-link" href="#2-å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹" title="Direct link to heading">#</a></h3><p>å½“å®¢æˆ·ç«¯å¯åŠ¨åï¼Œæ ¹æ®ç›¸å…³é…ç½®ï¼Œè¯»å–å±æ€§ä¿¡æ¯ï¼Œç„¶åå†™å…¥é˜Ÿåˆ—ã€‚ä»¥å®˜æ–¹æä¾›çš„ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> ä¸ºä¾‹ï¼Œå¼€å§‹æºç åˆ†æã€‚å®˜æ–¹æä¾›çš„ä¾‹å­æ˜¯ä¸€ä¸ªç”±<code>springboot</code>æ„å»ºçš„å¾®æœåŠ¡ã€‚æ³¨å†Œä¸­å¿ƒçš„ç›¸å…³é…ç½®å¯ä»¥å‚è€ƒå®˜ç½‘  <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-åŠ è½½é…ç½®è¯»å–å±æ€§"></a>2.1 åŠ è½½é…ç½®ï¼Œè¯»å–å±æ€§<a class="hash-link" href="#21-åŠ è½½é…ç½®è¯»å–å±æ€§" title="Direct link to heading">#</a></h4><p>å…ˆç”¨ä¸€å¼ å›¾ä¸²è”ä¸‹æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯åˆå§‹åŒ–æµç¨‹ï¼š</p><p><img src="/zh/assets/images/client-register-init-zh-40a0219a500b6637453b6ad0daf1bf87.png"></p><p>æˆ‘ä»¬åˆ†æçš„æ˜¯é€šè¿‡<code>http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¯ä¸ªå±æ€§è¡¨ç¤ºçš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>registerType</code>: æœåŠ¡æ³¨å†Œç±»å‹ï¼Œå¡«å†™ <code>http</code>ã€‚</li><li><code>serverList</code>: ä¸º<code>http</code>æ³¨å†Œç±»å‹æ—¶ï¼Œå¡«å†™<code>Shenyu-Admin</code>é¡¹ç›®çš„åœ°å€ï¼Œæ³¨æ„åŠ ä¸Š<code>http://</code>ï¼Œå¤šä¸ªåœ°å€ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚</li><li><code>username</code>: <code>Shenyu-Admin</code>ç”¨æˆ·å</li><li><code>password</code>: <code>Shenyu-Admin</code>ç”¨æˆ·å¯¹åº”çš„å¯†ç </li><li><code>port</code>: ä½ æœ¬é¡¹ç›®çš„å¯åŠ¨ç«¯å£ï¼Œç›®å‰<code>springmvc/tars/grpc</code>éœ€è¦è¿›è¡Œå¡«å†™ã€‚</li><li><code>contextPath</code>: ä¸ºä½ çš„è¿™ä¸ª<code>mvc</code>é¡¹ç›®åœ¨<code>shenyu</code>ç½‘å…³çš„è·¯ç”±å‰ç¼€ï¼Œ æ¯”å¦‚<code>/order</code> ï¼Œ<code>/product</code> ç­‰ç­‰ï¼Œç½‘å…³ä¼šæ ¹æ®ä½ çš„è¿™ä¸ªå‰ç¼€æ¥è¿›è¡Œè·¯ç”±ã€‚</li><li><code>appName</code>ï¼šä½ çš„åº”ç”¨åç§°ï¼Œä¸é…ç½®çš„è¯ï¼Œä¼šé»˜è®¤å– <code>spring.application.name</code> çš„å€¼ã€‚</li><li><code>isFull</code>: è®¾ç½® <code>true</code> ä»£è¡¨ä»£ç†ä½ çš„æ•´ä¸ªæœåŠ¡ï¼Œ<code>false</code>è¡¨ç¤ºä»£ç†ä½ å…¶ä¸­æŸå‡ ä¸ª<code>controller</code>ï¼›ç›®å‰é€‚ç”¨äº<code>springmvc/springcloud</code>ã€‚</li></ul><p>é¡¹ç›®å¯åŠ¨åï¼Œä¼šå…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œè¯»å–å±æ€§ä¿¡æ¯ï¼Œç”Ÿæˆç›¸åº”çš„<code>Bean</code>ã€‚</p><p>é¦–å…ˆè¯»å–åˆ°çš„é…ç½®æ–‡ä»¶æ˜¯ <code>ShenyuSpringMvcClientConfiguration</code>ï¼Œå®ƒæ˜¯<code>shenyu</code> å®¢æˆ·ç«¯<code>http</code>æ³¨å†Œé…ç½®ç±»ï¼Œé€šè¿‡<code>@Configuration</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œé€šè¿‡<code>@ImportAutoConfiguration</code>å¼•å…¥å…¶ä»–é…ç½®ç±»ã€‚åˆ›å»º<code>SpringMvcClientEventListener</code>ï¼Œä¸»è¦å¤„ç†å…ƒæ•°æ®å’Œ <code>URI</code> ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyu å®¢æˆ·ç«¯httpæ³¨å†Œé…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // åˆ›å»ºSpringMvcClientEventListenerï¼Œä¸»è¦å¤„ç†å…ƒæ•°æ®å’ŒURIä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                     final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuClientCommonBeanConfiguration</code>æ˜¯<code>shenyu</code>å®¢æˆ·ç«¯é€šç”¨é…ç½®ç±»ï¼Œä¼šåˆ›å»ºæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯é€šç”¨çš„<code>bean</code>ã€‚</p><ul><li>åˆ›å»º<code>ShenyuClientRegisterRepository</code>ï¼Œé€šè¿‡å·¥å‚ç±»åˆ›å»ºè€Œæˆã€‚</li><li>åˆ›å»º<code>ShenyuRegisterCenterConfig</code>ï¼Œè¯»å–<code>shenyu.register</code>å±æ€§é…ç½®ã€‚</li><li>åˆ›å»º<code>ShenyuClientConfig</code>ï¼Œè¯»å–<code>shenyu.client</code>å±æ€§é…ç½®ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyuå®¢æˆ·ç«¯é€šç”¨é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientCommonBeanConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // åˆ›å»ºShenyuClientRegisterRepositoryï¼Œé€šè¿‡å·¥å‚ç±»åˆ›å»ºè€Œæˆã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientRegisterRepository shenyuClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuClientRegisterRepositoryFactory.newInstance(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºShenyuRegisterCenterConfigï¼Œè¯»å–shenyu.registerå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // åˆ›å»ºShenyuClientConfigï¼Œè¯»å–shenyu.clientå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientConfig shenyuClientConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuClientConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-ç”¨äºæ³¨å†Œçš„-httpclientregisterrepository"></a>2.2 ç”¨äºæ³¨å†Œçš„ HttpClientRegisterRepository<a class="hash-link" href="#22-ç”¨äºæ³¨å†Œçš„-httpclientregisterrepository" title="Direct link to heading">#</a></h4><p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¸­ç”Ÿæˆçš„<code>ShenyuClientRegisterRepository</code>æ˜¯å®¢æˆ·ç«¯æ³¨å†Œçš„å…·ä½“å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒçš„å®ç°ç±»å¦‚ä¸‹ã€‚</p><p><img src="/zh/assets/images/shenyu-client-register-repository-dba8edf50af1be31d8b53c9573b1e015.png"></p><ul><li><code>HttpClientRegisterRepository</code>ï¼šé€šè¿‡<code>http</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>ConsulClientRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>EtcdClientRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>NacosClientRegisterRepository</code>ï¼šé€šè¿‡<code>nacos</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>ZookeeperClientRegisterRepository</code>é€šè¿‡<code>Zookeeper</code>è¿›è¡Œæ³¨å†Œã€‚</li></ul><p>å…·ä½“æ˜¯å“ªä¸€ç§æ–¹å¼ï¼Œæ˜¯é€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½å®ç°çš„ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * åŠ è½½ ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»º ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡SPIçš„æ–¹å¼è¿›è¡ŒåŠ è½½ï¼Œç±»å‹ç”±registerTypeå†³å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŠ è½½ç±»å‹é€šè¿‡<code>registerType</code>æŒ‡å®šï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ç±»å‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆ‘ä»¬æŒ‡å®šçš„æ˜¯<code>http</code>ï¼Œæ‰€ä»¥ä¼šå»åŠ è½½<code>HttpClientRegisterRepository</code>ã€‚å¯¹è±¡åˆ›å»ºæˆåŠŸåï¼Œæ‰§è¡Œçš„åˆå§‹åŒ–æ–¹æ³•<code>init()</code>å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository implements ShenyuClientRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // æš‚æ—¶çœç•¥å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„<code>username</code>ã€<code>password</code>å’Œ<code>serverLists</code>ï¼Œå³<code>sheenyu-admin</code>çš„è®¿é—®è´¦å·ã€å¯†ç å’Œåœ°å€ä¿¡æ¯ï¼Œä¸ºåç»­æ•°æ®å‘é€åšå‡†å¤‡ã€‚ç±»æ³¨è§£<code>@Join</code>ç”¨äº<code>SPI</code>çš„åŠ è½½ã€‚</p><blockquote><p><code>SPI</code> å…¨ç§°ä¸º <code>Service Provider Interface</code>, æ˜¯ <code>JDK</code> å†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°åŠŸèƒ½, ä¸€ç§åŠ¨æ€æ›¿æ¢å‘ç°çš„æœºåˆ¶ã€‚</p><p><a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-spi" target="_blank" rel="noopener noreferrer">shenyu-spi</a> æ˜¯<code>Apache ShenYu</code>ç½‘å…³è‡ªå®šä¹‰çš„<code>SPI</code>æ‰©å±•å®ç°ï¼Œè®¾è®¡å’Œå®ç°åŸç†å‚è€ƒäº†<code>Dubbo</code>çš„ <a href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/" target="_blank" rel="noopener noreferrer">SPIæ‰©å±•å®ç°</a> ã€‚</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23--æ„å»º-å…ƒæ•°æ®-å’Œ-uriä¿¡æ¯-çš„-springmvcclienteventlistener"></a>2.3  æ„å»º å…ƒæ•°æ® å’Œ URIä¿¡æ¯ çš„ SpringMvcClientEventListener<a class="hash-link" href="#23--æ„å»º-å…ƒæ•°æ®-å’Œ-uriä¿¡æ¯-çš„-springmvcclienteventlistener" title="Direct link to heading">#</a></h4><p>åˆ›å»º <code>SpringMvcClientEventListener</code>ï¼Œè´Ÿè´£å®¢æˆ·ç«¯ <code>å…ƒæ•°æ®</code> å’Œ <code>URI</code> æ•°æ®çš„æ„å»ºå’Œæ³¨å†Œï¼Œå®ƒçš„åˆ›å»ºæ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®Œæˆã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  åˆ›å»º SpringMvcClientEventListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>SpringMvcClientEventListener</code>ç»§æ‰¿äº†<code>AbstractContextRefreshedEventListener</code></li></ul><p><img src="/zh/assets/images/shenyu-client-event-listener-0cd56409c59f2546a285a6426f9c8fee.png"></p><p><code>AbstractContextRefreshedEventListener</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº†<code>ApplicationListener</code>æ¥å£ï¼Œå¹¶é‡å†™äº†<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œå½“æœ‰Springäº‹ä»¶å‘ç”Ÿåï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œã€‚å®ƒçš„å®ç°ç›®å‰æœ‰å…«ç§ï¼Œæ¯ä¸€ç§è¡¨ç¤ºå¯¹åº”çš„RPCè°ƒç”¨åè®®çš„ <code>å…ƒæ•°æ®</code> å’Œ<code>URI</code> ä¿¡æ¯çš„æ³¨å†Œã€‚</p><ul><li><code>AlibabaDubboServiceBeanListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Alibaba Dubbo</code>åè®®ï¼›</li><li><code>ApacheDubboServiceBeanListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Apacge Dubbo</code>åè®®ï¼›</li><li><code>GrpcClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>grpc</code>åè®®ï¼›</li><li><code>MotanServiceEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Mortan</code>åè®®ï¼›</li><li><code>SofaServiceEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Sofa</code>åè®®ï¼›</li><li><code>SpringMvcClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>http</code>åè®®ï¼›</li><li><code>SpringWebSocketClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>websocket</code>åè®®ï¼›</li><li><code>TarsServiceBeanEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Tars</code>æ³¨å†Œç±»å‹ï¼›</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å®ç°äº†ApplicationListeneræ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractContextRefreshedEventListener&lt;T, A extends Annotation&gt; implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ„é€ å‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractContextRefreshedEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯»å– shenyu.client.http é…ç½®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // appName åº”ç”¨åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // contextPathä¸Šä¸‹æ–‡è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = Optional.ofNullable(props.getProperty(ShenyuClientConstants.CONTEXT_PATH)).map(UriUtils::repairData).orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;client register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.ipAndPort = props.getProperty(ShenyuClientConstants.IP_PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // hostä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // port å®¢æˆ·ç«¯ç«¯å£ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¼€å§‹äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“æœ‰ä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ContextRefreshedEventå‘ç”Ÿæ—¶ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¿è¯è¯¥æ–¹æ³•çš„å†…å®¹åªæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ApplicationContext context = event.getApplicationContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å£°æ˜RPCè°ƒç”¨çš„ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, T&gt; beans = getBeans(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (MapUtils.isEmpty(beans)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºURIæ•°æ®å¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildURIRegisterDTO(context, beans));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºå…ƒæ•°æ®å¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        beans.forEach(this::handle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº¤ç»™ä¸åŒçš„å­ç±»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;all&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract URIRegisterDTO buildURIRegisterDTO(ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                          Map&lt;String, T&gt; beans);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handle(final String beanName, final T bean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = getCorrectedClass(bean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„å¯¹åº”shenyuå®¢æˆ·ç«¯çš„æ³¨è§£ï¼ˆå¯¹åº”ä¸åŒçš„RPCè°ƒç”¨æ³¨è§£ä¸ä¸€æ ·ï¼Œåƒhttpçš„å°±æ˜¯@ShenyuSpringMvcClient,è€ŒåƒSpringCloudçš„åˆ™æ˜¯@ShenyuSpringCloudClientï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final A beanShenyuClient = AnnotatedElementUtils.findMergedAnnotation(clazz, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®beanè·å–å¯¹åº”çš„pathï¼ˆä¸åŒå­ç±»å®ç°ä¸ä¸€æ ·ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(clazz, beanShenyuClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœåŒ…å«Shenyuå®¢æˆ·ç«¯æ³¨è§£æˆ–è€…pathä¸­åŒ…æ‹¬&#x27;*&#x27;ï¼Œè¡¨ç¤ºæ³¨å†Œæ•´ä¸ªç±»çš„æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºç±»çš„å…ƒæ•°æ®ï¼Œå‘é€æ³¨å†Œäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleClass(clazz, bean, beanShenyuClient, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„æ‰€æœ‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†Œç¬¦åˆæ¡ä»¶çš„æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleMethod(bean, clazz, beanShenyuClient, method, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºç±»å…ƒæ•°æ®å¹¶æ³¨å†Œçš„é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleClass(final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               @NonNull final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildMetaDataDTO(bean, beanShenyuClient, pathJoin(contextPath, superPath), clazz, null));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºæ–¹æ³•å…ƒæ•°æ®å¹¶æ³¨å†Œçš„é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ–¹æ³•ä¸Šæœ‰Shenyuå®¢æˆ·ç«¯æ³¨è§£ï¼Œå°±è¡¨ç¤ºè¯¥æ–¹æ³•éœ€è¦æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        A methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºå…ƒæ•°æ®ï¼Œå‘é€æ³¨å†Œäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº¤ç»™ä¸åŒå­ç±»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract MetaDataRegisterDTO buildMetaDataDTO(T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            @NonNull A shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            String path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Method method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨æ„é€ å‡½æ•°ä¸­ä¸»è¦æ˜¯è¯»å–å±æ€§é…ç½®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åï¼Œæ‰§è¡Œäº†<code>publisher.start()</code>ï¼Œå¼€å§‹äº‹ä»¶å‘å¸ƒï¼Œä¸ºæ³¨å†Œåšå‡†å¤‡ã€‚</p><ul><li>ShenyuClientRegisterEventPublisher</li></ul><p><code>ShenyuClientRegisterEventPublisher</code>é€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ï¼Œä¸»è¦æ˜¯ç”Ÿæˆå…ƒæ•°æ®å’Œ<code>URI</code>è®¢é˜…å™¨ï¼ˆåç»­ç”¨äºæ•°æ®å‘å¸ƒï¼‰ï¼Œç„¶åå¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚æä¾›äº†ä¸€ä¸ªå…±æœ‰æ–¹æ³•<code>publishEvent()</code>ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œå‘Disruptoré˜Ÿåˆ—å‘æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientRegisterEventPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuClientRegisterEventPublisher INSTANCE = new ShenyuClientRegisterEventPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;DataTypeParent&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¬å¼€é™æ€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ShenyuClientRegisterEventPublisher instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterEventPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Startæ–¹æ³•æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param shenyuClientRegisterRepository shenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºå®¢æˆ·ç«¯æ³¨å†Œå·¥å‚ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientExecutorFactory factory = new RegisterClientExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ å…ƒæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientMetadataExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  æ·»åŠ URIè®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientURIExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯åŠ¨Disruptoré˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å‘å¸ƒäº‹ä»¶ï¼Œå‘Disruptoré˜Ÿåˆ—å‘æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publishEvent(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;DataTypeParent&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AbstractContextRefreshedEventListener</code>çš„æ„é€ å‡½æ•°é€»è¾‘åˆ†æå®Œæˆäº†ï¼Œä¸»è¦æ˜¯è¯»å–å±æ€§é…ç½®ï¼Œåˆ›å»º<code>å…ƒæ•°æ®</code>å’Œ<code>URI</code>è®¢é˜…å™¨ï¼Œå¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚</p><p><code>onApplicationEvent()</code>æ–¹æ³•æ˜¯æœ‰<code>Spring</code>äº‹ä»¶å‘ç”Ÿæ—¶ä¼šæ‰§è¡Œï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯<code>ContextRefreshedEvent</code>ï¼Œè¡¨ç¤ºä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ã€‚å½“<code>Spring</code>å®¹å™¨å°±ç»ªåæ‰§è¡Œæ­¤å¤„é€»è¾‘ï¼šå…ˆæ„å»º<code>URI</code>æ•°æ®å¹¶æ³¨å†Œï¼Œå†æ„å»ºå…ƒæ•°æ®å¹¶æ³¨å†Œï¼Œ</p><blockquote><p><code>ContextRefreshedEvent</code>æ˜¯<code>Spring</code>å†…ç½®äº‹ä»¶ã€‚<code>ApplicationContext</code>è¢«åˆå§‹åŒ–æˆ–åˆ·æ–°æ—¶ï¼Œè¯¥äº‹ä»¶è¢«è§¦å‘ã€‚è¿™ä¹Ÿå¯ä»¥åœ¨ <code>ConfigurableApplicationContext</code>æ¥å£ä¸­ä½¿ç”¨ <code>refresh()</code> æ–¹æ³•æ¥å‘ç”Ÿã€‚æ­¤å¤„çš„åˆå§‹åŒ–æ˜¯æŒ‡ï¼šæ‰€æœ‰çš„<code>Bean</code>è¢«æˆåŠŸè£…è½½ï¼Œåå¤„ç†<code>Bean</code>è¢«æ£€æµ‹å¹¶æ¿€æ´»ï¼Œæ‰€æœ‰<code>Singleton Bean</code> è¢«é¢„å®ä¾‹åŒ–ï¼Œ<code>ApplicationContext</code>å®¹å™¨å·²å°±ç»ªå¯ç”¨ã€‚</p></blockquote><p>å†æ¥çœ‹<code>AbstractContextRefreshedEventListener</code>çš„httpå®ç°<code>SpringMvcClientEventListener</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientEventListener extends AbstractContextRefreshedEventListener&lt;Object, ShenyuSpringMvcClient&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;Class&lt;? extends Annotation&gt;&gt; mappingAnnotation = new ArrayList&lt;&gt;(3);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Boolean isFull;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ å‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(clientConfig, shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å– isFull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¡¨ç¤ºæ˜¯httpåè®®çš„å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Map&lt;String, Object&gt; getBeans(final ApplicationContext context) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½®å±æ€§ï¼Œå¦‚æœ isFull=true çš„è¯ï¼Œè¡¨ç¤ºæ³¨å†Œæ•´ä¸ªå¾®æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .contextPath(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .appName(getAppName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .path(PathUtils.decoratorPathWithSlash(getContextPath()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ruleName(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦åˆ™è·å–å¸¦Controlleræ³¨è§£çš„bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context.getBeansWithAnnotation(Controller.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ URIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected URIRegisterDTO buildURIRegisterDTO(final ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final Map&lt;String, Object&gt; beans) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String buildApiSuperPath(final Class&lt;?&gt; clazz, @Nullable final ShenyuSpringMvcClient beanShenyuClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰å¸¦ä¸ŠShenyuå®¢æˆ·ç«¯æ³¨è§£ï¼Œåˆ™ä¼˜å…ˆå–æ³¨è§£ä¸­çš„ä¸ä¸ºç©ºçš„pathå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; StringUtils.isNotBlank(beanShenyuClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return beanShenyuClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰å¸¦ä¸ŠRequestMappingæ³¨è§£ï¼Œä¸”pathå±æ€§ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›pathæ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(clazz, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å£°æ˜httpå®ç°çš„å®¢æˆ·ç«¯æ³¨è§£æ˜¯ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Class&lt;ShenyuSpringMvcClient&gt; getAnnotationType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuSpringMvcClient.class;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final Object bean, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final ShenyuSpringMvcClient beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method, final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„RequestMappingæ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„ ShenyuSpringMvcClient æ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœæœ‰ ShenyuSpringMvcClient æ³¨è§£å¹¶ä¸”åŒ…å«RequestMappingæ³¨è§£ï¼ˆè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ¥å£ï¼‰ï¼Œåˆ™è¿›è¡Œæ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient) &amp;&amp; Objects.nonNull(requestMapping)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected MetaDataRegisterDTO buildMetaDataDTO(final Object bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   @NonNull final ShenyuSpringMvcClient shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final String path, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ³¨å†Œé€»è¾‘éƒ½æ˜¯é€šè¿‡ <code>publisher.publishEvent()</code>å®Œæˆã€‚</p><p><code>Controller</code>æ³¨è§£å’Œ<code>RequestMapping</code>æ³¨è§£æ˜¯ç”±<code>Spring</code>æä¾›çš„ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚<code>ShenyuSpringMvcClient</code> æ³¨è§£æ˜¯ç”±<code>Apache ShenYu</code>æä¾›çš„ï¼Œç”¨äºæ³¨å†Œ<code>SpringMvc</code>å®¢æˆ·ç«¯ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyu å®¢æˆ·ç«¯æ¥å£ï¼Œç”¨äºæ–¹æ³•ä¸Šæˆ–ç±»ä¸Š</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;path&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;value&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ruleName è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // desc æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // enabledæ˜¯å¦å¯ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // registerMetaData æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean  registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å®ƒçš„ä½¿ç”¨å¦‚ä¸‹ï¼š</p><ul><li>æ³¨å†Œæ•´ä¸ªæ¥å£</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/test/**&quot;)  // è¡¨ç¤ºæ•´ä¸ªæ¥å£æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpTestController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ³¨å†Œå½“å‰æ–¹æ³•</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Save order dto.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param orderDTO the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/save&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/save&quot;, desc = &quot;Save order&quot;) // æ³¨å†Œå½“å‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO save(@RequestBody final OrderDTO orderDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDTO.setName(&quot;hello world save order&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>publisher.publishEvent() å‘å¸ƒæ³¨å†Œäº‹ä»¶</li></ul><p>è¯¥æ–¹æ³•ä¼šå°†æ•°æ®å‘é€åˆ°<code>Disruptor</code>é˜Ÿåˆ—ä¸­ï¼Œå…³äº<code>Disruptor</code>é˜Ÿåˆ—æ›´å¤šç»†èŠ‚è¿™é‡Œä¸åšæ›´å¤šä»‹ç»ï¼Œè¿™ä¸å½±å“åˆ†ææ³¨å†Œçš„æµç¨‹ã€‚</p><p>å½“æ•°æ®å‘é€åï¼Œ<code>Disruptor</code>é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ä¼šå¤„ç†æ•°æ®ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚</p><ul><li>QueueConsumer æ¶ˆè´¹æ•°æ®</li></ul><p><code>QueueConsumer</code>æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå®ç°äº†<code>WorkHandler</code>æ¥å£ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹åœ¨<code>providerManage.startup()</code>é€»è¾‘ä¸­ã€‚<code>WorkHandler</code>æ¥å£æ˜¯<code>disruptor</code>çš„æ•°æ®æ¶ˆè´¹æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯<code>onEvent()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumer</code>é‡å†™äº†<code>onEvent()</code>æ–¹æ³•ï¼Œä¸»è¦é€»è¾‘æ˜¯ç”Ÿæˆæ¶ˆè´¹ä»»åŠ¡ï¼Œç„¶ååœ¨çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é˜Ÿåˆ—æ¶ˆè´¹è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®äº‹ä»¶ç±»å‹ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡å·¥å‚åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¿å­˜æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ”¾åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code>æ˜¯åœ¨çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå…·ä½“çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼š</p><ul><li><code>RegisterClientConsumerExecutor</code>ï¼šå®¢æˆ·ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼›</li><li><code>RegisterServerConsumerExecutor</code>ï¼šæœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ã€‚</li></ul><p>é¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯ä»»åŠ¡ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ä»»åŠ¡ï¼ˆæœåŠ¡ç«¯å°±æ˜¯<code>admin</code>ï¼Œåœ¨ä¸‹æ–‡è¿›è¡Œåˆ†æï¼‰ã€‚</p><p><img src="/zh/assets/images/consumer-executor-f7ad67d35abaa5a2fac94ef913445a19.png"></p><ul><li>RegisterClientConsumerExecutor æ¶ˆè´¹è€…æ‰§è¡Œå™¨</li></ul><p>é‡å†™çš„<code>run()</code>é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterClientConsumerExecutor&lt;T extends DataTypeParent&gt; extends QueueConsumerExecutor&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final T data = getData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®æ•°æ®ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†å™¨è¿›è¡Œå¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribers.get(data.getType()).executor(Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹è°ƒç”¨ä¸åŒçš„å¤„ç†å™¨å»æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ã€‚æ•°æ®ç±»å‹æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯å…ƒæ•°æ®ï¼Œè®°å½•å®¢æˆ·ç«¯æ³¨å†Œä¿¡æ¯ã€‚ä¸€ä¸ªæ˜¯<code>URI</code>æ•°æ®ï¼Œè®°å½•å®¢æˆ·ç«¯æœåŠ¡ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//æ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public enum DataType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // URIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    URI,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor() æ‰§è¡Œå™¨è®¢é˜…è€…</li></ul><p>æ‰§è¡Œå™¨è®¢é˜…è€…ä¹Ÿåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯å¤„ç†å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ˜¯å¤„ç†<code>URI</code>ã€‚åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥ä¸€å…±æ˜¯å››ä¸ªã€‚</p><p><img src="/zh/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><p>å…ˆçœ‹å…ƒæ•°æ®å¤„ç†</p><ul><li>ShenyuClientMetadataExecutorSubscriber#executor()</li></ul><p>å®¢æˆ·ç«¯è¿™è¾¹å¯¹å…ƒæ•°æ®å¤„ç†é€»è¾‘æ˜¯ï¼šéå†å…ƒæ•°æ®ä¿¡æ¯ï¼Œè°ƒç”¨æ¥å£æ–¹æ³•<code>persistInterface()</code>å®Œæˆæ•°æ®çš„å‘å¸ƒã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientMetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA; // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (MetaDataRegisterDTO metaDataRegisterDTO : metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è°ƒç”¨æ¥å£æ–¹æ³•persistInterface()å®Œæˆæ•°æ®çš„å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistInterface(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterRepository#persistInterface()</li></ul><p><code>ShenyuClientRegisterRepository</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºè¡¨ç¤ºå®¢æˆ·ç«¯æ•°æ®æ³¨å†Œï¼Œå®ƒçš„å®ç°ç±»ç›®å‰æœ‰äº”ç§ï¼Œæ¯ä¸€ç§å°±è¡¨ç¤ºä¸€ç§æ³¨å†Œæ–¹æ³•ã€‚</p><ul><li><code>ConsulClientRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>EtcdClientRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>HttpClientRegisterRepository</code>ï¼šé€šè¿‡<code>Http</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>NacosClientRegisterRepository</code>ï¼šé€šè¿‡<code>Nacos</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>ZookeeperClientRegisterRepository</code>ï¼šé€šè¿‡<code>Zookeeper</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li></ul><p><img src="/zh/assets/images/client-register-repository-61756e3284c1d3a27083b25d393edf9c.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ³¨å†Œä¸­å¿ƒçš„åŠ è½½æ˜¯é€šè¿‡<code>SPI</code>çš„æ–¹å¼å®Œæˆçš„ã€‚è¿™ä¸ªåœ¨å‰é¢æåˆ°è¿‡äº†ï¼Œåœ¨å®¢æˆ·ç«¯é€šç”¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æŒ‡å®šé…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å®Œæˆå…·ä½“çš„ç±»åŠ è½½ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * åŠ è½½ ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»º ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡SPIçš„æ–¹å¼è¿›è¡ŒåŠ è½½ï¼Œç±»å‹ç”±registerTypeå†³å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ¬æ–‡çš„æºç åˆ†ææ˜¯åŸºäº<code>Http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ†æ<code>HttpClientRegisterRepository</code>ï¼Œå…¶ä»–çš„æ³¨å†Œæ–¹å¼åç»­å†åˆ†æã€‚<code>HttpClientRegisterRepository</code>ç»§æ‰¿äº†<code>FailbackRegistryRepository</code>ï¼Œè€Œ<code>FailbackRegistryRepository</code>æœ¬èº«ä¸»è¦ç”¨äºå¯¹<code>Http</code>æ³¨å†Œè¿‡ç¨‹ä¸­çš„å¤±è´¥å¼‚å¸¸çš„å¤„ç†ï¼Œè¿™é‡Œå°±çœç•¥äº†ã€‚</p><p>é€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œå¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨å·¥å…·ç±»å‘é€<code>http</code>è¯·æ±‚ã€‚æ³¨å†Œå…ƒæ•°æ®å’ŒURIéƒ½æ˜¯è°ƒç”¨çš„åŒä¸€ä¸ªæ–¹æ³•<code>doRegister()</code>ï¼ŒæŒ‡å®šæ¥å£å’Œç±»å‹å°±å¥½ã€‚</p><ul><li><code>Constants.URI_PATH</code>çš„å€¼<code>/shenyu-client/register-metadata</code>ï¼šæœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†Œå…ƒæ•°æ®ã€‚</li><li><code>Constants.META_PATH</code>çš„å€¼<code>/shenyu-client/register-uri</code>ï¼š    æœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†ŒURIã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository extends FailbackRegistryRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientRegisterRepository.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static URIRegisterDTO uriRegisterDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;String&gt; serverList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        init(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminçš„ç”¨æˆ·å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminçš„ç”¨æˆ·åå¯¹åº”çš„å¯†ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminæœåŠ¡åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®è®¿é—®çš„token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Persist uri.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param registerDTO the register dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistURI(final URIRegisterDTO registerDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RuntimeUtils.listenByOther(registerDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(registerDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uriRegisterDTO = registerDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistInterface(final MetaDataRegisterDTO metadata) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(metadata, Constants.META_PATH, Constants.META_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uriRegisterDTO != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            uriRegisterDTO.setEventType(EventType.DELETED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRegister(uriRegisterDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setAccessToken() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional&lt;?&gt; login = RegisterUtils.doLogin(username, password, server.concat(Constants.LOGIN_PATH));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                login.ifPresent(v -&gt; this.accessToken = String.valueOf(v));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Login admin url :{} is fail, will retry. cause: {} &quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void doRegister(final T t, final String path, final String type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†adminæœåŠ¡åˆ—è¡¨ï¼ˆadminå¯èƒ½æ˜¯é›†ç¾¤ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            i++;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String concat = server.concat(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è®¾ç½®è®¿é—®token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new NullPointerException(&quot;accessToken is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è°ƒç”¨å·¥å…·ç±»å‘é€ http è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RegisterUtils.doRegister(GsonUtils.getInstance().toJson(t), concat, type, accessToken);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Register admin url :{} is fail, will retry. cause:{}&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (i == serverList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å°†æ•°æ®åºåˆ—åŒ–åï¼Œé€šè¿‡<code>OkHttp</code>å‘é€æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€šè¿‡OkHttpå‘é€æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void doRegister(final String json, final String url, final String type) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasLength(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error accessToken is null, please check the config : {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Headers headers = new Headers.Builder().add(Constants.X_ACCESS_TOKEN, accessToken).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result = OkHttpTools.getInstance().post(url, json, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.equals(SUCCESS, result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;{} client register success: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ï¼Œå®¢æˆ·ç«¯é€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œå…ƒæ•°æ®çš„é€»è¾‘å°±åˆ†æå®Œäº†ã€‚å°ç»“ä¸€ä¸‹ï¼šé€šè¿‡è¯»å–è‡ªå®šä¹‰çš„æ³¨è§£ä¿¡æ¯æ„é€ å…ƒæ•°æ®ï¼Œå°†æ•°æ®å‘åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œç„¶åä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ•°æ®ï¼Œå°†æ¶ˆè´¹è€…æ”¾åˆ°çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œï¼Œæœ€ç»ˆé€šè¿‡å‘é€<code>http</code>è¯·æ±‚åˆ°<code>admin</code>ã€‚</p><p>å†æ¥çœ‹çœ‹ <code>URI</code> æ•°æ®çš„å¤„ç†</p><ul><li>ShenyuClientURIExecutorSubscriber#executor()</li></ul><p>ä¸»è¦é€»è¾‘æ˜¯éå†URIæ•°æ®é›†åˆï¼Œé€šè¿‡<code>persistURI()</code>æ–¹æ³•å®ç°æ•°æ®æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientURIExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; //æ•°æ®ç±»å‹æ˜¯URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨å†ŒURIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (URIRegisterDTO uriRegisterDTO : dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Stopwatch stopwatch = Stopwatch.createStarted();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (Socket ignored = new Socket(uriRegisterDTO.getHost(), uriRegisterDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long sleepTime = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // maybe the port is delay exposed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 5) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;host:{}, port:{} connection failed, will retry&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                uriRegisterDTO.getHost(), uriRegisterDTO.getPort());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If the connection fails for a long time, Increase sleep time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 180) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sleepTime = 10000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TimeUnit.MILLISECONDS.sleep(sleepTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ex.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ·»åŠ hookï¼Œä¼˜é›…åœæ­¢å®¢æˆ·ç«¯ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.delayOtherHooks();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistURI(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»£ç ä¸­çš„<code>while(true)</code>å¾ªç¯æ˜¯ä¸ºäº†ä¿è¯å®¢æˆ·ç«¯å·²ç»æˆåŠŸå¯åŠ¨äº†ï¼Œé€šè¿‡<code>host</code>å’Œ<code>port</code>å¯ä»¥è¿æ¥ä¸Šã€‚</p><p>åé¢çš„é€»è¾‘æ˜¯ï¼šæ·»åŠ <code>hook</code>å‡½æ•°ï¼Œç”¨äºä¼˜é›…åœæ­¢å®¢æˆ·ç«¯ ã€‚</p><p>é€šè¿‡<code>persistURI()</code>æ–¹æ³•å®ç°æ•°æ®æ³¨å†Œã€‚æ•´ä¸ªé€»è¾‘ä¹Ÿåœ¨å‰é¢åˆ†æè¿‡äº†ï¼Œæœ€ç»ˆå°±æ˜¯é€šè¿‡<code>OkHttp</code>å®¢æˆ·ç«¯å‘<code>shenyu-admin</code>å‘èµ·<code>http</code>ï¼Œé€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œ<code>URI</code>ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œå°±å°†å®¢æˆ·ç«¯çš„æ³¨å†Œé€»è¾‘åˆ†æå®Œäº†ï¼Œå°†æ„å»ºçš„å…ƒæ•°æ®å’ŒURIæ•°æ®å‘é€åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œå†ä»ä¸­æ¶ˆè´¹ï¼Œè¯»å–æ•°æ®ï¼Œé€šè¿‡<code>http</code>å‘<code>admin</code>å‘é€æ•°æ®ã€‚</p><p>å®¢æˆ·ç«¯<code>å…ƒæ•°æ®</code>å’Œ<code>URI</code>æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œæˆäº†ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/client-metadata-uri-register-zh-a7094099a530101dee93b172a1bc0254.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-æœåŠ¡ç«¯æ³¨å†Œæµç¨‹"></a>3. æœåŠ¡ç«¯æ³¨å†Œæµç¨‹<a class="hash-link" href="#3-æœåŠ¡ç«¯æ³¨å†Œæµç¨‹" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-æ³¨å†Œæ¥å£shenyuclienthttpregistrycontroller"></a>3.1 æ³¨å†Œæ¥å£ShenyuClientHttpRegistryController<a class="hash-link" href="#31-æ³¨å†Œæ¥å£shenyuclienthttpregistrycontroller" title="Direct link to heading">#</a></h4><p>ä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼ŒæœåŠ¡ç«¯æä¾›äº†æ³¨å†Œçš„ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li><code>/shenyu-client/register-metadata</code>ï¼šæœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†Œå…ƒæ•°æ®ã€‚</li><li><code>/shenyu-client/register-uri</code>ï¼š    æœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†ŒURIã€‚</li></ul><p>è¿™ä¸¤ä¸ªæ¥å£ä½äº<code>ShenyuClientHttpRegistryController</code>ä¸­ï¼Œå®ƒå®ç°äº†<code>ShenyuClientServerRegisterRepository</code>æ¥å£ï¼Œæ˜¯æœåŠ¡ç«¯æ³¨å†Œçš„å®ç°ç±»ã€‚å®ƒç”¨<code>@Join</code>æ ‡è®°ï¼Œè¡¨ç¤ºé€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// shenuyuå®¢æˆ·ç«¯æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/shenyu-client&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientHttpRegistryController implements ShenyuClientServerRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuClientServerRegisterPublisher publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuClientServerRegisterPublisher publisher, final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.publisher = publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-metadata&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerMetadata(@RequestBody final MetaDataRegisterDTO metaDataRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-uri&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(@RequestBody final URIRegisterDTO uriRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸¤ä¸ªæ³¨å†Œæ¥å£è·å–åˆ°æ•°æ®å¥½ï¼Œå°±è°ƒç”¨äº†<code>publisher.publish()</code>æ–¹æ³•ï¼ŒæŠŠæ•°æ®å‘å¸ƒåˆ°<code>Disruptor</code>é˜Ÿåˆ—ä¸­ã€‚</p><ul><li><code>ShenyuClientServerRegisterRepository</code>æ¥å£</li></ul><p><code>ShenyuClientServerRegisterRepository</code>æ¥å£æ˜¯æœåŠ¡æ³¨å†Œæ¥å£ï¼Œå®ƒæœ‰äº”ä¸ªå®ç°ç±»ï¼Œè¡¨ç¤ºæœ‰äº”ç§æ³¨å†Œæ–¹å¼ï¼š</p><ul><li><code>ConsulClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>å®ç°æ³¨å†Œ;</li><li><code>EtcdClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>å®ç°æ³¨å†Œï¼›</li><li><code>NacosClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Nacos</code>å®ç°æ³¨å†Œï¼›</li><li><code>ShenyuClientHttpRegistryController</code>ï¼šé€šè¿‡<code>Http</code>å®ç°æ³¨å†Œï¼›</li><li><code>ZookeeperClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Zookeeper</code>å®ç°æ³¨å†Œã€‚</li></ul><p>å…·ä½“ç”¨å“ªä¸€ç§æ–¹å¼ï¼Œæ˜¯é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šçš„ï¼Œç„¶åé€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½ã€‚</p><p>åœ¨<code>shenyu-admin</code>ä¸­çš„<code>application.yml</code>æ–‡ä»¶ä¸­é…ç½®æ³¨å†Œæ–¹å¼ï¼Œ<code>registerType</code>æŒ‡å®šæ³¨å†Œç±»å‹ï¼Œå½“ç”¨<code>http</code>è¿›è¡Œæ³¨å†Œæ—¶ï¼Œ<code>serverLists</code>ä¸éœ€è¦å¡«å†™ï¼Œæ›´å¤šé…ç½®è¯´æ˜å¯ä»¥å‚è€ƒå®˜ç½‘  <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverLists</span><span class="token punctuation" style="color:#393A34">:</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>RegisterCenterConfiguration åŠ è½½é…ç½®</li></ul><p>åœ¨å¼•å…¥ç›¸å…³ä¾èµ–å’Œå±æ€§é…ç½®åï¼Œå¯åŠ¨<code>shenyu-admin</code>æ—¶ï¼Œä¼šå…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå’Œæ³¨å†Œä¸­å¿ƒç›¸å…³çš„é…ç½®æ–‡ä»¶ç±»æ˜¯<code>RegisterCenterConfiguration</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨å†Œä¸­å¿ƒé…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterCenterConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¯»å–é…ç½®å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åˆ›å»ºShenyuServerRegisterRepositoryï¼Œç”¨äºæœåŠ¡ç«¯æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuServerRegisterRepository shenyuServerRegisterRepository(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig, final List&lt;ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.ä»é…ç½®å±æ€§ä¸­è·å–æ³¨å†Œç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String registerType = shenyuRegisterCenterConfig.getRegisterType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.é€šè¿‡æ³¨å†Œç±»å‹ï¼Œä»¥SPIçš„æ–¹æ³•åŠ è½½å®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuClientServerRegisterRepository registerRepository = ExtensionLoader.getExtensionLoader(ShenyuClientServerRegisterRepository.class).getJoin(registerType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.è·å–publisherï¼Œå‘Disruptoré˜Ÿåˆ—ä¸­å†™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientServerDisruptorPublisher publisher = RegisterClientServerDisruptorPublisher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.æ³¨å†ŒServiceï¼Œ rpcType -&gt; registerService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuClientRegisterService&gt; registerServiceMap = shenyuClientRegisterService.stream().collect(Collectors.toMap(ShenyuClientRegisterService::rpcType, e -&gt; e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5.äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(registerServiceMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.æ³¨å†Œçš„åˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRepository.init(publisher, shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerRepository;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨é…ç½®ç±»ä¸­ç”Ÿæˆäº†ä¸¤ä¸ª<code>bean</code>ï¼š</p><ul><li><p><code>shenyuRegisterCenterConfig</code>ï¼šè¯»å–å±æ€§é…ç½®ï¼›</p></li><li><p><code>shenyuClientServerRegisterRepository</code>ï¼šç”¨äºæœåŠ¡ç«¯æ³¨å†Œã€‚</p></li></ul><p>åœ¨åˆ›å»º<code>shenyuClientServerRegisterRepository</code>çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè¿›è¡Œäº†ä¸€ç³»åˆ—çš„å‡†å¤‡å·¥ä½œï¼š</p><ul><li>1.ä»é…ç½®å±æ€§ä¸­è·å–æ³¨å†Œç±»å‹ã€‚</li><li>2.é€šè¿‡æ³¨å†Œç±»å‹ï¼Œä»¥<code>SPI</code>çš„æ–¹æ³•åŠ è½½å®ç°ç±»ï¼šæ¯”å¦‚æŒ‡å®šçš„ç±»å‹æ˜¯<code>http</code>ï¼Œå°±ä¼šåŠ è½½<code>ShenyuClientHttpRegistryController</code>ã€‚</li><li>3.è·å–<code>publisher</code>ï¼Œå‘<code>Disruptor</code>é˜Ÿåˆ—ä¸­å†™æ•°æ®ã€‚</li><li>4.æ³¨å†Œ<code>Service</code>ï¼Œ <code>rpcType -&gt; registerService</code>ï¼šè·å–æ³¨å†Œçš„<code>Service</code>ï¼Œæ¯ç§<code>rpc</code>éƒ½æœ‰å¯¹åº”çš„<code>Service</code>ã€‚æœ¬æ–‡çš„å®¢æˆ·ç«¯æ„å»ºæ˜¯é€šè¿‡<code>springboot</code>ï¼Œå±äº<code>http</code>ç±»å‹ï¼Œè¿˜æœ‰å…¶ä»–å®¢æˆ·ç«¯ç±»å‹ï¼š<code>dubbo</code>ï¼Œ<code>Spring Cloud</code>ï¼Œ<code>gRPC</code>ç­‰ã€‚</li><li>5.äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œï¼šæ·»åŠ æœåŠ¡ç«¯å…ƒæ•°æ®å’Œ<code>URI</code>è®¢é˜…å™¨ï¼Œå¤„ç†æ•°æ®ã€‚å¹¶ä¸”å¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚</li><li>6.æ³¨å†Œçš„åˆå§‹åŒ–æ“ä½œï¼š<code>http</code>ç±»å‹çš„æ³¨å†Œåˆå§‹åŒ–æ“ä½œå°±æ˜¯ä¿å­˜<code>publisher</code>ã€‚</li></ul><ul><li>RegisterServerDisruptorPublisher#publish()</li></ul><p>æœåŠ¡ç«¯å‘<code>Disruptor</code>é˜Ÿåˆ—å†™å…¥æ•°æ®çš„å‘å¸ƒè€… ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼æ„å»ºã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterClientServerDisruptorPublisher implements ShenyuClientServerRegisterPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ç§æœ‰å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final RegisterClientServerDisruptorPublisher INSTANCE = new RegisterClientServerDisruptorPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;Collection&lt;DataTypeParent&gt;&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å…¬å¼€é™æ€æ–¹æ³•è·å–å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static RegisterServerDisruptorPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œï¼Œæ·»åŠ æœåŠ¡ç«¯å…ƒæ•°æ®å’ŒURIè®¢é˜…å™¨ï¼Œå¤„ç†æ•°æ®ã€‚å¹¶ä¸”å¯åŠ¨Disruptoré˜Ÿåˆ—ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final Map&lt;String, ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æœåŠ¡ç«¯æ³¨å†Œå·¥å‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerExecutorFactory factory = new RegisterServerExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ·»åŠ URIæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new URIRegisterExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ·»åŠ å…ƒæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new MetadataExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¯åŠ¨Disruptoré˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(Collections.singleton(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰¹é‡å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final Collection&lt;? extends DataTypeParent&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(dataList.stream().map(DataTypeParent.class::cast).collect(Collectors.toList()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.getProvider().shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é…ç½®æ–‡ä»¶çš„åŠ è½½ï¼Œå¯çœ‹ä½œæ˜¯æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯åˆå§‹åŒ–æµç¨‹ï¼Œç”¨å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-register-init-zh-f459729f048f19f89b7eaa023ae4b4e8.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-æ¶ˆè´¹æ•°æ®queueconsumer"></a>3.2 æ¶ˆè´¹æ•°æ®QueueConsumer<a class="hash-link" href="#32-æ¶ˆè´¹æ•°æ®queueconsumer" title="Direct link to heading">#</a></h4><p>åœ¨å‰é¢åˆ†æäº†å®¢æˆ·ç«¯<code>disruptor</code>é˜Ÿåˆ—æ¶ˆè´¹æ•°æ®çš„è¿‡ã€‚æœåŠ¡ç«¯ä¹Ÿæ˜¯ä¸€æ ·çš„é€»è¾‘ï¼Œåªæ˜¯å…¶ä¸­æ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œè€…å˜äº†ã€‚</p><p><code>QueueConsumer</code>æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå®ç°äº†<code>WorkHandler</code>æ¥å£ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹åœ¨<code>providerManage.startup()</code>é€»è¾‘ä¸­ã€‚<code>WorkHandler</code>æ¥å£æ˜¯<code>disruptor</code>çš„æ•°æ®æ¶ˆè´¹æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯<code>onEvent()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumer</code>é‡å†™äº†<code>onEvent()</code>æ–¹æ³•ï¼Œä¸»è¦é€»è¾‘æ˜¯ç”Ÿæˆæ¶ˆè´¹ä»»åŠ¡ï¼Œç„¶ååœ¨çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é˜Ÿåˆ—æ¶ˆè´¹è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®äº‹ä»¶ç±»å‹è·å–ç›¸åº”çš„çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡å·¥å‚åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¿å­˜æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ”¾åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code>æ˜¯åœ¨çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå…·ä½“çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼š</p><ul><li><code>RegisterClientConsumerExecutor</code>ï¼šå®¢æˆ·ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼›</li><li><code>RegisterServerConsumerExecutor</code>ï¼šæœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ã€‚</li></ul><p>é¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯ä»»åŠ¡ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ä»»åŠ¡ã€‚</p><ul><li><code>RegisterServerConsumerExecutor#run()</code></li></ul><p><code>RegisterServerConsumerExecutor</code>æ˜¯æœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼Œå®ƒé€šè¿‡<code>QueueConsumerExecutor</code>é—´æ¥å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå¹¶é‡å†™äº†<code>run()</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterServerConsumerExecutor extends QueueConsumerExecutor&lt;Collection&lt;DataTypeParent&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–ä»disruptoré˜Ÿåˆ—ä¸­æ‹¿åˆ°çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;DataTypeParent&gt; results = getData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(this::isValidData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ ¹æ®ç±»å‹æ‰§è¡Œæ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectExecutor(results).executor(results);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ ¹æ®ç±»å‹è·å–è®¢é˜…è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ExecutorSubscriber&lt;DataTypeParent&gt; selectExecutor(final Collection&lt;DataTypeParent&gt; list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Optional&lt;DataTypeParent&gt; first = list.stream().findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return subscribers.get(first.orElseThrow(() -&gt; new RuntimeException(&quot;the data type is not found&quot;)).getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>æ‰§è¡Œå™¨è®¢é˜…è€…åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯å¤„ç†å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ˜¯å¤„ç†<code>URI</code>ã€‚åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥ä¸€å…±æ˜¯å››ä¸ªã€‚</p><p><img src="/zh/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><ul><li>MetadataExecutorSubscriber#executor()</li></ul><p>å¦‚æœæ˜¯æ³¨å†Œå…ƒæ•°æ®ï¼Œåˆ™é€šè¿‡<code>MetadataExecutorSubscriber#executor()</code>å®ç°ï¼šæ ¹æ®ç±»å‹è·å–æ³¨å†Œ<code>Service</code>ï¼Œè°ƒç”¨<code>register()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class MetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA;  // å…ƒæ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†å…ƒæ•°æ®åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataRegisterDTOList.forEach(meta -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(this.shenyuClientRegisterService.get(meta.getRpcType())) // æ ¹æ®ç±»å‹è·å–æ³¨å†ŒService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(shenyuClientRegisterService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¯¹å…ƒæ•°æ®è¿›è¡Œæ³¨å†Œï¼ŒåŠ é”ç¡®ä¿é¡ºåºæ‰§è¡Œï¼Œé˜²æ­¢å¹¶å‘é”™è¯¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            shenyuClientRegisterService.register(meta);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>URIRegisterExecutorSubscriber#executor()</li></ul><p>å¦‚æœæ˜¯æ³¨å†Œå…ƒæ•°æ®ï¼Œåˆ™é€šè¿‡<code>URIRegisterExecutorSubscriber#executor()</code>å®ç°ï¼šæ„å»º<code>URI</code>æ•°æ®ï¼Œæ ¹æ®æ³¨å†Œç±»å‹æŸ¥æ‰¾<code>Serviceï¼Œ</code>é€šè¿‡<code>registerURI</code>æ–¹æ³•å®ç°æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class URIRegisterExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; // URIæ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®rpcè°ƒç”¨ç±»å‹èšé›†æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; groupByRpcType = dataList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(data -&gt; StringUtils.isNotBlank(data.getRpcType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.groupingBy(URIRegisterDTO::getRpcType));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, List&lt;URIRegisterDTO&gt;&gt; entry : groupByRpcType.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String rpcType = entry.getKey();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®ç±»å‹æŸ¥æ‰¾Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(shenyuClientRegisterService.get(rpcType))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final List&lt;URIRegisterDTO&gt; list = entry.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // æ„å»ºURIæ•°æ®ç±»å‹ï¼Œé€šè¿‡registerURIæ–¹æ³•å®ç°æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(list);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterService#register()</li></ul><p><code>ShenyuClientRegisterService</code>æ˜¯æ³¨å†Œæ–¹æ³•æ¥å£ï¼Œå®ƒæœ‰å¤šä¸ªå®ç°ç±»ï¼š</p><p><img src="/zh/assets/images/client-register-service-949e3110cb57db2f250dafdc41446eb4.png"></p><ul><li><code>AbstractContextPathRegisterService</code>ï¼šæŠ½è±¡ç±»ï¼Œå¤„ç†éƒ¨åˆ†å…¬å…±é€»è¾‘ï¼›</li><li><code>AbstractShenyuClientRegisterServiceImpl</code>ï¼šï¼šæŠ½è±¡ç±»ï¼Œå¤„ç†éƒ¨åˆ†å…¬å…±é€»è¾‘ï¼›</li><li><code>ShenyuClientRegisterDivideServiceImpl</code>ï¼š<code>divide</code>ç±»ï¼Œå¤„ç†<code>http</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterDubboServiceImpl</code>ï¼š<code>dubbo</code>ç±»ï¼Œå¤„ç†<code>dubbo</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterGrpcServiceImpl</code>ï¼š<code>gRPC</code>ç±»ï¼Œå¤„ç†<code>gRPC</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterMotanServiceImpl</code>ï¼š<code>Motan</code>ç±»ï¼Œå¤„ç†<code>Motan</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterSofaServiceImpl</code>ï¼š<code>Sofa</code>ç±»ï¼Œå¤„ç†<code>Sofa</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterSpringCloudServiceImpl</code>ï¼š<code>SpringCloud</code>ç±»ï¼Œå¤„ç†<code>SpringCloud</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterTarsServiceImpl</code>ï¼š<code>Tars</code>ç±»ï¼Œå¤„ç†<code>Tars</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterWebSocketServiceImpl</code>ï¼š<code>Websocket</code>ç±»ï¼Œå¤„ç†<code>Websocket</code>æ³¨å†Œç±»å‹ï¼›</li></ul><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¯ç§å¾®æœåŠ¡éƒ½æœ‰å¯¹åº”çš„æ³¨å†Œå®ç°ç±»ï¼Œæœ¬æ–‡çš„æºç åˆ†ææ˜¯ ä»¥å®˜æ–¹æä¾›çš„ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> ä¸ºä¾‹ï¼Œæ˜¯å±<code>http</code>æ³¨å†Œç±»å‹ï¼Œæ‰€ä»¥å…ƒæ•°æ®å’ŒURIæ•°æ®çš„æ³¨å†Œå®ç°ç±»æ˜¯ <code>ShenyuClientRegisterDivideServiceImpl</code>ï¼š</p><ul><li>register(): æ³¨å†Œå…ƒæ•°æ®</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.æ³¨å†Œé€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.æ³¨å†Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.æ³¨å†Œå…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.æ³¨å†ŒcontextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ•´ä¸ªæ³¨å†Œé€»è¾‘å¯ä»¥åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼š</p><ul><li>1.æ³¨å†Œé€‰æ‹©å™¨ä¿¡æ¯</li><li>2.æ³¨å†Œè§„åˆ™ä¿¡æ¯</li><li>3.æ³¨å†Œå…ƒæ•°æ®ä¿¡æ¯</li><li>4.æ³¨å†Œ<code>contextPath</code></li></ul><p>åœ¨<code>admin</code>è¿™ä¸€ä¾§é€šè¿‡å®¢æˆ·ç«¯çš„å…ƒæ•°æ®ä¿¡æ¯éœ€è¦æ„å»ºé€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œ<code>ContextPath</code>ã€‚å…·ä½“çš„æ³¨å†Œè¿‡ç¨‹å’Œç»†èŠ‚å¤„ç†è·Ÿ<code>rpc</code>ç±»å‹æœ‰å…³ã€‚æˆ‘ä»¬å°±ä¸å†ç»§ç»­å‘ä¸‹è¿½è¸ªäº†ï¼Œå¯¹äºæ³¨å†Œä¸­å¿ƒçš„é€»è¾‘åˆ†æï¼Œè·Ÿè¸ªåˆ°è¿™é‡Œå°±å¤Ÿäº†ã€‚</p><p>æœåŠ¡ç«¯å…ƒæ•°æ®æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œäº†ï¼Œæµç¨‹å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-metadata-register-zh-1b1d9d30b0f3c8fedc59d9a82ab24896.png"></p><ul><li>registerURI(): æ³¨å†Œ<code>URI</code>æ•°æ®</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯¹åº”çš„é€‰æ‹©å™¨æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†é€‰æ‹©å™¨ä¸­çš„handlerä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®åº“ä¸­çš„è®°å½•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>admin</code>æ‹¿åˆ°<code>URI</code>æ•°æ®åï¼Œä¸»è¦æ˜¯æ›´æ–°é€‰æ‹©å™¨ä¸­çš„<code>handler</code>ä¿¡æ¯ï¼Œç„¶åå†™å…¥åˆ°æ•°æ®åº“ï¼Œæœ€åå‘å¸ƒäº‹ä»¶é€šçŸ¥ç½‘å…³ã€‚é€šçŸ¥ç½‘å…³çš„é€»è¾‘æ˜¯ç”±æ•°æ®åŒæ­¥æ“ä½œå®Œæˆï¼Œè¿™åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å·²ç»åˆ†æè¿‡äº†ï¼Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>æœåŠ¡ç«¯<code>URI</code>æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œæˆäº†ï¼Œç”¨å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-uri-register-zh-4d956ca81d252f021f22e8a28d15bf2d.png"></p><p>è‡³æ­¤ï¼ŒæœåŠ¡ç«¯æ³¨å†Œæµç¨‹ä¹Ÿå°±åˆ†æå®Œäº†ï¼Œä¸»è¦é€šè¿‡å¯¹å¤–æä¾›çš„æ¥å£ï¼Œæ¥å—å®¢æˆ·ç«¯çš„æ³¨å†Œä¿¡æ¯ï¼Œç„¶åå†™å…¥åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œå†ä»ä¸­æ¶ˆè´¹æ•°æ®ï¼Œæ ¹æ®æ¥æ”¶åˆ°çš„å…ƒæ•°æ®å’Œ<code>URI</code>æ•°æ®æ›´æ–°<code>admin</code>çš„é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œé€‰æ‹©å™¨çš„<code>handler</code>ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-æ€»ç»“"></a>4. æ€»ç»“<a class="hash-link" href="#4-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡ä¸»è¦å¯¹<code>Apache ShenYu</code>ç½‘å…³ä¸­çš„<code>httpæ³¨å†Œ</code>æ¨¡å—è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼Œå½’çº³å¦‚ä¸‹ï¼š</p><ul><li>æ³¨å†Œä¸­å¿ƒæ˜¯ä¸ºäº†å°†å®¢æˆ·ç«¯ä¿¡æ¯æ³¨å†Œåˆ°<code>admin</code>ï¼Œæ–¹ä¾¿æµé‡ç­›é€‰ï¼›</li><li><code>http</code>æ³¨å†Œæ˜¯å°†å®¢æˆ·ç«¯å…ƒæ•°æ®ä¿¡æ¯å’Œ<code>URI</code>ä¿¡æ¯æ³¨å†Œåˆ°<code>admin</code>ï¼›</li><li><code>http</code>æœåŠ¡çš„æ¥å…¥é€šè¿‡æ³¨è§£<code>@ShenyuSpringMvcClient</code>æ ‡è¯†ï¼›</li><li>æ³¨å†Œä¿¡æ¯çš„æ„å»ºä¸»è¦é€šè¿‡<code>Spring</code>åº”ç”¨ç›‘å¬å™¨<code>ApplicationListener</code>ï¼›</li><li>æ³¨å†Œç±»å‹çš„åŠ è½½é€šè¿‡<code>SPI</code>å®Œæˆï¼›</li><li>å¼•å…¥<code>Disruptor</code>é˜Ÿåˆ—æ˜¯ä¸ºäº†æ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œä»¥åŠæ•°æ®ç¼“å†²ã€‚</li><li>æ³¨å†Œä¸­å¿ƒçš„å®ç°é‡‡ç”¨äº†é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä½¿ç”¨æ¨¡æ¿æ–¹æ³•ã€å•ä¾‹ã€è§‚å¯Ÿè€…ç­‰è®¾è®¡æ¨¡å¼ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/http">http</a><a class="margin-horiz--sm" href="/zh/blog/tags/register-center">register center</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge-- åŸºäºSPIçš„è®¾è®¡å®ç°åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T06:06:58.415Z">2023å¹´8æœˆ15æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>çµæ´»çš„æ’ä»¶å’Œè§„åˆ™å®šä¹‰ï¼Œæ˜¯<a href="http://shenyu.apache.org/" target="_blank" rel="noopener noreferrer">Shenyuç½‘å…³</a>çš„ä¸€å¤§ç‰¹è‰²ã€‚å®ƒä»¥æ’ä»¶å½¢å¼æ”¯æŒå¤šç§ç½‘ç»œåè®®å’Œå¤šç§æµè¡Œçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå¦‚Dubbo, gRPCå’Œ Spring-Cloud ç­‰ã€‚ ä¸ºäº†å®ç°å¯¹å„ç§åè®®åŠæ’ä»¶çš„é…ç½®è§„åˆ™çš„è§£æï¼Œç½‘å…³åœ¨è§„åˆ™ç­–ç•¥è§£ææ–¹é¢ï¼Œé‡‡ç”¨äº†ä¼˜é›…çš„<code>SPI</code>(Service Provider Interface)å®ç°ï¼Œå½“æ·»åŠ æ–°çš„æ’ä»¶æ—¶ï¼Œè§„åˆ™è§£æéƒ¨åˆ†å¯ä»¥æ²¿ç”¨ç°æœ‰å®ç°æˆ–é‡‡ç”¨<code>SPI</code>æœºåˆ¶å¿«é€Ÿå®ç°ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi-çš„é¡¶å±‚è®¾è®¡"></a><code>SPI</code> çš„é¡¶å±‚è®¾è®¡<a class="hash-link" href="#spi-çš„é¡¶å±‚è®¾è®¡" title="Direct link to heading">#</a></h2><p>Shenyuçš„<code>SPI</code>é‡‡ç”¨æ¥å£+ å·¥å‚æ¨¡å¼+é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œæ¥å®ç°æ¨¡ç»„çš„åŠ¨æ€åŠ è½½ã€‚åœ¨å…¶<strong><em>shen-<code>SPI</code></em></strong>-æ¨¡ç»„ï¼Œåšäº†<code>SPI</code>çš„é¡¶å±‚è®¾è®¡ã€‚å®šä¹‰äº†@ Join ï¼Œ@<code>SPI</code> ä¸¤ä¸ªannotationã€‚ å…¶ä¸­@Join  ä»£è¡¨æ­¤ç±»ä¼šåŠ å…¥æ‰©å±•æœºåˆ¶ï¼Œç›¸å½“äºæ˜¯åšç”³è¯·æ³¨å†Œã€‚ @<code>SPI</code> æ ‡æ˜å½“å‰ç±»ä¸º<code>SPI</code>åŠŸèƒ½æ‰©å±•ç±»ã€‚</p><p>Fig 1 classes in the <strong><em>shenyu-spi</em></strong></p><p><img alt="toplevel-SPI" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASkAAACeCAYAAABuIfz7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAABX0SURBVHhe7Z39kxXVmcf5l1L70/y2STbRaLTKJEQoeTFBBtYkG8iS2ggoiChCcBCFlEQriElF0RWoiplaYGCDMRiRXQEtglNmABdKN1izI+iaicBJP6fP6T4vz+nue29f7pnu78c65b3d5637nudzTx/udM8SAAAQMZAUACBqICkAQNRAUgCAqBmYpM5f/FCcfu+slcbPvi8uf/KpygEAAAOU1KvHTog9+3/npX0HjkhZge4ZHZ4lZg2Pqnc3hkG0GRvyHAyNiHH1HtQDK6kXXnhB7N69W0xMTKgtNpOTk2LPnj0yH6VuCElKpzN/Pqdygk6BpAbBuBgZgqT6ASspElRIVK6g+iWpKonqAD6QFGgSrKRITJyoXEG98cYbMnUDJNU/ICnQJIJrUq6oTp065Qnq+vXrMnVD3yU1PiKGZiWBYyQ3hmRgJdPz0ZGhNI85VR8dtsoOjYym0/nCQFRT/qzcsDBz6/bG3b55dRbXkzIqhs06jL5rYYzr4wrV4faj9FLFbtPsdj1tquMuqCc7h+q9Rm9/V/VxaMTOESqXU3JsVLbkcytvA3RD4cK5KSozaUH1giup3xx+TZy78IH4+Mon8v+vHP6DtZ9LQUkpwVhjSA0wc/DKQcUMNh0g3kBl8pqMjwyLvHp/jSKrwxzIeuAb9ZbVo4/PCsSknsSjEt1Ovl8FoFfHUHE7Fn7wj474x9Zbm+o9V48+P14dRJonzeL3k5D96/HYrPLM51bcBuiWQkkRrqjqEBThSuri/15Se1IufvgXaz+XeEnxg5RI5eN8K3vf9qHyKoAKJOUhA6qsPb9fHlY95f3ggsVuI63Dq0IGnisAhQrKULP1tKmOrUI91udjnZ8uJFXl2LL6c9jxBEnVTqmkCC2qugRFuJL6/OpVtSfl88+vWvu5xEqqaMA538LsoAqWL5cDkQ5oM1UYxMzsIFhPSUARsqyTwQooVYddf574utXxUx7mGOppkz/Hrgzk+6wPrrS6mUlVOLYKn1txG6BbKkmqH7iSmpz6WO1Joffmfi7FJak0OMxgStvL31cb7CX11CipojqCmLIxjqWeNqtJKq1LnS/ztaQbSSmKjq30c6vYBuiYaCQ19oc3xZVP/1/uo//Te3M/l1hJBQYp4Q52flCFyit5hKLMGbAE254ZbAqrH6X1hI9PI+srDPTyOkqR/cylU0+bFSWl8lFdcp/1GfJ18J91AO7Yyj435j2oh2gkpRMtoHPbucRLSg9q51vbGXhEaFClg9IWRbotSVkFjrTc+rNv5Xxw+3UkuOUq1BM6Pv1etmPt1GVK6qC2sg3O8SX7hu0TkpR3ZhE9t1lVUgnU/lByzEl+J3vaFzO/Oqf5Z93FsZn5CVWnvclsA9RFdJLqJIUkJdEDM0u2dIiiQZUNTJWGR90A8gNKB6FMVK/sQx4sur3sJw9Z3SqDoqweiXt8RiWyHadSLtCtdihZ58I/PvucMBLvQ5sEV0/SYioabzuh6tFtJPXpc5+21cWxVfjc7DZAXTRXUrXDB1AnYBDXSe+fR1XwuQ2WgUlq6vIn4tLk//WUqI4bhrrs6iUmMNhrRH4e/uy4H+BzGywDk1TM0OWFvcCrLi16HKgY7PUhz+UNmEUR+NwGCyQVQA5MY/2hjoDAYO+dbE3rBp5HfG6DBZICAEQNJAUAiBpICgAQNZAUACBqICkAQNRAUgCAqIGkAABRA0kBAKKmdZL627VpcXbqjDh64aA4dH6fTPSattE+AEBctEZS15P/3rn0pnj+9Hax6+0RNtE+ykN5AQBx0ApJTV/9q9g/8RIrJi5RXirTVCbunyWemjsiJtV7AGKm8ZKiWVEngtKJyhTNqCZ3Dokd/zDLS2NHVIZoGRfH5/ZPUjP3vIBYabyk6PKNk1CVRGVDUDD2FuijYuwLzQteeV6+MCz4B/TXQTPPGwjTaEnRQnhoDWrJ2rvEwhXflIlec3mobGgxHZLigaRA3TRaUmen3mXlQ2nL/gfEvGV3yESvuTyUqA6OIknRPv8SJw2up+4fzfab6aWdxo1Azo6Il5K8ep/djrpcc+rxxZC2p/ebfWHXpJw23TJV25XnpVBSaT2h8il233VfOz1vlFyZ6WOfUHXR65OBNTqs3cVBoyX1+sUxVjw63bt+gUzcPp2oDg4ZjAUD2B7geYDnBGYER4aTwB0Sx8+q994aUh7keYDmAjTfmwE8sTPvqxd8SZteQKuAz+uo0m65pCZ3DhccW4Lqiyuf41nfwuet/BjSY6d81mfhnXMi0A644TRaUofO7WPFo1MVSVEdHNy3uh2cuSj4wOWCIA1aLzBksOkgYgI7wWpDBWcowGxJ5f10sftdoV31vvi8OEhBOG1YMnfhzlvVY1DH7vUnbdcqb/ULDBJIqgdJuQHroWThf0sTTLCp/G6Q65Tm5QOZEwqV4fpoSapIaNYMo0q7/nsOPZvRKctfIteU8HkrPwZX0Dn258lICwwMXO6VSKrbyz1Jl5IqDtJqspCo+lxZDU5S6TFb+80ZS6Xj74+k0jpUPvM1GDitXTh//MCabOGcXnN5KHWzcJ6SfxvzeZlgU9uKv8E7kJQmCVQSlW7LDtRwm3adNUjKEQZh569y/J2dN7c/QUmVfl5gUDRaUoP8CYIdDFyA84FF9ZpCkdA3e1a2giyS/GNmvSWzCbZNR2x1ScqqU82A3PJcX/L3HZw37xiKJJVA52lu0lZynFY9YKA0WlJEP3/MSQHgJgpiGQju5YIOSDPIVRBRMoPOrdsOqmqyoD5k5Z2+sIFq9IUrU4ukEsxjk30gMbj53b44bYbOW/kxlEhKCbCo/+DG03hJ9evPYkAT4UUMBkvjJUXgD4xBJbBgHiWtkBRBsyK6fAutUVGifZQHM6h2Ii8FMYuKjtZISkML4bjpHTDR62ThtSowSFonKQDAzAKSAgBEDSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKhpvKQuf/KpOHz0uNj18m/Fq8feUlsBADOFRkvqg798JJ7bMyp+/vw+mXa/clBMX7su/jQ1LQ5cuCL2nr8sE72mbbQPABAXjZUUzaBMQVHad/SE2HZ6Umx++yM20b5jlz7DH8UAEBGNlRRd4pmCembvfvHYiQ9ZObnpxYmPxWdXr6mamkfx7UpmMriLQRNprKR2vZzPop7Zs19s+a//EVv++OeORFU0ozLvi2Sm+G+WpgK5T5Iqu59Uf4GkmkhjJfXqsRNi9ytj8hKPxESC+vmLvxFPHvpvVkpcoku/EDIYewp07ja4Mx9ICtRNoxfOaSFcr0GRqEhQO/79P+Tr5b/eLxasf0LMXrFWfGfTDrHm8DuepKhsaDEdkuKBpEDdNFpSZ6amPfE89tYHYtFDj4ub5i8Wdz/6M7HkyV+KOSsfEbct/ZHYyFwKUh0cRZKiff6ln7o1bRJAer+ZrNvgqlsN6312O3kgmvX4Ykjb0/vNvrBrUk6bbpmq7crzUiap0raItL1QOxLvNsMjvKQKz2d+PsynGnf/5QPqptGSOnjxiiedZb8aFTcvXCLWH33P2r4pkZf5Xieqg0MGY8FgtkXAfcMHZlLynt/m3SFVWacuCqZcbLkAzfem+GJ5gnG1tqieak86Nuuh46Jt1nkuPZ+BciAaGi2pvecue9KZ/+AWOYNyt4cS1cFhziZ0soMzFwUfuJyk0gDyxCWDWAcaE7AJVhsq6L16FLakfKFp7H5XaJd5b1O1LQYpG70/VI/qYyabKudTnY+itsFAaaekNmz3todSkaTcgPVQsuCeWsJKSuV35adTmtcNxBROKFSG66MlqSKhWbOQKu2WyKZyWyl6hqNTVm+wHqePlc6nK20QG+283FswLNb9ftzavmbspPVep24v9yQqSDqVFBvEGdVkITGC1Oxr/JJKz41VjzmTCtbDS6r4fEJSsdO6hfPNpy6JOas2iJvm3SNoRjW8dZf4xvLV4ub5i8WGY+97+btZOE9JAya73PPyMpIKXsaYdCApTRLg4ZlDuE27zhokVbUtZlZl1xuqJ92e97HK+YSkYqfRkjJ/gmClRFQ0o5q3dkTMue9hsXjrs+Kh1+yZFaVefoJgD3wuwPkAonpNoUhoRpCVrSCLJH+UTzBOqNSW+17NiMx65TE4IqNtVM7sI9uedT4hqdhptKQI+kGmK5+qqezHnDT43UQBwgVQFmhmkKtgpGTKyq3bDqBqstABK8szwewFpdEXrkwnkjLryeoLHLfc57Vl1yP7mpRx5WceI6WxI+E+mvncY4ek4qbxkqJ5EP2JCyeholT2ZzEAgBtD4yVF0B8LdyKqpv+BMQAziVZIiqBZEV2+sWtUKtE+3KoFgLhojaQ0tBCOm94BMHNonaQAADMLSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCiBpICAERN6yT1t2vT4uzUGXH0wkFx6Pw+meg1baN9AIC4aI2krif/vXPpTfH86e1i19sjbKJ9lIfyAgDioBWSmr76V7F/4iVWTFyivFSmn+D2IABUo/GSollRJ4LSicqUz6j4+xeVo8pBUgCU0nhJ0eWbKZ9nT42INc8tEwtWfEvcftc/iVvnfEl8e+nXxfKRe8TTxx618lLZYrqVFACgKo2WFC2Em2tQO08+JhatvFPMufc28dDuFeIXb22W27f9bp249+GFYvbiW8VTr2/I8lPZ4sV0SAqAftNoSZ2dejcTDqVVz3xfzF5yq3jmzY3JrGmjWL3zX8SKbUvEfTvuFTuOPiLuWT1X/GDj3VYZqiNMQFLqVsHmLWute2wn2GtSeT3WbXML7hUOQFtotKRevzhmCeeuZXdIUe1441HxzUVfE8s2f1ds2PMTccudXxI/fWWlfE3bzTJURxhGUu5DBAglLfM+5pykqFyex33yCQDtpNGSOnRunyWc2+d/VWz+7Sqx5rkfijv/+Ta5jS4Bb/n2F8XI/gfE4wfWSGGZZaiOMK6kwo9Qch9YwM6knIV0twwAbaRdkpr3FSmjnySXdwtXfEtu2/bqevG12f8onvjPdWLd8//qzaQ6kpSaMbmXdhL5tJP8qSihyz0TSAqAll3uzf3e7eL+XT+UM6avz/2yvPRbtGqOuH3BV8XSdfPE7OFbxY+fXGKVqXK5l82cICkAaqdVC+ckoHnL75A/Q6AZ1Y+3LxWPvPxvciF9ZSIs+hc/2meWKV44Ty/vcin1eLkHSQHg0WhJuT9BePr4JrkWtfj+uWLr4QflNlqTeiJ5TQvnOp9OZT9B4CRC27yFc2YxHZICoBqNlhTh/pjz6WTWtOyxRfIHnLQWdcudX5SXgat/8QMrHyX+x5ypUNKfCPhP3pUoKenE5YOkAKhG4yXV3z+LAQD0m8ZLiojxD4wBANVohaQImhXR5Zu5RuUm2kd5MIMCIB5aIykNLYTjpncAzBxaJykAwMwCkgIARA0kBQCIGkgKABA1kBQAIGogKQBA1EBSAICogaQAAFEDSQEAoqZ1ksIvzgGYWbRGUvjbPQBmJq2QFO6CAMDMpfGSollRJ4LSicqUzqjcm9tlN7FL0XfpLMpj3/wOAODSeEnR5Zspn7oes87eNTORlnl/c5nHEpC6A6exDZICoJhGS4oWws01qPoesx5+4IKJL6kE54kykBQAxTRaUv17zHq1pwuzknKeMANJAVBMoyXVz8esk1zkGlOBqMIzqdDz9wAALo2WVL8fs04SyhbEGVn5kvJnYJAUAMW0S1K1P2Y9JZtVOY+uMiWmk7uOBUkBUEyrLvfqf8y6ifqXO+Nf/Pg1KRtICoBiWrVwXv9j1h2ODENSANRMoyXl/gShvses09qS+1Ri/ynEkBQAvdNoSRHujzl7f8y6Jl0EL1pvgqQA6J3GS6qvfxYDAOg7jZcUgT8wBmDm0gpJETQross3c43KTbSP8mAGBUA8tEZSGloIx03vAJg5tE5SAICZBSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCipnWSmr52XfxpalocuHBF7D1/WSZ6TdtoHwAgLlojKdLPsUufiW2nJ8Xmtz9iE+2jPFAVAPHQCkl9dvWaeHHiY1ZMXKK8VOZG0aTbteDWM6BuGi8pmhV1IiidqEzpjKrkCcbV8B8Yyt0bnZJ+DFa8+MdSJzP3vIBeaLyk6PKNk1CVRGVDyBvalTzBuFuq3CyvGPvZfk2BPee10szzNtNptKRoITy0BrX81/vFgvVPiNkr1orvbNoh1hx+x8tDZakOn3Qw1yEkDkiKB5JqJ42W1JmpaU88m09dEnc98FNx0/zF4u5HfyaWPPlLMWflI+K2pT8SG0986OWnOnzSwVz2BONsfUY9Wl1fnrjl3HWcIknRPv8SJ++P3m8mS6ZuX6x28vu0m/X4Ykjb0/vNvrBrUk6bbpmq7crzUiiptJ5Q+RS777qvnZ43Sq7M9LFPqLro9cnAGh3W7qrTaEkdvHjFk86yX42KmxcuEeuPvmdt3/TWB9Z7nagODhpkciAWiCrLYw5GNdjNcu6AlcFYMIDt/HmA5wRmBPJpNuYDJNw1pDzI8wB1hZy+NwN4YmfeVy/41Lqd1Rd1DvI6qrRbLqnJncMFx5ag+uLK53jWt/B5Kz8G4/M2PwvvnBOBdgBLoyW199xlTzrzH9wiZ1Du9lCiOkJY3/qWJFJkwDJB5QYbJyldb1a/VU8uCj5wuSBIg9YLDBlsOoiYwE6w2lDBGQow+1jyfrrY/a7QrnpffF4cpCCcNpjPKYc7b1WPIfR5p+1a5a1+gTLaKakN273toVQkKU32Dep8Y7ryyXC+XTlJseVMlCz8b2mCCTaV3w1yndK8fCBzQqEyXB+tYykSmnUOqrTrv+fQn4VOWf4SuaaEz1v5MYQ/b/vzZKQFCmnn5d6CYbHu9+PW9jVjJ633OoUu93xUoBlBFKOkioO0miwkqj5XVoOTVHrM1n7Zhnpf6fj7I6m0DpXPfA0q0cqF8zmrNoib5t0jaEY1vHWX+Mby1eLm+YvFhmPve/n5hfMAZlAkyEHLBJU7mDuXVP5tzOdlgk1tK/4G70BSmuSYSVS6LftYwm3addYgKUcYhJ2/yvF3dt7c/gQlVfp5gSIaLangTxASUdGMat7aETHnvofF4q3Piodes2dWlIp/guB+G/qBRoNWzjTM4HOCmuhUUnZ+LsD5wKJ63bblN3tWtoIskvxjZr0lswm2Te8c1CMpq041A3LLc33J33dw3ip8jhZ0nuYmbSXHadUDSmm0pIh+/ZhTD2gaqDq5g1sPWv1P0jq5gzQU2G6iIJZ5XUHqgDSDXAURJbNfbt12UFWTBfUhK+/0hQ1Uoy9cmVoklWAem+wDicHN7/bFaTN03sqPoURSarwU9R/wNF5Sff2zmBKKBy1oF7yIQTmNlxQxqD8whqRABhbMu6YVkiJoVkSXb6E/k6FE+yhPrzMoDSQFNHIsYBbVFa2RlIYWwm/UTe8gKaDXyTAOuqd1kgIAzCwgKQBA1EBSAICogaQAAFEDSQEAogaSAgBEjBB/B3o1C04w+m2JAAAAAElFTkSuQmCC"></p><p>é…ç½®æ–‡ä»¶æ–¹é¢ï¼Œå®šä¹‰<code>SPI</code>åŠ è½½çš„ç›®å½•ä¸º <code>META-INF/shenyu/</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šæ‰«æ <code>SHENYU_DIRECTORY</code> ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ç”± <code>ExtensionLoader</code> ç±»æ¥åŠ è½½æ‰€é…ç½®çš„<code>SPI</code>æ‰©å±•ç±»ï¼Œå¹¶cacheåˆ°å†…å­˜ä¸­ã€‚  é…ç½®æ–‡ä»¶å†…å®¹ä¸º key=classçš„å½¢å¼ã€‚ åœ¨ç³»ç»Ÿæ‰§è¡ŒæœŸé—´ï¼Œ ç”±<code>ExtensionFactory</code>çš„å®ç°ç±»ï¼Œè¿”å›keyæ‰€å¯¹åº”çš„<code>SPI</code>å®ç°ç±»ã€‚ </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-pluginçš„spi-å®ç°"></a>shenyu-pluginçš„<code>SPI</code> å®ç°<a class="hash-link" href="#shenyu-pluginçš„spi-å®ç°" title="Direct link to heading">#</a></h2><p>åœ¨<strong><em>shenyu-plugin</em></strong>æ¨¡ç»„ä¸­ï¼ŒæŒ‰ç…§æ’ä»¶æœºåˆ¶ï¼Œå®ç°äº†å„ç§è¯·æ±‚è½¬å‘åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ”¯æŒrequest, redirect, response, rewriteç­‰httpåè®®åŠŸèƒ½ï¼ŒåŠ gRPC, dubbo, hystrixç­‰å¾®æœåŠ¡æ¡†æ¶ï¼Œ å¹¶ä¸”æ’ä»¶åŠŸèƒ½è¿˜åœ¨ä¸æ–­å¢åŠ ä¸­ã€‚å¦‚æœåœ¨å„è‡ªçš„åŠŸèƒ½æ’ä»¶å®åšç±»ä¸­ï¼Œè¿˜è¦åšå¯¹routing å‚æ•°çš„è§£æç­‰å¤„ç†ï¼Œä¸ä»…ä¼šé€ æˆç¨‹åºçš„å†—ä½™ï¼Œè€Œä¸”å½“è¦æ”¯æŒå„è‡ªåŒ¹é…è§„åˆ™ï¼Œå¦‚é€šé…ç¬¦ã€æ­£åˆ™è¡¨è¾¾å¼ã€SpELè§£æç­‰ï¼Œä¼šé€ æˆé¢‘ç¹å¯¹æ’ä»¶æ ¸å¿ƒä»£ç çš„ä¿®æ”¹ã€‚å› æ­¤ï¼Œåœ¨<strong><em>shenyu-plugin</em></strong>æ¨¡ç»„ä¸­ï¼Œå°†routingå‚æ•°è§£æåšäº†æ›´é«˜ä¸€å±‚çš„æŠ½è±¡ï¼Œå¹¶æŒ‰ç…§<code>SPI</code>æœºåˆ¶åšäº†è§„åˆ™è§£æçš„å®ç°ã€‚è§£æç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ul><li><p><code>ParameterData</code>-å‚æ•°èµ„æ–™,  </p></li><li><p><code>PredictJudge</code>-æ–­è¨€</p></li><li><p><code>MatchStrategy</code>-åŒ¹é…ç­–ç•¥ä¸‰ä¸ª<code>SPI</code>å®ç°ã€‚</p><p>è¿™äº›æ‰©å±•ç±»å®šä¹‰åœ¨ <strong><em>shenyu-plugin-base</em></strong> moduleä¸­ï¼Œç»è¿‡è¿™æ ·æŠ½è±¡åï¼Œæ¯ä¸ªæ’ä»¶å®ç°ä¸­ï¼Œrouting å‚æ•°è§£æçš„åŠŸèƒ½å…¨éƒ¨ç”±AbstractShenyuPlugin æ¥è°ƒç”¨ä¸Šè¿°ä¸‰ä¸ª<code>SPI</code>å·¥å‚ç±»æ¥å®šä¹‰å’Œå®ç°ã€‚åšåˆ°äº†åŠŸèƒ½çš„ä¸“ä¸€ï¼Œå¹¶æ˜“äºæ‰©å±•ï¼Œç¬¦åˆSOLIDåŸåˆ™ã€‚</p></li></ul><p>æœ¬èŠ‚å°±å…¶ä¸­çš„<code>PredictJudge</code>-æ–­è¨€åšè¯¦ç»†è§£æã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªmoduleä¸­çš„pomæ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº†å¯¹<strong><em>shenyu-<code>SPI</code></em></strong>çš„ä¾èµ–</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge-spi-è®¾è®¡"></a>PredicateJudge <code>SPI</code> è®¾è®¡<a class="hash-link" href="#predicatejudge-spi-è®¾è®¡" title="Direct link to heading">#</a></h3><p>PredicateJudge <code>SPI</code> å®ç°ç”¨æ¥è§£æåˆ¤æ–­å„ç±»è§„åˆ™ï¼Œå½“ç½‘å…³ä¸­é…ç½®çš„ã€‚è¿™ä¸ªç±»å‘½åå’ŒåŠŸèƒ½éƒ½ç±»ä¼¼äºjava çš„<a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener noreferrer">Predicate</a>  ï¼Œä½†å¯¹æ¥å—è¡Œä¸ºåšäº†æ›´è¿›ä¸€æ­¥çš„æŠ½è±¡ã€‚è¿™ä¸ª<code>SPI</code>é€šè¿‡ä¸€ä¸ªå·¥å‚å’Œç­–ç•¥æ¨¡å¼å®ç°ï¼Œé¦–å…ˆæ¥çœ‹<code>PredicateJudge</code> <code>SPI</code>æ¥å£çš„å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@FunctionalInterface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PredicateJudge {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * judge conditionData and realData is match.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param conditionData {@linkplain ConditionData}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param realData       realData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true is pass  false is not pass.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean judge(ConditionData conditionData, String realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™éƒ¨åˆ†çš„ç±»å›¾å¦‚ä¸‹ï¼š</p><p>Fig 2-Predicate class diagram</p><p><img alt="predicate-class-diagram" src="/zh/assets/images/predicate-class-diagram-67a93b8c3e49800b23fe717c22027c54.png"></p><p><code>PredicateJudgeFactory</code>çš„é‡è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static PredicateJudge newInstance(final String operator) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(PredicateJudge.class).getJoin(processSpecialOperator(operator));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static Boolean judge(final ConditionData conditionData, final String realData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(conditionData) || StringUtils.isBlank(realData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(conditionData.getOperator()).judge(conditionData, realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œ<code>ConditionData</code>å®šä¹‰å¦‚ä¸‹åŒ…å«å±æ€§å››ä¸ªStringç±»å‹çš„å±æ€§ï¼š <code>paramType, operator,paramName,paramValue</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="paramtypeenum"></a>ParamTypeEnum<a class="hash-link" href="#paramtypeenum" title="Direct link to heading">#</a></h4><p>å‚æ•° <code>paramType</code>å¿…é¡»ä¸ºç³»ç»Ÿä¸­æšä¸¾ç±»å‹ <code>ParamTypeEnum</code>ï¼Œé»˜è®¤æ”¯æŒçš„<code>paramType</code>æœ‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">post, uri,query, host, ip,header, cookie,req_method</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="operatorenum"></a>OperatorEnum<a class="hash-link" href="#operatorenum" title="Direct link to heading">#</a></h4><p> <code>operator</code> å¿…é¡»ä¸ºæšä¸¾ç±»å‹ <code>OperatorEnum</code> ï¼Œç›®å‰æ”¯æŒçš„æ“ä½œç¬¦æœ‰ï¼šï¼ˆæ³¨æ„ï¼Œä¸¥æ ¼åŒºåˆ†å¤§å°å†™)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   match, =,regex, &gt;,&lt;, contains, SpEL,  Groovy, TimeBefore,TimeAfter</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŸºäºä»¥ä¸Šçš„è§„åˆ™, plugin æ¨¡ç»„å®ç°äº†å¦‚ä¸‹8ä¸ª <code>PredicateJudge</code> å®ç°ç±»ï¼Œåˆ†åˆ«å®ç°ä¸Šè¿°operatorçš„é€»è¾‘åŒ¹é…è§„åˆ™.</p><table><thead><tr><th>Implementation class</th><th>Rule denotes è§„åˆ™è¯´æ˜</th><th>corespondece operator</th></tr></thead><tbody><tr><td><code>ContainsPredicateJudge</code></td><td>åŒ…å«å…³ç³» &quot;contains&quot;ï¼Œ å®é™…ç»“æœï¼Œéœ€è¦åŒ…å«æ‰€å®šè§„åˆ™çš„å€¼</td><td>contains</td></tr><tr><td><code>EqualsPredicateJudge</code></td><td>ç›¸ç­‰&quot;=&quot;ï¼Œ</td><td>=</td></tr><tr><td><code>MatchPredicateJudge</code></td><td>ç”¨äºURI è·¯å¾„åŒ¹é…çš„å¤„ç†</td><td>match</td></tr><tr><td><code>TimerAfterPredicateJudge</code></td><td>å½“å‰localæ—¶é—´æ˜¯å¦æ™šäºè®¾å®šçš„æ—¶é—´</td><td>TimeAfter</td></tr><tr><td><code>TimerBeforePredicateJudge</code></td><td>å½“å‰localæ—¶é—´æ˜¯å¦æ—©äºè®¾å®šçš„æ—¶é—´</td><td>TimeBefore</td></tr><tr><td><code>GroovyPredicateJudge</code></td><td>Groovy,è®¾å®šParamNameçš„å€¼ï¼Œä¸è®¾å®šParamValueç›¸åŒ</td><td>Groovy</td></tr><tr><td><code>RegexPredicateJudge</code></td><td>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…èµ„æ–™</td><td>regex</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è°ƒç”¨æ–¹æ³•"></a>è°ƒç”¨æ–¹æ³•<a class="hash-link" href="#è°ƒç”¨æ–¹æ³•" title="Direct link to heading">#</a></h3><p>å½“è¦åšä¸€ç»„å‚æ•°çš„è§£ææ—¶ï¼Œåªéœ€è¦è°ƒç”¨<code>PredicateJudgeFactory</code>çš„judgeæ–¹æ³•å³å¯ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">PredicateJudgeFactory.judge(final ConditionData conditionData, final String realData);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spié…ç½®æ–‡ä»¶"></a><code>SPI</code>é…ç½®æ–‡ä»¶<a class="hash-link" href="#spié…ç½®æ–‡ä»¶" title="Direct link to heading">#</a></h3><p>è¿™äº›<code>PredicateJudge</code>å®ç°ç±»åœ¨  <code>SHENYU_DIRECTORY</code> ä¸­çš„configæ–‡ä»¶ä¸­åšäº†é…ç½®ï¼Œåœ¨å¯åŠ¨æ—¶ä¼šåŠ åŠ è½½å¹¶cacheåˆ°å†…å­˜ä¸­ã€‚</p><p><code>PredicateJudge</code>æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸ºkey=classå½¢å¼ï¼Œå·¦è¾¹çš„operatorè¦å’Œ<code>ParamEnum</code>ä¸­çš„å®šä¹‰ä¸€è‡´ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">equals=org.apache.shenyu.plugin.base.condition.judge.EqualsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">contains=org.apache.shenyu.plugin.base.condition.judge.ContainsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Groovy=org.apache.shenyu.plugin.base.condition.judge.GroovyPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">match=org.apache.shenyu.plugin.base.condition.judge.MatchPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">regex=org.apache.shenyu.plugin.base.condition.judge.RegexPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SpEL=org.apache.shenyu.plugin.base.condition.judge.SpELPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeAfter=org.apache.shenyu.plugin.base.condition.judge.TimerAfterPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeBefore=org.apache.shenyu.plugin.base.condition.judge.TimerBeforePredicateJudge</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge-spiåœ¨ç½‘å…³pluginä¸­çš„ä½¿ç”¨"></a>PredicateJudge <code>SPI</code>åœ¨ç½‘å…³Pluginä¸­çš„ä½¿ç”¨<a class="hash-link" href="#predicatejudge-spiåœ¨ç½‘å…³pluginä¸­çš„ä½¿ç”¨" title="Direct link to heading">#</a></h2><p>ç½‘å…³ç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨åˆ†çš„Plugin éƒ½ç»§æ‰¿è‡ª<code>AbstractShenyuPlugin</code>ï¼Œè¿™ä¸ªæŠ½è±¡ç±»ä¸­ï¼Œåœ¨åšé€‰æ‹©å’Œè§„åˆ™è§£ææ—¶ï¼Œè°ƒç”¨äº†ä¸Šè¿°<code>SPI</code>ä¸­çš„<code>MatchStrategy</code>ï¼Œç»§è€Œåœ¨ç­–ç•¥åˆ¤æ–­æ—¶è°ƒç”¨<code>PredicateJudge</code> çš„å„ä¸ªæ–­è¨€ç±»æ¥å¤„ç†ã€‚</p><p>Pluginä¸<code>SPI</code> çš„ç±»å›¾å¦‚ä¸‹:</p><p>Fig 3- class diagram of plugins with PredicateJudge and <code>MatchStrategy</code> <code>SPI</code></p><p><img alt="plugin-SPI-class-diagram" src="/zh/assets/images/plugin-SPI-class-diagram-fa432591b833ff178cb662ce352f5b23.png"></p><p>ä»å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ï¼Œåœ¨ç³»ç»Ÿä¸­è°ƒç”¨è§„åˆ™éƒ¨åˆ†çš„<code>SPI</code>çš„æµç¨‹å¦‚ä¸‹ï¼š</p><p>Fig 4- flow chart for Shenyu gateway filter  with parameter processing</p><p><img alt="SPI-flow-diagram" src="/zh/assets/images/SPI-flow-diagram-590f2cd298ae7655330a62a2010b006e.png"></p><ul><li>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šåŠ è½½ç›®å½•ä¸‹é…ç½®çš„<code>SPI</code>èµ„æ–™åˆ°å†…å­˜ä¸­</li><li>å½“clientæœ‰æ–°çš„è¯·æ±‚å‘åˆ°Apache shenyu ç½‘å…³ç³»ç»Ÿæ—¶ï¼Œåœ¨ç½‘å…³å†…éƒ¨ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„plugin</li><li>å¯¹å®é™…è¯·æ±‚èµ„æ–™åšè§„åˆ™åŒ¹é…æ—¶ï¼Œä¼šæ ¹æ®æ‰€åŒ…å«çš„operator,è°ƒç”¨çš„å¯¹åº”çš„PredicateJudgeå®ç°ç±»</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å…¶ä»–"></a>å…¶ä»–<a class="hash-link" href="#å…¶ä»–" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge--åˆ¤æ–­ç»“æœä¸¾ä¾‹"></a>PredicateJudge  åˆ¤æ–­ç»“æœä¸¾ä¾‹<a class="hash-link" href="#predicatejudge--åˆ¤æ–­ç»“æœä¸¾ä¾‹" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="containspredicatejudge---contains-rule"></a>ContainsPredicateJudge- &quot; containsâ€œ rule<a class="hash-link" href="#containspredicatejudge---contains-rule" title="Direct link to heading">#</a></h4><p> ä¸¾ä¾‹ï¼šç»™å®šä¸€ç»„å‚æ•°ï¼ˆConditionData ï¼‰ï¼Œ paramType=&quot;uri&quot;, paramValue æ˜¯ &quot;/http/**&quot;</p><p>å½“åº”ç”¨ ContainsPredicateJudgeåŒ…å«å…³ç³»æ—¶ï¼Œåˆ¤æ–­ç»“æœå¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>ConditionData  (operator=&quot;contains&quot;)</th><th>real data</th><th>judge result</th></tr></thead><tbody><tr><td>paramType=&quot;uri&quot;,    &quot;/http/**&quot;</td><td>&quot;/http/**/test&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/test/http/**/other&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/http1/**&quot;</td><td>false</td></tr></tbody></table><p>å…¶ä»–çš„å‡ ä¸ªPredicateJudgeçš„å…·ä½“åŠŸèƒ½å¯å‚è€ƒå…¶ä»£ç å’Œæµ‹è¯•ç±».</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI ä»£ç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T06:06:58.415Z">2023å¹´8æœˆ15æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>é™æµæ˜¯ç½‘å…³å¿…å¤‡çš„åŠŸèƒ½ï¼Œç”¨æ¥åº”å¯¹é«˜å¹¶å‘è¯·æ±‚çš„åœºæ™¯ã€‚å½“ç³»ç»Ÿå—åˆ°å¼‚å¸¸æ”»å‡»ï¼ŒçŸ­æœŸå†…èšé›†äº†å¤§é‡çš„æµé‡ï¼›å½“æœ‰å¤§é‡ä½çº§åˆ«çš„è¯·æ±‚ï¼Œå¤„ç†è¿™äº›è¯·æ±‚ä¼šå½±å“å…³é”®ä¸šåŠ¡çš„å¤„ç†ï¼Œéœ€è¦é™åˆ¶è¿™äº›è¯·æ±‚çš„è®¿é—®é€Ÿåº¦; æˆ–è€…ç³»ç»Ÿå†…éƒ¨å‡ºç°ä¸€äº›å¼‚å¸¸ï¼Œä¸èƒ½æ»¡è´Ÿè·çš„æœåŠ¡æ•´ä¸ªåº”ç”¨è¯·æ±‚ç­‰ç­‰ã€‚è¿™äº›æƒ…å†µä¸‹ï¼Œéƒ½éœ€è¦å¯ç”¨é™æµæ¥ä¿æŠ¤ç³»ç»Ÿã€‚å¯ä»¥æ‹’ç»æœåŠ¡ã€ç­‰å¾…æˆ–é™çº§å¤„ç†ï¼Œå°†æµé‡é™åˆ¶åˆ°ç³»ç»Ÿå¯æ¥å—çš„é‡ï¼Œæˆ–è€…åªå…è®¸æŸäº›åŸŸå(æˆ–æŸäº›ä¸šåŠ¡)çš„è¯·æ±‚ä¼˜å…ˆå¤„ç†ã€‚</p><p>   é’ˆå¯¹ä»¥ä¸Šçš„åœºæ™¯éœ€æ±‚ï¼Œåœ¨è®¾è®¡ä¸€ä¸ª<code>API</code>ç½‘å…³çš„é™æµåŠŸèƒ½æ—¶ï¼Œå°±éœ€è¦è€ƒè™‘å¦‚ä¸‹çš„æ‰©å±•ç‚¹ï¼š</p><ol><li><p>å¯ä»¥æ”¯æŒå¤šç§é™æµçš„ç®—æ³•ï¼Œå¹¶æ˜“äºæ‰©å±•ã€‚</p></li><li><p>è¦å¯ä»¥æ”¯æŒå¤šç§é™æµçš„æ–¹å¼ï¼Œèƒ½åŒºåˆ†ç”¨æˆ·ç¾¤ã€é«˜ä½ä¼˜å…ˆçº§çš„è¯·æ±‚ã€‚</p></li><li><p>è¦æ”¯æŒé«˜å¹¶å‘ï¼Œèƒ½å¿«é€Ÿçš„åšå‡ºé™åˆ¶æˆ–é€šè¿‡çš„å†³ç­–ã€‚</p></li><li><p>è¦æœ‰å®¹é”™å¤„ç†ï¼Œå¦‚æœé™æµç¨‹åºå‡ºé”™ï¼Œç½‘å…³ç³»ç»Ÿèƒ½ç»§ç»­æ‰§è¡Œã€‚</p><p>æœ¬æ–‡ä¼šå…ˆä»‹ç»shenyuç½‘å…³é™æµéƒ¨åˆ†çš„æ€»ä½“æŠ€æœ¯æ¶æ„ï¼Œä¹‹åé‡ç‚¹åˆ†æ<code>RateLimiter</code> SPIæ‰©å±•å®ç°çš„ä»£ç ã€‚</p></li></ol><blockquote><p>This article based on <code>shenyu-2.4.0</code> version of the source code analysis.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiter--æ€»ä½“è®¾è®¡è¯´æ˜"></a>RateLimiter  æ€»ä½“è®¾è®¡è¯´æ˜<a class="hash-link" href="#ratelimiter--æ€»ä½“è®¾è®¡è¯´æ˜" title="Direct link to heading">#</a></h2><p>â€‹        WebFluxæ˜¯Spring æä¾›çš„åŸºäºReactoræ¨¡å‹çš„å¼‚æ­¥éé˜»å¡æ¡†æ¶ï¼Œèƒ½æå‡ååé‡ï¼Œä½¿ç³»ç»Ÿæœ‰æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ã€‚Apache Shenyuç½‘å…³çš„æ’ä»¶åŠŸèƒ½åŸºäºWebFluxæ¡†æ¶å®ç°çš„ã€‚RateLimiteråŠŸèƒ½æ˜¯åœ¨<code>ratelimiter-plugin</code>ä¸­å®ç°ã€‚åœ¨é™æµè¿‡ç¨‹ä¸­ï¼Œå¸¸ç”¨çš„ç®—æ³•æœ‰ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ç­‰ç®—æ³•ï¼Œè¿™äº›ç®—æ³•æ‰§è¡Œä¸­ï¼Œéœ€è¦æ£€æ ¸è¯·æ±‚çš„æ¥æºï¼Œå¯¹å·²ä½¿ç”¨çš„æµé‡åšè®¡æ•°åŠé€»è¾‘è®¡ç®—ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸é€šè¿‡ã€‚ä¸ºäº†æé«˜å¹¶å‘åŠæ€§èƒ½ï¼Œ å°†è®¡æ•°å’Œç®—æ³•é€»è¾‘å¤„ç†ï¼Œéƒ½æ”¾åˆ°redisä¸­ã€‚Javaä»£ç è´Ÿè´£åšæ•°æ®å‚æ•°çš„ä¼ é€’ã€‚åœ¨è°ƒç”¨redisæ—¶ï¼Œ<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">lua</a>è„šæœ¬å¯ä»¥å¸¸é©»åœ¨rediså†…å­˜ä¸­ï¼Œèƒ½å‡å°‘ç½‘ç»œå¼€é”€ï¼Œå¹¶å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œï¼Œå…·æœ‰åŸå­æ€§ã€‚<a href="https://spring.io/projects/spring-data-redis" target="_blank" rel="noopener noreferrer">Spring Data Redis</a> æä¾›äº†å¯¹<a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer">rediså‘½ä»¤</a>æ‰§è¡Œçš„æŠ½è±¡ï¼Œæ‰§è¡Œåºåˆ—åŒ–ï¼ŒåŠè‡ªåŠ¨ä½¿ç”¨redis è„šæœ¬ç¼“å­˜ã€‚åœ¨è¿™ä¸ªpluginä¸­ï¼Œç”±äºé‡‡ç”¨äº†reactor éé˜»å¡æ¡†æ¶ï¼Œæ‰€ä»¥é‡‡ç”¨Spring Redis Reactiveç±»åº“å®ç°å¯¹redisçš„åŠŸèƒ½è°ƒç”¨ã€‚</p><p>â€‹        è¿™ä¸ªpluginä¸­çš„ç±»åŒ…å›¾å¦‚ä¸‹ï¼Œé‡ç‚¹æ ‡å‡ºäº†ä¸<code>RateLimiter</code> <code>SPI</code>ç›¸å…³çš„ä¸¤ä¸ªpackage: resolver å’Œalgorithm.</p><p><img alt="ratelimiter-package-diagram" src="/zh/assets/images/ratelimiter-package-diagram-b041571cdf2f8592c23ab33bf07fbc71.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiter-spiçš„è®¾è®¡"></a>RateLimiter SPIçš„è®¾è®¡<a class="hash-link" href="#ratelimiter-spiçš„è®¾è®¡" title="Direct link to heading">#</a></h2><p>ç”±äºé‡‡ç”¨äº†Spring data+ Redis +luaæ¶æ„å®ç°äº†é«˜å¹¶å‘çš„éœ€æ±‚ã€‚ å¦‚ä½•åšåˆ°å¯¹ç®—æ³•å’Œé™æµæ–¹å¼çš„æ‰©å±•å‘¢ï¼Ÿ Shenyu ratelimiter  pluginä¸­è®¾è®¡äº†ä¸¤ä¸ªSPIæ¥å®ç°è¿™ä¸¤ä¸ªéœ€æ±‚ï¼š</p><ul><li><code>RateLimiterAlgorithm</code>ï¼šç”¨æ¥æ‰©å±•ä¸åŒçš„é™æµç®—æ³•ã€‚</li><li><code>RateLimiterKeyResolver</code>ï¼š ç”¨äºæ‰©å±•è·å–è¯·æ±‚çš„å…³é”®ä¿¡æ¯ï¼Œç”¨äºåŒºåˆ†æµé‡ï¼Œä¾‹å¦‚æŒ‰IP åœ°å€ã€æŒ‰æŸä¸€æ®µåŸŸåç­‰æ¥åŒºåˆ†è®¿é—®çš„è¯·æ±‚ã€‚</li></ul><p>SPIçš„å…·ä½“å®ä½œç±»ä¸é…ç½®ä¿¡æ¯ä½äºï¼š<code>SHENYU_DIRECTORY</code>ç›®å½•ä¸‹ (é»˜è®¤åœ¨<code>/META-INF/shenyu</code>)ä¸‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiterkeyresolver"></a>RateLimiterKeyResolver<a class="hash-link" href="#ratelimiterkeyresolver" title="Direct link to heading">#</a></h3><p>è·å–è¯·æ±‚çš„å…³é”®ä¿¡æ¯ï¼Œç”¨äºåˆ†ç»„é™æµï¼Œä¾‹å¦‚æŒ‰URL/ ç”¨æˆ· / IP ç­‰ï¼Œ <code>RateLimiterKeyResolver</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterKeyResolver {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get Key resolver&#x27;s name.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Key resolver&#x27;s name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getKeyResolverName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * resolve.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param exchange exchange the current server exchange {@linkplain ServerWebExchange}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return rate limiter key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolve(ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code>å°†å½“å‰interface æ³¨å†Œä¸ºShenyu SPI æ¥å£ã€‚resolve(ServerWebExchange exchange)æ–¹æ³•ç”¨æ¥æä¾›è§£ææ–¹å¼ã€‚</p><p>RateLimiterKeyResolver  SPI æä¾›äº†ä¸¤ç§key resolver, <code>WholeKeyResolve</code>å’Œ <code>RemoteAddrKeyResolver</code>ï¼Œå…¶ä¸­<code>RemoteAddrKeyResolver</code>ä¸­çš„<code>resolve</code>æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String resolve(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…¶keyå€¼ä¸ºè¯·æ±‚çš„IPåœ°å€ã€‚ åŸºäºSPIåŠå·¥å‚ç±»çš„å®ç°ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„æ‰©å±•å®ç°æ–°çš„key resolverï¼Œå¦‚URL,ç”¨æˆ·ç­‰ç­‰ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiteralgorithm-spi"></a>RateLimiterAlgorithm SPI<a class="hash-link" href="#ratelimiteralgorithm-spi" title="Direct link to heading">#</a></h3><p><code>RateLimiterAlgorithm</code> SPI ç”¨æ¥å®ç°å¯¹ä¸åŒé™æµç®—æ³•çš„è¯†åˆ«ã€åŠ è½½å’Œå®šä¹‰ï¼Œå…¶ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img alt="ratelimiteral-class-diagram" src="/zh/assets/images/ratelimiteral-class-diagram-24df4785848602bdc5b321cf609d5cda.png"></p><p>æœ¬æ¨¡ç»„ä½¿ç”¨äº†å·¥å‚æ¨¡å¼ï¼Œæä¾›äº†æ¥å£ç±»ã€æŠ½è±¡ç±»å’Œå·¥å‚ç±»ï¼Œæä¾›äº†4ä¸ªå®ç°ç±»ï¼Œå…¶ä¸­å®ç°ç±»å¯¹åº”çš„Luaè„šæœ¬åœ¨ <code>RateLimitEnum</code> ä¸­åšäº†å®šä¹‰ï¼Œæ”¾ç½®åœ¨ <code>/META-INF/scripts</code> ç›®å½•ä¸‹ã€‚æ¥å£<code>RateLimiterAlgorithm</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterAlgorithm&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisScript&lt;T&gt; getScript();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; getKeys(String id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param script the script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param keys the keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param scriptArgs the script args</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code> å°†è¿™ä¸ªæ¥å£æ³¨å†Œä¸ºshenyu SPI, å…¶ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>getScript()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª <code>RedisScript</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°†ä¼ é€’ç»™Redisã€‚</li><li><code>getKeys(String id)</code> è¿”å›ä¸€ä¸ªé”®å€¼çš„List.</li><li><code>callback()</code>å›è°ƒå‡½æ•°ç”¨äºå¼‚æ­¥å¤„ç†ä¸€äº›éœ€è¦åœ¨è¿”å›ååšçš„å¤„ç†ï¼Œç¼ºçœæ˜¯ç©ºæ–¹æ³•ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æŠ½è±¡ç±»-abstractratelimiteralgorithm"></a>æŠ½è±¡ç±» AbstractRateLimiterAlgorithm<a class="hash-link" href="#æŠ½è±¡ç±»-abstractratelimiteralgorithm" title="Direct link to heading">#</a></h4><p>åœ¨è¿™ä¸ªç±»ä¸­ï¼Œå®ç°äº†æ¥å£çš„æ¨¡æ¿æ–¹æ³•ï¼Œä½¿ç”¨å‚æ•°ç±»å‹ä¸º<code>List&lt;Long&gt;</code>,  æŠ½è±¡æ–¹æ³•getScriptName() å’ŒgetKeyName() ç•™ç»™å„ä¸ªå®ä½œç±»æ¥å®ç°ã€‚å¦‚ä¸‹çš„getScript() æ˜¯è¿™ä¸ªç±»ä¸­è¯»å–luaè„šæœ¬çš„å¤„ç†ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public RedisScript&lt;List&lt;Long&gt;&gt; getScript() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.initialized.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultRedisScript redisScript = new DefaultRedisScript&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String scriptPath = &quot;/META-INF/scripts/&quot; + getScriptName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(scriptPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setResultType(List.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.script = redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialized.compareAndSet(false, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return script;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AtomicBoolean</code>ç±»å‹çš„å˜é‡<code>initialized</code> ç”¨æ¥æ ‡è®°luaè„šæœ¬æ˜¯å¦æœ‰è¢«åŠ è½½ã€‚ å¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼Œå°±ä»/META-INF/scripts/ç›®å½•ä¸‹ï¼Œè¯»å–<code>scriptName</code>æŒ‡å®šçš„Luaæ–‡ä»¶ï¼ŒåŠ è½½æˆ<code>RedisScript</code>å¯¹è±¡ã€‚æŒ‡å®šç»“æœä¸º<code>List</code>ç±»å‹ï¼Œ è®¾å®šé‡<code>initialized</code>ä¸ºtrue,é¿å…é‡å¤åŠ è½½ã€‚ è¿”å› <code>RedisScript</code>å¯¹è±¡ã€‚</p><p><code>AbstractRateLimiterAlgorithm</code>ä¸­<code>getKeys()</code>çš„ä»£ç å¦‚ä¸‹ï¼Œ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String prefix = getKeyName() + &quot;.{&quot; + id;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = prefix + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestampKey = prefix + &quot;}.timestamp&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, timestampKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ¨¡æ¿æ–¹æ³•ä¸­ï¼Œäº§ç”Ÿäº†ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­ï¼Œ<code>tokenKey</code>ä¼šä½œä¸ºKeyä¼ é€’ç»™<code>redis</code>, æŒ‡å‘ä¸€ä¸ªæœ‰åºé›†åˆã€‚ <code>timestampKey</code>æ˜¯ä¸€ä¸ªä»¥ä¼ å…¥id ä¸ºè¯†åˆ«çš„å­—ç¬¦ä¸²ã€‚</p><p>å¯ä»¥ä»ä¸Šé¢çš„ç±»å›¾ä¸­çœ‹åˆ°ï¼Œ<code>ConcurrentRateLimiterAlgorithm</code> å’Œ<code>SlidingWindowRateLimiterAlgorithm</code> æœ‰è¦†å†™<code>getKeys(String id)</code>æ–¹æ³•ï¼Œè€Œä¸¤å¤–ä¸¤ä¸ªç®—æ³•ç¨‹åºï¼Œåˆ™é‡‡ç”¨çš„æ˜¯æŠ½è±¡ç±»ä¸­çš„å®ç°ã€‚ä¹Ÿåªæœ‰ <code>ConcurrentRateLimiterAlgorithm</code> é‡å†™äº†<code>callback()</code>æ–¹æ³•ã€‚ä¸‹æ–‡ä¸­æˆ‘ä»¬ä¼šå¯¹æ­¤åšè¿›ä¸€æ­¥çš„åˆ†æã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å·¥å‚ç±»ratelimiteralgorithmfactory"></a>å·¥å‚ç±»RateLimiterAlgorithmFactory<a class="hash-link" href="#å·¥å‚ç±»ratelimiteralgorithmfactory" title="Direct link to heading">#</a></h4><p><code>RateLimiterAlgorithmFactory</code> ä¸­ä¾æ®ç®—æ³•åç§°ï¼Œè·å–RateLimiterAlgorithmå®ä¾‹çš„æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static RateLimiterAlgorithm&lt;?&gt; newInstance(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Optional.ofNullable(ExtensionLoader.getExtensionLoader(RateLimiterAlgorithm.class).getJoin(name)).orElse(new TokenBucketRateLimiterAlgorithm());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æŒ‰ç…§Apache shenyu SPIçš„è§„åˆ™ï¼Œç”±åŠ è½½å™¨<code>ExtensionLoader</code>è·å¾—å®ä½œç±»ï¼Œå½“æ‰¾ä¸åˆ°ç®—æ³•æ—¶ï¼Œé»˜è®¤è¿”å›ä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ç±»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä¸redisåšèµ„æ–™äº¤äº’"></a>ä¸Redisåšèµ„æ–™äº¤äº’<a class="hash-link" href="#ä¸redisåšèµ„æ–™äº¤äº’" title="Direct link to heading">#</a></h3><p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬äº†è§£åˆ°Apache Shenyuç½‘å…³ä¸­ï¼ŒRateLimiter SPI çš„åŸºæœ¬æ‰©å±•ç‚¹ï¼Œåœ¨Shenyuç½‘å…³è¿è¡Œä¸­ï¼Œåº”ç”¨ReactiveRedisTemplate æ¥å¼‚æ­¥æ‰§è¡Œå¯¹redisçš„è°ƒç”¨å¤„ç†ã€‚å®ç°ä»£ç åœ¨RedisRateLimiterç±»çš„isAllowed()æ–¹æ³•ä¸­ï¼Œå…¶éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;RateLimiterResponse&gt; isAllowed(final String id, final RateLimiterHandle limiterHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get parameters that will pass to redis from RateLimiterHandle Object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double replenishRate = limiterHandle.getReplenishRate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double burstCapacity = limiterHandle.getBurstCapacity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double requestCount = limiterHandle.getRequestCount();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the current used RateLimiterAlgorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RateLimiterAlgorithm&lt;?&gt; rateLimiterAlgorithm = RateLimiterAlgorithmFactory.newInstance(limiterHandle.getAlgorithmName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ........</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flux&lt;List&lt;Long&gt;&gt; resultFlux = Singleton.INST.get(ReactiveRedisTemplate.class).execute(script, keys, scriptArgs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFlux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(1L, -1L)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .reduce(new ArrayList&lt;Long&gt;(), (longs, l) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    longs.addAll(l);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return longs;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).map(results -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean allowed = results.get(0) == 1L;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Long tokensLeft = results.get(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new RateLimiterResponse(allowed, tokensLeft);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(throwable -&gt; log.error(&quot;Error occurred while judging if user is allowed by RedisRateLimiter:{}&quot;, throwable.getMessage()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doFinally(signalType -&gt; rateLimiterAlgorithm.callback(script, keys, scriptArgs));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>POJO å¯¹è±¡RateLimiterHandle ä¸­ï¼Œå®šä¹‰äº†é™æµæ‰€éœ€çš„å±æ€§ç®—æ³•åç§°, é€Ÿå½•ï¼Œå®¹é‡ï¼Œè¯·æ±‚çš„æ•°é‡ ã€‚é¦–å…ˆ ä»limiterHandle åŒ…è£…ç±»ä¸­å–å¾—éœ€è¦ä¼ å…¥redisçš„å‡ ä¸ªå‚æ•°ã€‚ä¹‹åä»RateLimiterAlgorithmFactory ä»å·¥å‚ç±»å–å¾—å½“å‰é…ç½®çš„é™æµç®—æ³•ã€‚ ä¹‹ååšKeyå€¼å’Œå‚æ•°çš„ä¼ é€’ã€‚</p><p>ä¸ºäº†æ›´æ–¹ä¾¿é˜…è¯»ï¼Œä¸‹å›¾ç»™å‡ºäº†javaä»£ç ä¸redisæ‰§è¡Œå‚æ•°è¾“å…¥ã€è¾“å‡ºçš„ä¼ é€’è¿‡ç¨‹ã€‚å·¦è¾¹æ˜¯<code>isAllowed</code>() å‡½æ•°çš„ååŠéƒ¨åˆ†ä»£ç ï¼Œå³è¾¹æ˜¯ä¸€ä¸ªLuaè„šæœ¬çš„è¾“å…¥è¾“å‡ºä»£ç ã€‚</p><p>ä¸‹é¢è¯´æ˜Javaä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ol><li><p>ä»<code>getKeys()</code>æ–¹æ³•è·å¾—ä¸¤ä¸ªé”®å€¼<code>List&lt;String&gt;</code>. å…¶ä¸­ç¬¬ä¸€ä¸ªKeyä¼šæ˜ å°„ä¸ºRedisä¸­çš„æœ‰åºé›†åˆã€‚</p></li><li><p>è®¾å®š4ä¸ªå‚æ•°ï¼šé€Ÿç‡ replenishRate ,å®¹é‡ burstCapacity, æ—¶é—´æˆ³ï¼Œ è¿”å›å½“å‰java çºªå…ƒç§’æ•°(é•¿æ•´æ•°)EpochSecond, è¯·æ±‚çš„æ•°é‡ requestcount.</p></li><li><p>æŒ‰æ‰€è®¾å®šçš„è„šæœ¬ã€Keyå€¼ã€å‚æ•°è°ƒç”¨<code>ReactiveRedisTemplate</code>åŠŸèƒ½ï¼Œæ‰§è¡Œrediså¤„ç†ã€‚è¿”å›å‚æ•°æ˜¯<code>Flux&lt;List&lt;Long&gt;&gt;</code>ç±»å‹</p></li><li><p>é€šè¿‡reduceæ–¹æ³•å°†å…¶è¿”å›å€¼ä»<code>Flux&lt;ArrayList&lt;Long&gt;&gt;</code> ç±»å‹è½¬æ¢ä¸º<code>Mono&lt;ArrayList&lt;Long&gt;&gt;</code>ï¼Œå†ç»è¿‡mapæ–¹æ³•ï¼Œè½¬æ¢ä¸º<code>Mono&lt;RateLimiterResponse&gt;</code>è¿”å›ã€‚</p><p> è¿”å›ç»“æœæœ‰ä¸¤ä¸ªèµ„æ–™ï¼Œallowed =1, ä»£è¡¨å…è®¸é€šè¿‡ï¼Œ0-ä¸é€šè¿‡ï¼›è€Œç¬¬äºŒä¸ªè¿”å›å‚æ•°tokensLeftï¼Œæ˜¯å¯ç”¨çš„å‰©ä½™è¯·æ±‚æ•°é‡ã€‚</p></li></ol><p>5.å®¹é”™æ€§æ–¹é¢ï¼Œç”±äºä½¿ç”¨çš„æ˜¯reactor çš„éé˜»å¡é€šè®¯æ¨¡å‹ï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä¼šæ‰§è¡ŒonErrorResume()è¯­å¥ï¼ŒFlux.justäº§ç”Ÿè¿”å›èµ„æ–™ï¼Œ é»˜è®¤ä¸º<code>allowed</code>=1, ä»£è¡¨å…è®¸é€šè¿‡ï¼Œ å¹¶ä¸¢å‡ºé”™è¯¯æ—¥å¿—ã€‚</p><p>6.ä¹‹åæ‰§è¡ŒdoFinally()æ–¹æ³•,æ‰§è¡Œç®—æ³•å®ç°ç±»çš„callbackæ–¹æ³•ã€‚</p><p><img alt="io-with-lua" src="/zh/assets/images/io-with-lua-eefcd28d4b59a8bd0e69e29400018c50.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4ç§é™æµç®—æ³•"></a>4ç§é™æµç®—æ³•<a class="hash-link" href="#4ç§é™æµç®—æ³•" title="Direct link to heading">#</a></h2><p>ä¸Šé¢æˆ‘ä»¬äº†è§£äº†ç½‘å…³ä¸­å¦‚ä½•é€šè¿‡Javaä»£ç å¦‚ä½•ä¸Redis åšé€šè®¯ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬é€šè¿‡ç®€è¦åˆ†æç½‘å…³ä¸­æä¾›çš„4ç§é™æµç®—æ³•ä¸­çš„ä¸€äº›ä»£ç ï¼Œæ¥ç†è§£å¦‚ä½•å¼€å‘ä½¿ç”¨<code>RateLimiter SPI</code>çš„æ¥å£æ–¹æ³•,å¹¶ä¸Redisæœ‰æ•ˆåä½œã€‚</p><p><code>Ratelimiter SPI</code>ç›®å‰æä¾›äº†4ç§é™æµç®—æ³•:</p><table><thead><tr><th>Algorithm name</th><th>Java class</th><th>Lua script file</th></tr></thead><tbody><tr><td>Request rate limiter</td><td><code>TokenBucketRateLimiterAlgorithm</code></td><td>request_rate_limiter.lua</td></tr><tr><td>Slide window rate limiter</td><td><code>SlidingWindowRateLimiterAlgorithm</code></td><td>liding_window_request_rate_limiter.lua</td></tr><tr><td>Concurrent rate limiter</td><td><code>ConcurrentRateLimiterAlgorithm</code></td><td>concurrent_request_rate_limiter.lua</td></tr><tr><td>Leaky bucket algorithm</td><td><code>LeakyBucketRateLimiterAlgorithm</code></td><td>request_leaky_rate_limiter.lua</td></tr></tbody></table><ol><li>ä»¤ç‰Œæ¡¶é™æµï¼šæŒ‰è¯·æ±‚æ•°é‡é™æµï¼Œè®¾ç½®æ¯ç§’Nä¸ªè¯·æ±‚ï¼Œè¶…è¿‡Nçš„è¯·æ±‚ä¼šæ‹’ç»æœåŠ¡ã€‚ç®—æ³•å®ç°æ—¶ï¼Œä»¥æ—¶é—´é—´éš”è®¡ç®—åŒ€é€Ÿäº§ç”Ÿä»¤ç‰Œçš„æ•°é‡ã€‚è‹¥æ¯æ¬¡è¯·æ±‚çš„æ•°é‡ï¼Œå°äºæ¡¶å†…ä»¤ç‰Œçš„æ•°é‡ï¼Œåˆ™å…è®¸é€šè¿‡ã€‚ æ—¶é—´çª—å£ä¸º 2*å®¹ç§¯/é€Ÿç‡ã€‚</li><li>æ»‘åŠ¨çª—å£é™æµï¼šä¸ä»¤ç‰Œæ¡¶é™æµä¸åŒåœ¨äºï¼Œå…¶çª—å£å¤§å°æ¯”ä»¤ç‰Œæ¡¶çš„çª—å£å°ï¼Œä¸ºä¸€ä¸ªå®¹ç§¯/é€Ÿç‡ã€‚å¹¶ä¸”æ¯æ¬¡ç§»åŠ¨å‘åä¸€ä¸ªæ—¶é—´æ—¶é—´çª—å£ã€‚å…¶ä»–é™æµåŸç†ä¸ä»¤ç‰Œæ¡¶ç±»ä¼¼ã€‚</li><li>å¹¶å‘çš„è¯·æ±‚é€Ÿç‡é™æµï¼šä¸¥æ ¼é™åˆ¶å¹¶å‘è®¿é—®é‡ä¸ºNä¸ªè¯·æ±‚ï¼Œå¤§äºNçš„è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚æ¯æ¬¡å½“æœ‰æ–°è¯·æ±‚ï¼ŒæŸ¥çœ‹è®¡æ•°æ˜¯å¦å¤§äºN, è‹¥å°äºNåˆ™å…è®¸é€šè¿‡ï¼Œè®¡æ•°åŠ 1ã€‚ å½“è¿™ä¸ªè¯·æ±‚è°ƒç”¨ç»“æŸæ—¶ï¼Œä¼šé‡Šæ”¾è¿™ä¸ªä¿¡å·ï¼ˆè®¡æ•°å‡1ï¼‰</li><li>æ¼æ¡¶ç®—æ³•:  ç›¸å¯¹äºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¼æ¡¶ç®—æ³•æœ‰åŠ©äºå‡å°‘æµé‡èšé›†ï¼Œå®ç°æ›´ä¸ºå¹³æ»‘çš„é™æµå¤„ç†ã€‚ æ¼æ¡¶ç®—æ³•å¼ºåˆ¶ä»¥å¸¸æ•°Nçš„é€Ÿç‡è¾“å‡ºæµé‡ï¼Œå…¶ä»¥æ¼æ¡¶ä¸ºæ¨¡å‹ï¼Œå¯æ¼æ°´çš„é‡ä¸ºæ—¶é—´é—´éš” *é€Ÿç‡ã€‚è‹¥å¯æ¼æ°´é‡&gt;å·²ä½¿ç”¨é‡ï¼Œåˆ™å·²ä½¿ç”¨é‡è®¾ä¸º0( æ¸…ç©ºæ¼æ¡¶)ï¼Œå¦åˆ™å·²ä½¿ç”¨é‡è¦å‡å»å¯æ¼æ°´é‡ã€‚  è‹¥è¯·æ±‚æ•°é‡+ å·²ä½¿ç”¨é‡&lt; æ€»å®¹é‡ï¼Œåˆ™å…è®¸è¯·æ±‚é€šè¿‡ã€‚</li></ol><p>ä¸‹é¢ä»¥ å¹¶è¡Œé™æµç®—æ³•ä¸ºä¾‹ï¼Œè§£è¯»Luaå’ŒJavaä»£ç ï¼ŒæŸ¥çœ‹callback æ–¹æ³•çš„ä½¿ç”¨ã€‚ é€šè¿‡è§£è¯»ä»¤ç‰Œæ¡¶å’Œæ»‘åŠ¨çª—å£ç®—æ³•ä»£ç ï¼Œäº†è§£getKey()æ–¹æ³•çš„ä½¿ç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•"></a>å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•<a class="hash-link" href="#å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•" title="Direct link to heading">#</a></h3><p>é¦–å…ˆ<code>ConcurrentRateLimiterAlgorithm</code> çš„<code>getKeys()</code> æ–¹æ³•è¦†å†™äº†æŠ½è±¡ç±»ä¸­çš„æ¨¡æ¿æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = getKeyName() + &quot;.{&quot; + id + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String requestKey = UUIDUtils.getInstance().generateShortUuid();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, requestKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç¬¬äºŒä¸ªå…ƒç´  requestKey æ˜¯ä¸€ä¸ªlongå‹ä¸é‡å¤å€¼(ç”±ä¸€ä¸ªåˆ†å¸ƒå¼IDäº§ç”Ÿå™¨äº§ç”Ÿçš„ï¼Œé€’å¢ï¼Œæ¯”å½“å‰æ—¶é—´EpochSecondå°)ï¼Œ ç›¸åº”çš„concurrent_request_rate_limiter.luaçš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local capacity = tonumber(ARGV[2])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp = tonumber(ARGV[3])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local id = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œid å³æ˜¯å–å¾—ä¸Šé¢çš„getKeys()æ–¹æ³•äº§ç”Ÿçš„requestKeyï¼Œ ä¸€ä¸ªuuid.  åç»­çš„å¤„ç†å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local count = redis.call(&quot;zcard&quot;, key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if count &lt; capacity then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis.call(&quot;zadd&quot;, key, timestamp, id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count = count + 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed, count }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…ˆç”¨zcardå‘½ä»¤ç»Ÿè®¡redisä¸­keyå€¼æ‰€å¯¹åº”çš„æœ‰åºé›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œè‹¥å…ƒç´ æ€»æ•°countå°äºå®¹é‡ï¼Œåˆ™å…è®¸é€šè¿‡ï¼Œå¹¶ç”¨zadd key score memberæ–¹æ³•ï¼Œå‘keyæ‰€åœ¨çš„æœ‰åºé›†åˆä¸­ï¼Œæ·»åŠ ä¸€ä¸ªå…ƒç´ id, å…¶scoreä¸ºtimestamp.  åˆ™æ­¤æ—¶å…ƒç´ çš„æ€»ä¸ªæ•°countå®é™…ä¸ºcount+1.  </p><p>ä»¥ä¸Šçš„ä»£ç éƒ½æ˜¯åœ¨redisä¸­ä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œæ¥æ‰§è¡Œçš„ã€‚å½“åŒä¸€ä¸ªkey (ä¾‹å¦‚Ipä¸‹)æœ‰å¤§é‡å¹¶å‘è¯·æ±‚æ—¶ï¼Œredisè®°å½•çš„è¯¥ipçš„æœ‰åºé›†åˆçš„æ•°é‡countä¹Ÿåœ¨ä¸æ–­ç´¯åŠ ä¸­ã€‚å½“è¶…è¿‡å®¹é‡é™åˆ¶ï¼Œåˆ™ä¼šæ‹’ç»æœåŠ¡ã€‚</p><p>å¹¶å‘è¯·æ±‚æ•°é™æµç®—æ³•ä¸­ï¼Œè¦æ±‚å½“è¯·æ±‚è°ƒç”¨ç»“æŸæ—¶ï¼Œè¦é‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ï¼Œluaä»£ç ä¸­å¹¶æ²¡æœ‰åšè¿™ä¸ªå¤„ç†ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>ConcurrentRateLimiterAlgorithm</code>ç±»ä¸­çš„å›è°ƒå‡½æ•°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton.INST.get(ReactiveRedisTemplate.class).opsForZSet().remove(keys.get(0), keys.get(1)).subscribe();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œåšäº†ä¸€ä¸ªå¼‚æ­¥çš„è®¢é˜…å¤„ç†ï¼Œé€šè¿‡<code>ReactiveRedisTemplate</code>åˆ é™¤redisä¸­(key, id)çš„å…ƒç´ ï¼Œç­‰å¾…è°ƒç”¨ç»“æŸåï¼Œé‡Šæ”¾è¿™ä¸ªä¿¡å·ã€‚è¿™ä¸ªremoveçš„å¤„ç†ä¸èƒ½æ”¾åˆ°luaè„šæœ¬ä¸­æ‰§è¡Œï¼Œå¦åˆ™é€»è¾‘å°±æ˜¯é”™è¯¯çš„ã€‚è¿™ä¹Ÿæ­£æ˜¯<code>RateLimiterAlgorithm</code> SPI è®¾è®¡<code>callback</code>æ–¹æ³•çš„ç”¨æ„ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getkeys"></a>ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getKeys()<a class="hash-link" href="#ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getkeys" title="Direct link to heading">#</a></h3><p>å¯¹åº”çš„Lua ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local tokens_key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>çœç•¥è·å–å‚æ•°çš„ä»£ç </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local fill_time = capacity/rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local ttl = math.floor(fill_time*2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ—¶é—´çª—å£ttl å¤§æ¦‚æ˜¯ 2* å®¹é‡/é€Ÿç‡.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_tokens = tonumber(redis.call(&quot;get&quot;, tokens_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_tokens == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_tokens = capacity</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»æœ‰åºé›†åˆä¸­å–å¾—ä¸Šæ¬¡ä½¿ç”¨çš„token,å¦‚æœæ²¡æœ‰åˆ™last_tokens = å®¹é‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_refreshed = tonumber(redis.call(&quot;get&quot;, timestamp_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_refreshed == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_refreshed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»¥timestamp_keyä¸ºkey,ä»æœ‰åºé›†åˆä¸­å–å¾—ä¸Šæ¬¡åˆ·æ–°æ—¶é—´ï¼Œé»˜è®¤ä¸º0.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local delta = math.max(0, now-last_refreshed)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local filled_tokens = math.min(capacity, last_tokens+(delta*rate))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = filled_tokens &gt;= requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if allowed then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  new_tokens = filled_tokens - requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ—¶é—´é—´éš”*é€Ÿç‡åŒ€é€Ÿäº§ç”Ÿä»¤ç‰Œï¼Œè‹¥ä»¤ç‰Œæ•°é‡&gt;è¯·æ±‚æ•°é‡ï¼Œåˆ™allowed=1, å¹¶ä¸”æ›´æ–°ä»¤ç‰Œæ•°é‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, tokens_key, ttl, new_tokens)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, timestamp_key, ttl, now)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, new_tokens }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œnowæ˜¯ä¼ å…¥çš„å½“å‰æ—¶é—´(EpochSecond)ï¼Œè®¾ç½®<code>tokens_key</code>æ‰€å¯¹åº”çš„æœ‰åºé›†åˆçš„å€¼ä¸º <code>new_tokens</code>ï¼ˆå³æ–°ä»¤ç‰Œæ•°é‡) ï¼Œ è¿‡æœŸæ—¶é—´ä¸º<code>ttl</code>ã€‚ æ›´æ–°é›†åˆä¸­ï¼Œ<code>timestamp_key</code>çš„å€¼ä¸ºå½“å‰æ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´ä¸º<code>ttl</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨getkeysæ–¹æ³•"></a>æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨<code>getKeys</code>æ–¹æ³•<a class="hash-link" href="#æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨getkeysæ–¹æ³•" title="Direct link to heading">#</a></h3><p>åœ¨<code>SlidingWindowRateLimiterAlgorithm</code> çš„<code>getKeys()</code>åŒæ ·è¦†å†™äº†çˆ¶ç±»ï¼Œä»£ç ä¸<code>ConcurrentRateLimiterAlgorithm</code> æ–¹æ³•ä»£ç ä¸€è‡´ã€‚</p><p>å¦‚ä¸‹ä¸ºæ»‘åŠ¨çª—å£ç®—æ³•çš„Luaä»£ç ï¼Œçœç•¥äº†å…¶ä»–å‚æ•°çš„æ¥æ”¶ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_size = tonumber(capacity / rate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_time = 1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è®¾å®šçª—å£å¤§å°ä¸ºå®¹ç§¯/é€Ÿç‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_requested = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local exists_key = redis.call(&#x27;exists&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (exists_key == 1) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_requested = redis.call(&#x27;zcard&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è·å–å½“å‰key çš„åŸºæ•°</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local remain_request = capacity - last_requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (last_requested &lt; capacity) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;zadd&#x27;, tokens_key, now, timestamp_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è®¡ç®—å‰©ä½™å¯ç”¨é‡ = å®¹é‡ å‡å»å·²ä½¿ç”¨é‡ï¼Œè‹¥<code>last_requested</code> &lt; capacity ,åˆ™å…è®¸é€šè¿‡ï¼Œå¹¶ä¸”åœ¨<code>tokens_key</code>ä¸ºkeyçš„æœ‰åºé›†åˆä¸­ï¼Œå¢åŠ ä¸€ä¸ª å…ƒç´ ï¼ˆkey =<code>timestam_key</code>,value= <code>now</code>)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;zremrangebyscore&#x27;, tokens_key, 0, now - window_size / window_time)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;expire&#x27;, tokens_key, window_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, remain_request }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‰é¢å·²ç»è®¾å®š<code>window_time</code>=1, ç”¨Redisçš„ <code>zremrangebyscore</code>å‘½ä»¤ï¼Œç§»é™¤æœ‰åºé›†åˆä¸­ï¼Œscoreä¸º[0- å½“å‰æ—¶é—´-çª—å£å¤§å°]çš„å…ƒç´ ï¼Œå³ç§»åŠ¨ä¸€ä¸ªçª—å£å¤§å°ã€‚è®¾å®štokens_keyçš„è¿‡æœŸæ—¶é—´ä¸ºçª—å£å¤§å°ã€‚</p><p>åœ¨<code>AbstractRateLimiterAlgorithm</code>çš„æ¨¡æ¿æ–¹æ³•ä¸­ï¼Œ<code>getKeys(final String id)</code> ç»™å‡ºçš„ç¬¬äºŒä¸ªå€¼(ä»¥<code>secondKey</code>æŒ‡ä»£)ï¼Œæ˜¯æ‹¼æ¥äº†{id} (å³resolve key)çš„ä¸€ä¸ªå›ºå®šå­—ç¬¦ä¸²ã€‚ä»ä¸Šé¢ä¸‰ä¸ªç®—æ³•ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ï¼Œ<code>secondKey</code>åœ¨Luaä»£ç æ‰§è¡Œä¸­ä¼šæ›´æ–°ä¸ºæœ€æ–°çš„æ—¶é—´ï¼Œæ‰€ä»¥æ— æ‰€è°“ä¼ å…¥çš„å€¼ã€‚è€Œåœ¨å¹¶å‘é™æµç®—æ³•ä¸­ï¼Œä¼šä»¥æ­¤<code>secondKey</code>ä¸ºæ¡ä»¶ï¼Œåœ¨java <code>callback</code>æ–¹æ³•ä¸­ç§»é™¤å¯¹åº”çš„å…ƒç´ ã€‚è€Œåœ¨æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ï¼Œè¿™ä¸ª<code>secondKey</code>çš„å€¼ï¼Œä¼šä½œä¸ºä¸€ä¸ªæ–°å…ƒç´ çš„key, å¢åŠ åˆ°å½“å‰æœ‰åºé›†åˆä¸­ï¼Œå¹¶åœ¨åšçª—å£æ»‘åŠ¨ä¸­ï¼Œè¿‡æœŸçš„èµ„æ–™ä¼šè¢«åˆ é™¤æ‰ã€‚</p><p>æ€»ä¹‹ï¼Œå½“è®¾è®¡æ–°çš„é™æµç®—æ³•æ—¶ï¼Œè¦æ ¹æ®ç®—æ³•éœ€è¦ä»”ç»†è®¾è®¡<code>getKey()</code>æ–¹æ³•ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¦‚ä½•è°ƒç”¨-ratelimiter-spi"></a>å¦‚ä½•è°ƒç”¨ RateLimiter SPI<a class="hash-link" href="#å¦‚ä½•è°ƒç”¨-ratelimiter-spi" title="Direct link to heading">#</a></h2><p>åœ¨<code>RateLimiter</code> Plugä¸­çš„<code>doExecute()</code>æ–¹æ³•ä¸­ï¼Œä¼ å…¥çš„ä¸‰ä¸ªå‚æ•° exchange ä¸ºè¯·æ±‚çš„è¿æ¥ï¼Œ chain ä¸ºshenyuæ’ä»¶çš„è°ƒç”¨é“¾ï¼Œselector æ˜¯é€‰æ‹©å™¨ï¼Œruleæ˜¯ç³»ç»Ÿä¸­é…ç½®çš„è§„åˆ™å‚æ•°èµ„æ–™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RateLimiterHandle limiterHandle = RatelimiterRuleHandleCache.getInstance()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolverKey = Optional.ofNullable(limiterHandle.getKeyResolverName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(name -&gt; Optional.of(&quot;-&quot; + RateLimiterKeyResolverFactory.newInstance(name).resolve(exchange)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return redisRateLimiter.isAllowed(rule.getId() + resolverKey, limiterHandle)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(response -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!response.isAllowed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(ShenyuResultEnum.TOO_MANY_REQUESTS.getCode(), ShenyuResultEnum.TOO_MANY_REQUESTS.getMsg(), null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>1.é¦–å…ˆï¼Œä»ç¼“å­˜ä¸­ï¼Œå–å¾—ç³»ç»Ÿè®¾å®šçš„é™æµå‚æ•°<code>RateLimiterHandle</code>å®ä¾‹ <code>limiterHandle</code>.
2.æ ¹æ®nameæŒ‡å®šçš„Resolver è·å¾—è¯·æ±‚çš„è¿æ¥Keyä¿¡æ¯ï¼ˆå¦‚åœ°å€ç­‰).
3.è°ƒç”¨ RedisRateLimiterçš„ isAllowedæ–¹æ³•, è·å–è¿”å›å€¼åï¼Œ
4.è‹¥<code>isAllowd</code>=false,åšé”™è¯¯å¤„ç†
5.å¦‚æœ <code>isAllowed</code>=trueï¼Œreturn chain.execute(exchange)ï¼Œ å¯¹è¯¥è¯·æ±‚åšåç»­å¤„ç†ï¼Œä¼ é€’åˆ°è°ƒç”¨é“¾çš„ä¸‹ä¸€å…³ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>æ•´ä¸ª<code>RateLimiter</code> pluginæ¡†æ¶åŸºäºSpring WebFluxå¼€å‘ï¼Œç”¨redis å’Œluaè„šæœ¬åšé™æµè®¡æ•°åŠæ ¸å¿ƒé€»è¾‘å¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘åŠå¼¹æ€§æ‰©å±•ã€‚</p><ol><li><p><code>RateLimiter</code> <code>SPI</code> æä¾›äº†ä¸¤ä¸ª<code>SPI</code> æ¥å£ï¼Œé€šè¿‡åº”ç”¨é¢å‘æ¥å£è®¾è®¡åŠå„ç§è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥æ–¹ä¾¿çš„å¢åŠ æ–°çš„é™æµç®—æ³•ï¼Œä»¥åŠå„ç§æµé‡è§£æè§„åˆ™ã€‚</p></li><li><p>æä¾›äº†ä»¤ç‰Œæ¡¶ã€å¹¶å‘é€Ÿç‡é™æµã€æ»‘åŠ¨çª—å£ã€æ¼æ¡¶4ç§é™æµç®—æ³•ã€‚åœ¨è®¾è®¡ç®—æ³•å®ç°æ—¶ï¼Œéœ€è¦æ ¹æ®ç®—æ³•ç‰¹å¾è®¾è®¡KEYå€¼ï¼Œç”¨Luaè„šæœ¬å®ç°åœ¨redisä¸­è¦å¤„ç†çš„é€»è¾‘ï¼Œè®¾è®¡<code>callback()</code>æ–¹æ³•åšåç»­çš„æ•°æ®å¤„ç†ã€‚</p></li><li><p>å“åº”å¼ç¼–ç¨‹ï¼Œå®ç°è¿‡ç¨‹ç®€æ´é«˜æ•ˆã€‚</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/rate-limiter">rate limiter</a><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor">ç¤¾åŒºæ–°äººå¼€å‘è€…å¯åŠ¨åŠå¼€å‘é˜²è¸©å‘æŒ‡å—</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T06:06:58.415Z">2023å¹´8æœˆ15æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/61108539?s=400&amp;u=f065b78a2944f2cea9160de7f7df054e2f157867&amp;v=4" alt="Yuxuan Zhang"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer">Yuxuan Zhang</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å‰è¨€"></a>å‰è¨€<a class="hash-link" href="#å‰è¨€" title="Direct link to heading">#</a></h2><p>ä½œä¸º <code>Shenyu</code> ç¤¾åŒºåˆæ¥ä¹åˆ°çš„å¼€å‘è€…ï¼Œæˆ‘åœ¨æŒ‰ç…§ç›¸å…³æ•™ç¨‹è¿›è¡Œé¡¹ç›®å¯åŠ¨åŠå¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€äº›æ•™ç¨‹ä¸­å¹¶æœªæåŠåˆ°çš„ â€œå‘â€ ï¼Œ æˆ‘å°†æˆ‘å¯åŠ¨<code>shenyu</code> , <code>shenyu-dashboard</code>, <code>shenyu-website</code> çš„è¯¦ç»†æ­¥éª¤è®°å½•åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ç¤¾åŒºä¸­æ›´å¤šçš„æ–°äººå¼€å‘è€…ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡<a class="hash-link" href="#ç¯å¢ƒå‡†å¤‡" title="Direct link to heading">#</a></h2><ul><li>æœ¬åœ°æ­£ç¡®å®‰è£… <code>JDK1.8+</code></li><li>æœ¬åœ°æ­£ç¡®å®‰è£… <code>Git</code></li><li>é€‰æ‹©ä¸€æ¬¾å¼€å‘å·¥å…·ï¼Œæœ¬æ–‡ä½¿ç”¨ <code>IDEA</code> ä¸ºä¾‹</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-åç«¯å¯åŠ¨æŒ‡å—"></a>ShenYu åç«¯å¯åŠ¨æŒ‡å—<a class="hash-link" href="#shenyu-åç«¯å¯åŠ¨æŒ‡å—" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å®‰è£…å¹¶é…ç½®maven"></a>å®‰è£…å¹¶é…ç½®Maven<a class="hash-link" href="#å®‰è£…å¹¶é…ç½®maven" title="Direct link to heading">#</a></h3><p>Mavenæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„é¡¹ç›®ç®¡ç†å·¥å…·ã€‚ä½œä¸ºApacheç»„ç»‡é¡¶çº§å¼€æºé¡¹ç›®ï¼Œå…¶ä¸»è¦æœåŠ¡äºåŸºäºJavaå¹³å°çš„é¡¹ç›®åˆ›å»ºï¼Œä¾èµ–ç®¡ç†å’Œé¡¹ç›®ä¿¡æ¯ç®¡ç†ã€‚</p><ol><li><p><a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener noreferrer">ä¸‹è½½ maven</a>ï¼Œå¹¶è§£å‹åˆ°ä¸€ä¸ªæ²¡æœ‰ä¸­æ–‡æ²¡æœ‰ç©ºæ ¼çš„è·¯å¾„ä¸‹ã€‚</p><p><img src="/zh/assets/images/maven-install-1810a86409d255c485e91852e679baad.png"></p></li><li><p>å°† <code>maven</code> ç›®å½•ä¸‹çš„ <code>bin</code> ç›®å½•æ·»åŠ è‡³ç¯å¢ƒå˜é‡ä¸­ã€‚ä»¥ <code>Windows</code> ä¸ºä¾‹ï¼Œè‹¥ä¸‹è½½ç›®å½•ä¸º <code>E:\apache-maven-3.9.1</code> ï¼Œåˆ™å°†<code>E:\apache-maven-3.9.1\bin</code> æ·»åŠ è‡³ <code>Path</code> ç³»ç»Ÿå˜é‡ä¸­ã€‚</p></li><li><p>éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸã€‚åœ¨å‘½ä»¤è¡Œçª—å£ä¸­è¾“å…¥ <code>mvn -v</code> ï¼Œè‹¥å‡ºç° Maven ç‰ˆæœ¬åŠ Java ç‰ˆæœ¬å³ä¸ºå®‰è£…æˆåŠŸã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">mvn -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Maven </span><span class="token number" style="color:#36acaa">3.9</span><span class="token plain">.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">2e178502fcdbffc201671fb2537d0cb4b4cc58f8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Maven home: E:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">apache-maven-3.9.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Java version: </span><span class="token number" style="color:#36acaa">18.0</span><span class="token plain">.1.1, vendor: Oracle Corporation, runtime: C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Program Files</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Java</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">jdk-18.0.1.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Default locale: zh_CN, platform encoding: UTF-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain">OS name: </span><span class="token string" style="color:#e3116c">&quot;windows 10&quot;</span><span class="token plain">, version: </span><span class="token string" style="color:#e3116c">&quot;10.0&quot;</span><span class="token plain">, arch: </span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain">, family: </span><span class="token string" style="color:#e3116c">&quot;windows&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>ä¸ºäº†åŠ å¿«é¡¹ç›®ç›¸å…³ä¾èµ–çš„ä¸‹è½½é€Ÿåº¦ï¼Œéœ€è¦æ›´æ”¹ Maven é•œåƒï¼Œæ­¤å¤„æ·»åŠ é˜¿é‡Œäº‘ç­‰é•œåƒã€‚å°† <code>conf/settings.xml</code> ä¸­ <code>&lt;mirrors&gt; &lt;/mirrors&gt;</code> æ ‡ç­¾å¯¹æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/groups/public/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/repositories/central/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">name_</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://repo1.maven.org/maven2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit address/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://jcenter.bintray.com/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¹¶åœ¨ <code>&lt;/mirrors&gt;</code> ä¸‹ä¸€è¡Œæ·»åŠ  <code>&lt;localRepository&gt;E:/maven_local_repository&lt;/localRepository&gt;</code>è®¾ç½® Maven æœ¬åœ°ä»“åº“ä½ç½®ã€‚å…·ä½“ä½ç½®å¯è‡ªè¡ŒæŒ‡å®šã€‚</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‹‰å–-shenyu-ä»£ç "></a>æ‹‰å– ShenYu ä»£ç <a class="hash-link" href="#æ‹‰å–-shenyu-ä»£ç " title="Direct link to heading">#</a></h3><ol><li><p>åœ¨ Github ä¸Š Fork <a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer">ShenYu</a> ä»“åº“åˆ°è‡ªå·±çš„å­˜å‚¨åº“ä¸­ï¼Œä»¥åå¯åœ¨æ­¤ä»“åº“ä¸­è¿›è¡Œå¼€å‘å¹¶æäº¤ PR</p></li><li><p>ä½¿ç”¨ Git å°†ä¸Šä¸€æ­¥ Fork çš„ä»“åº“ä¸‹è½½åˆ°æœ¬åœ°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‹¥æç¤ºæ–‡ä»¶åè¿‡é•¿ï¼Œåˆ™é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> config --global core.longpaths </span><span class="token boolean" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-åˆå¯åŠ¨"></a>ShenYu åˆå¯åŠ¨<a class="hash-link" href="#shenyu-åˆå¯åŠ¨" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ<a class="hash-link" href="#å‡†å¤‡å·¥ä½œ" title="Direct link to heading">#</a></h4><ol><li><p>åœ¨ <code>shenyu</code> ç›®å½•ä¸‹ä½¿ç”¨ Maven è¿›è¡Œç¼–è¯‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>é…ç½® IDEA ç¯å¢ƒã€‚ä½¿ç”¨ IDEA æ‰“å¼€ <code>shenyu</code> é¡¹ç›®ï¼Œç‚¹å‡»å·¦ä¸Šè§’ <code>File</code> -&gt; <code>Settings</code> ï¼ŒæŒ‰ç…§ä¸‹å›¾é…ç½®  Maven ã€‚å…¶ä¸­ <code>User settings file</code> é€‰æ‹©ä½ çš„ <code>settings.xml</code> æ‰€åœ¨ç›®å½•ï¼Œ <code>Local repository</code> ä¼šè‡ªåŠ¨åŠ è½½ <code>settings.xml</code> ä¸­è®¾ç½®çš„ <code>localRepository</code> è·¯å¾„ï¼š</p><p><img src="/zh/assets/images/idea-config-eab162e57c60c188ae39b46d08d17d0a.png"></p></li><li><p>æ­¤æ—¶ï¼ŒIDEA ä¼šè‡ªåŠ¨ä¸‹è½½é¡¹ç›®ç›¸å…³ä¾èµ–ï¼Œéœ€ç­‰å¾…ä¸€ä¼šï¼Œå®Œæˆåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/zh/assets/images/project-without-example-0a8dc1e81a325b6ce56328b3d282325d.png"></p><p>å¯ä»¥å‘ç°ï¼Œ <code>shenyu-e2e</code>, <code>shenyu-examples</code>, <code>shenyu-integrated-test</code> æ²¡æœ‰è¢« IDEA æ ‡è®°ä¸º Maven é¡¹ç›®ï¼Œéœ€æ‰‹åŠ¨æ·»åŠ ã€‚åˆ†åˆ«é€‰ä¸­åŒ…ä¸­çš„ <code>pom.xml</code> æ–‡ä»¶ï¼Œå³é”®ç‚¹å‡» <code>Add as Maven Project</code> ã€‚
è‹¥ shenyu-e2e æ„å»ºå¤±è´¥ï¼Œåˆ™å°†å…¶ <code>pom.xml</code> ä¸­ <code>&lt;relativePath&gt;./pom.xml&lt;/relativePath&gt;</code> æ”¹ä¸º <code>&lt;relativePath/&gt;</code> ã€‚</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨ç½‘å…³æœåŠ¡"></a>å¯åŠ¨ç½‘å…³æœåŠ¡<a class="hash-link" href="#å¯åŠ¨ç½‘å…³æœåŠ¡" title="Direct link to heading">#</a></h4><ol><li><p>å¯åŠ¨ <code>shenyu-admin</code> æ§åˆ¶å°ï¼ˆé»˜è®¤ä½¿ç”¨H2æ•°æ®åº“ï¼‰</p><p><img src="/zh/assets/images/admin-debdd1ee5e979a4892f26e4d54572ead.png"></p></li><li><p>å¯åŠ¨ <code>shenyu-bootstrap</code></p><p><img src="/zh/assets/images/bootstrap-cafa4d22b0d69bb6ee82c01e7b45d239.png"></p></li></ol><blockquote><p>åˆ°è¿™ä¸€æ­¥ï¼Œshenyuç½‘å…³å·²ç»å¯åŠ¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®adminæ§åˆ¶å°ï¼š<a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p><p>é»˜è®¤è´¦å·ï¼šadmin ï¼Œé»˜è®¤å¯†ç ï¼š123456</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨åº”ç”¨æœåŠ¡"></a>å¯åŠ¨åº”ç”¨æœåŠ¡<a class="hash-link" href="#å¯åŠ¨åº”ç”¨æœåŠ¡" title="Direct link to heading">#</a></h4><p>Apache ShenYuæä¾›äº†Httpã€Dubboã€SpringCloudç­‰åº”ç”¨æ¥å…¥shenyuç½‘å…³çš„æ ·ä¾‹ï¼Œä½äº <code>shenyu-example</code> æ¨¡å—ï¼Œè¿™é‡Œä»¥HttpæœåŠ¡ä¸ºä¾‹ã€‚</p><p>å¯åŠ¨ <code>shenyu-examples-http</code>ã€‚</p><p><img src="/zh/assets/images/shenyu-examples-http-16e2cd3166eb89067d20ab76fbd2000a.png"></p><p>è¿™æ—¶ï¼Œ<code>shenyu-examples-http</code> ä¼šè‡ªåŠ¨æŠŠåŠ  <code>@ShenyuSpringMvcClient</code> æ³¨è§£çš„æ¥å£æ–¹æ³•ï¼Œä»¥åŠapplication.ymlä¸­çš„ç›¸å…³é…ç½®æ³¨å†Œåˆ°ç½‘å…³ã€‚æˆ‘ä»¬æ‰“å¼€ <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">adminæ§åˆ¶å°</a>ï¼Œå³å¯åœ¨<code>æ’ä»¶åˆ—è¡¨ -&gt; Proxy -&gt; divide</code> ä¸­çœ‹åˆ°ç›¸å…³é…ç½®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æµ‹è¯•httpè¯·æ±‚"></a>æµ‹è¯•Httpè¯·æ±‚<a class="hash-link" href="#æµ‹è¯•httpè¯·æ±‚" title="Direct link to heading">#</a></h4><p>ä¸‹é¢ä½¿ç”¨ <code>IDEA HTTP Client Plugin</code> æ¨¡æ‹Ÿ http çš„æ–¹å¼æ¥è®¿é—® http æœåŠ¡ã€‚</p><ul><li><p>æœ¬åœ°è®¿é—®ï¼Œä¸ä½¿ç”¨ shenyu ä»£ç†</p><p>  <img src="/zh/assets/images/shenyu-http-test-api-local-0769bf0aa49ba1d1bf19781429c0311b.png"></p></li><li><p>ä½¿ç”¨ shenyu ä»£ç†</p><p>  <img src="/zh/assets/images/shenyu-http-test-api-b3f37741aee04845e891179e8eb6a137.png"></p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä½¿ç”¨æ›´å¤šæ’ä»¶"></a>ä½¿ç”¨æ›´å¤šæ’ä»¶<a class="hash-link" href="#ä½¿ç”¨æ›´å¤šæ’ä»¶" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="/zh/blog/docs/index">å®˜æ–¹æ–‡æ¡£</a>å·¦ä¾§<code>æ’ä»¶é›†åˆ</code>ï¼Œæ¥ä½¿ç”¨æ‰€éœ€è¦æ’ä»¶ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-å‰ç«¯å¯åŠ¨æŒ‡å—"></a>Shenyu å‰ç«¯å¯åŠ¨æŒ‡å—<a class="hash-link" href="#shenyu-å‰ç«¯å¯åŠ¨æŒ‡å—" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å®‰è£…-nodejs"></a>å®‰è£… Node.js<a class="hash-link" href="#å®‰è£…-nodejs" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä¸‹è½½"></a>ä¸‹è½½<a class="hash-link" href="#ä¸‹è½½" title="Direct link to heading">#</a></h4><ol><li><p>åœ¨<a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">å®˜ç½‘</a>ä¸‹è½½å¹¶å®‰è£…Node.js ï¼Œé€‰æ‹© <code>LTS</code> ç‰ˆæœ¬å³å¯</p></li><li><p>å®‰è£…æ—¶ï¼Œé™¤äº†è®¾ç½®å®‰è£…è·¯å¾„ï¼Œå…¶ä»–ä¸€ç›´ç‚¹ <code>Next</code> å³å¯</p></li><li><p>å®‰è£…å®Œæˆåï¼Œåœ¨å‘½ä»¤è¡Œä¸­è¿›è¡ŒéªŒè¯ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">node -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">v12.22.12</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">npm -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6.14</span><span class="token plain">.16</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ¢æº"></a>æ¢æº<a class="hash-link" href="#æ¢æº" title="Direct link to heading">#</a></h4><p>ä¸ºäº†åŠ å¿« npm ä¸‹è½½é€Ÿåº¦ï¼Œéœ€è¦è¿›è¡Œæ¢æºï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æŸ¥çœ‹å½“å‰æº</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> config get registry</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¢ä¸ºä¸­å›½ npmmirror é•œåƒæº</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> config </span><span class="token builtin class-name">set</span><span class="token plain"> registry https://registry.npmmirror.com</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æŸ¥çœ‹æ˜¯å¦æ¢æºæˆåŠŸ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> config get registry</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‹‰å–-shenyu-dashboard-ä»£ç "></a>æ‹‰å– ShenYu Dashboard ä»£ç <a class="hash-link" href="#æ‹‰å–-shenyu-dashboard-ä»£ç " title="Direct link to heading">#</a></h3><ol><li><p>Fork <a href="https://github.com/apache/shenyu-dashboard" target="_blank" rel="noopener noreferrer">ShenYu Dashboard</a> ä»“åº“</p></li><li><p>ä½¿ç”¨ Git ä¸‹è½½åˆ°æœ¬åœ°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å‰åç«¯è”åˆå¼€å‘"></a>å‰åç«¯è”åˆå¼€å‘<a class="hash-link" href="#å‰åç«¯è”åˆå¼€å‘" title="Direct link to heading">#</a></h3><ol><li><p>åœ¨åç«¯ä»“åº“ <code>shenyu</code> çš„ <code>shenyu-admin/src/main/resources/application.yml</code> æ–‡ä»¶ä¸­æŒ‰ä¸‹å›¾æ‰€ç¤ºæ·»åŠ  <code>enablePrintApiLog: true</code> ï¼Œä»¥åœ¨åç«¯æ§åˆ¶å°æ˜¾ç¤ºå‰ç«¯æ¥å£è¢«è°ƒç”¨çš„æ—¥å¿—ã€‚</p><p><img src="/zh/assets/images/enable-api-log-b7eedec55079ce1ef7b96e3076f46841.png"></p></li><li><p>å¯åŠ¨ <code>ShenyuAdminBootstrap</code></p></li><li><p>åˆ‡æ¢è‡³å‰ç«¯ä»“åº“ <code>shenyu-dashboard</code> ï¼Œæ‰“å¼€ <code>README</code> ï¼Œä¾æ¬¡ç‚¹å‡» <code>npm install</code>, <code>npm start</code> æˆ–é€šè¿‡å‘½ä»¤è¡Œè¾“å…¥ä¸Šè¿°å‘½ä»¤å³å¯é€šè¿‡ <a href="http://localhost:8000" target="_blank" rel="noopener noreferrer">http://localhost:8000</a> è®¿é—®å‰ç«¯ç•Œé¢ï¼Œå¹¶å¯åœ¨åç«¯æ§åˆ¶å°ä¸­æ˜¾ç¤ºå‰ç«¯æ¥å£è¢«è°ƒç”¨çš„æ—¥å¿—ï¼Œå®ç°å‰åç«¯è”åˆå¼€å‘ã€‚</p><p><img src="/zh/assets/images/admin-log-37289f14905e15906d363c0345b797cb.png"></p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‰“åŒ…å‰ç«¯ä»£ç "></a>æ‰“åŒ…å‰ç«¯ä»£ç <a class="hash-link" href="#æ‰“åŒ…å‰ç«¯ä»£ç " title="Direct link to heading">#</a></h3><p>æ‰§è¡Œ <code>README</code> ä¸­ <code>npm build</code> å‘½ä»¤ï¼Œå¹¶å°† dist æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°åç«¯ä»“åº“ä¸­ <code>shenyu-admin/src/main/resources/static/</code> ç›®å½•ä¸‹ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä¸º-shenyu-å®˜ç½‘åšè´¡çŒ®"></a>ä¸º Shenyu å®˜ç½‘åšè´¡çŒ®<a class="hash-link" href="#ä¸º-shenyu-å®˜ç½‘åšè´¡çŒ®" title="Direct link to heading">#</a></h2><p>æŒ‰ç…§ <a href="https://github.com/apache/shenyu-website" target="_blank" rel="noopener noreferrer">shenyu-website</a> ä¸­ <code>README</code> è¿›è¡Œæ“ä½œå³å¯ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å°è´´å£«"></a>å°è´´å£«<a class="hash-link" href="#å°è´´å£«" title="Direct link to heading">#</a></h3><ol><li>å¯ä»¥ä¸º <code>yarn</code> è¿›è¡Œæ¢æºï¼Œæµç¨‹åŒ <code>npm</code></li><li>å»ºè®®ä¸‹è½½ <code>Node</code> <a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">å®˜ç½‘</a>ä¸­ <code>LTS</code> ç‰ˆæœ¬</li><li><code>Windows</code> ç³»ç»Ÿæ— æ³•è¿›è¡Œéƒ¨ç½²ï¼Œå¦‚éœ€å¯¹ä½ çš„æ›´æ”¹è¿›è¡ŒéªŒè¯ï¼Œå¯ä»¥åœ¨Linux è™šæ‹Ÿæœºæˆ–æœåŠ¡å™¨ä¸Šè¿›è¡Œéƒ¨ç½²</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/first-start">first-start</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy--åŸºäºSPIçš„ä»£ç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T06:06:58.415Z">2023å¹´8æœˆ15æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p><code>Apache Shenyu</code> ç½‘å…³çš„å„ä¸ª<code>Plugin</code>ï¼ˆåŒ…æ‹¬<code>Dubbo</code>, <code>gRPC</code>,<code>Spring-cloud</code>ç­‰) ä¸­ï¼Œ<code>routing</code>å‚æ•°å‡è®¾è®¡ä¸ºå¯ä»¥æ¥å—å¤šä¸ªæ¡ä»¶çš„ç»„åˆã€‚ ä¸ºäº†å®ç°è¿™æ ·çš„ç›®çš„ï¼Œéµå¾ªå…¶<code>SPI</code>çš„æœºåˆ¶è¿›è¡Œå°†å‚æ•°åŠè¡Œä¸ºæŠ½è±¡ä¸ºå¦‚ä¸‹ä¸‰éƒ¨åˆ†ï¼Œè¿™äº›<code>SPI</code> åœ¨<strong><em>shenyu-plugin-base</em></strong>æ¨¡ç»„ä¸­å®ç°</p><ul><li><code>ParameterData</code>-å‚æ•°èµ„æ–™</li><li><code>PredictJudge</code>-æ–­è¨€</li><li><code>MatchStrategy</code>-åŒ¹é…ç­–ç•¥</li></ul><p>ç›¸å¯¹è€Œè¨€ï¼ŒåŒ¹é…ç­–ç•¥æ˜¯éœ€è¦æ‰©å±•ç‚¹æœ€å°‘çš„éƒ¨åˆ†ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¯¹å¤šä¸ªæ¡ä»¶çš„ç»„åˆåˆ¤æ–­ï¼Œæœ€å¸¸è§çš„å‡ ç§è§„åˆ™æ˜¯ï¼šå…¨éƒ¨éƒ½æ»¡è¶³ã€è‡³å°‘æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ã€è‡³å°‘æ»¡è¶³ç¬¬ä¸€ä¸ªï¼Œæˆ–è€…å¤§éƒ¨åˆ†æ»¡è¶³ç­‰ç­‰ã€‚ å¹¶ä¸”è¦åšåˆ°å¯¹å„ç§<code>plugin</code>çš„ä¸åŒç±»å‹çš„å‚æ•°ï¼Œå¦‚<code>IP</code>, <code>header</code>, <code>uri</code>ç­‰ã€‚é’ˆå¯¹è¿™äº›éœ€æ±‚ï¼Œå¦‚ä½•å°†<code>MatchStrategy</code>è®¾è®¡å¾—ç®€å•æ˜“ç”¨ä¸”å®¹æ˜“æ‰©å±•ï¼Ÿ</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy"></a>MatchStrategy<a class="hash-link" href="#matchstrategy" title="Direct link to heading">#</a></h2><p><code>MatchStrategy</code>çš„å®ç°ä»£ç åœ¨<strong><em>shenyu-plugin-base</em></strong>æ¨¡ç»„ä¸­ï¼ŒåŸºäº<code>Apache Shenyu</code>çš„<code>SPI</code>åˆ›å»ºæœºåˆ¶ï¼Œ è®¾è®¡ä¸Šç»“åˆäº†å·¥å‚æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼ï¼Œæ•´ä½“<code>MatchStrategy</code>çš„è®¾è®¡ç±»å›¾å¦‚ä¸‹ä¸‹ï¼š</p><p><img alt="MatchStrategy-class-diagram" src="/zh/assets/images/MatchStrategy-class-diagram-ac006eef5089ce92a972e039b431100b.PNG"></p><p>ä»¥æ¥å£<code>MatchStrategy</code>ä¸ºåŸºç¡€ï¼Œè®¾è®¡å®ç°ç±»ï¼Œå¹¶ç”±æŠ½è±¡ç±»<code>AbstractMatchStrategy</code>å®ç°å…¬å…±æ–¹æ³•ï¼Œç”±å·¥å‚ç±»<code>MatchStrategyFactory</code>æä¾›åˆ›å»ºå’Œå¤–éƒ¨è°ƒç”¨åŠŸèƒ½ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy-interface"></a>MatchStrategy Interface<a class="hash-link" href="#matchstrategy-interface" title="Direct link to heading">#</a></h2><p>é¦–å…ˆæ¥çœ‹<code>MatchStrategy</code> <code>SPI</code>æ¥å£çš„å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean match(List&lt;ConditionData&gt; conditionDataList, ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>@<code>SPI</code> <code>annotation</code>ä»£è¡¨è¿™æ˜¯ä¸€ä¸ª<code>SPI</code>æ¥å£ã€‚<code>ServerWebExchange</code> æ˜¯ <code>org.springframework.web.server.ServerWebExchange</code> ,ä»£è¡¨<code>HTTP</code>çš„ <code>request-response</code>  çš„äº¤äº’å†…å®¹ã€‚<code>ConditionData</code>çš„ä»£ç å¦‚ä¸‹ï¼Œæ›´å¤šè¯´æ˜å¯ä»¥å‚è€ƒ<code>PredicateJudge</code><a href="http://shenyu.apache.org/blog/PredicateJudge-SPI" target="_blank" rel="noopener noreferrer">ä»£ç åˆ†æ</a>ä¸­çš„è¯´æ˜ï¼Œ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionData {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String operator;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramValue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractmatchstrategy"></a>AbstractMatchStrategy<a class="hash-link" href="#abstractmatchstrategy" title="Direct link to heading">#</a></h2><p>åœ¨æŠ½è±¡ç±»<code>AbstractMatchStrategy</code>ä¸­ï¼Œå®šä¹‰<code>MatchStrategy</code>çš„å…¬å…±æ–¹æ³•ï¼Œ ç”¨<code>buildRealData</code>æ–¹æ³•ä¸­ï¼Œç”¨<code>ParameterData</code>å·¥å‚ç±»<code>ParameterDataFactory</code>ï¼Œå°†å¤šç§å‚æ•°å¦‚  <code>Ip</code>, <code>Cookie</code>, <code>Header</code>,<code>uri</code>ç­‰èµ„æ–™éƒ½ä»¥ç»Ÿä¸€çš„æ¥å£æ–¹æ³•æ¥å‘ˆç°ã€‚è¿™äº›å‚æ•°æ ¼å¼åŠè§„åˆ™çš„ä¿®æ”¹ï¼Œä¸ä¼šå½±å“åˆ°å¯¹å‚æ•°è§„åˆ™åŒ¹é…<code>MatchStrategy</code>çš„è°ƒç”¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractMatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String buildRealData(final ConditionData condition, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ParameterDataFactory.builderData(condition.getParamType(), condition.getParamName(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å®ç°ç±»åŠprofile"></a>å®ç°ç±»åŠProfile<a class="hash-link" href="#å®ç°ç±»åŠprofile" title="Direct link to heading">#</a></h2><p>åŸºäºä¸Šè¿°æ¥å£å®šä¹‰, <strong><em>shenyu-plugin-base</em></strong> æ¨¡ç»„æä¾›äº†ä¸¤ä¸ª<code>MatchStrategy</code>å®ç°ç±»</p><ul><li><p><code>AndMatchStrategy</code>-å¤šä¸ªæ¡ä»¶ AND</p></li><li><p><code>OrMatchStrategy</code>- å¤šä¸ªæ¡ä»¶ OR</p><p>å¹¶åœ¨<code>SHENYU_DIRECTORY</code>ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®ä½œç±»åšäº†é…ç½®ã€‚åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šç”±é¡¶å±‚<code>SPI</code>ä»¥<code>key-value</code>å½¢å¼åŠ è½½å¹¶<code>cache</code>èµ·æ¥ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">and=org.apache.shenyu.plugin.base.condition.strategy.AndMatchStrategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">or=org.apache.shenyu.plugin.base.condition.strategy.OrMatchStrategy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p> ä¸¤ä¸ªå®ç°ç±»<code>AndMatchStrategy</code> ç»§æ‰¿<code>AbstractMatchStrategy</code> å¹¶å®åšäº†<code>MatchStrategy</code>ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="andmatchstrategy---ä¸çš„å…³ç³»"></a>AndMatchStrategy-  â€œä¸â€çš„å…³ç³»<a class="hash-link" href="#andmatchstrategy---ä¸çš„å…³ç³»" title="Direct link to heading">#</a></h3><p>  ç”±äº<code>PredicateJudge</code>å°è£…äº†æ¡ä»¶åˆ¤æ–­çš„å¤šæ ·æ€§ï¼Œ<code>ConditionData</code>å’Œ<code>ParameData</code>å°è£…äº†å¤šç§å‚æ•°ã€‚é‚£ä¹ˆå¯¹äºå¤šä¸ªæ¡ä»¶çš„åŒ¹é…æ¥è¯´ï¼Œé‡‡ç”¨<code>Stream</code>æµå¤„ç†åŠ<code>lamda</code>è¡¨è¾¾å¼ï¼Œéå¸¸ç®€æ´é«˜æ•ˆè¾¾æˆäº†ï¼šå…¨éƒ¨æ¡ä»¶éƒ½æ»¡è¶³ï¼Œå³&quot;AND&quot;çš„é€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AndMatchStrategy extends AbstractMatchStrategy implements MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean match(final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return conditionDataList</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .allMatch(condition -&gt; PredicateJudgeFactory.judge(condition, buildRealData(condition, exchange)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>OrMatchStrategy</code>æ˜¯åŒæ ·çš„å®ç°æ–¹å¼ï¼Œå®ç°: è‡³å°‘æ»¡è¶³ä¸€ä¸ªæ¡ä»¶&quot;OR&quot;çš„è§„åˆ™ï¼Œåœ¨æ­¤ä¸åšèµ˜è¿°ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategyfactory"></a>MatchStrategyFactory<a class="hash-link" href="#matchstrategyfactory" title="Direct link to heading">#</a></h2><p>è¿™æ˜¯<code>MatchStrategy</code>çš„å·¥å‚ç±»ï¼Œå®ç°äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯<code>newInstance()</code>æ–¹æ³•æ ¹æ®ç­–ç•¥ä»£ç å’Œåç§°ï¼Œè¿”å›ç”±<code>SPI</code> <code>ExtensionLoader</code>æŒ‰keyæ¥åŠ è½½å¯¹åº”çš„<code>MatchStrategy</code>å®ç°ç±»ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static MatchStrategy newInstance(final Integer strategy) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String matchMode = MatchModeEnum.getMatchModeByCode(strategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(MatchStrategy.class).getJoin(matchMode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>MatchModeEnum</code> ä¸­å®šä¹‰äº†matchç­–ç•¥çš„codeå’Œnameã€‚ è°ƒç”¨æ—¶ç”±ç­–ç•¥åç§°ï¼Œå¦‚&quot;and&quot;,&quot;or&quot;ï¼Œæ ¹æ®å¯åŠ¨æ—¶SPIåŠ è½½çš„key-valueèµ„æ–™ï¼Œæ‰¾åˆ°å¯¹åº”çš„å®ç°ç±»ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">AND(0, &quot;and&quot;),  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">OR(1, &quot;or&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦ä¸€ä¸ªæ˜¯<code>match()</code>æ–¹æ³•ï¼Œè°ƒç”¨å®ä½œç±»çš„<code>match</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean match(final Integer strategy, final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(strategy).match(conditionDataList, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è°ƒç”¨æ–¹å¼"></a>è°ƒç”¨æ–¹å¼<a class="hash-link" href="#è°ƒç”¨æ–¹å¼" title="Direct link to heading">#</a></h2><p>åœ¨<code>shenyu-plugin</code>æ¨¡ç»„çš„å„ä¸ª<code>plugin</code>çš„åŸºç±»<code>AbstractShenyuPlugin</code> ä¸­ï¼Œå®šä¹‰äº†ä¸¤ä¸ªé€‰æ‹©çš„æ–¹æ³•ï¼š<code>filterSelector</code> å’Œ<code>filterRule</code> å®ƒä»¬éƒ½è°ƒç”¨äº†<code>MatchStrategyFactory</code> æ–¹æ³•ï¼Œä¸‹é¢æ˜¯<code>AbstractShenyuPlugin</code>ä¸­<code>filterSelector</code>æ–¹æ³•çš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterSelector(final SelectorData selector, final ServerWebExchange exchange) {        if (selector.getType() == SelectorTypeEnum.CUSTOM_FLOW.getCode()) {            if (CollectionUtils.isEmpty(selector.getConditionList())) {                return false;            }            return MatchStrategyFactory.match(selector.getMatchMode(), selector.getConditionList(), exchange);        }        return true;    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™æ®µä»£ç ä¸­ï¼Œå…ˆæ£€æµ‹å‚æ•°åŒ¹é…æ¡ä»¶<code>SelectorData</code>æ˜¯å¦ä¸ºç©ºï¼Œä¹‹åè°ƒç”¨<code>MatchStrategyFactory</code>çš„<code>match</code>æ–¹æ³•ï¼Œå·¥å‚æ–¹æ³•å°†è°ƒç”¨å¯¹åº”çš„å®ä½œç±»çš„<code>match</code>æ–¹æ³•ã€‚åŒç†ï¼Œå¦‚ä¸‹æ˜¯<code>AbstractShenyuPlugin</code>ä¸­ <code>filterRule</code> æ–¹æ³•</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterRule(final RuleData ruleData, final ServerWebExchange exchange) {        return ruleData.getEnabled() &amp;&amp; MatchStrategyFactory.match(ruleData.getMatchMode(), ruleData.getConditionDataList(), exchange);    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¹ŸåŒæ ·æ˜¯è°ƒç”¨<code>MatchStrategyFactory</code>çš„<code>match</code>æ–¹æ³•ï¼Œçœ‹ä¸Šå»æ˜¯ä¸æ˜¯ç‰¹åˆ«çš„ç®€æ´ç”šè‡³æ˜¯ç®€å•ï¼Ÿ åœ¨<code>PredicteJudge</code>çš„<a href="http://shenyu.apache.org/blog/PredicateJudge-SPI" target="_blank" rel="noopener noreferrer">ä»£ç åˆ†æ</a>æ–‡ä¸­ï¼Œå¯¹<code>shenyu-plugin</code>å¦‚ä½•åšå‚æ•°è°ƒç”¨æ–¹é¢åšäº†æ›´è¿›ä¸€æ­¥çš„æè¿°ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>ç”±äºåº”ç”¨äº†<code>Apache shenyu</code>çš„<code>SPI</code>æ¡†æ¶ï¼Œä½¿å¾—æ•´ä½“ä¸Šå…·æœ‰æ¾è€¦åˆã€æ˜“äºæ‰©å±•çš„ç‰¹ç‚¹ã€‚åœ¨å¤šä¸ªå‚æ•°è§„åˆ™ç­–ç•¥æ–¹é¢ï¼Œ<code>MatchStrategy</code>æä¾›äº†è‰¯å¥½çš„è®¾è®¡ï¼Œè™½ç„¶ç›®å‰åªæä¾›äº†ä¸¤ä¸ªAND å’ŒORçš„å®ç°ç±»ï¼Œä½†æœªæ¥å¯ä»¥å¾ˆè½»æ¾åœ°æ‰©å±•ä¸ºæ›´å¤š<code>MatchStrategy</code>è§„åˆ™ï¼Œä¾‹å¦‚ <code>firstOf</code>ï¼šå³å¿…é¡»æ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œæˆ–<code>mostOf</code>-æ»¡è¶³å¤§éƒ¨åˆ†æ¡ä»¶ç­‰æ›´å¤šå¤æ‚ç­–ç•¥ï¼Œè€Œå…¶ä»–è°ƒç”¨éƒ¨åˆ†çš„ä»£ç å®Œå…¨ä¸å—å½±å“ã€‚ </p><p>æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»é˜…è¯»<code>Shenyu plugin</code>çš„æºç äº†è§£æ›´å¤šå†…å®¹ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu å¯åŠ¨ç¤ºä¾‹</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T06:06:58.415Z">2023å¹´8æœˆ15æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡<a class="hash-link" href="#ç¯å¢ƒå‡†å¤‡" title="Direct link to heading">#</a></h3><ul><li>æœ¬åœ°æ­£ç¡®å®‰è£…JDK1.8+</li><li>æœ¬åœ°æ­£ç¡®å®‰è£…Git</li><li>æœ¬åœ°æ­£ç¡®å®‰è£…Maven</li><li>é€‰æ‹©ä¸€æ¬¾å¼€å‘å·¥å…·ï¼Œæ¯”å¦‚IDEA</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‹‰å–shenyuä»£ç "></a>æ‹‰å–ShenYuä»£ç <a class="hash-link" href="#æ‹‰å–shenyuä»£ç " title="Direct link to heading">#</a></h3><p>ä½¿ç”¨Gitæ‹‰å–ä»£ç </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/apache/incubator-shenyu.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¼–è¯‘ä»£ç "></a>ç¼–è¯‘ä»£ç <a class="hash-link" href="#ç¼–è¯‘ä»£ç " title="Direct link to heading">#</a></h3><p>ä½¿ç”¨Mavenè¿›è¡Œç¼–è¯‘</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> incubator-shenyu</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨ç½‘å…³æœåŠ¡"></a>å¯åŠ¨ç½‘å…³æœåŠ¡<a class="hash-link" href="#å¯åŠ¨ç½‘å…³æœåŠ¡" title="Direct link to heading">#</a></h3><p>ä½¿ç”¨å¼€å‘å·¥å…·ï¼Œä»¥IDEAä¸ºä¾‹ã€‚</p><p>å¯åŠ¨ <code>shenyu-admin</code> æ§åˆ¶å°ï¼ˆé»˜è®¤ä½¿ç”¨H2æ•°æ®åº“ï¼‰</p><p><img alt="start-demo-admin" src="/zh/assets/images/start-demo-admin-debdd1ee5e979a4892f26e4d54572ead.png"></p><p>å¯åŠ¨ <code>shenyu-bootstrap</code></p><p><img alt="start-demo-bootstrap" src="/zh/assets/images/start-demo-bootstrap-cafa4d22b0d69bb6ee82c01e7b45d239.png"></p><blockquote><p>åˆ°è¿™ä¸€æ­¥ï¼Œshenyuç½‘å…³å·²ç»å¯åŠ¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®adminæ§åˆ¶å°ï¼š<a href="http://localhost:9095/%EF%BC%8C%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E4%B8%BA%EF%BC%9Aadmin/123456" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨åº”ç”¨æœåŠ¡"></a>å¯åŠ¨åº”ç”¨æœåŠ¡<a class="hash-link" href="#å¯åŠ¨åº”ç”¨æœåŠ¡" title="Direct link to heading">#</a></h3><p>Apache ShenYuæä¾›äº†Httpã€Dubboã€SpringCloudç­‰åº”ç”¨æ¥å…¥shenyuç½‘å…³çš„æ ·ä¾‹ï¼Œä½äº <code>shenyu-example</code> æ¨¡å—ï¼Œè¿™é‡Œä»¥HttpæœåŠ¡ä¸ºä¾‹ã€‚</p><p>è‹¥ <code>shenyu-example</code> æœªè¢«IDEAæ ‡è®°ä¸ºMavené¡¹ç›®ï¼Œå¯ä»¥å³é”®ç‚¹å‡» <code>shenyu-example</code> ç›®å½•ä¸‹çš„ <code>pom.xml</code> æ–‡ä»¶ï¼Œå°†å…¶æ·»åŠ ä¸ºMavené¡¹ç›®ã€‚</p><p><img alt="start-demo-maven" src="/zh/assets/images/start-demo-maven-a52eeb99414c79d32a127312a5d22d6f.png"></p><p>å¯åŠ¨ <code>shenyu-examples-http</code>ã€‚</p><p><img alt="start-demo-examples-http" src="/zh/assets/images/start-demo-examples-http-a42235638d82a4be8aeefbb819d419be.png"></p><p>è¿™æ—¶ï¼Œ<code>shenyu-examples-http</code> ä¼šè‡ªåŠ¨æŠŠåŠ  <code>@ShenyuSpringMvcClient</code> æ³¨è§£çš„æ¥å£æ–¹æ³•ï¼Œä»¥åŠapplication.ymlä¸­çš„ç›¸å…³é…ç½®æ³¨å†Œåˆ°ç½‘å…³ã€‚æˆ‘ä»¬æ‰“å¼€adminæ§åˆ¶å°ï¼Œå³å¯åœ¨divideã€context_pathä¸­çœ‹åˆ°ç›¸å…³é…ç½®ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æµ‹è¯•httpè¯·æ±‚"></a>æµ‹è¯•Httpè¯·æ±‚<a class="hash-link" href="#æµ‹è¯•httpè¯·æ±‚" title="Direct link to heading">#</a></h3><p>ä¸‹é¢ä½¿ç”¨<code>postman</code>æ¨¡æ‹Ÿ<code>http</code>çš„æ–¹å¼æ¥è¯·æ±‚ä½ çš„<code>http</code>æœåŠ¡ï¼š</p><p><img alt="start-demo-post-http" src="/zh/assets/images/start-demo-post-http-a7e95883d3147d67e6080236d980d72b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä½¿ç”¨æ›´å¤šæ’ä»¶"></a>ä½¿ç”¨æ›´å¤šæ’ä»¶<a class="hash-link" href="#ä½¿ç”¨æ›´å¤šæ’ä»¶" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="/zh/blog/docs/index">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæ¥ä½¿ç”¨å…¶ä»–çš„æ’ä»¶ã€‚</p><p>è¿™é‡Œä»¥ä½¿ç”¨ param-mapping æ’ä»¶ä¸ºä¾‹ã€‚</p><p>åœ¨ <code>BasicConfig -&gt; Plugin</code> ç¼–è¾‘ param-mapping æ’ä»¶ï¼Œè®¾ç½® <code>status</code>ã€‚</p><p><img alt="start-demo-plugin" src="/zh/assets/images/start-demo-plugin-8525f3812e42bed70e28ce23540069b7.png"></p><p>åœ¨ <code>PluginList -&gt; http process</code> é…ç½®é€‰æ‹©å™¨å’Œè§„åˆ™ã€‚</p><p><img alt="start-demo-selector" src="/zh/assets/images/start-demo-selector-98b0b1ae460bdbed17edc40ab730a182.png"></p><p><img alt="start-demo-rules" src="/zh/assets/images/start-demo-rules-581013f9d7f0f9996b01aab85efcc8e7.png"></p><p>ç„¶åä½¿ç”¨ <code>postman</code> å‘ <code>/http/test/payment</code> å‘èµ·httpè¯·æ±‚ã€‚</p><p><img alt="start-demo-post-param-mapping" src="/zh/assets/images/start-demo-post-param-mapping-d5d632dc96eb1f0080c451820e8f7df4.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-SPI">SPIè®¾è®¡å®ç°æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-09-12T00:00:00.000Z">2022å¹´9æœˆ12æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zjcscut/" target="_blank" rel="noopener noreferrer">Throwable</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="èƒŒæ™¯"></a>èƒŒæ™¯<a class="hash-link" href="#èƒŒæ™¯" title="Direct link to heading">#</a></h2><p>æœ€è¿‘ç ”è¯»<code>Apache</code>å¼€æºé¡¹ç›®<code>Shenyu</code>ç½‘å…³çš„æºç ï¼Œç½‘å…³çš„å¤šä¸ªæ ¸å¿ƒç»„ä»¶åŠ è½½éƒ½ç”¨åˆ°äº†<code>SPI</code>æ¨¡å—ã€‚æœ¬æ–‡å°±<code>Shenyu</code>ä¸­çš„<code>SPI</code>è®¾è®¡å’Œæºç å®ç°è¿›è¡Œåˆ†æã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»€ä¹ˆæ˜¯spi"></a>ä»€ä¹ˆæ˜¯SPI<a class="hash-link" href="#ä»€ä¹ˆæ˜¯spi" title="Direct link to heading">#</a></h2><p><code>SPI</code>å°±æ˜¯<code>Service Provider Interface</code>ï¼Œç›´è¯‘&quot;æœåŠ¡æä¾›æ–¹æ¥å£&quot;ï¼Œæ˜¯ä¸€ç§åŠ¨æ€çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå¯ä»¥åŸºäºæ¥å£è¿è¡Œæ—¶åŠ¨æ€åŠ è½½æ¥å£çš„å®ç°ç±»ï¼ˆä¹Ÿå°±æ˜¯æ¥å£ç¼–ç¨‹ + ç­–ç•¥æ¨¡å¼ + é…ç½®æ–‡ä»¶çš„ä¸€ç§å¼€å‘æ¨¡å¼ï¼‰ã€‚æœ€å¸¸è§çš„å°±æ˜¯<code>JDK</code>å†…ç½®çš„æ•°æ®åº“é©±åŠ¨æ¥å£<code>java.sql.Driver</code>ï¼Œä¸åŒçš„å‚å•†å¯ä»¥å¯¹è¯¥æ¥å£å®Œæˆä¸åŒçš„å®ç°ï¼Œä¾‹å¦‚<code>MySQL</code>ï¼ˆ<code>MySQL</code>é©±åŠ¨åŒ…ä¸­çš„<code>com.mysql.jdbc.Driver</code>ï¼‰ã€<code>PostgreSQL</code>ï¼ˆ<code>PostgreSQL</code>é©±åŠ¨åŒ…ä¸­çš„<code>org.postgresql.Driver</code>ï¼‰ç­‰ç­‰ã€‚</p><p><img alt="spi-jdk-api-diagram" src="/zh/assets/images/spi-jdk-api-diagram-667a15fab78f5b565111dd15c2abb352.png"></p><p><code>JDK</code>å†…ç½®çš„<code>SPI</code>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>åœ¨ç±»è·¯å¾„çš„<code>META-INF/services</code>ç›®å½•åˆ›å»ºä¸€ä¸ªä»¥æ¥å£å…¨é™å®šåç§°å‘½åçš„æ–‡ä»¶ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ª<code>properties</code>ï¼‰æ–‡ä»¶ï¼Œä¾‹å¦‚å‘½åä¸º<code>java.sql.Driver</code></li><li>è¯¥æ–‡ä»¶ä¸­å¯ä»¥æŒ‡å®šå…·ä½“çš„å®ç°ç±»ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªå®ç°ç±»çš„å…¨ç±»å‹é™å®šåä¸ºå•ç‹¬ä¸€è¡Œï¼Œä¾‹å¦‚<code>META-INF/services/java.sql.Driver</code>ä¸­ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># META-INF/services/java.sql.Driveræ–‡ä»¶å†…å®¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">com.mysql.jdbc.Driver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">org.postgresql.Driver</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æœ€åé€šè¿‡<code>java.util.ServiceLoader</code>å¯¹è¯¥æ–‡ä»¶è¿›è¡ŒåŠ è½½ï¼Œå®ä¾‹åŒ–æ¥å£çš„å¯¹åº”å®ç°ç±»ï¼ˆè¿™é‡Œéšå«äº†ä¸€ä¸ªçº¦å®šï¼Œ<strong>æ‰€æœ‰å®ç°ç±»å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°</strong>ï¼‰</li></ul><p>åº•å±‚çš„å®ç°æ¶‰åŠåˆ°ç±»åŠ è½½ã€åŒäº²å§”æ‰˜æ¨¡å‹ç­‰å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ã€‚åŸºäºè¿™ç§è®¾è®¡æ€è·¯ï¼Œå¾ˆå¤šä¸»æµæ¡†æ¶äº†è‡ªå®ç°äº†ä¸€å¥—<code>SPI</code>æ‰©å±•ï¼Œä¾‹å¦‚<code>Dubbo</code>çš„<code>SPI</code>æ‰©å±•æ¨¡å—ï¼Œå°±æ˜¯è¯»å–ç±»è·¯å¾„ä¸‹<code>META-INF/services/dubbo</code>ç›®å½•çš„æ–‡ä»¶å†…å®¹è¿›è¡Œç±»åŠ è½½ã€‚<code>Shenyu-SPI</code>æ¨¡å—ä¹Ÿæ˜¯æ²¿ç”¨ç±»ä¼¼çš„è®¾è®¡æ€è·¯ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-spiæºç åˆ†æ"></a>shenyu-spiæºç åˆ†æ<a class="hash-link" href="#shenyu-spiæºç åˆ†æ" title="Direct link to heading">#</a></h2><p><code>shenyu-spi</code>æ¨¡å—ååˆ†ç²¾ç‚¼ï¼Œä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">- shenyu-spi[module]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  - org.apache.shenyu.spi[package]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SpiExtensionFactory</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™äº›ç±»åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li><code>ExtensionFactory</code>ï¼š<code>SPI</code>åŠ è½½å™¨å·¥å‚ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª<code>SPI</code>ï¼Œç”¨äºåŸºäº<code>SPI</code>æœºåˆ¶åŠ è½½<code>ExtensionLoader</code>å®ä¾‹åŒæ—¶åŸºäº<code>ExtensionLoader</code>å®ä¾‹è·å–é»˜è®¤çš„<code>SPI</code>æ ‡è¯†æ¥å£å®ç°</li><li><code>SpiExtensionFactory</code>ï¼šå…¶å®å°±æ˜¯<code>ExtensionFactory</code>çš„ä¸€ä¸ªå®ç°ç±»</li><li><code>SPI</code>ï¼šæ ‡è¯†æ³¨è§£ï¼Œç”¨äºæ ‡è¯†<code>SPI</code>ï¼Œç”¨äºæ¥å£ä¸Š</li><li><code>Join</code>ï¼šæ ‡è¯†æ³¨è§£ï¼Œç”¨äºå®ç°ç±»ä¸Šï¼Œç”¨äºæ ‡è¯†è¯¥ç±»åŠ å…¥<code>SPI</code>ç³»ç»Ÿ</li><li><code>ExtensionLoader</code>ï¼š<code>SPI</code>åŠ è½½å™¨ï¼Œç±»æ¯”<code>java.util.ServiceLoader</code>ï¼Œç”¨äºåŠ è½½<code>SPI</code>ä¸­æ¥å£çš„å®ç°ç±»</li></ul><p>æ¥ä¸‹æ¥ç»†çœ‹æ¯ä¸ªç±»çš„æºç å®ç°ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi"></a>@SPI<a class="hash-link" href="#spi" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.SPI</code>ä½œä¸ºä¸€ä¸ªæ ‡è¯†æ³¨è§£ï¼Œä¸»è¦ç”¨äº<strong>æ¥å£</strong>ä¸Šï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä½¿ç”¨äº†<code>@SPI</code>çš„æ¥å£æ‰èƒ½è¢«<code>shenyu-spi</code>åŠ è½½ã€‚è¿™ä¸ªç±»çš„æ³¨é‡Šä¸­æè¿°åˆ°ï¼šæ‰€æœ‰<code>SPI</code>ç³»ç»Ÿç›¸å…³å‚è€ƒ<code>Apache Dubbo</code>çš„å®ç°ï¼ˆè¿™ä¸€ç‚¹æ¯”è¾ƒåˆæƒ…ç†ï¼Œå…¶å®<code>SPI</code>æ‰©å±•å·²ç»æ˜¯ä¸€ç§æˆç†Ÿçš„æ–¹æ¡ˆï¼Œå®ç°ä¸Šå¤§åŒå°å¼‚ï¼‰ã€‚è¯¥æ³¨è§£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface SPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Value string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the string</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å”¯ä¸€çš„<code>value()</code>æ–¹æ³•ç”¨äºæŒ‡å®šé»˜è®¤çš„<code>SPI</code>å®ç°ï¼ˆå¯é€‰çš„ï¼‰ï¼Œåæ–‡åœ¨å±•å¼€<code>ExtensionLoader</code>æ—¶å€™ä¼šè¯´æ˜ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="join"></a>@Join<a class="hash-link" href="#join" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.Join</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ ‡è¯†æ³¨è§£ï¼Œä¸»è¦ç”¨åœ¨ä½¿ç”¨äº†<code>@SPI</code>æ³¨è§£çš„æ¥å£çš„<strong>å®ç°ç±»</strong>ä¸Šï¼Œç”¨äºæ ‡è¯†è¯¥ç±»åŠ å…¥<code>SPI</code>ç³»ç»Ÿä¸­è€Œåå¯ä»¥è¢«<code>ExtensionLoader</code>åŠ è½½ã€‚è¯¥æ³¨è§£ä¹Ÿåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å”¯ä¸€çš„<code>order()</code>æ–¹æ³•ç”¨äºæŒ‡å®šå…·ä½“çš„é¡ºåºå·ï¼Œå•ä¸ªä½¿ç”¨äº†<code>@SPI</code>çš„æ¥å£å­˜åœ¨å¤šä¸ªä½¿ç”¨äº†<code>@Join</code>çš„å®ç°ç±»çš„æ—¶å€™ï¼Œè¿™ä¸ªé¡ºåºå·å°±ç¡®å®šäº†è¿™äº›å®ç°ç±»å®ä¾‹çš„æ’åºï¼ˆé¡ºåºå·å°çš„æ’åœ¨å‰é¢ï¼‰ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionloader"></a>ExtensionLoader<a class="hash-link" href="#extensionloader" title="Direct link to heading">#</a></h3><p><code>ExtensionLoader</code>å°±æ˜¯&quot;ç±»å‹æ‰©å±•åŠ è½½å™¨&quot;ï¼Œå°±æ˜¯æ•´ä¸ª<code>SPI</code>æ¨¡å—çš„æ ¸å¿ƒã€‚å…ˆçœ‹å…¶æˆå‘˜å±æ€§ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ExtensionLoader&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SLF4Jæ—¥å¿—å¥æŸ„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(ExtensionLoader.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SPIé…ç½®æ–‡ä»¶åŸºäºç±»è·¯å¾„ä¸‹çš„ç›¸å¯¹ç›®å½•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // @SPIæ ‡è¯†æ¥å£ç±»å‹ -&gt; ExtensionLoaderå®ä¾‹çš„ç¼“å­˜ =&gt; æ³¨æ„è¿™ä¸ªæ˜¯ä¸€ä¸ªå…¨å±€çš„é™æ€å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; LOADERS = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰@SPIæ ‡è¯†æ¥å£ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Class&lt;T&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ClassLoader classLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜¯ä¸€ä¸ªHashMapï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»åˆ«å -&gt; å®ç°ç±»ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Holder&lt;Map&lt;String, ClassEntity&gt;&gt; cachedClasses = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»å®ä¾‹çš„å€¼åŒ…è£…å™¨ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»åˆ«å -&gt; å€¼æŒæœ‰å™¨åŒ…è£…çš„å®ç°ç±»å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»å®ä¾‹ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»ç±»å‹ -&gt; å®ç°ç±»å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;Class&lt;?&gt;, Object&gt; joinInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜é»˜è®¤åç§°ï¼Œæ¥æºäº@SPIæ³¨è§£çš„value()æ–¹æ³•éç©ºç™½è¿”å›å€¼ï¼Œç”¨äºåŠ è½½é»˜è®¤çš„æ¥å£å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String cachedDefaultName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Holderæ¯”è¾ƒå™¨ï¼ŒæŒ‰ç…§Holderçš„orderé™åºï¼Œä¹Ÿå°±æ˜¯é¡ºåºå·å°çš„æ’åœ¨å‰é¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;Holder&lt;Object&gt;&gt; holderComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ClassEntityæ¯”è¾ƒå™¨ï¼ŒæŒ‰ç…§ClassEntityçš„orderé™åºï¼Œä¹Ÿå°±æ˜¯é¡ºåºå·å°çš„æ’åœ¨å‰é¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;ClassEntity&gt; classEntityComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æš‚æ—¶çœç•¥å…¶ä»–ä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å€¼æŒæœ‰å™¨ï¼Œç®€å•VOï¼Œç”¨æ¥å­˜å‚¨æ³›å‹å€¼å’Œå€¼åŠ è½½é¡ºåº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class Holder&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œçš„å€¼å¼•ç”¨æ˜¯volatileä¿®é¥°ï¼Œä¾¿äºæŸçº¿ç¨‹æ›´å˜å¦ä¸€çº¿ç¨‹é©¬ä¸Šè¯»åˆ°æœ€æ–°çš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private volatile T value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // çœç•¥setterå’Œgetterä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»å®ä½“ï¼Œä¸»è¦å­˜æ”¾åŠ è½½çš„å®ç°ç±»çš„ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final class ClassEntity {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åç§°ï¼Œè¿™é‡Œæ˜¯æŒ‡SPIå®ç°ç±»çš„åˆ«åï¼Œä¸æ˜¯ç±»å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŠ è½½é¡ºåºå·</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // SPIå®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Class&lt;?&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private ClassEntity(final String name, final Integer order, final Class&lt;?&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.name = name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.order = order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // çœç•¥setterå’Œgetterä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ†æå®Œæˆå‘˜å±æ€§ï¼Œä¸éš¾å‘ç°ä¸‹é¢å‡ ç‚¹ï¼š</p><ul><li><code>ExtensionLoader</code>ä¼šå­˜åœ¨ä¸€ä¸ªå…¨å±€çš„é™æ€ç¼“å­˜<code>LOADERS</code>ï¼Œç¼“å­˜å·²ç»åˆ›å»ºçš„<code>ExtensionLoader</code>å®ä¾‹ä»¥é˜²æ­¢é‡å¤åˆ›å»ºçš„æ€§èƒ½å¼€é”€</li><li>æ¯ä¸ª<code>@SPI</code>æ ‡è®°çš„æ¥å£å¦‚æœä½¿ç”¨<code>ExtensionLoader</code>è¿›è¡ŒåŠ è½½ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„<code>ExtensionLoader</code>å®ä¾‹</li><li><code>@SPI</code>æ ‡è®°çš„æ¥å£å¦‚æœæœ‰å¤šä¸ªå®ç°ï¼Œé‚£ä¹ˆæœ€ç»ˆè·å–åˆ°è¿™äº›å®ç°å®ä¾‹çš„æ—¶å€™æ˜¯æœ‰åºçš„</li></ul><p>æ¥ç€çœ‹å…¶æ„é€ å‡½æ•°å’Œé™æ€å·¥å‚æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ç§æœ‰æ„é€ å‡½æ•°ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private ExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆå‘˜å˜é‡clazzèµ‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆå‘˜å˜é‡classLoaderèµ‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.classLoader = cl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œå¯¹äºéExtensionFactoryæ¥å£ç±»å‹ä¼šæ‡’åŠ è½½ä¸€ä¸ªç”¨äºåŠ è½½ExtensionFactoryçš„ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Objects.equals(clazz, ExtensionFactory.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getExtensionClassesEntity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®ä¾‹åŒ–getExtensionLoaderï¼Œé™æ€å·¥å‚æ–¹æ³•ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‰ç¼€æ ¡éªŒï¼Œæ¥å£ç±»å‹å¿…é¡»éç©ºå¹¶ä¸”å¿…é¡»å­˜åœ¨@SPIæ³¨è§£ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ä¸­æ–­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Objects.requireNonNull(clazz, &quot;extension clazz is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isInterface()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) is not interface!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAnnotationPresent(SPI.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) without @&quot; + SPI.class + &quot; Annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»ç¼“å­˜LOADERSä¸­åŠ è½½ExtensionLoaderå®ä¾‹ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå…¸å‹çš„æ‡’åŠ è½½æ¨¡å¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExtensionLoader&lt;T&gt; extensionLoader = (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(extensionLoader)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extensionLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOADERS.putIfAbsent(clazz, new ExtensionLoader&lt;&gt;(clazz, cl));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®ä¾‹åŒ–getExtensionLoaderï¼Œé™æ€å·¥å‚æ–¹æ³•ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹ï¼Œä½¿ç”¨ExtensionLoaderç±»çš„ç±»åŠ è½½å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getExtensionLoader(clazz, ExtensionLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ExtensionLoader</code>ä½¿ç”¨äº†ç§æœ‰æ„é€ å™¨ï¼Œä½¿ç”¨äº†é™æ€å·¥å‚æ–¹æ³•å’Œæ‡’åŠ è½½æ¨¡å¼ã€‚åˆå§‹åŒ–<code>ExtensionLoader</code>å®Œæˆåå¹¶ä¸ä¼šè§¦å‘ç±»åŠ è½½å·¥ä½œï¼ŒçœŸæ­£çš„æ‰«æå’ŒåŠ è½½è¡Œä¸ºå»¶è¿Ÿåˆ°è°ƒç”¨<code>getJoin</code>ç³»åˆ—æ–¹æ³•æ‰§è¡Œï¼Œè¿™é‡Œæ‰«ç å’ŒåŠ è½½æ‰€æœ‰å®ç°ç±»ä¿¡æ¯çš„æ–¹æ³•è°ƒç”¨é“¾ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½æ‰€æœ‰æ‰©å±•ç±»ä¿¡æ¯ï¼Œè¿™é‡Œé‡‡ç”¨äº†DCLï¼ˆåŒé‡é”æ ¡éªŒï¼‰é˜²æ­¢å¹¶å‘åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; getExtensionClassesEntity() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜ä¸å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŠ é”åå†æ£€æŸ¥ä¸€æ¬¡ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedClasses) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æœ€ç»ˆç¡®è®¤ç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŠ è½½ï¼Œå¹¶ä¸”æ ‡è®°é¡ºåºå·ä¸º0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                classes = loadExtensionClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setValue(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setOrder(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½å½“å‰ExtensionLoaderä¸­clazzçš„æ‰€æœ‰SPIç³»ç»Ÿå†…çš„å®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; loadExtensionClass() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SPI annotation = clazz.getAnnotation(SPI.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(annotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œå°±æ˜¯å‰é¢æåˆ°ï¼Œå¦‚æœ@SPIæ³¨è§£çš„value()æ–¹æ³•éç©ºç™½è¿”å›å€¼ä¼šä½œä¸ºé»˜è®¤å®ç°çš„åˆ«å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¹Ÿå°±æ˜¯å¦‚æœåªä½¿ç”¨äº†@SPIï¼Œé‚£ä¹ˆå°±æ— æ³•è·å–é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœä½¿ç”¨äº†@SPI(&quot;foo&quot;)ï¼Œå¯ä»¥é€šè¿‡åˆ«åfooå»æ˜ å°„å’Œè·å–é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String value = annotation.value();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cachedDefaultName = value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆå§‹åŒ–ä¸€ä¸ªHashmapå®¹å™¨ç”¨äºå­˜å‚¨åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œè¿™ä¸ªå˜é‡ä¼šé€ä¼ åˆ°ä¸‹ä¸€ä¸ªæ–¹æ³•é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = new HashMap&lt;&gt;(16);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åŠ è½½ç›®å½•ä¸­çš„å±æ€§æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadDirectory(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½ç›®å½•ä¸­çš„å±æ€§æ–‡ä»¶ï¼Œå¹¶ä¸”åŠ è½½æ–‡ä»¶ä¸­çš„å®ç°ç±»ï¼Œç›®æ ‡ç›®å½•ï¼šMETA-INF/shenyu/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadDirectory(final Map&lt;String, ClassEntity&gt; classes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ–‡ä»¶å =&gt; META-INF/shenyu/$className</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = SHENYU_DIRECTORY + clazz.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½æ–‡ä»¶èµ„æºï¼Œå¦‚æœä¼ å…¥çš„ç±»åŠ è½½å™¨ä¸ºç©ºä¼šä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;URL&gt; urls = Objects.nonNull(this.classLoader) ? classLoader.getResources(fileName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : ClassLoader.getSystemResources(fileName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†è§£æçš„æ–‡ä»¶URLé›†åˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(urls)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (urls.hasMoreElements()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                URL url = urls.nextElement();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // é€šè¿‡æ–‡ä»¶URLåŠ è½½èµ„æº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                loadResources(classes, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.error(&quot;load extension class error {}&quot;, fileName, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½æ–‡ä»¶èµ„æºï¼Œè§£ææ–‡ä»¶å¹¶ä¸”åŠ è½½å®ç°ç±»å­˜å‚¨åˆ°classesä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadResources(final Map&lt;String, ClassEntity&gt; classes, final URL url) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¯»å–URLæ–‡ä»¶èµ„æºï¼ŒåŠ è½½åˆ°Propertiesä¸­ï¼Œæ¯è¡Œæ ¼å¼ä¸ºname=classPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (InputStream inputStream = url.openStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.load(inputStream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.forEach((k, v) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String name = (String) k;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String classPath = (String) v;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(name) &amp;&amp; StringUtils.isNotBlank(classPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // åŸºäºnameå’ŒclassPathè¿›è¡Œç±»åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    loadClass(classes, name, classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (ClassNotFoundException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºnameï¼ˆåˆ«åï¼‰å’ŒclassPathï¼ˆç±»å…¨é™å®šåç§°ï¼‰è¿›è¡Œç±»åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadClass(final Map&lt;String, ClassEntity&gt; classes,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String name, final String classPath) throws ClassNotFoundException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»åˆå§‹åŒ–ï¼Œå¹¶ä¸”ç¡®å®šå®ç°ç±»å¿…é¡»æ˜¯å½“å‰@SPIæ³¨è§£æ ‡è¯†æ¥å£çš„å­ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; subClass = Objects.nonNull(this.classLoader) ? Class.forName(classPath, true, this.classLoader) : Class.forName(classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAssignableFrom(subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; subtype is not of &quot; + clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å®ç°ç±»å¿…é¡»å­˜åœ¨æ³¨è§£@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!subClass.isAnnotationPresent(Join.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; without @&quot; + Join.class + &quot; annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨åŒæ ·åˆ«åçš„å®ç°ç±»æ‰è¿›è¡Œç¼“å­˜ï¼Œå·²ç»å­˜åœ¨åˆ™æ ¡éªŒæ—§çš„ç±»å‹å’Œå½“å‰å®ç°ç±»å‹æ˜¯å¦ä¸€è‡´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity oldClassEntity = classes.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(oldClassEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºç±»ä¿¡æ¯å®ä½“ä¿å­˜åˆ«åã€é¡ºåºå·å’Œå®ç°ç±»å¹¶ä¸”ç¼“å­˜ï¼Œæ˜ å°„å…³ç³»ï¼šåˆ«å -&gt; ç±»ä¿¡æ¯å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Join joinAnnotation = subClass.getAnnotation(Join.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassEntity classEntity = new ClassEntity(name, joinAnnotation.order(), subClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classes.put(name, classEntity);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (!Objects.equals(oldClassEntity.getClazz(), subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,Duplicate class &quot; + clazz.getName() + &quot; name &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                + name + &quot; on &quot; + oldClassEntity.getClazz().getName() + &quot; or &quot; + subClass.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡æ–¹æ³•é“¾<code>getExtensionClassesEntity -&gt; loadExtensionClass -&gt; loadDirectory -&gt; loadResources -&gt; loadClass</code>æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªåˆ«å<code>-&gt;</code>å®ç°ç±»ä¿¡æ¯çš„æ˜ å°„ï¼Œç”¨äºåç»­çš„å®ä¾‹åŒ–ï¼Œè§<code>getJoin()</code>æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºåˆ«åè·å–å®ç°ç±»å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public T getJoin(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ«åå¿…é¡»ä¸ºéç©ºç™½å­—ç¬¦ä¸²</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(name)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NullPointerException(&quot;get join name is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œä¹Ÿä½¿ç”¨DCLå»cachedInstancesç¼“å­˜ä¸­å–åˆ«åå¯¹åº”çš„å€¼æŒæœ‰å™¨ï¼Œå€¼æŒæœ‰å™¨ä¸ºç©ºåˆ™åˆ›å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;Object&gt; objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(objectHolder)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedInstances.putIfAbsent(name, new Holder&lt;&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedInstances) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŠ é”åå†æ¬¡åˆ¤æ–­å€¼æŒæœ‰å™¨ä¸­çš„å€¼æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„æ—¶å€™åˆ™è¿›è¡Œå®ç°ç±»å®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Holder&lt;T&gt; pair = createExtension(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                value = pair.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                int order = pair.getOrder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å®ä¾‹åŒ–å®Œæˆåæ›´æ–°å€¼æŒæœ‰å™¨ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setValue(value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setOrder(order);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (T) value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºåˆ«åæœç´¢å·²ç»åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œå¹¶ä¸”å®ä¾‹åŒ–å¯¹åº”çš„å®ç°ç±»è¿›è¡Œå€¼åŒ…è£…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Holder&lt;T&gt; createExtension(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åŠ è½½è¯¥@SPIæ ‡è¯†æ¥å£çš„æ‰€æœ‰å®ç°ç±»ä¿¡æ¯å¹¶ä¸”è·å–å¯¹åº”åˆ«åçš„å®ç°ç±»ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity classEntity = getExtensionClassesEntity().get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;name is error&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; aClass = classEntity.getClazz();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœå®ç°ç±»å®ä¾‹ç¼“å­˜ä¸­å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥å°è£…ä¸ºå€¼åŒ…è£…å™¨è¿”å›ï¼Œå¦åˆ™è¿›è¡Œå®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(o)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åå°„å®ä¾‹åŒ–å¹¶ä¸”ç¼“å­˜è¯¥å®ç°ç±»å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            joinInstances.putIfAbsent(aClass, aClass.newInstance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InstantiationException | IllegalAccessException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Extension instance(name: &quot; + name + &quot;, class: &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + aClass + &quot;)  could not be instantiated: &quot; + e.getMessage(), e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;T&gt; objectHolder = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setOrder(classEntity.getOrder());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setValue((T) o);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return objectHolder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»<code>createExtension()</code>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯ä½¿ç”¨åå°„æ–¹å¼å®ä¾‹åŒ–å®ç°ç±»ï¼Œåå°„æ–¹æ³•<code>newInstance()</code>è¦æ±‚è¯¥ç±»å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°ï¼Œå› ä¸ºè¿™é‡Œæœ‰ä¸€ç‚¹éšå«çš„çº¦å®šï¼š<code>SPI</code>å®ç°ç±»<strong>å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°</strong>ï¼Œå¦åˆ™ä¼šå®ä¾‹åŒ–å¤±è´¥ã€‚å‰©ä½™çš„<code>getDefaultJoin()</code>å’Œ<code>getJoins()</code>æ˜¯åŸºäº<code>getJoin()</code>æ–¹æ³•è¿›è¡Œæ‰©å±•ï¼ŒåŠŸèƒ½å¹¶ä¸å¤æ‚ï¼Œè¿™é‡Œå°±ä¸å±•å¼€åˆ†æäº†ã€‚å¦å¤–ï¼Œåœ¨<code>getJoin()</code>æ–¹æ³•ç”¨åˆ°äº†å¤šçº§ç¼“å­˜ï¼š</p><ul><li><code>cachedInstances</code>ï¼šé€šè¿‡åˆ«åå°±å¯ä»¥æœç´¢åˆ°å¯¹åº”çš„å®ç°ç±»å®ä¾‹</li><li><code>joinInstances</code>ï¼šåˆ«åæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™åŠ è½½æ‰€æœ‰å®ç°ç±»ä¿¡æ¯ï¼Œç„¶åé€šè¿‡åˆ«åå®šä½å®ç°ç±»ç±»å‹ï¼Œå†é€šè¿‡å®ç°ç±»ç±»å‹æŸ¥æ‰¾æˆ–è€…åˆ›å»ºå¹¶ç¼“å­˜å®ç°ç±»å®ä¾‹åæ›´æ–°<code>cachedInstances</code>ç¼“å­˜</li></ul><p>åˆ°æ­¤ï¼Œ<code>ExtensionLoader</code>çš„æºç åˆ†æå®Œæ¯•ã€‚è¿™é‡Œå†é€šè¿‡ä¸€ä¸ª<code>ExtensionLoader</code>å®ä¾‹æˆå‘˜å±æ€§å†…å­˜å¸ƒå±€å›¾å¯ä»¥åŠ æ·±ç†è§£ï¼š</p><p><img alt="spi-attr-memory-debug" src="/zh/assets/images/spi-attr-memory-debug-fbcf742eb342ba1aa47e9395bf8ffc0c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionfactory"></a>ExtensionFactory<a class="hash-link" href="#extensionfactory" title="Direct link to heading">#</a></h3><p><code>ExtensionFactory</code>æ˜¯å·¥å‚æ¨¡å¼é‡Œé¢çš„å·¥å‚æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸€ä¸ªè·å–<code>SPI</code>å®ç°ï¼ˆ<strong>é»˜è®¤å®ç°ï¼Œå”¯ä¸€</strong>ï¼‰å®ä¾‹çš„æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI(&quot;spi&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets Extension.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt;   the type parameter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param key   æ­¤å‚æ•°æš‚æ—¶æ²¡æœ‰ä½¿ç”¨ï¼ŒçŒœæµ‹æ˜¯é¢„ç•™ç”¨äºæ˜ å°„@SPIçš„value()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param clazz @SPIæ ‡è¯†çš„æ¥å£ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the extension</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getExtension(String key, Class&lt;T&gt; clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥ç€çœ‹å…¶å®ç°ç±»<code>SpiExtensionFactory</code>çš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpiExtensionFactory implements ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; T getExtension(final String key, final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Optional.ofNullable(clazz)   // å…¥å‚clazzéç©º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Class::isInterface)  // å…¥å‚clazzå¿…é¡»æ˜¯æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(cls -&gt; cls.isAnnotationPresent(SPI.class))  // å…¥å‚clazzå¿…é¡»è¢«@SPIæ ‡è¯†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getExtensionLoader)  // åŸºäºclazzè¿™ä¸ªæ¥å£ç±»å‹å®ä¾‹åŒ–ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getDefaultJoin)  // è·å–è¯¥@SPIæ ‡è¯†æ¥å£çš„é»˜è®¤å®ç°ï¼Œä¸å­˜åœ¨åˆ™è¿”å›NULL</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š<code>ExtensionFactory</code>æœ¬èº«ä¹Ÿæ˜¯<code>SPI</code>ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ä½¿ç”¨<code>ExtensionFactory</code>çš„æ—¶å€™å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = new SpiExtensionFactory();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¹Ÿå¯ä»¥åŸºäº<code>ExtensionLoader</code>è¿›è¡ŒåŠ è½½ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># åœ¨ç±»è·¯å¾„META-INF/services/shenyuç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªå±æ€§æ–‡ä»¶org.apache.shenyu.spi.ExtensionFactoryï¼Œå†…å®¹æ˜¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">spi=org.apache.shenyu.spi.SpiExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># ç„¶ååŸºäºExtensionLoaderè¿›è¡ŒåŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getDefaultJoin();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¾—åˆ°<code>ExtensionFactory</code>å®ä¾‹åå°±å¯ä»¥åŸºäº<code>@SPI</code>æ¥å£åŠ è½½å…¶é»˜è®¤å®ç°ç±»çš„å®ä¾‹ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‰©å±•å’Œå»ºè®®"></a>æ‰©å±•å’Œå»ºè®®<a class="hash-link" href="#æ‰©å±•å’Œå»ºè®®" title="Direct link to heading">#</a></h2><p>ä¸‹é¢æ˜¯ä¸ªäººçš„ä¸€äº›è§è§£ã€‚ç›®å‰æ¥çœ‹ï¼Œ<code>Shenyu</code>ä¸­çš„<code>SPI</code>æ¨¡å—åŠŸèƒ½æ˜¯å®Œå¤‡çš„ï¼Œå»ºè®®è€ƒè™‘å¼•å…¥ä¸¤ä¸ªå¸¸ç”¨çš„åŠŸèƒ½ï¼š</p><ul><li>å¯ä»¥åœ¨<code>Join</code>æ³¨è§£ä¸­æ·»åŠ å±æ€§æ ‡è®°<code>SPI</code>æ¥å£å®ç°ç±»ç”Ÿæˆçš„å®ä¾‹æ˜¯å•ä¾‹è¿˜æ˜¯å…¨æ–°å®ä¾‹ï¼Œç±»ä¼¼äº<code>Spring</code>ä¸­çš„<code>Scope</code>å£°æ˜ï¼ˆ<code>singleton</code>æˆ–è€…<code>prototype</code>ï¼‰é‚£æ ·ï¼Œä¾‹å¦‚ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The join class instance should be singleton or not</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true or false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isSingleton() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>å¯é€‰åœ°</strong>è®©<code>SPI</code>çš„å®ç°ç±»å®ç°ä¸€ä¸ªåˆå§‹åŒ–å™¨æ¥å£ï¼Œåœ¨è¯¥å®ç°ç±»å®ä¾‹åŒ–åå›è°ƒåˆå§‹åŒ–å™¨æ¥å£æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionInitializer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void init();  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * demo</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface JdbcSPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getClassName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MysqlSPI implements JdbcSPI, ExtensionInitializer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // callback when MysqlSPI instance init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getClassName() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;mysql&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦‚æœæ·»åŠ äº†è¿™ä¸¤ç‚¹ï¼Œèƒ½å¤Ÿæ»¡è¶³å¾ˆå¤šç°å®åœºæ™¯çš„éœ€æ±‚ã€‚å¦å¤–ï¼Œ<code>ExtensionLoader</code>ä¸­çš„ä¸¤å¤„æ¯”è¾ƒå™¨æˆå‘˜å˜é‡å¯ä»¥è¿›è¡Œä»£ç ç²¾ç®€ï¼Œä¾‹å¦‚å¯¹<code>classEntityComparator</code>è€Œè¨€ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final Comparator&lt;ClassEntity&gt; classEntityComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¯ä»¥ç²¾ç®€ä¸ºComparatoræä¾›çš„é™æ€å·¥å‚æ–¹æ³•å’Œæ–¹æ³•å¼•ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private final Comparator&lt;ClassEntity&gt; classEntityComparator = Comparator.comparing(ClassEntity::getOrder);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å°ç»“"></a>å°ç»“<a class="hash-link" href="#å°ç»“" title="Direct link to heading">#</a></h2><p>åŸºäº<code>Java</code>åŸç”Ÿ<code>SPI</code>è®¾è®¡æ€è·¯ä¸Šè®¾è®¡å‡ºæ¥çš„<code>SPI</code>æ¡†æ¶å…·å¤‡äº†æ¾è€¦åˆã€é«˜æ˜“ç”¨æ€§å’Œé«˜æ‰©å±•æ€§çš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”æ·»åŠ äº†åŠ è½½å®ä¾‹ç¼“å­˜ã€å¹¶å‘å®‰å…¨ç­‰ç‰¹æ€§ï¼Œå¡«è¡¥äº†åŸç”Ÿ<code>JDK</code>ä¸­<code>SPI</code>çš„ä¸€äº›ç¼ºé™·ï¼Œ<code>Shenyu</code>çš„<code>SPI</code>æ¨¡å—ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ­£æ˜¯ç”±äºæ­¤å¼ºå¤§çš„<code>SPI</code>æ¨¡å—çš„å­˜åœ¨ï¼Œ<code>Shenyu</code>ä¸­çš„å…¶ä»–æ¨¡å—å¦‚<code>Plugin</code>æ¨¡å—å¯ä»¥å®ç°å¿«é€Ÿæ’æ‹”å¼é…ç½®ï¼Œè®©åŠ è½½ä¸€ä¸ªå…¨æ–°å¼€å‘çš„æ’ä»¶å®ä¾‹å˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div></div>
<script src="/zh/assets/js/runtime~main.a7fede36.js"></script>
<script src="/zh/assets/js/main.e868eba5.js"></script>
</body>
</html>