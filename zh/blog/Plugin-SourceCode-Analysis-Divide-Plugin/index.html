<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Divide插件源码分析 | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Divide插件源码分析 | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Apache ShenYu 是一个异步的，高性能的，跨语言的，响应式的 API 网关。"><meta data-react-helmet="true" property="og:description" content="Apache ShenYu 是一个异步的，高性能的，跨语言的，响应式的 API 网关。"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Plugin-SourceCode-Analysis-Divide-Plugin" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Plugin-SourceCode-Analysis-Divide-Plugin" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.6bd5fa92.css">
<link rel="preload" href="/zh/assets/js/runtime~main.c1361167.js" as="script">
<link rel="preload" href="/zh/assets/js/main.e3824e15.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">下载</a><a class="navbar__item navbar__link" href="/zh/document">文档</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">社区</a><a class="navbar__item navbar__link" href="/zh/team">团队</a><a class="navbar__item navbar__link" href="/zh/event">事件</a><a class="navbar__item navbar__link" href="/zh/news">新闻</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a><a class="navbar__item navbar__link" href="/zh/users">用户</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog/Plugin-SourceCode-Analysis-Divide-Plugin" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="blogPostTitle_d4p0">Divide插件源码分析</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-01-06T13:38:58.030Z">2024年1月6日</time> · One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> 是一个异步的，高性能的，跨语言的，响应式的 <code>API</code> 网关。</p></blockquote><p><code>ShenYu</code> 网关使用 <code>divide</code> 插件来处理 <code>http</code> 请求。你可以查看官方文档 <a href="https://shenyu.apache.org/zh/docs/next/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Http快速开始</a> 了解如何使用该插件。</p><blockquote><p>本文基于<code>shenyu-2.4.3</code>版本进行源码分析，官网的介绍请参考 <a href="https://shenyu.apache.org/zh/docs/next/user-guide/http-proxy" target="_blank" rel="noopener noreferrer">Http服务接入</a> 。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-服务注册"></a>1. 服务注册<a class="hash-link" href="#1-服务注册" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--声明注册接口"></a>1.1  声明注册接口<a class="hash-link" href="#11--声明注册接口" title="Direct link to heading">#</a></h4><p>使用注解<code>@ShenyuSpringMvcClient</code>将服务注册到网关。简单<code>demo</code>如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)  // API注册</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/findById&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/findById&quot;, desc = &quot;Find by id&quot;) // 方法注册</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO findById(@RequestParam(&quot;id&quot;) final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return build(id, &quot;hello world findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>注解定义：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 作用于类和方法上</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //规则名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //描述信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //是否启用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-扫描注解信息"></a>1.2 扫描注解信息<a class="hash-link" href="#12-扫描注解信息" title="Direct link to heading">#</a></h4><p>注解扫描通过<code>SpringMvcClientBeanPostProcessor</code>完成，它实现了<code>BeanPostProcessor</code>接口，是<code>Spring</code>提供的后置处理器。</p><p>在构造器实例化的过程中：</p><ul><li>读取属性配置</li><li>添加注解，读取<code>path</code>信息</li><li>启动注册中心，向<code>shenyu-admin</code>注册</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientBeanPostProcessor implements BeanPostProcessor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 构造器实例化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientBeanPostProcessor(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 读取属性配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;http register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 添加注解</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PostMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(GetMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(DeleteMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PutMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. 启动注册中心</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // 重写后置处理器逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>SpringMvcClientBeanPostProcessor#postProcessAfterInitialization()</li></ul><p>重写后置处理器逻辑：读取注解信息，构建元数据对象和<code>URI</code>对象，并向<code>shenyu-admin</code>注册。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 如果是注册整个服务或者不是Controller类，就不处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull) || !hasAnnotation(bean.getClass(), Controller.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 读取类上的注解 ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuSpringMvcClient beanShenyuClient = AnnotationUtils.findAnnotation(bean.getClass(), ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1构建superPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.2 是否注册整个类方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 构建元数据对象，然后向shenyu-admin注册</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(beanShenyuClient, pathJoin(contextPath, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. 读取所有方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3.1 读取方法上的注解 ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuSpringMvcClient methodShenyuClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果方法上面没有注解，就用类上面的注解</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // 3.2 构建path信息，构建元数据对象，向shenyu-admin注册</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(methodShenyuClient, buildApiPath(method, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>1.如果是注册整个服务或者不是<code>Controller</code>类，就不处理</li><li>2.读取类上的注解 <code>ShenyuSpringMvcClient</code>，如果是注册整个类，就在这里构建元数据对象，然后向<code>shenyu-admin</code>注册</li><li>3.处理方法上的注解 <code>ShenyuSpringMvcClient</code>，针对特定方法构建<code>path</code>信息，构建元数据对象，然后向<code>shenyu-admin</code>注册</li></ul><p>这里有两个取<code>path</code>的方法，需要特别说明一下：</p><ul><li><p>buildApiSuperPath()</p><p>构造<code>SuperPath</code>：先从类上的注解<code>ShenyuSpringMvcClient</code>取<code>path</code>属性，如果没有，就从当前类的<code>RequestMapping</code>注解中取<code>path</code>信息。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiSuperPath(@NonNull final Class&lt;?&gt; method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 先从类上的注解ShenyuSpringMvcClient取path属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return shenyuSpringMvcClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 从当前类的RequestMapping注解中取path信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildApiPath()</p><p>构建<code>path</code>：先读取方法上的注解<code>ShenyuSpringMvcClient</code>，如果存在就构建；否则从方法的其他注解上获取<code>path</code>信息；完整的<code>path = contextPath(上下文信息)+superPath(类信息)+methodPath(方法信息)</code>。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiPath(@NonNull final Method method, @NonNull final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 读取方法上的注解ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.1如果存在path，就构建</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //1.2完整 path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, shenyuSpringMvcClient.path());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.从方法的其他注解上获取path信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String path = getPathByMethod(method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // 2.1 完整的path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return pathJoin(contextPath, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>getPathByMethod()</p><p>从方法的其他注解上获取<code>path</code>信息，其他注解包括：</p><ul><li>ShenyuSpringMvcClient</li><li>PostMapping</li><li>GetMapping</li><li>DeleteMapping</li><li>PutMapping</li><li>RequestMapping</li></ul></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getPathByMethod(@NonNull final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历接口注解获取path信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class&lt;? extends Annotation&gt; mapping : mappingAnnotation) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String pathByAnnotation = getPathByAnnotation(AnnotationUtils.findAnnotation(method, mapping), pathAttributeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(pathByAnnotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return pathByAnnotation;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>扫描注解完成后，构建元数据对象，然后将该对象发送到<code>shenyu-admin</code>，即可完成注册。</p><ul><li><p>元数据对象</p><p>包括当前注册方法的规则信息：contextPath，appName，注册路径，描述信息，注册类型，是否启用，规则名称和是否注册元数据。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private MetaDataRegisterDTO buildMetaDataDTO(@NonNull final ShenyuSpringMvcClient shenyuSpringMvcClient, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path) // 注册路径，在网关规则匹配时使用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(shenyuSpringMvcClient.desc()) // 描述信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.HTTP.getName()) // divide插件，默认时http类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuSpringMvcClient.enabled()) // 是否启用规则</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(StringUtils.defaultIfBlank(shenyuSpringMvcClient.ruleName(), path))//规则名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .registerMetaData(shenyuSpringMvcClient.registerMetaData()) //是否注册元数据信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>具体的注册逻辑由注册中心实现，在之前的文章中已经分析过了，这里就不再深入分析。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-注册uri信息"></a>1.3 注册URI信息<a class="hash-link" href="#13-注册uri信息" title="Direct link to heading">#</a></h4><p><code>ContextRegisterListener</code>负责将客户端的<code>URI</code>信息注册到<code>shenyu-admin</code>，它实现了<code>ApplicationListener</code>接口，发生上下文刷新事件<code>ContextRefreshedEvent</code>时，执行<code>onApplicationEvent()</code>方法，实现注册逻辑。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ContextRegisterListener implements ApplicationListener&lt;ContextRefreshedEvent&gt;, BeanFactoryAware {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 构造器实例化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ContextRegisterListener(final PropertiesConfig clientConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读取属性配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String errorMsg = &quot;http register param must config the contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = Integer.parseInt(Optional.ofNullable(props.getProperty(ShenyuClientConstants.PORT)).orElseGet(() -&gt; &quot;-1&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 执行应用事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 保证该方法执行一次</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 如果是注册整个服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 构建元数据，并注册</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取端口信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final int mergedPort = port &lt;= 0 ? PortUtils.findPort(beanFactory) : port;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. 构建URI数据，并注册</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(mergedPort));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage() + &quot;please config ${shenyu.client.http.props.port} in xml/yml !&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构建URI数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private URIRegisterDTO buildURIRegisterDTO(final int port) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(this.contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .protocol(protocol) // 服务使用的协议</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .host(IpUtils.isCompleteHost(this.host) ? this.host : IpUtils.getHost(this.host)) //主机</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .port(port) // 端口</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName()) // divide插件，默认注册http类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构建元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .path(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ruleName(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="14-处理注册信息"></a>1.4 处理注册信息<a class="hash-link" href="#14-处理注册信息" title="Direct link to heading">#</a></h4><p>客户端通过注册中心注册的元数据和<code>URI</code>数据，在<code>shenyu-admin</code>进行处理，负责存储到数据库和同步给<code>shenyu</code>网关。<code>Divide</code>插件的客户端注册处理逻辑在<code>ShenyuClientRegisterDivideServiceImpl</code>中。继承关系如下：</p><p><img src="/zh/assets/images/ShenyuClientRegisterDivideServiceImpl-4d9351b1efbb545cde2a3a172e35f59c.png"></p><ul><li>ShenyuClientRegisterService：客户端注册服务，顶层接口；</li><li>FallbackShenyuClientRegisterService：注册失败，提供重试操作；</li><li>AbstractShenyuClientRegisterServiceImpl：抽象类，实现部分公共注册逻辑；</li><li>AbstractContextPathRegisterService：抽象类，负责注册<code>ContextPath</code>；</li><li>ShenyuClientRegisterDivideServiceImpl：实现<code>Divide</code>插件的注册；</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="141-注册服务"></a>1.4.1 注册服务<a class="hash-link" href="#141-注册服务" title="Direct link to heading">#</a></h5><ul><li><p>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</p><p>客户端通过注册中心注册的元数据<code>MetaDataRegisterDTO</code>对象在<code>shenyu-admin</code>的<code>register()</code>方法被接送到。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. 注册选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. 注册规则</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. 注册元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. 注册ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1411-注册选择器"></a>1.4.1.1 注册选择器<a class="hash-link" href="#1411-注册选择器" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>构建<code>contextPath</code>，查找选择器信息是否存在，如果存在就返回<code>id</code>；不存在就创建默认的选择器信息。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 通过名称查找选择器信息是否存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 不存在就创建默认的选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>默认选择器信息</p><p>在这里构建默认选择器信息及其条件属性。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //注册选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //构建选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //注册默认选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //构建选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //构建默认选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //构建默认选择器的条件属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>构建默认选择器</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // 名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // 默认类型自定义</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //默认匹配方式 and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //默认启开启</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //默认记录日志</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) //默认继续后续选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) //默认顺序1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>构建默认选择器条件属性</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // 默认参数类型URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // 默认匹配策略 match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // 默认值 /contextPath/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>注册默认选择器</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //选择器条件属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 向数据库插入选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 向数据库插入选择器条件属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 发布同步事件，向网关同步选择信息及其条件属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1412-注册规则"></a>1.4.1.2 注册规则<a class="hash-link" href="#1412-注册规则" title="Direct link to heading">#</a></h6><p>在注册服务的第二步中，开始构建默认规则，然后注册规则。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. 注册选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. 注册规则</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 默认规则处理属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建默认规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 注册规则</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. 注册元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. 注册ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>默认规则处理属性</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 默认规则处理属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DivideRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Divide</code>插件默认规则处理属性</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DivideRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 负载均衡：默认随机</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadBalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 重试策略：默认重试当前服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String retryStrategy = RetryEnum.CURRENT.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 重试次数：默认3次</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int retry = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 调用超时：默认 3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * header最大值：10240 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long headerMaxSize = Constants.HEADER_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * request最大值：102400 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long requestMaxSize = Constants.REQUEST_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>构建默认规则信息</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // 构建默认规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  构建默认规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId) //关联的选择器id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) //规则名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) // 默认匹配模式 and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) // 默认开启</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) //默认记录日志</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1) //默认顺序 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) // 默认参数类型URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) //参数值path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //如果path中有*，操作类型则默认为 match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // 否则，默认操作类型 = </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>注册规则：向数据库插入记录，并向网关发布事件，进行数据同步。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 向数据库插入规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //向数据库插入规则体条件属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 向网关发布事件，进行数据同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1413-注册元数据"></a>1.4.1.3 注册元数据<a class="hash-link" href="#1413-注册元数据" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. 注册选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. 注册规则</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. 注册元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. 注册ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDivideServiceImpl#registerMetadata()</p><p>插入或更新元数据，然后发布同步事件到网关。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dto.isRegisterMetaData()) { // 如果注册元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取metaDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 元数据是否存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入或更新元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 数据类型转换 DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 插入数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 更新数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布同步事件到网关</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1414-注册contextpath"></a>1.4.1.4 注册ContextPath<a class="hash-link" href="#1414-注册contextpath" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. 注册选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. 注册规则</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. 注册元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. 注册ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractContextPathRegisterService#registerContextPath()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerContextPath(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置选择器的contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPathSelectorId = getSelectorService().registerDefault(dto, PluginEnum.CONTEXT_PATH.getName(), &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ContextMappingRuleHandle handle = new ContextMappingRuleHandle();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handle.setContextPath(PathUtils.decoratorContextPath(dto.getContextPath()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置规则的contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getRuleService().registerDefault(buildContextPathDefaultRuleDTO(contextPathSelectorId, dto, handle.toJson()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="142-注册uri"></a>1.4.2 注册URI<a class="hash-link" href="#142-注册uri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>服务端收到客户端注册的<code>URI</code>信息后，进行处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 注册URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 注册失败后，进行重试</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>从客户端注册的<code>URI</code>中获取有效的<code>URI</code>，更新对应的选择器<code>handle</code>属性，向网关发送选择器更新事件。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //参数检查</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取有效的URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建选择器的handle属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 向数据库更新选择器的handle属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 向网关发送选择器更新事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>关于服务注册的源码分析就以及完成了，分析流程图如下：</p><p><img src="/zh/assets/images/divide-register-zh-0697d4849e6ae1dbd2f15a0fd528cd32.png"></p><p>接下来就分析<code>divide</code>插件是如何根据这些信息向<code>http</code>服务发起调用。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-服务调用"></a>2. 服务调用<a class="hash-link" href="#2-服务调用" title="Direct link to heading">#</a></h3><p><code>divide</code>插件是网关用于处理 <code>http协议</code>请求的核心处理插件。</p><p>以官网提供的案例 <a href="https://shenyu.apache.org/zh/docs/next/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Http快速开始</a> 为例，一个直连请求如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:8189/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>通过<code>ShenYu</code>网关代理后，请求如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/http/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>通过<code>ShenYu</code>网关代理后的服务仍然能够请求到之前的服务，在这里起作用的就是<code>divide</code>插件。类继承关系如下：</p><p><img src="data:image/png;base64,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"></p><ul><li>ShenyuPlugin：顶层接口，定义接口方法；</li><li>AbstractShenyuPlugin：抽象类，实现插件共有逻辑；</li><li>DividePlugin：Divide插件。</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-接收请求"></a>2.1 接收请求<a class="hash-link" href="#21-接收请求" title="Direct link to heading">#</a></h4><p>通过<code>ShenYu</code>网关代理后，请求入口是<code>ShenyuWebHandler</code>，它实现了<code>org.springframework.web.server.WebHandler</code>接口。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 处理web请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // 执行默认插件链</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 实例化默认插件链</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 执行每个插件.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 获取当前执行插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 是否跳过当前插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 如果跳过就执行下一个</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 执行当前插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-匹配规则"></a>2.2 匹配规则<a class="hash-link" href="#22-匹配规则" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>在<code>execute()</code>方法中执行选择器和规则的匹配逻辑。</p><ul><li>匹配选择器；</li><li>匹配规则；</li><li>执行插件。</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 插件名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 匹配选择器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 匹配规则</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 执行插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-执行divide插件"></a>2.3 执行divide插件<a class="hash-link" href="#23-执行divide插件" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.divide.DividePlugin#doExecute()</li></ul><p>在<code>doExecute()</code>方法中执行<code>divide</code>插件的具体逻辑：</p><ul><li>校验<code>header</code>大小；</li><li>校验<code>request</code>大小；</li><li>获取服务列表；</li><li>实现负载均衡；</li><li>设置请求<code>url</code>，超时时间，重试策略。</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取上下文信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取规则的handle属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DivideRuleHandle ruleHandle = DividePluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long headerSize = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 校验header大小</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (List&lt;String&gt; multiHeader : exchange.getRequest().getHeaders().values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String value : multiHeader) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                headerSize += value.getBytes(StandardCharsets.UTF_8).length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (headerSize &gt; ruleHandle.getHeaderMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request header is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_HEADER_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 校验request大小</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (exchange.getRequest().getHeaders().getContentLength() &gt; ruleHandle.getRequestMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request entity is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_ENTITY_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取服务列表upstreamList</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide upstream configuration error： {}&quot;, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 请求ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 实现负载均衡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide has no upstream&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String domain = upstream.buildDomain();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_DOMAIN, domain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置超时时间</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_TIME_OUT, ruleHandle.getTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_RETRY, ruleHandle.getRetry());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置重试策略</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.RETRY_STRATEGY, ruleHandle.getRetryStrategy());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.LOAD_BALANCE, ruleHandle.getLoadBalance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.DIVIDE_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-发起请求"></a>2.4 发起请求<a class="hash-link" href="#24-发起请求" title="Direct link to heading">#</a></h4><p>默认由<code>WebClientPlugin</code>向<code>http</code>服务发起调用请求，类继承关系如下：</p><p><img src="/zh/assets/images/WebClientPlugin-64ae237cda7fd819160795669ee2e2bd.png"></p><ul><li>ShenyuPlugin：顶层插件，定义插件方法；</li><li>AbstractHttpClientPlugin：抽象类，实现请求调用的公共逻辑；</li><li>WebClientPlugin：通过<code>WebClient</code>发起请求；</li><li>NettyHttpClientPlugin：通过<code>Netty</code>发起请求。</li></ul><p>发起请求调用：</p><ul><li>org.apache.shenyu.plugin.httpclient.AbstractHttpClientPlugin#execute()</li></ul><p>在<code>execute()</code>方法中发起请求调用：</p><ul><li>获取指定的超时时间，重试次数</li><li>发起请求</li><li>根据指定的重试策略进行失败后重试操作</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractHttpClientPlugin&lt;R&gt; implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static final Logger LOG = LoggerFactory.getLogger(AbstractHttpClientPlugin.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取上下文信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final URI uri = exchange.getAttribute(Constants.HTTP_URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取指定的超时时间</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final long timeout = (long) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_TIME_OUT)).orElse(3000L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Duration duration = Duration.ofMillis(timeout);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取指定重试次数</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int retryTimes = (int) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_RETRY)).orElse(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取指定的重试策略</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String retryStrategy = (String) Optional.ofNullable(exchange.getAttribute(Constants.RETRY_STRATEGY)).orElseGet(RetryEnum.CURRENT::getName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;The request urlPath is {}, retryTimes is {}, retryStrategy is {}&quot;, uri.toASCIIString(), retryTimes, retryStrategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建header</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final HttpHeaders httpHeaders = buildHttpHeaders(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发起请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;R&gt; response = doRequest(exchange, exchange.getRequest().getMethodValue(), uri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 重试策略CURRENT，对当前服务进行重试</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RetryEnum.CURRENT.getName().equals(retryStrategy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //old version of DividePlugin and SpringCloudPlugin will run on this</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response.retryWhen(Retry.anyOf(TimeoutException.class, ConnectTimeoutException.class, ReadTimeoutException.class, IllegalStateException.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .retryMax(retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .backoff(Backoff.exponential(Duration.ofMillis(200), Duration.ofSeconds(20), 2, true)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 对其他服务进行重试</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 排除已经调用过的服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Set&lt;URI&gt; exclude = Sets.newHashSet(uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 请求重试</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resend(response, exchange, duration, httpHeaders, exclude, retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; clientResponse,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final int retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;R&gt; result = clientResponse;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 根据指定的重试次数进行重试</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; retryTimes; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = resend(result, exchange, duration, httpHeaders, exclude);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; response,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response.onErrorResume(th -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String selectorId = exchange.getAttribute(Constants.DIVIDE_SELECTOR_ID);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String loadBalance = exchange.getAttribute(Constants.LOAD_BALANCE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //查询可用服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selectorId)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .stream().filter(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String trimUri = data.getUrl().trim();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (URI needToExclude : exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // exclude already called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if ((needToExclude.getHost() + &quot;:&quot; + needToExclude.getPort()).equals(trimUri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 请求ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 实现负载均衡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Upstream upstream = LoadBalancerFactory.selector(upstreamList, loadBalance, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final URI newUri = RequestUrlUtils.buildRequestUri(exchange, upstream.buildDomain());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 排除已经调用的uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exclude.add(newUri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // 进行再次调用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doRequest(exchange, exchange.getRequest().getMethodValue(), newUri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.httpclient.WebClientPlugin#doRequest()</li></ul><p>在<code>doRequest()</code>方法中通过<code>webClient</code>发起真正的请求调用。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;ClientResponse&gt; doRequest(final ServerWebExchange exchange, final String httpMethod, final URI uri,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final HttpHeaders httpHeaders, final Flux&lt;DataBuffer&gt; body) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return webClient.method(HttpMethod.valueOf(httpMethod)).uri(uri) //请求uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .headers(headers -&gt; headers.addAll(httpHeaders)) // 请求header</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .body(BodyInserters.fromDataBuffers(body))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .exchange() // 发起请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnSuccess(res -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (res.statusCode().is2xxSuccessful()) { // 成功</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else { // 失败</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.ERROR.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getResponse().setStatusCode(res.statusCode());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.CLIENT_RESPONSE_ATTR, res);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-处理响应结果"></a>2.5 处理响应结果<a class="hash-link" href="#25-处理响应结果" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>响应结果由<code>ResponsePlugin</code>插件处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 根据rpc类型处理结果</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>处理类型由<code>MessageWriter</code>决定，类继承关系如下：</p><p><img src="/zh/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriter：接口，定义消息处理方法；</li><li>NettyClientMessageWriter：处理<code>Netty</code>调用结果；</li><li>RPCMessageWriter：处理<code>RPC</code>调用结果；</li><li>WebClientMessageWriter：处理<code>WebClient</code>调用结果；</li></ul><p>默认是通过<code>WebCient</code>发起<code>http</code>请求。</p><ul><li>org.apache.shenyu.plugin.response.strategy.WebClientMessageWriter#writeWith()</li></ul><p>在<code>writeWith()</code>方法中处理响应结果。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取响应</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerHttpResponse response = exchange.getResponse();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientResponse clientResponse = exchange.getAttribute(Constants.CLIENT_RESPONSE_ATTR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(clientResponse)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //获取cookies和headers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getCookies().putAll(clientResponse.cookies());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getHeaders().putAll(clientResponse.headers().asHttpHeaders());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // image, pdf or stream does not do format processing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 处理特殊响应类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clientResponse.headers().contentType().isPresent()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String media = clientResponse.headers().contentType().get().toString().toLowerCase();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (media.matches(COMMON_BIN_MEDIA_TYPE_REGEX)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return response.writeWith(clientResponse.body(BodyExtractors.toDataBuffers()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 处理一般响应类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clientResponse = ResponseUtils.buildClientResponse(response, clientResponse.body(BodyExtractors.toDataBuffers()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return clientResponse.bodyToMono(byte[].class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap(originData -&gt; WebFluxResultUtils.result(exchange, originData))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>分析至此，关于<code>Divide</code>插件的源码分析就完成了，分析流程图如下：</p><p><img src="/zh/assets/images/divide-execute-zh-c145705430fc3aec6e561cc4ad183a05.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-小结"></a>3. 小结<a class="hash-link" href="#3-小结" title="Direct link to heading">#</a></h3><p>本文源码分析从<code>http</code>服务注册开始，到<code>divide</code>插件的服务调用。<code>divide</code>插件主要用来处理<code>http</code>请求。有些源码没有进入深入分析，比如负载均衡的实现，服务探活，将在后续继续分析。</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/divide">divide</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Divide-Plugin.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑本文档</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Context-Path插件源码分析</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Param-Mapping插件源码分析 »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-服务注册" class="table-of-contents__link">1. 服务注册</a></li><li><a href="#2-服务调用" class="table-of-contents__link">2. 服务调用</a></li><li><a href="#3-小结" class="table-of-contents__link">3. 小结</a></li></ul></div></div></div></div></div></div>
<script src="/zh/assets/js/runtime~main.c1361167.js"></script>
<script src="/zh/assets/js/main.e3824e15.js"></script>
</body>
</html>