<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Blog | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Blog | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/page/2"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/page/2"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/page/2" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.4db9224e.css">
<link rel="preload" href="/zh/assets/js/runtime~main.43910f1b.js" as="script">
<link rel="preload" href="/zh/assets/js/main.2c045cdb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin">Divideæ’ä»¶æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-06-01T03:06:51.476Z">2023å¹´6æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p><code>ShenYu</code> ç½‘å…³ä½¿ç”¨ <code>divide</code> æ’ä»¶æ¥å¤„ç† <code>http</code> è¯·æ±‚ã€‚ä½ å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ <a href="https://shenyu.apache.org/zh/docs/next/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Httpå¿«é€Ÿå¼€å§‹</a> äº†è§£å¦‚ä½•ä½¿ç”¨è¯¥æ’ä»¶ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.3</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/next/user-guide/http-proxy" target="_blank" rel="noopener noreferrer">HttpæœåŠ¡æ¥å…¥</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-æœåŠ¡æ³¨å†Œ"></a>1. æœåŠ¡æ³¨å†Œ<a class="hash-link" href="#1-æœåŠ¡æ³¨å†Œ" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--å£°æ˜æ³¨å†Œæ¥å£"></a>1.1  å£°æ˜æ³¨å†Œæ¥å£<a class="hash-link" href="#11--å£°æ˜æ³¨å†Œæ¥å£" title="Direct link to heading">#</a></h4><p>ä½¿ç”¨æ³¨è§£<code>@ShenyuSpringMvcClient</code>å°†æœåŠ¡æ³¨å†Œåˆ°ç½‘å…³ã€‚ç®€å•<code>demo</code>å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)  // APIæ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/findById&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/findById&quot;, desc = &quot;Find by id&quot;) // æ–¹æ³•æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO findById(@RequestParam(&quot;id&quot;) final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return build(id, &quot;hello world findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ³¨è§£å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ä½œç”¨äºç±»å’Œæ–¹æ³•ä¸Š</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ˜¯å¦å¯ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-æ‰«ææ³¨è§£ä¿¡æ¯"></a>1.2 æ‰«ææ³¨è§£ä¿¡æ¯<a class="hash-link" href="#12-æ‰«ææ³¨è§£ä¿¡æ¯" title="Direct link to heading">#</a></h4><p>æ³¨è§£æ‰«æé€šè¿‡<code>SpringMvcClientBeanPostProcessor</code>å®Œæˆï¼Œå®ƒå®ç°äº†<code>BeanPostProcessor</code>æ¥å£ï¼Œæ˜¯<code>Spring</code>æä¾›çš„åç½®å¤„ç†å™¨ã€‚</p><p>åœ¨æ„é€ å™¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼š</p><ul><li>è¯»å–å±æ€§é…ç½®</li><li>æ·»åŠ æ³¨è§£ï¼Œè¯»å–<code>path</code>ä¿¡æ¯</li><li>å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼Œå‘<code>shenyu-admin</code>æ³¨å†Œ</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientBeanPostProcessor implements BeanPostProcessor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ„é€ å™¨å®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientBeanPostProcessor(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. è¯»å–å±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;http register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. æ·»åŠ æ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PostMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(GetMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(DeleteMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PutMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. å¯åŠ¨æ³¨å†Œä¸­å¿ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // é‡å†™åç½®å¤„ç†å™¨é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>SpringMvcClientBeanPostProcessor#postProcessAfterInitialization()</li></ul><p>é‡å†™åç½®å¤„ç†å™¨é€»è¾‘ï¼šè¯»å–æ³¨è§£ä¿¡æ¯ï¼Œæ„å»ºå…ƒæ•°æ®å¯¹è±¡å’Œ<code>URI</code>å¯¹è±¡ï¼Œå¹¶å‘<code>shenyu-admin</code>æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. å¦‚æœæ˜¯æ³¨å†Œæ•´ä¸ªæœåŠ¡æˆ–è€…ä¸æ˜¯Controllerç±»ï¼Œå°±ä¸å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull) || !hasAnnotation(bean.getClass(), Controller.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. è¯»å–ç±»ä¸Šçš„æ³¨è§£ ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuSpringMvcClient beanShenyuClient = AnnotationUtils.findAnnotation(bean.getClass(), ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1æ„å»ºsuperPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.2 æ˜¯å¦æ³¨å†Œæ•´ä¸ªç±»æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œç„¶åå‘shenyu-adminæ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(beanShenyuClient, pathJoin(contextPath, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. è¯»å–æ‰€æœ‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3.1 è¯»å–æ–¹æ³•ä¸Šçš„æ³¨è§£ ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuSpringMvcClient methodShenyuClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¦‚æœæ–¹æ³•ä¸Šé¢æ²¡æœ‰æ³¨è§£ï¼Œå°±ç”¨ç±»ä¸Šé¢çš„æ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // 3.2 æ„å»ºpathä¿¡æ¯ï¼Œæ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œå‘shenyu-adminæ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(methodShenyuClient, buildApiPath(method, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>1.å¦‚æœæ˜¯æ³¨å†Œæ•´ä¸ªæœåŠ¡æˆ–è€…ä¸æ˜¯<code>Controller</code>ç±»ï¼Œå°±ä¸å¤„ç†</li><li>2.è¯»å–ç±»ä¸Šçš„æ³¨è§£ <code>ShenyuSpringMvcClient</code>ï¼Œå¦‚æœæ˜¯æ³¨å†Œæ•´ä¸ªç±»ï¼Œå°±åœ¨è¿™é‡Œæ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œç„¶åå‘<code>shenyu-admin</code>æ³¨å†Œ</li><li>3.å¤„ç†æ–¹æ³•ä¸Šçš„æ³¨è§£ <code>ShenyuSpringMvcClient</code>ï¼Œé’ˆå¯¹ç‰¹å®šæ–¹æ³•æ„å»º<code>path</code>ä¿¡æ¯ï¼Œæ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œç„¶åå‘<code>shenyu-admin</code>æ³¨å†Œ</li></ul><p>è¿™é‡Œæœ‰ä¸¤ä¸ªå–<code>path</code>çš„æ–¹æ³•ï¼Œéœ€è¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼š</p><ul><li><p>buildApiSuperPath()</p><p>æ„é€ <code>SuperPath</code>ï¼šå…ˆä»ç±»ä¸Šçš„æ³¨è§£<code>ShenyuSpringMvcClient</code>å–<code>path</code>å±æ€§ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä»å½“å‰ç±»çš„<code>RequestMapping</code>æ³¨è§£ä¸­å–<code>path</code>ä¿¡æ¯ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiSuperPath(@NonNull final Class&lt;?&gt; method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å…ˆä»ç±»ä¸Šçš„æ³¨è§£ShenyuSpringMvcClientå–pathå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return shenyuSpringMvcClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä»å½“å‰ç±»çš„RequestMappingæ³¨è§£ä¸­å–pathä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildApiPath()</p><p>æ„å»º<code>path</code>ï¼šå…ˆè¯»å–æ–¹æ³•ä¸Šçš„æ³¨è§£<code>ShenyuSpringMvcClient</code>ï¼Œå¦‚æœå­˜åœ¨å°±æ„å»ºï¼›å¦åˆ™ä»æ–¹æ³•çš„å…¶ä»–æ³¨è§£ä¸Šè·å–<code>path</code>ä¿¡æ¯ï¼›å®Œæ•´çš„<code>path = contextPath(ä¸Šä¸‹æ–‡ä¿¡æ¯)+superPath(ç±»ä¿¡æ¯)+methodPath(æ–¹æ³•ä¿¡æ¯)</code>ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiPath(@NonNull final Method method, @NonNull final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. è¯»å–æ–¹æ³•ä¸Šçš„æ³¨è§£ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.1å¦‚æœå­˜åœ¨pathï¼Œå°±æ„å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //1.2å®Œæ•´ path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, shenyuSpringMvcClient.path());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.ä»æ–¹æ³•çš„å…¶ä»–æ³¨è§£ä¸Šè·å–pathä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String path = getPathByMethod(method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // 2.1 å®Œæ•´çš„path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return pathJoin(contextPath, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>getPathByMethod()</p><p>ä»æ–¹æ³•çš„å…¶ä»–æ³¨è§£ä¸Šè·å–<code>path</code>ä¿¡æ¯ï¼Œå…¶ä»–æ³¨è§£åŒ…æ‹¬ï¼š</p><ul><li>ShenyuSpringMvcClient</li><li>PostMapping</li><li>GetMapping</li><li>DeleteMapping</li><li>PutMapping</li><li>RequestMapping</li></ul></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getPathByMethod(@NonNull final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ¥å£æ³¨è§£è·å–pathä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class&lt;? extends Annotation&gt; mapping : mappingAnnotation) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String pathByAnnotation = getPathByAnnotation(AnnotationUtils.findAnnotation(method, mapping), pathAttributeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(pathByAnnotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return pathByAnnotation;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ‰«ææ³¨è§£å®Œæˆåï¼Œæ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œç„¶åå°†è¯¥å¯¹è±¡å‘é€åˆ°<code>shenyu-admin</code>ï¼Œå³å¯å®Œæˆæ³¨å†Œã€‚</p><ul><li><p>å…ƒæ•°æ®å¯¹è±¡</p><p>åŒ…æ‹¬å½“å‰æ³¨å†Œæ–¹æ³•çš„è§„åˆ™ä¿¡æ¯ï¼šcontextPathï¼ŒappNameï¼Œæ³¨å†Œè·¯å¾„ï¼Œæè¿°ä¿¡æ¯ï¼Œæ³¨å†Œç±»å‹ï¼Œæ˜¯å¦å¯ç”¨ï¼Œè§„åˆ™åç§°å’Œæ˜¯å¦æ³¨å†Œå…ƒæ•°æ®ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private MetaDataRegisterDTO buildMetaDataDTO(@NonNull final ShenyuSpringMvcClient shenyuSpringMvcClient, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path) // æ³¨å†Œè·¯å¾„ï¼Œåœ¨ç½‘å…³è§„åˆ™åŒ¹é…æ—¶ä½¿ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(shenyuSpringMvcClient.desc()) // æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.HTTP.getName()) // divideæ’ä»¶ï¼Œé»˜è®¤æ—¶httpç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuSpringMvcClient.enabled()) // æ˜¯å¦å¯ç”¨è§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(StringUtils.defaultIfBlank(shenyuSpringMvcClient.ruleName(), path))//è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .registerMetaData(shenyuSpringMvcClient.registerMetaData()) //æ˜¯å¦æ³¨å†Œå…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…·ä½“çš„æ³¨å†Œé€»è¾‘ç”±æ³¨å†Œä¸­å¿ƒå®ç°ï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†æ·±å…¥åˆ†æã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-æ³¨å†Œuriä¿¡æ¯"></a>1.3 æ³¨å†ŒURIä¿¡æ¯<a class="hash-link" href="#13-æ³¨å†Œuriä¿¡æ¯" title="Direct link to heading">#</a></h4><p><code>ContextRegisterListener</code>è´Ÿè´£å°†å®¢æˆ·ç«¯çš„<code>URI</code>ä¿¡æ¯æ³¨å†Œåˆ°<code>shenyu-admin</code>ï¼Œå®ƒå®ç°äº†<code>ApplicationListener</code>æ¥å£ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶<code>ContextRefreshedEvent</code>æ—¶ï¼Œæ‰§è¡Œ<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œå®ç°æ³¨å†Œé€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ContextRegisterListener implements ApplicationListener&lt;ContextRefreshedEvent&gt;, BeanFactoryAware {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ„é€ å™¨å®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ContextRegisterListener(final PropertiesConfig clientConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯»å–å±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String errorMsg = &quot;http register param must config the contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = Integer.parseInt(Optional.ofNullable(props.getProperty(ShenyuClientConstants.PORT)).orElseGet(() -&gt; &quot;-1&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰§è¡Œåº”ç”¨äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¿è¯è¯¥æ–¹æ³•æ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. å¦‚æœæ˜¯æ³¨å†Œæ•´ä¸ªæœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºå…ƒæ•°æ®ï¼Œå¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–ç«¯å£ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final int mergedPort = port &lt;= 0 ? PortUtils.findPort(beanFactory) : port;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. æ„å»ºURIæ•°æ®ï¼Œå¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(mergedPort));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage() + &quot;please config ${shenyu.client.http.props.port} in xml/yml !&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºURIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private URIRegisterDTO buildURIRegisterDTO(final int port) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(this.contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .protocol(protocol) // æœåŠ¡ä½¿ç”¨çš„åè®®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .host(IpUtils.isCompleteHost(this.host) ? this.host : IpUtils.getHost(this.host)) //ä¸»æœº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .port(port) // ç«¯å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName()) // divideæ’ä»¶ï¼Œé»˜è®¤æ³¨å†Œhttpç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .path(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ruleName(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="14-å¤„ç†æ³¨å†Œä¿¡æ¯"></a>1.4 å¤„ç†æ³¨å†Œä¿¡æ¯<a class="hash-link" href="#14-å¤„ç†æ³¨å†Œä¿¡æ¯" title="Direct link to heading">#</a></h4><p>å®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„å…ƒæ•°æ®å’Œ<code>URI</code>æ•°æ®ï¼Œåœ¨<code>shenyu-admin</code>è¿›è¡Œå¤„ç†ï¼Œè´Ÿè´£å­˜å‚¨åˆ°æ•°æ®åº“å’ŒåŒæ­¥ç»™<code>shenyu</code>ç½‘å…³ã€‚<code>Divide</code>æ’ä»¶çš„å®¢æˆ·ç«¯æ³¨å†Œå¤„ç†é€»è¾‘åœ¨<code>ShenyuClientRegisterDivideServiceImpl</code>ä¸­ã€‚ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/ShenyuClientRegisterDivideServiceImpl-4d9351b1efbb545cde2a3a172e35f59c.png"></p><ul><li>ShenyuClientRegisterServiceï¼šå®¢æˆ·ç«¯æ³¨å†ŒæœåŠ¡ï¼Œé¡¶å±‚æ¥å£ï¼›</li><li>FallbackShenyuClientRegisterServiceï¼šæ³¨å†Œå¤±è´¥ï¼Œæä¾›é‡è¯•æ“ä½œï¼›</li><li>AbstractShenyuClientRegisterServiceImplï¼šæŠ½è±¡ç±»ï¼Œå®ç°éƒ¨åˆ†å…¬å…±æ³¨å†Œé€»è¾‘ï¼›</li><li>AbstractContextPathRegisterServiceï¼šæŠ½è±¡ç±»ï¼Œè´Ÿè´£æ³¨å†Œ<code>ContextPath</code>ï¼›</li><li>ShenyuClientRegisterDivideServiceImplï¼šå®ç°<code>Divide</code>æ’ä»¶çš„æ³¨å†Œï¼›</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="141-æ³¨å†ŒæœåŠ¡"></a>1.4.1 æ³¨å†ŒæœåŠ¡<a class="hash-link" href="#141-æ³¨å†ŒæœåŠ¡" title="Direct link to heading">#</a></h5><ul><li><p>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</p><p>å®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„å…ƒæ•°æ®<code>MetaDataRegisterDTO</code>å¯¹è±¡åœ¨<code>shenyu-admin</code>çš„<code>register()</code>æ–¹æ³•è¢«æ¥é€åˆ°ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1411-æ³¨å†Œé€‰æ‹©å™¨"></a>1.4.1.1 æ³¨å†Œé€‰æ‹©å™¨<a class="hash-link" href="#1411-æ³¨å†Œé€‰æ‹©å™¨" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>æ„å»º<code>contextPath</code>ï¼ŒæŸ¥æ‰¾é€‰æ‹©å™¨ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è¿”å›<code>id</code>ï¼›ä¸å­˜åœ¨å°±åˆ›å»ºé»˜è®¤çš„é€‰æ‹©å™¨ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºcontextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é€šè¿‡åç§°æŸ¥æ‰¾é€‰æ‹©å™¨ä¿¡æ¯æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¸å­˜åœ¨å°±åˆ›å»ºé»˜è®¤çš„é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>é»˜è®¤é€‰æ‹©å™¨ä¿¡æ¯</p><p>åœ¨è¿™é‡Œæ„å»ºé»˜è®¤é€‰æ‹©å™¨ä¿¡æ¯åŠå…¶æ¡ä»¶å±æ€§ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ³¨å†Œé»˜è®¤é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //æ„å»ºé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºé»˜è®¤é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //æ„å»ºé»˜è®¤é€‰æ‹©å™¨çš„æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤é€‰æ‹©å™¨</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // é»˜è®¤ç±»å‹è‡ªå®šä¹‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //é»˜è®¤åŒ¹é…æ–¹å¼ and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //é»˜è®¤å¯å¼€å¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //é»˜è®¤è®°å½•æ—¥å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) //é»˜è®¤ç»§ç»­åç»­é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) //é»˜è®¤é¡ºåº1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤é€‰æ‹©å™¨æ¡ä»¶å±æ€§</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // é»˜è®¤å‚æ•°ç±»å‹URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // é»˜è®¤åŒ¹é…ç­–ç•¥ match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // é»˜è®¤å€¼ /contextPath/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ³¨å†Œé»˜è®¤é€‰æ‹©å™¨</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é€‰æ‹©å™¨æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘æ•°æ®åº“æ’å…¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // å‘æ•°æ®åº“æ’å…¥é€‰æ‹©å™¨æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‘å¸ƒåŒæ­¥äº‹ä»¶ï¼Œå‘ç½‘å…³åŒæ­¥é€‰æ‹©ä¿¡æ¯åŠå…¶æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1412-æ³¨å†Œè§„åˆ™"></a>1.4.1.2 æ³¨å†Œè§„åˆ™<a class="hash-link" href="#1412-æ³¨å†Œè§„åˆ™" title="Direct link to heading">#</a></h6><p>åœ¨æ³¨å†ŒæœåŠ¡çš„ç¬¬äºŒæ­¥ä¸­ï¼Œå¼€å§‹æ„å»ºé»˜è®¤è§„åˆ™ï¼Œç„¶åæ³¨å†Œè§„åˆ™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DivideRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Divide</code>æ’ä»¶é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DivideRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è´Ÿè½½å‡è¡¡ï¼šé»˜è®¤éšæœº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadBalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * é‡è¯•ç­–ç•¥ï¼šé»˜è®¤é‡è¯•å½“å‰æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String retryStrategy = RetryEnum.CURRENT.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * é‡è¯•æ¬¡æ•°ï¼šé»˜è®¤3æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int retry = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è°ƒç”¨è¶…æ—¶ï¼šé»˜è®¤ 3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * headeræœ€å¤§å€¼ï¼š10240 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long headerMaxSize = Constants.HEADER_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * requestæœ€å¤§å€¼ï¼š102400 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long requestMaxSize = Constants.REQUEST_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId) //å…³è”çš„é€‰æ‹©å™¨id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) // é»˜è®¤åŒ¹é…æ¨¡å¼ and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) // é»˜è®¤å¼€å¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) //é»˜è®¤è®°å½•æ—¥å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1) //é»˜è®¤é¡ºåº 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) // é»˜è®¤å‚æ•°ç±»å‹URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) //å‚æ•°å€¼path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //å¦‚æœpathä¸­æœ‰*ï¼Œæ“ä½œç±»å‹åˆ™é»˜è®¤ä¸º match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // å¦åˆ™ï¼Œé»˜è®¤æ“ä½œç±»å‹ = </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>æ³¨å†Œè§„åˆ™ï¼šå‘æ•°æ®åº“æ’å…¥è®°å½•ï¼Œå¹¶å‘ç½‘å…³å‘å¸ƒäº‹ä»¶ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘æ•°æ®åº“æ’å…¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å‘æ•°æ®åº“æ’å…¥è§„åˆ™ä½“æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘ç½‘å…³å‘å¸ƒäº‹ä»¶ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1413-æ³¨å†Œå…ƒæ•°æ®"></a>1.4.1.3 æ³¨å†Œå…ƒæ•°æ®<a class="hash-link" href="#1413-æ³¨å†Œå…ƒæ•°æ®" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDivideServiceImpl#registerMetadata()</p><p>æ’å…¥æˆ–æ›´æ–°å…ƒæ•°æ®ï¼Œç„¶åå‘å¸ƒåŒæ­¥äº‹ä»¶åˆ°ç½‘å…³ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dto.isRegisterMetaData()) { // å¦‚æœæ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–metaDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å…ƒæ•°æ®æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥æˆ–æ›´æ–°å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ•°æ®ç±»å‹è½¬æ¢ DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒåŒæ­¥äº‹ä»¶åˆ°ç½‘å…³</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1414-æ³¨å†Œcontextpath"></a>1.4.1.4 æ³¨å†ŒContextPath<a class="hash-link" href="#1414-æ³¨å†Œcontextpath" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractContextPathRegisterService#registerContextPath()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerContextPath(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®é€‰æ‹©å™¨çš„contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPathSelectorId = getSelectorService().registerDefault(dto, PluginEnum.CONTEXT_PATH.getName(), &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ContextMappingRuleHandle handle = new ContextMappingRuleHandle();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handle.setContextPath(PathUtils.decoratorContextPath(dto.getContextPath()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®è§„åˆ™çš„contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getRuleService().registerDefault(buildContextPathDefaultRuleDTO(contextPathSelectorId, dto, handle.toJson()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="142-æ³¨å†Œuri"></a>1.4.2 æ³¨å†ŒURI<a class="hash-link" href="#142-æ³¨å†Œuri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯æ³¨å†Œçš„<code>URI</code>ä¿¡æ¯åï¼Œè¿›è¡Œå¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†Œå¤±è´¥åï¼Œè¿›è¡Œé‡è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>ä»å®¢æˆ·ç«¯æ³¨å†Œçš„<code>URI</code>ä¸­è·å–æœ‰æ•ˆçš„<code>URI</code>ï¼Œæ›´æ–°å¯¹åº”çš„é€‰æ‹©å™¨<code>handle</code>å±æ€§ï¼Œå‘ç½‘å…³å‘é€é€‰æ‹©å™¨æ›´æ–°äº‹ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å‚æ•°æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æœ‰æ•ˆçš„URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé€‰æ‹©å™¨çš„handleå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘æ•°æ®åº“æ›´æ–°é€‰æ‹©å™¨çš„handleå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘ç½‘å…³å‘é€é€‰æ‹©å™¨æ›´æ–°äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…³äºæœåŠ¡æ³¨å†Œçš„æºç åˆ†æå°±ä»¥åŠå®Œæˆäº†ï¼Œåˆ†ææµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/divide-register-zh-0697d4849e6ae1dbd2f15a0fd528cd32.png"></p><p>æ¥ä¸‹æ¥å°±åˆ†æ<code>divide</code>æ’ä»¶æ˜¯å¦‚ä½•æ ¹æ®è¿™äº›ä¿¡æ¯å‘<code>http</code>æœåŠ¡å‘èµ·è°ƒç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-æœåŠ¡è°ƒç”¨"></a>2. æœåŠ¡è°ƒç”¨<a class="hash-link" href="#2-æœåŠ¡è°ƒç”¨" title="Direct link to heading">#</a></h3><p><code>divide</code>æ’ä»¶æ˜¯ç½‘å…³ç”¨äºå¤„ç† <code>httpåè®®</code>è¯·æ±‚çš„æ ¸å¿ƒå¤„ç†æ’ä»¶ã€‚</p><p>ä»¥å®˜ç½‘æä¾›çš„æ¡ˆä¾‹ <a href="https://shenyu.apache.org/zh/docs/next/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Httpå¿«é€Ÿå¼€å§‹</a> ä¸ºä¾‹ï¼Œä¸€ä¸ªç›´è¿è¯·æ±‚å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:8189/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡<code>ShenYu</code>ç½‘å…³ä»£ç†åï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/http/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡<code>ShenYu</code>ç½‘å…³ä»£ç†åçš„æœåŠ¡ä»ç„¶èƒ½å¤Ÿè¯·æ±‚åˆ°ä¹‹å‰çš„æœåŠ¡ï¼Œåœ¨è¿™é‡Œèµ·ä½œç”¨çš„å°±æ˜¯<code>divide</code>æ’ä»¶ã€‚ç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAGoCAIAAAB0UFO8AAAACXBIWXMAAB2HAAAdhwGP5fFlAAAgAElEQVR42u2d3ZfbRJqH59/ZEzLbsJCAp+3uzhchBAwmgkzmsz07aJpZDwPj7IbgkJAYw5yFHQeyNHhgLvoqc9V3PefsXmf+o9nrLVm2VJKqSiVZsmX5+R2dnO6O7JLen97Hr0pV5R+cKkKNqU4tXVtT0W7Zwl/8Jc4ltfsDLKRd/MVf/AXBWEiK4i/+gmAspF38xV/iDIKxkBTFX/wFwVhIu/iLv8QZBGMhKUq7+AuCsZAUJc74S5xBMBaSorSLvyAYC0lR4oy/xBkE0y4pSrv4C4KxkBQlzvhLnEEw7ZKitIu/IBgLSVHijL/EGQTTLv7SLv6CYCwkRYkz/uIvCKZd/KVd/AXBWEiKEmf8BcFYSLv4i7/EGQRjISmKv/gLgrGQdvEXf4kzCMZCUpR28RcEYyEpSpzxlziDYCwkRWkXf0EwFpKixBl/iTMIxkJSlHbxd40R3EAIIbQibTSCbyGElqtOpyOX3mijOyLEBXFwcHADIVS+RK7JCKYjgr5gD8HiythGCJUvkWsgGASDYIRAMAgGwQiBYBAMgkEwQiAYBINghEAwCAbBCCEQDIJBMEIgGASDYIQQCAbBIBghEAyCQTBCCASDYBCMEAgGwSAYIQSCQfCSEbx3pXl5v3X1vVb79k7n/q7YxA/iV/FH8V8kG0IgGASXguDz15rtD3be+GTXsIkdxG6kHEIgGAQXhuCdi9uv3kyBr7yJncVL6qf24Pivf/u72A4HDlhZx9A1Gk5/fHw4HnY7DRAMgtcDwedebb5+d9eev/4mXiJeuBZ0aHR6XlqePPEZEWyHR5O+64BgFcUmI+U2EGhzqozg7njm8uOjYbvRAMEguOoIFhh940Fm/s62B1WnsKBJd3wcI6+8xRIVBE+D1hslPq4iQTs5HrkOCAbBIHhRBO9c3M5R/8Zq4cr2SHjV3NETibbHUkE3K4pBsBnBh0fH/pYEcSxEVemI6AxH3gFP+nREgODqIzhT/6+hXzj1AnU+333r4V6wXX13ZwlZEUBBVG1911F3UAx6IFiH4GQh2e70RvNPNS+qHUIHgkFwXgSfv9ZcnL/+Zh4j4XyxJ/PX3y44zZI5EpbAI7eRldogWHcvLwf28bhH6EAwCM6JYPP4s2da/xTbzCPVDA35zA1+vfSzlvj12me7Zd+QzroaTibdBgguDMG62IJgEAyCMyB470pKCXyu+9zZl0778BU/iF/N+xtmbcQQ3GzF/1JlBDc6TncwnHYfD7uuk/qEx3sA6Pr7T/pur63pkRS7tTvTbf6GXkOzFw77iYYandn+KcefeM/pXxr6KCl2SEdwsIPUF6FDcL5jiO2gjEzsZHWBzRdwEAyCy0Xw5f2WTQ9Dav0bbOINLRGs/Eu5z5Ss6zKZI8rRFNPBAFqq9lWjLwTIkmNUszYU9mtL9/7mz4+gx0D3ISSRNLJDgQjOfQxBZ/3o6IlyPEbDnSgDovskWMRZEAyCi0fwK+/vFItg8YaVQrCcdfYUlhK1F/R4ekMCpEFascdQISykfWKjCJJ8ydpQalGfhF2JCLbuiFgEwUErQTTkkIrqNS+CszkLgkFwKQhOnYicFcGG7mAZuMnncsmtjEJ4CpRJ6owpmdp+ukr3reG7xdJefkIVeYlUbelIMX9g6ChpLr8qGPGqLNZCLM5fUh6Cw5Jc2qFYBMvexW4j2u4kws2MCLYPOAgGwSUiuPPxbrEIFm9YNQRvJ4YG+zPiDCA2F866UtTwJEpikHoIlxKpyoZ0t96xNwzerSQEy8WpsqukEASbO17kY8iBYMuAg2AQXBMEJ3G8NATPStHBJDY7WbeGgLK+M/PU3Jspo1OGQrENhftL71YsgqePsyLzvG3Yl+8YlH3NMYWz4DIi2D7gIBgE16QjYrUITvYJLDLL1s98dS+t5h5WuYNlQ7pKM1bHKSlfSCeA5cTughGcFlLDPYHN4zj7gINgEFyHx3FVQLAOxLF8y5GoUnmlWdpG1R2cjwg6NiU/GMpDsPKjq2AEqz5RQDAIZlBazkFp1UFwcqhT1lm2BgSnbqkPr9IRrCJaSDHNQ8L8HREn8qoaw77bs+lGXxzBNrM8QDAIXm8Ep07NOP+rM89fmU3NED+IX3NPzagaghNjGJySq+BgpcfeggiW0RM+dkv8pewREUtDsIGGIBgErzeCt5c4QbmCCI7k8GLFab6JufkRnODjvBdC/4xubRFMFQyC64zgpS3TU28Em8eKFY7gWM9vgDDl+yj7iFNHYhWI4HzHYBNS3ag1EAyC1wbB20tcrLLSCF7sKVnqoLTCERxgS7zWfx8d4FJmcwQRKB/BmY5B4rIG3JrV2kAwCF4zBNd4yXYvjfWzMHQrSORLVHmMqmZRBafrFkaE8O5+PJz/0LOv9JMRKBXB+Y7BHFJ5WAsIBsFrjODt+n5xUVhJHR3733g2Wyir05NnamT91gzNQAV5Nu1E/na16UJrXnOWpLAkQmK6bfonjTzNt+3Gll8oE8H5jkGe/yZ9lPpfAxgZZwKCQfBaI3i7pl/fGVvkRTNKLF4m539KltZcsQg21I9mWEeH95b+OC73MUwZPTEN7+Nx3FogeKsI+QjeWjfxJfaizkoudSjPL0jyZbEu2p56sUrR1qBnM5csExGCHVJHYsTWtfE/e+RHeWUjOMcx6Bz01kubBrPiIyK20FQg+Eamy+j8tWbqxGWxg/34h8pUxE7b7XWnW3Ix7+LR35m11S2zLfNIA2UQ5hForNCIHMcQ2if38FjMoFumQLAawXRE5LiY9q40L++3rr7Xat/e6dzfFZv4Qfwq/mg5/wItsad7qV/VXqFbHIvpGytEMB0R9AXnRzACQFX/BFp4YTMQDIJBMMoNoDwjkWv5CZR7hXUQDIJBMMpZAC744Gg9TtOdeM/rFF9jGj7zrE4JDIJBMAjehM7f6PfRVaYALAnBsW+NS37PW6U+gUAwCAbBtUew9PWgmml4dT3f1AHdIBgEg2BU8gOo2YqXw6rRp0wQO1132JfWLO66TjU/e0AwCAbBCIFgEAyCEQLBIBgEg2CEQDAIBsEIgWAQDIIRQiAYBINghEAwCAbBCCEQDILLRPDBwcENhFD5ErkGgkFwHMFo7dT/6PdiIw5rKhAMgkN10BrqJ3dfExtxWFO1Wi0QDILRuurM7jO//PI1sYkfiMa6CwSDYLRmeq1/8ZdfvSY28QPRAMEgeEMRvGntVsTfWQk8RXCphTD+kkcgGAtJ0fj5BiVw2YUw/pJHIBgLSdHI+UZK4JILYfwlj0AwFpKikfONlcClFsL4Sx6BYCwkRcPzVZTAZRbC+EsegWAsJEXD81WWwOUVwvhLHoFgLCRFZ+erLYFLK4TxlzwCwVhIis7O11ACl1QI4y95BIKxkBT1zrdx4YypBC6nEMZf8ggEYyEp6p3v6zcvpfC3hEIYf8kjEIyFpOgpqxK4hEIYf8kjEIyFpOgpyxK48EIYf8kjEIyFm56iKQMhyiyE8Zc8AsFYuOkpmjoQorxCGH/JIxCMhRudoplL4EILYfwlj0AwFm50iuYogQsshPGXPALBWLi5KZqzBC6uEMZf8ggEY+HmpmjuErioQhh/ySMQjIUbmqILlcAFFcL4Sx4tD8FbRci3cAvVVMv0N9NYYN0m3gTXyN+1EAhG1fL3zPaz5u1l95yArPjXvBuukb/rgWBuZGh3vfy99IuWQLD4F3/piKAvGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/JXxCMhaQoCMZf8hcE0y4Ixl/yFwRjISkKgvEXBGMh7a6Nv89ffFbwV/yLvyAYBGMhKUqc8Zc4g2DaJUVpF39BMBaSosQZf4kzCKbd2qYofcEgGARjISm6svNlRAQIBsFYSIqCYPwlziAYC0Ew/pK/IBgLSVEQjL/EGQTTLgjGX/IXBGMhKQqC8Zc4g2DaBcH4S/6CYCwkRUEw/pK/IJh2QTD+kr8gGAtJURCMv+QvCKZdEIy/5C8IxkJS1Pp8WSMCBINgLCRFiTP+EmcQjIWkKO3iLwjGQlKUOOMvcQbBtFv/FKUvGASDYCwkRVd2voyIAMEgGAtJURCMv8QZBGMhCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/J30ojeKsI+RZuoZqqUv5e3t8VCBb/4kst/d00gWAEgvGX/F0dgrmRoV06IvCX/KUvGAtJURCMvyAYC2m32v6yRgQIBsFYSIoSZ/wlziAYC0lR2sVfEIyFpChxxl/iDIJpt/4pSl8wCAbBWEiKrux8GREBgkEwFpKiIBh/iTMIxkIQjL/kLwjGQlIUBOMvcQbBtAuC8Zf8BcFYSIqCYPwlziCYdkEw/pK/IBgLSVEQjL/kLwimXRCMv+QvCMZCUhQE4y/5C4JpFwTjL/kLgrGQFLU+X9aIAMEgGAtJUeKMv8QZBGMhKUq7+AuCsZAUJc74S5xBMO3WP0XpCwbBIBgLSdGVnS8jIkAwCMZCUhQE4y9xBsFYCILxl/wFwVhIioJg/CXOIJh2QTD+kr8gGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxl/wFwbQLgvGX/AXBWEiKgmD8JX9BMO2CYPwlf0EwFpKi1ufLGhEgGASrLbyFEEL1UqfTWScEHxwc3EAIofWXoNn6IVgc9zZCCK2/BM2WgeBGcQLBCKG6IrhRjkAwQgitDsF0RCCE0Mo6IkAwQgiBYIQQAsEgGCGEQDBCCIFgEIwQAsEgGCGEQDAIRgiBYBCMEEIgeGEEN5ut5r8NWsPvFNu9w2YHpiOEQHAZCG7ttD7+Rg3f2Lb/Oy4IhBAILhLBVvCVttpb3h4c//Vvfxfb4cAhAQgsoQvUaDj98fHheNjtNEAwCM5y6XR6/fFkNN1Srx5IkT22x4cnT/ygBdvh0aTvOgRWRbHZpRjfBgJtTpWvye545vLjo2G7sSQK1xbBd0afL4Lg8xcurmMRYXMRQwp7mnTHxzHyylssUQnsNGi9UeLjKhK0k+OR64DgmiPY7b336ZffLoLg4OXrUXccPZEu8UnXePUs53IXR9V2h6OjJyO3Udm4GY4wHtWjY6mgmxXFINiM4MOjY39LgjgWoqp0RHTE9XDs3d/QEbEIgls7OwKgiyP4o0+/SA2f8/nuWw/3gu3quzsruW58IgTXupl6y7ncg1Yqi2DzEQb/K6q2vuuoOygGPRCsQ3CykGx3eqP5p5oX1Q6hqymCH/zXo0IQLLZz586b+PvFnsxff7vgNFdy9zQlxYzFj8c9ELzIEcolsP3xg2AzgmOBla9SEFwfBDdbLZ+eSgQ3733z1N7l081L8nbWvaVD8Mf/+dAQO5+5wa+XftYSv177bHd1V/zs+o6VGCA4M4LnNxapvTogOBOCdbEFwfVB8O9u3tYh+Ow7gxh8g+3pV64rEWzuEY4huNmK/2UZV7w7ka9dm0s5uY/33Mkd+g+y+26vndYRJu7Bu4Oh3zEqbsZjj7nbHUds3RBwjv+XtrSb1w/r/zFIQvGerrfF8rYh3sqdj/cYDLuubYq24wfZsD/CohDsHfzsGLwjT33C4xsxSjMiGb1plGYN9RMNNRLx10Qs/p7TvzT0l4Fih3QEBztIhYLuus13DInrRxGZ2MnqApsv4BuN4ACdMQQ3P/rvWc37TnSO3IM/n77wsq4KFtvVV9uWCFb+peSKI172huzQP9KVL3fdQ//DsbaEGR09MYwNCD4SlFtQb0aPoSe/Z7iPOzlUtqV6pB6h2GByeKI9SJsjjDxTsq7LUgM7PXItVfsqI8QxJ0cZZm0o7NfW91DFIChdWuoPIYmkkR0KRHDuYwgKheS16l88wTUQC4juk2ARZ0HwDMFP7bwo+PvCuw8y9QWL7eD3/eoiuBPv/G1Y9EXI15M0Cif+5DqZQjK8xPvLD7sXQHCvH82TJATDZ+snClLruhrlF2ZF8HbGcX6Gk4odttIXDxaJkzUMccnaUGpRn4RdiQi27ohYBMFBK/LlGro8zo3gbM6C4BDBfgmc9XGceVyEDNzkc7nktpzezNSSR4bLtOCNPtZ3wxIymg9S8eLG7hYjYwNsOiLCa3qaGNP5SP4+sx4Dv7nkPKXw7JKfEPKjnsRBeuPP5qW9XVdJBIuPjzLMeQnSVbpvDd8t5ot82JGXSNWWjhTB8StpLr8q+KxVf3SZPssLRrDSwWIRLHsXu42QL+8cCLYPOAguDMGf/OnraiJYd4Ga785i15Pyoglv06R30N275Xscl34MDXUHn6HMVx72Ig8MVTW1CcTmwllXihq673UnKzdk+SzRbF8yFCUhWC5OlXVDIQg2VyHyMeRAcFEPb0GwLYLvf/6lTRxXgGB9UplLHmnEa8ptaSQny0FwjqtW+c4Nu9EgWcdsKHuWdWsIGCp03RGmfl7GHreW0VC4v/RuxSJ4+oEamedtw758x6Dsa9YlSFYE2wccBGsQ/ODPWRF8886DaiLYwNkQl6orJsfDmUT94hSG4Iz3bo1IB0JDUYlYTy21HzaXfAKTb5ZtOII72UuriYNyB8uGdJVm7HyVlC+kE8ByYnfBCO6kj45f5HFc1mQEwTMEP/1jVyD4qZ0Xk8x97tc3DQj+effXFURwyrNgYyFgM3BNeY0G15nfN9o3gtgSweYnXf4cYm9E2pFioZwIglUcKQrBOhDHXpgjUaXySrO0jao7OB8RdGxKfjCUh2DdaJYiEWxxJYDgEhH84ItHunHBp3dno4Cf/dUfmve+aX706OzBh/5ICXlcWgzBzVarggiOdDvOZ+LLm6FTMjeClcVg7GleUQhOXSLHpjOxWAQnhzplnWVrQHDqlvrwKh3BKqKFFNM8JMzfEXEir6ox7Lu9bsbpQvmOIfflDYKLQfAbb143zI5LTo1LdlDEEGwZx2UiOPmYaPGbPvuOZn/xxhiIDbV2PgSHvXUe5f0Enj2gM48DyTGfOGvaRMcwOCVXwcFKj70FESzbmuzij+9Z2oiIpSHY1MUPgktdI8KA4OkcjUdPd34hWCw28cP27T8Z+oL33XeqiGCpW1ZZAscK4az3y7ZVqvScyjB2NQeCLfuyV1IFG45wEQRnmpibH8EJPs57IfTP6NYWwVTBK0Nw9ze/LWqZHvs4LhPBlnmre+Rl83LLS0pXDy6IYMvXKvuCy3gcVx6Cs44zWZwIcs9vgDDl+yj7iBU9y6UhON8x2IQ0a2qA4MzrBX/68JvFEdxx3qoggm3G3JiTxDzCZttipFSmgiIHgk2DPTRrmNmHpWAEL/aULFOoCyFCuLTpwPHfRxexlNkcmlHYZSA40zFIl70G3JrV2kBwkQj2lwxeBMG3Ph5tV1L25V5ql6VuOoBy1GSjo16LRPcA2rLOzfq/hkHy6eOdO7ZH6KWxfhaGbgWJfIkqR1vzieh03cKIEN7dj4fzH3pZr7TI9LMyEZzvGMwhlR/zguASv7joxZeuLILgyiow26b30Hy/nJxoEH3cH00td+I9444tUu5qK45IhTKbcxxOeLPtC5bGMKWOCYtNUB5FlsXyHiHG0thwhNIo42P/G8/awfxpuQc847dmaAYqyLNpJ/Kyc9NB0F5zWbuSLOfmpE0OVE/zDUxfBoLzHYM8/036KFU8SQbBfH1nvgdxlrfbaatSqZc9MyNVuamqacX4UMvHUIYhH14empZa7430Y0XiCNYfYWyRF827TXTrV2R+SpbWXLEINtSPZlhHh/eW/jgu9zFMGT0xXQY8jlsqggcP7fnbfP3HVUZwajeuTdUcW3kvuUaicgKucuk/8xyN5MqW9iMBlOOC/THI5j5c3WKVXj3rOhmO0DV9Po1US8Qu1kXbUy9WmbjzKIQI9vdSsXVtZo5Lj/LKRnCOY9A56A1wnAaTERFLRbBQc+9866NHKcXvfm97UzWdhDZdMb3jpPYvB2urp+4c3k17++dZ1lo+sOx3DI7lcZqP0OsEd+fLyXecsr9YN2t4F+nOsn90GQSz3VnZd6DkO4bQPrmHJ/tcyvK0EQgOWfzyay3331sfjj3s3vmq9YdR86fuNkIb9YmbfT2NmqlS36q1WQhGCFX/a/3KvudbZGGzdUXwVhECwQgtDKA8I5Fr+QmUb4X1shG8VY5AMEKVKAAXeXC0NqfpTvynxImvMQ2feVakBF4egumIQGhlSPI6f6PfRzeu88Nn5Zccxr7nrTqfQPQFI7QJCH6i+7bA2p9v6oBuEAyCESq3/6E/W/FyWCn6lAxip+uv9z9fszjfyEgQDIIRQrUVCEYIIRAMghFCIBgEI4QQCAbBCCEQDIIRQggEg2CEEAiuBIIPDg5uIITQ+kvQbP0QjFDZev/el2IjDmg5WicEdxAqX2+OnoiNOKDlqNVqrQ2CTyFUsp49d+36d/8Qm/iBaKD1EghGa6+XP/yf69//n9jED0QDgeAVI1h5SrRbuCri76wEniK41EIYf8kjEIyFpGj8fIMSuOxCGH/JIxCMhaRo5HwjJXDJhTD+kkcgGAtJ0cj5xkrgUgth/CWPQDAWkqLh+SpK4DILYfwlj0AwFpKi4fkqS+DyCmH8JY9AMBaSorPz1ZbApRXC+EsegWAsJEVn52sogUsqhPGXPALBWEiKeuf7/KXrphK4nEIYf8kjEIyFpKh3vlcH/5vC3xIKYfwlj0AwFpKip6xK4BIKYfwlj0AwFpKipyxL4MILYfwlj0AwFm56iqYMhCizEMZf8ggEY+Gmp2jqQIjyCmH8JY9AMBZudIpmLoELLYTxlzwCwVi40SmaowQusBDGX/IIBGPh5qZozhK4uEIYf8kjEIyFm5uiuUvgogph/CWPQDAWbmiKLlQCF1QI4y95BIKxcENTdMESuJBCGH/JIxCMhRuaok+/cOHpxkV/e671ktiCX/3t4m//IiAr/o39PbK9cAF/yV8QjIWkaPHne+5fHwoEi3/xFwSDYCwkRUEw/hLnBRC8VYR8C7dQTVUpfy+8/ZVAsPgXX2rp76YJBCMQjL/k7+oQzI0M7dIRgb/kL33BWEiKgmD8BcFYSLsgGH/JIxCMhaQoCAbBIBgLaRcE4y9xBsFYSIqCYBAMgrGQFAXB+EucQTAWgmD8BcEgGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/JXxCMhaQoCMZf8hcE0y4Ixl/yFwRjISkKgvEXBGMh7YJg/CWPQDAWkqIgGASDYCykXRCMv+QRCMZCUhQEg2AQjIWkKAjGX+IMgrEQBINgEAyCsZAUBcH4S5xBMBaCYPwlf0EwFpKiIBh/iTMIpl0QjL/kLwjGQlIUBOMvcQbBtAuC8Zf8BcFYSIqCYPwlf0Ew7YJg/CV/QTAWkqIgGH/JXxBMuyAYf8lfEIyFpCgIxl8QjIW0C4LxlzwCwVhIioJgEAyCsZB2QTD+EmcQjIWkKAgGwXVE8FYR8i3cQjVVpfy98PZXAsHiX3yppb+bJhCMQDD+kr+rQzA3MrRLRwT+kr/0BWMhKQqC8RcEYyHtgmD8JY9AMBaSoiAYBINgLKRdEIy/xBkEYyEpCoJBMAjGQlIUBOMvcQbBWAiC8RcEg2AsJEVBMP4SZxBMuyAYf8lfEIyFpCgIxl/iDIJpFwTjL/kLgrGQFAXB+EucQTDtgmD8JX9BMBaSoiAYf8lfEEy7IBh/yV8QjIWkKAjGXxCMhbQLgvGXPALBWEiKgmAQDIKxkHZBMP6SRyAYC0lREAyCQTAWkqIgGH+JMwjGQhAMgkEwCMZCUhQE4y9xBsFYCILxl/wFwVhIioJg/CXOIJh2QTD+kr8gGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxl/wFwbS77v6eefHngr/iX/wFwSC4hhbeQggVoU6nA4JBcB4EHxwc3EAI5ZXIIBAMgvMjWFxD2wihvBIZBIJBMAhGCASDYBCMEAgGwSAYBCMEgkEwCEYIBIPgOYIbKCoQjFCxCIYqBoFgEIwQCF4dgumIoCMCIToi6AsGwQiBYBAMgkEwQiAYBINghEAwCAbBCCEQDIKrj+Ar7eZ+r/nesHl73Lo/EZv4wft1vyf+i7REIBgEg+BSENy89tPmB39qffIXwyZ2ELuRnAgEg2AQXByCL15u3fyjGb6R7eYfxUs2IQkbDac/Pj4cD7udxkrep+FO/vq3v4vt8bi3kgi0B8f+ARwOnBoYAYJBcPUQ/Oq11t2vM/DX3+5+LV5YeXpORupt2HWddiM9mbvjJzMCHg1t9i/8fQpEsCkgA4E2p8oILsoIEAyCK4Zgwd8H32Xmr789+K7KFG40eqOTWd7qtsdHk77rbAyCUwLy+OR4lIgGCAbBILg0BF+8nKf+jdXCVe2RsEFwAGLd7W2jMxwdHR8KUi/YEZH3fUpC8KF3MN6WjEYMtVXpiCjICBAMgiuE4Gz9v4Z+4TQ5n+++9XAv2K6+u7NMBCfrJnFL3u70+uNjuQBcZm6vFsHJgIhojI6eKENREQTzOA4E1w3BzWs/LYC//jAJ4xgJ54s9mb/+dsFprhDBUm3V62vQs1EInvUUB6GQ2gLBIBgEl4Ng/fiz5vC7swcfbrV/8tS5K6daF09feu3pN35xtne3NfxeN1LN0JDP3ODXSz9riV+vfbZbBQT76FlJP2PVEOzf7B/6O5xMuvMdQDAIBsElIPhKW8ff7btfb71yXZA3uT3jdLWv0s/aiCG42Yr/ZbUIjhWAIzfZZTHd5u/Q6Mz+Yn7D+KsSf1ER0Om6Q3/ARn8+YMMGwd6nyOyFk77ba+v6tVMRHOwg3RDoEDyPg+l0UndInu+0V0QRKF0AlQYp3xYEg+AKIbi539PVv1uvvCVo+89Xromyd/vOI/HHH9159Hzv7vQv97SF837PEsHKv6wWwRHSRXdOAij4i4GJQVkdAN1cSzakrtjY+AQzgv3RsqoHjIrxswUiODfVj0IAAAYoSURBVPjQkutlzVspdshxvroAyn+f3tAcq962AYJBcMUQ/P4nSpKe+c0Hgr8/fPnN5v1v4/+r6YWYIfj9T9YbwSr6KDNfebeeSh8DgoM3nNMzMlBBVHM6BHsgk14YG+GQPLwCOyIWQXD8fE+sztcCwWG3vheKaBP5evlBMAguDcGajmC/C+L53w8zP5HTdwfLwE0+l0tuK0Kwui9CgWB9r0WsoJZhob2dlwaKxUrXthtFVRRJ8mEI+sg9HkElmHhJSkDCAl/aoVgEG893YjjfVATPHXGUH1H5etJBMAguC8Gtj79VkvT0nvf8TVECp24ff7vWCFb2HmgBZOwc8N/HcmiXuVtDLhgtkRTlY+QYUkZESG2lRyAvggs/XxnByU/E1FsWEAyC64/gJI7XHsGGu+zgvywIouv9SGW0uadVV4krAxIMkc7EvnwItjnfcHRKRgSbR9rl64sAwSB4NR0RLxTaEVE/BOt2lvfX/T0CsqBGM4x2UFXcqS9U7mA3Yzsxa6NABOc9X8vHcfa2gmAQXNXHcW/f8oZDvPRG89438WFnd75q3jvM8ThuLRBs3xdsIqMeTOYODcOQWyW2pNJPtw6RqXa2XyCiYATbnC8IBsGbPCit9cn3P7zieNMxLrbP/vaONyht+P2Pbo+fe/s/Tp+/Kmrk5v1J1kFpa4LglL7LxGM0BYMCXCZxoHwfm1kPZgRbLH8h9zmE/QDyonF9t2dYAbJABFudLwgGwZuAYNPUjDuPfvjym8qpGf/ykwPd0DTLL9SoLoKtxwUb+hz8vyi7Hc0INtAhbxUcrELZUyA4yyTAMhBsOl8QDII3AsHGCcqiFj7z9i1R8z6199JTu5dPX379metvv9D/bMGO4Moi2DDOzGY8rw+LkEqq5vJXwSok5Zs0XB0EUwWDYBC8vGV6qo/gcCCt3cMoJYYCIitTPcfgNtOIiFwLRxSIYN3YO/NosNznC4JBcA0RvL3ExSori+DIRAbrDoQkCkV6z3sh1FVhyogIHcg0q5elDkpbGoJT56eoR0RkPF8QDILrieANWbJdOxnMHcqL5NpXr6pRwMNZRayp71JBJl6YPEh5xYPYO5tfOPt0cZ3yEKzrPY8NvYh9SOQ+XxAMguuI4O2N+OKi6AAAbzuMrhFjMzPCnOGPp4sS5HifyHww6cs7GtEV5Q2zjecvlItrpzvwJvtmnaCc7cg1U43j86pjE5Tzni8IBsE1RfB2jb++0+qLiw41VaRlhgfFoBltNiMr1EPKXMMyPRHYKV5eJoINRz69pdB2lbSliNmfLwgGwfVF8HY9v8TegGCvaPWW1k1fTDYdwWmr9ti8j9wlEvtsSFmsMlE8hhAc9NoZV0rLdeST2MfA4+nXu5l7q5Pn662XNjCdLwgGwbVG8HyMhHGk2mz8mf34B5TtM6PjtN1e15sokfn7Kdqd6Qunr13+F39MV0n3Wm9nWYdBeb42M+iWJhAMgpeK4JmutJv7veZ7w+btcev+RGziB+/X/Z7l/AuEcstm+gYIBsG1RjBCK+s7WmhhMxAMgkEwQgWUwIt/VykIBsEgGKFEnetOvOd1iQeh8nPFipTAIBgEg2BUQwTHvjUu+T1vVegFBsEgGASjOiLYOJZZnqwBgtcMwVtFyEfwVi0EglGFQex03WFfWrO4665gLF1WBG8hvUAwCEYIBK8OwXRE0BGBEB0R9AWDYIRAMAgGwSAYIRAMgkEwQiAYBINghBAIBsEgGCEQDII3AcEHBwc3EEJ5JTIIBIPg/AhGCC0uEAyC86iDECpCrVYLBINghFBFBYJBMEIIBINgLKx2u/iLv8QZBGMhKUq7+AuCsZAUJc74S5xBMBaSorSLvyAYC0lR4oy/xBkE0y4pSrv4C4KxkBQlzvhLnEEw7ZKitIu/IBgLSVHijL/EGQTTLv7SLv6CYCwkRYkz/uIvCKZd/KVd/AXBWEiKEmf8BcFYSLv4i7/EGQRjISmKv/gLgrGQdvEXf4kzCMZCUpR28RcEYyEpSpzxlziDYCwkRWkXf0EwFpKixBl/iTMIJkVJUdrFXxCMhaQoccZf4gyCaZcUpV38BcFYSIoSZ/wlziCYdvGXdvG3su3+P1nK/SpJ8iNQAAAAAElFTkSuQmCC"></p><ul><li>ShenyuPluginï¼šé¡¶å±‚æ¥å£ï¼Œå®šä¹‰æ¥å£æ–¹æ³•ï¼›</li><li>AbstractShenyuPluginï¼šæŠ½è±¡ç±»ï¼Œå®ç°æ’ä»¶å…±æœ‰é€»è¾‘ï¼›</li><li>DividePluginï¼šDivideæ’ä»¶ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶è¯·æ±‚"></a>2.1 æ¥æ”¶è¯·æ±‚<a class="hash-link" href="#21-æ¥æ”¶è¯·æ±‚" title="Direct link to heading">#</a></h4><p>é€šè¿‡<code>ShenYu</code>ç½‘å…³ä»£ç†åï¼Œè¯·æ±‚å…¥å£æ˜¯<code>ShenyuWebHandler</code>ï¼Œå®ƒå®ç°äº†<code>org.springframework.web.server.WebHandler</code>æ¥å£ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¤„ç†webè¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // æ‰§è¡Œé»˜è®¤æ’ä»¶é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * å®ä¾‹åŒ–é»˜è®¤æ’ä»¶é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * æ‰§è¡Œæ¯ä¸ªæ’ä»¶.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // è·å–å½“å‰æ‰§è¡Œæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ˜¯å¦è·³è¿‡å½“å‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœè·³è¿‡å°±æ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ‰§è¡Œå½“å‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-åŒ¹é…è§„åˆ™"></a>2.2 åŒ¹é…è§„åˆ™<a class="hash-link" href="#22-åŒ¹é…è§„åˆ™" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>åœ¨<code>execute()</code>æ–¹æ³•ä¸­æ‰§è¡Œé€‰æ‹©å™¨å’Œè§„åˆ™çš„åŒ¹é…é€»è¾‘ã€‚</p><ul><li>åŒ¹é…é€‰æ‹©å™¨ï¼›</li><li>åŒ¹é…è§„åˆ™ï¼›</li><li>æ‰§è¡Œæ’ä»¶ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŒ¹é…é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŒ¹é…è§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ‰§è¡Œæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-æ‰§è¡Œdivideæ’ä»¶"></a>2.3 æ‰§è¡Œdivideæ’ä»¶<a class="hash-link" href="#23-æ‰§è¡Œdivideæ’ä»¶" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.divide.DividePlugin#doExecute()</li></ul><p>åœ¨<code>doExecute()</code>æ–¹æ³•ä¸­æ‰§è¡Œ<code>divide</code>æ’ä»¶çš„å…·ä½“é€»è¾‘ï¼š</p><ul><li>æ ¡éªŒ<code>header</code>å¤§å°ï¼›</li><li>æ ¡éªŒ<code>request</code>å¤§å°ï¼›</li><li>è·å–æœåŠ¡åˆ—è¡¨ï¼›</li><li>å®ç°è´Ÿè½½å‡è¡¡ï¼›</li><li>è®¾ç½®è¯·æ±‚<code>url</code>ï¼Œè¶…æ—¶æ—¶é—´ï¼Œé‡è¯•ç­–ç•¥ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–è§„åˆ™çš„handleå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DivideRuleHandle ruleHandle = DividePluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long headerSize = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¡éªŒheaderå¤§å°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (List&lt;String&gt; multiHeader : exchange.getRequest().getHeaders().values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String value : multiHeader) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                headerSize += value.getBytes(StandardCharsets.UTF_8).length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (headerSize &gt; ruleHandle.getHeaderMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request header is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_HEADER_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¡éªŒrequestå¤§å°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (exchange.getRequest().getHeaders().getContentLength() &gt; ruleHandle.getRequestMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request entity is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_ENTITY_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æœåŠ¡åˆ—è¡¨upstreamList</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide upstream configuration errorï¼š {}&quot;, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯·æ±‚ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å®ç°è´Ÿè½½å‡è¡¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide has no upstream&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String domain = upstream.buildDomain();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_DOMAIN, domain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_TIME_OUT, ruleHandle.getTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_RETRY, ruleHandle.getRetry());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®é‡è¯•ç­–ç•¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.RETRY_STRATEGY, ruleHandle.getRetryStrategy());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.LOAD_BALANCE, ruleHandle.getLoadBalance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.DIVIDE_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-å‘èµ·è¯·æ±‚"></a>2.4 å‘èµ·è¯·æ±‚<a class="hash-link" href="#24-å‘èµ·è¯·æ±‚" title="Direct link to heading">#</a></h4><p>é»˜è®¤ç”±<code>WebClientPlugin</code>å‘<code>http</code>æœåŠ¡å‘èµ·è°ƒç”¨è¯·æ±‚ï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/WebClientPlugin-64ae237cda7fd819160795669ee2e2bd.png"></p><ul><li>ShenyuPluginï¼šé¡¶å±‚æ’ä»¶ï¼Œå®šä¹‰æ’ä»¶æ–¹æ³•ï¼›</li><li>AbstractHttpClientPluginï¼šæŠ½è±¡ç±»ï¼Œå®ç°è¯·æ±‚è°ƒç”¨çš„å…¬å…±é€»è¾‘ï¼›</li><li>WebClientPluginï¼šé€šè¿‡<code>WebClient</code>å‘èµ·è¯·æ±‚ï¼›</li><li>NettyHttpClientPluginï¼šé€šè¿‡<code>Netty</code>å‘èµ·è¯·æ±‚ã€‚</li></ul><p>å‘èµ·è¯·æ±‚è°ƒç”¨ï¼š</p><ul><li>org.apache.shenyu.plugin.httpclient.AbstractHttpClientPlugin#execute()</li></ul><p>åœ¨<code>execute()</code>æ–¹æ³•ä¸­å‘èµ·è¯·æ±‚è°ƒç”¨ï¼š</p><ul><li>è·å–æŒ‡å®šçš„è¶…æ—¶æ—¶é—´ï¼Œé‡è¯•æ¬¡æ•°</li><li>å‘èµ·è¯·æ±‚</li><li>æ ¹æ®æŒ‡å®šçš„é‡è¯•ç­–ç•¥è¿›è¡Œå¤±è´¥åé‡è¯•æ“ä½œ</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractHttpClientPlugin&lt;R&gt; implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static final Logger LOG = LoggerFactory.getLogger(AbstractHttpClientPlugin.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final URI uri = exchange.getAttribute(Constants.HTTP_URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æŒ‡å®šçš„è¶…æ—¶æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final long timeout = (long) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_TIME_OUT)).orElse(3000L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Duration duration = Duration.ofMillis(timeout);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æŒ‡å®šé‡è¯•æ¬¡æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int retryTimes = (int) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_RETRY)).orElse(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æŒ‡å®šçš„é‡è¯•ç­–ç•¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String retryStrategy = (String) Optional.ofNullable(exchange.getAttribute(Constants.RETRY_STRATEGY)).orElseGet(RetryEnum.CURRENT::getName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;The request urlPath is {}, retryTimes is {}, retryStrategy is {}&quot;, uri.toASCIIString(), retryTimes, retryStrategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºheader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final HttpHeaders httpHeaders = buildHttpHeaders(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘èµ·è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;R&gt; response = doRequest(exchange, exchange.getRequest().getMethodValue(), uri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é‡è¯•ç­–ç•¥CURRENTï¼Œå¯¹å½“å‰æœåŠ¡è¿›è¡Œé‡è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RetryEnum.CURRENT.getName().equals(retryStrategy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //old version of DividePlugin and SpringCloudPlugin will run on this</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response.retryWhen(Retry.anyOf(TimeoutException.class, ConnectTimeoutException.class, ReadTimeoutException.class, IllegalStateException.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .retryMax(retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .backoff(Backoff.exponential(Duration.ofMillis(200), Duration.ofSeconds(20), 2, true)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯¹å…¶ä»–æœåŠ¡è¿›è¡Œé‡è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’é™¤å·²ç»è°ƒç”¨è¿‡çš„æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Set&lt;URI&gt; exclude = Sets.newHashSet(uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯·æ±‚é‡è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resend(response, exchange, duration, httpHeaders, exclude, retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; clientResponse,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final int retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;R&gt; result = clientResponse;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®æŒ‡å®šçš„é‡è¯•æ¬¡æ•°è¿›è¡Œé‡è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; retryTimes; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = resend(result, exchange, duration, httpHeaders, exclude);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; response,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response.onErrorResume(th -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String selectorId = exchange.getAttribute(Constants.DIVIDE_SELECTOR_ID);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String loadBalance = exchange.getAttribute(Constants.LOAD_BALANCE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æŸ¥è¯¢å¯ç”¨æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selectorId)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .stream().filter(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String trimUri = data.getUrl().trim();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (URI needToExclude : exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // exclude already called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if ((needToExclude.getHost() + &quot;:&quot; + needToExclude.getPort()).equals(trimUri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è¯·æ±‚ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å®ç°è´Ÿè½½å‡è¡¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Upstream upstream = LoadBalancerFactory.selector(upstreamList, loadBalance, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final URI newUri = RequestUrlUtils.buildRequestUri(exchange, upstream.buildDomain());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’é™¤å·²ç»è°ƒç”¨çš„uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exclude.add(newUri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // è¿›è¡Œå†æ¬¡è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doRequest(exchange, exchange.getRequest().getMethodValue(), newUri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.httpclient.WebClientPlugin#doRequest()</li></ul><p>åœ¨<code>doRequest()</code>æ–¹æ³•ä¸­é€šè¿‡<code>webClient</code>å‘èµ·çœŸæ­£çš„è¯·æ±‚è°ƒç”¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;ClientResponse&gt; doRequest(final ServerWebExchange exchange, final String httpMethod, final URI uri,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final HttpHeaders httpHeaders, final Flux&lt;DataBuffer&gt; body) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return webClient.method(HttpMethod.valueOf(httpMethod)).uri(uri) //è¯·æ±‚uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .headers(headers -&gt; headers.addAll(httpHeaders)) // è¯·æ±‚header</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .body(BodyInserters.fromDataBuffers(body))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .exchange() // å‘èµ·è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnSuccess(res -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (res.statusCode().is2xxSuccessful()) { // æˆåŠŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else { // å¤±è´¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.ERROR.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getResponse().setStatusCode(res.statusCode());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.CLIENT_RESPONSE_ATTR, res);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-å¤„ç†å“åº”ç»“æœ"></a>2.5 å¤„ç†å“åº”ç»“æœ<a class="hash-link" href="#25-å¤„ç†å“åº”ç»“æœ" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>å“åº”ç»“æœç”±<code>ResponsePlugin</code>æ’ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®rpcç±»å‹å¤„ç†ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¤„ç†ç±»å‹ç”±<code>MessageWriter</code>å†³å®šï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriterï¼šæ¥å£ï¼Œå®šä¹‰æ¶ˆæ¯å¤„ç†æ–¹æ³•ï¼›</li><li>NettyClientMessageWriterï¼šå¤„ç†<code>Netty</code>è°ƒç”¨ç»“æœï¼›</li><li>RPCMessageWriterï¼šå¤„ç†<code>RPC</code>è°ƒç”¨ç»“æœï¼›</li><li>WebClientMessageWriterï¼šå¤„ç†<code>WebClient</code>è°ƒç”¨ç»“æœï¼›</li></ul><p>é»˜è®¤æ˜¯é€šè¿‡<code>WebCient</code>å‘èµ·<code>http</code>è¯·æ±‚ã€‚</p><ul><li>org.apache.shenyu.plugin.response.strategy.WebClientMessageWriter#writeWith()</li></ul><p>åœ¨<code>writeWith()</code>æ–¹æ³•ä¸­å¤„ç†å“åº”ç»“æœã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–å“åº”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerHttpResponse response = exchange.getResponse();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientResponse clientResponse = exchange.getAttribute(Constants.CLIENT_RESPONSE_ATTR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(clientResponse)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è·å–cookieså’Œheaders</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getCookies().putAll(clientResponse.cookies());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getHeaders().putAll(clientResponse.headers().asHttpHeaders());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // image, pdf or stream does not do format processing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¤„ç†ç‰¹æ®Šå“åº”ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clientResponse.headers().contentType().isPresent()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String media = clientResponse.headers().contentType().get().toString().toLowerCase();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (media.matches(COMMON_BIN_MEDIA_TYPE_REGEX)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return response.writeWith(clientResponse.body(BodyExtractors.toDataBuffers()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¤„ç†ä¸€èˆ¬å“åº”ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clientResponse = ResponseUtils.buildClientResponse(response, clientResponse.body(BodyExtractors.toDataBuffers()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return clientResponse.bodyToMono(byte[].class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap(originData -&gt; WebFluxResultUtils.result(exchange, originData))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ†æè‡³æ­¤ï¼Œå…³äº<code>Divide</code>æ’ä»¶çš„æºç åˆ†æå°±å®Œæˆäº†ï¼Œåˆ†ææµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/divide-execute-zh-c145705430fc3aec6e561cc4ad183a05.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-å°ç»“"></a>3. å°ç»“<a class="hash-link" href="#3-å°ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡æºç åˆ†æä»<code>http</code>æœåŠ¡æ³¨å†Œå¼€å§‹ï¼Œåˆ°<code>divide</code>æ’ä»¶çš„æœåŠ¡è°ƒç”¨ã€‚<code>divide</code>æ’ä»¶ä¸»è¦ç”¨æ¥å¤„ç†<code>http</code>è¯·æ±‚ã€‚æœ‰äº›æºç æ²¡æœ‰è¿›å…¥æ·±å…¥åˆ†æï¼Œæ¯”å¦‚è´Ÿè½½å‡è¡¡çš„å®ç°ï¼ŒæœåŠ¡æ¢æ´»ï¼Œå°†åœ¨åç»­ç»§ç»­åˆ†æã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/divide">divide</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin">Dubboæ’ä»¶æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-06-01T03:06:51.476Z">2023å¹´6æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p><code>Apache ShenYu</code> ç½‘å…³ä½¿ç”¨ <code>dubbo</code> æ’ä»¶å®Œæˆå¯¹ <code>dubbo</code>æœåŠ¡çš„è°ƒç”¨ã€‚ä½ å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo" target="_blank" rel="noopener noreferrer">Dubboå¿«é€Ÿå¼€å§‹</a> äº†è§£å¦‚ä½•ä½¿ç”¨è¯¥æ’ä»¶ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.3</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/user-guide/dubbo-proxy/" target="_blank" rel="noopener noreferrer">DubboæœåŠ¡æ¥å…¥</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-æœåŠ¡æ³¨å†Œ"></a>1. æœåŠ¡æ³¨å†Œ<a class="hash-link" href="#1-æœåŠ¡æ³¨å†Œ" title="Direct link to heading">#</a></h3><p>ä»¥å®˜ç½‘æä¾›çš„ä¾‹å­ä¸ºä¾‹ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-dubbo/shenyu-examples-apache-dubbo-service" target="_blank" rel="noopener noreferrer">shenyu-examples-dubbo</a> ã€‚ å‡å¦‚ä½ çš„<code>dubbo</code>æœåŠ¡å®šä¹‰å¦‚ä¸‹(<code>spring-dubbo.xml</code>)ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">xsi</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">dubbo</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://code.alibabatech.com/schema/dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xsi:</span><span class="token tag attr-name" style="color:#00a4db">schemaLocation</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://code.alibabatech.com/schema/dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       https://code.alibabatech.com/schema/dubbo/dubbo.xsd</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">application</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">test-dubbo-service</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">registry</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">${dubbo.registry.address}</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">protocol</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">port</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">20888</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">service</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">timeout</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">10000</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">interface</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">org.apache.shenyu.examples.dubbo.api.service.DubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å£°æ˜åº”ç”¨æœåŠ¡åç§°ï¼Œæ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä½¿ç”¨<code>dubbo</code>åè®®ï¼Œå£°æ˜æœåŠ¡æ¥å£ï¼Œå¯¹åº”æ¥å£å®ç°ç±»ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * DubboTestServiceImpl.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨æ¥å£å®ç°ç±»ä¸­ï¼Œä½¿ç”¨æ³¨è§£<code>@ShenyuDubboClient</code>å‘<code>shenyu-admin</code>æ³¨å†ŒæœåŠ¡ã€‚è¯¥æ³¨è§£çš„ä½œç”¨åŠåŸç†ï¼Œç¨åå†è¿›è¡Œåˆ†æã€‚</p><p>åœ¨é…ç½®æ–‡ä»¶<code>application.yml</code>ä¸­çš„é…ç½®ä¿¡æ¯ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8011</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">servlet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">context-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">main</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">allow-bean-definition-overriding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2181</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># dubboä½¿ç”¨çš„æ³¨å†Œä¸­å¿ƒ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span><span class="token comment" style="color:#999988;font-style:italic">#æ³¨å†Œæ–¹å¼</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#æ³¨å†Œåœ°å€</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dubbo  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜<code>dubbo</code>ä½¿ç”¨çš„æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œ<code>dubbo</code>æœåŠ¡å‘<code>shenyu-admin</code>æ³¨å†Œï¼Œä½¿ç”¨çš„æ–¹å¼æ˜¯<code>http</code>ï¼Œæ³¨å†Œåœ°å€æ˜¯<code>http://localhost:9095</code>ã€‚</p><p>å…³äºæ³¨å†Œæ–¹å¼çš„ä½¿ç”¨ï¼Œè¯·å‚è€ƒ <a href="https://shenyu.apache.org/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">åº”ç”¨å®¢æˆ·ç«¯æ¥å…¥</a> ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--å£°æ˜æ³¨å†Œæ¥å£"></a>1.1  å£°æ˜æ³¨å†Œæ¥å£<a class="hash-link" href="#11--å£°æ˜æ³¨å†Œæ¥å£" title="Direct link to heading">#</a></h4><p>ä½¿ç”¨æ³¨è§£<code>@ShenyuDubboClient</code>å°†æœåŠ¡æ³¨å†Œåˆ°ç½‘å…³ã€‚ç®€å•<code>demo</code>å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// dubboæœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;) // éœ€è¦æ³¨å†Œçš„æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ³¨è§£å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ä½œç”¨äºç±»å’Œæ–¹æ³•ä¸Š</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuDubboClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ˜¯å¦å¯ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-æ‰«ææ³¨è§£ä¿¡æ¯"></a>1.2 æ‰«ææ³¨è§£ä¿¡æ¯<a class="hash-link" href="#12-æ‰«ææ³¨è§£ä¿¡æ¯" title="Direct link to heading">#</a></h4><p>æ³¨è§£æ‰«æé€šè¿‡<code>ApacheDubboServiceBeanListener</code>å®Œæˆï¼Œå®ƒå®ç°äº†<code>ApplicationListener&lt;ContextRefreshedEvent&gt;</code>æ¥å£ï¼Œåœ¨<code>Spring</code>å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶æ—¶ï¼Œå¼€å§‹æ‰§è¡Œäº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ã€‚</p><p>åœ¨æ„é€ å™¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼š</p><ul><li>è¯»å–å±æ€§é…ç½®</li><li>å¼€å¯çº¿ç¨‹æ± </li><li>å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼Œç”¨äºå‘<code>shenyu-admin</code>æ³¨å†Œ</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboServiceBeanListener implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApacheDubboServiceBeanListener(final PropertiesConfig clientConfig, final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.è¯»å–å±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(&quot;apache dubbo client must config the contextPath or appName&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = contextPath;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = appName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.å¼€å¯çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executorService = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder().setNameFormat(&quot;shenyu-apache-dubbo-client-thread-pool-%d&quot;).build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.å¯åŠ¨æ³¨å†Œä¸­å¿ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ï¼Œæ‰§è¡Œæ–¹æ³•é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ApacheDubboServiceBeanListener#onApplicationEvent()</li></ul><p>é‡å†™çš„æ–¹æ³•é€»è¾‘ï¼šè¯»å–<code>Dubbo</code>æœåŠ¡<code>ServiceBean</code>ï¼Œæ„å»ºå…ƒæ•°æ®å¯¹è±¡å’Œ<code>URI</code>å¯¹è±¡ï¼Œå¹¶å‘<code>shenyu-admin</code>æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¯»å–ServiceBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ServiceBean&gt; serviceBean = contextRefreshedEvent.getApplicationContext().getBeansOfType(ServiceBean.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (serviceBean.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¿è¯è¯¥æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¤„ç†å…ƒæ•°æ®å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, ServiceBean&gt; entry : serviceBean.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler(entry.getValue());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¤„ç†URIå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceBean.values().stream().findFirst().ifPresent(bean -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(bean));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>handler()</p><p>åœ¨<code>handler()</code>æ–¹æ³•ä¸­ï¼Œä»<code>serviceBean</code>ä¸­è¯»å–æ‰€æœ‰æ–¹æ³•ï¼Œåˆ¤æ–­æ–¹æ³•ä¸Šæ˜¯å¦æœ‰<code>ShenyuDubboClient</code>æ³¨è§£ï¼Œå¦‚æœå­˜åœ¨å°±æ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œå¹¶é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼Œå‘<code>shenyu-admin</code>æ³¨å†Œè¯¥æ–¹æ³•ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void handler(final ServiceBean&lt;?&gt; serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–ä»£ç†å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object refProxy = serviceBean.getRef();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–classä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = refProxy.getClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (AopUtils.isAopProxy(refProxy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clazz = AopUtils.getTargetClass(refProxy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–æ‰€æœ‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è¯»å–ShenyuDubboClientæ³¨è§£ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuDubboClient shenyuDubboClient = method.getAnnotation(ShenyuDubboClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(shenyuDubboClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //æ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œå¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(serviceBean, shenyuDubboClient, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildMetaDataDTO()</p><p>æ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œåœ¨è¿™é‡Œæ„å»ºæ–¹æ³•æ³¨å†Œçš„å¿…è¦ä¿¡æ¯ï¼Œåç»­ç”¨äºé€‰æ‹©å™¨æˆ–è§„åˆ™åŒ¹é…ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO(final ServiceBean&lt;?&gt; serviceBean, final ShenyuDubboClient shenyuDubboClient, final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åº”ç”¨åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = buildAppName(serviceBean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ–¹æ³•è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = contextPath + shenyuDubboClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String desc = shenyuDubboClient.desc();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æœåŠ¡åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String serviceName = serviceBean.getInterface();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configRuleName = shenyuDubboClient.ruleName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleName = (&quot;&quot;.equals(configRuleName)) ? path : configRuleName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ–¹æ³•åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String methodName = method.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å‚æ•°ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] parameterTypesClazz = method.getParameterTypes();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String parameterTypes = Arrays.stream(parameterTypesClazz).map(Class::getName).collect(Collectors.joining(&quot;,&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .serviceName(serviceName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .methodName(methodName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(ruleName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(desc)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .parameterTypes(parameterTypes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcExt(buildRpcExt(serviceBean)) //dubboæœåŠ¡çš„æ‰©å±•ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuDubboClient.enabled())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildRpcExt()</p><p> <code>dubbo</code>æœåŠ¡çš„æ‰©å±•ä¿¡æ¯</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   private String buildRpcExt(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       DubboRpcExt build = DubboRpcExt.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .group(StringUtils.isNotEmpty(serviceBean.getGroup()) ? serviceBean.getGroup() : &quot;&quot;)//åˆ†ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .version(StringUtils.isNotEmpty(serviceBean.getVersion()) ? serviceBean.getVersion() : &quot;&quot;)//ç‰ˆæœ¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .loadbalance(StringUtils.isNotEmpty(serviceBean.getLoadbalance()) ? serviceBean.getLoadbalance() : Constants.DEFAULT_LOADBALANCE)//è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé»˜è®¤éšæœº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .retries(Objects.isNull(serviceBean.getRetries()) ? Constants.DEFAULT_RETRIES : serviceBean.getRetries())//é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .timeout(Objects.isNull(serviceBean.getTimeout()) ? Constants.DEFAULT_CONNECT_TIMEOUT : serviceBean.getTimeout())//è¶…æ—¶ï¼Œé»˜è®¤3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .sent(Objects.isNull(serviceBean.getSent()) ? Constants.DEFAULT_SENT : serviceBean.getSent())//sentï¼Œé»˜è®¤false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .cluster(StringUtils.isNotEmpty(serviceBean.getCluster()) ? serviceBean.getCluster() : Constants.DEFAULT_CLUSTER)//é›†ç¾¤ç­–ç•¥ï¼Œé»˜è®¤failover</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .url(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return GsonUtils.getInstance().toJson(build);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><ul><li><p>buildURIRegisterDTO()</p><p>æ„å»º<code>URI</code>å¯¹è±¡ï¼Œæ³¨å†ŒæœåŠ¡æœ¬èº«çš„ä¿¡æ¯ï¼Œåç»­å¯ç”¨äºæœåŠ¡æ¢æ´»ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private URIRegisterDTO buildURIRegisterDTO(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(this.contextPath) //ä¸Šä¸‹æ–‡è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(buildAppName(serviceBean))//åº”ç”¨åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())//rpcç±»å‹ï¼šdubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost()) //host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))//port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…·ä½“çš„æ³¨å†Œé€»è¾‘ç”±æ³¨å†Œä¸­å¿ƒå®ç°ï¼Œè¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥åŸç†</a> ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//å‘æ³¨å†Œä¸­å¿ƒï¼Œå‘å¸ƒæ³¨å†Œäº‹ä»¶   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">publisher.publishEvent();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-å¤„ç†æ³¨å†Œä¿¡æ¯"></a>1.3 å¤„ç†æ³¨å†Œä¿¡æ¯<a class="hash-link" href="#13-å¤„ç†æ³¨å†Œä¿¡æ¯" title="Direct link to heading">#</a></h4><p>å®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„å…ƒæ•°æ®å’Œ<code>URI</code>æ•°æ®ï¼Œåœ¨<code>shenyu-admin</code>ç«¯è¿›è¡Œå¤„ç†ï¼Œè´Ÿè´£å­˜å‚¨åˆ°æ•°æ®åº“å’ŒåŒæ­¥ç»™<code>shenyu</code>ç½‘å…³ã€‚<code>Dubbo</code>æ’ä»¶çš„å®¢æˆ·ç«¯æ³¨å†Œå¤„ç†é€»è¾‘åœ¨<code>ShenyuClientRegisterDubboServiceImpl</code>ä¸­ã€‚ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/ShenyuClientRegisterDubboServiceImpl-a48cc4b745cb6a47ee000cf08d4cff04.png"></p><ul><li>ShenyuClientRegisterServiceï¼šå®¢æˆ·ç«¯æ³¨å†ŒæœåŠ¡ï¼Œé¡¶å±‚æ¥å£ï¼›</li><li>FallbackShenyuClientRegisterServiceï¼šæ³¨å†Œå¤±è´¥ï¼Œæä¾›é‡è¯•æ“ä½œï¼›</li><li>AbstractShenyuClientRegisterServiceImplï¼šæŠ½è±¡ç±»ï¼Œå®ç°éƒ¨åˆ†å…¬å…±æ³¨å†Œé€»è¾‘ï¼›</li><li>ShenyuClientRegisterDubboServiceImplï¼šå®ç°<code>Dubbo</code>æ’ä»¶çš„æ³¨å†Œï¼›</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="131-æ³¨å†ŒæœåŠ¡"></a>1.3.1 æ³¨å†ŒæœåŠ¡<a class="hash-link" href="#131-æ³¨å†ŒæœåŠ¡" title="Direct link to heading">#</a></h5><ul><li><p>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</p><p>å®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„å…ƒæ•°æ®<code>MetaDataRegisterDTO</code>å¯¹è±¡åœ¨<code>shenyu-admin</code>çš„<code>register()</code>æ–¹æ³•è¢«æ¥é€åˆ°ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1311-æ³¨å†Œé€‰æ‹©å™¨"></a>1.3.1.1 æ³¨å†Œé€‰æ‹©å™¨<a class="hash-link" href="#1311-æ³¨å†Œé€‰æ‹©å™¨" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>æ„å»º<code>contextPath</code>ï¼ŒæŸ¥æ‰¾é€‰æ‹©å™¨ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è¿”å›<code>id</code>ï¼›ä¸å­˜åœ¨å°±åˆ›å»ºé»˜è®¤çš„é€‰æ‹©å™¨ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºcontextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é€šè¿‡åç§°æŸ¥æ‰¾é€‰æ‹©å™¨ä¿¡æ¯æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¸å­˜åœ¨å°±åˆ›å»ºé»˜è®¤çš„é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>é»˜è®¤é€‰æ‹©å™¨ä¿¡æ¯</p><p>åœ¨è¿™é‡Œæ„å»ºé»˜è®¤é€‰æ‹©å™¨ä¿¡æ¯åŠå…¶æ¡ä»¶å±æ€§ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ³¨å†Œé»˜è®¤é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //æ„å»ºé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºé»˜è®¤é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //æ„å»ºé»˜è®¤é€‰æ‹©å™¨çš„æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤é€‰æ‹©å™¨</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // é»˜è®¤ç±»å‹è‡ªå®šä¹‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //é»˜è®¤åŒ¹é…æ–¹å¼ and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //é»˜è®¤å¯å¼€å¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //é»˜è®¤è®°å½•æ—¥å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) //é»˜è®¤ç»§ç»­åç»­é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) //é»˜è®¤é¡ºåº1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤é€‰æ‹©å™¨æ¡ä»¶å±æ€§</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // é»˜è®¤å‚æ•°ç±»å‹URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // é»˜è®¤åŒ¹é…ç­–ç•¥ match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // é»˜è®¤å€¼ /contextPath/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ³¨å†Œé»˜è®¤é€‰æ‹©å™¨</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é€‰æ‹©å™¨æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘æ•°æ®åº“æ’å…¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // å‘æ•°æ®åº“æ’å…¥é€‰æ‹©å™¨æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());            selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‘å¸ƒåŒæ­¥äº‹ä»¶ï¼Œå‘ç½‘å…³åŒæ­¥é€‰æ‹©ä¿¡æ¯åŠå…¶æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1312-æ³¨å†Œè§„åˆ™"></a>1.3.1.2 æ³¨å†Œè§„åˆ™<a class="hash-link" href="#1312-æ³¨å†Œè§„åˆ™" title="Direct link to heading">#</a></h6><p>åœ¨æ³¨å†ŒæœåŠ¡çš„ç¬¬äºŒæ­¥ä¸­ï¼Œå¼€å§‹æ„å»ºé»˜è®¤è§„åˆ™ï¼Œç„¶åæ³¨å†Œè§„åˆ™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Dubbo</code>æ’ä»¶é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * dubboæœåŠ¡ç‰ˆæœ¬ä¿¡æ¯.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String version;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ†ç»„.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String group;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * é‡è¯•æ¬¡æ•°.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer retries = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šé»˜è®¤éšæœº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadbalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¶…æ—¶ï¼Œé»˜è®¤3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId) //å…³è”çš„é€‰æ‹©å™¨id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) // é»˜è®¤åŒ¹é…æ¨¡å¼ and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) // é»˜è®¤å¼€å¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) //é»˜è®¤è®°å½•æ—¥å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1) //é»˜è®¤é¡ºåº 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) // é»˜è®¤å‚æ•°ç±»å‹URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) //å‚æ•°å€¼path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //å¦‚æœpathä¸­æœ‰*ï¼Œæ“ä½œç±»å‹åˆ™é»˜è®¤ä¸º match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // å¦åˆ™ï¼Œé»˜è®¤æ“ä½œç±»å‹ = </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>æ³¨å†Œè§„åˆ™ï¼šå‘æ•°æ®åº“æ’å…¥è®°å½•ï¼Œå¹¶å‘ç½‘å…³å‘å¸ƒäº‹ä»¶ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘æ•°æ®åº“æ’å…¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å‘æ•°æ®åº“æ’å…¥è§„åˆ™ä½“æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘ç½‘å…³å‘å¸ƒäº‹ä»¶ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1313-æ³¨å†Œå…ƒæ•°æ®"></a>1.3.1.3 æ³¨å†Œå…ƒæ•°æ®<a class="hash-link" href="#1313-æ³¨å†Œå…ƒæ•°æ®" title="Direct link to heading">#</a></h6><p>å…ƒæ•°æ®ä¸»è¦ç”¨äº<code>RPC</code>æœåŠ¡çš„è°ƒç”¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDubboServiceImpl#registerMetadata()</p><p>æ’å…¥æˆ–æ›´æ–°å…ƒæ•°æ®ï¼Œç„¶åå‘å¸ƒåŒæ­¥äº‹ä»¶åˆ°ç½‘å…³ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–metaDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å…ƒæ•°æ®æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥æˆ–æ›´æ–°å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ•°æ®ç±»å‹è½¬æ¢ DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒåŒæ­¥äº‹ä»¶åˆ°ç½‘å…³</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="132-æ³¨å†Œuri"></a>1.3.2 æ³¨å†ŒURI<a class="hash-link" href="#132-æ³¨å†Œuri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯æ³¨å†Œçš„<code>URI</code>ä¿¡æ¯åï¼Œè¿›è¡Œå¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†Œå¤±è´¥åï¼Œè¿›è¡Œé‡è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>ä»å®¢æˆ·ç«¯æ³¨å†Œçš„<code>URI</code>ä¸­è·å–æœ‰æ•ˆçš„<code>URI</code>ï¼Œæ›´æ–°å¯¹åº”çš„é€‰æ‹©å™¨<code>handle</code>å±æ€§ï¼Œå‘ç½‘å…³å‘é€é€‰æ‹©å™¨æ›´æ–°äº‹ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å‚æ•°æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æœ‰æ•ˆçš„URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé€‰æ‹©å™¨çš„handleå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘æ•°æ®åº“æ›´æ–°é€‰æ‹©å™¨çš„handleå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘ç½‘å…³å‘é€é€‰æ‹©å™¨æ›´æ–°äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…³äºæœåŠ¡æ³¨å†Œçš„æºç åˆ†æå°±ä»¥åŠå®Œæˆäº†ï¼Œåˆ†ææµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/dubbo-register-zh-3a94f676f21cccb70d92c1e9e1eaad29.png"></p><p>æ¥ä¸‹æ¥å°±åˆ†æ<code>dubbo</code>æ’ä»¶æ˜¯å¦‚ä½•æ ¹æ®è¿™äº›ä¿¡æ¯å‘<code>http</code>æœåŠ¡å‘èµ·è°ƒç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-æœåŠ¡è°ƒç”¨"></a>2. æœåŠ¡è°ƒç”¨<a class="hash-link" href="#2-æœåŠ¡è°ƒç”¨" title="Direct link to heading">#</a></h3><p><code>dubbo</code>æ’ä»¶æ˜¯<code>ShenYu</code>ç½‘å…³ç”¨äºå°†<code>http</code>è¯·æ±‚è½¬æˆ <code>dubboåè®®</code>ï¼Œè°ƒç”¨<code>dubbo</code>æœåŠ¡çš„æ ¸å¿ƒå¤„ç†æ’ä»¶ã€‚</p><p>ä»¥å®˜ç½‘æä¾›çš„æ¡ˆä¾‹ <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo/" target="_blank" rel="noopener noreferrer">Dubboå¿«é€Ÿå¼€å§‹</a> ä¸ºä¾‹ï¼Œä¸€ä¸ª<code>dubbo</code>æœåŠ¡é€šè¿‡æ³¨å†Œä¸­å¿ƒå‘<code>shenyu-admin</code>æ³¨å†Œåï¼Œé€šè¿‡<code>ShenYu</code>ç½‘å…³ä»£ç†ï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/dubbo/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Dubbo</code>æ’ä»¶ä¸­ï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/ApacheDubboPlugin-286a36694f3fa121e7d3c7d67d08b833.png"></p><ul><li>ShenyuPluginï¼šé¡¶å±‚æ¥å£ï¼Œå®šä¹‰æ¥å£æ–¹æ³•ï¼›</li><li>AbstractShenyuPluginï¼šæŠ½è±¡ç±»ï¼Œå®ç°æ’ä»¶å…±æœ‰é€»è¾‘ï¼›</li><li>AbstractDubboPluginï¼šdubboæ’ä»¶æŠ½è±¡ç±»ï¼Œå®ç°<code>dubbo</code>å…±æœ‰é€»è¾‘ï¼›</li><li>ApacheDubboPluginï¼šApacheDubboæ’ä»¶ã€‚</li></ul><blockquote><p>ShenYuç½‘å…³æ”¯æŒApacheDubboå’ŒAlibabaDubbo</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶è¯·æ±‚"></a>2.1 æ¥æ”¶è¯·æ±‚<a class="hash-link" href="#21-æ¥æ”¶è¯·æ±‚" title="Direct link to heading">#</a></h4><p>é€šè¿‡<code>ShenYu</code>ç½‘å…³ä»£ç†åï¼Œè¯·æ±‚å…¥å£æ˜¯<code>ShenyuWebHandler</code>ï¼Œå®ƒå®ç°äº†<code>org.springframework.web.server.WebHandler</code>æ¥å£ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¤„ç†webè¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // æ‰§è¡Œé»˜è®¤æ’ä»¶é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * å®ä¾‹åŒ–é»˜è®¤æ’ä»¶é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * æ‰§è¡Œæ¯ä¸ªæ’ä»¶.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // è·å–å½“å‰æ‰§è¡Œæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ˜¯å¦è·³è¿‡å½“å‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœè·³è¿‡å°±æ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ‰§è¡Œå½“å‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-åŒ¹é…è§„åˆ™"></a>2.2 åŒ¹é…è§„åˆ™<a class="hash-link" href="#22-åŒ¹é…è§„åˆ™" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>åœ¨<code>execute()</code>æ–¹æ³•ä¸­æ‰§è¡Œé€‰æ‹©å™¨å’Œè§„åˆ™çš„åŒ¹é…é€»è¾‘ã€‚</p><ul><li>åŒ¹é…é€‰æ‹©å™¨ï¼›</li><li>åŒ¹é…è§„åˆ™ï¼›</li><li>æ‰§è¡Œæ’ä»¶ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŒ¹é…é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŒ¹é…è§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ‰§è¡Œæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-æ‰§è¡Œglobalplugin"></a>2.3 æ‰§è¡ŒGlobalPlugin<a class="hash-link" href="#23-æ‰§è¡Œglobalplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.global.GlobalPlugin#execute()</li></ul><p><code>GlobalPlugin</code>æ˜¯ä¸€ä¸ªå…¨å±€æ’ä»¶ï¼Œåœ¨<code>execute()</code>æ–¹æ³•ä¸­æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ShenyuContextBuilder builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¼ å…¥åˆ° exchange ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = builder.build(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.CONTEXT, shenyuContext);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.global.DefaultShenyuContextBuilder#build()</li></ul><p>æ„å»ºé»˜è®¤çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DefaultShenyuContextBuilder implements ShenyuContextBuilder {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext build(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºå‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String, MetaData&gt; buildData = buildData(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åŒ…è£…ShenyuContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return decoratorMap.get(buildData.getLeft()).decorator(buildDefaultContext(exchange.getRequest()), buildData.getRight());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Pair&lt;String, MetaData&gt; buildData(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ ¹æ®è¯·æ±‚çš„uriè·å–å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = MetaDataCache.getInstance().obtain(request.getURI().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; Boolean.TRUE.equals(metaData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.META_DATA, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(metaData.getRpcType(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(RpcTypeEnum.HTTP.getName(), new MetaData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è®¾ç½®é»˜è®¤çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuContext buildDefaultContext(final ServerHttpRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appKey = request.getHeaders().getFirst(Constants.APP_KEY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sign = request.getHeaders().getFirst(Constants.SIGN);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = new ShenyuContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = request.getURI().getPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setPath(path); //è¯·æ±‚è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setAppKey(appKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setSign(sign);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setTimestamp(timestamp);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setStartDateTime(LocalDateTime.now());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -&gt; shenyuContext.setHttpMethod(httpMethod.name()));//è¯·æ±‚æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.dubbo.common.context.DubboShenyuContextDecorator#decorator()</li></ul><p>åŒ…è£…<code>ShenyuContext</code>ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboShenyuContextDecorator implements ShenyuContextDecorator {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext decorator(final ShenyuContext shenyuContext, final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setModule(metaData.getAppName());//è·å–AppName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setMethod(metaData.getServiceName()); //è·å–ServiceName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setContextPath(metaData.getContextPath()); //è·å–contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setRpcType(RpcTypeEnum.DUBBO.getName()); // dubboæœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String rpcType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RpcTypeEnum.DUBBO.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-æ‰§è¡Œrpcparamtransformplugin"></a>2.4 æ‰§è¡ŒRpcParamTransformPlugin<a class="hash-link" href="#24-æ‰§è¡Œrpcparamtransformplugin" title="Direct link to heading">#</a></h4><p><code>RpcParamTransformPlugin</code>è´Ÿè´£ä»<code>http</code>è¯·æ±‚ä¸­è¯»å–å‚æ•°ï¼Œä¿å­˜åˆ°<code>exchange</code>ä¸­ï¼Œä¼ é€’ç»™<code>rpc</code>æœåŠ¡ã€‚</p><ul><li>org.apache.shenyu.plugin.base.RpcParamTransformPlugin#execute()</li></ul><p>åœ¨<code>execute()</code>æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œè¯¥æ’ä»¶çš„æ ¸å¿ƒé€»è¾‘ï¼šä»<code>exchange</code>ä¸­è·å–è¯·æ±‚ä¿¡æ¯ï¼Œæ ¹æ®è¯·æ±‚ä¼ å…¥çš„å†…å®¹å½¢å¼å¤„ç†å‚æ•°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class RpcParamTransformPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä»exchangeä¸­è·å–è¯·æ±‚ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerHttpRequest request = exchange.getRequest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuContext)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MediaType mediaType = request.getHeaders().getContentType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return body(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return formData(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ä¸€èˆ¬æŸ¥è¯¢è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return query(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; body(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(body -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, resolveBodyFromRequest(body));//è§£æbodyï¼Œä¿å­˜åˆ°exchangeä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; formData(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(map -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String param = resolveBodyFromRequest(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LinkedMultiValueMap&lt;String, String&gt; linkedMultiValueMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        linkedMultiValueMap = BodyParamUtils.buildBodyParams(URLDecoder.decode(param, StandardCharsets.UTF_8.name())); //æ ¼å¼åŒ–æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (UnsupportedEncodingException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return Mono.error(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.toMap(() -&gt; linkedMultiValueMap));// ä¿å­˜åˆ°exchangeä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ä¸€èˆ¬æŸ¥è¯¢è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; query(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.ofString(() -&gt; serverHttpRequest.getURI().getQuery()));//ä¿å­˜åˆ°exchangeä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-æ‰§è¡Œdubboplugin"></a>2.5 æ‰§è¡ŒDubboPlugin<a class="hash-link" href="#25-æ‰§è¡Œdubboplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.dubbo.common.AbstractDubboPlugin#doExecute()</li></ul><p>åœ¨<code>doExecute()</code>æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯æ£€æŸ¥å…ƒæ•°æ®å’Œå‚æ•°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–å‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String param = exchange.getAttribute(Constants.PARAM_TRANSFORM);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = exchange.getAttribute(Constants.META_DATA);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ£€æŸ¥å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!checkMetaData(metaData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot; path is : {}, meta data have error : {}&quot;, shenyuContext.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.META_DATA_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ£€æŸ¥å…ƒæ•°æ®å’Œå‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; StringUtils.isNoneBlank(metaData.getParameterTypes()) &amp;&amp; StringUtils.isBlank(param)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.DUBBO_HAVE_BODY_PARAM, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¾ç½®rpcContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.rpcContext(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¿›è¡ŒdubboæœåŠ¡è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.doDubboInvoker(exchange, chain, selector, rule, metaData, param);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.ApacheDubboPlugin#doDubboInvoker()</li></ul><p>åœ¨<code>doDubboInvoker()</code>æ–¹æ³•ä¸­è®¾ç½®ç‰¹æ®Šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç„¶åå¼€å§‹dubboçš„æ³›åŒ–è°ƒç”¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPlugin extends AbstractDubboPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doDubboInvoker(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final RuleData rule,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final MetaData metaData,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final String param) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¾ç½®å½“å‰çš„é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯ï¼Œä»¥åŠè¯·æ±‚åœ°å€ï¼Œç”¨äºæ”¯æŒdubboçš„ç°åº¦</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_RULE_ID, rule.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_REMOTE_ADDRESS, Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //dubboçš„æ³›åŒ–è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;Object&gt; result = dubboProxyService.genericInvoker(param, metaData, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‰§è¡Œä¸‹ä¸€ä¸ªæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.then(chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.proxy.ApacheDubboProxyService#genericInvoker()</li></ul><p><code>genericInvoker()</code>æ–¹æ³•ï¼š</p><ul><li>è·å–<code>ReferenceConfig</code>å¯¹è±¡ï¼›</li><li>è·å–æ³›åŒ–æœåŠ¡<code>GenericService</code>å¯¹è±¡ï¼›</li><li>æ„é€ è¯·æ±‚å‚æ•°<code>pair</code>å¯¹è±¡ï¼›</li><li>å‘èµ·å¼‚æ­¥çš„æ³›åŒ–è°ƒç”¨ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboProxyService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Generic invoker object.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Object&gt; genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.è·å–ReferenceConfigå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReferenceConfig&lt;GenericService&gt; reference = ApacheDubboConfigCache.getInstance().get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœæ²¡æœ‰è·å–åˆ°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¤±æ•ˆå½“å‰ç¼“å­˜çš„ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ä½¿ç”¨å…ƒæ•°æ®è¿›è¡Œå†æ¬¡åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference = ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.è·å–æ³›åŒ–æœåŠ¡GenericServiceå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        GenericService genericService = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.æ„é€ è¯·æ±‚å‚æ•°pairå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String[], Object[]&gt; pair;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(metaData.getParameterTypes()) || ParamCheckUtils.dubboBodyIsEmpty(body)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = new ImmutablePair&lt;&gt;(new String[]{}, new Object[]{});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4.å‘èµ·å¼‚æ­¥çš„æ³›åŒ–è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.fromFuture(invokeAsync(genericService, metaData.getMethodName(), pair.getLeft(), pair.getRight()).thenApply(ret -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¤„ç†ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(ret)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = Constants.DUBBO_RPC_RESULT_EMPTY;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.RPC_RESULT, ret);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ret;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        })).onErrorMap(exception -&gt; exception instanceof GenericException ? new ShenyuException(((GenericException) exception).getExceptionMessage()) : new ShenyuException(exception));//å¤„ç†å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ³›åŒ–è°ƒç”¨ï¼Œå¼‚æ­¥æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private CompletableFuture&lt;Object&gt; invokeAsync(final GenericService genericService, final String method, final String[] parameterTypes, final Object[] args) throws GenericException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        genericService.$invoke(method, parameterTypes, args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object resultFromFuture = RpcContext.getContext().getFuture();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFromFuture instanceof CompletableFuture ? (CompletableFuture&lt;Object&gt;) resultFromFuture : CompletableFuture.completedFuture(resultFromFuture);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡æ³›åŒ–è°ƒç”¨å°±å¯ä»¥å®ç°åœ¨ç½‘å…³è°ƒç”¨<code>dubbo</code>æœåŠ¡äº†ã€‚</p><p><code>ReferenceConfig</code>å¯¹è±¡æ˜¯æ”¯æŒæ³›åŒ–è°ƒç”¨çš„å…³é”®å¯¹è±¡ ï¼Œå®ƒçš„åˆå§‹åŒ–æ“ä½œæ˜¯åœ¨æ•°æ®åŒæ­¥çš„æ—¶å€™å®Œæˆçš„ã€‚è¿™é‡Œæ¶‰åŠä¸¤éƒ¨åˆ†æ•°æ®ï¼Œä¸€æ˜¯åŒæ­¥çš„æ’ä»¶<code>handler</code>ä¿¡æ¯ï¼ŒäºŒæ˜¯åŒæ­¥çš„æ’ä»¶å…ƒæ•°æ®ä¿¡æ¯ã€‚</p><ul><li>org.apache.shenyu.plugin.dubbo.common.handler.AbstractDubboPluginDataHandler#handlerPlugin()</li></ul><p>å½“æ’ä»¶æ•°æ®æ›´æ–°æ—¶ï¼Œæ•°æ®åŒæ­¥æ¨¡å—ä¼šå°†æ•°æ®ä»<code>shenyu-admin</code>åŒæ­¥åˆ°ç½‘å…³ã€‚åœ¨<code>handlerPlugin()</code>ä¸­æ‰§è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åˆå§‹åŒ–é…ç½®ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   protected abstract void initConfigCache(DubboRegisterConfig dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerPlugin(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(pluginData) &amp;&amp; Boolean.TRUE.equals(pluginData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ•°æ®ååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig dubboRegisterConfig = GsonUtils.getInstance().fromJson(pluginData.getConfig(), DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig exist = Singleton.INST.get(DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || !dubboRegisterConfig.equals(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.initConfigCache(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Singleton.INST.single(DubboRegisterConfig.class, dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.handler.ApacheDubboPluginDataHandler#initConfigCache()</li></ul><p>æ‰§è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPluginDataHandler extends AbstractDubboPluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void initConfigCache(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().init(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¤±æ•ˆä¹‹å‰ç¼“å­˜çš„ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().invalidateAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#init()</li></ul><p>åœ¨åˆå§‹åŒ–ä¸­ï¼Œè®¾ç½®<code>registryConfig</code>å’Œ<code>consumerConfig</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åˆ›å»ºApplicationConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(applicationConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            applicationConfig = new ApplicationConfig(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åè®®æˆ–è€…åœ°å€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œéœ€è¦æ›´æ–°registryConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (needUpdateRegistryConfig(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RegistryConfig registryConfigTemp = new RegistryConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setProtocol(dubboRegisterConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setId(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setRegister(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setAddress(dubboRegisterConfig.getRegister());            Optional.ofNullable(dubboRegisterConfig.getGroup()).ifPresent(registryConfigTemp::setGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfig = registryConfigTemp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åˆ›å»ºConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(consumerConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            consumerConfig = ApplicationModel.getConfigManager().getDefaultConsumer().orElseGet(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConsumerConfig consumerConfig = new ConsumerConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                consumerConfig.refresh();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return consumerConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> //è®¾ç½®ConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getThreadpool()).ifPresent(consumerConfig::setThreadpool); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getCorethreads()).ifPresent(consumerConfig::setCorethreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Optional.ofNullable(dubboRegisterConfig.getThreads()).ifPresent(consumerConfig::setThreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Optional.ofNullable(dubboRegisterConfig.getQueues()).ifPresent(consumerConfig::setQueues);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ˜¯å¦éœ€è¦æ›´æ–°æ³¨å†Œé…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean needUpdateRegistryConfig(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getRegister(), registryConfig.getAddress())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.subscriber.ApacheDubboMetaDataSubscriber#onSubscribe()</li></ul><p>å½“å…ƒæ•°æ®æ›´æ–°æ—¶ï¼Œæ•°æ®åŒæ­¥æ¨¡å—ä¼šå°†æ•°æ®ä»<code>shenyu-admin</code>åŒæ­¥åˆ°ç½‘å…³ã€‚åœ¨<code>onSubscribe()</code>æ–¹æ³•ä¸­æ‰§è¡Œå…ƒæ•°æ®æ›´æ–°æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboMetaDataSubscriber implements MetaDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æœ¬åœ°å†…å­˜ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, MetaData&gt; META_DATA = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å…ƒæ•°æ®å‘ç”Ÿæ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // dubboæœåŠ¡çš„å…ƒæ•°æ®æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¯¹åº”çš„å…ƒæ•°æ®æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaData exist = META_DATA.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || Objects.isNull(ApacheDubboConfigCache.getInstance().get(metaData.getPath()))) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // é¦–æ¬¡åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å¯¹åº”çš„å…ƒæ•°æ®å‘ç”Ÿäº†æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!Objects.equals(metaData.getServiceName(), exist.getServiceName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getRpcExt(), exist.getRpcExt())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getParameterTypes(), exist.getParameterTypes())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getMethodName(), exist.getMethodName())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //æ ¹æ®æœ€æ–°çš„å…ƒæ•°æ®å†æ¬¡æ„å»ºReferenceConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApacheDubboConfigCache.getInstance().build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æœ¬åœ°å†…å­˜ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.put(metaData.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åˆ é™¤å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void unSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ä½¿ReferenceConfigå¤±æ•ˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.remove(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#initRef()</li></ul><p>é€šè¿‡<code>metaData</code>æ„å»º<code>ReferenceConfig</code>å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ReferenceConfig&lt;GenericService&gt; initRef(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œå­˜åœ¨å°±ç›´æ¥è¿”å›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ReferenceConfig&lt;GenericService&gt; referenceConfig = cache.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(referenceConfig.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return referenceConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init dubbo ref exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           //ä¸å­˜åœ¨ï¼Œå°±æ„å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Build reference config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @SuppressWarnings(&quot;deprecation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ReferenceConfig&lt;GenericService&gt; build(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(applicationConfig) || Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ReferenceConfig&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ReferenceConfig&lt;GenericService&gt; reference = new ReferenceConfig&lt;&gt;(); //æ–°å»ºReferenceConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setGeneric(&quot;true&quot;); //æ³›åŒ–è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setAsync(true);//æ”¯æŒå¼‚æ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setApplication(applicationConfig);//è®¾ç½®åº”ç”¨é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setRegistry(registryConfig);//è®¾ç½®æ³¨å†Œä¸­å¿ƒé…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setConsumer(consumerConfig);//è®¾ç½®æ¶ˆè´¹è€…é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setInterface(metaData.getServiceName());//è®¾ç½®æœåŠ¡æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setProtocol(&quot;dubbo&quot;);//è®¾ç½®dubboåè®®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setCheck(false); //ä¸æ£€æŸ¥ service provider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setLoadbalance(&quot;gray&quot;);//æ”¯æŒç°åº¦</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            parameters.put(&quot;dispatcher&quot;, &quot;direct&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setParameters(parameters);//è‡ªå®šä¹‰å‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String rpcExt = metaData.getRpcExt();//rpcæ‰©å±•å‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboParam dubboParam = parserToDubboParam(rpcExt);//ååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(dubboParam)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getVersion())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setVersion(dubboParam.getVersion());//è®¾ç½®ç‰ˆæœ¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getGroup())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setGroup(dubboParam.getGroup());//è®¾ç½®åˆ†ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getUrl())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setUrl(dubboParam.getUrl());//è®¾ç½®url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getCluster())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setCluster(dubboParam.getCluster());//è®¾ç½®Cluster type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getTimeout()).ifPresent(reference::setTimeout);//timeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getRetries()).ifPresent(reference::setRetries);//retires</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getSent()).ifPresent(reference::setSent);//Whether to ack async-sent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //è·å–GenericService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object obj = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(obj)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;init apache dubbo reference success there meteData is :{}&quot;, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //ç¼“å­˜å½“å‰çš„reference</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    cache.put(metaData.getPath(), reference);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init apache dubbo reference exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return reference;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="26-æ‰§è¡Œresponseplugin"></a>2.6 æ‰§è¡ŒResponsePlugin<a class="hash-link" href="#26-æ‰§è¡Œresponseplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>å“åº”ç»“æœç”±<code>ResponsePlugin</code>æ’ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®rpcç±»å‹å¤„ç†ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¤„ç†ç±»å‹ç”±<code>MessageWriter</code>å†³å®šï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriterï¼šæ¥å£ï¼Œå®šä¹‰æ¶ˆæ¯å¤„ç†æ–¹æ³•ï¼›</li><li>NettyClientMessageWriterï¼šå¤„ç†<code>Netty</code>è°ƒç”¨ç»“æœï¼›</li><li>RPCMessageWriterï¼šå¤„ç†<code>RPC</code>è°ƒç”¨ç»“æœï¼›</li><li>WebClientMessageWriterï¼šå¤„ç†<code>WebClient</code>è°ƒç”¨ç»“æœï¼›</li></ul><p><code>Dubbo</code>æœåŠ¡è°ƒç”¨ï¼Œå¤„ç†ç»“æœå½“ç„¶æ˜¯<code>RPCMessageWriter</code>äº†ã€‚</p><ul><li>org.apache.shenyu.plugin.response.strategy.RPCMessageWriter#writeWith()</li></ul><p>åœ¨<code>writeWith()</code>æ–¹æ³•ä¸­å¤„ç†å“åº”ç»“æœã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RPCMessageWriter implements MessageWriter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object result = exchange.getAttribute(Constants.RPC_RESULT); //è·å–ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(result)) { //å¤„ç†å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, result);//è¿”å›ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ†æè‡³æ­¤ï¼Œå…³äº<code>Dubbo</code>æ’ä»¶çš„æºç åˆ†æå°±å®Œæˆäº†ï¼Œåˆ†ææµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/dubbo-execute-zh-cd073b32b44fa14c94a575450d8b320d.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-å°ç»“"></a>3. å°ç»“<a class="hash-link" href="#3-å°ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡æºç åˆ†æä»<code>Dubbo</code>æœåŠ¡æ³¨å†Œå¼€å§‹ï¼Œåˆ°<code>Dubbo</code>æ’ä»¶çš„æœåŠ¡è°ƒç”¨ã€‚<code>Dubbo</code>æ’ä»¶ä¸»è¦ç”¨æ¥å¤„ç†å°†<code>http</code>è¯·æ±‚è½¬æˆ<code>dubbo</code>åè®®,ä¸»è¦é€»è¾‘æ˜¯é€šè¿‡æ³›åŒ–è°ƒç”¨å®ç°ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/dubbo">dubbo</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge-- åŸºäºSPIçš„è®¾è®¡å®ç°åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-06-01T03:06:51.476Z">2023å¹´6æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>çµæ´»çš„æ’ä»¶å’Œè§„åˆ™å®šä¹‰ï¼Œæ˜¯<a href="http://shenyu.apache.org/" target="_blank" rel="noopener noreferrer">Shenyuç½‘å…³</a>çš„ä¸€å¤§ç‰¹è‰²ã€‚å®ƒä»¥æ’ä»¶å½¢å¼æ”¯æŒå¤šç§ç½‘ç»œåè®®å’Œå¤šç§æµè¡Œçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå¦‚Dubbo, gRPCå’Œ Spring-Cloud ç­‰ã€‚ ä¸ºäº†å®ç°å¯¹å„ç§åè®®åŠæ’ä»¶çš„é…ç½®è§„åˆ™çš„è§£æï¼Œç½‘å…³åœ¨è§„åˆ™ç­–ç•¥è§£ææ–¹é¢ï¼Œé‡‡ç”¨äº†ä¼˜é›…çš„<code>SPI</code>(Service Provider Interface)å®ç°ï¼Œå½“æ·»åŠ æ–°çš„æ’ä»¶æ—¶ï¼Œè§„åˆ™è§£æéƒ¨åˆ†å¯ä»¥æ²¿ç”¨ç°æœ‰å®ç°æˆ–é‡‡ç”¨<code>SPI</code>æœºåˆ¶å¿«é€Ÿå®ç°ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi-çš„é¡¶å±‚è®¾è®¡"></a><code>SPI</code> çš„é¡¶å±‚è®¾è®¡<a class="hash-link" href="#spi-çš„é¡¶å±‚è®¾è®¡" title="Direct link to heading">#</a></h2><p>Shenyuçš„<code>SPI</code>é‡‡ç”¨æ¥å£+ å·¥å‚æ¨¡å¼+é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œæ¥å®ç°æ¨¡ç»„çš„åŠ¨æ€åŠ è½½ã€‚åœ¨å…¶<strong><em>shen-<code>SPI</code></em></strong>-æ¨¡ç»„ï¼Œåšäº†<code>SPI</code>çš„é¡¶å±‚è®¾è®¡ã€‚å®šä¹‰äº†@ Join ï¼Œ@<code>SPI</code> ä¸¤ä¸ªannotationã€‚ å…¶ä¸­@Join  ä»£è¡¨æ­¤ç±»ä¼šåŠ å…¥æ‰©å±•æœºåˆ¶ï¼Œç›¸å½“äºæ˜¯åšç”³è¯·æ³¨å†Œã€‚ @<code>SPI</code> æ ‡æ˜å½“å‰ç±»ä¸º<code>SPI</code>åŠŸèƒ½æ‰©å±•ç±»ã€‚</p><p>Fig 1 classes in the <strong><em>shenyu-spi</em></strong></p><p><img alt="toplevel-SPI" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASkAAACeCAYAAABuIfz7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAABX0SURBVHhe7Z39kxXVmcf5l1L70/y2STbRaLTKJEQoeTFBBtYkG8iS2ggoiChCcBCFlEQriElF0RWoiplaYGCDMRiRXQEtglNmABdKN1izI+iaicBJP6fP6T4vz+nue29f7pnu78c65b3d5637nudzTx/udM8SAAAQMZAUACBqICkAQNRAUgCAqBmYpM5f/FCcfu+slcbPvi8uf/KpygEAAAOU1KvHTog9+3/npX0HjkhZge4ZHZ4lZg2Pqnc3hkG0GRvyHAyNiHH1HtQDK6kXXnhB7N69W0xMTKgtNpOTk2LPnj0yH6VuCElKpzN/Pqdygk6BpAbBuBgZgqT6ASspElRIVK6g+iWpKonqAD6QFGgSrKRITJyoXEG98cYbMnUDJNU/ICnQJIJrUq6oTp065Qnq+vXrMnVD3yU1PiKGZiWBYyQ3hmRgJdPz0ZGhNI85VR8dtsoOjYym0/nCQFRT/qzcsDBz6/bG3b55dRbXkzIqhs06jL5rYYzr4wrV4faj9FLFbtPsdj1tquMuqCc7h+q9Rm9/V/VxaMTOESqXU3JsVLbkcytvA3RD4cK5KSozaUH1giup3xx+TZy78IH4+Mon8v+vHP6DtZ9LQUkpwVhjSA0wc/DKQcUMNh0g3kBl8pqMjwyLvHp/jSKrwxzIeuAb9ZbVo4/PCsSknsSjEt1Ovl8FoFfHUHE7Fn7wj474x9Zbm+o9V48+P14dRJonzeL3k5D96/HYrPLM51bcBuiWQkkRrqjqEBThSuri/15Se1IufvgXaz+XeEnxg5RI5eN8K3vf9qHyKoAKJOUhA6qsPb9fHlY95f3ggsVuI63Dq0IGnisAhQrKULP1tKmOrUI91udjnZ8uJFXl2LL6c9jxBEnVTqmkCC2qugRFuJL6/OpVtSfl88+vWvu5xEqqaMA538LsoAqWL5cDkQ5oM1UYxMzsIFhPSUARsqyTwQooVYddf574utXxUx7mGOppkz/Hrgzk+6wPrrS6mUlVOLYKn1txG6BbKkmqH7iSmpz6WO1Joffmfi7FJak0OMxgStvL31cb7CX11CipojqCmLIxjqWeNqtJKq1LnS/ztaQbSSmKjq30c6vYBuiYaCQ19oc3xZVP/1/uo//Te3M/l1hJBQYp4Q52flCFyit5hKLMGbAE254ZbAqrH6X1hI9PI+srDPTyOkqR/cylU0+bFSWl8lFdcp/1GfJ18J91AO7Yyj435j2oh2gkpRMtoHPbucRLSg9q51vbGXhEaFClg9IWRbotSVkFjrTc+rNv5Xxw+3UkuOUq1BM6Pv1etmPt1GVK6qC2sg3O8SX7hu0TkpR3ZhE9t1lVUgnU/lByzEl+J3vaFzO/Oqf5Z93FsZn5CVWnvclsA9RFdJLqJIUkJdEDM0u2dIiiQZUNTJWGR90A8gNKB6FMVK/sQx4sur3sJw9Z3SqDoqweiXt8RiWyHadSLtCtdihZ58I/PvucMBLvQ5sEV0/SYioabzuh6tFtJPXpc5+21cWxVfjc7DZAXTRXUrXDB1AnYBDXSe+fR1XwuQ2WgUlq6vIn4tLk//WUqI4bhrrs6iUmMNhrRH4e/uy4H+BzGywDk1TM0OWFvcCrLi16HKgY7PUhz+UNmEUR+NwGCyQVQA5MY/2hjoDAYO+dbE3rBp5HfG6DBZICAEQNJAUAiBpICgAQNZAUACBqICkAQNRAUgCAqIGkAABRA0kBAKKmdZL627VpcXbqjDh64aA4dH6fTPSattE+AEBctEZS15P/3rn0pnj+9Hax6+0RNtE+ykN5AQBx0ApJTV/9q9g/8RIrJi5RXirTVCbunyWemjsiJtV7AGKm8ZKiWVEngtKJyhTNqCZ3Dokd/zDLS2NHVIZoGRfH5/ZPUjP3vIBYabyk6PKNk1CVRGVDUDD2FuijYuwLzQteeV6+MCz4B/TXQTPPGwjTaEnRQnhoDWrJ2rvEwhXflIlec3mobGgxHZLigaRA3TRaUmen3mXlQ2nL/gfEvGV3yESvuTyUqA6OIknRPv8SJw2up+4fzfab6aWdxo1Azo6Il5K8ep/djrpcc+rxxZC2p/ebfWHXpJw23TJV25XnpVBSaT2h8il233VfOz1vlFyZ6WOfUHXR65OBNTqs3cVBoyX1+sUxVjw63bt+gUzcPp2oDg4ZjAUD2B7geYDnBGYER4aTwB0Sx8+q994aUh7keYDmAjTfmwE8sTPvqxd8SZteQKuAz+uo0m65pCZ3DhccW4Lqiyuf41nfwuet/BjSY6d81mfhnXMi0A644TRaUofO7WPFo1MVSVEdHNy3uh2cuSj4wOWCIA1aLzBksOkgYgI7wWpDBWcowGxJ5f10sftdoV31vvi8OEhBOG1YMnfhzlvVY1DH7vUnbdcqb/ULDBJIqgdJuQHroWThf0sTTLCp/G6Q65Tm5QOZEwqV4fpoSapIaNYMo0q7/nsOPZvRKctfIteU8HkrPwZX0Dn258lICwwMXO6VSKrbyz1Jl5IqDtJqspCo+lxZDU5S6TFb+80ZS6Xj74+k0jpUPvM1GDitXTh//MCabOGcXnN5KHWzcJ6SfxvzeZlgU9uKv8E7kJQmCVQSlW7LDtRwm3adNUjKEQZh569y/J2dN7c/QUmVfl5gUDRaUoP8CYIdDFyA84FF9ZpCkdA3e1a2giyS/GNmvSWzCbZNR2x1ScqqU82A3PJcX/L3HZw37xiKJJVA52lu0lZynFY9YKA0WlJEP3/MSQHgJgpiGQju5YIOSDPIVRBRMoPOrdsOqmqyoD5k5Z2+sIFq9IUrU4ukEsxjk30gMbj53b44bYbOW/kxlEhKCbCo/+DG03hJ9evPYkAT4UUMBkvjJUXgD4xBJbBgHiWtkBRBsyK6fAutUVGifZQHM6h2Ii8FMYuKjtZISkML4bjpHTDR62ThtSowSFonKQDAzAKSAgBEDSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKhpvKQuf/KpOHz0uNj18m/Fq8feUlsBADOFRkvqg798JJ7bMyp+/vw+mXa/clBMX7su/jQ1LQ5cuCL2nr8sE72mbbQPABAXjZUUzaBMQVHad/SE2HZ6Umx++yM20b5jlz7DH8UAEBGNlRRd4pmCembvfvHYiQ9ZObnpxYmPxWdXr6mamkfx7UpmMriLQRNprKR2vZzPop7Zs19s+a//EVv++OeORFU0ozLvi2Sm+G+WpgK5T5Iqu59Uf4GkmkhjJfXqsRNi9ytj8hKPxESC+vmLvxFPHvpvVkpcoku/EDIYewp07ja4Mx9ICtRNoxfOaSFcr0GRqEhQO/79P+Tr5b/eLxasf0LMXrFWfGfTDrHm8DuepKhsaDEdkuKBpEDdNFpSZ6amPfE89tYHYtFDj4ub5i8Wdz/6M7HkyV+KOSsfEbct/ZHYyFwKUh0cRZKiff6ln7o1bRJAer+ZrNvgqlsN6312O3kgmvX4Ykjb0/vNvrBrUk6bbpmq7crzUiap0raItL1QOxLvNsMjvKQKz2d+PsynGnf/5QPqptGSOnjxiiedZb8aFTcvXCLWH33P2r4pkZf5Xieqg0MGY8FgtkXAfcMHZlLynt/m3SFVWacuCqZcbLkAzfem+GJ5gnG1tqieak86Nuuh46Jt1nkuPZ+BciAaGi2pvecue9KZ/+AWOYNyt4cS1cFhziZ0soMzFwUfuJyk0gDyxCWDWAcaE7AJVhsq6L16FLakfKFp7H5XaJd5b1O1LQYpG70/VI/qYyabKudTnY+itsFAaaekNmz3todSkaTcgPVQsuCeWsJKSuV35adTmtcNxBROKFSG66MlqSKhWbOQKu2WyKZyWyl6hqNTVm+wHqePlc6nK20QG+283FswLNb9ftzavmbspPVep24v9yQqSDqVFBvEGdVkITGC1Oxr/JJKz41VjzmTCtbDS6r4fEJSsdO6hfPNpy6JOas2iJvm3SNoRjW8dZf4xvLV4ub5i8WGY+97+btZOE9JAya73PPyMpIKXsaYdCApTRLg4ZlDuE27zhokVbUtZlZl1xuqJ92e97HK+YSkYqfRkjJ/gmClRFQ0o5q3dkTMue9hsXjrs+Kh1+yZFaVefoJgD3wuwPkAonpNoUhoRpCVrSCLJH+UTzBOqNSW+17NiMx65TE4IqNtVM7sI9uedT4hqdhptKQI+kGmK5+qqezHnDT43UQBwgVQFmhmkKtgpGTKyq3bDqBqstABK8szwewFpdEXrkwnkjLryeoLHLfc57Vl1yP7mpRx5WceI6WxI+E+mvncY4ek4qbxkqJ5EP2JCyeholT2ZzEAgBtD4yVF0B8LdyKqpv+BMQAziVZIiqBZEV2+sWtUKtE+3KoFgLhojaQ0tBCOm94BMHNonaQAADMLSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCiBpICAERN6yT1t2vT4uzUGXH0wkFx6Pw+meg1baN9AIC4aI2krif/vXPpTfH86e1i19sjbKJ9lIfyAgDioBWSmr76V7F/4iVWTFyivFSmn+D2IABUo/GSollRJ4LSicqUz6j4+xeVo8pBUgCU0nhJ0eWbKZ9nT42INc8tEwtWfEvcftc/iVvnfEl8e+nXxfKRe8TTxx618lLZYrqVFACgKo2WFC2Em2tQO08+JhatvFPMufc28dDuFeIXb22W27f9bp249+GFYvbiW8VTr2/I8lPZ4sV0SAqAftNoSZ2dejcTDqVVz3xfzF5yq3jmzY3JrGmjWL3zX8SKbUvEfTvuFTuOPiLuWT1X/GDj3VYZqiNMQFLqVsHmLWute2wn2GtSeT3WbXML7hUOQFtotKRevzhmCeeuZXdIUe1441HxzUVfE8s2f1ds2PMTccudXxI/fWWlfE3bzTJURxhGUu5DBAglLfM+5pykqFyex33yCQDtpNGSOnRunyWc2+d/VWz+7Sqx5rkfijv/+Ta5jS4Bb/n2F8XI/gfE4wfWSGGZZaiOMK6kwo9Qch9YwM6knIV0twwAbaRdkpr3FSmjnySXdwtXfEtu2/bqevG12f8onvjPdWLd8//qzaQ6kpSaMbmXdhL5tJP8qSihyz0TSAqAll3uzf3e7eL+XT+UM6avz/2yvPRbtGqOuH3BV8XSdfPE7OFbxY+fXGKVqXK5l82cICkAaqdVC+ckoHnL75A/Q6AZ1Y+3LxWPvPxvciF9ZSIs+hc/2meWKV44Ty/vcin1eLkHSQHg0WhJuT9BePr4JrkWtfj+uWLr4QflNlqTeiJ5TQvnOp9OZT9B4CRC27yFc2YxHZICoBqNlhTh/pjz6WTWtOyxRfIHnLQWdcudX5SXgat/8QMrHyX+x5ypUNKfCPhP3pUoKenE5YOkAKhG4yXV3z+LAQD0m8ZLiojxD4wBANVohaQImhXR5Zu5RuUm2kd5MIMCIB5aIykNLYTjpncAzBxaJykAwMwCkgIARA0kBQCIGkgKABA1kBQAIGogKQBA1EBSAICogaQAAFEDSQEAoqZ1ksIvzgGYWbRGUvjbPQBmJq2QFO6CAMDMpfGSollRJ4LSicqUzqjcm9tlN7FL0XfpLMpj3/wOAODSeEnR5Zspn7oes87eNTORlnl/c5nHEpC6A6exDZICoJhGS4oWws01qPoesx5+4IKJL6kE54kykBQAxTRaUv17zHq1pwuzknKeMANJAVBMoyXVz8esk1zkGlOBqMIzqdDz9wAALo2WVL8fs04SyhbEGVn5kvJnYJAUAMW0S1K1P2Y9JZtVOY+uMiWmk7uOBUkBUEyrLvfqf8y6ifqXO+Nf/Pg1KRtICoBiWrVwXv9j1h2ODENSANRMoyXl/gShvses09qS+1Ri/ynEkBQAvdNoSRHujzl7f8y6Jl0EL1pvgqQA6J3GS6qvfxYDAOg7jZcUgT8wBmDm0gpJETQross3c43KTbSP8mAGBUA8tEZSGloIx03vAJg5tE5SAICZBSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCipnWSmr52XfxpalocuHBF7D1/WSZ6TdtoHwAgLlojKdLPsUufiW2nJ8Xmtz9iE+2jPFAVAPHQCkl9dvWaeHHiY1ZMXKK8VOZG0aTbteDWM6BuGi8pmhV1IiidqEzpjKrkCcbV8B8Yyt0bnZJ+DFa8+MdSJzP3vIBeaLyk6PKNk1CVRGVDyBvalTzBuFuq3CyvGPvZfk2BPee10szzNtNptKRoITy0BrX81/vFgvVPiNkr1orvbNoh1hx+x8tDZakOn3Qw1yEkDkiKB5JqJ42W1JmpaU88m09dEnc98FNx0/zF4u5HfyaWPPlLMWflI+K2pT8SG0986OWnOnzSwVz2BONsfUY9Wl1fnrjl3HWcIknRPv8SJ++P3m8mS6ZuX6x28vu0m/X4Ykjb0/vNvrBrUk6bbpmq7crzUiiptJ5Q+RS777qvnZ43Sq7M9LFPqLro9cnAGh3W7qrTaEkdvHjFk86yX42KmxcuEeuPvmdt3/TWB9Z7nagODhpkciAWiCrLYw5GNdjNcu6AlcFYMIDt/HmA5wRmBPJpNuYDJNw1pDzI8wB1hZy+NwN4YmfeVy/41Lqd1Rd1DvI6qrRbLqnJncMFx5ag+uLK53jWt/B5Kz8G4/M2PwvvnBOBdgBLoyW199xlTzrzH9wiZ1Du9lCiOkJY3/qWJFJkwDJB5QYbJyldb1a/VU8uCj5wuSBIg9YLDBlsOoiYwE6w2lDBGQow+1jyfrrY/a7QrnpffF4cpCCcNpjPKYc7b1WPIfR5p+1a5a1+gTLaKakN273toVQkKU32Dep8Y7ryyXC+XTlJseVMlCz8b2mCCTaV3w1yndK8fCBzQqEyXB+tYykSmnUOqrTrv+fQn4VOWf4SuaaEz1v5MYQ/b/vzZKQFCmnn5d6CYbHu9+PW9jVjJ633OoUu93xUoBlBFKOkioO0miwkqj5XVoOTVHrM1n7Zhnpf6fj7I6m0DpXPfA0q0cqF8zmrNoib5t0jaEY1vHWX+Mby1eLm+YvFhmPve/n5hfMAZlAkyEHLBJU7mDuXVP5tzOdlgk1tK/4G70BSmuSYSVS6LftYwm3addYgKUcYhJ2/yvF3dt7c/gQlVfp5gSIaLangTxASUdGMat7aETHnvofF4q3Piodes2dWlIp/guB+G/qBRoNWzjTM4HOCmuhUUnZ+LsD5wKJ63bblN3tWtoIskvxjZr0lswm2Te8c1CMpq041A3LLc33J33dw3ip8jhZ0nuYmbSXHadUDSmm0pIh+/ZhTD2gaqDq5g1sPWv1P0jq5gzQU2G6iIJZ5XUHqgDSDXAURJbNfbt12UFWTBfUhK+/0hQ1Uoy9cmVoklWAem+wDicHN7/bFaTN03sqPoURSarwU9R/wNF5Sff2zmBKKBy1oF7yIQTmNlxQxqD8whqRABhbMu6YVkiJoVkSXb6E/k6FE+yhPrzMoDSQFNHIsYBbVFa2RlIYWwm/UTe8gKaDXyTAOuqd1kgIAzCwgKQBA1EBSAICogaQAAFEDSQEAogaSAgBEjBB/B3o1C04w+m2JAAAAAElFTkSuQmCC"></p><p>é…ç½®æ–‡ä»¶æ–¹é¢ï¼Œå®šä¹‰<code>SPI</code>åŠ è½½çš„ç›®å½•ä¸º <code>META-INF/shenyu/</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šæ‰«æ <code>SHENYU_DIRECTORY</code> ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ç”± <code>ExtensionLoader</code> ç±»æ¥åŠ è½½æ‰€é…ç½®çš„<code>SPI</code>æ‰©å±•ç±»ï¼Œå¹¶cacheåˆ°å†…å­˜ä¸­ã€‚  é…ç½®æ–‡ä»¶å†…å®¹ä¸º key=classçš„å½¢å¼ã€‚ åœ¨ç³»ç»Ÿæ‰§è¡ŒæœŸé—´ï¼Œ ç”±<code>ExtensionFactory</code>çš„å®ç°ç±»ï¼Œè¿”å›keyæ‰€å¯¹åº”çš„<code>SPI</code>å®ç°ç±»ã€‚ </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-pluginçš„spi-å®ç°"></a>shenyu-pluginçš„<code>SPI</code> å®ç°<a class="hash-link" href="#shenyu-pluginçš„spi-å®ç°" title="Direct link to heading">#</a></h2><p>åœ¨<strong><em>shenyu-plugin</em></strong>æ¨¡ç»„ä¸­ï¼ŒæŒ‰ç…§æ’ä»¶æœºåˆ¶ï¼Œå®ç°äº†å„ç§è¯·æ±‚è½¬å‘åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ”¯æŒrequest, redirect, response, rewriteç­‰httpåè®®åŠŸèƒ½ï¼ŒåŠ gRPC, dubbo, hystrixç­‰å¾®æœåŠ¡æ¡†æ¶ï¼Œ å¹¶ä¸”æ’ä»¶åŠŸèƒ½è¿˜åœ¨ä¸æ–­å¢åŠ ä¸­ã€‚å¦‚æœåœ¨å„è‡ªçš„åŠŸèƒ½æ’ä»¶å®åšç±»ä¸­ï¼Œè¿˜è¦åšå¯¹routing å‚æ•°çš„è§£æç­‰å¤„ç†ï¼Œä¸ä»…ä¼šé€ æˆç¨‹åºçš„å†—ä½™ï¼Œè€Œä¸”å½“è¦æ”¯æŒå„è‡ªåŒ¹é…è§„åˆ™ï¼Œå¦‚é€šé…ç¬¦ã€æ­£åˆ™è¡¨è¾¾å¼ã€SpELè§£æç­‰ï¼Œä¼šé€ æˆé¢‘ç¹å¯¹æ’ä»¶æ ¸å¿ƒä»£ç çš„ä¿®æ”¹ã€‚å› æ­¤ï¼Œåœ¨<strong><em>shenyu-plugin</em></strong>æ¨¡ç»„ä¸­ï¼Œå°†routingå‚æ•°è§£æåšäº†æ›´é«˜ä¸€å±‚çš„æŠ½è±¡ï¼Œå¹¶æŒ‰ç…§<code>SPI</code>æœºåˆ¶åšäº†è§„åˆ™è§£æçš„å®ç°ã€‚è§£æç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ul><li><p><code>ParameterData</code>-å‚æ•°èµ„æ–™,  </p></li><li><p><code>PredictJudge</code>-æ–­è¨€</p></li><li><p><code>MatchStrategy</code>-åŒ¹é…ç­–ç•¥ä¸‰ä¸ª<code>SPI</code>å®ç°ã€‚</p><p>è¿™äº›æ‰©å±•ç±»å®šä¹‰åœ¨ <strong><em>shenyu-plugin-base</em></strong> moduleä¸­ï¼Œç»è¿‡è¿™æ ·æŠ½è±¡åï¼Œæ¯ä¸ªæ’ä»¶å®ç°ä¸­ï¼Œrouting å‚æ•°è§£æçš„åŠŸèƒ½å…¨éƒ¨ç”±AbstractShenyuPlugin æ¥è°ƒç”¨ä¸Šè¿°ä¸‰ä¸ª<code>SPI</code>å·¥å‚ç±»æ¥å®šä¹‰å’Œå®ç°ã€‚åšåˆ°äº†åŠŸèƒ½çš„ä¸“ä¸€ï¼Œå¹¶æ˜“äºæ‰©å±•ï¼Œç¬¦åˆSOLIDåŸåˆ™ã€‚</p></li></ul><p>æœ¬èŠ‚å°±å…¶ä¸­çš„<code>PredictJudge</code>-æ–­è¨€åšè¯¦ç»†è§£æã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªmoduleä¸­çš„pomæ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº†å¯¹<strong><em>shenyu-<code>SPI</code></em></strong>çš„ä¾èµ–</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge-spi-è®¾è®¡"></a>PredicateJudge <code>SPI</code> è®¾è®¡<a class="hash-link" href="#predicatejudge-spi-è®¾è®¡" title="Direct link to heading">#</a></h3><p>PredicateJudge <code>SPI</code> å®ç°ç”¨æ¥è§£æåˆ¤æ–­å„ç±»è§„åˆ™ï¼Œå½“ç½‘å…³ä¸­é…ç½®çš„ã€‚è¿™ä¸ªç±»å‘½åå’ŒåŠŸèƒ½éƒ½ç±»ä¼¼äºjava çš„<a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener noreferrer">Predicate</a>  ï¼Œä½†å¯¹æ¥å—è¡Œä¸ºåšäº†æ›´è¿›ä¸€æ­¥çš„æŠ½è±¡ã€‚è¿™ä¸ª<code>SPI</code>é€šè¿‡ä¸€ä¸ªå·¥å‚å’Œç­–ç•¥æ¨¡å¼å®ç°ï¼Œé¦–å…ˆæ¥çœ‹<code>PredicateJudge</code> <code>SPI</code>æ¥å£çš„å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@FunctionalInterface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PredicateJudge {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * judge conditionData and realData is match.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param conditionData {@linkplain ConditionData}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param realData       realData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true is pass  false is not pass.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean judge(ConditionData conditionData, String realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™éƒ¨åˆ†çš„ç±»å›¾å¦‚ä¸‹ï¼š</p><p>Fig 2-Predicate class diagram</p><p><img alt="predicate-class-diagram" src="/zh/assets/images/predicate-class-diagram-67a93b8c3e49800b23fe717c22027c54.png"></p><p><code>PredicateJudgeFactory</code>çš„é‡è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static PredicateJudge newInstance(final String operator) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(PredicateJudge.class).getJoin(processSpecialOperator(operator));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static Boolean judge(final ConditionData conditionData, final String realData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(conditionData) || StringUtils.isBlank(realData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(conditionData.getOperator()).judge(conditionData, realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œ<code>ConditionData</code>å®šä¹‰å¦‚ä¸‹åŒ…å«å±æ€§å››ä¸ªStringç±»å‹çš„å±æ€§ï¼š <code>paramType, operator,paramName,paramValue</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="paramtypeenum"></a>ParamTypeEnum<a class="hash-link" href="#paramtypeenum" title="Direct link to heading">#</a></h4><p>å‚æ•° <code>paramType</code>å¿…é¡»ä¸ºç³»ç»Ÿä¸­æšä¸¾ç±»å‹ <code>ParamTypeEnum</code>ï¼Œé»˜è®¤æ”¯æŒçš„<code>paramType</code>æœ‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">post, uri,query, host, ip,header, cookie,req_method</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="operatorenum"></a>OperatorEnum<a class="hash-link" href="#operatorenum" title="Direct link to heading">#</a></h4><p> <code>operator</code> å¿…é¡»ä¸ºæšä¸¾ç±»å‹ <code>OperatorEnum</code> ï¼Œç›®å‰æ”¯æŒçš„æ“ä½œç¬¦æœ‰ï¼šï¼ˆæ³¨æ„ï¼Œä¸¥æ ¼åŒºåˆ†å¤§å°å†™)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   match, =,regex, &gt;,&lt;, contains, SpEL,  Groovy, TimeBefore,TimeAfter</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŸºäºä»¥ä¸Šçš„è§„åˆ™, plugin æ¨¡ç»„å®ç°äº†å¦‚ä¸‹8ä¸ª <code>PredicateJudge</code> å®ç°ç±»ï¼Œåˆ†åˆ«å®ç°ä¸Šè¿°operatorçš„é€»è¾‘åŒ¹é…è§„åˆ™.</p><table><thead><tr><th>Implementation class</th><th>Rule denotes è§„åˆ™è¯´æ˜</th><th>corespondece operator</th></tr></thead><tbody><tr><td><code>ContainsPredicateJudge</code></td><td>åŒ…å«å…³ç³» &quot;contains&quot;ï¼Œ å®é™…ç»“æœï¼Œéœ€è¦åŒ…å«æ‰€å®šè§„åˆ™çš„å€¼</td><td>contains</td></tr><tr><td><code>EqualsPredicateJudge</code></td><td>ç›¸ç­‰&quot;=&quot;ï¼Œ</td><td>=</td></tr><tr><td><code>MatchPredicateJudge</code></td><td>ç”¨äºURI è·¯å¾„åŒ¹é…çš„å¤„ç†</td><td>match</td></tr><tr><td><code>TimerAfterPredicateJudge</code></td><td>å½“å‰localæ—¶é—´æ˜¯å¦æ™šäºè®¾å®šçš„æ—¶é—´</td><td>TimeAfter</td></tr><tr><td><code>TimerBeforePredicateJudge</code></td><td>å½“å‰localæ—¶é—´æ˜¯å¦æ—©äºè®¾å®šçš„æ—¶é—´</td><td>TimeBefore</td></tr><tr><td><code>GroovyPredicateJudge</code></td><td>Groovy,è®¾å®šParamNameçš„å€¼ï¼Œä¸è®¾å®šParamValueç›¸åŒ</td><td>Groovy</td></tr><tr><td><code>RegexPredicateJudge</code></td><td>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…èµ„æ–™</td><td>regex</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è°ƒç”¨æ–¹æ³•"></a>è°ƒç”¨æ–¹æ³•<a class="hash-link" href="#è°ƒç”¨æ–¹æ³•" title="Direct link to heading">#</a></h3><p>å½“è¦åšä¸€ç»„å‚æ•°çš„è§£ææ—¶ï¼Œåªéœ€è¦è°ƒç”¨<code>PredicateJudgeFactory</code>çš„judgeæ–¹æ³•å³å¯ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">PredicateJudgeFactory.judge(final ConditionData conditionData, final String realData);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spié…ç½®æ–‡ä»¶"></a><code>SPI</code>é…ç½®æ–‡ä»¶<a class="hash-link" href="#spié…ç½®æ–‡ä»¶" title="Direct link to heading">#</a></h3><p>è¿™äº›<code>PredicateJudge</code>å®ç°ç±»åœ¨  <code>SHENYU_DIRECTORY</code> ä¸­çš„configæ–‡ä»¶ä¸­åšäº†é…ç½®ï¼Œåœ¨å¯åŠ¨æ—¶ä¼šåŠ åŠ è½½å¹¶cacheåˆ°å†…å­˜ä¸­ã€‚</p><p><code>PredicateJudge</code>æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸ºkey=classå½¢å¼ï¼Œå·¦è¾¹çš„operatorè¦å’Œ<code>ParamEnum</code>ä¸­çš„å®šä¹‰ä¸€è‡´ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">equals=org.apache.shenyu.plugin.base.condition.judge.EqualsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">contains=org.apache.shenyu.plugin.base.condition.judge.ContainsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Groovy=org.apache.shenyu.plugin.base.condition.judge.GroovyPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">match=org.apache.shenyu.plugin.base.condition.judge.MatchPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">regex=org.apache.shenyu.plugin.base.condition.judge.RegexPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SpEL=org.apache.shenyu.plugin.base.condition.judge.SpELPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeAfter=org.apache.shenyu.plugin.base.condition.judge.TimerAfterPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeBefore=org.apache.shenyu.plugin.base.condition.judge.TimerBeforePredicateJudge</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge-spiåœ¨ç½‘å…³pluginä¸­çš„ä½¿ç”¨"></a>PredicateJudge <code>SPI</code>åœ¨ç½‘å…³Pluginä¸­çš„ä½¿ç”¨<a class="hash-link" href="#predicatejudge-spiåœ¨ç½‘å…³pluginä¸­çš„ä½¿ç”¨" title="Direct link to heading">#</a></h2><p>ç½‘å…³ç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨åˆ†çš„Plugin éƒ½ç»§æ‰¿è‡ª<code>AbstractShenyuPlugin</code>ï¼Œè¿™ä¸ªæŠ½è±¡ç±»ä¸­ï¼Œåœ¨åšé€‰æ‹©å’Œè§„åˆ™è§£ææ—¶ï¼Œè°ƒç”¨äº†ä¸Šè¿°<code>SPI</code>ä¸­çš„<code>MatchStrategy</code>ï¼Œç»§è€Œåœ¨ç­–ç•¥åˆ¤æ–­æ—¶è°ƒç”¨<code>PredicateJudge</code> çš„å„ä¸ªæ–­è¨€ç±»æ¥å¤„ç†ã€‚</p><p>Pluginä¸<code>SPI</code> çš„ç±»å›¾å¦‚ä¸‹:</p><p>Fig 3- class diagram of plugins with PredicateJudge and <code>MatchStrategy</code> <code>SPI</code></p><p><img alt="plugin-SPI-class-diagram" src="/zh/assets/images/plugin-SPI-class-diagram-fa432591b833ff178cb662ce352f5b23.png"></p><p>ä»å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ï¼Œåœ¨ç³»ç»Ÿä¸­è°ƒç”¨è§„åˆ™éƒ¨åˆ†çš„<code>SPI</code>çš„æµç¨‹å¦‚ä¸‹ï¼š</p><p>Fig 4- flow chart for Shenyu gateway filter  with parameter processing</p><p><img alt="SPI-flow-diagram" src="/zh/assets/images/SPI-flow-diagram-590f2cd298ae7655330a62a2010b006e.png"></p><ul><li>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šåŠ è½½ç›®å½•ä¸‹é…ç½®çš„<code>SPI</code>èµ„æ–™åˆ°å†…å­˜ä¸­</li><li>å½“clientæœ‰æ–°çš„è¯·æ±‚å‘åˆ°Apache shenyu ç½‘å…³ç³»ç»Ÿæ—¶ï¼Œåœ¨ç½‘å…³å†…éƒ¨ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„plugin</li><li>å¯¹å®é™…è¯·æ±‚èµ„æ–™åšè§„åˆ™åŒ¹é…æ—¶ï¼Œä¼šæ ¹æ®æ‰€åŒ…å«çš„operator,è°ƒç”¨çš„å¯¹åº”çš„PredicateJudgeå®ç°ç±»</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å…¶ä»–"></a>å…¶ä»–<a class="hash-link" href="#å…¶ä»–" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge--åˆ¤æ–­ç»“æœä¸¾ä¾‹"></a>PredicateJudge  åˆ¤æ–­ç»“æœä¸¾ä¾‹<a class="hash-link" href="#predicatejudge--åˆ¤æ–­ç»“æœä¸¾ä¾‹" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="containspredicatejudge---contains-rule"></a>ContainsPredicateJudge- &quot; containsâ€œ rule<a class="hash-link" href="#containspredicatejudge---contains-rule" title="Direct link to heading">#</a></h4><p> ä¸¾ä¾‹ï¼šç»™å®šä¸€ç»„å‚æ•°ï¼ˆConditionData ï¼‰ï¼Œ paramType=&quot;uri&quot;, paramValue æ˜¯ &quot;/http/**&quot;</p><p>å½“åº”ç”¨ ContainsPredicateJudgeåŒ…å«å…³ç³»æ—¶ï¼Œåˆ¤æ–­ç»“æœå¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>ConditionData  (operator=&quot;contains&quot;)</th><th>real data</th><th>judge result</th></tr></thead><tbody><tr><td>paramType=&quot;uri&quot;,    &quot;/http/**&quot;</td><td>&quot;/http/**/test&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/test/http/**/other&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/http1/**&quot;</td><td>false</td></tr></tbody></table><p>å…¶ä»–çš„å‡ ä¸ªPredicateJudgeçš„å…·ä½“åŠŸèƒ½å¯å‚è€ƒå…¶ä»£ç å’Œæµ‹è¯•ç±».</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor">ç¤¾åŒºæ–°äººå¼€å‘è€…å¯åŠ¨åŠå¼€å‘é˜²è¸©å‘æŒ‡å—</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-06-01T03:06:51.476Z">2023å¹´6æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/61108539?s=400&amp;u=f065b78a2944f2cea9160de7f7df054e2f157867&amp;v=4" alt="Yuxuan Zhang"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer">Yuxuan Zhang</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å‰è¨€"></a>å‰è¨€<a class="hash-link" href="#å‰è¨€" title="Direct link to heading">#</a></h2><p>ä½œä¸º <code>Shenyu</code> ç¤¾åŒºåˆæ¥ä¹åˆ°çš„å¼€å‘è€…ï¼Œæˆ‘åœ¨æŒ‰ç…§ç›¸å…³æ•™ç¨‹è¿›è¡Œé¡¹ç›®å¯åŠ¨åŠå¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€äº›æ•™ç¨‹ä¸­å¹¶æœªæåŠåˆ°çš„ â€œå‘â€ ï¼Œ æˆ‘å°†æˆ‘å¯åŠ¨<code>shenyu</code> , <code>shenyu-dashboard</code>, <code>shenyu-website</code> çš„è¯¦ç»†æ­¥éª¤è®°å½•åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ç¤¾åŒºä¸­æ›´å¤šçš„æ–°äººå¼€å‘è€…ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡<a class="hash-link" href="#ç¯å¢ƒå‡†å¤‡" title="Direct link to heading">#</a></h2><ul><li>æœ¬åœ°æ­£ç¡®å®‰è£… <code>JDK1.8+</code></li><li>æœ¬åœ°æ­£ç¡®å®‰è£… <code>Git</code></li><li>é€‰æ‹©ä¸€æ¬¾å¼€å‘å·¥å…·ï¼Œæœ¬æ–‡ä½¿ç”¨ <code>IDEA</code> ä¸ºä¾‹</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-åç«¯å¯åŠ¨æŒ‡å—"></a>ShenYu åç«¯å¯åŠ¨æŒ‡å—<a class="hash-link" href="#shenyu-åç«¯å¯åŠ¨æŒ‡å—" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å®‰è£…å¹¶é…ç½®maven"></a>å®‰è£…å¹¶é…ç½®Maven<a class="hash-link" href="#å®‰è£…å¹¶é…ç½®maven" title="Direct link to heading">#</a></h3><p>Mavenæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„é¡¹ç›®ç®¡ç†å·¥å…·ã€‚ä½œä¸ºApacheç»„ç»‡é¡¶çº§å¼€æºé¡¹ç›®ï¼Œå…¶ä¸»è¦æœåŠ¡äºåŸºäºJavaå¹³å°çš„é¡¹ç›®åˆ›å»ºï¼Œä¾èµ–ç®¡ç†å’Œé¡¹ç›®ä¿¡æ¯ç®¡ç†ã€‚</p><ol><li><p><a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener noreferrer">ä¸‹è½½ maven</a>ï¼Œå¹¶è§£å‹åˆ°ä¸€ä¸ªæ²¡æœ‰ä¸­æ–‡æ²¡æœ‰ç©ºæ ¼çš„è·¯å¾„ä¸‹ã€‚</p><p><img src="/zh/assets/images/maven-install-1810a86409d255c485e91852e679baad.png"></p></li><li><p>å°† <code>maven</code> ç›®å½•ä¸‹çš„ <code>bin</code> ç›®å½•æ·»åŠ è‡³ç¯å¢ƒå˜é‡ä¸­ã€‚ä»¥ <code>Windows</code> ä¸ºä¾‹ï¼Œè‹¥ä¸‹è½½ç›®å½•ä¸º <code>E:\apache-maven-3.9.1</code> ï¼Œåˆ™å°†<code>E:\apache-maven-3.9.1\bin</code> æ·»åŠ è‡³ <code>Path</code> ç³»ç»Ÿå˜é‡ä¸­ã€‚</p></li><li><p>éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸã€‚åœ¨å‘½ä»¤è¡Œçª—å£ä¸­è¾“å…¥ <code>mvn -v</code> ï¼Œè‹¥å‡ºç° Maven ç‰ˆæœ¬åŠ Java ç‰ˆæœ¬å³ä¸ºå®‰è£…æˆåŠŸã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">mvn -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Maven </span><span class="token number" style="color:#36acaa">3.9</span><span class="token plain">.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">2e178502fcdbffc201671fb2537d0cb4b4cc58f8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Maven home: E:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">apache-maven-3.9.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Java version: </span><span class="token number" style="color:#36acaa">18.0</span><span class="token plain">.1.1, vendor: Oracle Corporation, runtime: C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Program Files</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Java</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">jdk-18.0.1.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Default locale: zh_CN, platform encoding: UTF-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain">OS name: </span><span class="token string" style="color:#e3116c">&quot;windows 10&quot;</span><span class="token plain">, version: </span><span class="token string" style="color:#e3116c">&quot;10.0&quot;</span><span class="token plain">, arch: </span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain">, family: </span><span class="token string" style="color:#e3116c">&quot;windows&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>ä¸ºäº†åŠ å¿«é¡¹ç›®ç›¸å…³ä¾èµ–çš„ä¸‹è½½é€Ÿåº¦ï¼Œéœ€è¦æ›´æ”¹ Maven é•œåƒï¼Œæ­¤å¤„æ·»åŠ é˜¿é‡Œäº‘ç­‰é•œåƒã€‚å°† <code>conf/settings.xml</code> ä¸­ <code>&lt;mirrors&gt; &lt;/mirrors&gt;</code> æ ‡ç­¾å¯¹æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/groups/public/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/repositories/central/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">name_</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://repo1.maven.org/maven2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit address/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://jcenter.bintray.com/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¹¶åœ¨ <code>&lt;/mirrors&gt;</code> ä¸‹ä¸€è¡Œæ·»åŠ  <code>&lt;localRepository&gt;E:/maven_local_repository&lt;/localRepository&gt;</code>è®¾ç½® Maven æœ¬åœ°ä»“åº“ä½ç½®ã€‚å…·ä½“ä½ç½®å¯è‡ªè¡ŒæŒ‡å®šã€‚</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‹‰å–-shenyu-ä»£ç "></a>æ‹‰å– ShenYu ä»£ç <a class="hash-link" href="#æ‹‰å–-shenyu-ä»£ç " title="Direct link to heading">#</a></h3><ol><li><p>åœ¨ Github ä¸Š Fork <a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer">ShenYu</a> ä»“åº“åˆ°è‡ªå·±çš„å­˜å‚¨åº“ä¸­ï¼Œä»¥åå¯åœ¨æ­¤ä»“åº“ä¸­è¿›è¡Œå¼€å‘å¹¶æäº¤ PR</p></li><li><p>ä½¿ç”¨ Git å°†ä¸Šä¸€æ­¥ Fork çš„ä»“åº“ä¸‹è½½åˆ°æœ¬åœ°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‹¥æç¤ºæ–‡ä»¶åè¿‡é•¿ï¼Œåˆ™é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> config --global core.longpaths </span><span class="token boolean" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-åˆå¯åŠ¨"></a>ShenYu åˆå¯åŠ¨<a class="hash-link" href="#shenyu-åˆå¯åŠ¨" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ<a class="hash-link" href="#å‡†å¤‡å·¥ä½œ" title="Direct link to heading">#</a></h4><ol><li><p>åœ¨ <code>shenyu</code> ç›®å½•ä¸‹ä½¿ç”¨ Maven è¿›è¡Œç¼–è¯‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>é…ç½® IDEA ç¯å¢ƒã€‚ä½¿ç”¨ IDEA æ‰“å¼€ <code>shenyu</code> é¡¹ç›®ï¼Œç‚¹å‡»å·¦ä¸Šè§’ <code>File</code> -&gt; <code>Settings</code> ï¼ŒæŒ‰ç…§ä¸‹å›¾é…ç½®  Maven ã€‚å…¶ä¸­ <code>User settings file</code> é€‰æ‹©ä½ çš„ <code>settings.xml</code> æ‰€åœ¨ç›®å½•ï¼Œ <code>Local repository</code> ä¼šè‡ªåŠ¨åŠ è½½ <code>settings.xml</code> ä¸­è®¾ç½®çš„ <code>localRepository</code> è·¯å¾„ï¼š</p><p><img src="/zh/assets/images/idea-config-eab162e57c60c188ae39b46d08d17d0a.png"></p></li><li><p>æ­¤æ—¶ï¼ŒIDEA ä¼šè‡ªåŠ¨ä¸‹è½½é¡¹ç›®ç›¸å…³ä¾èµ–ï¼Œéœ€ç­‰å¾…ä¸€ä¼šï¼Œå®Œæˆåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/zh/assets/images/project-without-example-0a8dc1e81a325b6ce56328b3d282325d.png"></p><p>å¯ä»¥å‘ç°ï¼Œ <code>shenyu-e2e</code>, <code>shenyu-examples</code>, <code>shenyu-integrated-test</code> æ²¡æœ‰è¢« IDEA æ ‡è®°ä¸º Maven é¡¹ç›®ï¼Œéœ€æ‰‹åŠ¨æ·»åŠ ã€‚åˆ†åˆ«é€‰ä¸­åŒ…ä¸­çš„ <code>pom.xml</code> æ–‡ä»¶ï¼Œå³é”®ç‚¹å‡» <code>Add as Maven Project</code> ã€‚
è‹¥ shenyu-e2e æ„å»ºå¤±è´¥ï¼Œåˆ™å°†å…¶ <code>pom.xml</code> ä¸­ <code>&lt;relativePath&gt;./pom.xml&lt;/relativePath&gt;</code> æ”¹ä¸º <code>&lt;relativePath/&gt;</code> ã€‚</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨ç½‘å…³æœåŠ¡"></a>å¯åŠ¨ç½‘å…³æœåŠ¡<a class="hash-link" href="#å¯åŠ¨ç½‘å…³æœåŠ¡" title="Direct link to heading">#</a></h4><ol><li><p>å¯åŠ¨ <code>shenyu-admin</code> æ§åˆ¶å°ï¼ˆé»˜è®¤ä½¿ç”¨H2æ•°æ®åº“ï¼‰</p><p><img src="/zh/assets/images/admin-debdd1ee5e979a4892f26e4d54572ead.png"></p></li><li><p>å¯åŠ¨ <code>shenyu-bootstrap</code></p><p><img src="/zh/assets/images/bootstrap-cafa4d22b0d69bb6ee82c01e7b45d239.png"></p></li></ol><blockquote><p>åˆ°è¿™ä¸€æ­¥ï¼Œshenyuç½‘å…³å·²ç»å¯åŠ¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®adminæ§åˆ¶å°ï¼š<a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p><p>é»˜è®¤è´¦å·ï¼šadmin ï¼Œé»˜è®¤å¯†ç ï¼š123456</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨åº”ç”¨æœåŠ¡"></a>å¯åŠ¨åº”ç”¨æœåŠ¡<a class="hash-link" href="#å¯åŠ¨åº”ç”¨æœåŠ¡" title="Direct link to heading">#</a></h4><p>Apache ShenYuæä¾›äº†Httpã€Dubboã€SpringCloudç­‰åº”ç”¨æ¥å…¥shenyuç½‘å…³çš„æ ·ä¾‹ï¼Œä½äº <code>shenyu-example</code> æ¨¡å—ï¼Œè¿™é‡Œä»¥HttpæœåŠ¡ä¸ºä¾‹ã€‚</p><p>å¯åŠ¨ <code>shenyu-examples-http</code>ã€‚</p><p><img src="/zh/assets/images/shenyu-examples-http-16e2cd3166eb89067d20ab76fbd2000a.png"></p><p>è¿™æ—¶ï¼Œ<code>shenyu-examples-http</code> ä¼šè‡ªåŠ¨æŠŠåŠ  <code>@ShenyuSpringMvcClient</code> æ³¨è§£çš„æ¥å£æ–¹æ³•ï¼Œä»¥åŠapplication.ymlä¸­çš„ç›¸å…³é…ç½®æ³¨å†Œåˆ°ç½‘å…³ã€‚æˆ‘ä»¬æ‰“å¼€ <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">adminæ§åˆ¶å°</a>ï¼Œå³å¯åœ¨<code>æ’ä»¶åˆ—è¡¨ -&gt; Proxy -&gt; divide</code> ä¸­çœ‹åˆ°ç›¸å…³é…ç½®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æµ‹è¯•httpè¯·æ±‚"></a>æµ‹è¯•Httpè¯·æ±‚<a class="hash-link" href="#æµ‹è¯•httpè¯·æ±‚" title="Direct link to heading">#</a></h4><p>ä¸‹é¢ä½¿ç”¨ <code>IDEA HTTP Client Plugin</code> æ¨¡æ‹Ÿ http çš„æ–¹å¼æ¥è®¿é—® http æœåŠ¡ã€‚</p><ul><li><p>æœ¬åœ°è®¿é—®ï¼Œä¸ä½¿ç”¨ shenyu ä»£ç†</p><p>  <img src="/zh/assets/images/shenyu-http-test-api-local-0769bf0aa49ba1d1bf19781429c0311b.png"></p></li><li><p>ä½¿ç”¨ shenyu ä»£ç†</p><p>  <img src="/zh/assets/images/shenyu-http-test-api-b3f37741aee04845e891179e8eb6a137.png"></p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä½¿ç”¨æ›´å¤šæ’ä»¶"></a>ä½¿ç”¨æ›´å¤šæ’ä»¶<a class="hash-link" href="#ä½¿ç”¨æ›´å¤šæ’ä»¶" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="/zh/blog/docs/index">å®˜æ–¹æ–‡æ¡£</a>å·¦ä¾§<code>æ’ä»¶é›†åˆ</code>ï¼Œæ¥ä½¿ç”¨æ‰€éœ€è¦æ’ä»¶ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-å‰ç«¯å¯åŠ¨æŒ‡å—"></a>Shenyu å‰ç«¯å¯åŠ¨æŒ‡å—<a class="hash-link" href="#shenyu-å‰ç«¯å¯åŠ¨æŒ‡å—" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å®‰è£…-nodejs"></a>å®‰è£… Node.js<a class="hash-link" href="#å®‰è£…-nodejs" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä¸‹è½½"></a>ä¸‹è½½<a class="hash-link" href="#ä¸‹è½½" title="Direct link to heading">#</a></h4><ol><li><p>åœ¨<a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">å®˜ç½‘</a>ä¸‹è½½å¹¶å®‰è£…Node.js ï¼Œé€‰æ‹© <code>LTS</code> ç‰ˆæœ¬å³å¯</p></li><li><p>å®‰è£…æ—¶ï¼Œé™¤äº†è®¾ç½®å®‰è£…è·¯å¾„ï¼Œå…¶ä»–ä¸€ç›´ç‚¹ <code>Next</code> å³å¯</p></li><li><p>å®‰è£…å®Œæˆåï¼Œåœ¨å‘½ä»¤è¡Œä¸­è¿›è¡ŒéªŒè¯ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">node -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">v12.22.12</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">npm -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6.14</span><span class="token plain">.16</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ¢æº"></a>æ¢æº<a class="hash-link" href="#æ¢æº" title="Direct link to heading">#</a></h4><p>ä¸ºäº†åŠ å¿« npm ä¸‹è½½é€Ÿåº¦ï¼Œéœ€è¦è¿›è¡Œæ¢æºï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æŸ¥çœ‹å½“å‰æº</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> config get registry</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¢ä¸ºä¸­å›½ npmmirror é•œåƒæº</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> config </span><span class="token builtin class-name">set</span><span class="token plain"> registry https://registry.npmmirror.com</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æŸ¥çœ‹æ˜¯å¦æ¢æºæˆåŠŸ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> config get registry</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‹‰å–-shenyu-dashboard-ä»£ç "></a>æ‹‰å– ShenYu Dashboard ä»£ç <a class="hash-link" href="#æ‹‰å–-shenyu-dashboard-ä»£ç " title="Direct link to heading">#</a></h3><ol><li><p>Fork <a href="https://github.com/apache/shenyu-dashboard" target="_blank" rel="noopener noreferrer">ShenYu Dashboard</a> ä»“åº“</p></li><li><p>ä½¿ç”¨ Git ä¸‹è½½åˆ°æœ¬åœ°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å‰åç«¯è”åˆå¼€å‘"></a>å‰åç«¯è”åˆå¼€å‘<a class="hash-link" href="#å‰åç«¯è”åˆå¼€å‘" title="Direct link to heading">#</a></h3><ol><li><p>åœ¨åç«¯ä»“åº“ <code>shenyu</code> çš„ <code>shenyu-admin/src/main/resources/application.yml</code> æ–‡ä»¶ä¸­æŒ‰ä¸‹å›¾æ‰€ç¤ºæ·»åŠ  <code>enablePrintApiLog: true</code> ï¼Œä»¥åœ¨åç«¯æ§åˆ¶å°æ˜¾ç¤ºå‰ç«¯æ¥å£è¢«è°ƒç”¨çš„æ—¥å¿—ã€‚</p><p><img src="/zh/assets/images/enable-api-log-b7eedec55079ce1ef7b96e3076f46841.png"></p></li><li><p>å¯åŠ¨ <code>ShenyuAdminBootstrap</code></p></li><li><p>åˆ‡æ¢è‡³å‰ç«¯ä»“åº“ <code>shenyu-dashboard</code> ï¼Œæ‰“å¼€ <code>README</code> ï¼Œä¾æ¬¡ç‚¹å‡» <code>npm install</code>, <code>npm start</code> æˆ–é€šè¿‡å‘½ä»¤è¡Œè¾“å…¥ä¸Šè¿°å‘½ä»¤å³å¯é€šè¿‡ <a href="http://localhost:8000" target="_blank" rel="noopener noreferrer">http://localhost:8000</a> è®¿é—®å‰ç«¯ç•Œé¢ï¼Œå¹¶å¯åœ¨åç«¯æ§åˆ¶å°ä¸­æ˜¾ç¤ºå‰ç«¯æ¥å£è¢«è°ƒç”¨çš„æ—¥å¿—ï¼Œå®ç°å‰åç«¯è”åˆå¼€å‘ã€‚</p><p><img src="/zh/assets/images/admin-log-37289f14905e15906d363c0345b797cb.png"></p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‰“åŒ…å‰ç«¯ä»£ç "></a>æ‰“åŒ…å‰ç«¯ä»£ç <a class="hash-link" href="#æ‰“åŒ…å‰ç«¯ä»£ç " title="Direct link to heading">#</a></h3><p>æ‰§è¡Œ <code>README</code> ä¸­ <code>npm build</code> å‘½ä»¤ï¼Œå¹¶å°† dist æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°åç«¯ä»“åº“ä¸­ <code>shenyu-admin/src/main/resources/static/</code> ç›®å½•ä¸‹ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä¸º-shenyu-å®˜ç½‘åšè´¡çŒ®"></a>ä¸º Shenyu å®˜ç½‘åšè´¡çŒ®<a class="hash-link" href="#ä¸º-shenyu-å®˜ç½‘åšè´¡çŒ®" title="Direct link to heading">#</a></h2><p>æŒ‰ç…§ <a href="https://github.com/apache/shenyu-website" target="_blank" rel="noopener noreferrer">shenyu-website</a> ä¸­ <code>README</code> è¿›è¡Œæ“ä½œå³å¯ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å°è´´å£«"></a>å°è´´å£«<a class="hash-link" href="#å°è´´å£«" title="Direct link to heading">#</a></h3><ol><li>å¯ä»¥ä¸º <code>yarn</code> è¿›è¡Œæ¢æºï¼Œæµç¨‹åŒ <code>npm</code></li><li>å»ºè®®ä¸‹è½½ <code>Node</code> <a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">å®˜ç½‘</a>ä¸­ <code>LTS</code> ç‰ˆæœ¬</li><li><code>Windows</code> ç³»ç»Ÿæ— æ³•è¿›è¡Œéƒ¨ç½²ï¼Œå¦‚éœ€å¯¹ä½ çš„æ›´æ”¹è¿›è¡ŒéªŒè¯ï¼Œå¯ä»¥åœ¨Linux è™šæ‹Ÿæœºæˆ–æœåŠ¡å™¨ä¸Šè¿›è¡Œéƒ¨ç½²</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/first-start">first-start</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI ä»£ç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-06-01T03:06:51.476Z">2023å¹´6æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>é™æµæ˜¯ç½‘å…³å¿…å¤‡çš„åŠŸèƒ½ï¼Œç”¨æ¥åº”å¯¹é«˜å¹¶å‘è¯·æ±‚çš„åœºæ™¯ã€‚å½“ç³»ç»Ÿå—åˆ°å¼‚å¸¸æ”»å‡»ï¼ŒçŸ­æœŸå†…èšé›†äº†å¤§é‡çš„æµé‡ï¼›å½“æœ‰å¤§é‡ä½çº§åˆ«çš„è¯·æ±‚ï¼Œå¤„ç†è¿™äº›è¯·æ±‚ä¼šå½±å“å…³é”®ä¸šåŠ¡çš„å¤„ç†ï¼Œéœ€è¦é™åˆ¶è¿™äº›è¯·æ±‚çš„è®¿é—®é€Ÿåº¦; æˆ–è€…ç³»ç»Ÿå†…éƒ¨å‡ºç°ä¸€äº›å¼‚å¸¸ï¼Œä¸èƒ½æ»¡è´Ÿè·çš„æœåŠ¡æ•´ä¸ªåº”ç”¨è¯·æ±‚ç­‰ç­‰ã€‚è¿™äº›æƒ…å†µä¸‹ï¼Œéƒ½éœ€è¦å¯ç”¨é™æµæ¥ä¿æŠ¤ç³»ç»Ÿã€‚å¯ä»¥æ‹’ç»æœåŠ¡ã€ç­‰å¾…æˆ–é™çº§å¤„ç†ï¼Œå°†æµé‡é™åˆ¶åˆ°ç³»ç»Ÿå¯æ¥å—çš„é‡ï¼Œæˆ–è€…åªå…è®¸æŸäº›åŸŸå(æˆ–æŸäº›ä¸šåŠ¡)çš„è¯·æ±‚ä¼˜å…ˆå¤„ç†ã€‚</p><p>   é’ˆå¯¹ä»¥ä¸Šçš„åœºæ™¯éœ€æ±‚ï¼Œåœ¨è®¾è®¡ä¸€ä¸ª<code>API</code>ç½‘å…³çš„é™æµåŠŸèƒ½æ—¶ï¼Œå°±éœ€è¦è€ƒè™‘å¦‚ä¸‹çš„æ‰©å±•ç‚¹ï¼š</p><ol><li><p>å¯ä»¥æ”¯æŒå¤šç§é™æµçš„ç®—æ³•ï¼Œå¹¶æ˜“äºæ‰©å±•ã€‚</p></li><li><p>è¦å¯ä»¥æ”¯æŒå¤šç§é™æµçš„æ–¹å¼ï¼Œèƒ½åŒºåˆ†ç”¨æˆ·ç¾¤ã€é«˜ä½ä¼˜å…ˆçº§çš„è¯·æ±‚ã€‚</p></li><li><p>è¦æ”¯æŒé«˜å¹¶å‘ï¼Œèƒ½å¿«é€Ÿçš„åšå‡ºé™åˆ¶æˆ–é€šè¿‡çš„å†³ç­–ã€‚</p></li><li><p>è¦æœ‰å®¹é”™å¤„ç†ï¼Œå¦‚æœé™æµç¨‹åºå‡ºé”™ï¼Œç½‘å…³ç³»ç»Ÿèƒ½ç»§ç»­æ‰§è¡Œã€‚</p><p>æœ¬æ–‡ä¼šå…ˆä»‹ç»shenyuç½‘å…³é™æµéƒ¨åˆ†çš„æ€»ä½“æŠ€æœ¯æ¶æ„ï¼Œä¹‹åé‡ç‚¹åˆ†æ<code>RateLimiter</code> SPIæ‰©å±•å®ç°çš„ä»£ç ã€‚</p></li></ol><blockquote><p>This article based on <code>shenyu-2.4.0</code> version of the source code analysis.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiter--æ€»ä½“è®¾è®¡è¯´æ˜"></a>RateLimiter  æ€»ä½“è®¾è®¡è¯´æ˜<a class="hash-link" href="#ratelimiter--æ€»ä½“è®¾è®¡è¯´æ˜" title="Direct link to heading">#</a></h2><p>â€‹        WebFluxæ˜¯Spring æä¾›çš„åŸºäºReactoræ¨¡å‹çš„å¼‚æ­¥éé˜»å¡æ¡†æ¶ï¼Œèƒ½æå‡ååé‡ï¼Œä½¿ç³»ç»Ÿæœ‰æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ã€‚Apache Shenyuç½‘å…³çš„æ’ä»¶åŠŸèƒ½åŸºäºWebFluxæ¡†æ¶å®ç°çš„ã€‚RateLimiteråŠŸèƒ½æ˜¯åœ¨<code>ratelimiter-plugin</code>ä¸­å®ç°ã€‚åœ¨é™æµè¿‡ç¨‹ä¸­ï¼Œå¸¸ç”¨çš„ç®—æ³•æœ‰ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ç­‰ç®—æ³•ï¼Œè¿™äº›ç®—æ³•æ‰§è¡Œä¸­ï¼Œéœ€è¦æ£€æ ¸è¯·æ±‚çš„æ¥æºï¼Œå¯¹å·²ä½¿ç”¨çš„æµé‡åšè®¡æ•°åŠé€»è¾‘è®¡ç®—ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸é€šè¿‡ã€‚ä¸ºäº†æé«˜å¹¶å‘åŠæ€§èƒ½ï¼Œ å°†è®¡æ•°å’Œç®—æ³•é€»è¾‘å¤„ç†ï¼Œéƒ½æ”¾åˆ°redisä¸­ã€‚Javaä»£ç è´Ÿè´£åšæ•°æ®å‚æ•°çš„ä¼ é€’ã€‚åœ¨è°ƒç”¨redisæ—¶ï¼Œ<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">lua</a>è„šæœ¬å¯ä»¥å¸¸é©»åœ¨rediså†…å­˜ä¸­ï¼Œèƒ½å‡å°‘ç½‘ç»œå¼€é”€ï¼Œå¹¶å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œï¼Œå…·æœ‰åŸå­æ€§ã€‚<a href="https://spring.io/projects/spring-data-redis" target="_blank" rel="noopener noreferrer">Spring Data Redis</a> æä¾›äº†å¯¹<a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer">rediså‘½ä»¤</a>æ‰§è¡Œçš„æŠ½è±¡ï¼Œæ‰§è¡Œåºåˆ—åŒ–ï¼ŒåŠè‡ªåŠ¨ä½¿ç”¨redis è„šæœ¬ç¼“å­˜ã€‚åœ¨è¿™ä¸ªpluginä¸­ï¼Œç”±äºé‡‡ç”¨äº†reactor éé˜»å¡æ¡†æ¶ï¼Œæ‰€ä»¥é‡‡ç”¨Spring Redis Reactiveç±»åº“å®ç°å¯¹redisçš„åŠŸèƒ½è°ƒç”¨ã€‚</p><p>â€‹        è¿™ä¸ªpluginä¸­çš„ç±»åŒ…å›¾å¦‚ä¸‹ï¼Œé‡ç‚¹æ ‡å‡ºäº†ä¸<code>RateLimiter</code> <code>SPI</code>ç›¸å…³çš„ä¸¤ä¸ªpackage: resolver å’Œalgorithm.</p><p><img alt="ratelimiter-package-diagram" src="/zh/assets/images/ratelimiter-package-diagram-b041571cdf2f8592c23ab33bf07fbc71.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiter-spiçš„è®¾è®¡"></a>RateLimiter SPIçš„è®¾è®¡<a class="hash-link" href="#ratelimiter-spiçš„è®¾è®¡" title="Direct link to heading">#</a></h2><p>ç”±äºé‡‡ç”¨äº†Spring data+ Redis +luaæ¶æ„å®ç°äº†é«˜å¹¶å‘çš„éœ€æ±‚ã€‚ å¦‚ä½•åšåˆ°å¯¹ç®—æ³•å’Œé™æµæ–¹å¼çš„æ‰©å±•å‘¢ï¼Ÿ Shenyu ratelimiter  pluginä¸­è®¾è®¡äº†ä¸¤ä¸ªSPIæ¥å®ç°è¿™ä¸¤ä¸ªéœ€æ±‚ï¼š</p><ul><li><code>RateLimiterAlgorithm</code>ï¼šç”¨æ¥æ‰©å±•ä¸åŒçš„é™æµç®—æ³•ã€‚</li><li><code>RateLimiterKeyResolver</code>ï¼š ç”¨äºæ‰©å±•è·å–è¯·æ±‚çš„å…³é”®ä¿¡æ¯ï¼Œç”¨äºåŒºåˆ†æµé‡ï¼Œä¾‹å¦‚æŒ‰IP åœ°å€ã€æŒ‰æŸä¸€æ®µåŸŸåç­‰æ¥åŒºåˆ†è®¿é—®çš„è¯·æ±‚ã€‚</li></ul><p>SPIçš„å…·ä½“å®ä½œç±»ä¸é…ç½®ä¿¡æ¯ä½äºï¼š<code>SHENYU_DIRECTORY</code>ç›®å½•ä¸‹ (é»˜è®¤åœ¨<code>/META-INF/shenyu</code>)ä¸‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiterkeyresolver"></a>RateLimiterKeyResolver<a class="hash-link" href="#ratelimiterkeyresolver" title="Direct link to heading">#</a></h3><p>è·å–è¯·æ±‚çš„å…³é”®ä¿¡æ¯ï¼Œç”¨äºåˆ†ç»„é™æµï¼Œä¾‹å¦‚æŒ‰URL/ ç”¨æˆ· / IP ç­‰ï¼Œ <code>RateLimiterKeyResolver</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterKeyResolver {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get Key resolver&#x27;s name.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Key resolver&#x27;s name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getKeyResolverName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * resolve.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param exchange exchange the current server exchange {@linkplain ServerWebExchange}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return rate limiter key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolve(ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code>å°†å½“å‰interface æ³¨å†Œä¸ºShenyu SPI æ¥å£ã€‚resolve(ServerWebExchange exchange)æ–¹æ³•ç”¨æ¥æä¾›è§£ææ–¹å¼ã€‚</p><p>RateLimiterKeyResolver  SPI æä¾›äº†ä¸¤ç§key resolver, <code>WholeKeyResolve</code>å’Œ <code>RemoteAddrKeyResolver</code>ï¼Œå…¶ä¸­<code>RemoteAddrKeyResolver</code>ä¸­çš„<code>resolve</code>æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String resolve(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…¶keyå€¼ä¸ºè¯·æ±‚çš„IPåœ°å€ã€‚ åŸºäºSPIåŠå·¥å‚ç±»çš„å®ç°ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„æ‰©å±•å®ç°æ–°çš„key resolverï¼Œå¦‚URL,ç”¨æˆ·ç­‰ç­‰ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiteralgorithm-spi"></a>RateLimiterAlgorithm SPI<a class="hash-link" href="#ratelimiteralgorithm-spi" title="Direct link to heading">#</a></h3><p><code>RateLimiterAlgorithm</code> SPI ç”¨æ¥å®ç°å¯¹ä¸åŒé™æµç®—æ³•çš„è¯†åˆ«ã€åŠ è½½å’Œå®šä¹‰ï¼Œå…¶ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img alt="ratelimiteral-class-diagram" src="/zh/assets/images/ratelimiteral-class-diagram-24df4785848602bdc5b321cf609d5cda.png"></p><p>æœ¬æ¨¡ç»„ä½¿ç”¨äº†å·¥å‚æ¨¡å¼ï¼Œæä¾›äº†æ¥å£ç±»ã€æŠ½è±¡ç±»å’Œå·¥å‚ç±»ï¼Œæä¾›äº†4ä¸ªå®ç°ç±»ï¼Œå…¶ä¸­å®ç°ç±»å¯¹åº”çš„Luaè„šæœ¬åœ¨ <code>RateLimitEnum</code> ä¸­åšäº†å®šä¹‰ï¼Œæ”¾ç½®åœ¨ <code>/META-INF/scripts</code> ç›®å½•ä¸‹ã€‚æ¥å£<code>RateLimiterAlgorithm</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterAlgorithm&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisScript&lt;T&gt; getScript();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; getKeys(String id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param script the script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param keys the keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param scriptArgs the script args</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code> å°†è¿™ä¸ªæ¥å£æ³¨å†Œä¸ºshenyu SPI, å…¶ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>getScript()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª <code>RedisScript</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°†ä¼ é€’ç»™Redisã€‚</li><li><code>getKeys(String id)</code> è¿”å›ä¸€ä¸ªé”®å€¼çš„List.</li><li><code>callback()</code>å›è°ƒå‡½æ•°ç”¨äºå¼‚æ­¥å¤„ç†ä¸€äº›éœ€è¦åœ¨è¿”å›ååšçš„å¤„ç†ï¼Œç¼ºçœæ˜¯ç©ºæ–¹æ³•ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æŠ½è±¡ç±»-abstractratelimiteralgorithm"></a>æŠ½è±¡ç±» AbstractRateLimiterAlgorithm<a class="hash-link" href="#æŠ½è±¡ç±»-abstractratelimiteralgorithm" title="Direct link to heading">#</a></h4><p>åœ¨è¿™ä¸ªç±»ä¸­ï¼Œå®ç°äº†æ¥å£çš„æ¨¡æ¿æ–¹æ³•ï¼Œä½¿ç”¨å‚æ•°ç±»å‹ä¸º<code>List&lt;Long&gt;</code>,  æŠ½è±¡æ–¹æ³•getScriptName() å’ŒgetKeyName() ç•™ç»™å„ä¸ªå®ä½œç±»æ¥å®ç°ã€‚å¦‚ä¸‹çš„getScript() æ˜¯è¿™ä¸ªç±»ä¸­è¯»å–luaè„šæœ¬çš„å¤„ç†ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public RedisScript&lt;List&lt;Long&gt;&gt; getScript() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.initialized.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultRedisScript redisScript = new DefaultRedisScript&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String scriptPath = &quot;/META-INF/scripts/&quot; + getScriptName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(scriptPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setResultType(List.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.script = redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialized.compareAndSet(false, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return script;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AtomicBoolean</code>ç±»å‹çš„å˜é‡<code>initialized</code> ç”¨æ¥æ ‡è®°luaè„šæœ¬æ˜¯å¦æœ‰è¢«åŠ è½½ã€‚ å¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼Œå°±ä»/META-INF/scripts/ç›®å½•ä¸‹ï¼Œè¯»å–<code>scriptName</code>æŒ‡å®šçš„Luaæ–‡ä»¶ï¼ŒåŠ è½½æˆ<code>RedisScript</code>å¯¹è±¡ã€‚æŒ‡å®šç»“æœä¸º<code>List</code>ç±»å‹ï¼Œ è®¾å®šé‡<code>initialized</code>ä¸ºtrue,é¿å…é‡å¤åŠ è½½ã€‚ è¿”å› <code>RedisScript</code>å¯¹è±¡ã€‚</p><p><code>AbstractRateLimiterAlgorithm</code>ä¸­<code>getKeys()</code>çš„ä»£ç å¦‚ä¸‹ï¼Œ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String prefix = getKeyName() + &quot;.{&quot; + id;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = prefix + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestampKey = prefix + &quot;}.timestamp&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, timestampKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ¨¡æ¿æ–¹æ³•ä¸­ï¼Œäº§ç”Ÿäº†ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­ï¼Œ<code>tokenKey</code>ä¼šä½œä¸ºKeyä¼ é€’ç»™<code>redis</code>, æŒ‡å‘ä¸€ä¸ªæœ‰åºé›†åˆã€‚ <code>timestampKey</code>æ˜¯ä¸€ä¸ªä»¥ä¼ å…¥id ä¸ºè¯†åˆ«çš„å­—ç¬¦ä¸²ã€‚</p><p>å¯ä»¥ä»ä¸Šé¢çš„ç±»å›¾ä¸­çœ‹åˆ°ï¼Œ<code>ConcurrentRateLimiterAlgorithm</code> å’Œ<code>SlidingWindowRateLimiterAlgorithm</code> æœ‰è¦†å†™<code>getKeys(String id)</code>æ–¹æ³•ï¼Œè€Œä¸¤å¤–ä¸¤ä¸ªç®—æ³•ç¨‹åºï¼Œåˆ™é‡‡ç”¨çš„æ˜¯æŠ½è±¡ç±»ä¸­çš„å®ç°ã€‚ä¹Ÿåªæœ‰ <code>ConcurrentRateLimiterAlgorithm</code> é‡å†™äº†<code>callback()</code>æ–¹æ³•ã€‚ä¸‹æ–‡ä¸­æˆ‘ä»¬ä¼šå¯¹æ­¤åšè¿›ä¸€æ­¥çš„åˆ†æã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å·¥å‚ç±»ratelimiteralgorithmfactory"></a>å·¥å‚ç±»RateLimiterAlgorithmFactory<a class="hash-link" href="#å·¥å‚ç±»ratelimiteralgorithmfactory" title="Direct link to heading">#</a></h4><p><code>RateLimiterAlgorithmFactory</code> ä¸­ä¾æ®ç®—æ³•åç§°ï¼Œè·å–RateLimiterAlgorithmå®ä¾‹çš„æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static RateLimiterAlgorithm&lt;?&gt; newInstance(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Optional.ofNullable(ExtensionLoader.getExtensionLoader(RateLimiterAlgorithm.class).getJoin(name)).orElse(new TokenBucketRateLimiterAlgorithm());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æŒ‰ç…§Apache shenyu SPIçš„è§„åˆ™ï¼Œç”±åŠ è½½å™¨<code>ExtensionLoader</code>è·å¾—å®ä½œç±»ï¼Œå½“æ‰¾ä¸åˆ°ç®—æ³•æ—¶ï¼Œé»˜è®¤è¿”å›ä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ç±»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä¸redisåšèµ„æ–™äº¤äº’"></a>ä¸Redisåšèµ„æ–™äº¤äº’<a class="hash-link" href="#ä¸redisåšèµ„æ–™äº¤äº’" title="Direct link to heading">#</a></h3><p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬äº†è§£åˆ°Apache Shenyuç½‘å…³ä¸­ï¼ŒRateLimiter SPI çš„åŸºæœ¬æ‰©å±•ç‚¹ï¼Œåœ¨Shenyuç½‘å…³è¿è¡Œä¸­ï¼Œåº”ç”¨ReactiveRedisTemplate æ¥å¼‚æ­¥æ‰§è¡Œå¯¹redisçš„è°ƒç”¨å¤„ç†ã€‚å®ç°ä»£ç åœ¨RedisRateLimiterç±»çš„isAllowed()æ–¹æ³•ä¸­ï¼Œå…¶éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;RateLimiterResponse&gt; isAllowed(final String id, final RateLimiterHandle limiterHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get parameters that will pass to redis from RateLimiterHandle Object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double replenishRate = limiterHandle.getReplenishRate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double burstCapacity = limiterHandle.getBurstCapacity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double requestCount = limiterHandle.getRequestCount();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the current used RateLimiterAlgorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RateLimiterAlgorithm&lt;?&gt; rateLimiterAlgorithm = RateLimiterAlgorithmFactory.newInstance(limiterHandle.getAlgorithmName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ........</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flux&lt;List&lt;Long&gt;&gt; resultFlux = Singleton.INST.get(ReactiveRedisTemplate.class).execute(script, keys, scriptArgs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFlux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(1L, -1L)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .reduce(new ArrayList&lt;Long&gt;(), (longs, l) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    longs.addAll(l);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return longs;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).map(results -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean allowed = results.get(0) == 1L;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Long tokensLeft = results.get(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new RateLimiterResponse(allowed, tokensLeft);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(throwable -&gt; log.error(&quot;Error occurred while judging if user is allowed by RedisRateLimiter:{}&quot;, throwable.getMessage()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doFinally(signalType -&gt; rateLimiterAlgorithm.callback(script, keys, scriptArgs));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>POJO å¯¹è±¡RateLimiterHandle ä¸­ï¼Œå®šä¹‰äº†é™æµæ‰€éœ€çš„å±æ€§ç®—æ³•åç§°, é€Ÿå½•ï¼Œå®¹é‡ï¼Œè¯·æ±‚çš„æ•°é‡ ã€‚é¦–å…ˆ ä»limiterHandle åŒ…è£…ç±»ä¸­å–å¾—éœ€è¦ä¼ å…¥redisçš„å‡ ä¸ªå‚æ•°ã€‚ä¹‹åä»RateLimiterAlgorithmFactory ä»å·¥å‚ç±»å–å¾—å½“å‰é…ç½®çš„é™æµç®—æ³•ã€‚ ä¹‹ååšKeyå€¼å’Œå‚æ•°çš„ä¼ é€’ã€‚</p><p>ä¸ºäº†æ›´æ–¹ä¾¿é˜…è¯»ï¼Œä¸‹å›¾ç»™å‡ºäº†javaä»£ç ä¸redisæ‰§è¡Œå‚æ•°è¾“å…¥ã€è¾“å‡ºçš„ä¼ é€’è¿‡ç¨‹ã€‚å·¦è¾¹æ˜¯<code>isAllowed</code>() å‡½æ•°çš„ååŠéƒ¨åˆ†ä»£ç ï¼Œå³è¾¹æ˜¯ä¸€ä¸ªLuaè„šæœ¬çš„è¾“å…¥è¾“å‡ºä»£ç ã€‚</p><p>ä¸‹é¢è¯´æ˜Javaä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ol><li><p>ä»<code>getKeys()</code>æ–¹æ³•è·å¾—ä¸¤ä¸ªé”®å€¼<code>List&lt;String&gt;</code>. å…¶ä¸­ç¬¬ä¸€ä¸ªKeyä¼šæ˜ å°„ä¸ºRedisä¸­çš„æœ‰åºé›†åˆã€‚</p></li><li><p>è®¾å®š4ä¸ªå‚æ•°ï¼šé€Ÿç‡ replenishRate ,å®¹é‡ burstCapacity, æ—¶é—´æˆ³ï¼Œ è¿”å›å½“å‰java çºªå…ƒç§’æ•°(é•¿æ•´æ•°)EpochSecond, è¯·æ±‚çš„æ•°é‡ requestcount.</p></li><li><p>æŒ‰æ‰€è®¾å®šçš„è„šæœ¬ã€Keyå€¼ã€å‚æ•°è°ƒç”¨<code>ReactiveRedisTemplate</code>åŠŸèƒ½ï¼Œæ‰§è¡Œrediså¤„ç†ã€‚è¿”å›å‚æ•°æ˜¯<code>Flux&lt;List&lt;Long&gt;&gt;</code>ç±»å‹</p></li><li><p>é€šè¿‡reduceæ–¹æ³•å°†å…¶è¿”å›å€¼ä»<code>Flux&lt;ArrayList&lt;Long&gt;&gt;</code> ç±»å‹è½¬æ¢ä¸º<code>Mono&lt;ArrayList&lt;Long&gt;&gt;</code>ï¼Œå†ç»è¿‡mapæ–¹æ³•ï¼Œè½¬æ¢ä¸º<code>Mono&lt;RateLimiterResponse&gt;</code>è¿”å›ã€‚</p><p> è¿”å›ç»“æœæœ‰ä¸¤ä¸ªèµ„æ–™ï¼Œallowed =1, ä»£è¡¨å…è®¸é€šè¿‡ï¼Œ0-ä¸é€šè¿‡ï¼›è€Œç¬¬äºŒä¸ªè¿”å›å‚æ•°tokensLeftï¼Œæ˜¯å¯ç”¨çš„å‰©ä½™è¯·æ±‚æ•°é‡ã€‚</p></li></ol><p>5.å®¹é”™æ€§æ–¹é¢ï¼Œç”±äºä½¿ç”¨çš„æ˜¯reactor çš„éé˜»å¡é€šè®¯æ¨¡å‹ï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä¼šæ‰§è¡ŒonErrorResume()è¯­å¥ï¼ŒFlux.justäº§ç”Ÿè¿”å›èµ„æ–™ï¼Œ é»˜è®¤ä¸º<code>allowed</code>=1, ä»£è¡¨å…è®¸é€šè¿‡ï¼Œ å¹¶ä¸¢å‡ºé”™è¯¯æ—¥å¿—ã€‚</p><p>6.ä¹‹åæ‰§è¡ŒdoFinally()æ–¹æ³•,æ‰§è¡Œç®—æ³•å®ç°ç±»çš„callbackæ–¹æ³•ã€‚</p><p><img alt="io-with-lua" src="/zh/assets/images/io-with-lua-eefcd28d4b59a8bd0e69e29400018c50.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4ç§é™æµç®—æ³•"></a>4ç§é™æµç®—æ³•<a class="hash-link" href="#4ç§é™æµç®—æ³•" title="Direct link to heading">#</a></h2><p>ä¸Šé¢æˆ‘ä»¬äº†è§£äº†ç½‘å…³ä¸­å¦‚ä½•é€šè¿‡Javaä»£ç å¦‚ä½•ä¸Redis åšé€šè®¯ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬é€šè¿‡ç®€è¦åˆ†æç½‘å…³ä¸­æä¾›çš„4ç§é™æµç®—æ³•ä¸­çš„ä¸€äº›ä»£ç ï¼Œæ¥ç†è§£å¦‚ä½•å¼€å‘ä½¿ç”¨<code>RateLimiter SPI</code>çš„æ¥å£æ–¹æ³•,å¹¶ä¸Redisæœ‰æ•ˆåä½œã€‚</p><p><code>Ratelimiter SPI</code>ç›®å‰æä¾›äº†4ç§é™æµç®—æ³•:</p><table><thead><tr><th>Algorithm name</th><th>Java class</th><th>Lua script file</th></tr></thead><tbody><tr><td>Request rate limiter</td><td><code>TokenBucketRateLimiterAlgorithm</code></td><td>request_rate_limiter.lua</td></tr><tr><td>Slide window rate limiter</td><td><code>SlidingWindowRateLimiterAlgorithm</code></td><td>liding_window_request_rate_limiter.lua</td></tr><tr><td>Concurrent rate limiter</td><td><code>ConcurrentRateLimiterAlgorithm</code></td><td>concurrent_request_rate_limiter.lua</td></tr><tr><td>Leaky bucket algorithm</td><td><code>LeakyBucketRateLimiterAlgorithm</code></td><td>request_leaky_rate_limiter.lua</td></tr></tbody></table><ol><li>ä»¤ç‰Œæ¡¶é™æµï¼šæŒ‰è¯·æ±‚æ•°é‡é™æµï¼Œè®¾ç½®æ¯ç§’Nä¸ªè¯·æ±‚ï¼Œè¶…è¿‡Nçš„è¯·æ±‚ä¼šæ‹’ç»æœåŠ¡ã€‚ç®—æ³•å®ç°æ—¶ï¼Œä»¥æ—¶é—´é—´éš”è®¡ç®—åŒ€é€Ÿäº§ç”Ÿä»¤ç‰Œçš„æ•°é‡ã€‚è‹¥æ¯æ¬¡è¯·æ±‚çš„æ•°é‡ï¼Œå°äºæ¡¶å†…ä»¤ç‰Œçš„æ•°é‡ï¼Œåˆ™å…è®¸é€šè¿‡ã€‚ æ—¶é—´çª—å£ä¸º 2*å®¹ç§¯/é€Ÿç‡ã€‚</li><li>æ»‘åŠ¨çª—å£é™æµï¼šä¸ä»¤ç‰Œæ¡¶é™æµä¸åŒåœ¨äºï¼Œå…¶çª—å£å¤§å°æ¯”ä»¤ç‰Œæ¡¶çš„çª—å£å°ï¼Œä¸ºä¸€ä¸ªå®¹ç§¯/é€Ÿç‡ã€‚å¹¶ä¸”æ¯æ¬¡ç§»åŠ¨å‘åä¸€ä¸ªæ—¶é—´æ—¶é—´çª—å£ã€‚å…¶ä»–é™æµåŸç†ä¸ä»¤ç‰Œæ¡¶ç±»ä¼¼ã€‚</li><li>å¹¶å‘çš„è¯·æ±‚é€Ÿç‡é™æµï¼šä¸¥æ ¼é™åˆ¶å¹¶å‘è®¿é—®é‡ä¸ºNä¸ªè¯·æ±‚ï¼Œå¤§äºNçš„è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚æ¯æ¬¡å½“æœ‰æ–°è¯·æ±‚ï¼ŒæŸ¥çœ‹è®¡æ•°æ˜¯å¦å¤§äºN, è‹¥å°äºNåˆ™å…è®¸é€šè¿‡ï¼Œè®¡æ•°åŠ 1ã€‚ å½“è¿™ä¸ªè¯·æ±‚è°ƒç”¨ç»“æŸæ—¶ï¼Œä¼šé‡Šæ”¾è¿™ä¸ªä¿¡å·ï¼ˆè®¡æ•°å‡1ï¼‰</li><li>æ¼æ¡¶ç®—æ³•:  ç›¸å¯¹äºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¼æ¡¶ç®—æ³•æœ‰åŠ©äºå‡å°‘æµé‡èšé›†ï¼Œå®ç°æ›´ä¸ºå¹³æ»‘çš„é™æµå¤„ç†ã€‚ æ¼æ¡¶ç®—æ³•å¼ºåˆ¶ä»¥å¸¸æ•°Nçš„é€Ÿç‡è¾“å‡ºæµé‡ï¼Œå…¶ä»¥æ¼æ¡¶ä¸ºæ¨¡å‹ï¼Œå¯æ¼æ°´çš„é‡ä¸ºæ—¶é—´é—´éš” *é€Ÿç‡ã€‚è‹¥å¯æ¼æ°´é‡&gt;å·²ä½¿ç”¨é‡ï¼Œåˆ™å·²ä½¿ç”¨é‡è®¾ä¸º0( æ¸…ç©ºæ¼æ¡¶)ï¼Œå¦åˆ™å·²ä½¿ç”¨é‡è¦å‡å»å¯æ¼æ°´é‡ã€‚  è‹¥è¯·æ±‚æ•°é‡+ å·²ä½¿ç”¨é‡&lt; æ€»å®¹é‡ï¼Œåˆ™å…è®¸è¯·æ±‚é€šè¿‡ã€‚</li></ol><p>ä¸‹é¢ä»¥ å¹¶è¡Œé™æµç®—æ³•ä¸ºä¾‹ï¼Œè§£è¯»Luaå’ŒJavaä»£ç ï¼ŒæŸ¥çœ‹callback æ–¹æ³•çš„ä½¿ç”¨ã€‚ é€šè¿‡è§£è¯»ä»¤ç‰Œæ¡¶å’Œæ»‘åŠ¨çª—å£ç®—æ³•ä»£ç ï¼Œäº†è§£getKey()æ–¹æ³•çš„ä½¿ç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•"></a>å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•<a class="hash-link" href="#å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•" title="Direct link to heading">#</a></h3><p>é¦–å…ˆ<code>ConcurrentRateLimiterAlgorithm</code> çš„<code>getKeys()</code> æ–¹æ³•è¦†å†™äº†æŠ½è±¡ç±»ä¸­çš„æ¨¡æ¿æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = getKeyName() + &quot;.{&quot; + id + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String requestKey = UUIDUtils.getInstance().generateShortUuid();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, requestKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç¬¬äºŒä¸ªå…ƒç´  requestKey æ˜¯ä¸€ä¸ªlongå‹ä¸é‡å¤å€¼(ç”±ä¸€ä¸ªåˆ†å¸ƒå¼IDäº§ç”Ÿå™¨äº§ç”Ÿçš„ï¼Œé€’å¢ï¼Œæ¯”å½“å‰æ—¶é—´EpochSecondå°)ï¼Œ ç›¸åº”çš„concurrent_request_rate_limiter.luaçš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local capacity = tonumber(ARGV[2])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp = tonumber(ARGV[3])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local id = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œid å³æ˜¯å–å¾—ä¸Šé¢çš„getKeys()æ–¹æ³•äº§ç”Ÿçš„requestKeyï¼Œ ä¸€ä¸ªuuid.  åç»­çš„å¤„ç†å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local count = redis.call(&quot;zcard&quot;, key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if count &lt; capacity then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis.call(&quot;zadd&quot;, key, timestamp, id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count = count + 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed, count }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…ˆç”¨zcardå‘½ä»¤ç»Ÿè®¡redisä¸­keyå€¼æ‰€å¯¹åº”çš„æœ‰åºé›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œè‹¥å…ƒç´ æ€»æ•°countå°äºå®¹é‡ï¼Œåˆ™å…è®¸é€šè¿‡ï¼Œå¹¶ç”¨zadd key score memberæ–¹æ³•ï¼Œå‘keyæ‰€åœ¨çš„æœ‰åºé›†åˆä¸­ï¼Œæ·»åŠ ä¸€ä¸ªå…ƒç´ id, å…¶scoreä¸ºtimestamp.  åˆ™æ­¤æ—¶å…ƒç´ çš„æ€»ä¸ªæ•°countå®é™…ä¸ºcount+1.  </p><p>ä»¥ä¸Šçš„ä»£ç éƒ½æ˜¯åœ¨redisä¸­ä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œæ¥æ‰§è¡Œçš„ã€‚å½“åŒä¸€ä¸ªkey (ä¾‹å¦‚Ipä¸‹)æœ‰å¤§é‡å¹¶å‘è¯·æ±‚æ—¶ï¼Œredisè®°å½•çš„è¯¥ipçš„æœ‰åºé›†åˆçš„æ•°é‡countä¹Ÿåœ¨ä¸æ–­ç´¯åŠ ä¸­ã€‚å½“è¶…è¿‡å®¹é‡é™åˆ¶ï¼Œåˆ™ä¼šæ‹’ç»æœåŠ¡ã€‚</p><p>å¹¶å‘è¯·æ±‚æ•°é™æµç®—æ³•ä¸­ï¼Œè¦æ±‚å½“è¯·æ±‚è°ƒç”¨ç»“æŸæ—¶ï¼Œè¦é‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ï¼Œluaä»£ç ä¸­å¹¶æ²¡æœ‰åšè¿™ä¸ªå¤„ç†ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>ConcurrentRateLimiterAlgorithm</code>ç±»ä¸­çš„å›è°ƒå‡½æ•°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton.INST.get(ReactiveRedisTemplate.class).opsForZSet().remove(keys.get(0), keys.get(1)).subscribe();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œåšäº†ä¸€ä¸ªå¼‚æ­¥çš„è®¢é˜…å¤„ç†ï¼Œé€šè¿‡<code>ReactiveRedisTemplate</code>åˆ é™¤redisä¸­(key, id)çš„å…ƒç´ ï¼Œç­‰å¾…è°ƒç”¨ç»“æŸåï¼Œé‡Šæ”¾è¿™ä¸ªä¿¡å·ã€‚è¿™ä¸ªremoveçš„å¤„ç†ä¸èƒ½æ”¾åˆ°luaè„šæœ¬ä¸­æ‰§è¡Œï¼Œå¦åˆ™é€»è¾‘å°±æ˜¯é”™è¯¯çš„ã€‚è¿™ä¹Ÿæ­£æ˜¯<code>RateLimiterAlgorithm</code> SPI è®¾è®¡<code>callback</code>æ–¹æ³•çš„ç”¨æ„ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getkeys"></a>ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getKeys()<a class="hash-link" href="#ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getkeys" title="Direct link to heading">#</a></h3><p>å¯¹åº”çš„Lua ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local tokens_key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>çœç•¥è·å–å‚æ•°çš„ä»£ç </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local fill_time = capacity/rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local ttl = math.floor(fill_time*2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ—¶é—´çª—å£ttl å¤§æ¦‚æ˜¯ 2* å®¹é‡/é€Ÿç‡.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_tokens = tonumber(redis.call(&quot;get&quot;, tokens_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_tokens == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_tokens = capacity</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»æœ‰åºé›†åˆä¸­å–å¾—ä¸Šæ¬¡ä½¿ç”¨çš„token,å¦‚æœæ²¡æœ‰åˆ™last_tokens = å®¹é‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_refreshed = tonumber(redis.call(&quot;get&quot;, timestamp_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_refreshed == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_refreshed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»¥timestamp_keyä¸ºkey,ä»æœ‰åºé›†åˆä¸­å–å¾—ä¸Šæ¬¡åˆ·æ–°æ—¶é—´ï¼Œé»˜è®¤ä¸º0.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local delta = math.max(0, now-last_refreshed)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local filled_tokens = math.min(capacity, last_tokens+(delta*rate))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = filled_tokens &gt;= requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if allowed then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  new_tokens = filled_tokens - requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ—¶é—´é—´éš”*é€Ÿç‡åŒ€é€Ÿäº§ç”Ÿä»¤ç‰Œï¼Œè‹¥ä»¤ç‰Œæ•°é‡&gt;è¯·æ±‚æ•°é‡ï¼Œåˆ™allowed=1, å¹¶ä¸”æ›´æ–°ä»¤ç‰Œæ•°é‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, tokens_key, ttl, new_tokens)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, timestamp_key, ttl, now)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, new_tokens }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œnowæ˜¯ä¼ å…¥çš„å½“å‰æ—¶é—´(EpochSecond)ï¼Œè®¾ç½®<code>tokens_key</code>æ‰€å¯¹åº”çš„æœ‰åºé›†åˆçš„å€¼ä¸º <code>new_tokens</code>ï¼ˆå³æ–°ä»¤ç‰Œæ•°é‡) ï¼Œ è¿‡æœŸæ—¶é—´ä¸º<code>ttl</code>ã€‚ æ›´æ–°é›†åˆä¸­ï¼Œ<code>timestamp_key</code>çš„å€¼ä¸ºå½“å‰æ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´ä¸º<code>ttl</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨getkeysæ–¹æ³•"></a>æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨<code>getKeys</code>æ–¹æ³•<a class="hash-link" href="#æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨getkeysæ–¹æ³•" title="Direct link to heading">#</a></h3><p>åœ¨<code>SlidingWindowRateLimiterAlgorithm</code> çš„<code>getKeys()</code>åŒæ ·è¦†å†™äº†çˆ¶ç±»ï¼Œä»£ç ä¸<code>ConcurrentRateLimiterAlgorithm</code> æ–¹æ³•ä»£ç ä¸€è‡´ã€‚</p><p>å¦‚ä¸‹ä¸ºæ»‘åŠ¨çª—å£ç®—æ³•çš„Luaä»£ç ï¼Œçœç•¥äº†å…¶ä»–å‚æ•°çš„æ¥æ”¶ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_size = tonumber(capacity / rate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_time = 1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è®¾å®šçª—å£å¤§å°ä¸ºå®¹ç§¯/é€Ÿç‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_requested = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local exists_key = redis.call(&#x27;exists&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (exists_key == 1) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_requested = redis.call(&#x27;zcard&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è·å–å½“å‰key çš„åŸºæ•°</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local remain_request = capacity - last_requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (last_requested &lt; capacity) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;zadd&#x27;, tokens_key, now, timestamp_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è®¡ç®—å‰©ä½™å¯ç”¨é‡ = å®¹é‡ å‡å»å·²ä½¿ç”¨é‡ï¼Œè‹¥<code>last_requested</code> &lt; capacity ,åˆ™å…è®¸é€šè¿‡ï¼Œå¹¶ä¸”åœ¨<code>tokens_key</code>ä¸ºkeyçš„æœ‰åºé›†åˆä¸­ï¼Œå¢åŠ ä¸€ä¸ª å…ƒç´ ï¼ˆkey =<code>timestam_key</code>,value= <code>now</code>)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;zremrangebyscore&#x27;, tokens_key, 0, now - window_size / window_time)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;expire&#x27;, tokens_key, window_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, remain_request }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‰é¢å·²ç»è®¾å®š<code>window_time</code>=1, ç”¨Redisçš„ <code>zremrangebyscore</code>å‘½ä»¤ï¼Œç§»é™¤æœ‰åºé›†åˆä¸­ï¼Œscoreä¸º[0- å½“å‰æ—¶é—´-çª—å£å¤§å°]çš„å…ƒç´ ï¼Œå³ç§»åŠ¨ä¸€ä¸ªçª—å£å¤§å°ã€‚è®¾å®štokens_keyçš„è¿‡æœŸæ—¶é—´ä¸ºçª—å£å¤§å°ã€‚</p><p>åœ¨<code>AbstractRateLimiterAlgorithm</code>çš„æ¨¡æ¿æ–¹æ³•ä¸­ï¼Œ<code>getKeys(final String id)</code> ç»™å‡ºçš„ç¬¬äºŒä¸ªå€¼(ä»¥<code>secondKey</code>æŒ‡ä»£)ï¼Œæ˜¯æ‹¼æ¥äº†{id} (å³resolve key)çš„ä¸€ä¸ªå›ºå®šå­—ç¬¦ä¸²ã€‚ä»ä¸Šé¢ä¸‰ä¸ªç®—æ³•ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ï¼Œ<code>secondKey</code>åœ¨Luaä»£ç æ‰§è¡Œä¸­ä¼šæ›´æ–°ä¸ºæœ€æ–°çš„æ—¶é—´ï¼Œæ‰€ä»¥æ— æ‰€è°“ä¼ å…¥çš„å€¼ã€‚è€Œåœ¨å¹¶å‘é™æµç®—æ³•ä¸­ï¼Œä¼šä»¥æ­¤<code>secondKey</code>ä¸ºæ¡ä»¶ï¼Œåœ¨java <code>callback</code>æ–¹æ³•ä¸­ç§»é™¤å¯¹åº”çš„å…ƒç´ ã€‚è€Œåœ¨æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ï¼Œè¿™ä¸ª<code>secondKey</code>çš„å€¼ï¼Œä¼šä½œä¸ºä¸€ä¸ªæ–°å…ƒç´ çš„key, å¢åŠ åˆ°å½“å‰æœ‰åºé›†åˆä¸­ï¼Œå¹¶åœ¨åšçª—å£æ»‘åŠ¨ä¸­ï¼Œè¿‡æœŸçš„èµ„æ–™ä¼šè¢«åˆ é™¤æ‰ã€‚</p><p>æ€»ä¹‹ï¼Œå½“è®¾è®¡æ–°çš„é™æµç®—æ³•æ—¶ï¼Œè¦æ ¹æ®ç®—æ³•éœ€è¦ä»”ç»†è®¾è®¡<code>getKey()</code>æ–¹æ³•ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¦‚ä½•è°ƒç”¨-ratelimiter-spi"></a>å¦‚ä½•è°ƒç”¨ RateLimiter SPI<a class="hash-link" href="#å¦‚ä½•è°ƒç”¨-ratelimiter-spi" title="Direct link to heading">#</a></h2><p>åœ¨<code>RateLimiter</code> Plugä¸­çš„<code>doExecute()</code>æ–¹æ³•ä¸­ï¼Œä¼ å…¥çš„ä¸‰ä¸ªå‚æ•° exchange ä¸ºè¯·æ±‚çš„è¿æ¥ï¼Œ chain ä¸ºshenyuæ’ä»¶çš„è°ƒç”¨é“¾ï¼Œselector æ˜¯é€‰æ‹©å™¨ï¼Œruleæ˜¯ç³»ç»Ÿä¸­é…ç½®çš„è§„åˆ™å‚æ•°èµ„æ–™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RateLimiterHandle limiterHandle = RatelimiterRuleHandleCache.getInstance()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolverKey = Optional.ofNullable(limiterHandle.getKeyResolverName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(name -&gt; Optional.of(&quot;-&quot; + RateLimiterKeyResolverFactory.newInstance(name).resolve(exchange)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return redisRateLimiter.isAllowed(rule.getId() + resolverKey, limiterHandle)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(response -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!response.isAllowed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(ShenyuResultEnum.TOO_MANY_REQUESTS.getCode(), ShenyuResultEnum.TOO_MANY_REQUESTS.getMsg(), null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>1.é¦–å…ˆï¼Œä»ç¼“å­˜ä¸­ï¼Œå–å¾—ç³»ç»Ÿè®¾å®šçš„é™æµå‚æ•°<code>RateLimiterHandle</code>å®ä¾‹ <code>limiterHandle</code>.
2.æ ¹æ®nameæŒ‡å®šçš„Resolver è·å¾—è¯·æ±‚çš„è¿æ¥Keyä¿¡æ¯ï¼ˆå¦‚åœ°å€ç­‰).
3.è°ƒç”¨ RedisRateLimiterçš„ isAllowedæ–¹æ³•, è·å–è¿”å›å€¼åï¼Œ
4.è‹¥<code>isAllowd</code>=false,åšé”™è¯¯å¤„ç†
5.å¦‚æœ <code>isAllowed</code>=trueï¼Œreturn chain.execute(exchange)ï¼Œ å¯¹è¯¥è¯·æ±‚åšåç»­å¤„ç†ï¼Œä¼ é€’åˆ°è°ƒç”¨é“¾çš„ä¸‹ä¸€å…³ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>æ•´ä¸ª<code>RateLimiter</code> pluginæ¡†æ¶åŸºäºSpring WebFluxå¼€å‘ï¼Œç”¨redis å’Œluaè„šæœ¬åšé™æµè®¡æ•°åŠæ ¸å¿ƒé€»è¾‘å¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘åŠå¼¹æ€§æ‰©å±•ã€‚</p><ol><li><p><code>RateLimiter</code> <code>SPI</code> æä¾›äº†ä¸¤ä¸ª<code>SPI</code> æ¥å£ï¼Œé€šè¿‡åº”ç”¨é¢å‘æ¥å£è®¾è®¡åŠå„ç§è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥æ–¹ä¾¿çš„å¢åŠ æ–°çš„é™æµç®—æ³•ï¼Œä»¥åŠå„ç§æµé‡è§£æè§„åˆ™ã€‚</p></li><li><p>æä¾›äº†ä»¤ç‰Œæ¡¶ã€å¹¶å‘é€Ÿç‡é™æµã€æ»‘åŠ¨çª—å£ã€æ¼æ¡¶4ç§é™æµç®—æ³•ã€‚åœ¨è®¾è®¡ç®—æ³•å®ç°æ—¶ï¼Œéœ€è¦æ ¹æ®ç®—æ³•ç‰¹å¾è®¾è®¡KEYå€¼ï¼Œç”¨Luaè„šæœ¬å®ç°åœ¨redisä¸­è¦å¤„ç†çš„é€»è¾‘ï¼Œè®¾è®¡<code>callback()</code>æ–¹æ³•åšåç»­çš„æ•°æ®å¤„ç†ã€‚</p></li><li><p>å“åº”å¼ç¼–ç¨‹ï¼Œå®ç°è¿‡ç¨‹ç®€æ´é«˜æ•ˆã€‚</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/rate-limiter">rate limiter</a><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu å¯åŠ¨ç¤ºä¾‹</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-06-01T03:06:51.476Z">2023å¹´6æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡<a class="hash-link" href="#ç¯å¢ƒå‡†å¤‡" title="Direct link to heading">#</a></h3><ul><li>æœ¬åœ°æ­£ç¡®å®‰è£…JDK1.8+</li><li>æœ¬åœ°æ­£ç¡®å®‰è£…Git</li><li>æœ¬åœ°æ­£ç¡®å®‰è£…Maven</li><li>é€‰æ‹©ä¸€æ¬¾å¼€å‘å·¥å…·ï¼Œæ¯”å¦‚IDEA</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‹‰å–shenyuä»£ç "></a>æ‹‰å–ShenYuä»£ç <a class="hash-link" href="#æ‹‰å–shenyuä»£ç " title="Direct link to heading">#</a></h3><p>ä½¿ç”¨Gitæ‹‰å–ä»£ç </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/apache/incubator-shenyu.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¼–è¯‘ä»£ç "></a>ç¼–è¯‘ä»£ç <a class="hash-link" href="#ç¼–è¯‘ä»£ç " title="Direct link to heading">#</a></h3><p>ä½¿ç”¨Mavenè¿›è¡Œç¼–è¯‘</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> incubator-shenyu</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨ç½‘å…³æœåŠ¡"></a>å¯åŠ¨ç½‘å…³æœåŠ¡<a class="hash-link" href="#å¯åŠ¨ç½‘å…³æœåŠ¡" title="Direct link to heading">#</a></h3><p>ä½¿ç”¨å¼€å‘å·¥å…·ï¼Œä»¥IDEAä¸ºä¾‹ã€‚</p><p>å¯åŠ¨ <code>shenyu-admin</code> æ§åˆ¶å°ï¼ˆé»˜è®¤ä½¿ç”¨H2æ•°æ®åº“ï¼‰</p><p><img alt="start-demo-admin" src="/zh/assets/images/start-demo-admin-debdd1ee5e979a4892f26e4d54572ead.png"></p><p>å¯åŠ¨ <code>shenyu-bootstrap</code></p><p><img alt="start-demo-bootstrap" src="/zh/assets/images/start-demo-bootstrap-cafa4d22b0d69bb6ee82c01e7b45d239.png"></p><blockquote><p>åˆ°è¿™ä¸€æ­¥ï¼Œshenyuç½‘å…³å·²ç»å¯åŠ¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®adminæ§åˆ¶å°ï¼š<a href="http://localhost:9095/%EF%BC%8C%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E4%B8%BA%EF%BC%9Aadmin/123456" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨åº”ç”¨æœåŠ¡"></a>å¯åŠ¨åº”ç”¨æœåŠ¡<a class="hash-link" href="#å¯åŠ¨åº”ç”¨æœåŠ¡" title="Direct link to heading">#</a></h3><p>Apache ShenYuæä¾›äº†Httpã€Dubboã€SpringCloudç­‰åº”ç”¨æ¥å…¥shenyuç½‘å…³çš„æ ·ä¾‹ï¼Œä½äº <code>shenyu-example</code> æ¨¡å—ï¼Œè¿™é‡Œä»¥HttpæœåŠ¡ä¸ºä¾‹ã€‚</p><p>è‹¥ <code>shenyu-example</code> æœªè¢«IDEAæ ‡è®°ä¸ºMavené¡¹ç›®ï¼Œå¯ä»¥å³é”®ç‚¹å‡» <code>shenyu-example</code> ç›®å½•ä¸‹çš„ <code>pom.xml</code> æ–‡ä»¶ï¼Œå°†å…¶æ·»åŠ ä¸ºMavené¡¹ç›®ã€‚</p><p><img alt="start-demo-maven" src="/zh/assets/images/start-demo-maven-a52eeb99414c79d32a127312a5d22d6f.png"></p><p>å¯åŠ¨ <code>shenyu-examples-http</code>ã€‚</p><p><img alt="start-demo-examples-http" src="/zh/assets/images/start-demo-examples-http-a42235638d82a4be8aeefbb819d419be.png"></p><p>è¿™æ—¶ï¼Œ<code>shenyu-examples-http</code> ä¼šè‡ªåŠ¨æŠŠåŠ  <code>@ShenyuSpringMvcClient</code> æ³¨è§£çš„æ¥å£æ–¹æ³•ï¼Œä»¥åŠapplication.ymlä¸­çš„ç›¸å…³é…ç½®æ³¨å†Œåˆ°ç½‘å…³ã€‚æˆ‘ä»¬æ‰“å¼€adminæ§åˆ¶å°ï¼Œå³å¯åœ¨divideã€context_pathä¸­çœ‹åˆ°ç›¸å…³é…ç½®ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æµ‹è¯•httpè¯·æ±‚"></a>æµ‹è¯•Httpè¯·æ±‚<a class="hash-link" href="#æµ‹è¯•httpè¯·æ±‚" title="Direct link to heading">#</a></h3><p>ä¸‹é¢ä½¿ç”¨<code>postman</code>æ¨¡æ‹Ÿ<code>http</code>çš„æ–¹å¼æ¥è¯·æ±‚ä½ çš„<code>http</code>æœåŠ¡ï¼š</p><p><img alt="start-demo-post-http" src="/zh/assets/images/start-demo-post-http-a7e95883d3147d67e6080236d980d72b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä½¿ç”¨æ›´å¤šæ’ä»¶"></a>ä½¿ç”¨æ›´å¤šæ’ä»¶<a class="hash-link" href="#ä½¿ç”¨æ›´å¤šæ’ä»¶" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="/zh/blog/docs/index">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæ¥ä½¿ç”¨å…¶ä»–çš„æ’ä»¶ã€‚</p><p>è¿™é‡Œä»¥ä½¿ç”¨ param-mapping æ’ä»¶ä¸ºä¾‹ã€‚</p><p>åœ¨ <code>BasicConfig -&gt; Plugin</code> ç¼–è¾‘ param-mapping æ’ä»¶ï¼Œè®¾ç½® <code>status</code>ã€‚</p><p><img alt="start-demo-plugin" src="/zh/assets/images/start-demo-plugin-8525f3812e42bed70e28ce23540069b7.png"></p><p>åœ¨ <code>PluginList -&gt; http process</code> é…ç½®é€‰æ‹©å™¨å’Œè§„åˆ™ã€‚</p><p><img alt="start-demo-selector" src="/zh/assets/images/start-demo-selector-98b0b1ae460bdbed17edc40ab730a182.png"></p><p><img alt="start-demo-rules" src="/zh/assets/images/start-demo-rules-581013f9d7f0f9996b01aab85efcc8e7.png"></p><p>ç„¶åä½¿ç”¨ <code>postman</code> å‘ <code>/http/test/payment</code> å‘èµ·httpè¯·æ±‚ã€‚</p><p><img alt="start-demo-post-param-mapping" src="/zh/assets/images/start-demo-post-param-mapping-d5d632dc96eb1f0080c451820e8f7df4.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcdæ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-06-01T03:06:51.472Z">2023å¹´6æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>Etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>Etcd</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-å…³äºetcd"></a>1. å…³äºEtcd<a class="hash-link" href="#1-å…³äºetcd" title="Direct link to heading">#</a></h3><p><a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener noreferrer"><code>Etcd</code></a>æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒä¸ºå¤§å‹åˆ†å¸ƒå¼è®¡ç®—æä¾›åˆ†å¸ƒå¼é…ç½®æœåŠ¡ã€åŒæ­¥æœåŠ¡å’Œå‘½åæ³¨å†Œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-adminæ•°æ®åŒæ­¥"></a>2. Adminæ•°æ®åŒæ­¥<a class="hash-link" href="#2-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªå®é™…æ¡ˆä¾‹è¿›è¡Œæºç è¿½è¸ªï¼Œæ¯”å¦‚åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼š</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶æ•°æ®"></a>2.1 æ¥æ”¶æ•°æ®<a class="hash-link" href="#21-æ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>è¿›å…¥<code>SelectorController</code>ç±»ä¸­çš„<code>updateSelector()</code>æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ•°æ®çš„æ ¡éªŒï¼Œæ·»åŠ æˆ–æ›´æ–°æ•°æ®ï¼Œè¿”å›ç»“æœä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®å½“å‰é€‰æ‹©å™¨æ•°æ®id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæˆ–æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿”å›ç»“æœä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å¤„ç†æ•°æ®"></a>2.2 å¤„ç†æ•°æ®<a class="hash-link" href="#22-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>åœ¨<code>SelectorServiceImpl</code>ç±»ä¸­é€šè¿‡<code>createOrUpdate()</code>æ–¹æ³•å®Œæˆæ•°æ®çš„è½¬æ¢ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œæ›´æ–°<code>upstream</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è´Ÿè´£äº‹ä»¶å‘å¸ƒçš„eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ•°æ® DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­æ˜¯æ·»åŠ è¿˜æ˜¯æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨ä¸­çš„æ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æƒé™æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®ï¼Œå…ˆåˆ é™¤å†æ–°å¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>Service</code>ç±»å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼Œå³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸æ·±å…¥è¿½è¸ªäº†ã€‚å…³äºæ›´æ–°<code>upstream</code>æ“ä½œï¼Œæ”¾åˆ°åé¢å¯¹åº”çš„ç« èŠ‚ä¸­è¿›è¡Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨å‘å¸ƒäº‹ä»¶çš„æ“ä½œï¼Œå®ƒä¼šæ‰§è¡Œæ•°æ®åŒæ­¥ã€‚</p><p><code>publishEvent()</code>æ–¹æ³•çš„é€»è¾‘æ˜¯ï¼šæ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶ï¼Œæ„å»ºæ¡ä»¶æ•°æ®ï¼Œå‘å¸ƒå˜æ›´æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒå˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‘å¸ƒå˜æ›´æ•°æ®é€šè¿‡<code>eventPublisher.publishEvent()</code>å®Œæˆï¼Œè¿™ä¸ª<code>eventPublisher</code>å¯¹è±¡æ˜¯ä¸€ä¸ª<code>ApplicationEventPublisher</code>ç±»ï¼Œè¿™ä¸ªç±»çš„å…¨é™å®šåæ˜¯<code>org.springframework.context.ApplicationEventPublisher</code>ã€‚çœ‹åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬çŸ¥é“äº†å‘å¸ƒæ•°æ®æ˜¯é€šè¿‡<code>Spring</code>ç›¸å…³çš„åŠŸèƒ½æ¥å®Œæˆçš„ã€‚</p><blockquote><p>å…³äº<code>ApplicationEventPublisher</code>ï¼š</p><p>å½“æœ‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…è°ƒç”¨ <code>ApplicationEventPublisher</code> çš„ <code>publishEvent</code> æ–¹æ³•å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œ<code>Spring</code>å®¹å™¨å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onApplicationEvent</code> æ–¹æ³•æŠŠäº‹ä»¶å¯¹è±¡ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚è°ƒç”¨ <code>publishEvent</code>æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å®ç°æ¥å£ç”±å®¹å™¨æ³¨å…¥ <code>ApplicationEventPublisher</code> å¯¹è±¡ç„¶åè°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨å®¹å™¨çš„æ–¹æ³•ï¼Œä¸¤ç§æ–¹æ³•å‘å¸ƒäº‹ä»¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><ul><li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒäº‹ä»¶ï¼›</li><li><code>ApplicationEvent</code>ï¼š<code>Spring</code> äº‹ä»¶ï¼Œè®°å½•äº‹ä»¶æºã€æ—¶é—´å’Œæ•°æ®ï¼›</li><li><code>ApplicationListener</code>ï¼šäº‹ä»¶ç›‘å¬è€…ï¼Œè§‚å¯Ÿè€…ï¼›</li></ul></blockquote><p>åœ¨<code>Spring</code>çš„äº‹ä»¶å‘å¸ƒæœºåˆ¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œ</p><p>ä¸€ä¸ªæ˜¯å‘å¸ƒäº‹ä»¶çš„<code>ApplicationEventPublisher</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡æ„é€ å™¨æ³¨å…¥äº†ä¸€ä¸ª<code>eventPublisher</code>ã€‚</p><p>å¦ä¸€ä¸ªå¯¹è±¡æ˜¯<code>ApplicationEvent</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEvent</code>ç»§æ‰¿äº†å®ƒï¼Œè¡¨ç¤ºäº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åä¸€ä¸ªæ˜¯ <code>ApplicationListener</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEventDispatcher</code>ç±»å®ç°äº†è¯¥æ¥å£ï¼Œä½œä¸ºäº‹ä»¶çš„ç›‘å¬è€…ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-åˆ†å‘æ•°æ®"></a>2.3 åˆ†å‘æ•°æ®<a class="hash-link" href="#23-åˆ†å‘æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>å½“äº‹ä»¶å‘å¸ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿›å…¥åˆ°<code>DataChangedEventDispatcher</code>ç±»ä¸­çš„<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨<code>onApplicationEvent</code>æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œåˆ¤æ–­æ˜¯å“ªç§æ•°æ®ç±»å‹ï¼Œäº¤ç»™ç›¸åº”çš„æ•°æ®ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚</p><p><code>ShenYu</code>å°†æ‰€æœ‰æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æ˜¯äº”ç§ï¼šè®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯å’Œå…ƒæ•°æ®ã€‚</p><p>è¿™é‡Œçš„æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆ<code>DataChangedListener</code>ï¼‰ï¼Œå°±æ˜¯æ•°æ®åŒæ­¥ç­–ç•¥çš„æŠ½è±¡ï¼Œå®ƒçš„å…·ä½“å®ç°æœ‰ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>è¿™å‡ ä¸ªå®ç°ç±»å°±æ˜¯å½“å‰<code>ShenYu</code>æ”¯æŒçš„åŒæ­¥ç­–ç•¥ï¼š</p><ul><li><code>WebsocketDataChangedListener</code>ï¼šåŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ZookeeperDataChangedListener</code>ï¼šåŸºäº<code>zookeeper</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ConsulDataChangedListener</code>ï¼šåŸºäº<code>consul</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>EtcdDataDataChangedListener</code>ï¼šåŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>HttpLongPollingDataChangedListener</code>ï¼šåŸºäº<code>httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>NacosDataChangedListener</code>ï¼šåŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼›</li></ul><p>æ—¢ç„¶æœ‰è¿™ä¹ˆå¤šç§å®ç°ç­–ç•¥ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>å› ä¸ºæœ¬æ–‡æ˜¯åŸºäº<code>Etcd</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æï¼Œæ‰€ä»¥è¿™é‡Œä»¥<code>EtcdDataDataChangedListener</code>ä¸ºä¾‹ï¼Œåˆ†æå®ƒæ˜¯å¦‚ä½•è¢«åŠ è½½å¹¶å®ç°çš„ã€‚</p><p>é€šè¿‡æŸ¥çœ‹å¯¹<code>EtcdDataDataChangedListener</code>ç±»çš„è°ƒç”¨ï¼Œå¯ä»¥å‘ç°ï¼Œå®ƒæ˜¯åœ¨<code>DataSyncConfiguration</code>ç±»è¿›è¡Œé…ç½®çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * The type Etcd listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @EnableConfigurationProperties(EtcdProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class EtcdListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdClient etcdClient(final EtcdProperties etcdProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Client client = Client.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .endpoints(etcdProperties.getUrl())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdClient(client);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»ºEtcdæ•°æ®å˜æ›´ç›‘å¬å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdDataDataChangedListener(etcdClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»ºEtcdæ•°æ®åˆå§‹åŒ–ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient        the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the etcd data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(EtcdDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdDataInit(etcdClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªé…ç½®ç±»æ˜¯é€šè¿‡<code>SpringBoot</code>æ¡ä»¶è£…é…ç±»å®ç°çš„ã€‚åœ¨<code>EtcdListener</code>ç±»ä¸Šé¢æœ‰å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p><code>@Configuration</code>ï¼šé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ä¸Šä¸‹æ–‡ï¼›</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</code>ï¼šå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šé‡‡ç”¨<code>etcd</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     etcd:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties(EtcdProperties.class)</code>ï¼šå¯¼å…¥å¦ä¸€ä¸ªå±æ€§ç±»<code>EtcdProperties</code>ï¼Œ<code>EtcdProperties</code>ä¸­å„å±æ€§å¯¹åº”é…ç½®æ–‡ä»¶ä¸­ä»¥<code>shenyu.sync.etcd</code>ä½œä¸ºå‰ç¼€çš„å„å±æ€§ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.etcd&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†<code>shenyu.sync.etcd.url</code>å±æ€§æ—¶ï¼Œ<code>Admin</code>å°†é‡‡ç”¨<code>etcd</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ­¤æ—¶é…ç½®ç±»<code>EtcdListener</code>ä¼šç”Ÿæ•ˆï¼Œå¹¶ç”Ÿæˆ<code>EtcdClient</code>, <code>EtcdDataDataChangedListener</code>å’Œ<code>EtcdDataInit</code>ç±»å‹çš„beanã€‚</p><ul><li>ç”Ÿæˆ<code>EtcdClient</code>ç±»å‹çš„beanï¼Œ<code>etcdClient</code>ï¼Œè¿™ä¸ªbeanæ ¹æ®é…ç½®æ–‡ä»¶ï¼Œé…ç½®äº†ä¸etcdæœåŠ¡å™¨çš„è¿æ¥ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æ“ä½œetcdèŠ‚ç‚¹ã€‚</li><li>ç”Ÿæˆ<code>EtcdDataDataChangedListener</code>ç±»å‹çš„beanï¼Œ<code>etcdDataDataChangedListener</code>ï¼Œè¿™ä¸ªbeanå°†bean<code>etcdClient</code>ä½œä¸ºæˆå‘˜å˜é‡ï¼Œå½“ç›‘å¬åˆ°äº‹ä»¶æ—¶ï¼Œè¿›è¡Œå›è°ƒæ“ä½œï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥beanæ“ä½œetcdèŠ‚ç‚¹ã€‚</li><li>ç”Ÿæˆ<code>EtcdDataInit</code>ç±»å‹çš„beanï¼Œ<code>etcdDataInit</code>ï¼Œè¿™ä¸ªbeanå°†bean<code>etcdClient</code>å’Œbean<code>syncDataService</code>ä½œä¸ºæˆå‘˜å˜é‡ï¼Œä½¿ç”¨<code>etcdClient</code>æ ¹æ®etcdè·¯å¾„ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦æœªåˆå§‹åŒ–ï¼Œå½“æœªåˆå§‹åŒ–æ—¶ï¼Œå°†è°ƒç”¨syncDataServiceè¿›è¡Œåˆ·æ–°æ“ä½œï¼Œå°†åœ¨ä¸‹æ–‡è¯¦è¿°ã€‚
æ ¹æ®ä¸Šæ–‡æ‰€è¿°ï¼Œåœ¨äº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ä¸­ï¼Œå°±ä¼šåˆ°ç›¸åº”çš„<code>listener</code>ä¸­ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ˜¯å¯¹ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæ•°æ®åŒæ­¥é‡‡ç”¨çš„æ˜¯<code>etcd</code>ï¼Œæ‰€ä»¥ï¼Œä»£ç ä¼šè¿›å…¥åˆ°<code>EtcdDataDataChangedListener</code>è¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä¼šè¿›å…¥åˆ°EtcdDataDataChangedListenerè¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-etcdæ•°æ®å˜æ›´ç›‘å¬å™¨"></a>2.4 Etcdæ•°æ®å˜æ›´ç›‘å¬å™¨<a class="hash-link" href="#24-etcdæ•°æ®å˜æ›´ç›‘å¬å™¨" title="Direct link to heading">#</a></h4><ul><li><p>EtcdDataDataChangedListener.onSelectorChanged()</p><p>åœ¨<code>onSelectorChanged()</code>æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­æ“ä½œç±»å‹ï¼Œæ˜¯åˆ·æ–°åŒæ­¥è¿˜æ˜¯æ›´æ–°æˆ–åˆ›å»ºåŒæ­¥ã€‚æ ¹æ®å½“å‰é€‰æ‹©å™¨æ•°æ®ä¿¡æ¯åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨<code>etcd</code>ä¸­ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataDataChangedListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdDataDataChangedListener(final EtcdClient client) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€‰æ‹©å™¨ä¿¡æ¯å‘ç”Ÿæ”¹å˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // åˆ·æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcdClient.deleteEtcdPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // å‘ç”Ÿå˜æ›´çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé€‰æ‹©å™¨æ•°æ®çš„çœŸå®è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          etcdClient.delete(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //create or updateï¼Œåˆ›å»ºæˆ–æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™éƒ¨åˆ†æ˜¯æ ¸å¿ƒã€‚<code>changed</code>è¡¨ç¤ºéœ€æ›´æ–°çš„<code>SelectorData</code>åˆ—è¡¨ï¼Œ<code>eventType</code>è¡¨ç¤ºäº‹ä»¶ç±»å‹ã€‚å½“äº‹ä»¶ç±»å‹ä¸ºåˆ·æ–°<code>REFRESH</code>ï¼Œå¹¶ä¸”<code>SelectorData</code>æœ‰æ”¹åŠ¨æ—¶ï¼Œä¼šå…ˆå°†etcdä¸­è¯¥pluginä¸‹çš„selectorèŠ‚ç‚¹éƒ½å…ˆåˆ é™¤ã€‚æ³¨æ„è¿™é‡Œçš„æ¡ä»¶<code>SelectorData</code>æœ‰æ”¹åŠ¨æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ä¼šå‡ºç°æ²¡æœ‰æ”¹åŠ¨æ—¶è¿›è¡Œåˆ·æ–°ï¼Œå°†æ‰€æœ‰selectorèŠ‚ç‚¹éƒ½åˆ é™¤çš„bugã€‚
è·å–åˆ°selectorå¯¹åº”è·¯å¾„åï¼Œä¼šå¯¹èŠ‚ç‚¹è¿›è¡Œåˆ é™¤ã€åˆ›å»ºæˆ–æ›´æ–°ã€‚</p><p>åªè¦å°†å˜åŠ¨çš„æ•°æ®æ­£ç¡®å†™å…¥åˆ°<code>etcd</code>çš„èŠ‚ç‚¹ä¸Šï¼Œ<code>admin</code>è¿™è¾¹çš„æ“ä½œå°±æ‰§è¡Œå®Œæˆäº†ã€‚</p><p>åœ¨æˆ‘ä»¬å½“å‰çš„æ¡ˆä¾‹ä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼Œå°±ä¼šå¯¹å›¾ä¸­çš„ç‰¹å®šèŠ‚ç‚¹æ›´æ–°ã€‚</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>æˆ‘ä»¬ç”¨æ—¶åºå›¾å°†ä¸Šé¢çš„æ›´æ–°æµç¨‹ä¸²è”èµ·æ¥ã€‚</p><p><img src="/zh/assets/images/etcd-sync-sequence-admin-zh-d9ccd2c6bd5f9b3f135c5420b60fd403.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-ç½‘å…³æ•°æ®åŒæ­¥"></a>3. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#3-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>å‡è®¾<code>ShenYu</code>ç½‘å…³å·²ç»åœ¨æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨çš„æ•°æ®åŒæ­¥æ–¹å¼ä¹Ÿæ˜¯<code>etcd</code>ã€‚é‚£ä¹ˆå½“åœ¨<code>admin</code>ç«¯æ›´æ–°é€‰æ‹©å™¨æ•°æ®åï¼Œå¹¶ä¸”å‘<code>etcd</code>å‘é€äº†å˜æ›´çš„æ•°æ®ï¼Œé‚£ç½‘å…³æ˜¯å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†æ•°æ®çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­è¿›è¡Œæºç åˆ†æï¼Œä¸€æ¢ç©¶ç«Ÿã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-etcdclientæ¥æ”¶æ•°æ®"></a>3.1 EtcdClientæ¥æ”¶æ•°æ®<a class="hash-link" href="#31-etcdclientæ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>EtcdClient.watchDataChange()</li></ul><p>åœ¨ç½‘å…³ç«¯æœ‰ä¸€ä¸ª<code>EtcdSyncDataService</code>ç±»ï¼Œå®ƒé€šè¿‡<code>etcdClient</code>è®¢é˜…äº†æ•°æ®èŠ‚ç‚¹ï¼Œå½“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œå¯ä»¥æ„ŸçŸ¥åˆ°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //çœç•¥å…¶å®ƒä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      etcdClient.watchDataChange(path, (updateNode, updateValue) -&gt; cacheSelectorData(updateValue),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              this::unCacheSelectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //çœç•¥å…¶å®ƒä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Etcd</code>çš„<code>Watch</code>æœºåˆ¶ï¼Œä¼šç»™è®¢é˜…çš„å®¢æˆ·ç«¯å‘é€èŠ‚ç‚¹å˜æ›´é€šçŸ¥ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ›´æ–°é€‰æ‹©å™¨ä¿¡æ¯ï¼Œå°±ä¼šè¿›å…¥åˆ°<code>watchDataChange()</code>æ–¹æ³•ã€‚é€šè¿‡<code>cacheSelectorData()</code>å»å¤„ç†æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-å¤„ç†æ•°æ®"></a>3.2 å¤„ç†æ•°æ®<a class="hash-link" href="#32-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>EtcdSyncDataService.cacheSelectorData()</li></ul><p>ç»è¿‡åˆ¤ç©ºé€»è¾‘ä¹‹åï¼Œç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„æ“ä½œåˆäº¤ç»™äº†<code>PluginDataSubscriber</code>å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final SelectorData selectorData = GsonUtils.getInstance().fromJson(dataString, SelectorData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ª<code>CommonPluginDataSubscriber</code>å®ç°ç±»ï¼Œè´Ÿè´£å¤„ç†æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…"></a>3.3 é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…<a class="hash-link" href="#33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>å®ƒæ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>subscribeDataHandler()</code>æ–¹æ³•ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œæ›´å…·æ•°æ®ç±»å‹ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨æˆ–è§„åˆ™ï¼‰ï¼Œæ“ä½œç±»å‹ï¼ˆæ›´æ–°æˆ–åˆ é™¤ï¼‰ï¼Œå»æ‰§è¡Œä¸åŒé€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å¤„ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å¤„ç†å™¨ï¼Œå¤„ç†æ•°æ®çš„æ›´æ–°æˆ–åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜"></a>3.4 æ•°æ®ç¼“å­˜åˆ°å†…å­˜<a class="hash-link" href="#34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜" title="Direct link to heading">#</a></h4><p>é‚£ä¹ˆæ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³çš„å†…å­˜ä¸­ã€‚<code>BaseDataCache</code>æ˜¯æœ€ç»ˆç¼“å­˜æ•°æ®çš„ç±»ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ã€‚é€‰æ‹©å™¨æ•°æ®å°±å­˜åˆ°äº†<code>SELECTOR_MAP</code>è¿™ä¸ª<code>Map</code>ä¸­ã€‚åœ¨åç»­ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»è¿™é‡Œæ‹¿æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  å…¬å¼€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  ç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç¼“å­˜é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // æ›´æ–°æ“ä½œï¼Œå…ˆåˆ é™¤å†æ’å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // æ–°å¢æ“ä½œï¼Œç›´æ¥æ”¾åˆ°Mapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>äºŒæ˜¯å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†ã€‚  é€šè¿‡<code>idea</code>ç¼–è¾‘å™¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æ–°å¢ä¸€æ¡é€‰æ‹©å™¨åï¼Œæœ‰å¦‚ä¸‹çš„æ’ä»¶è¿˜æœ‰å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä¸å†å±•å¼€äº†ã€‚</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>ç»è¿‡ä»¥ä¸Šçš„æºç è¿½è¸ªï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼Œåœ¨<code>admin</code>ç«¯æ–°å¢æ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œå°±å°†<code>etcd</code>æ•°æ®åŒæ­¥çš„æµç¨‹åˆ†ææ¸…æ¥šäº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡æ—¶åºå›¾å°†ç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æµç¨‹ä¸²è”ä¸€ä¸‹ï¼š</p><p><img src="/zh/assets/images/etcd-sync-sequence-gateway-zh-708de62d8fafbb80c133b20247674db6.png"></p><p>æ•°æ®åŒæ­¥çš„æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œä¸ºäº†ä¸è®©åŒæ­¥æµç¨‹è¢«æ‰“æ–­ï¼Œåœ¨åˆ†æè¿‡ç¨‹ä¸­å°±å¿½ç•¥äº†å…¶ä»–é€»è¾‘ã€‚æˆ‘ä»¬è¿˜éœ€è¦åˆ†æ<code>Admin</code>åŒæ­¥æ•°æ®åˆå§‹åŒ–å’Œç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–çš„æµç¨‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–"></a>4. AdminåŒæ­¥æ•°æ®åˆå§‹åŒ–<a class="hash-link" href="#4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>å½“<code>admin</code>å¯åŠ¨åï¼Œä¼šå°†å½“å‰çš„æ•°æ®ä¿¡æ¯å…¨é‡åŒæ­¥åˆ°<code>etcd</code>ä¸­ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataInit.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void run(final String... args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!etcdClient.exists(pluginPath) &amp;&amp; !etcdClient.exists(authPath) &amp;&amp; !etcdClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.info(&quot;Init all data from database&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ¤æ–­<code>etcd</code>ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŒæ­¥ã€‚</p><p><code>EtcdDataInit</code>å®ç°äº†<code>CommandLineRunner</code>æ¥å£ã€‚å®ƒæ˜¯<code>springboot</code>æä¾›çš„æ¥å£ï¼Œä¼šåœ¨æ‰€æœ‰ <code>Spring Beans</code>åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ<code>run()</code>æ–¹æ³•ï¼Œå¸¸ç”¨äºé¡¹ç›®ä¸­åˆå§‹åŒ–çš„æ“ä½œã€‚</p><ul><li>SyncDataService.syncAll()</li></ul><p>ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œç„¶åè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œæ‰€æœ‰çš„è®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯å’Œå…ƒæ•°æ®ä¿¡æ¯ã€‚ä¸»è¦æ˜¯é€šè¿‡<code>eventPublisher</code>å‘å¸ƒåŒæ­¥äº‹ä»¶ã€‚è¿™é‡Œå°±è·Ÿå‰é¢æåˆ°çš„åŒæ­¥é€»è¾‘å°±åˆè”ç³»èµ·æ¥äº†ï¼Œ<code>eventPublisher</code>é€šè¿‡<code>publishEvent()</code>å‘å¸ƒå®Œäº‹ä»¶åï¼Œæœ‰<code>ApplicationListener</code>æ‰§è¡Œäº‹ä»¶å˜æ›´æ“ä½œï¼Œåœ¨<code>ShenYu</code>ä¸­å°±æ˜¯å‰é¢æåˆ°çš„<code>DataChangedEventDispatcher</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡æ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥å…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–"></a>5. ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–<a class="hash-link" href="#5-ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>ç½‘å…³è¿™è¾¹çš„æ•°æ®åŒæ­¥åˆå§‹åŒ–æ“ä½œä¸»è¦æ˜¯è®¢é˜…<code>etcd</code>ä¸­çš„èŠ‚ç‚¹ï¼Œå½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œæ”¶åˆ°å˜æ›´æ•°æ®ã€‚è¿™ä¾èµ–äº<code>Etcd</code>çš„<code>Watch</code>æœºåˆ¶ã€‚åœ¨<code>ShenYu</code>ä¸­ï¼Œè´Ÿè´£<code>etcd</code>æ•°æ®åŒæ­¥çš„æ˜¯<code>EtcdSyncDataService</code>ï¼Œä¹Ÿåœ¨å‰é¢æåˆ°è¿‡ã€‚</p><p><code>EtcdSyncDataService</code>çš„åŠŸèƒ½é€»è¾‘æ˜¯åœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­å®Œæˆçš„ï¼šå¯¹<code>etcd</code>ä¸­çš„<code>shenyu</code>æ•°æ®åŒæ­¥èŠ‚ç‚¹å®Œæˆè®¢é˜…ã€‚è¿™é‡Œçš„è®¢é˜…åˆ†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å·²ç»å­˜åœ¨çš„èŠ‚ç‚¹ä¸Šé¢æ•°æ®å‘ç”Ÿæ›´æ–°ï¼Œè¿™é€šè¿‡<code>etcdClient.watchDataChange()</code>æ–¹æ³•å®ç°ï¼›å¦ä¸€ç±»æ˜¯å½“å‰èŠ‚ç‚¹ä¸‹æœ‰æ–°å¢æˆ–åˆ é™¤èŠ‚ç‚¹ï¼Œå³å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼Œè¿™é€šè¿‡<code>etcdClient.watchChildChange()</code>æ–¹æ³•å®ç°ã€‚</p><p><code>EtcdSyncDataService</code>çš„ä»£ç æœ‰ç‚¹å¤šï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥æ’ä»¶æ•°æ®çš„è¯»å–å’Œè®¢é˜…è¿›è¡Œè¿½è¸ªï¼Œå…¶ä»–ç±»å‹çš„æ•°æ®æ“ä½œåŸç†æ˜¯ä¸€æ ·çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * etcd æ•°æ®åŒæ­¥æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå®Œæˆä»etcdä¸­è¯»å–æ•°æ®çš„æ“ä½œï¼Œå¹¶è®¢é˜…èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdSyncDataService(/*çœç•¥æ„é€ å‚æ•°*/) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ’ä»¶èŠ‚ç‚¹è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰€æœ‰æ’ä»¶èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; pluginZKs = etcdClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // è®¢é˜…å½“å‰æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…å­èŠ‚ç‚¹ï¼ˆæ–°å¢æˆ–åˆ é™¤ä¸€ä¸ªæ’ä»¶ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!updateNode.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éœ€è¦è®¢é˜…å­èŠ‚ç‚¹çš„æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherAll(updateNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰æ’ä»¶è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cachePluginData(etcdClient.get(pluginPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ’ä»¶èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void cachePluginData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional.ofNullable(pluginData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .flatMap(data -&gt; Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -&gt; e.onSubscribe(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å˜æ›´ï¼šæ›´æ–°æˆ–åˆ é™¤ï¼Œä¸¤ä¸ªlambdaè¡¨è¾¾å¼åˆ†åˆ«ä¸ºæ›´æ–°å’Œåˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataPath = buildRealPath(pluginPath, updatePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataStr = etcdClient.get(dataPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Optional.ofNullable(data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .ifPresent(d -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSubscribe(d)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, deleteNode -&gt; deletePlugin(pluginName));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸Šé¢çš„æºä»£ç ä¸­éƒ½ç»™å‡ºäº†æ³¨é‡Šï¼Œç›¸ä¿¡å¤§å®¶å¯ä»¥çœ‹æ˜ç™½ã€‚è®¢é˜…æ’ä»¶æ•°æ®çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><blockquote><ol><li>æ„é€ å½“å‰æ’ä»¶è·¯å¾„</li><li>è¯»å–etcdä¸Šå½“å‰èŠ‚ç‚¹æ•°æ®ï¼Œå¹¶ååºåˆ—åŒ–</li><li>æ’ä»¶æ•°æ®ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­</li><li>è®¢é˜…æ’ä»¶èŠ‚ç‚¹</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-æ€»ç»“"></a>6. æ€»ç»“<a class="hash-link" href="#6-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œå¯¹<code>etcd</code>çš„æ•°æ®åŒæ­¥åŸç†è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>åŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>watch</code>æœºåˆ¶å®ç°ï¼›</li><li>é€šè¿‡<code>Spring</code>å®Œæˆäº‹ä»¶å‘å¸ƒå’Œç›‘å¬ï¼›</li><li>é€šè¿‡æŠ½è±¡<code>DataChangedListener</code>æ¥å£ï¼Œæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼›</li><li>ä½¿ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼å®ç°ç¼“å­˜æ•°æ®ç±»<code>BaseDataCache</code>ï¼›</li><li>é€šè¿‡<code>SpringBoot</code>çš„æ¡ä»¶è£…é…å’Œ<code>starter</code>åŠ è½½æœºåˆ¶å®ç°é…ç½®ç±»çš„åŠ è½½ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/etcd">etcd</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-SPI">SPIè®¾è®¡å®ç°æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-09-12T00:00:00.000Z">2022å¹´9æœˆ12æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zjcscut/" target="_blank" rel="noopener noreferrer">Throwable</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="èƒŒæ™¯"></a>èƒŒæ™¯<a class="hash-link" href="#èƒŒæ™¯" title="Direct link to heading">#</a></h2><p>æœ€è¿‘ç ”è¯»<code>Apache</code>å¼€æºé¡¹ç›®<code>Shenyu</code>ç½‘å…³çš„æºç ï¼Œç½‘å…³çš„å¤šä¸ªæ ¸å¿ƒç»„ä»¶åŠ è½½éƒ½ç”¨åˆ°äº†<code>SPI</code>æ¨¡å—ã€‚æœ¬æ–‡å°±<code>Shenyu</code>ä¸­çš„<code>SPI</code>è®¾è®¡å’Œæºç å®ç°è¿›è¡Œåˆ†æã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»€ä¹ˆæ˜¯spi"></a>ä»€ä¹ˆæ˜¯SPI<a class="hash-link" href="#ä»€ä¹ˆæ˜¯spi" title="Direct link to heading">#</a></h2><p><code>SPI</code>å°±æ˜¯<code>Service Provider Interface</code>ï¼Œç›´è¯‘&quot;æœåŠ¡æä¾›æ–¹æ¥å£&quot;ï¼Œæ˜¯ä¸€ç§åŠ¨æ€çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå¯ä»¥åŸºäºæ¥å£è¿è¡Œæ—¶åŠ¨æ€åŠ è½½æ¥å£çš„å®ç°ç±»ï¼ˆä¹Ÿå°±æ˜¯æ¥å£ç¼–ç¨‹ + ç­–ç•¥æ¨¡å¼ + é…ç½®æ–‡ä»¶çš„ä¸€ç§å¼€å‘æ¨¡å¼ï¼‰ã€‚æœ€å¸¸è§çš„å°±æ˜¯<code>JDK</code>å†…ç½®çš„æ•°æ®åº“é©±åŠ¨æ¥å£<code>java.sql.Driver</code>ï¼Œä¸åŒçš„å‚å•†å¯ä»¥å¯¹è¯¥æ¥å£å®Œæˆä¸åŒçš„å®ç°ï¼Œä¾‹å¦‚<code>MySQL</code>ï¼ˆ<code>MySQL</code>é©±åŠ¨åŒ…ä¸­çš„<code>com.mysql.jdbc.Driver</code>ï¼‰ã€<code>PostgreSQL</code>ï¼ˆ<code>PostgreSQL</code>é©±åŠ¨åŒ…ä¸­çš„<code>org.postgresql.Driver</code>ï¼‰ç­‰ç­‰ã€‚</p><p><img alt="spi-jdk-api-diagram" src="/zh/assets/images/spi-jdk-api-diagram-667a15fab78f5b565111dd15c2abb352.png"></p><p><code>JDK</code>å†…ç½®çš„<code>SPI</code>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>åœ¨ç±»è·¯å¾„çš„<code>META-INF/services</code>ç›®å½•åˆ›å»ºä¸€ä¸ªä»¥æ¥å£å…¨é™å®šåç§°å‘½åçš„æ–‡ä»¶ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ª<code>properties</code>ï¼‰æ–‡ä»¶ï¼Œä¾‹å¦‚å‘½åä¸º<code>java.sql.Driver</code></li><li>è¯¥æ–‡ä»¶ä¸­å¯ä»¥æŒ‡å®šå…·ä½“çš„å®ç°ç±»ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªå®ç°ç±»çš„å…¨ç±»å‹é™å®šåä¸ºå•ç‹¬ä¸€è¡Œï¼Œä¾‹å¦‚<code>META-INF/services/java.sql.Driver</code>ä¸­ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># META-INF/services/java.sql.Driveræ–‡ä»¶å†…å®¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">com.mysql.jdbc.Driver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">org.postgresql.Driver</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æœ€åé€šè¿‡<code>java.util.ServiceLoader</code>å¯¹è¯¥æ–‡ä»¶è¿›è¡ŒåŠ è½½ï¼Œå®ä¾‹åŒ–æ¥å£çš„å¯¹åº”å®ç°ç±»ï¼ˆè¿™é‡Œéšå«äº†ä¸€ä¸ªçº¦å®šï¼Œ<strong>æ‰€æœ‰å®ç°ç±»å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°</strong>ï¼‰</li></ul><p>åº•å±‚çš„å®ç°æ¶‰åŠåˆ°ç±»åŠ è½½ã€åŒäº²å§”æ‰˜æ¨¡å‹ç­‰å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ã€‚åŸºäºè¿™ç§è®¾è®¡æ€è·¯ï¼Œå¾ˆå¤šä¸»æµæ¡†æ¶äº†è‡ªå®ç°äº†ä¸€å¥—<code>SPI</code>æ‰©å±•ï¼Œä¾‹å¦‚<code>Dubbo</code>çš„<code>SPI</code>æ‰©å±•æ¨¡å—ï¼Œå°±æ˜¯è¯»å–ç±»è·¯å¾„ä¸‹<code>META-INF/services/dubbo</code>ç›®å½•çš„æ–‡ä»¶å†…å®¹è¿›è¡Œç±»åŠ è½½ã€‚<code>Shenyu-SPI</code>æ¨¡å—ä¹Ÿæ˜¯æ²¿ç”¨ç±»ä¼¼çš„è®¾è®¡æ€è·¯ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-spiæºç åˆ†æ"></a>shenyu-spiæºç åˆ†æ<a class="hash-link" href="#shenyu-spiæºç åˆ†æ" title="Direct link to heading">#</a></h2><p><code>shenyu-spi</code>æ¨¡å—ååˆ†ç²¾ç‚¼ï¼Œä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">- shenyu-spi[module]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  - org.apache.shenyu.spi[package]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SpiExtensionFactory</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™äº›ç±»åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li><code>ExtensionFactory</code>ï¼š<code>SPI</code>åŠ è½½å™¨å·¥å‚ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª<code>SPI</code>ï¼Œç”¨äºåŸºäº<code>SPI</code>æœºåˆ¶åŠ è½½<code>ExtensionLoader</code>å®ä¾‹åŒæ—¶åŸºäº<code>ExtensionLoader</code>å®ä¾‹è·å–é»˜è®¤çš„<code>SPI</code>æ ‡è¯†æ¥å£å®ç°</li><li><code>SpiExtensionFactory</code>ï¼šå…¶å®å°±æ˜¯<code>ExtensionFactory</code>çš„ä¸€ä¸ªå®ç°ç±»</li><li><code>SPI</code>ï¼šæ ‡è¯†æ³¨è§£ï¼Œç”¨äºæ ‡è¯†<code>SPI</code>ï¼Œç”¨äºæ¥å£ä¸Š</li><li><code>Join</code>ï¼šæ ‡è¯†æ³¨è§£ï¼Œç”¨äºå®ç°ç±»ä¸Šï¼Œç”¨äºæ ‡è¯†è¯¥ç±»åŠ å…¥<code>SPI</code>ç³»ç»Ÿ</li><li><code>ExtensionLoader</code>ï¼š<code>SPI</code>åŠ è½½å™¨ï¼Œç±»æ¯”<code>java.util.ServiceLoader</code>ï¼Œç”¨äºåŠ è½½<code>SPI</code>ä¸­æ¥å£çš„å®ç°ç±»</li></ul><p>æ¥ä¸‹æ¥ç»†çœ‹æ¯ä¸ªç±»çš„æºç å®ç°ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi"></a>@SPI<a class="hash-link" href="#spi" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.SPI</code>ä½œä¸ºä¸€ä¸ªæ ‡è¯†æ³¨è§£ï¼Œä¸»è¦ç”¨äº<strong>æ¥å£</strong>ä¸Šï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä½¿ç”¨äº†<code>@SPI</code>çš„æ¥å£æ‰èƒ½è¢«<code>shenyu-spi</code>åŠ è½½ã€‚è¿™ä¸ªç±»çš„æ³¨é‡Šä¸­æè¿°åˆ°ï¼šæ‰€æœ‰<code>SPI</code>ç³»ç»Ÿç›¸å…³å‚è€ƒ<code>Apache Dubbo</code>çš„å®ç°ï¼ˆè¿™ä¸€ç‚¹æ¯”è¾ƒåˆæƒ…ç†ï¼Œå…¶å®<code>SPI</code>æ‰©å±•å·²ç»æ˜¯ä¸€ç§æˆç†Ÿçš„æ–¹æ¡ˆï¼Œå®ç°ä¸Šå¤§åŒå°å¼‚ï¼‰ã€‚è¯¥æ³¨è§£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface SPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Value string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the string</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å”¯ä¸€çš„<code>value()</code>æ–¹æ³•ç”¨äºæŒ‡å®šé»˜è®¤çš„<code>SPI</code>å®ç°ï¼ˆå¯é€‰çš„ï¼‰ï¼Œåæ–‡åœ¨å±•å¼€<code>ExtensionLoader</code>æ—¶å€™ä¼šè¯´æ˜ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="join"></a>@Join<a class="hash-link" href="#join" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.Join</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ ‡è¯†æ³¨è§£ï¼Œä¸»è¦ç”¨åœ¨ä½¿ç”¨äº†<code>@SPI</code>æ³¨è§£çš„æ¥å£çš„<strong>å®ç°ç±»</strong>ä¸Šï¼Œç”¨äºæ ‡è¯†è¯¥ç±»åŠ å…¥<code>SPI</code>ç³»ç»Ÿä¸­è€Œåå¯ä»¥è¢«<code>ExtensionLoader</code>åŠ è½½ã€‚è¯¥æ³¨è§£ä¹Ÿåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å”¯ä¸€çš„<code>order()</code>æ–¹æ³•ç”¨äºæŒ‡å®šå…·ä½“çš„é¡ºåºå·ï¼Œå•ä¸ªä½¿ç”¨äº†<code>@SPI</code>çš„æ¥å£å­˜åœ¨å¤šä¸ªä½¿ç”¨äº†<code>@Join</code>çš„å®ç°ç±»çš„æ—¶å€™ï¼Œè¿™ä¸ªé¡ºåºå·å°±ç¡®å®šäº†è¿™äº›å®ç°ç±»å®ä¾‹çš„æ’åºï¼ˆé¡ºåºå·å°çš„æ’åœ¨å‰é¢ï¼‰ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionloader"></a>ExtensionLoader<a class="hash-link" href="#extensionloader" title="Direct link to heading">#</a></h3><p><code>ExtensionLoader</code>å°±æ˜¯&quot;ç±»å‹æ‰©å±•åŠ è½½å™¨&quot;ï¼Œå°±æ˜¯æ•´ä¸ª<code>SPI</code>æ¨¡å—çš„æ ¸å¿ƒã€‚å…ˆçœ‹å…¶æˆå‘˜å±æ€§ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ExtensionLoader&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SLF4Jæ—¥å¿—å¥æŸ„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(ExtensionLoader.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SPIé…ç½®æ–‡ä»¶åŸºäºç±»è·¯å¾„ä¸‹çš„ç›¸å¯¹ç›®å½•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // @SPIæ ‡è¯†æ¥å£ç±»å‹ -&gt; ExtensionLoaderå®ä¾‹çš„ç¼“å­˜ =&gt; æ³¨æ„è¿™ä¸ªæ˜¯ä¸€ä¸ªå…¨å±€çš„é™æ€å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; LOADERS = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰@SPIæ ‡è¯†æ¥å£ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Class&lt;T&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ClassLoader classLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜¯ä¸€ä¸ªHashMapï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»åˆ«å -&gt; å®ç°ç±»ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Holder&lt;Map&lt;String, ClassEntity&gt;&gt; cachedClasses = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»å®ä¾‹çš„å€¼åŒ…è£…å™¨ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»åˆ«å -&gt; å€¼æŒæœ‰å™¨åŒ…è£…çš„å®ç°ç±»å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»å®ä¾‹ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»ç±»å‹ -&gt; å®ç°ç±»å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;Class&lt;?&gt;, Object&gt; joinInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜é»˜è®¤åç§°ï¼Œæ¥æºäº@SPIæ³¨è§£çš„value()æ–¹æ³•éç©ºç™½è¿”å›å€¼ï¼Œç”¨äºåŠ è½½é»˜è®¤çš„æ¥å£å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String cachedDefaultName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Holderæ¯”è¾ƒå™¨ï¼ŒæŒ‰ç…§Holderçš„orderé™åºï¼Œä¹Ÿå°±æ˜¯é¡ºåºå·å°çš„æ’åœ¨å‰é¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;Holder&lt;Object&gt;&gt; holderComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ClassEntityæ¯”è¾ƒå™¨ï¼ŒæŒ‰ç…§ClassEntityçš„orderé™åºï¼Œä¹Ÿå°±æ˜¯é¡ºåºå·å°çš„æ’åœ¨å‰é¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;ClassEntity&gt; classEntityComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æš‚æ—¶çœç•¥å…¶ä»–ä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å€¼æŒæœ‰å™¨ï¼Œç®€å•VOï¼Œç”¨æ¥å­˜å‚¨æ³›å‹å€¼å’Œå€¼åŠ è½½é¡ºåº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class Holder&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œçš„å€¼å¼•ç”¨æ˜¯volatileä¿®é¥°ï¼Œä¾¿äºæŸçº¿ç¨‹æ›´å˜å¦ä¸€çº¿ç¨‹é©¬ä¸Šè¯»åˆ°æœ€æ–°çš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private volatile T value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // çœç•¥setterå’Œgetterä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»å®ä½“ï¼Œä¸»è¦å­˜æ”¾åŠ è½½çš„å®ç°ç±»çš„ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final class ClassEntity {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åç§°ï¼Œè¿™é‡Œæ˜¯æŒ‡SPIå®ç°ç±»çš„åˆ«åï¼Œä¸æ˜¯ç±»å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŠ è½½é¡ºåºå·</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // SPIå®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Class&lt;?&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private ClassEntity(final String name, final Integer order, final Class&lt;?&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.name = name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.order = order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // çœç•¥setterå’Œgetterä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ†æå®Œæˆå‘˜å±æ€§ï¼Œä¸éš¾å‘ç°ä¸‹é¢å‡ ç‚¹ï¼š</p><ul><li><code>ExtensionLoader</code>ä¼šå­˜åœ¨ä¸€ä¸ªå…¨å±€çš„é™æ€ç¼“å­˜<code>LOADERS</code>ï¼Œç¼“å­˜å·²ç»åˆ›å»ºçš„<code>ExtensionLoader</code>å®ä¾‹ä»¥é˜²æ­¢é‡å¤åˆ›å»ºçš„æ€§èƒ½å¼€é”€</li><li>æ¯ä¸ª<code>@SPI</code>æ ‡è®°çš„æ¥å£å¦‚æœä½¿ç”¨<code>ExtensionLoader</code>è¿›è¡ŒåŠ è½½ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„<code>ExtensionLoader</code>å®ä¾‹</li><li><code>@SPI</code>æ ‡è®°çš„æ¥å£å¦‚æœæœ‰å¤šä¸ªå®ç°ï¼Œé‚£ä¹ˆæœ€ç»ˆè·å–åˆ°è¿™äº›å®ç°å®ä¾‹çš„æ—¶å€™æ˜¯æœ‰åºçš„</li></ul><p>æ¥ç€çœ‹å…¶æ„é€ å‡½æ•°å’Œé™æ€å·¥å‚æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ç§æœ‰æ„é€ å‡½æ•°ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private ExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆå‘˜å˜é‡clazzèµ‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆå‘˜å˜é‡classLoaderèµ‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.classLoader = cl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œå¯¹äºéExtensionFactoryæ¥å£ç±»å‹ä¼šæ‡’åŠ è½½ä¸€ä¸ªç”¨äºåŠ è½½ExtensionFactoryçš„ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Objects.equals(clazz, ExtensionFactory.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getExtensionClassesEntity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®ä¾‹åŒ–getExtensionLoaderï¼Œé™æ€å·¥å‚æ–¹æ³•ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‰ç¼€æ ¡éªŒï¼Œæ¥å£ç±»å‹å¿…é¡»éç©ºå¹¶ä¸”å¿…é¡»å­˜åœ¨@SPIæ³¨è§£ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ä¸­æ–­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Objects.requireNonNull(clazz, &quot;extension clazz is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isInterface()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) is not interface!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAnnotationPresent(SPI.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) without @&quot; + SPI.class + &quot; Annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»ç¼“å­˜LOADERSä¸­åŠ è½½ExtensionLoaderå®ä¾‹ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå…¸å‹çš„æ‡’åŠ è½½æ¨¡å¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExtensionLoader&lt;T&gt; extensionLoader = (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(extensionLoader)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extensionLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOADERS.putIfAbsent(clazz, new ExtensionLoader&lt;&gt;(clazz, cl));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®ä¾‹åŒ–getExtensionLoaderï¼Œé™æ€å·¥å‚æ–¹æ³•ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹ï¼Œä½¿ç”¨ExtensionLoaderç±»çš„ç±»åŠ è½½å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getExtensionLoader(clazz, ExtensionLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ExtensionLoader</code>ä½¿ç”¨äº†ç§æœ‰æ„é€ å™¨ï¼Œä½¿ç”¨äº†é™æ€å·¥å‚æ–¹æ³•å’Œæ‡’åŠ è½½æ¨¡å¼ã€‚åˆå§‹åŒ–<code>ExtensionLoader</code>å®Œæˆåå¹¶ä¸ä¼šè§¦å‘ç±»åŠ è½½å·¥ä½œï¼ŒçœŸæ­£çš„æ‰«æå’ŒåŠ è½½è¡Œä¸ºå»¶è¿Ÿåˆ°è°ƒç”¨<code>getJoin</code>ç³»åˆ—æ–¹æ³•æ‰§è¡Œï¼Œè¿™é‡Œæ‰«ç å’ŒåŠ è½½æ‰€æœ‰å®ç°ç±»ä¿¡æ¯çš„æ–¹æ³•è°ƒç”¨é“¾ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½æ‰€æœ‰æ‰©å±•ç±»ä¿¡æ¯ï¼Œè¿™é‡Œé‡‡ç”¨äº†DCLï¼ˆåŒé‡é”æ ¡éªŒï¼‰é˜²æ­¢å¹¶å‘åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; getExtensionClassesEntity() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜ä¸å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŠ é”åå†æ£€æŸ¥ä¸€æ¬¡ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedClasses) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æœ€ç»ˆç¡®è®¤ç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŠ è½½ï¼Œå¹¶ä¸”æ ‡è®°é¡ºåºå·ä¸º0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                classes = loadExtensionClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setValue(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setOrder(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½å½“å‰ExtensionLoaderä¸­clazzçš„æ‰€æœ‰SPIç³»ç»Ÿå†…çš„å®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; loadExtensionClass() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SPI annotation = clazz.getAnnotation(SPI.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(annotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œå°±æ˜¯å‰é¢æåˆ°ï¼Œå¦‚æœ@SPIæ³¨è§£çš„value()æ–¹æ³•éç©ºç™½è¿”å›å€¼ä¼šä½œä¸ºé»˜è®¤å®ç°çš„åˆ«å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¹Ÿå°±æ˜¯å¦‚æœåªä½¿ç”¨äº†@SPIï¼Œé‚£ä¹ˆå°±æ— æ³•è·å–é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœä½¿ç”¨äº†@SPI(&quot;foo&quot;)ï¼Œå¯ä»¥é€šè¿‡åˆ«åfooå»æ˜ å°„å’Œè·å–é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String value = annotation.value();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cachedDefaultName = value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆå§‹åŒ–ä¸€ä¸ªHashmapå®¹å™¨ç”¨äºå­˜å‚¨åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œè¿™ä¸ªå˜é‡ä¼šé€ä¼ åˆ°ä¸‹ä¸€ä¸ªæ–¹æ³•é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = new HashMap&lt;&gt;(16);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åŠ è½½ç›®å½•ä¸­çš„å±æ€§æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadDirectory(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½ç›®å½•ä¸­çš„å±æ€§æ–‡ä»¶ï¼Œå¹¶ä¸”åŠ è½½æ–‡ä»¶ä¸­çš„å®ç°ç±»ï¼Œç›®æ ‡ç›®å½•ï¼šMETA-INF/shenyu/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadDirectory(final Map&lt;String, ClassEntity&gt; classes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ–‡ä»¶å =&gt; META-INF/shenyu/$className</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = SHENYU_DIRECTORY + clazz.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½æ–‡ä»¶èµ„æºï¼Œå¦‚æœä¼ å…¥çš„ç±»åŠ è½½å™¨ä¸ºç©ºä¼šä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;URL&gt; urls = Objects.nonNull(this.classLoader) ? classLoader.getResources(fileName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : ClassLoader.getSystemResources(fileName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†è§£æçš„æ–‡ä»¶URLé›†åˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(urls)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (urls.hasMoreElements()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                URL url = urls.nextElement();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // é€šè¿‡æ–‡ä»¶URLåŠ è½½èµ„æº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                loadResources(classes, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.error(&quot;load extension class error {}&quot;, fileName, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½æ–‡ä»¶èµ„æºï¼Œè§£ææ–‡ä»¶å¹¶ä¸”åŠ è½½å®ç°ç±»å­˜å‚¨åˆ°classesä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadResources(final Map&lt;String, ClassEntity&gt; classes, final URL url) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¯»å–URLæ–‡ä»¶èµ„æºï¼ŒåŠ è½½åˆ°Propertiesä¸­ï¼Œæ¯è¡Œæ ¼å¼ä¸ºname=classPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (InputStream inputStream = url.openStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.load(inputStream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.forEach((k, v) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String name = (String) k;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String classPath = (String) v;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(name) &amp;&amp; StringUtils.isNotBlank(classPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // åŸºäºnameå’ŒclassPathè¿›è¡Œç±»åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    loadClass(classes, name, classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (ClassNotFoundException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºnameï¼ˆåˆ«åï¼‰å’ŒclassPathï¼ˆç±»å…¨é™å®šåç§°ï¼‰è¿›è¡Œç±»åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadClass(final Map&lt;String, ClassEntity&gt; classes,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String name, final String classPath) throws ClassNotFoundException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»åˆå§‹åŒ–ï¼Œå¹¶ä¸”ç¡®å®šå®ç°ç±»å¿…é¡»æ˜¯å½“å‰@SPIæ³¨è§£æ ‡è¯†æ¥å£çš„å­ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; subClass = Objects.nonNull(this.classLoader) ? Class.forName(classPath, true, this.classLoader) : Class.forName(classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAssignableFrom(subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; subtype is not of &quot; + clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å®ç°ç±»å¿…é¡»å­˜åœ¨æ³¨è§£@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!subClass.isAnnotationPresent(Join.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; without @&quot; + Join.class + &quot; annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨åŒæ ·åˆ«åçš„å®ç°ç±»æ‰è¿›è¡Œç¼“å­˜ï¼Œå·²ç»å­˜åœ¨åˆ™æ ¡éªŒæ—§çš„ç±»å‹å’Œå½“å‰å®ç°ç±»å‹æ˜¯å¦ä¸€è‡´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity oldClassEntity = classes.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(oldClassEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºç±»ä¿¡æ¯å®ä½“ä¿å­˜åˆ«åã€é¡ºåºå·å’Œå®ç°ç±»å¹¶ä¸”ç¼“å­˜ï¼Œæ˜ å°„å…³ç³»ï¼šåˆ«å -&gt; ç±»ä¿¡æ¯å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Join joinAnnotation = subClass.getAnnotation(Join.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassEntity classEntity = new ClassEntity(name, joinAnnotation.order(), subClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classes.put(name, classEntity);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (!Objects.equals(oldClassEntity.getClazz(), subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,Duplicate class &quot; + clazz.getName() + &quot; name &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                + name + &quot; on &quot; + oldClassEntity.getClazz().getName() + &quot; or &quot; + subClass.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡æ–¹æ³•é“¾<code>getExtensionClassesEntity -&gt; loadExtensionClass -&gt; loadDirectory -&gt; loadResources -&gt; loadClass</code>æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªåˆ«å<code>-&gt;</code>å®ç°ç±»ä¿¡æ¯çš„æ˜ å°„ï¼Œç”¨äºåç»­çš„å®ä¾‹åŒ–ï¼Œè§<code>getJoin()</code>æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºåˆ«åè·å–å®ç°ç±»å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public T getJoin(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ«åå¿…é¡»ä¸ºéç©ºç™½å­—ç¬¦ä¸²</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(name)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NullPointerException(&quot;get join name is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œä¹Ÿä½¿ç”¨DCLå»cachedInstancesç¼“å­˜ä¸­å–åˆ«åå¯¹åº”çš„å€¼æŒæœ‰å™¨ï¼Œå€¼æŒæœ‰å™¨ä¸ºç©ºåˆ™åˆ›å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;Object&gt; objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(objectHolder)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedInstances.putIfAbsent(name, new Holder&lt;&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedInstances) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŠ é”åå†æ¬¡åˆ¤æ–­å€¼æŒæœ‰å™¨ä¸­çš„å€¼æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„æ—¶å€™åˆ™è¿›è¡Œå®ç°ç±»å®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Holder&lt;T&gt; pair = createExtension(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                value = pair.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                int order = pair.getOrder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å®ä¾‹åŒ–å®Œæˆåæ›´æ–°å€¼æŒæœ‰å™¨ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setValue(value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setOrder(order);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (T) value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºåˆ«åæœç´¢å·²ç»åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œå¹¶ä¸”å®ä¾‹åŒ–å¯¹åº”çš„å®ç°ç±»è¿›è¡Œå€¼åŒ…è£…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Holder&lt;T&gt; createExtension(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åŠ è½½è¯¥@SPIæ ‡è¯†æ¥å£çš„æ‰€æœ‰å®ç°ç±»ä¿¡æ¯å¹¶ä¸”è·å–å¯¹åº”åˆ«åçš„å®ç°ç±»ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity classEntity = getExtensionClassesEntity().get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;name is error&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; aClass = classEntity.getClazz();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœå®ç°ç±»å®ä¾‹ç¼“å­˜ä¸­å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥å°è£…ä¸ºå€¼åŒ…è£…å™¨è¿”å›ï¼Œå¦åˆ™è¿›è¡Œå®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(o)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åå°„å®ä¾‹åŒ–å¹¶ä¸”ç¼“å­˜è¯¥å®ç°ç±»å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            joinInstances.putIfAbsent(aClass, aClass.newInstance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InstantiationException | IllegalAccessException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Extension instance(name: &quot; + name + &quot;, class: &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + aClass + &quot;)  could not be instantiated: &quot; + e.getMessage(), e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;T&gt; objectHolder = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setOrder(classEntity.getOrder());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setValue((T) o);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return objectHolder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»<code>createExtension()</code>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯ä½¿ç”¨åå°„æ–¹å¼å®ä¾‹åŒ–å®ç°ç±»ï¼Œåå°„æ–¹æ³•<code>newInstance()</code>è¦æ±‚è¯¥ç±»å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°ï¼Œå› ä¸ºè¿™é‡Œæœ‰ä¸€ç‚¹éšå«çš„çº¦å®šï¼š<code>SPI</code>å®ç°ç±»<strong>å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°</strong>ï¼Œå¦åˆ™ä¼šå®ä¾‹åŒ–å¤±è´¥ã€‚å‰©ä½™çš„<code>getDefaultJoin()</code>å’Œ<code>getJoins()</code>æ˜¯åŸºäº<code>getJoin()</code>æ–¹æ³•è¿›è¡Œæ‰©å±•ï¼ŒåŠŸèƒ½å¹¶ä¸å¤æ‚ï¼Œè¿™é‡Œå°±ä¸å±•å¼€åˆ†æäº†ã€‚å¦å¤–ï¼Œåœ¨<code>getJoin()</code>æ–¹æ³•ç”¨åˆ°äº†å¤šçº§ç¼“å­˜ï¼š</p><ul><li><code>cachedInstances</code>ï¼šé€šè¿‡åˆ«åå°±å¯ä»¥æœç´¢åˆ°å¯¹åº”çš„å®ç°ç±»å®ä¾‹</li><li><code>joinInstances</code>ï¼šåˆ«åæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™åŠ è½½æ‰€æœ‰å®ç°ç±»ä¿¡æ¯ï¼Œç„¶åé€šè¿‡åˆ«åå®šä½å®ç°ç±»ç±»å‹ï¼Œå†é€šè¿‡å®ç°ç±»ç±»å‹æŸ¥æ‰¾æˆ–è€…åˆ›å»ºå¹¶ç¼“å­˜å®ç°ç±»å®ä¾‹åæ›´æ–°<code>cachedInstances</code>ç¼“å­˜</li></ul><p>åˆ°æ­¤ï¼Œ<code>ExtensionLoader</code>çš„æºç åˆ†æå®Œæ¯•ã€‚è¿™é‡Œå†é€šè¿‡ä¸€ä¸ª<code>ExtensionLoader</code>å®ä¾‹æˆå‘˜å±æ€§å†…å­˜å¸ƒå±€å›¾å¯ä»¥åŠ æ·±ç†è§£ï¼š</p><p><img alt="spi-attr-memory-debug" src="/zh/assets/images/spi-attr-memory-debug-fbcf742eb342ba1aa47e9395bf8ffc0c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionfactory"></a>ExtensionFactory<a class="hash-link" href="#extensionfactory" title="Direct link to heading">#</a></h3><p><code>ExtensionFactory</code>æ˜¯å·¥å‚æ¨¡å¼é‡Œé¢çš„å·¥å‚æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸€ä¸ªè·å–<code>SPI</code>å®ç°ï¼ˆ<strong>é»˜è®¤å®ç°ï¼Œå”¯ä¸€</strong>ï¼‰å®ä¾‹çš„æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI(&quot;spi&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets Extension.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt;   the type parameter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param key   æ­¤å‚æ•°æš‚æ—¶æ²¡æœ‰ä½¿ç”¨ï¼ŒçŒœæµ‹æ˜¯é¢„ç•™ç”¨äºæ˜ å°„@SPIçš„value()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param clazz @SPIæ ‡è¯†çš„æ¥å£ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the extension</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getExtension(String key, Class&lt;T&gt; clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥ç€çœ‹å…¶å®ç°ç±»<code>SpiExtensionFactory</code>çš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpiExtensionFactory implements ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; T getExtension(final String key, final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Optional.ofNullable(clazz)   // å…¥å‚clazzéç©º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Class::isInterface)  // å…¥å‚clazzå¿…é¡»æ˜¯æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(cls -&gt; cls.isAnnotationPresent(SPI.class))  // å…¥å‚clazzå¿…é¡»è¢«@SPIæ ‡è¯†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getExtensionLoader)  // åŸºäºclazzè¿™ä¸ªæ¥å£ç±»å‹å®ä¾‹åŒ–ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getDefaultJoin)  // è·å–è¯¥@SPIæ ‡è¯†æ¥å£çš„é»˜è®¤å®ç°ï¼Œä¸å­˜åœ¨åˆ™è¿”å›NULL</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š<code>ExtensionFactory</code>æœ¬èº«ä¹Ÿæ˜¯<code>SPI</code>ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ä½¿ç”¨<code>ExtensionFactory</code>çš„æ—¶å€™å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = new SpiExtensionFactory();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¹Ÿå¯ä»¥åŸºäº<code>ExtensionLoader</code>è¿›è¡ŒåŠ è½½ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># åœ¨ç±»è·¯å¾„META-INF/services/shenyuç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªå±æ€§æ–‡ä»¶org.apache.shenyu.spi.ExtensionFactoryï¼Œå†…å®¹æ˜¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">spi=org.apache.shenyu.spi.SpiExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># ç„¶ååŸºäºExtensionLoaderè¿›è¡ŒåŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getDefaultJoin();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¾—åˆ°<code>ExtensionFactory</code>å®ä¾‹åå°±å¯ä»¥åŸºäº<code>@SPI</code>æ¥å£åŠ è½½å…¶é»˜è®¤å®ç°ç±»çš„å®ä¾‹ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‰©å±•å’Œå»ºè®®"></a>æ‰©å±•å’Œå»ºè®®<a class="hash-link" href="#æ‰©å±•å’Œå»ºè®®" title="Direct link to heading">#</a></h2><p>ä¸‹é¢æ˜¯ä¸ªäººçš„ä¸€äº›è§è§£ã€‚ç›®å‰æ¥çœ‹ï¼Œ<code>Shenyu</code>ä¸­çš„<code>SPI</code>æ¨¡å—åŠŸèƒ½æ˜¯å®Œå¤‡çš„ï¼Œå»ºè®®è€ƒè™‘å¼•å…¥ä¸¤ä¸ªå¸¸ç”¨çš„åŠŸèƒ½ï¼š</p><ul><li>å¯ä»¥åœ¨<code>Join</code>æ³¨è§£ä¸­æ·»åŠ å±æ€§æ ‡è®°<code>SPI</code>æ¥å£å®ç°ç±»ç”Ÿæˆçš„å®ä¾‹æ˜¯å•ä¾‹è¿˜æ˜¯å…¨æ–°å®ä¾‹ï¼Œç±»ä¼¼äº<code>Spring</code>ä¸­çš„<code>Scope</code>å£°æ˜ï¼ˆ<code>singleton</code>æˆ–è€…<code>prototype</code>ï¼‰é‚£æ ·ï¼Œä¾‹å¦‚ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The join class instance should be singleton or not</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true or false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isSingleton() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>å¯é€‰åœ°</strong>è®©<code>SPI</code>çš„å®ç°ç±»å®ç°ä¸€ä¸ªåˆå§‹åŒ–å™¨æ¥å£ï¼Œåœ¨è¯¥å®ç°ç±»å®ä¾‹åŒ–åå›è°ƒåˆå§‹åŒ–å™¨æ¥å£æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionInitializer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void init();  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * demo</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface JdbcSPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getClassName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MysqlSPI implements JdbcSPI, ExtensionInitializer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // callback when MysqlSPI instance init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getClassName() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;mysql&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦‚æœæ·»åŠ äº†è¿™ä¸¤ç‚¹ï¼Œèƒ½å¤Ÿæ»¡è¶³å¾ˆå¤šç°å®åœºæ™¯çš„éœ€æ±‚ã€‚å¦å¤–ï¼Œ<code>ExtensionLoader</code>ä¸­çš„ä¸¤å¤„æ¯”è¾ƒå™¨æˆå‘˜å˜é‡å¯ä»¥è¿›è¡Œä»£ç ç²¾ç®€ï¼Œä¾‹å¦‚å¯¹<code>classEntityComparator</code>è€Œè¨€ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final Comparator&lt;ClassEntity&gt; classEntityComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¯ä»¥ç²¾ç®€ä¸ºComparatoræä¾›çš„é™æ€å·¥å‚æ–¹æ³•å’Œæ–¹æ³•å¼•ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private final Comparator&lt;ClassEntity&gt; classEntityComparator = Comparator.comparing(ClassEntity::getOrder);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å°ç»“"></a>å°ç»“<a class="hash-link" href="#å°ç»“" title="Direct link to heading">#</a></h2><p>åŸºäº<code>Java</code>åŸç”Ÿ<code>SPI</code>è®¾è®¡æ€è·¯ä¸Šè®¾è®¡å‡ºæ¥çš„<code>SPI</code>æ¡†æ¶å…·å¤‡äº†æ¾è€¦åˆã€é«˜æ˜“ç”¨æ€§å’Œé«˜æ‰©å±•æ€§çš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”æ·»åŠ äº†åŠ è½½å®ä¾‹ç¼“å­˜ã€å¹¶å‘å®‰å…¨ç­‰ç‰¹æ€§ï¼Œå¡«è¡¥äº†åŸç”Ÿ<code>JDK</code>ä¸­<code>SPI</code>çš„ä¸€äº›ç¼ºé™·ï¼Œ<code>Shenyu</code>çš„<code>SPI</code>æ¨¡å—ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ­£æ˜¯ç”±äºæ­¤å¼ºå¤§çš„<code>SPI</code>æ¨¡å—çš„å­˜åœ¨ï¼Œ<code>Shenyu</code>ä¸­çš„å…¶ä»–æ¨¡å—å¦‚<code>Plugin</code>æ¨¡å—å¯ä»¥å®ç°å¿«é€Ÿæ’æ‹”å¼é…ç½®ï¼Œè®©åŠ è½½ä¸€ä¸ªå…¨æ–°å¼€å‘çš„æ’ä»¶å®ä¾‹å˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div></div>
<script src="/zh/assets/js/runtime~main.43910f1b.js"></script>
<script src="/zh/assets/js/main.2c045cdb.js"></script>
</body>
</html>