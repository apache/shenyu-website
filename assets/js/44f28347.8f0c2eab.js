"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[17563],{20976:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>d,frontMatter:()=>s,metadata:()=>a,toc:()=>o});var r=i(74848),l=i(28453);const s={title:"Custom Plugin",keywords:["Custom Plugin"],description:"plugins"},t=void 0,a={id:"developer/custom-plugin",title:"Custom Plugin",description:"plugins",source:"@site/versioned_docs/version-2.4.0/developer/custom-plugin.md",sourceDirName:"developer",slug:"/developer/custom-plugin",permalink:"/docs/2.4.0/developer/custom-plugin",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/shenyu-website/edit/main/versioned_docs/version-2.4.0/developer/custom-plugin.md",tags:[],version:"2.4.0",frontMatter:{title:"Custom Plugin",keywords:["Custom Plugin"],description:"plugins"},sidebar:"tutorialSidebar",previous:{title:"Fetching Correct IP Address And Host",permalink:"/docs/2.4.0/developer/custom-parsing-ip-and-host"},next:{title:"Custom Response",permalink:"/docs/2.4.0/developer/custom-result"}},c={},o=[{value:"Description",id:"description",level:2},{value:"Single Responsibility Plugins",id:"single-responsibility-plugins",level:2},{value:"Matching Traffic Processing Plugin",id:"matching-traffic-processing-plugin",level:2},{value:"Subscribe your plugin data and do customized jobs",id:"subscribe-your-plugin-data-and-do-customized-jobs",level:2}];function u(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"description",children:"Description"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Plugins are core executors of ",(0,r.jsx)(n.code,{children:"Apache ShenYu"})," gateway. Every plugin handles matched requests when enabled."]}),"\n",(0,r.jsxs)(n.li,{children:["There are two kinds of plugins in the ",(0,r.jsx)(n.code,{children:"Apache ShenYu"})," gateway.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The first type is a chain with single responsibility, and can not custom filtering of traffic."}),"\n",(0,r.jsx)(n.li,{children:"The other one can do its own chain of responsibility for matched traffic."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["You could reference from ",(0,r.jsx)(n.a,{href:"https://github.com/apache/incubator-shenyu/tree/v2.4.0/shenyu-plugin",children:"shenyu-plugin"})," module and develop plugins by yourself. Please fire pull requests of your wonderful plugins without hesitate."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"single-responsibility-plugins",children:"Single Responsibility Plugins"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Add following dependency:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.apache.shenyu</groupId>\n    <artifactId>shenyu-plugin-api</artifactId>\n    <version>${project.version}</version>\n</dependency>\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Declare a new class named ",(0,r.jsx)(n.code,{children:"MyShenyuPlugin"})," and implements ",(0,r.jsx)(n.code,{children:"org.apache.shenyu.plugin.api.ShenyuPlugin"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'public interface ShenyuPlugin {\n\n    /**\n     * Process the Web request and (optionally) delegate to the next\n     * {@code WebFilter} through the given {@link ShenyuPluginChain}.\n     *\n     * @param exchange the current server exchange\n     * @param chain    provides a way to delegate to the next filter\n     * @return {@code Mono<Void>} to indicate when request processing is complete\n     */\n    Mono<Void> execute(ServerWebExchange exchange, ShenyuPluginChain chain);\n\n    /**\n     * return plugin order .\n     * This attribute To determine the plugin execution order in the same type plugin.\n     *\n     * @return int order\n     */\n    int getOrder();\n\n    /**\n     * acquire plugin name.\n     * this is plugin name define you must offer the right name.\n     * if you impl AbstractShenyuPlugin this attribute not use.\n     *\n     * @return plugin name.\n     */\n    default String named() {\n        return "";\n    }\n\n    /**\n     * plugin is execute.\n     * if return true this plugin can not execute.\n     *\n     * @param exchange the current server exchange\n     * @return default false.\n     */\n    default Boolean skip(ServerWebExchange exchange) {\n        return false;\n    }\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"Detailed instruction of interface methods:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"execute()"})," core method, you can do any task here freely."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getOrder()"})," get the order of current plugin."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"named()"})," acquire the name of specific plugin."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"skip()"})," determines whether this plugin should be skipped under certain conditions."]}),"\n",(0,r.jsxs)(n.li,{children:["Register plugin in ",(0,r.jsx)(n.code,{children:"Spring"})," as a ",(0,r.jsx)(n.code,{children:"Bean"}),", or simply apply ",(0,r.jsx)(n.code,{children:"@Component"})," in implementation class."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    @Bean\n    public ShenyuPlugin myShenyuPlugin() {\n        return new MyShenyuPlugin();\n    }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"matching-traffic-processing-plugin",children:"Matching Traffic Processing Plugin"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Introduce the following dependency:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:" <dependency>\n        <groupId>org.apache.shenyu</groupId>\n        <artifactId>shenyu-plugin-base</artifactId>\n        <version>${project.version}</version>\n  </dependency>\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Add a new class ",(0,r.jsx)(n.code,{children:"CustomPlugin"}),", inherit from ",(0,r.jsx)(n.code,{children:"org.apache.shenyu.plugin.base.AbstractShenyuPlugin"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"examples down below:"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'/**\n * This is your custom plugin.\n * He is running in after before plugin, implement your own functionality.\n * extends AbstractShenyuPlugin so you must user shenyu-admin And add related plug-in development.\n *\n * @author xiaoyu(Myth)\n */\npublic class CustomPlugin extends AbstractShenyuPlugin {\n\n    /**\n     * return plugin order .\n     * The same plugin he executes in the same order.\n     *\n     * @return int\n     */\n    @Override\n    public int getOrder() {\n        return 0;\n    }\n\n    /**\n     * acquire plugin name.\n     * return you custom plugin name.\n     * It must be the same name as the plug-in you added in the admin background.\n     *\n     * @return plugin name.\n     */\n    @Override\n    public String named() {\n        return "shenyu";\n    }\n\n    /**\n     * plugin is execute.\n     * Do I need to skip.\n     * if you need skip return true.\n     *\n     * @param exchange the current server exchange\n     * @return default false.\n     */\n    @Override\n    public Boolean skip(final ServerWebExchange exchange) {\n        return false;\n    }\n\n    /**\n     * this is Template Method child has Implement your own logic.\n     *\n     * @param exchange exchange the current server exchange\n     * @param chain    chain the current chain\n     * @param selector selector\n     * @param rule     rule\n     * @return {@code Mono<Void>} to indicate when request handling is complete\n     */\n    @Override\n    protected abstract Mono<Void> doExecute(ServerWebExchange exchange, ShenyuPluginChain chain, SelectorData selector, RuleData rule) {\n        LOGGER.debug(".......... function plugin start..............");\n        /*\n         * Processing after your selector matches the rule.\n         * rule.getHandle() is you Customize the json string to be processed.\n         * for this example.\n         * Convert your custom json string pass to an entity class.\n         */\n        final String ruleHandle = rule.getHandle();\n\n        final Test test = GsonUtils.getInstance().fromJson(ruleHandle, Test.class);\n\n        /*\n         * Then do your own business processing.\n         * The last execution  chain.execute(exchange).\n         * Let it continue on the chain until the end.\n         */\n        System.out.println(test.toString());\n        return chain.execute(exchange);\n    }\n}\n\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Detailed explanation:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Plugins will match the selector rule for customized plugins inherit from this abstract class."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Firstly define a new plugin in ",(0,r.jsx)(n.code,{children:"shenyu-admin"}),"  \u2013> BasicConfig \u2013> Plugin, please mind that your plugin name should match the ",(0,r.jsx)(n.code,{children:"named()"})," method overridden in your class."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Re-login  ",(0,r.jsx)(n.code,{children:"shenyu-admin"}),", the plugin you added now showing on plugin-list page, you can choose selectors for matching."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["You can add custom fields to different level of the plugin in ",(0,r.jsx)(n.code,{children:"BasicConfig \u2013> PluginHandle"}),". Then when you add an entry in the corresponding table, you can specify values for these fields. They will be sent to the plugin in json, to achieving the purpose of dynamically configuring the plugin. You can process data after acquiring a handle (",(0,r.jsx)(n.code,{children:"selector.getHandle();"}),", ",(0,r.jsx)(n.code,{children:"rule.getHandle();"}),") in ",(0,r.jsx)(n.code,{children:"doExecute()"})," method."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Register plugin in ",(0,r.jsx)(n.code,{children:"Spring"})," as a ",(0,r.jsx)(n.code,{children:"Bean"}),", or simply apply ",(0,r.jsx)(n.code,{children:"@Component"})," in implementation class."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    @Bean\n    public ShenyuPlugin customPlugin() {\n        return new CustomPlugin();\n    }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"subscribe-your-plugin-data-and-do-customized-jobs",children:"Subscribe your plugin data and do customized jobs"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Declare a new class named ",(0,r.jsx)(n.code,{children:"PluginDataHandler"})," and implements ",(0,r.jsx)(n.code,{children:"org.apache.shenyu.plugin.base.handler.PluginDataHandler"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public interface PluginDataHandler {\n\n    /**\n     * Handler plugin.\n     *\n     * @param pluginData the plugin data\n     */\n    default void handlerPlugin(PluginData pluginData) {\n    }\n\n    /**\n     * Remove plugin.\n     *\n     * @param pluginData the plugin data\n     */\n    default void removePlugin(PluginData pluginData) {\n    }\n\n    /**\n     * Handler selector.\n     *\n     * @param selectorData the selector data\n     */\n    default void handlerSelector(SelectorData selectorData) {\n    }\n\n    /**\n     * Remove selector.\n     *\n     * @param selectorData the selector data\n     */\n    default void removeSelector(SelectorData selectorData) {\n    }\n\n    /**\n     * Handler rule.\n     *\n     * @param ruleData the rule data\n     */\n    default void handlerRule(RuleData ruleData) {\n    }\n\n    /**\n     * Remove rule.\n     *\n     * @param ruleData the rule data\n     */\n    default void removeRule(RuleData ruleData) {\n    }\n\n    /**\n     * Plugin named string.\n     *\n     * @return the string\n     */\n    String pluginNamed();\n\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.code,{children:"pluginNamed()"})," is same as the plugin name you defined."]}),"\n",(0,r.jsxs)(n.li,{children:["Register defined class as a ",(0,r.jsx)(n.code,{children:"Spring Bean"}),", or simply apply ",(0,r.jsx)(n.code,{children:"@Component"})," in implementation class."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    @Bean\n    public PluginDataHandler pluginDataHandler() {\n        return new PluginDataHandler();\n    }\n"})})]})}function d(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>a});var r=i(96540);const l={},s=r.createContext(l);function t(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);