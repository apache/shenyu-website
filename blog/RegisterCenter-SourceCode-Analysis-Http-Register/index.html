<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Register Center Source Code Analysis of Http Register | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Register Center Source Code Analysis of Http Register | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Apache ShenYu is an asynchronous, high-performance, cross-language, responsive API gateway."><meta data-react-helmet="true" property="og:description" content="Apache ShenYu is an asynchronous, high-performance, cross-language, responsive API gateway."><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//blog/RegisterCenter-SourceCode-Analysis-Http-Register"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//blog/RegisterCenter-SourceCode-Analysis-Http-Register"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/RegisterCenter-SourceCode-Analysis-Http-Register" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/RegisterCenter-SourceCode-Analysis-Http-Register" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.6bd5fa92.css">
<link rel="preload" href="/assets/js/runtime~main.4edf57a7.js" as="script">
<link rel="preload" href="/assets/js/main.ef192180.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/document">Docs</a><a class="navbar__item navbar__link" href="/community/contributor-guide">Community</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/event">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/RegisterCenter-SourceCode-Analysis-Http-Register" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="blogPostTitle_d4p0">Register Center Source Code Analysis of Http Register</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-08-15T05:38:46.403Z">August 15, 2023</time> Â· 29 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, the registration center is used to register the client information to <code>shenyu-admin</code>, <code>admin</code> then synchronizes this information to the gateway through data synchronization, and the gateway completes traffic filtering through these data. The client information mainly includes <code>interface information</code> and <code>URI information</code>.</p><blockquote><p>This article is based on <code>shenyu-2.5.0</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/docs/design/register-center-design" target="_blank" rel="noopener noreferrer">Client Access Principles</a> for the introduction of the official website.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-registration-center-principle"></a>1. Registration Center Principle<a class="hash-link" href="#1-registration-center-principle" title="Direct link to heading">#</a></h3><p>When the client starts, it reads the interface information and <code>uri information</code>, and sends the data to <code>shenyu-admin</code> by the specified registration type.</p><p><img src="/assets/images/register-center-en-d38e8150e48eec9bef3727dbadc124ec.png"></p><p>The registration center in the figure requires the user to specify which registration type to use. <code>ShenYu</code> currently supports <code>Http</code>, <code>Zookeeper</code>, <code>Etcd</code>, <code>Consul</code> and <code>Nacos</code> for registration. Please refer to <a href="https://shenyu.apache.org/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">Client Access Configuration</a> for details on how to configure them.</p><p><code>ShenYu</code> introduces <code>Disruptor</code> in the principle design of the registration center, in which the <code>Disruptor</code> queue plays a role in decoupling data and operations, which is conducive to expansion. If too many registration requests lead to registration exceptions, it also has a data buffering role.</p><p><img src="/assets/images/shenyu-register-center-en-732853d1dc114c56034d14f70e92be06.png"></p><p>As shown in the figure, the registration center is divided into two parts, one is the registration center client <code>register-client</code>, the load processing client data reading. The other is the registration center server <code>register-server</code>, which is loaded to handle the server side (that is <code>shenyu-admin</code>) data writing. Data is sent and received by specifying the registration type.</p><ul><li>Client: Usually it is a microservice, which can be <code>springmvc</code>, <code>spring-cloud</code>, <code>dubbo</code>, <code>grpc</code>, etc.</li><li><code>register-client</code>: register the central client, read the client interface and <code>uri</code> information.</li><li><code>Disruptor</code>: decoupling data from operations, data buffering role.</li><li><code>register-server</code>: registry server, here is <code>shenyu-admin</code>, receive data, write to database, send data synchronization events.</li><li>registration-type: specify the registration type, complete data registration, currently supports <code>Http</code>, <code>Zookeeper</code>, <code>Etcd</code>, <code>Consul</code> and <code>Nacos</code>.</li></ul><p>This article analyzes the use of <code>Http</code> for registration, so the specific processing flow is as follows.</p><p><img src="/assets/images/shenyu-register-center-http-en-2bf3e3a1e2c72d3fca6059fae46886f8.png"></p><p>On the client side, after the data is out of the queue, the data is transferred via <code>http</code> and on the server side, the corresponding interface is provided to receive the data and then write it to the queue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-client-registration-process"></a>2. Client Registration Process<a class="hash-link" href="#2-client-registration-process" title="Direct link to heading">#</a></h3><p>When the client starts, it reads the attribute information according to the relevant configuration, and then writes it to the queue. Let&#x27;s take the official <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> as an example and start the source code analysis . The official example is a microservice built by <code>springboot</code>. For the configuration of the registration center, please refer to the official website <a href="https://shenyu.apache.org/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">client access configuration</a> .</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-load-configuration-read-properties"></a>2.1 Load configuration, read properties<a class="hash-link" href="#21-load-configuration-read-properties" title="Direct link to heading">#</a></h4><p>Let&#x27;s start with a diagram that ties together the initialization process of the registry client.</p><p><img src="/assets/images/client-register-init-en-782b6467880bcb85cee72f2beba708c5.png"></p><p>We are analyzing registration by means of <code>http</code>, so the following configuration is required.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Each attribute indicates the following meaning.</p><ul><li><code>registerType</code>: the service registration type, fill in <code>http</code>.</li><li><code>serverList</code>: The address of the <code>Shenyu-Admin</code> project to fill in for the <code>http</code> registration type, note the addition of <code>http://</code> and separate multiple addresses with English commas.</li><li><code>username</code>: The username of the <code>Shenyu-Admin</code></li><li><code>password</code>: The password of the <code>Shenyu-Admin</code></li><li><code>port</code>: the start port of your project, currently <code>springmvc/tars/grpc</code> needs to be filled in.</li><li><code>contextPath</code>: the routing prefix for your <code>mvc</code> project in <code>shenyu</code> gateway, such as <code>/order</code>, <code>/product</code>, etc. The gateway will route according to your prefix.</li><li><code>appName</code>: the name of your application, if not configured, it will take the value of <code>spring.application.name</code> by default.</li><li><code>isFull</code>: set <code>true</code> to proxy your entire service, <code>false</code> to proxy one of your <code>controllers</code>; currently applies to <code>springmvc/springcloud</code>.</li></ul><p>After the project starts, it will first load the configuration file, read the property information and generate the corresponding <code>Bean</code>.</p><p>The first configuration file read is <code>ShenyuSpringMvcClientConfiguration</code>, which is the <code>http</code> registration configuration class for the <code>shenyu</code> client, indicated by <code>@Configuration</code> which is a configuration class, and by <code>@ImportAutoConfiguration</code> which is a configuration class. to introduce other configuration classes. Create <code>SpringMvcClientEventListener</code>, which mainly handles metadata and <code>URI</code> information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Shenyu SpringMvc Client Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create SpringMvcClientEventListener to handle metadata and URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuClientCommonBeanConfiguration</code> is a <code>shenyu</code> client common configuration class that will create the <code>bean</code> common to the registry client.</p><ul><li>Create <code>ShenyuClientRegisterRepository</code>, which is created by factory class.</li><li>Create <code>ShenyuRegisterCenterConfig</code>, which reads the <code>shenyu.register</code> property configuration.</li><li>Create <code>ShenyuClientConfig</code>, read the <code>shenyu.client</code> property configuration.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Shenyu Client Common Bean Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientCommonBeanConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // create ShenyuClientRegisterRepository by factory </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientRegisterRepository shenyuClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuClientRegisterRepositoryFactory.newInstance(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create ShenyuRegisterCenterConfig to read shenyu.register properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // create ShenyuClientConfig to read shenyu.client properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientConfig shenyuClientConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuClientConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-httpclientregisterrepository"></a>2.2 HttpClientRegisterRepository<a class="hash-link" href="#22-httpclientregisterrepository" title="Direct link to heading">#</a></h4><p>The <code>ShenyuClientRegisterRepository</code> generated in the configuration file above is a concrete implementation of the client registration, which is an interface with the following implementation class.</p><p><img src="/assets/images/shenyu-client-register-repository-dba8edf50af1be31d8b53c9573b1e015.png"></p><ul><li><code>HttpClientRegisterRepository</code>: registration via <code>http</code>.</li><li><code>ConsulClientRegisterRepository</code>: registration via <code>Consul</code>.</li><li><code>EtcdClientRegisterRepository</code>: registration via <code>Etcd</code>; <code>EtcdClientRegisterRepository</code>: registration via <code>Etcd</code>.</li><li><code>NacosClientRegisterRepository</code>: registration via <code>nacos</code>; <code>NacosClientRegisterRepository</code>: registration via <code>nacos</code>.</li><li><code>ZookeeperClientRegisterRepository</code>: registration through <code>Zookeeper</code>.</li></ul><p>The specific way which is achieved by loading through <code>SPI</code>, the implementation logic is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * load ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Loading by means of SPI, type determined by registerType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //init ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The load type is specified by <code>registerType</code>, which is the type we specify in the configuration file at</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We specified <code>http</code>, so it will go to load <code>HttpClientRegisterRepository</code>. After the object is successfully created, the initialization method <code>init()</code> is executed as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository implements ShenyuClientRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Read <code>username</code>, <code>password</code> and <code>serverLists</code> from the configuration file, the username, password and address of <code>sheenyu-admin</code>, in preparation for subsequent data sending. The class annotation <code>@Join</code> is used for <code>SPI</code> loading.</p><blockquote><p><code>SPI</code>, known as <code>Service Provider Interface</code>, is a service provider discovery feature built into the <code>JDK</code>, a mechanism for dynamic replacement discovery.</p><p><a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-spi" target="_blank" rel="noopener noreferrer">shenyu-spi</a> is a custom <code>SPI</code> extension implementation for the <code>Apache ShenYu</code> gateway, designed and implemented with reference to Dubbo <a href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/" target="_blank" rel="noopener noreferrer">SPI extension implementation</a>.</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-springmvcclienteventlistener"></a>2.3 SpringMvcClientEventListener<a class="hash-link" href="#23-springmvcclienteventlistener" title="Direct link to heading">#</a></h4><p>Create <code>SpringMvcClientEventListener</code>, which is responsible for the construction and registration of client-side metadata and <code>URI</code> data, and its creation is done in the configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create SpringMvcClientEventListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>SpringMvcClientEventListener</code> implements the <code>AbstractContextRefreshedEventListener</code></p><p><img src="/assets/images/shenyu-client-event-listener-0cd56409c59f2546a285a6426f9c8fee.png"></p><p>The <code>AbstractContextRefreshedEventListener</code> is an abstract class. it implements the <code>ApplicationListener</code> interface and overrides the <code>onApplicationEvent()</code> method, which is executed when a Spring event occurs. It has several implementation classes, which support different kind of <code>RPC</code> styles.</p><ul><li><code>AlibabaDubboServiceBeanListener</code>ï¼šhandles <code>Alibaba Dubbo</code> protocol.</li><li><code>ApacheDubboServiceBeanListener</code>ï¼šhandles <code>Apache Dubbo</code> protocol.</li><li><code>GrpcClientEventListener</code>ï¼šhandles <code>grpc</code> protocol.</li><li><code>MotanServiceEventListener</code>ï¼šhandles <code>Motan</code> protocol.</li><li><code>SofaServiceEventListener</code>ï¼šhandles <code>Sofa</code> protocol.</li><li><code>SpringMvcClientEventListener</code>ï¼šhandles <code>http</code> protocol.</li><li><code>SpringWebSocketClientEventListener</code>ï¼šhandles <code>Websocket</code> protocol.</li><li><code>TarsServiceBeanEventListener</code>ï¼šhandles <code>Tars</code> protocol.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractContextRefreshedEventListener&lt;T, A extends Annotation&gt; implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Instantiation is done through the constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractContextRefreshedEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read shenyu.client.http properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // appName </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = Optional.ofNullable(props.getProperty(ShenyuClientConstants.CONTEXT_PATH)).map(UriUtils::repairData).orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;client register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.ipAndPort = props.getProperty(ShenyuClientConstants.IP_PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // This method is executed when a context refresh event(ContextRefreshedEvent), occurs</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The contents of the method are guaranteed to be executed only once</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ApplicationContext context = event.getApplicationContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the specific beans </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, T&gt; beans = getBeans(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (MapUtils.isEmpty(beans)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build URI data and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildURIRegisterDTO(context, beans));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build metadata and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        beans.forEach(this::handle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;all&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract URIRegisterDTO buildURIRegisterDTO(ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                          Map&lt;String, T&gt; beans);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handle(final String beanName, final T bean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = getCorrectedClass(bean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final A beanShenyuClient = AnnotatedElementUtils.findMergedAnnotation(clazz, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(clazz, beanShenyuClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleClass(clazz, bean, beanShenyuClient, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleMethod(bean, clazz, beanShenyuClient, method, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // default implementation. build URI data and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleClass(final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               @NonNull final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildMetaDataDTO(bean, beanShenyuClient, pathJoin(contextPath, superPath), clazz, null));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // default implementation. build metadata and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        A methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æž„å»ºå…ƒæ•°æ®ï¼Œå‘é€æ³¨å†Œäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract MetaDataRegisterDTO buildMetaDataDTO(T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            @NonNull A shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            String path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Method method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the constructor, the main purpose is to read the property information and then perform the checksum.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, publisher.start() is executed to start event publishing and prepare for registration.</p><p>ShenyuClientRegisterEventPublisher is implemented via singleton pattern, mainly generating metadata and URI subscribers (subsequently used for data publishing), and then starting the Disruptor queue. A common method publishEvent() is provided to publish events and send data to the Disruptor queue.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientRegisterEventPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuClientRegisterEventPublisher INSTANCE = new ShenyuClientRegisterEventPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;DataTypeParent&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterEventPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientExecutorFactory factory = new RegisterClientExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientMetadataExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientURIExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publishEvent(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;DataTypeParent&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of the constructor of <code>AbstractContextRefreshedEventListener</code> is analyzed, it mainly reads the property configuration, creates metadata and URI subscribers, and starts the Disruptor queue.</p><p>The <code>onApplicationEvent()</code> method is executed when a <code>Spring</code> event occurs, the parameter here is <code>ContextRefreshedEvent</code>, which means the context refresh event. </p><blockquote><p><code>ContextRefreshedEvent</code> is a <code>Spring</code> built-in event. It is fired when the <code>ApplicationContext</code> is initialized or refreshed. This can also happen in the <code>ConfigurableApplicationContext</code> interface using the <code>refresh()</code> method. Initialization here means that all <code>Bean</code>s have been successfully loaded, post-processing <code>Bean</code>s have been detected and activated, all <code>Singleton Bean</code>s have been pre-instantiated, and the <code>ApplicationContext</code> container is ready to be used.</p></blockquote><ul><li><code>SpringMvcClientEventListener</code>: the <code>http</code> implementation of <code>AbstractContextRefreshedEventListener</code>:</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientEventListener extends AbstractContextRefreshedEventListener&lt;Object, ShenyuSpringMvcClient&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;Class&lt;? extends Annotation&gt;&gt; mappingAnnotation = new ArrayList&lt;&gt;(3);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Boolean isFull;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æž„é€ å‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(clientConfig, shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get isFull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // http protocol</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Map&lt;String, Object&gt; getBeans(final ApplicationContext context) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configuration attribute, if isFull=true, means register the whole microservice</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .contextPath(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .appName(getAppName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .path(PathUtils.decoratorPathWithSlash(getContextPath()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ruleName(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get bean with Controller annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context.getBeansWithAnnotation(Controller.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected URIRegisterDTO buildURIRegisterDTO(final ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final Map&lt;String, Object&gt; beans) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String buildApiSuperPath(final Class&lt;?&gt; clazz, @Nullable final ShenyuSpringMvcClient beanShenyuClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; StringUtils.isNotBlank(beanShenyuClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return beanShenyuClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(clazz, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Only the first path is supported temporarily</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Class&lt;ShenyuSpringMvcClient&gt; getAnnotationType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuSpringMvcClient.class;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final Object bean, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final ShenyuSpringMvcClient beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method, final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get RequestMapping annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get ShenyuSpringMvcClient annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // the result of ReflectionUtils#getUniqueDeclaredMethods contains method such as hashCode, wait, toSting</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add Objects.nonNull(requestMapping) to make sure not register wrong method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient) &amp;&amp; Objects.nonNull(requestMapping)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æž„é€ å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected MetaDataRegisterDTO buildMetaDataDTO(final Object bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   @NonNull final ShenyuSpringMvcClient shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final String path, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The registration logic is done through <code>publisher.publishEvent()</code>. </p><p>The <code>Controller</code> annotation and the <code>RequestMapping</code> annotation are provided by <code>Spring</code>, which you should be familiar with, so I won&#x27;t go into details. The <code>ShenyuSpringMvcClient</code> annotation is provided by <code>Apache ShenYu</code> to register the <code>SpringMvc</code> client, which is defined as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;path&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;value&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ruleName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // desc info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register MetaData </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean  registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It is used as follows.</p><ul><li>register the entire interface</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/test/**&quot;)  // register the entire interface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpTestController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>register current method</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Save order dto.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param orderDTO the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/save&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/save&quot;, desc = &quot;Save order&quot;) // register current method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO save(@RequestBody final OrderDTO orderDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDTO.setName(&quot;hello world save order&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>publisher.publishEvent()</li></ul><p>This method sends the data to the <code>Disruptor</code> queue. More details about the <code>Disruptor</code> queue are not described here, which does not affect the flow of analyzing the registration.</p><p>When the data is sent, the consumers of the <code>Disruptor</code> queue will process the data for consumption.</p><p>This method sends the data to the <code>Disruptor</code> queue. More details about the <code>Disruptor</code> queue are not described here, which does not affect the flow of analyzing the registration.</p><ul><li>QueueConsumer</li></ul><p><code>QueueConsumer</code> is a consumer that implements the <code>WorkHandler</code> interface, which is created in the <code>providerManage.startup()</code> logic. The <code>WorkHandler</code> interface is the data consumption interface for <code>Disruptor</code>, and the only method is <code>onEvent()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>QueueConsumer</code> overrides the <code>onEvent()</code> method, and the main logic is to generate the consumption task and then go to the thread pool to execute it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * QueueConsumer</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use different thread pools based on DataEvent type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create queue consumption tasks via factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // put in the thread pool to execute the consumption task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code> is the task that is executed in the thread pool, it implements the <code>Runnable</code> interface, and there are two specific implementation classes.</p><ul><li><code>RegisterClientConsumerExecutor</code>ï¼šthe client-side consumer executor.</li><li><code>RegisterServerConsumerExecutor</code>ï¼šserver-side consumer executor.</li></ul><p>As the name implies, one is responsible for handling client-side tasks, and one is responsible for handling server-side tasks (the server side is <code>admin</code>, which is analyzed below).</p><p><img src="/assets/images/consumer-executor-f7ad67d35abaa5a2fac94ef913445a19.png"></p><ul><li>RegisterClientConsumerExecutor</li></ul><p>The logic of the rewritten <code>run()</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterClientConsumerExecutor&lt;T extends DataTypeParent&gt; extends QueueConsumerExecutor&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final T data = getData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // call the appropriate processor for processing according to the data type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribers.get(data.getType()).executor(Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Different processors are called to perform the corresponding tasks based on different data types. There are two types of data, one is metadata, which records the client registration information. One is the <code>URI</code> data, which records the client service information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum DataType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    URI,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>The actuator subscribers are divided into two categories, one that handles metadata and one that handles <code>URIs</code>. There are two on the client side and two on the server side, so there are four in total.</p><p><img src="/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><p>Here is the registration metadata information, so the execution class is <code>ShenyuClientMetadataExecutorSubscriber</code>.</p><ul><li>ShenyuClientMetadataExecutorSubscriber#executor()</li></ul><p>The metadata processing logic on the client side is: iterate through the metadata information and call the interface method <code>persistInterface()</code> to finish publishing the data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientMetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (MetaDataRegisterDTO metaDataRegisterDTO : metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // call the interface method persistInterface() to finish publishing the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistInterface(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The two registration interfaces get the data well and call the <code>publish()</code> method to publish the data to the <code>Disruptor</code> queue.</p><ul><li><code>ShenyuServerRegisterRepository</code></li></ul><p>The <code>ShenyuServerRegisterRepository</code> interface is a service registration interface, which has five implementation classes, indicating five types of registration.</p><ul><li><code>ConsulServerRegisterRepository</code>: registration is achieved through <code>Consul</code>;</li><li><code>EtcdServerRegisterRepository</code>: registration through <code>Etcd</code>.</li><li><code>NacosServerRegisterRepository</code>: registration through <code>Nacos</code>.</li><li><code>ShenyuHttpRegistryController</code>: registration via <code>Http</code>; <code>ShenyuHttpRegistryController</code>: registration via <code>Http</code>.</li><li><code>ZookeeperServerRegisterRepository</code>: registration through <code>Zookeeper</code>.</li></ul><p><img src="/assets/images/client-register-repository-61756e3284c1d3a27083b25d393edf9c.png"></p><p>As you can see from the diagram, the loading of the registry is done by means of SPI. This was mentioned earlier, and the specific class loading is done in the client-side generic configuration file by specifying the properties in the configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * load ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // loading by means of SPI, type determined by registerType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // perform initialization operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The source code analysis in this article is based on the Http way of registration, so we first analyze the HttpClientRegisterRepository, and the other registration methods will be analyzed afterwards.</p><p>Registration by way of <code>http</code> is very simple, it is to call the tool class to send http requests. The registration metadata and URI are both called by the same method <code>doRegister()</code>, specifying the interface and type.</p><ul><li><code>Constants.URI_PATH</code> = <code>/shenyu-client/register-metadata</code>: the interface provided by the server for registering metadata.</li><li><code>Constants.META_PATH</code> = <code>/shenyu-client/register-uri</code>: Server-side interface for registering URIs.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository extends FailbackRegistryRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientRegisterRepository.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static URIRegisterDTO uriRegisterDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;String&gt; serverList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        init(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin paaword</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin server address</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set access token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Persist uri.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param registerDTO the register dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistURI(final URIRegisterDTO registerDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RuntimeUtils.listenByOther(registerDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(registerDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uriRegisterDTO = registerDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistInterface(final MetaDataRegisterDTO metadata) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(metadata, Constants.META_PATH, Constants.META_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uriRegisterDTO != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            uriRegisterDTO.setEventType(EventType.DELETED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRegister(uriRegisterDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setAccessToken() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional&lt;?&gt; login = RegisterUtils.doLogin(username, password, server.concat(Constants.LOGIN_PATH));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                login.ifPresent(v -&gt; this.accessToken = String.valueOf(v));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Login admin url :{} is fail, will retry. cause: {} &quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void doRegister(final T t, final String path, final String type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // iterate through the list of admin services (admin may be clustered)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            i++;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String concat = server.concat(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è®¾ç½®è®¿é—®token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new NullPointerException(&quot;accessToken is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // calling the tool class to send http requests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RegisterUtils.doRegister(GsonUtils.getInstance().toJson(t), concat, type, accessToken);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Register admin url :{} is fail, will retry. cause:{}&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (i == serverList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Serialize the data and send it via OkHttp.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Sending data via OkHttp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void doRegister(final String json, final String url, final String type) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasLength(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error accessToken is null, please check the config : {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Headers headers = new Headers.Builder().add(Constants.X_ACCESS_TOKEN, accessToken).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result = OkHttpTools.getInstance().post(url, json, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.equals(SUCCESS, result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;{} client register success: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, the logic of the client registering metadata by means of <code>http</code> is finished. To summarize: construct metadata by reading custom annotation information, send the data to the <code>Disruptor</code> queue, then consume the data from the queue, put the consumer into the thread pool to execute, and finally send an <code>http</code> request to the <code>admin</code>.</p><p>Similarly, <code>ShenyuClientURIExecutorSubscriber</code> is the execution class of registering <code>URI</code> information.</p><ul><li>ShenyuClientURIExecutorSubscriber#executor()</li></ul><p>The main logic is to iterate through the URI data collection and implement data registration through the persistURI() method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientURIExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (URIRegisterDTO uriRegisterDTO : dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Stopwatch stopwatch = Stopwatch.createStarted();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (Socket ignored = new Socket(uriRegisterDTO.getHost(), uriRegisterDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long sleepTime = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // maybe the port is delay exposed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 5) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;host:{}, port:{} connection failed, will retry&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                uriRegisterDTO.getHost(), uriRegisterDTO.getPort());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If the connection fails for a long time, Increase sleep time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 180) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sleepTime = 10000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TimeUnit.MILLISECONDS.sleep(sleepTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ex.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.delayOtherHooks();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistURI(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>while(true)</code> loop in the code is to ensure that the client has been successfully started and can connect via <code>host</code> and <code>port</code>.</p><p>The logic behind it is: add the <code>hook</code> function for gracefully stopping the client .</p><p>Data registration is achieved through the <code>persistURI()</code> method. The whole logic is also analyzed in the previous section, and ultimately it is the <code>OkHttp</code> client that initiates <code>http</code> to <code>shenyu-admin</code> and registers the <code>URI</code> by way of <code>http</code>.</p><p>The analysis of the registration logic of the client is finished here, and the metadata and URI data constructed are sent to the <code>Disruptor</code> queue, from which they are then consumed, read, and sent to <code>admin</code> via <code>http</code>.</p><p>The source code analysis of the client-side metadata and <code>URI</code> registration process is complete, with the following flow chart.</p><p><img src="/assets/images/client-metadata-uri-register-en-7ccc8df4fc77fdf28480f15a6de6022b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-server-side-registration-process"></a>3. Server-side registration process<a class="hash-link" href="#3-server-side-registration-process" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-shenyuhttpregistrycontroller"></a>3.1 ShenyuHttpRegistryController<a class="hash-link" href="#31-shenyuhttpregistrycontroller" title="Direct link to heading">#</a></h4><p>From the previous analysis, we know that the server side provides two interfaces for registration.</p><ul><li><code>/shenyu-client/register-metadata</code>: The interface provided by the server side is used to register metadata.</li><li><code>/shenyu-client/register-uri</code>: The server-side interface is provided for registering URIs.</li></ul><p>These two interfaces are located in <code>ShenyuHttpRegistryController</code>, which implements the <code>ShenyuServerRegisterRepository</code> interface and is the implementation class for server-side registration. It is marked with <code>@Join</code> to indicate loading via <code>SPI</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/shenyu-client&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuHttpRegistryController implements ShenyuServerRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuServerRegisterPublisher publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuServerRegisterPublisher publisher, final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.publisher = publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register Metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-metadata&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerMetadata(@RequestBody final MetaDataRegisterDTO metaDataRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-uri&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(@RequestBody final URIRegisterDTO uriRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The exact method used is specified by the configuration file and then loaded via <code>SPI</code>.</p><p>In the <code>application.yml</code> file in <code>shenyu-admin</code> configure the registration method, <code>registerType</code> specify the registration type, when registering with <code>http</code>, <code>serverLists</code> do not need to be filled in, for more configuration instructions you can refer to the official website <a href="https://shenyu.apache.org/zh/docs/user-guide/register-center-access" target="_blank" rel="noopener noreferrer">Client Access Configuration</a>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>RegisterCenterConfiguration </li></ul><p>After introducing the relevant dependencies and properties configuration, when starting <code>shenyu-admin</code>, the configuration file will be loaded first, and the configuration file class related to the registration center is <code>RegisterCenterConfiguration</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterCenterConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //create ShenyuServerRegisterRepository to register in admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuServerRegisterRepository shenyuServerRegisterRepository(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig, final List&lt;ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. get the registration type from the configuration property</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String registerType = shenyuRegisterCenterConfig.getRegisterType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. load the implementation class by registering the type with the SPI method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuServerRegisterRepository registerRepository = ExtensionLoader.getExtensionLoader(ShenyuServerRegisterRepository.class).getJoin(registerType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. get the publisher and write data to the Disruptor queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerDisruptorPublisher publisher = RegisterServerDisruptorPublisher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. ShenyuClientRegisterService, rpcType -&gt; registerService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuClientRegisterService&gt; registerServiceMap = shenyuClientRegisterService.stream().collect(Collectors.toMap(ShenyuClientRegisterService::rpcType, e -&gt; e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. start publisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(registerServiceMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. init registerRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRepository.init(publisher, shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerRepository;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Two <code>bean</code>s are generated in the configuration class.</p><ul><li><p><code>shenyuRegisterCenterConfig</code>: to read the attribute configuration.</p></li><li><p><code>shenyuServerRegisterRepository</code>: for server-side registration.</p></li></ul><p>In the process of creating <code>shenyuServerRegisterRepository</code>, a series of preparations are also performed.</p><ul><li><ol><li>get the registration type from the configuration property.</li></ol></li><li><ol start="2"><li>Load the implementation class by the registration type with the <code>SPI</code> method: for example, if the specified type is <code>http</code>, <code>ShenyuHttpRegistryController</code> will be loaded.</li></ol></li><li><ol start="3"><li>Get <code>publisher</code> and write data to the <code>Disruptor</code> queue.</li></ol></li><li><ol start="4"><li>Register <code>Service</code>, <code>rpcType -&gt; registerService</code>: get the registered <code>Service</code>, each <code>rpc</code> has a corresponding <code>Service</code>. The client for this article is built through <code>springboot</code>, which belongs to the <code>http</code> type, and other client types: <code>dubbo</code>, <code>Spring Cloud</code>, <code>gRPC</code>, etc.</li></ol></li><li><ol start="5"><li>Preparation for event publishing: add server-side metadata and <code>URI</code> subscribers, process the data. And start the <code>Disruptor</code> queue.</li></ol></li><li><ol start="6"><li>Initialization operation for registration: <code>http</code> type registration initialization operation is to save <code>publisher</code>.</li></ol></li></ul><ul><li>RegisterClientServerDisruptorPublisher#publish()</li></ul><p>The server-side publisher that writes data to the <code>Disruptor</code> queue , built via the singleton pattern.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterClientServerDisruptorPublisher implements ShenyuServerRegisterPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final RegisterClientServerDisruptorPublisher INSTANCE = new     private static final RegisterClientServerDisruptorPublisher INSTANCE = new RegisterServerDisruptorPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static RegisterClientServerDisruptorPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //prepare for event publishing, add server-side metadata and URI subscribers, process data. And start the Disruptor queue.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final Map&lt;String, ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerExecutorFactory factory = new RegisterServerExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add URI data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new URIRegisterExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add Metadata subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new MetadataExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //start Disruptor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write data to queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publish(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Object&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(Collections.singleton(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write data to queue on batch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final Collection&lt;? extends DataTypeParent&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(dataList.stream().map(DataTypeParent.class::cast).collect(Collectors.toList()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.getProvider().shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The loading of the configuration file, which can be seen as the initialization process of the registry server, is described in the following diagram.</p><p><img src="/assets/images/server-register-init-en-c20ecd9991817e159730a8aea38db110.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-queueconsumer"></a>3.2 QueueConsumer<a class="hash-link" href="#32-queueconsumer" title="Direct link to heading">#</a></h4><p>In the previous analysis of the client-side <code>disruptor</code> queue consumption of data over. The server side has the same logic, except that the executor performing the task changes.</p><p>The <code>QueueConsumer</code> is a consumer that implements the <code>WorkHandler</code> interface, which is created in the <code>providerManage.startup()</code> logic. The <code>WorkHandler</code> interface is the data consumption interface for <code>disruptor</code>, and the only method is <code>onEvent()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T var1) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>QueueConsumer</code> overrides the <code>onEvent()</code> method, and the main logic is to generate the consumption task and then go to the thread pool to execute it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * QueueConsumer</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use different thread pools based on DataEvent type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create queue consumption tasks via factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // put in the thread pool to execute the consumption task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code> is the task that is executed in the thread pool, it implements the <code>Runnable</code> interface, and there are two specific implementation classes.</p><ul><li><code>RegisterClientConsumerExecutor</code>: the client-side consumer executor.</li><li><code>RegisterServerConsumerExecutor</code>: server-side consumer executor.</li></ul><p>As the name implies, one is responsible for handling client-side tasks and one is responsible for handling server-side tasks.</p><ul><li><code>RegisterServerConsumerExecutor#run()</code></li></ul><p><code>RegisterServerConsumerExecutor</code> is a server-side consumer executor that indirectly implements the <code>Runnable</code> interface via <code>QueueConsumerExecutor</code> and overrides the <code>run()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterServerConsumerExecutor extends QueueConsumerExecutor&lt;List&lt;DataTypeParent&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get the data from the disruptor queue and check data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;DataTypeParent&gt; results = getData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(this::isValidData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //execute operations according to type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getType(results).executor(results);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get subscribers by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ExecutorSubscriber&lt;DataTypeParent&gt; selectExecutor(final Collection&lt;DataTypeParent&gt; list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Optional&lt;DataTypeParent&gt; first = list.stream().findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return subscribers.get(first.orElseThrow(() -&gt; new RuntimeException(&quot;the data type is not found&quot;)).getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>The actuator subscribers are divided into two categories, one that handles metadata and one that handles <code>URIs</code>. There are two on the client side and two on the server side, so there are four in total.</p><p><img src="/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><ul><li>MetadataExecutorSubscriber#executor()</li></ul><p>In case of registering metadata, this is achieved by <code>MetadataExecutorSubscriber#executor()</code>: get the registered <code>Service</code> according to the type and call <code>register()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class MetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Traversing the metadata list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataRegisterDTOList.forEach(meta -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(this.shenyuClientRegisterService.get(meta.getRpcType())) // Get registered Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(shenyuClientRegisterService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Registration of metadata, locking to ensure sequential execution and prevent concurrent errors</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            shenyuClientRegisterService.register(meta);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>URIRegisterExecutorSubscriber#executor()</li></ul><p>In case of registration metadata, this is achieved by <code>URIRegisterExecutorSubscriber#executor()</code>: construct <code>URI</code> data, find <code>Service</code> according to the registration type, and achieve registration by the <code>registerURI</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class URIRegisterExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        findService(dataList).ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; groupByRpcType = dataList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(data -&gt; StringUtils.isNotBlank(data.getRpcType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.groupingBy(URIRegisterDTO::getRpcType));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, List&lt;URIRegisterDTO&gt;&gt; entry : groupByRpcType.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String rpcType = entry.getKey();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Get registered Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(shenyuClientRegisterService.get(rpcType))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final List&lt;URIRegisterDTO&gt; list = entry.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Build URI data types and register them with the registerURI method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(list);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Find Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Optional&lt;ShenyuClientRegisterService&gt; findService(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dataList.stream().map(dto -&gt; shenyuClientRegisterService.get(dto.getRpcType())).findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterService#register()</li></ul><p><code>ShenyuClientRegisterService</code> is the registration method interface, which has several implementation classes.</p><p><img src="/assets/images/client-register-service-949e3110cb57db2f250dafdc41446eb4.png"></p><ul><li><code>AbstractContextPathRegisterService</code>: abstract class, handling part of the public logic.</li><li><code>AbstractShenyuClientRegisterServiceImpl</code>: : abstract class, handles part of the public logic.</li><li><code>ShenyuClientRegisterDivideServiceImpl</code>: <code>divide</code> class, handles <code>http</code> registration types.</li><li><code>ShenyuClientRegisterDubboServiceImpl</code>: <code>dubbo</code> class, handles <code>dubbo</code> registration types.</li><li><code>ShenyuClientRegisterGrpcServiceImpl</code>: <code>gRPC</code> class, handles <code>gRPC</code> registration types.</li><li><code>ShenyuClientRegisterMotanServiceImpl</code>: <code>Motan</code> class, handles <code>Motan</code> registration types.</li><li><code>ShenyuClientRegisterSofaServiceImpl</code>: <code>Sofa</code> class, handles <code>Sofa</code> registration types.</li><li><code>ShenyuClientRegisterSpringCloudServiceImpl</code>: <code>SpringCloud</code> class, handles <code>SpringCloud</code> registration types.</li><li><code>ShenyuClientRegisterTarsServiceImpl</code>: <code>Tars</code> class, handles <code>Tars</code> registration types.</li><li><code>ShenyuClientRegisterWebSocketServiceImpl</code>ï¼š <code>Websocket</code> classï¼Œhandles <code>Websocket</code> registration types.</li></ul><p>From the above, we can see that each microservice has a corresponding registration implementation class. The source code analysis in this article is based on the official <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> as an example, it is of <code>http</code> registration type, so the registration implementation class for metadata and URI data is <code>ShenyuClientRegisterDivideServiceImpl</code>: <code>ShenyuClientRegisterDivideServiceImpl</code>.</p><ul><li>register(): </li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.register selector information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.register rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.register metadata information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.register contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The whole registration logic can be divided into 4 steps.</p><ul><li><ol><li>Register selector information</li></ol></li><li><ol start="2"><li>Register rule information</li></ol></li><li><ol start="3"><li>Register metadata information</li></ol></li><li><ol start="4"><li>Register `contextPath</li></ol></li></ul><p>This side of <code>admin</code> requires the construction of selectors, rules, metadata and <code>ContextPath</code> through the metadata information of the client. The specific registration process and details of processing are related to the <code>rpc</code> type. We will not continue to track down the logical analysis of the registration center, tracking to this point is enough.</p><p>The source code of the server-side metadata registration process is analyzed and the flow chart is described as follows.</p><p><img src="/assets/images/server-metadata-register-en-8290907a57a1189a4b5863f3c47254bb.png"></p><ul><li>registerURI()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Does the corresponding selector exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Handle handler information in the selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(uriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Update records in the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish Event to gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After <code>admin</code> gets the <code>URI</code> data, it mainly updates the <code>handler</code> information in the selector, then writes it to the database, and finally publishes the event notification gateway. The logic of notifying the gateway is done by the data synchronization operation, which has been analyzed in the previous article, so we will not repeat it.</p><p>The source code analysis of the server-side <code>URI</code> registration process is complete and is described in the following diagram.</p><p><img src="/assets/images/server-uri-register-en-6026d791dbc404cadee04b237add0691.png"></p><p>At this point, the server-side registration process is also analyzed, mainly through the interface provided externally, accept the registration information from the client, and then write to the <code>Disruptor</code> queue, and then consume data from it, and update the <code>admin</code> selector, rules, metadata and selector <code>handler</code> according to the received metadata and <code>URI</code> data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-summary"></a>4. Summary<a class="hash-link" href="#4-summary" title="Direct link to heading">#</a></h3><p>This article focuses on the <code>http registration</code> module of the <code>Apache ShenYu</code> gateway for source code analysis. The main knowledge points involved are summarized as follows.</p><ul><li>The register center is for registering client information to <code>admin</code> to facilitate traffic filtering.</li><li><code>http</code> registration is to register client metadata information and <code>URI</code> information to <code>admin</code>.</li><li><code>http</code> service access is identified by the annotation <code>@ShenyuSpringMvcClient</code>.</li><li>construction of the registration information mainly through the application listener <code>ApplicationListener</code>.</li><li>loading of the registration type is done through <code>SPI</code>.</li><li>The <code>Disruptor</code> queue was introduced to decouple data from operations, and data buffering.</li><li>The implementation of the registry uses interface-oriented programming, using design patterns such as template methods, singleton, and observer.</li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/http">http</a><a class="margin-horiz--sm" href="/blog/tags/register-center">register center</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/shenyu-website/edit/main/blog/RegisterCenter-SourceCode-Analysis-Http-Register.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Code Analysis For Dubbo Plugin</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">LoadBalancer SPI Source Code Analysis Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-registration-center-principle" class="table-of-contents__link">1. Registration Center Principle</a></li><li><a href="#2-client-registration-process" class="table-of-contents__link">2. Client Registration Process</a></li><li><a href="#3-server-side-registration-process" class="table-of-contents__link">3. Server-side registration process</a></li><li><a href="#4-summary" class="table-of-contents__link">4. Summary</a></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.4edf57a7.js"></script>
<script src="/assets/js/main.ef192180.js"></script>
</body>
</html>