<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Blog | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Blog | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//blog/page/2"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//blog/page/2"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/page/2" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.554d8e36.css">
<link rel="preload" href="/assets/js/runtime~main.375b1e44.js" as="script">
<link rel="preload" href="/assets/js/main.561e3b14.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/document">Docs</a><a class="navbar__item navbar__link" href="/community/contributor-guide">Community</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/event">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalancer SPI Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.291Z">July 12, 2024</time> · 14 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>Gateway applications need to support a variety of load balancing  strategies, including <code>random</code>,<code>Hashing</code>, <code>RoundRobin</code> and so on. In <code>Apache Shenyu</code> gateway, it not only realizes such traditional algorithms, but also makes smoother traffic processing for the entry of server nodes through detailed processing such as traffic <code>warm-up,</code> so as to obtain better overall stability. In this article, let&#x27;s walk through how <code>Apache Shenyu</code> is designed and implemented this part of the function.</p><blockquote><p>This article based on <code>shenyu-2.5.0</code> version of the source code analysis.</p></blockquote><p>[TOC]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalancer-spi"></a>LoadBalancer <code>SPI</code><a class="hash-link" href="#loadbalancer-spi" title="Direct link to heading">#</a></h2><p>The implementation of <code>LoadBalancer</code> is in <strong><em>shenyu-loadbalancer</em></strong> module. It has based on its <code>SPI</code> creation mechanism. The core interface code is shown as follows. This interface  well explains the concept: load balancing is to select the most appropriate node from a series of server nodes.  Routing, traffic processing and load balancing is the basic function of <code>LoadBalancer</code> <code>SPI</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface LoadBalancer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * this is select one for upstream list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream select(List&lt;Upstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Where <code>upstreamList</code> represents the server nodes list available for routing. <code>Upstream</code> is the data structure of server node, the  important elements including <code>protocol</code>, <code>upstreamUrl</code> , <code>weight</code>, <code>timestamp</code>, <code>warmup</code>、<code>healthy</code>.  </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class Upstream {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * protocol.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * weight.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * false close, true open.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean status;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * startup time.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final long timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * warmup.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int warmup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * healthy.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean healthy;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * lastHealthTimestamp.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastHealthTimestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * lastUnhealthyTimestamp.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUnhealthyTimestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * group.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String group;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * version.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String version;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-loadbalancer-module"></a>Design of LoadBalancer module<a class="hash-link" href="#design-of-loadbalancer-module" title="Direct link to heading">#</a></h2><p>The class diagram of <code>LoadBalancer</code> module<code>is</code>shown as follows.</p><p><img alt="loadbalancer-class-diagram" src="/assets/images/loadBalancer-class-diagram-7fa8d2dd07f1210da7d25fa787b69d5f.png"></p><p>We can draw the outline of <code>LoadBalancer</code> module from the class diagram:</p><ol><li><p>The abstract class <code>AbstractLoadBalancer</code> implements the SPI <code>LoadBalancer</code> interface，and supplies the template methods for selection related, such as select(), selector()，and gives the calculation of weight.</p></li><li><p>Three implementation classes which inherit <code>AbstractLoadBalancer</code> to realize their own logic:</p><ul><li><code>RandomLoadBalancer</code> - Weight Random</li><li><code>HashLoadBalancer</code>  - Consistent Hashing</li><li><code>RoundRobinLoadBalancer</code> -Weight Round Robin per-packet</li></ul></li><li><p>The factory class <code>LoadBalancerFactory</code> provides public static method to be called.</p><p>The implementation classes and algorithms are configurable.   According to its specification,   by adding profile in <code>SHENYU_DIERECTORY</code> directory, the data in profile should be  <em>key</em>=<em>value-class</em> format, where the <em>value-class</em> will be load by the <code>Apache Shenyu SPI</code> class loader, and <em>key</em> value should be an <code>name</code> defined in <code>LoadBalanceEnum.</code></p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">random=org.apache.shenyu.loadbalancer.spi.RandomLoadBalancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">roundRobin=org.apache.shenyu.loadbalancer.spi.RoundRobinLoadBalancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hash=org.apache.shenyu.loadbalancer.spi.HashLoadBalancer</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>The code of LoadBalanceEnum</code> is as follows：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum LoadBalanceEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Hash load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HASH(1, &quot;hash&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Random load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RANDOM(2, &quot;random&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Round robin load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ROUND_ROBIN(3, &quot;roundRobin&quot;, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int code;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final boolean support;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractloadbalancer"></a>AbstractLoadBalancer<a class="hash-link" href="#abstractloadbalancer" title="Direct link to heading">#</a></h2><p>This abstract class implements the <code>LoadBalancer</code> interface and define the abstract method <code>doSelect()</code> to be processed by the implementation classes. In the template method <code>select()</code>,  It will do validation first then call the <code>doSelect()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractLoadBalancer implements LoadBalancer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do select divide upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Upstream doSelect(List&lt;Upstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream select(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (upstreamList.size() == 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doSelect(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the <code>timestamp</code> of server node  is not null, and the interval between current time and <code>timestamp</code> is within the traffic warm-up time, the formula for weight calculation is.
$$ {1-1}
ww = min(1,uptime/(warmup/weight))
$$
It can be seen from the formula that the final weight(<code>ww</code>) is proportional to the original-<code>weight</code> value. The closer the time interval is to the <code>warmup</code> time, the greater the final <code>ww</code>. That is, the longer the waiting time of the request, the higher the final <code>weight</code>. When there is no <code>timestamp</code> or other conditions, the <code>ww</code> is equal to the <code>weight</code> value of <code>Upstream</code> object.</p><p>The central of thinking about <em>warm-up</em>is to avoid  bad performance when adding new server and the new <code>JVMs</code> starting up.</p><p>Let&#x27;s see how the load balancing  with <code>Random</code>, <code>Hashing</code> and <code>RoundRobin</code> strategy is implemented.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="randomloadbalancer"></a>RandomLoadBalancer<a class="hash-link" href="#randomloadbalancer" title="Direct link to heading">#</a></h2><p>The <code>RandomLoadBalancer</code> can handle two situations:</p><ol><li>Each node without weight, or every node has the same weight, randomly choose one.</li><li>Server Nodes with different weight, choose one randomly by weight.</li></ol><p>Following is the <code>random()</code> method of <code>RandomLoadBalancer</code>. When traversing server node list, if the randomly generated value is less than the weight of node, then the current node will be chosen. If after one round traversing, there is no server node match, then it will choose one randomly. The <code>getWeight(final Upstream upstream)</code> is defined in <code>AbstractLoadBalancer</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int length = upstreamList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // every upstream has the same weight?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean sameWeight = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // the weight of every upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int[] weights = new int[length];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int firstUpstreamWeight = getWeight(upstreamList.get(0));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weights[0] = firstUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // init the totalWeight</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int totalWeight = firstUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int halfLengthTotalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 1; i &lt; length; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int currentUpstreamWeight = getWeight(upstreamList.get(i));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i &lt;= (length + 1) / 2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                halfLengthTotalWeight = totalWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weights[i] = currentUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            totalWeight += currentUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (sameWeight &amp;&amp; currentUpstreamWeight != firstUpstreamWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Calculate whether the weight of ownership is the same.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                sameWeight = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (totalWeight &gt; 0 &amp;&amp; !sameWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return random(totalWeight, halfLengthTotalWeight, weights, upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return random(upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Upstream random(final int totalWeight, final int halfLengthTotalWeight, final int[] weights, final List&lt;Upstream&gt; upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the weights are not the same and the weights are greater than 0, then random by the total number of weights.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int offset = RANDOM.nextInt(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int index = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int end = weights.length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (offset &gt;= halfLengthTotalWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            index = (weights.length + 1) / 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset -= halfLengthTotalWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            end = (weights.length + 1) / 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine which segment the random value falls on</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (; index &lt; end; index++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset -= weights[index];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (offset &lt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return upstreamList.get(index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return random(upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="hashloadbalancer"></a>HashLoadBalancer<a class="hash-link" href="#hashloadbalancer" title="Direct link to heading">#</a></h2><p>In <code>HashLoadBalancer</code>, it takes the advantages of <a href="https://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener noreferrer">consistent hashing</a> , that maps both the input traffic and the servers to a unit circle, or name as  <em>hash ring</em>. For the requested<code>ip</code> address, with its hash value to find the node closest in clockwise order as the node to be routed.  Let&#x27;s see how consistent hashing is implemented in <code>HashLoadBalancer</code>.</p><p>As to the hash algorithms, <code>HashLoadBalancer</code> uses <code>MD5</code> hash, which has the advantage of mixing the input in an unpredictable but deterministic way. The output is a 32-bit integer.  the code is shown as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private static long hash(final String key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // md5 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MessageDigest md5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5 = MessageDigest.getInstance(&quot;MD5&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (NoSuchAlgorithmException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShenyuException(&quot;MD5 not supported&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] keyBytes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyBytes = key.getBytes(StandardCharsets.UTF_8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.update(keyBytes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] digest = md5.digest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // hash code, Truncate to 32-bits</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long hashCode = (long) (digest[3] &amp; 0xFF) &lt;&lt; 24</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[2] &amp; 0xFF) &lt;&lt; 16)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[1] &amp; 0xFF) &lt;&lt; 8)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | (digest[0] &amp; 0xFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return hashCode &amp; 0xffffffffL;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Importantly, how to generate the hash ring and avoid skewness?  Let&#x27;s the<code>doSelect()</code> method in<code>HashLoadBalancer</code> as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int VIRTUAL_NODE_NUM = 5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConcurrentSkipListMap&lt;Long, Upstream&gt; treeMap = new ConcurrentSkipListMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        upstreamList.forEach(upstream -&gt; IntStream.range(0, VIRTUAL_NODE_NUM).forEach(i -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long addressHash = hash(&quot;SHENYU-&quot; + upstream.getUrl() + &quot;-HASH-&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            treeMap.put(addressHash, upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hash = hash(ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SortedMap&lt;Long, Upstream&gt; lastRing = treeMap.tailMap(hash);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!lastRing.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return lastRing.get(lastRing.firstKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return treeMap.firstEntry().getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this method, duplicated labels are used which are called &quot;virtual nodes&quot; (i.e.  5 virtual nodes point to a single &quot;real&quot; server).  It will make the distribution in hash ring more evenly, and reduce the occurrence of data skewness.</p><p>In order to rescue the data sorted in the hash ring, and can be accessed quickly, we use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html" target="_blank" rel="noopener noreferrer">ConcurrentSkipListMap</a> of Java to store the server node lists ( with virtual nodes) and its hash value as key.  This class a member of <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/collections/index.html" target="_blank" rel="noopener noreferrer">Java Collections Framework</a>, providing expected average <em>log(n)</em> time cost for retrieve and access operations safely execute concurrent by multiple threads.  </p><p>Furthermore, the method tailMap(K fromKey) of  <code>ConcurrentSkipListMap</code> can return a view of portion of the map whose keys are greater or equal to the <code>fromKey</code>, and not need to navigate the whole map.</p><p>In the above code section, after the hash ring is generated, it uses <code>tailMap(K fromKey)</code> of <code>ConcurrentSkipListMap</code> to find the subset that the elements greater, or equal to the hash value of the requested <code>ip</code>, its first element is just the node to be routed. With the suitable data structure, the code looks particularly clear and concise.</p><p>Consistent hashing resolved the poor scalability of the traditional hashing by modular operation.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="roundrobinloadbalancer"></a>RoundRobinLoadBalancer<a class="hash-link" href="#roundrobinloadbalancer" title="Direct link to heading">#</a></h2><p>The original Round-robin selection is to select server nodes one by one from the candidate list. Whenever some nodes has crash ( ex, cannot be connected after 1 minute), it will be removed from the candidate list, and do not attend the next round, until the server node is recovered and it will be add to the candidate list again.  In <code>RoundRobinLoadBalancer</code>,the weight Round Robin per-packet schema is implemented.</p><p>In order to work in concurrent system, it provides an inner static class <code>WeigthRoundRobin</code> to store and calculate the rolling selections of each server node. Following is the main section of this class( removed remark )</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected static class WeightedRoundRobin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicLong current = new AtomicLong(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setWeight(final int weight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.weight = weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.set(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long increaseCurrent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return current.addAndGet(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void sel(final int total) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.addAndGet(-1 * total);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setLastUpdate(final long lastUpdate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.lastUpdate = lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Please focus on the these method:</p><ul><li><p><code>setWeight(final int weight)</code> : set the current value by <em>weight</em></p></li><li><p><code>increaseCurrent()</code>: Increment the <code>current</code> value by <code>weight</code>, and <code>current</code> set to 0. </p></li><li><p><code>sel(final int total)</code>: decrement  the <code>current</code> value by  <em>total</em></p><p>Let&#x27;s see how the weight factor being used in this round-robin  selection? </p><p>First it defines a two-level  <code>ConcurrentMap</code> type variable named as <code>methodWeightMap</code> , to cache the server node lists and the rolling selection data about each server node.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt; methodWeightMap = new ConcurrentHashMap&lt;&gt;(16);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this map, the key of first level is  set to <code>upstreamUrl</code> of first element in server node list. The type of second object is <code>ConcurrentMap&lt;String, WeightedRoundRobin&gt;,</code> the key of this inner Map is  the value <code>upstreamUrl</code>variable of each server node in this server list, the value object is <code>WeightedRoundRobin</code>, used to trace the rolling selection data about each server node. As to the implementation class for the  Map object, we use <code>ConcurrentHashMap</code> of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html" target="_blank" rel="noopener noreferrer">JUC</a>,  a hash table supporting full concurrency of retrievals and high expected concurrency for updates.</p><p>In the second level of the map, the embedded  static class - <code>WeighedRoundRobin</code> of each node is thread-safe, implementing the weighted <code>RoundRobin</code> per bucket. The following is the code of the <code>doselect()</code> method of this class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String key = upstreamList.get(0).getUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(map)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodWeightMap.putIfAbsent(key, new ConcurrentHashMap&lt;&gt;(16));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int totalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long maxCurrent = Long.MIN_VALUE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long now = System.currentTimeMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream selectedInvoker = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WeightedRoundRobin selectedWeightedRoundRobin = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Upstream upstream : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rKey = upstream.getUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WeightedRoundRobin weightedRoundRobin = map.get(rKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int weight = getWeight(upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(weightedRoundRobin)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin = new WeightedRoundRobin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.putIfAbsent(rKey, weightedRoundRobin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (weight != weightedRoundRobin.getWeight()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // weight changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long cur = weightedRoundRobin.increaseCurrent();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weightedRoundRobin.setLastUpdate(now);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cur &gt; maxCurrent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            maxCurrent = cur;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedInvoker = upstream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedWeightedRoundRobin = weightedRoundRobin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalWeight += weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......  //erase the section which handles the time-out upstreams. </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (selectedInvoker != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWeightedRoundRobin.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example we assume <code>upstreamUrl</code> values of three server nodes is: LIST = [upstream-20, upstream-50, upstream-30]. After a round of execution, the data in newly created <code>methodWeightMap</code> is as follows:</p><p><img alt="methodWeightMap" src="/assets/images/methodWeightMap-90b4a77aedffd8cd88bc12b9551739ad.png"></p><p>For the above example LIST, assumes the  <code>weight</code> array is  [20,50,30].  the following figure shows the value change and polling selection process of the <code>current</code> array in <code>WeighedRoundRobin</code> object.</p><p><img alt="weighted-roundrobin-demo" src="/assets/images/weighted-roundrobin-demo-cec02fd422fb01ef73e882e0966a8cec.png"></p><p>In each round, it will choose the server node with max <code>current</code> value.</p><ul><li>Round1:<ul><li>Traverse the server node list, initialize the <code>weightedRoundRobin</code> instance of each server node or update  the <code>weight</code> value of server nodes object <code>Upstream</code></li><li>Traverse the server node list, initialize the <code>weightedRoundRobin</code> instance of each server node or update  the <code>weight</code> value of server nodes object <code>Upstream</code></li><li>say, in this case,  after traverse, the <code>current</code> array  of the node list changes to  [20, 50,30]，so according to rule, the node Stream-50 would be chosen, and then the static object <code>WeightedRoundRobin</code> of  Stream-50 executes <code>sel(-total)</code> , the <code>current</code> array is now [20,-50, 30].</li></ul></li><li>Round 2:  after traverse, the <code>current</code> array should be [40,0,60],  so the Stream-30 node would be chosen， <code>current</code> array is now  [40,0,-40].</li><li>Round 3:  after traverse, <code>current</code> array  changes to [60,50,-10],  Stream-20 would be chosen，and <code>current</code> array is now [-40,50,-10].</li></ul><p>When there is any inconsistence or some server crashed, for example, the lists size does not match with the elements in map, it would copy and modify the element with lock mechanism, and remove the timeout server node,  the data in Map updated. Following is the fault tolerance code segment.  </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Java"><pre tabindex="0" class="prism-code language-Java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    if (!updateLock.get() &amp;&amp; upstreamList.size() != map.size() &amp;&amp; updateLock.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // copy -&gt; modify -&gt; update reference.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = new ConcurrentHashMap&lt;&gt;(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; recyclePeriod);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodWeightMap.put(key, newMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateLock.set(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(selectedInvoker)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWeightedRoundRobin.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalancerfactory"></a>LoadBalancerFactory<a class="hash-link" href="#loadbalancerfactory" title="Direct link to heading">#</a></h2><p>In this class, a static method calling <code>LoadBalancer</code> is provided, where<code>ExtensionLoader</code> is the entry point of <code>Apache Shenyu SPI</code>. That is to say, <code>LoadBalancer</code> module is configurable and extensible. The <code>algorithm</code> variable in this static method is the <code>name</code> enumeration type defined in <code>LoadBalanceEnum</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Selector upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param algorithm    the loadBalance algorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Upstream selector(final List&lt;Upstream&gt; upstreamList, final String algorithm, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LoadBalancer loadBalance = ExtensionLoader.getExtensionLoader(LoadBalancer.class).getJoin(algorithm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return loadBalance.select(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="using-of-loadbalancer-module"></a>Using of LoadBalancer module<a class="hash-link" href="#using-of-loadbalancer-module" title="Direct link to heading">#</a></h2><p>In the above section, we describe the <code>LoadBalancer</code> <code>SPI</code> and three implementation classes. Let&#x27;s take a look at how the <code>LoadBalancer</code> to be used in <code>Apache Shenyu</code>. <a href="http://shenyu.apache.org/docs/plugin-center/http-handle/divide-plugin" target="_blank" rel="noopener noreferrer">DividePlugin</a> is a <code>plugin</code> in <code>Apache Shenyu</code> responsible for routing <code>http</code> request. when enable to use this <code>plugin</code>, it will transfer traffic according to selection data and rule data, and deliver to next plugin downstream.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The type of second parameter of <code>doExecute()</code> is <code>ShenyuPluginChain</code>, which represents the execution chain of <code>plugins</code>. For details, see the mechanism of <a href="http://shenyu.apache.org/docs/design/flow-control" target="_blank" rel="noopener noreferrer">Apache Shenyu Plugins</a>. The third one is <code>SelectorData</code> type, and the fourth is <code>RuleData</code> type working as  the rule data.</p><p>In <code>doExecute()</code> of <code>DividePlugin</code>,  first verify the size of <code>header</code>, content length,  etc, then preparing for load balancing.</p><p>Following is a code fragment using<code>LoadBalancer</code> in the <code>doExecute()</code> method:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    // find the routing server node list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // the requested ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //calling the Utility class and invoke the LoadBalance processing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p> In the above code, the output of<code>ruleHandle.getLoadBalance()</code> is the <code>name</code> variable defined in <code>LoadBalanceEnum</code>, that is <code>random</code>, <code>hash</code>, <code>roundRobin</code>, etc.  It is very convenient to use <code>LoadBalancer</code> by <code>LoadBalancerFactory</code>. When adding more  <code>LoadBalancer</code> implementing classes,  the interface in <code>plugin</code> module will not be effect at all.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>After reading through the code of <code>LoadBalancer</code> module, from the design perspective, it is concluded that this module has the  following characteristics:</p><ol><li>Extensibility: Interface oriented design and implemented on <code>Apache Shenyu SPI</code> mechanism, it can be easily extended to other dynamic load balancing algorithms (for example, least connection, fastest mode, etc), and supports cluster processing.</li><li>Scalability： Every load balancing implementation,  weighted Random, consistency  Hashing and weighted <code>RoundRobin</code> can well support increase or decrease cluster overall capacity.</li><li>More detailed design such as <em>warm-up</em> can bring better performance and obtain better overall stability.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/load-balance">load balance</a><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy  -- analyze the design based on SPI</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.291Z">July 12, 2024</time> · 5 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>In most of the <code>plugins</code> ( such as <code>Dubbo</code>, <code>gRPC</code>,<code>Spring-cloud</code>, etc) of <code>Apache Shenyu</code>, the <code>routing</code>parameters are designed to support the combination of multiple conditions. In order to realize such requirements,  the parameters and behaviors are abstracted to three parts according to its <code>SPI</code> mechanism,  and implemented in <strong><em>shenyu-plugin-base</em></strong>  module.</p><ul><li><code>ParameterData</code>-parameters</li><li><code>PredictJudge</code>-predicate</li><li><code>MatchStrategy</code>-matching strategy</li></ul><p>Relatively speaking, the <code>MatchStrategy</code> is the part that needs the least extension points. For the combined judgement of multiple conditions, the common selection rules are: All conditions are matched, at least one is matched, at least the first is met, or most of conditions  satisfied.  As we will  need to handle various types of parameters, for example: <code>IP</code>, <code>header</code>, <code>uri</code>, etc. </p><p>How to make the <code>MatchStrategy</code> to be simple to use and extensible?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy"></a>MatchStrategy<a class="hash-link" href="#matchstrategy" title="Direct link to heading">#</a></h2><p>The implementation of <code>MatchStrategy</code> is in <strong><em>shenyu-plugin-base</em></strong> module. It is based on the SPI creation mechanism, and has used factory pattern and strategy design pattern. The class diagram of <code>MatchStrategy</code> <code>is</code> showed as follows.</p><p><img alt="MatchStrategy-class-diagram" src="/assets/images/MatchStrategy-class-diagram-ac006eef5089ce92a972e039b431100b.PNG"></p><p>Based on the interface <code>MatchStrategy</code> we design the implementation classes, and the  abstract class <code>AbstractMatchStrategy</code> supplies common method, while the factory class <code>MatchStrategyFactory</code> provides creation  functions.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy-interface"></a>MatchStrategy Interface<a class="hash-link" href="#matchstrategy-interface" title="Direct link to heading">#</a></h2><p>First, let&#x27;s look at the <code>MatchStrategy</code> <code>SPI</code> interface</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean match(List&lt;ConditionData&gt; conditionDataList, ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The annotation <code>@SPI</code> means that this is an <code>SPI</code> interface. Where <code>ServerWebExchange</code> is <code>org.springframework.web.server.ServerWebExchange</code>, represents the request-response  interactive content of HTTP. Following is the code of <code>ConditionData</code>, the more detail about this class can refer to <a href="https://shenyu.apache.org/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI/" target="_blank" rel="noopener noreferrer">code analysis</a> of <code>PredicteJudge</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionData {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String operator;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramValue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractmatchstrategy"></a>AbstractMatchStrategy<a class="hash-link" href="#abstractmatchstrategy" title="Direct link to heading">#</a></h2><p>Second, let&#x27;s look at the abstract class <code>AbstractMatchStrategy</code>，it has defined a <code>buildRealData</code>  method，In this method it wraps various parameters to a unified interface through the functionality of <code>ParameterDataFactory</code>,  which is the factory class of <code>ParameterData</code>. It supports a variety of types of  parameters , such as <code>Ip</code>, <code>Cookie</code>, <code>Header</code>,<code>uri</code>, etc.  Modifications of such parameters will not impact the calling of matching rules of <code>MatchStrategy</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractMatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String buildRealData(final ConditionData condition, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ParameterDataFactory.builderData(condition.getParamType(), condition.getParamName(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="implementation-class-and-profile"></a>Implementation class and profile<a class="hash-link" href="#implementation-class-and-profile" title="Direct link to heading">#</a></h2><p>Now, let&#x27;s look at the two implementation class based on the above interface in  <strong><em>shenyu-plugin-base</em></strong> module , that is:</p><ul><li><p><code>AndMatchStrategy</code>- <code>AND</code> -All conditions are matched</p></li><li><p><code>OrMatchStrategy</code>-   <code>OR</code> -at least one is match</p><p>The properties file containing the SPI implementation is shown as follows, which located at the <code>SHENYU_DIRECTORY</code>directory. When starting up, the top-level SPI classes will read the key-value and  load the classes and cache them.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">and=org.apache.shenyu.plugin.base.condition.strategy.AndMatchStrategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">or=org.apache.shenyu.plugin.base.condition.strategy.OrMatchStrategy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>These two implementation classes inherit <code>AbstractMatchStrategy</code> class and implement <code>MatchStrategy</code> interface.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="andmatchstrategy---and-relation"></a>AndMatchStrategy-  “AND” relation<a class="hash-link" href="#andmatchstrategy---and-relation" title="Direct link to heading">#</a></h3><p>Since the <code>PredicateJudge</code> interface can encapsulate different variety of Predicates , for example  EqualsPredicateJudge, EndsWithPredicateJudge and so on, the <code>ConditionData</code> and <code>ParamData</code> passed to it can present with variety of parameters, for treating of multiple conditions. So using<code>stream</code> and <code>lambda</code> expression, it can be very simple and efficient to process &quot;AND&quot; logic (all conditions must be matched).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AndMatchStrategy extends AbstractMatchStrategy implements MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean match(final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return conditionDataList</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .allMatch(condition -&gt; PredicateJudgeFactory.judge(condition, buildRealData(condition, exchange)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>OrMatchStrategy</code> similarly implements the &quot;OR&quot; logic- at least one is match.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategyfactory"></a>MatchStrategyFactory<a class="hash-link" href="#matchstrategyfactory" title="Direct link to heading">#</a></h2><p>This is the factory class of <code>MatchStrategy</code>，there are  two methods,  one is <code>newInstance()</code>, which will return the <code>MatchStrategy</code> implementation class instance cached by the <code>SPI</code> <code>ExtensionLoader</code> indexed by the key-value.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static MatchStrategy newInstance(final Integer strategy) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String matchMode = MatchModeEnum.getMatchModeByCode(strategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(MatchStrategy.class).getJoin(matchMode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>the <code>matchMode</code> will be the name of strategy, the value will be &quot;and&quot; or &quot;or&quot;. The <code>MatchModeEnum</code> defines the code and name of match strategy as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">AND(0, &quot;and&quot;), </span></span><span class="token-line" style="color:#393A34"><span class="token plain">OR(1, &quot;or&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Another method is <code>match()</code> method, which will invoke the <code>match()</code> method of  implementation class. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean match(final Integer strategy, final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(strategy).match(conditionDataList, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-it-works"></a>How it works<a class="hash-link" href="#how-it-works" title="Direct link to heading">#</a></h2><p><code>AbstractShenyuPlugin</code> is the base class of <code>plugins</code> in <code>shenyu-plugin</code> module. In this class two selection method are defined: <code>filterSelector()</code> and <code>filterRule()</code> , Both of them call the  <code>match()</code> method of <code>MatchStrategyFactory</code>. The code  of <code>filterSelector()</code> is shown as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterSelector(final SelectorData selector, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (selector.getType() == SelectorTypeEnum.CUSTOM_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selector.getConditionList())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return MatchStrategyFactory.match(selector.getMatchMode(), selector.getConditionList(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In <code>filterSelector</code>() method, after validation of  the <code>SelectorData</code>, calls the <code>match</code> method of <code>MatchStrategyFactory</code>, and then this factory class will invokes the <code>match</code> method of corresponding implementation class. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterRule(final RuleData ruleData, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleData.getEnabled() &amp;&amp; MatchStrategyFactory.match(ruleData.getMatchMode(), ruleData.getConditionDataList(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In <code>filterRule()</code> it is also calls the  <code>match()</code> method of <code>MatchStrategyFactory</code>.  Does it look particularly concise or even simple?  In the <a href="https://shenyu.apache.org/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI/" target="_blank" rel="noopener noreferrer">code analysis</a> of  <code>PredicteJudge</code> , you can  see more detail about parameter processing in <code>shenyu-plugin</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Due to the use of  <code>SPI</code> mechanism of <code>Apache Shenyu</code>, the parameter selection module has the characteristic of loose coupling and extensibility. In terms of  the combination of multiple conditions, <code>MatchStrategy</code> provides a good design.  Although currently only two implementation classes are present, it can be easily used to develop more complex <code>MatchStrategy</code> rules in the future,  such as &quot;<code>firstOf</code>&quot;-first condition must matched, or &quot;<code>mostOf</code>&quot;- most of the conditions must be matched, etc.</p><p>Interested readers can read the source code of <code>&#x27;shenyu-plugin&#x27;</code> to learn more.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge -- analyze the design based on SPI</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.291Z">July 12, 2024</time> · 6 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p><strong>Apache Shenyu</strong> has been identified as a gateway application which supports a variety of protocols and  microservice frameworks such as  Dubbo, gRPC, Spring-Cloud, etc.  To do this, the product has accomplished an elegant <code>SPI</code> (Service Provider Interface) as its foundation, and make the  Rule data parsing and predicting program very simple , resiliency and security. As to rule data parsing processing,  the <code>SPI</code> design increases the product&#x27;s scalability. When appending new plugin, in most cases, the   existing module is enough for rule data parsing , otherwise it can be rapidly carry out with tiny effort. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="top-level-design-of-spi"></a>Top level design of SPI<a class="hash-link" href="#top-level-design-of-spi" title="Direct link to heading">#</a></h2><p> In <code>Apache Shenyu</code>, the <code>SPI</code> archtecure is defined in <strong><em>shenyu-spi</em></strong> module and composed of three parts:   <code>SPI</code> interface,  factory  design pattern,  and configuration file. There is  two interface defined as annotation: @SPI and @Join. When class file with  @Join annotation,  it means that it will join as an <code>SPI</code> extension class, in other words, it is an application or registration.  The  @SPI denotes that the class is an <code>SPI</code> extension class.</p><p>Fig 1 classes in the <strong><em>shenyu-spi</em></strong></p><p><img alt="toplevel-SPI" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASkAAACeCAYAAABuIfz7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAABX0SURBVHhe7Z39kxXVmcf5l1L70/y2STbRaLTKJEQoeTFBBtYkG8iS2ggoiChCcBCFlEQriElF0RWoiplaYGCDMRiRXQEtglNmABdKN1izI+iaicBJP6fP6T4vz+nue29f7pnu78c65b3d5637nudzTx/udM8SAAAQMZAUACBqICkAQNRAUgCAqBmYpM5f/FCcfu+slcbPvi8uf/KpygEAAAOU1KvHTog9+3/npX0HjkhZge4ZHZ4lZg2Pqnc3hkG0GRvyHAyNiHH1HtQDK6kXXnhB7N69W0xMTKgtNpOTk2LPnj0yH6VuCElKpzN/Pqdygk6BpAbBuBgZgqT6ASspElRIVK6g+iWpKonqAD6QFGgSrKRITJyoXEG98cYbMnUDJNU/ICnQJIJrUq6oTp065Qnq+vXrMnVD3yU1PiKGZiWBYyQ3hmRgJdPz0ZGhNI85VR8dtsoOjYym0/nCQFRT/qzcsDBz6/bG3b55dRbXkzIqhs06jL5rYYzr4wrV4faj9FLFbtPsdj1tquMuqCc7h+q9Rm9/V/VxaMTOESqXU3JsVLbkcytvA3RD4cK5KSozaUH1giup3xx+TZy78IH4+Mon8v+vHP6DtZ9LQUkpwVhjSA0wc/DKQcUMNh0g3kBl8pqMjwyLvHp/jSKrwxzIeuAb9ZbVo4/PCsSknsSjEt1Ovl8FoFfHUHE7Fn7wj474x9Zbm+o9V48+P14dRJonzeL3k5D96/HYrPLM51bcBuiWQkkRrqjqEBThSuri/15Se1IufvgXaz+XeEnxg5RI5eN8K3vf9qHyKoAKJOUhA6qsPb9fHlY95f3ggsVuI63Dq0IGnisAhQrKULP1tKmOrUI91udjnZ8uJFXl2LL6c9jxBEnVTqmkCC2qugRFuJL6/OpVtSfl88+vWvu5xEqqaMA538LsoAqWL5cDkQ5oM1UYxMzsIFhPSUARsqyTwQooVYddf574utXxUx7mGOppkz/Hrgzk+6wPrrS6mUlVOLYKn1txG6BbKkmqH7iSmpz6WO1Joffmfi7FJak0OMxgStvL31cb7CX11CipojqCmLIxjqWeNqtJKq1LnS/ztaQbSSmKjq30c6vYBuiYaCQ19oc3xZVP/1/uo//Te3M/l1hJBQYp4Q52flCFyit5hKLMGbAE254ZbAqrH6X1hI9PI+srDPTyOkqR/cylU0+bFSWl8lFdcp/1GfJ18J91AO7Yyj435j2oh2gkpRMtoHPbucRLSg9q51vbGXhEaFClg9IWRbotSVkFjrTc+rNv5Xxw+3UkuOUq1BM6Pv1etmPt1GVK6qC2sg3O8SX7hu0TkpR3ZhE9t1lVUgnU/lByzEl+J3vaFzO/Oqf5Z93FsZn5CVWnvclsA9RFdJLqJIUkJdEDM0u2dIiiQZUNTJWGR90A8gNKB6FMVK/sQx4sur3sJw9Z3SqDoqweiXt8RiWyHadSLtCtdihZ58I/PvucMBLvQ5sEV0/SYioabzuh6tFtJPXpc5+21cWxVfjc7DZAXTRXUrXDB1AnYBDXSe+fR1XwuQ2WgUlq6vIn4tLk//WUqI4bhrrs6iUmMNhrRH4e/uy4H+BzGywDk1TM0OWFvcCrLi16HKgY7PUhz+UNmEUR+NwGCyQVQA5MY/2hjoDAYO+dbE3rBp5HfG6DBZICAEQNJAUAiBpICgAQNZAUACBqICkAQNRAUgCAqIGkAABRA0kBAKKmdZL627VpcXbqjDh64aA4dH6fTPSattE+AEBctEZS15P/3rn0pnj+9Hax6+0RNtE+ykN5AQBx0ApJTV/9q9g/8RIrJi5RXirTVCbunyWemjsiJtV7AGKm8ZKiWVEngtKJyhTNqCZ3Dokd/zDLS2NHVIZoGRfH5/ZPUjP3vIBYabyk6PKNk1CVRGVDUDD2FuijYuwLzQteeV6+MCz4B/TXQTPPGwjTaEnRQnhoDWrJ2rvEwhXflIlec3mobGgxHZLigaRA3TRaUmen3mXlQ2nL/gfEvGV3yESvuTyUqA6OIknRPv8SJw2up+4fzfab6aWdxo1Azo6Il5K8ep/djrpcc+rxxZC2p/ebfWHXpJw23TJV25XnpVBSaT2h8il233VfOz1vlFyZ6WOfUHXR65OBNTqs3cVBoyX1+sUxVjw63bt+gUzcPp2oDg4ZjAUD2B7geYDnBGYER4aTwB0Sx8+q994aUh7keYDmAjTfmwE8sTPvqxd8SZteQKuAz+uo0m65pCZ3DhccW4Lqiyuf41nfwuet/BjSY6d81mfhnXMi0A644TRaUofO7WPFo1MVSVEdHNy3uh2cuSj4wOWCIA1aLzBksOkgYgI7wWpDBWcowGxJ5f10sftdoV31vvi8OEhBOG1YMnfhzlvVY1DH7vUnbdcqb/ULDBJIqgdJuQHroWThf0sTTLCp/G6Q65Tm5QOZEwqV4fpoSapIaNYMo0q7/nsOPZvRKctfIteU8HkrPwZX0Dn258lICwwMXO6VSKrbyz1Jl5IqDtJqspCo+lxZDU5S6TFb+80ZS6Xj74+k0jpUPvM1GDitXTh//MCabOGcXnN5KHWzcJ6SfxvzeZlgU9uKv8E7kJQmCVQSlW7LDtRwm3adNUjKEQZh569y/J2dN7c/QUmVfl5gUDRaUoP8CYIdDFyA84FF9ZpCkdA3e1a2giyS/GNmvSWzCbZNR2x1ScqqU82A3PJcX/L3HZw37xiKJJVA52lu0lZynFY9YKA0WlJEP3/MSQHgJgpiGQju5YIOSDPIVRBRMoPOrdsOqmqyoD5k5Z2+sIFq9IUrU4ukEsxjk30gMbj53b44bYbOW/kxlEhKCbCo/+DG03hJ9evPYkAT4UUMBkvjJUXgD4xBJbBgHiWtkBRBsyK6fAutUVGifZQHM6h2Ii8FMYuKjtZISkML4bjpHTDR62ThtSowSFonKQDAzAKSAgBEDSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKhpvKQuf/KpOHz0uNj18m/Fq8feUlsBADOFRkvqg798JJ7bMyp+/vw+mXa/clBMX7su/jQ1LQ5cuCL2nr8sE72mbbQPABAXjZUUzaBMQVHad/SE2HZ6Umx++yM20b5jlz7DH8UAEBGNlRRd4pmCembvfvHYiQ9ZObnpxYmPxWdXr6mamkfx7UpmMriLQRNprKR2vZzPop7Zs19s+a//EVv++OeORFU0ozLvi2Sm+G+WpgK5T5Iqu59Uf4GkmkhjJfXqsRNi9ytj8hKPxESC+vmLvxFPHvpvVkpcoku/EDIYewp07ja4Mx9ICtRNoxfOaSFcr0GRqEhQO/79P+Tr5b/eLxasf0LMXrFWfGfTDrHm8DuepKhsaDEdkuKBpEDdNFpSZ6amPfE89tYHYtFDj4ub5i8Wdz/6M7HkyV+KOSsfEbct/ZHYyFwKUh0cRZKiff6ln7o1bRJAer+ZrNvgqlsN6312O3kgmvX4Ykjb0/vNvrBrUk6bbpmq7crzUiap0raItL1QOxLvNsMjvKQKz2d+PsynGnf/5QPqptGSOnjxiiedZb8aFTcvXCLWH33P2r4pkZf5Xieqg0MGY8FgtkXAfcMHZlLynt/m3SFVWacuCqZcbLkAzfem+GJ5gnG1tqieak86Nuuh46Jt1nkuPZ+BciAaGi2pvecue9KZ/+AWOYNyt4cS1cFhziZ0soMzFwUfuJyk0gDyxCWDWAcaE7AJVhsq6L16FLakfKFp7H5XaJd5b1O1LQYpG70/VI/qYyabKudTnY+itsFAaaekNmz3todSkaTcgPVQsuCeWsJKSuV35adTmtcNxBROKFSG66MlqSKhWbOQKu2WyKZyWyl6hqNTVm+wHqePlc6nK20QG+283FswLNb9ftzavmbspPVep24v9yQqSDqVFBvEGdVkITGC1Oxr/JJKz41VjzmTCtbDS6r4fEJSsdO6hfPNpy6JOas2iJvm3SNoRjW8dZf4xvLV4ub5i8WGY+97+btZOE9JAya73PPyMpIKXsaYdCApTRLg4ZlDuE27zhokVbUtZlZl1xuqJ92e97HK+YSkYqfRkjJ/gmClRFQ0o5q3dkTMue9hsXjrs+Kh1+yZFaVefoJgD3wuwPkAonpNoUhoRpCVrSCLJH+UTzBOqNSW+17NiMx65TE4IqNtVM7sI9uedT4hqdhptKQI+kGmK5+qqezHnDT43UQBwgVQFmhmkKtgpGTKyq3bDqBqstABK8szwewFpdEXrkwnkjLryeoLHLfc57Vl1yP7mpRx5WceI6WxI+E+mvncY4ek4qbxkqJ5EP2JCyeholT2ZzEAgBtD4yVF0B8LdyKqpv+BMQAziVZIiqBZEV2+sWtUKtE+3KoFgLhojaQ0tBCOm94BMHNonaQAADMLSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCiBpICAERN6yT1t2vT4uzUGXH0wkFx6Pw+meg1baN9AIC4aI2krif/vXPpTfH86e1i19sjbKJ9lIfyAgDioBWSmr76V7F/4iVWTFyivFSmn+D2IABUo/GSollRJ4LSicqUz6j4+xeVo8pBUgCU0nhJ0eWbKZ9nT42INc8tEwtWfEvcftc/iVvnfEl8e+nXxfKRe8TTxx618lLZYrqVFACgKo2WFC2Em2tQO08+JhatvFPMufc28dDuFeIXb22W27f9bp249+GFYvbiW8VTr2/I8lPZ4sV0SAqAftNoSZ2dejcTDqVVz3xfzF5yq3jmzY3JrGmjWL3zX8SKbUvEfTvuFTuOPiLuWT1X/GDj3VYZqiNMQFLqVsHmLWute2wn2GtSeT3WbXML7hUOQFtotKRevzhmCeeuZXdIUe1441HxzUVfE8s2f1ds2PMTccudXxI/fWWlfE3bzTJURxhGUu5DBAglLfM+5pykqFyex33yCQDtpNGSOnRunyWc2+d/VWz+7Sqx5rkfijv/+Ta5jS4Bb/n2F8XI/gfE4wfWSGGZZaiOMK6kwo9Qch9YwM6knIV0twwAbaRdkpr3FSmjnySXdwtXfEtu2/bqevG12f8onvjPdWLd8//qzaQ6kpSaMbmXdhL5tJP8qSihyz0TSAqAll3uzf3e7eL+XT+UM6avz/2yvPRbtGqOuH3BV8XSdfPE7OFbxY+fXGKVqXK5l82cICkAaqdVC+ckoHnL75A/Q6AZ1Y+3LxWPvPxvciF9ZSIs+hc/2meWKV44Ty/vcin1eLkHSQHg0WhJuT9BePr4JrkWtfj+uWLr4QflNlqTeiJ5TQvnOp9OZT9B4CRC27yFc2YxHZICoBqNlhTh/pjz6WTWtOyxRfIHnLQWdcudX5SXgat/8QMrHyX+x5ypUNKfCPhP3pUoKenE5YOkAKhG4yXV3z+LAQD0m8ZLiojxD4wBANVohaQImhXR5Zu5RuUm2kd5MIMCIB5aIykNLYTjpncAzBxaJykAwMwCkgIARA0kBQCIGkgKABA1kBQAIGogKQBA1EBSAICogaQAAFEDSQEAoqZ1ksIvzgGYWbRGUvjbPQBmJq2QFO6CAMDMpfGSollRJ4LSicqUzqjcm9tlN7FL0XfpLMpj3/wOAODSeEnR5Zspn7oes87eNTORlnl/c5nHEpC6A6exDZICoJhGS4oWws01qPoesx5+4IKJL6kE54kykBQAxTRaUv17zHq1pwuzknKeMANJAVBMoyXVz8esk1zkGlOBqMIzqdDz9wAALo2WVL8fs04SyhbEGVn5kvJnYJAUAMW0S1K1P2Y9JZtVOY+uMiWmk7uOBUkBUEyrLvfqf8y6ifqXO+Nf/Pg1KRtICoBiWrVwXv9j1h2ODENSANRMoyXl/gShvses09qS+1Ri/ynEkBQAvdNoSRHujzl7f8y6Jl0EL1pvgqQA6J3GS6qvfxYDAOg7jZcUgT8wBmDm0gpJETQross3c43KTbSP8mAGBUA8tEZSGloIx03vAJg5tE5SAICZBSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCipnWSmr52XfxpalocuHBF7D1/WSZ6TdtoHwAgLlojKdLPsUufiW2nJ8Xmtz9iE+2jPFAVAPHQCkl9dvWaeHHiY1ZMXKK8VOZG0aTbteDWM6BuGi8pmhV1IiidqEzpjKrkCcbV8B8Yyt0bnZJ+DFa8+MdSJzP3vIBeaLyk6PKNk1CVRGVDyBvalTzBuFuq3CyvGPvZfk2BPee10szzNtNptKRoITy0BrX81/vFgvVPiNkr1orvbNoh1hx+x8tDZakOn3Qw1yEkDkiKB5JqJ42W1JmpaU88m09dEnc98FNx0/zF4u5HfyaWPPlLMWflI+K2pT8SG0986OWnOnzSwVz2BONsfUY9Wl1fnrjl3HWcIknRPv8SJ++P3m8mS6ZuX6x28vu0m/X4Ykjb0/vNvrBrUk6bbpmq7crzUiiptJ5Q+RS777qvnZ43Sq7M9LFPqLro9cnAGh3W7qrTaEkdvHjFk86yX42KmxcuEeuPvmdt3/TWB9Z7nagODhpkciAWiCrLYw5GNdjNcu6AlcFYMIDt/HmA5wRmBPJpNuYDJNw1pDzI8wB1hZy+NwN4YmfeVy/41Lqd1Rd1DvI6qrRbLqnJncMFx5ag+uLK53jWt/B5Kz8G4/M2PwvvnBOBdgBLoyW199xlTzrzH9wiZ1Du9lCiOkJY3/qWJFJkwDJB5QYbJyldb1a/VU8uCj5wuSBIg9YLDBlsOoiYwE6w2lDBGQow+1jyfrrY/a7QrnpffF4cpCCcNpjPKYc7b1WPIfR5p+1a5a1+gTLaKakN273toVQkKU32Dep8Y7ryyXC+XTlJseVMlCz8b2mCCTaV3w1yndK8fCBzQqEyXB+tYykSmnUOqrTrv+fQn4VOWf4SuaaEz1v5MYQ/b/vzZKQFCmnn5d6CYbHu9+PW9jVjJ633OoUu93xUoBlBFKOkioO0miwkqj5XVoOTVHrM1n7Zhnpf6fj7I6m0DpXPfA0q0cqF8zmrNoib5t0jaEY1vHWX+Mby1eLm+YvFhmPve/n5hfMAZlAkyEHLBJU7mDuXVP5tzOdlgk1tK/4G70BSmuSYSVS6LftYwm3addYgKUcYhJ2/yvF3dt7c/gQlVfp5gSIaLangTxASUdGMat7aETHnvofF4q3Piodes2dWlIp/guB+G/qBRoNWzjTM4HOCmuhUUnZ+LsD5wKJ63bblN3tWtoIskvxjZr0lswm2Te8c1CMpq041A3LLc33J33dw3ip8jhZ0nuYmbSXHadUDSmm0pIh+/ZhTD2gaqDq5g1sPWv1P0jq5gzQU2G6iIJZ5XUHqgDSDXAURJbNfbt12UFWTBfUhK+/0hQ1Uoy9cmVoklWAem+wDicHN7/bFaTN03sqPoURSarwU9R/wNF5Sff2zmBKKBy1oF7yIQTmNlxQxqD8whqRABhbMu6YVkiJoVkSXb6E/k6FE+yhPrzMoDSQFNHIsYBbVFa2RlIYWwm/UTe8gKaDXyTAOuqd1kgIAzCwgKQBA1EBSAICogaQAAFEDSQEAogaSAgBEjBB/B3o1C04w+m2JAAAAAElFTkSuQmCC"></p><p>The SPI configuration directory is  <code>META-INF/shenyu/.</code>  that is specified:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When starting the gateway system , the <code>ExtensionLoader</code> will scan the profiles under  <code>SHENYU_DIRECTORY</code>,  in turn, load and validate and then  initialize each configed class. The configuration file uses  &quot;Key = class-file&quot; format.  During operation of the system,  the corresponding <code>SPI</code> implementation class will be invoked through the factory mechanism.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="implementation-of-shenyu-plugin-spi"></a>Implementation of shenyu-plugin SPI<a class="hash-link" href="#implementation-of-shenyu-plugin-spi" title="Direct link to heading">#</a></h2><p>In <strong><em>shenyu-plugin</em></strong> module,  various plugins for HTTP routing are implemented according to the plugin mechanism, including  request, redirect, response and rewrite, etc.  Plugins for microservice frameworks such as Dubbo, gRPC , Spring-Cloud and Tars have been developed in the gateway product.  And plugins are still increasing. If  no such  dependent module fo parsing and judge routing  parameters and data,  each plugin is necessary to implement the parsing functions, and has to frequently  modify  to support their matching rules, such as wildcard, regular expression, SpEL expression, etc. Therefore,  they made a high level abstraction for routing parameter data following the <code>SPI</code> framework in  <strong><em>shenyu-plugin</em></strong> module.  The rule analysis consists of three parts:</p><ul><li><p><code>ParameterData</code>- parameter data</p></li><li><p><code>PredicatJudge</code>-  predicate whether the actural data match the rule</p></li><li><p><code>MatchStrategy</code>- combine multiple conditions, the final used strategy</p></li></ul><p>These implementation classes are defined in <strong><em>shenyu-plugin-base</em></strong> module. In each plugin, resolution and predication of  the routing parameter can be realized through <code>AbstractShenyuPlugin</code> using the above  <code>SPIs</code>. That is dedicated and easy to extend, in line with SOLID principle.</p><p>​      This section analyzes the  <code>PredictJudge</code> in detail. You can find the dependency to <strong><em>shenyu-spi</em></strong> in the pom.xml of this module.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-predicatejudge-spi"></a>Design of PredicateJudge SPI<a class="hash-link" href="#design-of-predicatejudge-spi" title="Direct link to heading">#</a></h3><p><code>PredicateJudge</code> <code>SPI</code>  is used to analyze and judge various routing rules configed in <code>Apache Shenyu</code> gateway.  The name and functions of this SPI are similar to <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener noreferrer">Predicate</a>  in Java, but the acceptance behavior is further  abstracted applying for routing aspect. This <code>SPI</code> is implemented through the Factory pattern.  Let&#x27;s look at the <code>Predictejudge</code> <code>SPI</code> interface:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@FunctionalInterface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PredicateJudge {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * judge conditionData and realData is match.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param conditionData {@linkplain ConditionData}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param realData       realData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true is pass  false is not pass.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean judge(ConditionData conditionData, String realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The class diagram is as follows:</p><p>Fig 2-<code>Predicate</code> class diagram</p><p><img alt="predicate-class-diagram" src="/assets/images/predicate-class-diagram-67a93b8c3e49800b23fe717c22027c54.png"></p><p>The important  methods of <code>PredicateJudgeFactory</code>  are shown as follows:</p><p>Whenever need to parsing and matching routing data, you can use</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static PredicateJudge newInstance(final String operator) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(PredicateJudge.class).getJoin(processSpecialOperator(operator));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static Boolean judge(final ConditionData conditionData, final String realData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(conditionData) || StringUtils.isBlank(realData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(conditionData.getOperator()).judge(conditionData, realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ConditionData</code> contains of four attributes of String type: <code>paramType</code>, <code>operator</code>,<code>paramName</code>,<code>paramValue</code> </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="paramtypeenum"></a>ParamTypeEnum<a class="hash-link" href="#paramtypeenum" title="Direct link to heading">#</a></h4><p>Where <strong>paramType</strong> must be the  enumeration type  <code>ParamTypeEnum</code>. The default supported <code>paramType</code> are:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">post, uri,query, host, ip,header, cookie,req_method</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="operatorenum"></a>OperatorEnum<a class="hash-link" href="#operatorenum" title="Direct link to heading">#</a></h4><p><strong>operator</strong> must be the enumeration type <code>OperatorEnum</code>, currently  supported operators are:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   match, =,regex, &gt;,&lt;, contains, SpEL,  Groovy, TimeBefore,TimeAfter</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Base on the above defination , the plugin module provides  the following  eight <code>PredicateJudge</code>  implemetation classes to realize the logic of these operators respectively. </p><table><thead><tr><th>Implementation class</th><th>Logic description</th><th>corespondece operator</th></tr></thead><tbody><tr><td><code>ContainsPredicateJudge</code></td><td>&quot;contain&quot; relation, the actual data needs contain the specified string</td><td>contains</td></tr><tr><td><code>EqualsPredicateJudge</code></td><td>equals &quot;=&quot;</td><td>=</td></tr><tr><td><code>MatchPredicateJudge</code></td><td>used for URI context path matching</td><td>match</td></tr><tr><td><code>TimerAfterPredicateJudge</code></td><td>Whether the local time is after the specified time</td><td>TimeAfter</td></tr><tr><td><code>TimerBeforePredicateJudge</code></td><td>Whether the local time is before the specified time</td><td>TimeBefore</td></tr><tr><td><code>GroovyPredicateJudge</code></td><td>used Groovy syntax toe set ParamName and value data</td><td>Groovy</td></tr><tr><td><code>RegexPredicateJudge</code></td><td>used Regex to match</td><td>regex</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-use-predicatejudge"></a>How to use PredicateJudge<a class="hash-link" href="#how-to-use-predicatejudge" title="Direct link to heading">#</a></h3><p>When you want to parse parameters, you only need to call <code>PredicateJudgeFactory</code> as follows. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">PredicateJudgeFactory.judge(final ConditionData conditionData, final String realData);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi-profile"></a>SPI profile<a class="hash-link" href="#spi-profile" title="Direct link to heading">#</a></h3><p>The implementation class is configed in the file under directory <code>SHENYU_DIRECTORY</code> . It  will be loaded and cached at startup. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">equals=org.apache.shenyu.plugin.base.condition.judge.EqualsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">contains=org.apache.shenyu.plugin.base.condition.judge.ContainsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Groovy=org.apache.shenyu.plugin.base.condition.judge.GroovyPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">match=org.apache.shenyu.plugin.base.condition.judge.MatchPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">regex=org.apache.shenyu.plugin.base.condition.judge.RegexPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SpEL=org.apache.shenyu.plugin.base.condition.judge.SpELPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeAfter=org.apache.shenyu.plugin.base.condition.judge.TimerAfterPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeBefore=org.apache.shenyu.plugin.base.condition.judge.TimerBeforePredicateJudge</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-usage-of-predicatejudge-spi-in-shenyu-gateway"></a>The usage of PredicateJudge SPI in Shenyu gateway<a class="hash-link" href="#the-usage-of-predicatejudge-spi-in-shenyu-gateway" title="Direct link to heading">#</a></h2><p>Most plugins in <code>Apache Shenyu</code> are inherited from <code>AbstractShenyuPlugin</code>.  In this abstract class, the filter functions (selection and matching) are achieved through  <code>MatchStrategy</code> <code>SPI</code>, and <code>PredicateJudge</code> will be invoked from <code>MatchStrategy</code>  to predicate each condition data. </p><p>Fig 3- class diagram of plugins with <code>PredicateJudge</code> and <code>MatchStrategy</code> <code>SPI</code></p><p><img alt="plugin-SPI-class-diagram" src="/assets/images/plugin-SPI-class-diagram-fa432591b833ff178cb662ce352f5b23.png"></p><p>The process from client request  calling the routing parsing moodule is showed as following chart.</p><p>Fig 4- flow chart for Shenyu gateway filter  with parameter processing</p><p><img alt="SPI-flow-diagram" src="/assets/images/SPI-flow-diagram-590f2cd298ae7655330a62a2010b006e.png"></p><ul><li>When startup, the system will load <code>SPI</code> classes from profile and cache them.</li><li>When the client sends a new request to the Shenyu gateway,  will call the corresponding plugin within  the gateway.</li><li>When analyzing real data with routing rules, the  <code>PredicateJudge</code> implementation class  will be invoked according to the contained operator.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="others"></a>Others<a class="hash-link" href="#others" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="examples-of-predicatejudge--judgement"></a>Examples of PredicateJudge  judgement<a class="hash-link" href="#examples-of-predicatejudge--judgement" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="containspredicatejudge---contains-rule"></a>ContainsPredicateJudge- &quot; contains“ rule<a class="hash-link" href="#containspredicatejudge---contains-rule" title="Direct link to heading">#</a></h4><p>For example, giving a <code>ConditionData</code>  with: <code>paramType</code>=&quot;uri&quot;, <code>paramValue</code> 是 &quot;/http/**&quot;,  when using the &quot;contains&quot; relation: <code>ContainsPredicateJudge</code>, the matching result is as follows.</p><table><thead><tr><th><code>ConditionData</code>  (operator=&quot;contains&quot;)</th><th>real data</th><th>judge result</th></tr></thead><tbody><tr><td>paramType=&quot;uri&quot;,    &quot;/http/**&quot;</td><td>&quot;/http/**/test&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/test/http/**/other&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/http1/**&quot;</td><td>false</td></tr></tbody></table><p>About other <code>PredicateJudge</code> implemetantion classes, you  can  refer to the code and test classes.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI code analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.291Z">July 12, 2024</time> · 16 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p><em>Rate limiter</em> is a very important integral of  gateway application, to deal with  high traffic.  When the system is attacked abnormally by a large number of traffic gathered in a short time;  When there are a large number of lower priority request need to be slow down or else it  will effect your high  priority transactions;  Or sometimes your system can not afford the regular traffic; in these  scenarios, we need to start <em>rate limiter</em> component to protect our system,  through rejection, wait, load  shedding,etc,  limit the requests to an acceptable quantities, or only  certain domains (or services) requests can get through.  </p><p>Facing above scenarios, following need to be considered when designing the rate limiter component of an gateway.</p><ol><li>Supports a variety  of rate limiter algorithms and easy to extends.</li><li>Resilient resolvers  which can distinguish traffic by different way, such as  ip, url, even user group  etc.</li><li>High availability, can quickly get allow or reject result from rate limiter</li><li>With fault tolerance against when rate limiter is down, the gateway can continue work.</li></ol><p>This article will first introduce the overall architecture of the rate limiter module in Apache Shenyu, and then focus on the code analysis of rate limiter SPI.</p><blockquote><p>This article based on <code>shenyu-2.4.0</code> version of the source code analysis.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="overall-design-of-ratelimiter"></a>Overall design of RateLimiter<a class="hash-link" href="#overall-design-of-ratelimiter" title="Direct link to heading">#</a></h2><p>Spring <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html" target="_blank" rel="noopener noreferrer">WebFlux</a> is reactive and  non-blocking web framework,  which can benefit throughput and  make applications more resilient. The plugin of <code>Apache Shenyu</code> is based on <code>WebFlux</code>，its rate limiter component is implemented in <code>ratelimiter-plugin</code>. In rate limiter process, the commonly used algorithms are token bucket, leaky bucket, etc.  To speed up concurrency performance,  the counting and calculation logic is treated in Redis, and Java code is responsible for  the transmission of parameters.  When applying Redis, the Lua script can be resident memory,  and be executed as  a whole, so it is atomic. Let alone the reducing of network overhead.  Redis commands abstraction and automatic serialization/deserialization with Redis store is provided in  <a href="https://spring.io/projects/spring-data-redis" target="_blank" rel="noopener noreferrer">Spring Data Redis</a>.   Because of based on reactive framework, the  Spring Redis Reactive is used in <code>ratelimiter-plugin</code>.</p><p> The class diagram of this plugin is as follows, highlighting two packages related to <code>RateLimiter SPI</code>: resolver 和algorithm.</p><p><img alt="ratelimiter-package-diagram" src="/assets/images/ratelimiter-package-diagram-b041571cdf2f8592c23ab33bf07fbc71.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-ratelimiter-spi"></a>Design of RateLimiter SPI<a class="hash-link" href="#design-of-ratelimiter-spi" title="Direct link to heading">#</a></h2><p>High performance issue is  achieved through the architecture of Spring data+ Redis+Lua ,  two <code>SPI</code> are supplied in  <code>ratelimiter-plugin</code>  for the extension of algorithm and key resolver。</p><ul><li>RateLimiterAlgorithm：used for algorithms expansion.</li><li>RateLimiterKeyResolver： used for resolver expansion, to distinguish requests by various information, including ip, url, ect.  </li></ul><p>The profile of SPI is located at  directory of <code>SHENYU_DIRECTORY</code>  (default<code>/META-INF/shenyu</code>).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiterkeyresolver"></a>RateLimiterKeyResolver<a class="hash-link" href="#ratelimiterkeyresolver" title="Direct link to heading">#</a></h3><p>Obtain the critical info of the request used for packet rate limiter，the interface of <code>RateLimiterKeyResolver</code>  is follows：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterKeyResolver {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get Key resolver&#x27;s name.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Key resolver&#x27;s name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getKeyResolverName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * resolve.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param exchange exchange the current server exchange {@linkplain ServerWebExchange}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return rate limiter key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolve(ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code>  registers the current interface as  Apache Shenyu SPI. Method <code>resolve(ServerWebExchange exchange)</code> is used to provide  the resolution way.  Currently there are two key resolvers in  <code>RateLimiterKeyResolver</code>  <code>SPI</code>:<code>WholeKeyResolve</code> and <code>RemoteAddrKeyResolver</code>.  The  resolve method of <code>RemoteAddrKeyResolver</code>is as follows：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String resolve(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Where the resolved key is ip of request.  Based on <code>SPI</code> mechanism and its factory pattern,  new resolver can be easily developed.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiteralgorithm-spi"></a>RateLimiterAlgorithm SPI<a class="hash-link" href="#ratelimiteralgorithm-spi" title="Direct link to heading">#</a></h3><p><code>RateLimiterAlgorithm</code> <code>SPI</code> is used to identify and define different rate limiter algorithms, following is the class diagram of this module.</p><p><img alt="ratelimiteral-class-diagram" src="/assets/images/ratelimiteral-class-diagram-24df4785848602bdc5b321cf609d5cda.png"></p><p>In this module, factory pattern is used , providing interface, abstract class and factory class, and four implementation classes. The <code>lua</code> script corresponding to the implementation class is enumerated in <code>RateLimitEnum</code> and located in  <code>/META-INF/scripts</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterAlgorithm&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisScript&lt;T&gt; getScript();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; getKeys(String id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param script the script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param keys the keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param scriptArgs the script args</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code>  registers the current interface as  Apache Shenyu SPI. There are three methods:</p><ul><li><code>getScript()</code> returns a <code>RedisScript</code> object, which will be passed to Redis.</li><li><code>getKeys(String id)</code>  returns a List contains with  keys.</li><li><code>callback()</code> the callback function which will be executed asynchronously later on, and default is an empty method.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractratelimiteralgorithm"></a>AbstractRateLimiterAlgorithm<a class="hash-link" href="#abstractratelimiteralgorithm" title="Direct link to heading">#</a></h4><p>The template method is implemented in this abstract class, and the reified generics used is <code>List&lt;Long&gt;</code>. Two abstract methods getScriptName()  and getKeyName()  are left for  the implementation class. Following is the code to load <code>lua</code> script.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public RedisScript&lt;List&lt;Long&gt;&gt; getScript() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.initialized.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultRedisScript redisScript = new DefaultRedisScript&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String scriptPath = &quot;/META-INF/scripts/&quot; + getScriptName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(scriptPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setResultType(List.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.script = redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialized.compareAndSet(false, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return script;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>initialized</code>  is an <code>AtomicBoolean</code>  type variable used to indicate whether the <code>lua</code> script is loaded.  If has not been loaded, the system will read specified scripts form <code>META-INF/scripts</code>;  After reading,  specify the result with <code>List</code> type, and set  <code>initialized=true</code>, then returning  <code>RedisScript</code>object.</p><p>The code of <code>getKeys()</code>  in <code>AbstractRateLimiterAlgorithm</code> is  as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String prefix = getKeyName() + &quot;.{&quot; + id;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = prefix + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestampKey = prefix + &quot;}.timestamp&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, timestampKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Two strings are generated in this template method, where the <code>tokenKey</code> will work as Key to a Sorted map in Redis.  </p><p>We can observe from above class diagram that  <code>ConcurrentRateLimiterAlgorithm</code> and <code>SlidingWindowRateLimiterAlgorithm</code>  override <code>getKeys(String id)</code> method  but another two implementation classes not, and use template method in <code>AbstractRateLimiterAlgorithm</code>. Only  in  <code>ConcurrentRateLimiterAlgorithm</code> has override callback() method, the others not.  We will do further analysis in the following.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiteralgorithmfactory"></a>RateLimiterAlgorithmFactory<a class="hash-link" href="#ratelimiteralgorithmfactory" title="Direct link to heading">#</a></h4><p>The  method gets<code>RateLimiterAlgorithm</code> instance  by <code>name</code>  in  <code>RateLimiterAlgorithmFactory</code> is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static RateLimiterAlgorithm&lt;?&gt; newInstance(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Optional.ofNullable(ExtensionLoader.getExtensionLoader(RateLimiterAlgorithm.class).getJoin(name)).orElse(new TokenBucketRateLimiterAlgorithm());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ExtensionLoader</code> of <code>SPI</code> is responsible for loading SPI classes by &quot;name&quot;, if cannot find the specified algorithm class, it will return <code>TokenBucketRateLimiterAlgorithm</code> by default.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="data-access-with-redis"></a>Data access with Redis<a class="hash-link" href="#data-access-with-redis" title="Direct link to heading">#</a></h3><p>Above detailed the  extension interface in <code>RateLimiter</code> <code>SPI</code>. In Apache Shenyu, we use <code>ReactiveRedisTemplate</code>  to perform   Redis processing reactively, which is implemented  in<code>isAllowed()</code> method of <code>RedisRateLimiter</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;RateLimiterResponse&gt; isAllowed(final String id, final RateLimiterHandle limiterHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get parameters that will pass to redis from RateLimiterHandle Object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double replenishRate = limiterHandle.getReplenishRate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double burstCapacity = limiterHandle.getBurstCapacity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double requestCount = limiterHandle.getRequestCount();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the current used RateLimiterAlgorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RateLimiterAlgorithm&lt;?&gt; rateLimiterAlgorithm = RateLimiterAlgorithmFactory.newInstance(limiterHandle.getAlgorithmName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ........</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flux&lt;List&lt;Long&gt;&gt; resultFlux = Singleton.INST.get(ReactiveRedisTemplate.class).execute(script, keys, scriptArgs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFlux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(1L, -1L)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .reduce(new ArrayList&lt;Long&gt;(), (longs, l) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    longs.addAll(l);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return longs;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).map(results -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean allowed = results.get(0) == 1L;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Long tokensLeft = results.get(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new RateLimiterResponse(allowed, tokensLeft);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(throwable -&gt; log.error(&quot;Error occurred while judging if user is allowed by RedisRateLimiter:{}&quot;, throwable.getMessage()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doFinally(signalType -&gt; rateLimiterAlgorithm.callback(script, keys, scriptArgs));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>POJO</code> class <code>RateLimiterHandle</code> wraps the parameters needed in rate limiter, they are <code>algorithName</code>, <code>replenishRate</code>, <code>burstCapacity</code>, <code>requestCount</code>, etc.  First, gets the parameters  that need to be passed into Redis from <code>RateLimiterHandle</code> class. Then obtain the current implementation class from <code>RateLimiterAlgorithmFactory</code>.</p><p>For convenience,  we give an flow image to show the parameters I/O  and execution procedure in Java and Redis respectively.  On the left is the second half of <code>isAllowed</code>() ,  and on the right is the processing of <code>Lua</code> script.</p><p>Following is the execution process of the JAVA code.</p><ol><li><p>Get two keys value in <code>List&lt;String&gt;</code> type from the <code>getKeys()</code> method, the first element  will map to a sorted set in Redis.</p></li><li><p>Set four parameters,  <code>replenishRate</code> ,  <code>burstCapacity</code>,  <code>timestamp</code> (<code>EpochSecond</code>) and <code>requestcount</code>.</p></li><li><p>Calling <code>ReactiveRedisTemplate</code> with the scripts, keys and parameters,  the return a  <code>Flux&lt;List&lt;Long&gt;&gt;</code></p></li><li><p>The  return value is converted from <code>Flux&lt;ArrayList&lt;Long&gt;&gt;</code> to <code>Mono&lt;ArrayList&lt;Long&gt;&gt;</code> the through <code>reduce()</code> of <code>Flux</code> ，and then transform it to <code>Mono&lt;RateLimiterResponse&gt;</code> via <code>map()</code> function.  Returned two data, one is <code>allowed</code> (1-allow, 0- not allowed),  the other is <code>tokensLeft</code>, the number of available remaining request.  </p></li><li><p>As for the fault tolerance,  due to using of reactor non-blocking model, when an error occurs, the fallback  function <code>onErrorResume()</code> will be executed and a new stream <code>(1L, -1L)</code> will  generated by <code>Flux.just,</code> which means  allow the request getting through, and log the error on the side.  </p></li><li><p>After that, performs the  <code>doFinally()</code>  method, that is to execute the callback() method of the implementation class.</p></li></ol><p><img alt="io-with-lua" src="/assets/images/io-with-lua-eefcd28d4b59a8bd0e69e29400018c50.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="four-rate-limiter-algorithms"></a>Four rate limiter algorithms<a class="hash-link" href="#four-rate-limiter-algorithms" title="Direct link to heading">#</a></h2><p>From above we  know that  how the  java code works with Redis in the gateway. In this chapter we briefly analysis some code of the  four rate limiter algorithms, to understand how to develop the interface of  <code>RateLimiter SPI</code>  and work efficiently with Redis.  </p><p>Four rate limiter algorithms are supplied in Apache Shenyu <code>Ratelimit SPI</code>:</p><table><thead><tr><th>Algorithm name</th><th>Java class</th><th>Lua script file</th></tr></thead><tbody><tr><td>Request rate limiter</td><td><code>TokenBucketRateLimiterAlgorithm</code></td><td>request_rate_limiter.lua</td></tr><tr><td>Slide window rate limiter</td><td><code>SlidingWindowRateLimiterAlgorithm</code></td><td>liding_window_request_rate_limiter.lua</td></tr><tr><td>Concurrent rate limiter</td><td><code>ConcurrentRateLimiterAlgorithm</code></td><td>concurrent_request_rate_limiter.lua</td></tr><tr><td>Leaky bucket algorithm</td><td><code>LeakyBucketRateLimiterAlgorithm</code></td><td>request_leaky_rate_limiter.lua</td></tr></tbody></table><ol><li>Token bucket rate limiter： Limiting the traffic according to the number of requests. Assuming that <em>N</em> requests can be passed per second, when requests exceeding <em>N</em> will be rejected.  In implementing of the algorithm, the requests will be grouped by bucket,  the tokens will be generated at an evenly rate.  If  the number of requests is less than the tokens in the bucket, then it is allowed to pass.  The time window is 2* capacity/rate.</li><li>Slide window rate limiter:   Different from token bucket algorithm, its window size is smaller than that of token bucket rate limiter,  which is a capacity/rate.  And move backward one time window at a time. Other rate limiter principles are similar to token bucket.</li><li>Concurrent rate limiter： Strictly limit the concurrent requests to <em>N</em>. Each time when there is a new request, it will check whether the number of concurrent requests is greater than N. If it is less than <code>N</code>, it is allowed to pass through, and the count is increased by 1. When the requests call ends, the signal is released (count minus 1).</li><li>Leaky bucket rate limiter:   In contrast with token bucket algorithm, the leaky bucket algorithm can help to smooths the burst of requests and only allows a pre-defined <em>N</em> number of requests. This limiter can force the output flow at a constant rate of <em>N</em>.  It is based on a leaky bucket model, the leaky water quantity is  time interval*rate.  if the leaky water quantity is greater than the number of has used (represented by <code>key_bucket_count</code>), then clear the bucket, that is, set the <code>key_bucket_count</code> to 0. Otherwise, set <code>key_bucket_count</code>  minus the leaky water quantity.  If the number  (requests + <code>key_bucket_count</code> ) is less than the capacity, then allow the requests passing through.</li></ol><p>Let&#x27;s understand the functionality of  <code>callback()</code> by reading concurrent rate limiter code, and understand the usage of <code>getKeys()</code> through reading the  Lua script of token rate limiter and slide window rate limiter.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="callback-used-in-concurrent-requests-limiter"></a>callback() used in Concurrent requests limiter<a class="hash-link" href="#callback-used-in-concurrent-requests-limiter" title="Direct link to heading">#</a></h3><p>The <code>getKeys()</code>  method of <code>ConcurrentRateLimiterAlgorithm</code> overrides the template method in <code>AbstractRateLimiterAlgorithm</code> ：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = getKeyName() + &quot;.{&quot; + id + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String requestKey = UUIDUtils.getInstance().generateShortUuid();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, requestKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The second element, <code>requestKey</code>  is a long type and non-duplicate  value (generated by a distributed ID generator，it is incremented and smaller than the current time Epochsecond value). The corresponding <code>Lua</code> script in <code>concurrent_request_rate_limiter.lua</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local capacity = tonumber(ARGV[2])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp = tonumber(ARGV[3])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local id = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here <code>id</code>  is <code>requestKey</code>  generated by <code>getKeys()</code> method, it is an <code>uuid</code>(unique value).  Subsequent process is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local count = redis.call(&quot;zcard&quot;, key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if count &lt; capacity then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis.call(&quot;zadd&quot;, key, timestamp, id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count = count + 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed, count }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>First, using <code>zcard</code> command to obtain the cardinality  of the sorted set, and set count equals the  cardinality , if the cardinality is less than the capacity, we will add a new member <code>id</code> (it is an <code>uuid</code>) to the sorted set, with the score of current time(in seconds) . then <code>count =count+1</code>, the cardinality is also incremented by 1 in reality.</p><p>All of the code above is executed in Redis as an atomic transaction.  If there are a large number of concurrent requests from the same key( such as ip) , the cardinality of the sorted set of this key will increasing sharply, when then capacity limit is exceeded, the  service will be denied, that is <code>allowed =0</code>。</p><p>In concurrent requests limiter, It is required to release the semaphore when the request is completed. However, it is not included in Lua script.</p><p>Let&#x27;s see the callback function of  <code>ConcurrentRateLimiterAlgorithm</code>：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton.INST.get(ReactiveRedisTemplate.class).opsForZSet().remove(keys.get(0), keys.get(1)).subscribe();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here gives asynchronous subscription, using <code>ReactiveRedisTemplate</code> to delete the elements  (<code>key</code>,<code>id</code>)  in Redis store. That is once the request operation ends, the semaphore will be released.  This remove operation  cannot be executed in Lua script. This is just what design intention of <code>callback</code> in <code>RateLimiterAlgorithm</code> <code>SPI</code> .</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="getkeys-used--in-token-bucket-rate-limiter"></a>getKeys() used  in token bucket rate limiter<a class="hash-link" href="#getkeys-used--in-token-bucket-rate-limiter" title="Direct link to heading">#</a></h3><p>Following is the corresponding Lua code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local tokens_key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here we omit the code that get the parameters of rate ,capacity, etc.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local fill_time = capacity/rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local ttl = math.floor(fill_time*2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The window size variable(ttl) is approximately  two times of  capacity/rate.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_tokens = tonumber(redis.call(&quot;get&quot;, tokens_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_tokens == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_tokens = capacity</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Get last_tokens from the sorted set, if it not exist, then last_tokens equals capacity.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_refreshed = tonumber(redis.call(&quot;get&quot;, timestamp_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_refreshed == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_refreshed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Get the last refreshed time by the key =timestamp_key from the sorted set, and default 0.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local delta = math.max(0, now-last_refreshed)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local filled_tokens = math.min(capacity, last_tokens+(delta*rate))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = filled_tokens &gt;= requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if allowed then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  new_tokens = filled_tokens - requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The filled_tokens is produced evenly by time interval * rate，if the number of tokens greater than requests, then allowed=1,  and update  new_tokens.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, tokens_key, ttl, new_tokens)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, timestamp_key, ttl, now)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, new_tokens }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here <code>now</code> is  current time parameters passed in,  set <code>tokens_key</code> to hold the string <code>new_tokens</code> and set<code>tokens_key</code> to timeout after <code>ttl</code> of seconds.  Set  <code>timestamp_key</code> to hold the string value <code>now</code>, and expires after <code>ttl</code> seconds.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="getkeys-used--in-sliding-window-rate-limiter"></a>getKeys() used  in sliding window rate limiter<a class="hash-link" href="#getkeys-used--in-sliding-window-rate-limiter" title="Direct link to heading">#</a></h3><p>The  <code>getKeys()</code> in <code>SlidingWindowRateLimiterAlgorithm</code> also overrides the parent class, and the code is consistent with the method in <code>ConcurrentRateLimiterAlgorithm</code></p><p>Following is the Lua code of slide window rate limiter, the  receiving of other parameters is omitted.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_size = tonumber(capacity / rate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_time = 1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here set the window_size to capacity/rate.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_requested = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local exists_key = redis.call(&#x27;exists&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (exists_key == 1) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_requested = redis.call(&#x27;zcard&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Obtain the cardinality(<code>last_requested</code>) of the <code>tokens_key</code> in the sorted set.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local remain_request = capacity - last_requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (last_requested &lt; capacity) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;zadd&#x27;, tokens_key, now, timestamp_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Calculate remaining available <code>remain_request</code> equals  capacity minus <code>last_requested</code> .  If  <code>last_requested</code> less than  capacity ,then allow current requests passing through，add element in the sorted set with (key=<code>timestamp_key</code>, value=<code>now</code>) .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;zremrangebyscore&#x27;, tokens_key, 0, now - window_size / window_time)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;expire&#x27;, tokens_key, window_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, remain_request }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Previously has set <code>window_time</code>=1, using <code>zremrangebyscore</code> command of Redis to remove all the elements in the sorted set stored at  <code>tokens_key</code> with a score in [0,now - window_size / window_time] ,  that is,  move the window a window size. Set the expire time of <code>tokens_key</code>  to <code>window_size</code>.</p><p>In the template method <code>getKeys(final String id)</code>  of <code>AbstractRateLimiterAlgorithm</code>，the second key ( represented y <code>secondKey</code>)  is a  fixed string which concat  the input parameter{id}. As we can see from the above three algorithm codes, in the token bucket algorithm,  <code>secondKey</code> will be updated to the latest time in the Lua code, so it doesn&#x27;t matter what value is passed in.  In the concurrent rate limiter, <code>secondKey</code> will be used as the key to remove Redis data in the java <code>callback</code> method.  In the sliding window algorithm, the  <code>secondKey</code> will be added to the sorted set  as the key of a new element, and will be removed during window sliding.</p><p>That&#x27;s all, when in a new rate limiter algorithm, the <code>getKeys(final String id)</code>method should be carefully designed according to the logic of the algorithm.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-use-ratelimiter-spi"></a>How to use RateLimiter SPI<a class="hash-link" href="#how-to-use-ratelimiter-spi" title="Direct link to heading">#</a></h2><p>The three parameters in <code>doExecute()</code> method of  <code>RateLimiter</code> plugin， <code>exchange</code>  is an web request， <code>chain</code>  is the execution chain of the plugins，<code>selector</code> is the selection parameters，<code>rule</code>  is the  policies or rules of rate limiter setting in the system.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get  the `RateLimiterHandle` parameters from cache </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RateLimiterHandle limiterHandle = RatelimiterRuleHandleCache.getInstance()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //find the resolver name </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolverKey = Optional.ofNullable(limiterHandle.getKeyResolverName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(name -&gt; Optional.of(&quot;-&quot; + RateLimiterKeyResolverFactory.newInstance(name).resolve(exchange)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return redisRateLimiter.isAllowed(rule.getId() + resolverKey, limiterHandle)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(response -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!response.isAllowed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(ShenyuResultEnum.TOO_MANY_REQUESTS.getCode(), ShenyuResultEnum.TOO_MANY_REQUESTS.getMsg(), null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li><p>Firstly get the <code>RateLimiterHandle</code>  parameters from cache.</p></li><li><p>Obtains the corresponding Key resolver by <code>RateLimiterHandle</code> instance.  </p></li><li><p>Reactively executes <code>isAllowed()</code>  method of  <code>RedisRateLimiter</code>.</p></li><li><p>If not allowed, error handling is performed.</p></li><li><p>If the request is allowed, dispatch it to the next process of execution chain.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p><code>RateLimiter</code> plugin is based on <code>Spring WebFlux</code>,and with <code>Apache Shen SPI</code>, with Redis and Lua script to responsible for the critical algorithm and logic process, make it with characteristics of high concurrency and elastic.  As for the <code>RateLimiter SPI</code>.</p><ol><li><code>RateLimiter</code> <code>SPI</code> provides two <code>SPI</code> interface, with interface oriented design and various design patterns, it&#x27;s easy to develop new rate limiter algorithm and key resolver rule.</li><li><code>RateLimiterAlgorithm</code> <code>SPI</code> supplies four rate limiter algorithms, token bucket,concurrency rate limiter, leaky bucket and sliding window rate limiter. When designing rate limiter algorithm, the KEY generation need to be carefully designed according to the algorithm characteristic.  Using Lua script to realize the logic of the algorithm, and  design callback()  method for asynchronous processing when needed.</li><li>Reactive programming, simple and efficient implementation.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/rate-limiter">rate limiter</a><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor">Guide for New Contributors to Start avoid Pitfalls</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.291Z">July 12, 2024</time> · 5 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/61108539?s=400&amp;u=f065b78a2944f2cea9160de7f7df054e2f157867&amp;v=4" alt="Yuxuan Zhang"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer">Yuxuan Zhang</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="preface"></a>Preface<a class="hash-link" href="#preface" title="Direct link to heading">#</a></h2><p>As a first-time developer in the <code>Shenyu</code> community, I encountered some &quot;Pitfalls&quot; that were not mentioned in the tutorials I followed to start and develop the project. I have documented the detailed steps I took to start <code>shenyu</code>, <code>shenyu-dashboard</code>, <code>shenyu-website</code> in this blog, hoping to help more new contributors in the community.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="environmental-preparation"></a>Environmental Preparation<a class="hash-link" href="#environmental-preparation" title="Direct link to heading">#</a></h2><ul><li>Correct local installation of <code>JDK1.8+</code></li><li>Properly install <code>Git</code> locally</li><li>Choose a development tool, this article uses <code>IDEA</code> as an example</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-backend-startup-guide"></a>ShenYu Backend Startup Guide<a class="hash-link" href="#shenyu-backend-startup-guide" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="install-and-configure-maven"></a>Install and Configure Maven<a class="hash-link" href="#install-and-configure-maven" title="Direct link to heading">#</a></h3><p>Maven is a cross-platform project management tool . As the Apache organization&#x27;s top open source projects , its main service for Java-based platform project creation , dependency management and project information management.</p><ol><li><p><a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener noreferrer">Download maven</a> and extract it to a path with no Chinese and no spaces.</p><img src="/img/activities/start-demo-for-contributor/maven-install.png" width="100%" height="100%"></li><li><p>Add the <code>bin</code> directory under the <code>maven</code> directory to the environment variables. For <code>Windows</code>, if the download directory is <code>E:\apache-maven-3.9.1</code>, add <code>E:\apache-maven-3.9.1\bin</code> to the <code>Path</code> system variable.</p></li><li><p>Verify that the installation was successful. Type <code>mvn -v</code> in the cmd window, and if the Maven version and Java version appear, the installation is successful. This is shown below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">mvn -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Maven </span><span class="token number" style="color:#36acaa">3.9</span><span class="token plain">.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">2e178502fcdbffc201671fb2537d0cb4b4cc58f8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Maven home: E:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">apache-maven-3.9.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Java version: </span><span class="token number" style="color:#36acaa">18.0</span><span class="token plain">.1.1, vendor: Oracle Corporation, runtime: C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Program Files</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Java</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">jdk-18.0.1.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Default locale: zh_CN, platform encoding: UTF-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain">OS name: </span><span class="token string" style="color:#e3116c">&quot;windows 10&quot;</span><span class="token plain">, version: </span><span class="token string" style="color:#e3116c">&quot;10.0&quot;</span><span class="token plain">, arch: </span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain">, family: </span><span class="token string" style="color:#e3116c">&quot;windows&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>To speed up the download of project-related dependencies, you need to change the Maven mirrors, here add Aliyun and other mirrors. Change the <code>&lt;mirrors&gt; &lt;/mirrors&gt;</code> tag pair in <code>conf/settings.xml</code> to the following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/groups/public/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/repositories/central/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">name_</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://repo1.maven.org/maven2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit address/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://jcenter.bintray.com/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>and add <code>&lt;localRepository&gt;E:/maven_local_repository&lt;/localRepository&gt;</code> to the next line of <code>&lt;/mirrors&gt;</code> to set the location of Maven local repository. You can specify the exact location yourself.</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pull-shenyu-code"></a>Pull ShenYu Code<a class="hash-link" href="#pull-shenyu-code" title="Direct link to heading">#</a></h3><ol><li><p>Fork <a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer">ShenYu</a> repository on Github to your own repository, where you can develop and commit PRs in the future</p></li><li><p>Use Git to download the repository from the previous step locally:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If prompted for a long file name, execute the following command via the command line:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> config --global core.longpaths </span><span class="token boolean" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-first-start"></a>ShenYu First Start<a class="hash-link" href="#shenyu-first-start" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="preparation"></a>Preparation<a class="hash-link" href="#preparation" title="Direct link to heading">#</a></h4><ol><li><p>Compile with Maven in the <code>shenyu</code> directory:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>Configure IDEA environment. Open <code>shenyu</code> project with IDEA, click <code>File</code> -&gt; <code>Settings</code> in the top left corner, and configure Maven as shown below. Where <code>User settings file</code> select your <code>settings.xml</code> directory, and then <code>Local repository</code> will automatically load the <code>localRepository</code> path set in <code>settings.xml</code>:</p><img src="/img/activities/start-demo-for-contributor/idea-config.png" width="60%" height="60%"></li><li><p>At this point, IDEA will automatically download the project-related dependencies, you need to wait for a while, when finished, as shown in the following figure:</p><img src="/img/activities/start-demo-for-contributor/project-without-example.png" width="60%" height="60%"><p>As you can see, <code>shenyu-e2e</code>, <code>shenyu-examples</code>, <code>shenyu-integrated-test</code> are not marked as Maven projects by IDEA and need to be added manually. Select the <code>pom.xml</code> file in the package and right-click <code>Add as Maven Project</code>.
If the shenyu-e2e build fails, then add the <code>&lt;relativePath&gt;. /pom.xml&lt;/relativePath&gt;</code> to <code>&lt;relativePath/&gt;</code>.</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-gateway-service"></a>Start Gateway Service<a class="hash-link" href="#start-gateway-service" title="Direct link to heading">#</a></h4><ol><li><p>Start the <code>shenyu-admin</code> console (H2 database is used by default)</p><img src="/img/activities/start-demo-for-contributor/admin.png" width="60%" height="60%"></li><li><p>start <code>shenyu-bootstrap</code></p><img src="/img/activities/start-demo-for-contributor/bootstrap.png" width="100%" height="100%"></li></ol><blockquote><p>By this point, the shenyu gateway has been started.</p><p>We can open the browser and access the admin console: <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p><p>Default account: admin , default password: 123456</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-application-service"></a>Start Application Service<a class="hash-link" href="#start-application-service" title="Direct link to heading">#</a></h4><p>Apache ShenYu provides samples of Http, Dubbo, SpringCloud and other applications to access the shenyu gateway, located in the <code>shenyu-example</code> module, here the <code>Http service</code> is used as an example.</p><p>Start <code>shenyu-examples-http</code>。</p><img src="/img/activities/start-demo-for-contributor/shenyu-examples-http.png" width="80%" height="80%"><p>At this point, <code>shenyu-examples-http</code> will automatically register the interface methods annotated with <code>@ShenyuSpringMvcClient</code> and the relevant configuration in application.yml to the gateway. We can open the <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">admin console</a> and see the configuration in <code>Client List -&gt; Proxy -&gt; divide</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="test-http-request"></a>Test Http Request<a class="hash-link" href="#test-http-request" title="Direct link to heading">#</a></h4><p>The following uses the <code>IDEA HTTP Client Plugin</code> to mock http to access http services.</p><ul><li><p>Local access without using shenyu proxy</p><img src="/img/activities/start-demo-for-contributor/shenyu-http-test-api-local.png" width="60%" height="60%"></li><li><p>Use shenyu proxy</p><img src="/img/activities/start-demo-for-contributor/shenyu-http-test-api.png" width="60%" height="60%"></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="use-more-plugins"></a>Use more plugins<a class="hash-link" href="#use-more-plugins" title="Direct link to heading">#</a></h3><p>We can refer to the <a href="/blog/docs/index">official documentation</a> to the left of <code>Plugins collection</code> to use the required plugins.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-front-end-startup-guide"></a>Shenyu Front End Startup Guide<a class="hash-link" href="#shenyu-front-end-startup-guide" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="install-nodejs"></a>Install Node.js<a class="hash-link" href="#install-nodejs" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="download"></a>Download<a class="hash-link" href="#download" title="Direct link to heading">#</a></h4><ol><li><p>Download and install Node.js from <a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">official website</a> and select <code>LTS</code> version.</p></li><li><p>When installing, except for setting the installation path, just keep clicking <code>Next</code>.</p></li><li><p>After the installation is complete, verify at the command line:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">node -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">v12.22.12</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">npm -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6.14</span><span class="token plain">.16</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pull-shenyu-dashboard-code"></a>Pull ShenYu Dashboard Code<a class="hash-link" href="#pull-shenyu-dashboard-code" title="Direct link to heading">#</a></h3><ol><li><p>Fork <a href="https://github.com/apache/shenyu-dashboard" target="_blank" rel="noopener noreferrer">ShenYu Dashboard</a> repository</p></li><li><p>Using Git to download locally</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="front-and-back-end-co-development"></a>Front and Back End Co-development<a class="hash-link" href="#front-and-back-end-co-development" title="Direct link to heading">#</a></h3><ol><li><p>Add <code>enablePrintApiLog: true</code> to the <code>shenyu-admin/src/main/resources/application.yml</code> file in the backend repository <code>shenyu</code> as shown below to show the log of frontend interface calls in the backend console.</p><img src="/img/activities/start-demo-for-contributor/enable-api-log.png" width="60%" height="60%"></li><li><p>Start <code>ShenyuAdminBootstrap</code></p></li><li><p>Switch to the front-end repository <code>shenyu-dashboard</code>, open <code>README</code>, click <code>npm install</code>, <code>npm start</code> or enter the above command from cmd to access the front-end interface via <a href="http://localhost:8000" target="_blank" rel="noopener noreferrer">http://localhost:8000</a>, and display the log of the front-end interface called in the back-end console. Realize the co-development of front-end and back-end.</p><img src="/img/activities/start-demo-for-contributor/admin-log.png" width="60%" height="60%"></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="package-front-end-code"></a>Package Front-end Code<a class="hash-link" href="#package-front-end-code" title="Direct link to heading">#</a></h3><p>Execute the <code>npm build</code> command in <code>README</code> and copy all the generated files from the <code>dist</code> folder to the <code>shenyu-admin/src/main/resources/static/</code> directory in the backend repository.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="contribute-to-shenyu-official-website"></a>Contribute to Shenyu Official Website<a class="hash-link" href="#contribute-to-shenyu-official-website" title="Direct link to heading">#</a></h2><p>Just follow the <code>README</code> in <a href="https://github.com/apache/shenyu-website" target="_blank" rel="noopener noreferrer">shenyu-website</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="tips"></a>Tips<a class="hash-link" href="#tips" title="Direct link to heading">#</a></h3><ol><li>I recommend downloading the <code>LTS</code> version from the <code>Node</code> <a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">website</a>.</li><li><code>Windows</code> systems cannot be deployed, if you want to verify your changes, you can deploy on a Linux virtual machine or server.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/first-start">first-start</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu Start Demo</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.291Z">July 12, 2024</time> · 2 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="environmental-preparation"></a>Environmental preparation<a class="hash-link" href="#environmental-preparation" title="Direct link to heading">#</a></h3><ul><li>Install JDK1.8+ locally</li><li>Install Git locally</li><li>Install Maven locally</li><li>Choose a development tool, such as IDEA</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pull-shenyu-code"></a>Pull ShenYu code<a class="hash-link" href="#pull-shenyu-code" title="Direct link to heading">#</a></h3><p>Use Git to clone code</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/apache/incubator-shenyu.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="compile-code"></a>Compile code<a class="hash-link" href="#compile-code" title="Direct link to heading">#</a></h3><p>Compile with Maven</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> incubator-shenyu</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-the-gateway-service"></a>Start the gateway service<a class="hash-link" href="#start-the-gateway-service" title="Direct link to heading">#</a></h3><p>Use development tools, take IDEA as an example.</p><p>Start <code>shenyu-admin</code> (use H2 database by default)</p><p><img alt="start-demo-admin" src="/assets/images/start-demo-admin-debdd1ee5e979a4892f26e4d54572ead.png"></p><p>Start <code>shenyu-bootstrap</code></p><p><img alt="start-demo-bootstrap" src="/assets/images/start-demo-bootstrap-cafa4d22b0d69bb6ee82c01e7b45d239.png"></p><blockquote><p>At this point, shenyu gateway has been activated.</p><p>We can open the browser and access the admin console: <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-application-service"></a>Start application service<a class="hash-link" href="#start-application-service" title="Direct link to heading">#</a></h3><p>Apache ShenYu provides examples for Http, Dubbo, SpringCloud and other applications to access the shenyu gateway, located in the <code>shenyu-example</code> module. Here we take the Http service as an example.</p><p>If <code>shenyu-example</code> is not marked as a Maven project by IDEA, you can right-click the <code>pom.xml</code> file in the <code>shenyu-example</code> directory to add it as a Maven project.</p><p><img alt="start-demo-maven" src="/assets/images/start-demo-maven-a52eeb99414c79d32a127312a5d22d6f.png"></p><p>Start <code>shenyu-examples-http</code>。</p><p><img alt="start-demo-examples-http" src="/assets/images/start-demo-examples-http-a42235638d82a4be8aeefbb819d419be.png"></p><p>At this time, <code>shenyu-examples-http</code> will automatically register the interface method annotated with <code>@ShenyuSpringMvcClient</code> and the related configuration in application.yml to the gateway. When we open the admin console, you can see the relevant configuration in divide and context-path.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="test-http-request"></a>Test Http request<a class="hash-link" href="#test-http-request" title="Direct link to heading">#</a></h3><p>Now use <code>postman</code> to simulate <code>http</code> to request your <code>http</code> service:</p><p><img alt="start-demo-post-http" src="/assets/images/start-demo-post-http-a7e95883d3147d67e6080236d980d72b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="use-more-plugins"></a>Use more plugins<a class="hash-link" href="#use-more-plugins" title="Direct link to heading">#</a></h3><p>We can refer to <a href="/blog/docs/index">Official Document</a> to use other plugins.</p><p>Here is an example of using the param-mapping plugin.</p><p>Edit the param-mapping plugin in <code>BasicConfig -&gt; Plugin</code> and set <code>status</code>.</p><p><img alt="start-demo-plugin" src="/assets/images/start-demo-plugin-8525f3812e42bed70e28ce23540069b7.png"></p><p>Configure selectors and rules in <code>PluginList -&gt; http process</code>.</p><p><img alt="start-demo-selector" src="/assets/images/start-demo-selector-98b0b1ae460bdbed17edc40ab730a182.png"></p><p><img alt="start-demo-rules" src="/assets/images/start-demo-rules-581013f9d7f0f9996b01aab85efcc8e7.png"></p><p>Then use <code>postman</code> to make an http request to <code>/http/test/payment</code>.</p><p><img alt="start-demo-post-param-mapping" src="/assets/images/start-demo-post-param-mapping-d5d632dc96eb1f0080c451820e8f7df4.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync">Apollo Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.287Z">July 12, 2024</time> · 12 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/hql0312" target="_blank" rel="noopener noreferrer">hql0312</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>This article is based on the source code analysis of version &#x27;shenyu-2.6.1&#x27;. Please refer to the official website for an introduction <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a>.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="admin-management"></a>Admin management<a class="hash-link" href="#admin-management" title="Direct link to heading">#</a></h3><p>Understand the overall process through the process of adding plugins</p><p><img src="/assets/images/Apollo-Sync-b0720ba3b1fe0dfcb554b104a78ce2bd.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="receive-data"></a>Receive Data<a class="hash-link" href="#receive-data" title="Direct link to heading">#</a></h3><ul><li>PluginController.createPlugin()</li></ul><p>Enter the <code>createPlugin()</code> method in the <code>PluginController</code> class, which is responsible for data validation, adding or updating data, and returning result information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/plugin&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @PostMapping(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @RequiresPermissions(&quot;system:plugin:add&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ShenyuAdminResult createPlugin(@Valid @ModelAttribute final PluginDTO pluginDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Call pluginService.createOrUpdate for processing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return ShenyuAdminResult.success(pluginService.createOrUpdate(pluginDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="processing-data"></a>Processing data<a class="hash-link" href="#processing-data" title="Direct link to heading">#</a></h3><ul><li>PluginServiceImpl.createOrUpdate() -&gt; PluginServiceImpl.create()</li></ul><p>Use the <code>create()</code> method in the <code>PluginServiceImpl</code> class to convert data, save it to the database, and publish events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Event publishing object pluginEventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PluginEventPublisher pluginEventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String create(final PluginDTO pluginDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Check if there is a corresponding plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Assert.isNull(pluginMapper.nameExisted(pluginDTO.getName()), AdminConstants.PLUGIN_NAME_IS_EXIST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // check if Customized plugin jar</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!Objects.isNull(pluginDTO.getFile())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assert.isTrue(checkFile(Base64.decode(pluginDTO.getFile())), AdminConstants.THE_PLUGIN_JAR_FILE_IS_NOT_CORRECT_OR_EXCEEDS_16_MB);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Create plugin object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      PluginDO pluginDO = PluginDO.buildPluginDO(pluginDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Insert object into database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (pluginMapper.insertSelective(pluginDO) &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish create event. init plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pluginEventPublisher.onCreated(pluginDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return ShenyuResultMessage.CREATE_SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Complete the data persistence operation in the <code>PluginServiceImpl</code> class, that is, save the data to the database and publish events through <code>pluginEventPublisher</code>.</p><p>The logic of the <code>pluginEventPublisher.onCreated</code> method is to publish the changed event:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public void onCreated(final PluginDO plugin) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish DataChangeEvent events: event grouping (plugins, selectors, rules), event types (create, delete, update), changed data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, DataEventTypeEnum.CREATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collections.singletonList(PluginTransfer.INSTANCE.mapToData(plugin))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish PluginCreatedEvent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publish(new PluginCreatedEvent(plugin, SessionUtil.visitorName()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Publishing change data is completed through <code>publisher.publishEvent()</code>, which is an &#x27;Application EventPublisher&#x27; object with the fully qualified name of &#x27;org. springframework. contentxt.&#x27; Application EventPublisher `. From here, we know that publishing data is accomplished through the Spring related features.</p><blockquote><p>About <code>ApplicationEventPublisher</code>：</p><p>When there is a state change, the publisher calls the <code>publishEvent</code> method of <code>ApplicationEventPublisher</code> to publish an event, the <code>Spring</code> container broadcasts the event to all observers, and calls the observer&#x27;s <code>onApplicationEvent</code> method to pass the event object to the observer. There are two ways to call the <code>publishEvent</code> method. One is to implement the interface, inject the <code>ApplicationEventPublisher</code> object into the container, and then call its method. The other is to call the container directly. There is not much difference between the two methods to publish events.</p><ul><li><code>ApplicationEventPublisher</code>：Publish events；</li><li><code>ApplicationEvent</code>：<code>Spring</code> events，Record the source, time, and data of the event;</li><li><code>ApplicationListener</code>：Event listeners, observers;</li></ul></blockquote><p>In the event publishing mechanism of Spring, there are three objects,</p><p>One is the <code>ApplicationEventPublisher</code> that publishes events, injecting an <code>publisher</code> through a constructor in <code>ShenYu</code>.</p><p>The other object is <code>ApplicationEvent</code>, which is inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last one is <code>ApplicationListener</code>, which is implemented in <code>ShenYu</code> through the <code>DataChangedEventDispatcher</code> class as a listener for events, responsible for handling event objects.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="distribute-data"></a>Distribute data<a class="hash-link" href="#distribute-data" title="Direct link to heading">#</a></h3><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>After the event is published, it will automatically enter the <code>onApplicationEvent()</code> method in the <code>DataChangedEventDispatcher</code> class for event processing.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * When there is a data change, call this method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Traverse data change listeners (only ApolloDataChangedListener will be registered here)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Forward according to different grouping types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case APP_AUTH: // authentication information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case PLUGIN: // Plugin events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // Calling the registered listener object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RULE: // Rule events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case SELECTOR: // Selector event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case META_DATA: // Metadata events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case PROXY_SELECTOR: // Proxy selector event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onProxySelectorChanged((List&lt;ProxySelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case DISCOVER_UPSTREAM: // Registration discovery of downstream list events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onDiscoveryUpstreamChanged((List&lt;DiscoverySyncData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnUpstreamChanged((List&lt;DiscoverySyncData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, call the <code>onApplicationEvent</code> method, then traverse all data change listeners, determine which data type it is, and hand it over to the corresponding data listeners for processing.</p><p><code>ShenYu</code> has grouped all data into the following types: authentication information, plugin information, rule information, selector information, metadata, proxy selector, and downstream event discovery.</p><p>The Data Change Listener here is an abstraction of the data synchronization strategy, processed by specific implementations, and different listeners are processed by different implementations. Currently, Apollo is being analyzed
Listening, so here we only focus on <code>ApolloDataChangedListener</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Inheriting AbstractNodeDataChangedListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedListener extends AbstractNodeDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ApolloDataChangedListener</code> inherits the <code>AbstractNodeDataChangedListener</code> class, which mainly uses key as the base class for storage, such as Apollo, Nacos, etc., while others such as Zookeeper
Consul, etc. are searched in a hierarchical manner using a path.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Using key as the base class for finding storage methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractNodeDataChangedListener implements DataChangedListener { </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected AbstractNodeDataChangedListener(final ChangeData changeData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.changeData = changeData;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AbstractNodeDataChangedListener</code> receives ChangeData as a parameter, which defines the key names for each data stored in Apollo. The data stored in Apollo includes the following data:</p><ul><li>Plugin(plugin)</li><li>Selector(selector)</li><li>Rules(rule)</li><li>Authorization(auth)</li><li>Metadata(meta)</li><li>Proxy selector(proxy.selector)</li><li>Downstream List (discovery)</li></ul><p>These information are specified by the ApolloDataChangedListener constructor:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedListener extends AbstractNodeDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ApolloDataChangedListener(final ApolloClient apolloClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Configure prefixes for several types of grouped data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.RULE_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.AUTH_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.META_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.PROXY_SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.DISCOVERY_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Manipulating objects of Apollo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.apolloClient = apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>DataChangedListener</code> defines the following methods:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Data Change Listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Call when authorization information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onAppAuthChanged(List&lt;AppAuthData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when plugin information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onPluginChanged(List&lt;PluginData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when selector information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onSelectorChanged(List&lt;SelectorData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // Called when metadata information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onMetaDataChanged(List&lt;MetaData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Call when rule information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onRuleChanged(List&lt;RuleData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when proxy selector changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onProxySelectorChanged(List&lt;ProxySelectorData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when downstream information changes are discovered</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onDiscoveryUpstreamChanged(List&lt;DiscoverySyncData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the plugin is processed by <code>DataChangedEventDispatcher</code>, the method <code>listener.onPluginChanged</code> is called. Next, analyze the logic of the object and implement the processing by <code>AbstractNodeDataChangedListener</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractNodeDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Configure prefix as plugin.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String configKeyPrefix = changeData.getPluginDataId() + DefaultNodeConstants.JOIN_POINT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.onCommonChanged(configKeyPrefix, changed, eventType, PluginData::getName, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.debug(&quot;[DataChangedListener] PluginChanged {}&quot;, configKeyPrefix);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Firstly, the key prefix for constructing configuration data is: <code>plugin.</code>, Call <code>onCommonChanged</code> again for unified processing:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private &lt;T&gt; void onCommonChanged(final String configKeyPrefix, final List&lt;T&gt; changedList,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     final DataEventTypeEnum eventType, final Function&lt;? super T, ? extends String&gt; mapperToKey,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     final Class&lt;T&gt; tClass) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Avoiding concurrent operations on list nodes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock reentrantLock = listSaveLockMap.computeIfAbsent(configKeyPrefix, key -&gt; new ReentrantLock());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reentrantLock.lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Current incoming plugin list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;String&gt; changeNames = changedList.stream().map(mapperToKey).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Delete Operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete plugin.${pluginName}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.stream().map(mapperToKey).forEach(removeKey -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        delConfig(configKeyPrefix + removeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Remove the corresponding plugin name from plugin. list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // The plugin.list records the currently enabled list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    delChangedData(configKeyPrefix, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Overload logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Get a list of all plugins in plugin.list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final List&lt;String&gt; configDataNames = this.getConfigDataNames(configKeyPrefix);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Update each currently adjusted plug-in in turn</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.forEach(changedData -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Publish Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If there is more data in the currently stored list than what is currently being passed in, delete the excess data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (configDataNames != null &amp;&amp; configDataNames.size() &gt; changedList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Kick out the currently loaded data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configDataNames.removeAll(changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Delete cancelled data one by one</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configDataNames.forEach(this::delConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Update list data again</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    publishConfig(configKeyPrefix + DefaultNodeConstants.LIST_STR, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Add or update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.forEach(changedData -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Update the newly added plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    putChangeData(configKeyPrefix, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;AbstractNodeDataChangedListener onCommonMultiChanged error &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reentrantLock.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the above logic, it actually includes the handling of full overloading (REFRESH, MYSELF) and increment (Delete, UPDATE, CREATE)</p><p>The plugin mainly includes two nodes:</p><ul><li><code>plugin.list</code> List of currently effective plugins</li><li><code>plugin.${plugin.name}</code> Detailed information on specific plugins
Finally, write the data corresponding to these two nodes into Apollo.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="data-initialization"></a>Data initialization<a class="hash-link" href="#data-initialization" title="Direct link to heading">#</a></h3><p>After starting <code>admin</code>, the current data information will be fully synchronized to <code>Apollo</code>, which is implemented by <code>ApolloDataChangedInit</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Inheriting AbstractDataChangedInit</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedInit extends AbstractDataChangedInit {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Apollo operation object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApolloClient apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApolloDataChangedInit(final ApolloClient apolloClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.apolloClient = apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean notExist() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if nodes such as plugin, auth, meta, proxy.selector exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // As long as one does not exist, it enters reload (these nodes will not be created, why check once?)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Stream.of(ApolloPathConstants.PLUGIN_DATA_ID, ApolloPathConstants.AUTH_DATA_ID, ApolloPathConstants.META_DATA_ID, ApolloPathConstants.PROXY_SELECTOR_DATA_ID).allMatch(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this::dataIdNotExist);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data id not exist boolean.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataId the plugin data id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the boolean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.isNull(apolloClient.getItemValue(pluginDataId));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check if there is data in <code>apollo</code>, and if it does not exist, synchronize it.
There is a bug here because the key determined here will not be created during synchronization, which will cause data to be reloaded every time it is restarted. <a href="https://github.com/apache/shenyu/pull/5435" target="_blank" rel="noopener noreferrer">PR#5435</a></p><p><code>ApolloDataChangedInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>springboot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> are initialized. It is commonly used for initialization operations in projects.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, then perform full data synchronization, including all authentication information, plugin information, rule information, selector information, metadata, proxy selector, and discover downstream events. Mainly, synchronization events are published through <code>eventPublisher</code>. After publishing events through <code>publishEvent()</code>, <code>ApplicationListener</code> performs event change operations, which is referred to as <code>DataChangedEventDispatcher</code> in <code>ShenYu</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Event Publishing</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Full data synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronize auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronize plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //Notify subscribers through the Spring publish/subscribe mechanism (publishing DataChangedEvent)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //Unified monitoring by DataChangedEventDispatcher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //DataChangedEvent comes with configuration grouping type, current operation type, and data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // synchronizing selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronization rules</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronization metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronization Downstream List</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         discoveryService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="bootstrap-synchronization-operation-initialization"></a>Bootstrap synchronization operation initialization<a class="hash-link" href="#bootstrap-synchronization-operation-initialization" title="Direct link to heading">#</a></h3><p>The data synchronization initialization operation on the gateway side mainly involves subscribing to nodes in <code>apollo</code>, and receiving changed data when there are changes. This depends on the <code>listener</code> mechanism of <code>apollo</code>. In <code>ShenYu</code>, the person responsible for <code>Apollo</code> data synchronization is <code>ApolloDataService</code>.
The functional logic of Apollo DataService is completed during the instantiation process: subscribe to the <code>shenyu</code> data synchronization node in Apollo. Implement through the <code>configService.addChangeListener()</code> method;</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataService extends AbstractNodeDataSyncService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApolloDataService(final Config configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;AuthDataSubscriber&gt; authDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;ProxySelectorDataSubscriber&gt; proxySelectorDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;DiscoveryUpstreamDataSubscriber&gt; discoveryUpstreamDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configure the prefix for listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.RULE_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.AUTH_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.META_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.PROXY_SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.DISCOVERY_DATA_ID),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                pluginDataSubscriber, metaDataSubscribers, authDataSubscribers, proxySelectorDataSubscribers, discoveryUpstreamDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Start listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Note: The Apollo method is only responsible for obtaining data from Apollo and adding it to the local cache, and does not handle listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        startWatch();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configure listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        apolloWatchPrefixes();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Firstly, configure the key information that needs to be processed and synchronize it with the admin&#x27;s key. Next, call the <code>startWatch()</code> method to process data acquisition and listening. But in the implementation of Apollo, this method is only responsible for handling data retrieval and setting it to the local cache.
Listening is handled by the <code>apolloWatchPrefixes</code> method</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void apolloWatchPrefixes() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Defining Listeners</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConfigChangeListener listener = changeEvent -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            changeEvent.changedKeys().forEach(changeKey -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final ConfigChange configChange = changeEvent.getChange(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Skip if not changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (configChange == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;apollo watchPrefixes error configChange is null {}&quot;, changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final String newValue = configChange.getNewValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // skip last is &quot;list&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If it is a Key at the end of the list, such as plugin.list, skip it because it is only a list that records the effectiveness and will not be cached locally</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final int lastListStrIndex = changeKey.length() - DefaultNodeConstants.LIST_STR.length();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (changeKey.lastIndexOf(DefaultNodeConstants.LIST_STR) == lastListStrIndex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If it starts with plugin. =&gt; Process plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (changeKey.indexOf(ApolloPathConstants.PLUGIN_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // clear cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCachePluginData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // update cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cachePluginData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with selector. =&gt; Process selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.SELECTOR_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheSelectorData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheSelectorData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with rule. =&gt; Process rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.RULE_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheRuleData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheRuleData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // If it starts with auth. =&gt; Process auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.AUTH_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheAuthData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheAuthData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with meta. =&gt; Process meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.META_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheMetaData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheMetaData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with proxy.selector. =&gt; Process proxy.selector meta</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.PROXY_SELECTOR_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheProxySelectorData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheProxySelectorData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with discovery. =&gt; Process discovery meta</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.DISCOVERY_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheDiscoveryUpstreamData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheDiscoveryUpstreamData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;apollo sync listener change key handler error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchConfigChangeListener = listener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configService.addChangeListener(listener, Collections.emptySet(), ApolloPathConstants.pathKeySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of loading data from the previous admin will only add two keys to the plugin: <code>plugin.list</code> and <code>plugin.${plugin.name}</code>, while <code>plugin.list</code> is a list of all enabled plugins, and the data for this key is in the
There is no data in the local cache, only `plugin${plugin.name} will be  focus.</p><p>At this point, the synchronization logic of bootstrap in <code>apollo</code> has been analyzed.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/apollo">apollo</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync">Nacos Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.287Z">July 12, 2024</time> · 22 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>etcd</code> and <code>Consul</code>. The main content of this article is based on <code>Nacos</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-nacos"></a>1. About Nacos<a class="hash-link" href="#1-about-nacos" title="Direct link to heading">#</a></h3><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer"><code>Nacos</code></a>  can be used for dynamic service discovery and configuration and service management. <code>Shenyu</code> use <code>Nacos</code> as an option to sync data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>We traced the source code from a real case, such as updating a selector data in the <code>Divide</code> plugin to a weight of 90 in a background administration system:</p><p><img src="/assets/images/update-selector-en-4efb58e488bd424a54213d31929d7eb1.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-data"></a>2.1 Accept Data<a class="hash-link" href="#21-accept-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set the current selector data ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>：</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: <code>APP_AUTH</code>, <code>PLUGIN</code>, <code>RULE</code>, <code>SELECTOR</code> and <code>META_DATA</code>.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket;</li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper;</li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>：data synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>：data synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>：data synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>nacos</code> data synchronization source code analysis, so here to <code>NacosDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // some codes omitted here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Nacos listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(NacosConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class NacosListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Data changed listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener nacosDataChangedListener(final ConfigService configService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataChangedListener(configService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Nacos data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the nacos data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public NacosDataInit nacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataInit(configService, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // some codes omitted here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the SpringBoot conditional assembly class. The <code>NacosListener</code> class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>nacos</code> is used for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(NacosConfiguration.class)</code>：import  a configration class <code>NacosConfiguration</code>, which provides a method <code>ConfigService nacosConfigService(final NacosProperties nacosProp)</code> to convert the nacos properties to a bean with the <code>ConfigService</code> type. We would take a look at how to generate the bean and then analyze the property configuration class and the property configuration file.  </p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(NacosProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register configService in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosProp the nacos configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ConfigService {@linkplain ConfigService}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(ConfigService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosProperties nacosProp) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosProp.getAcm() != null &amp;&amp; nacosProp.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use aliyun ACM service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosProp.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use subaccount ACM administrative authority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosProp.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosProp.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosProp.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getUsername())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosProp.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getPassword())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosProp.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There are two steps in this method. Firstly, <code>Properties</code> object is generated and populated with the specified nacos path value and authority values on whether the alyun ACM service is used. Secondly, the nacos factory class would use its static factory method to create a <code>configService</code> object via reflect methods and then populate the object with the <code>Properties</code> object generated in the first step.</p><p>Now, let&#x27;s analyze the <code>NacosProperties</code> class and its counterpart property file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private NacosACMProperties acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUrl() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param url url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUrl(final String url) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.url = url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param username username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(final String username) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param password password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPassword(final String password) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosACMProperties getAcm() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param acm acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAcm(final NacosACMProperties acm) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.acm = acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class NacosACMProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean isEnabled() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param enabled enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEnabled(final boolean enabled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.enabled = enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getEndpoint() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param endpoint endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEndpoint(final String endpoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.endpoint = endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getAccessKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param accessKey accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setAccessKey(final String accessKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.accessKey = accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getSecretKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param secretKey secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setSecretKey(final String secretKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.secretKey = secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the property <code>shenyu.sync.nacos.url</code> is set in the property file, the <code>shenyu</code> admin would choose the <code>nacos</code> to sync data. At this time, the configuration class <code>NacosListener</code> would take effect and a bean with the type <code>NacosDataChangedListener</code> and another bean with the type <code>NacosDataInit</code> would both be generated.</p><ul><li><p><code>nacosDataChangedListener</code>, the bean with the type <code>NacosDataChangedListener</code> , takes the bean with the type <code>ConfigService</code> as a member variable. <code>ConfigService</code> is an api provided by <code>nacos</code> and can be used to send request to nacos server to modify configurations once the <code>nacosDataChangedListener</code> has accepted an event and trigger the callback method.</p></li><li><p><code>nacosDataInit</code>, the bean with the type <code>NacosDataInit</code>, takes the bean <code>configService</code> and the bean <code>syncDataService</code> as memeber variables. It use <code>configService</code> to call the <code>Nacos</code> api to judge whether the configurations have been initialized, and would use <code>syncDataService</code> to refresh them if the answer is no. </p><p>As mentioned above, some operations of the  <code>listener</code> would be triggered in the event handle method <code>onApplicationEvent()</code>. In this example, we update selector data and choose <code>nacos</code> to sync data, so the code about logic of the selector data changes in the <code>NacosDataChangedListener</code> class would be called.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                 // some codes omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-nacos-data-changed-listener"></a>2.4 Nacos Data Changed Listener<a class="hash-link" href="#24-nacos-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>NacosDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, determine the type of action, whether to refresh synchronization or update or create synchronization. Determine whether the node is in <code>etcd</code> based on the current selector data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Use nacos to push data changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateSelectorMap(getConfig(NacosPathConstants.SELECTOR_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SELECTOR_MAP.keySet().removeAll(SELECTOR_MAP.keySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishConfig(NacosPathConstants.SELECTOR_DATA_ID, SELECTOR_MAP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This is the core part. The variable <code>changed</code> represents the list , which needs to be updated, with the elements of the <code>SelectorData</code> type. The variable <code>eventType</code> represents the event type. The variable <code>SELECTOR_MAP</code> is with the type <code>ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt;</code>, so the key of the map is with the <code>String</code> type and the value is the selector list of this plugin.  The value of the constant <code>NacosPathConstants.SELECTOR_DATA_ID</code> is <code>shenyu.selector.json</code>. The steps are as follows, firstly, use the method <code>getConfig</code> to call the api of <code>Nacos</code> to fetch the config with the <code>group</code> value of <code>shenyu.selector.json</code> from <code>Nacos</code> and call the <code>updateSelectorMap</code> method to use the config fetched above to update the <code>SELECTOR_MAP</code> so that the we refresh the selector config from <code>Nacos</code>. Secondly, we can update <code>SELECTOR_MAP</code> according to the event type and then use the <code>publishConfig</code> method to call the <code>Nacos</code> api to update all the config with the <code>group</code> value of <code>shenyu.selector.json</code>.</p><p>As long as the changed data is correctly written to the <code>Nacos</code> node, the <code>admin</code> side of the operation is complete. </p><p>In our current case, updating one of the selector data in the <code>Divide</code> plugin with a weight of 90 updates specific nodes in the graph.</p><p><img src="/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>We series the above update flow with a sequence diagram.</p><p><img src="/assets/images/nacos-sync-sequence-admin-en-826456f35e436cb61d20b07a883532c5.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume that the ShenYu gateway is already running properly, and the data synchronization mode is also <code>nacos</code>. How does the gateway receive and process the selector data after updating it on the <code>admin</code> side and sending the changed data to <code>nacos</code>? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-nacossyncdataservice-accept-data"></a>3.1 NacosSyncDataService Accept Data<a class="hash-link" href="#31-nacossyncdataservice-accept-data" title="Direct link to heading">#</a></h4><p>The gateway side use <code>NacosSyncDataService</code> to watch <code>nacos</code> and fetch the data update, but before we dive into this part, let us take a look on how the bean with the type <code>NacosSyncDataService</code> is generated. The answer is it&#x27;s defined in the Spring config class <code>NacosSyncDataConfiguration</code>. Let&#x27;s focus on the annotation <code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code> on the class <code>NacosSyncDataConfiguration</code> again. We have met this annotation when we  analyzed the <code>NacosListener</code> class on the <code>Admin</code> side before, this config class would take effect only and if only the condition on this annotation is matched. In other words, when we have the config as below on the gateway side, the gateway would use <code>nacos</code> to sync data and the config class <code>NacosSyncDataConfiguration</code> would take effect.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(NacosSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(NacosSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService     the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos config service config service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosConfig the nacos config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosConfig nacosConfig) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosConfig.getAcm() != null &amp;&amp; nacosConfig.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosConfig.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosConfig.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosConfig.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosConfig.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosConfig.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getUsername() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosConfig.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getPassword() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosConfig.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http config http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosConfig nacosConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s focus on the part of code above which is about the  generation of the bean <code>nacosSyncDataService</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As we can see, the bean is generated by the construction method of the Class <code>NacosSyncDataService</code>. Let&#x27;s dive into the construction method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public NacosSyncDataService(final ConfigService configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(configService, pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.PLUGIN_DATA_ID, this::updatePluginMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.SELECTOR_DATA_ID, this::updateSelectorMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.RULE_DATA_ID, this::updateRuleMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.META_DATA_ID, this::updateMetaDataMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.AUTH_DATA_ID, this::updateAuthMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void watcherData(final String dataId, final OnChange oc) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Listener listener = new Listener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void receiveConfigInfo(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                oc.change(configInfo);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Executor getExecutor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        oc.change(getConfigAndSignListener(dataId, listener));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LISTENERS.computeIfAbsent(dataId, key -&gt; new ArrayList&lt;&gt;()).add(listener);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As we can see, the construction method calls the <code>start</code> method and calls the <code>watcherData</code> method to create a listener which relates itself to a callback method <code>oc</code>, since we&#x27;re analyzing the changes on the component with the <code>selector</code> type, the relative callback method is <code>updateSelectorMap</code>. This callback method is used to handle data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-handle-data"></a>3.2 Handle Data<a class="hash-link" href="#32-handle-data" title="Direct link to heading">#</a></h4><ul><li>NacosCacheHandler.updateSelectorMap()</li></ul><p>The data is not null, and caching the selector data is again handled by <code>PluginDataSubscriber</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateSelectorMap(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; selectorDataList = GsonUtils.getInstance().toObjectMapList(configInfo, SelectorData.class).values().stream().flatMap(Collection::stream).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDataList.forEach(selectorData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.unSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.onSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (JsonParseException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;sync selector data have error:&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code> is an interface, it is only a <code>CommonPluginDataSubscriber</code> implementation class, responsible for data processing plugin, selector and rules.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-common-plugin-data-subscriber"></a>3.3 Common Plugin Data Subscriber<a class="hash-link" href="#33-common-plugin-data-subscriber" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.unSelectorSubscribe()</li><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>unSelectorSubscribe()</code>and<code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void unSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.DELETE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-data-cached-to-memory"></a>3.4 Data cached to Memory<a class="hash-link" href="#34-data-cached-to-memory" title="Direct link to heading">#</a></h4><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracking, and through a practical case, in the <code>admin</code> end to update a selector data, the <code>ZooKeeper</code> data synchronization process analysis is clear.</p><p>Let&#x27;s series the data synchronization process on the gateway side through the sequence diagram:</p><p><img src="/assets/images/nacos-sync-sequence-gateway-en-be485f797e80f6c71e910d72e41affdc.png"></p><p>The data synchronization process has been analyzed. In order to prevent the synchronization process from being interrupted, other logic is ignored during the analysis. We have analyzed the process of  gateway synchronization operation initialization in the <code>start</code> method of <code>NacosSyncDataService</code> class. We also need to analyze the process of Admin synchronization data initialization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin-data-sync--initialization"></a>4. Admin Data Sync  initialization<a class="hash-link" href="#4-admin-data-sync--initialization" title="Direct link to heading">#</a></h3><p>On the <code>admin</code> side, the bean with the type <code>NacosDataInit</code>, is defined and generated in the <code>NacosListener</code>, if the configuration of the admin side decides to use <code>nacos</code> to sync data, when <code>admin</code> starts, the current data will be fully synchronized to <code>nacos</code>, the implementation logic is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(NacosDataInit.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConfigService configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService the nacos config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginDataId = NacosPathConstants.PLUGIN_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authDataId = NacosPathConstants.AUTH_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataId = NacosPathConstants.META_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dataIdNotExist(pluginDataId) &amp;&amp; dataIdNotExist(authDataId) &amp;&amp; dataIdNotExist(metaDataId)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group = NacosPathConstants.GROUP;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long timeout = NacosPathConstants.DEFAULT_TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return configService.getConfig(pluginDataId, group, timeout) == null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NacosException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Get data from nacos error.&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check whether there is data in <code>nacos</code>, if not, then synchronize.</p><p><code>NacosDataInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>SpringBoot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> initializations and is often used for initialization operations in a project.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, and then perform full data synchronization, all authentication information, plugin information, selector information, rule information, and metadata information. Synchronous events are published primarily through <code>eventPublisher</code>. After publishing the event via <code>publishEvent()</code>, the <code>ApplicationListener</code> performs the event change operation. In <code>ShenYu</code> is mentioned in <code>DataChangedEventDispatcher</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * sync all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-summary"></a>5. Summary<a class="hash-link" href="#5-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, <code>nacos</code> data synchronization principle source code analysis. The main knowledge points involved are as follows:</p><ul><li><p>Data synchronization based on <code>nacos</code> is mainly implemented through <code>watch</code> mechanism;</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of <code>SpringBoot</code> and <code>starter</code> loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/nacos">nacos</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcd Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.287Z">July 12, 2024</time> · 18 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>Etcd</code> and <code>Consul</code>. The main content of this article is based on <code>Etcd</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-etcd"></a>1. About Etcd<a class="hash-link" href="#1-about-etcd" title="Direct link to heading">#</a></h3><p><a href="https://etcd.io" target="_blank" rel="noopener noreferrer">Etcd</a> is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>We traced the source code from a real case, such as updating a selector data in the <code>Divide</code> plugin to a weight of 90 in a background administration system:</p><p><img src="/assets/images/update-selector-en-4efb58e488bd424a54213d31929d7eb1.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-data"></a>2.1 Accept Data<a class="hash-link" href="#21-accept-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set the current selector data ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>：</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: <code>APP_AUTH</code>, <code>PLUGIN</code>, <code>RULE</code>, <code>SELECTOR</code> and <code>META_DATA</code>.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket;</li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper;</li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>：data synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>：data synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>：data synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>Etcd</code> data synchronization source code analysis, so here to <code>EtcdDataDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data Sync Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * By springboot conditional assembly</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Etcd listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(EtcdProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class EtcdListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public EtcdClient etcdClient(final EtcdProperties etcdProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Client client = Client.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .endpoints(etcdProperties.getUrl())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdClient(client);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param etcdClient the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdDataDataChangedListener(etcdClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param etcdClient        the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the etcd data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(EtcdDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdDataInit(etcdClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // other code is omitted......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the SpringBoot conditional assembly class. The <code>EtcdListener</code> class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>etcd</code> is used for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     etcd:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties(EtcdProperties.class)</code>：import <code>EtcdProperties</code>; The properties in the class <code>EtcdProperties</code> is relative to the properties which is with <code>shenyu.sync.etcd</code> as prefix in the configuration file.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> @Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.etcd&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the <code>shenyu.sync.etcd.url</code> property is set in the configuration file, <code>Admin</code> would use the <code>etcd</code> data synchronization, <code>EtcdListener</code> is generated and the beans with type <code>EtcdClient</code>, <code>EtcdDataDataChangedListener</code> and <code>EtcdDataInit</code> would also be generated. </p><ul><li>The bean with the type <code>EtcdClient</code> would be generated, named <code>etcdClient</code>. This bean configues the connection properties of the <code>etcd</code> server based on the configuration file and can operate the <code>etcd</code>nodes directly.</li><li>The bean with the type <code>EtcdDataDataChangedListener</code> would be generated, named <code>etcdDataDataChangedListener</code>.  This bean use the bean <code>etcdClient</code> as a member variable and so when the event is listened, <code>etcdDataDataChangedListener</code> would call the callback method and use the <code>etcdClient</code>  to operate the <code>etcd</code> nodes.</li><li>The bean with the type <code>EtcdDataInit</code> would be generated, named <code>etcdDataInit</code>. This bean use the bean <code>etcdClient</code> and <code>syncDataService</code> as member variables, and use <code>etcdClient</code> to judge whether the data are initialized, if not, would use <code>syncDataService</code> to refresh data. We would dive into the details later.       </li></ul><p>So in the event handler <code>onApplicationEvent()</code>, it goes to the corresponding <code>listener</code>. In our case, it is a selector data update, data synchronization is <code>etcd</code>, so, the code will enter the <code>EtcdDataDataChangedListener</code> selector data change process.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // what kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // other code logic is omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // In our case, will enter the EtcdDataDataChangedListener selector data change process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-etcd-data-changed-listener"></a>2.4 Etcd Data Changed Listener<a class="hash-link" href="#24-etcd-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>EtcdDataDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, determine the type of action, whether to refresh synchronization or update or create synchronization. Determine whether the node is in <code>etcd</code> based on the current selector data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataDataChangedListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            etcdClient.deleteEtcdPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                etcdClient.delete(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //create or update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This part is very important. The variable <code>changed</code> represents the <code>SelectorData</code> list, the variable <code>eventType</code> reprents the event type. When the event type is <code>REFRESH</code> and the <code>SelectorData</code> has changed, all the <code>selector</code> nodes under this <code>plugin</code> would be deleted in <code>etcd</code>. We should notice that the condition that the <code>SelectorData</code> has changed is necessary, otherwise a bug would appear that all the selector nodes would be deleted when no <code>SelectorData</code> data has changed. </p><p>As long as the changed data is correctly written to the <code>etcd</code> node, the <code>admin</code> side of the operation is complete. </p><p>In our current case, updating one of the selector data in the <code>Divide</code> plugin with a weight of 90 updates specific nodes in the graph.</p><p><img src="/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>We series the above update flow with a sequence diagram.</p><p><img src="/assets/images/etcd-sync-sequence-admin-en-29e7ea74b69fcc2faa148fc0459fc16d.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume that the ShenYu gateway is already running properly, and the data synchronization mode is also <code>etcd</code>. How does the gateway receive and process the selector data after updating it on the admin side and sending the changed data to etcd? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-etcdclient-accept-data"></a>3.1 EtcdClient Accept Data<a class="hash-link" href="#31-etcdclient-accept-data" title="Direct link to heading">#</a></h4><ul><li>EtcdClient.watchDataChange()</li></ul><p>There is a <code>EtcdSyncDataService</code> class on the gateway, which subscribing to the data node through <code>etcdClient</code> and can sense when the data changes.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      etcdClient.watchDataChange(path, (updateNode, updateValue) -&gt; cacheSelectorData(updateValue),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              this::unCacheSelectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //other codes omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Etcd&#x27;s  <code>Watch</code> mechanism notifies subscribing clients of node changes. In our case, updating the selector information goes to the <code>watchDataChange()</code> method. <code>cacheSelectorData()</code> is used to process data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-handle-data"></a>3.2 Handle Data<a class="hash-link" href="#32-handle-data" title="Direct link to heading">#</a></h4><ul><li>EtcdSyncDataService.cacheSelectorData()</li></ul><p>The data is not null, and caching the selector data is again handled by <code>PluginDataSubscriber</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code> is an interface, it is only a <code>CommonPluginDataSubscriber</code> implementation class, responsible for data processing plugin, selector and rules.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-common-plugin-data-subscriber"></a>3.3 Common Plugin Data Subscriber<a class="hash-link" href="#33-common-plugin-data-subscriber" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-data-cached-to-memory"></a>3.4 Data cached to Memory<a class="hash-link" href="#34-data-cached-to-memory" title="Direct link to heading">#</a></h4><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracking, and through a practical case, in the <code>admin</code> end to update a selector data, the <code>ZooKeeper</code> data synchronization process analysis is clear.</p><p>Let&#x27;s series the data synchronization process on the gateway side through the sequence diagram:</p><p><img src="/assets/images/etcd-sync-sequence-gateway-en-4da1d7160168a3ee75741e84d7298e0d.png"></p><p>The data synchronization process has been analyzed. In order to prevent the synchronization process from being interrupted, other logic is ignored during the analysis. We also need to analyze the process of Admin synchronization data initialization and gateway synchronization operation initialization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin-data-sync--initialization"></a>4. Admin Data Sync  initialization<a class="hash-link" href="#4-admin-data-sync--initialization" title="Direct link to heading">#</a></h3><p>When <code>admin</code> starts, the current data will be fully synchronized to <code>etcd</code>, the implementation logic is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataInit.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void run(final String... args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!etcdClient.exists(pluginPath) &amp;&amp; !etcdClient.exists(authPath) &amp;&amp; !etcdClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.info(&quot;Init all data from database&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check whether there is data in <code>etcd</code>, if not, then synchronize.</p><p><code>EtcdDataInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>SpringBoot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> initializations and is often used for initialization operations in a project.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, and then perform full data synchronization, all authentication information, plugin information, selector information, rule information, and metadata information. Synchronous events are published primarily through <code>eventPublisher</code>. After publishing the event via <code>publishEvent()</code>, the <code>ApplicationListener</code> performs the event change operation. In <code>ShenYu</code> is mentioned in <code>DataChangedEventDispatcher</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * sync all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-gateway-data-sync-init"></a>5. Gateway Data Sync Init<a class="hash-link" href="#5-gateway-data-sync-init" title="Direct link to heading">#</a></h3><p>The initial operation of data synchronization on the gateway side is mainly the node in the subscription <code>etcd</code>. When there is a data change, the changed data will be received. This relies on the <code>Watch</code> mechanism of <code>etcd</code>. In <code>ShenYu</code>, the one responsible for <code>etcd</code> data synchronization is <code>EtcdSyncDataService</code>, also mentioned earlier.</p><p>The function logic of <code>EtcdSyncDataService</code> is completed in the process of instantiation: the subscription to <code>Shenyu</code> data synchronization node in <code>etcd</code> is completed. Subscription here is divided into two kinds, one kind is existing node data updated above, through this <code>etcdClient.subscribeDataChanges()</code> method; Another kind is under the current node, add or delete nodes change namely child nodes, it through <code>etcdClient.subscribeChildChanges()</code> method.</p><p><code>EtcdSyncDataService</code> code is a bit too much, here we use plugin data read and subscribe to track, other types of data operation principle is the same.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Zookeeper cache manager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient             the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdSyncDataService(final EtcdClient etcdClient, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.etcdClient = etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; pluginZKs = etcdClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!updateNode.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                watcherAll(updateNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePluginData(etcdClient.get(pluginPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void cachePluginData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(pluginData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(data -&gt; Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -&gt; e.onSubscribe(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataPath = buildRealPath(pluginPath, updatePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataStr = etcdClient.get(dataPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Optional.ofNullable(data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .ifPresent(d -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSubscribe(d)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, deleteNode -&gt; deletePlugin(pluginName));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above source code is given comments, I believe you can understand. The main logic for subscribing to plug-in data is as follows:</p><blockquote><ol><li>Create the current plugin path</li><li>Read the current node data on etcd and deserialize it</li><li>The plugin data is cached in the gateway memory</li><li>Subscribe to the plug-in node</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-summary"></a>6. Summary<a class="hash-link" href="#6-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, <code>etcd</code> data synchronization principle source code analysis. The main knowledge points involved are as follows:</p><ul><li><p>Data synchronization based on <code>etcd</code> is mainly implemented through <code>watch</code> mechanism;</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of <code>SpringBoot</code> and <code>starter</code> loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/etcd">etcd</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Http Long Polling Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-07-12T11:34:56.287Z">July 12, 2024</time> · 31 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>etcd</code> and <code>Consul</code>. The main content of this article is based on <code>http long poll</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.5.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-http-long-polling"></a>1. Http Long Polling<a class="hash-link" href="#1-http-long-polling" title="Direct link to heading">#</a></h3><p>Here is a direct quote from the official website with the relevant description.</p><blockquote><p>The mechanism of <code>Zookeeper</code> and <code>WebSocket</code> data synchronization is relatively simple, while <code>Http long polling</code> is more complex. <code>Apache ShenYu</code> borrowed the design ideas of <code>Apollo</code> and <code>Nacos</code>, took their essence, and implemented <code>Http long polling</code> data synchronization function by itself. Note that this is not the traditional <code>ajax</code> long polling!</p></blockquote><p><img src="/assets/images/http-long-polling-en-6d21af33dd02e70f631cddca7aa9d387.png"></p><p><code>Http Long Polling</code> mechanism as shown above, <code>Apache ShenYu</code> gateway active request <code>shenyu-admin</code> configuration service, read timeout time is <code>90s</code>, means that the gateway layer request configuration service will wait at most <code>90s</code>, so as to facilitate <code>shenyu-admin</code> configuration service timely response to change data, so as to achieve quasi real-time push.</p><p>The <code>Http long polling</code> mechanism is initiated by the gateway requesting <code>shenyu-admin</code>, so for this source code analysis, we start from the gateway side.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-gateway-data-sync"></a>2. Gateway Data Sync<a class="hash-link" href="#2-gateway-data-sync" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-load-configuration"></a>2.1 Load Configuration<a class="hash-link" href="#21-load-configuration" title="Direct link to heading">#</a></h4><p>The <code>Http long polling</code> data synchronization configuration is loaded through <code>spring boot starter</code> mechanism when we introduce the relevant dependencies and have the following configuration in the configuration file.</p><p>Introduce dependencies in the <code>pom</code> file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!--shenyu data sync start use http--&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spring-boot-starter-sync-data-http</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Add the following configuration to the <code>application.yml</code> configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the gateway is started, the configuration class <code>HttpSyncDataConfiguration</code> is executed, loading the corresponding <code>Bean</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Http sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HttpSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(value = HttpConfig.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Rest template.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param httpConfig the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the rest template</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RestTemplate restTemplate(final HttpConfig httpConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        OkHttp3ClientHttpRequestFactory factory = new OkHttp3ClientHttpRequestFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setConnectTimeout(Objects.isNull(httpConfig.getConnectionTimeout()) ? (int) HttpConstants.CLIENT_POLLING_CONNECT_TIMEOUT : httpConfig.getConnectionTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setReadTimeout(Objects.isNull(httpConfig.getReadTimeout()) ? (int) HttpConstants.CLIENT_POLLING_READ_TIMEOUT : httpConfig.getReadTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setWriteTimeout(Objects.isNull(httpConfig.getWriteTimeout()) ? (int) HttpConstants.CLIENT_POLLING_WRITE_TIMEOUT : httpConfig.getWriteTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new RestTemplate(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * AccessTokenManager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param httpConfig   the http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param restTemplate the rest template.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the access token manager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AccessTokenManager accessTokenManager(final HttpConfig httpConfig, final RestTemplate restTemplate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new AccessTokenManager(restTemplate, httpConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param httpConfig         the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber   the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param restTemplate       the rest template</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers    the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers    the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param accessTokenManager the access token manager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService httpSyncDataService(final ObjectProvider&lt;HttpConfig&gt; httpConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;RestTemplate&gt; restTemplate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;AccessTokenManager&gt; accessTokenManager) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use http long pull sync shenyu data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new HttpSyncDataService(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(httpConfig.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(pluginSubscriber.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(restTemplate.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                authSubscribers.getIfAvailable(Collections::emptyList),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(accessTokenManager.getIfAvailable())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>HttpSyncDataConfiguration</code> is the configuration class for <code>Http long polling</code> data synchronization, responsible for creating <code>HttpSyncDataService</code> (responsible for the concrete implementation of <code>http</code> data synchronization) 、 <code>RestTemplate</code> and <code>AccessTokenManager</code> (responsible for the access token processing). It is annotated as follows.</p><ul><li><code>@Configuration</code>: indicates that this is a configuration class.</li><li><code>@ConditionalOnClass(HttpSyncDataService.class)</code>: conditional annotation indicating that the class <code>HttpSyncDataService</code> is to be present.</li><li><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</code>: conditional annotation to have the property <code>shenyu.sync.http.url</code> configured.</li><li><code>@EnableConfigurationProperties(value = HttpConfig.class)</code>: indicates that the annotation <code>@ConfigurationProperties(prefix = &quot;shenyu.sync.http&quot;)</code> on <code>HttpConfig</code> will take effect, and the configuration class <code>HttpConfig</code> will be injected into the Ioc container.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-property-initialization"></a>2.2 Property initialization<a class="hash-link" href="#22-property-initialization" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService</li></ul><p>In the constructor of <code>HttpSyncDataService</code>, complete the property initialization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // omitted attribute field ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpSyncDataService(final HttpConfig httpConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final RestTemplate restTemplate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final List&lt;AuthDataSubscriber&gt; authDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final AccessTokenManager accessTokenManager) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 1. accessTokenManager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.accessTokenManager = accessTokenManager;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 2. create data refresh factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.factory = new DataRefreshFactory(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 3. shenyu-admin url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(httpConfig.getUrl()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 4. restTemplate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.restTemplate = restTemplate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 5. start a long polling task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Other functions and related fields are omitted from the above code, and the initialization of the properties is done in the constructor, mainly.</p><ul><li><p>the role of <code>accessTokenManager</code> is to request <code>admin</code> and update the <code>access token</code> regularly.</p></li><li><p>creating data processors for subsequent caching of various types of data (plugins, selectors, rules, metadata and authentication data).</p></li><li><p>obtaining the <code>admin</code> property configuration, mainly to obtain the <code>url</code> of the <code>admin</code>, <code>admin</code> with possible clusters, multiple split by a comma <code>(,)</code>.</p></li><li><p>using <code>RestTemplate</code>, for launching requests to <code>admin</code>.</p></li><li><p>Start the long polling task.</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-start-the-long-polling-task"></a>2.3 Start the long polling task.<a class="hash-link" href="#23-start-the-long-polling-task" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService#start()</li></ul><p>In the <code>start()</code> method, two things are done, one is to get the full amount of data, that is, to request the <code>admin</code> side to get all the data that needs to be synchronized, and then cache the acquired data into the gateway memory. The other is to open a multi-threaded execution of a long polling task.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It could be initialized multiple times, so you need to control that.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch all group configs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Initial startup, get full data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // one backend service, one thread</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ThreadPoolExecutor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // start long polling, each server creates a thread to listen for changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="231-fetch-data"></a>2.3.1 Fetch Data<a class="hash-link" href="#231-fetch-data" title="Direct link to heading">#</a></h5><ul><li>HttpSyncDataService#fetchGroupConfig()</li></ul><p><code>ShenYu</code> groups all the data that needs to be synchronized, there are 5 data types, namely plugins, selectors, rules, metadata and authentication data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum ConfigGroupEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    APP_AUTH, // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PLUGIN, // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RULE, // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECTOR, // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA; // meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>admin</code> may be a cluster, and here a request is made to each <code>admin</code> in a round-robin fashion, and if one succeeds, then the operation to get the full amount of data from the <code>admin</code> and cache it to the gateway is executed successfully. If there is an exception, the request is launched to the next <code>admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void fetchGroupConfig(final ConfigGroupEnum... groups) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It is possible that admins are clustered, and here requests are made to each admin by means of a loop.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int index = 0; index &lt; this.serverList.size(); index++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String server = serverList.get(index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // do execute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.doFetchGroupConfig(server, groups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If you have a success, you are successful and can exit the loop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // An exception occurs, try executing the next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The last one also failed to execute, throwing an exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no available server, throw exception.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (index &gt;= serverList.size() - 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw e;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.warn(&quot;fetch config fail, try another one: {}&quot;, serverList.get(index + 1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doFetchGroupConfig()</li></ul><p>In this method, the request parameters are first assembled, then the request is launched through <code>httpClient</code> to <code>admin</code> to get the data, and finally the obtained data is updated to the gateway memory.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Launch a request to the admin backend management system to get all synchronized data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doFetchGroupConfig(final String server, final ConfigGroupEnum... groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. build request parameters, all grouped enumeration types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuilder params = new StringBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum groupKey : groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            params.append(&quot;groupKeys&quot;).append(&quot;=&quot;).append(groupKey.name()).append(&quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin url:  /configs/fetch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_FETCH + &quot;?&quot; + StringUtils.removeEnd(params.toString(), &quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;request configs: [{}]&quot;, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpHeaders headers = new HttpHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set accessToken</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpEntity&lt;String&gt; httpEntity = new HttpEntity&lt;&gt;(headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. get a request for change data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            json = this.restTemplate.exchange(url, HttpMethod.GET, httpEntity, String.class).getBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String message = String.format(&quot;fetch config fail from server[%s], %s&quot;, url, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.warn(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update local cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Update data in gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean updated = this.updateCacheWithJson(json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (updated) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.debug(&quot;get latest configs: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // not updated. it is likely that the current config server has not been updated yet. wait a moment.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;The config of the server[{}] has not been updated or is out of date. Wait for 30s to listen for changes again.&quot;, server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // No data update on the server side, just wait 30s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadUtils.sleep(TimeUnit.SECONDS, 30);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>From the code, we can see that the <code>admin</code> side provides the interface to get the full amount of data is <code>/configs/fetch</code>, so we will not go further here and put it in the later analysis.</p><p>If you get the result data from <code>admin</code> and update it successfully, then this method is finished. If there is no successful update, then it is possible that there is no data update on the server side, so wait <code>30s</code>.</p><p>Here you need to explain in advance, the gateway in determining whether the update is successful, there is a comparison of the data operation, immediately mentioned.</p><ul><li>HttpSyncDataService#updateCacheWithJson()</li></ul><p>Update the data in the gateway memory. Use <code>GSON</code> for deserialization, take the real data from the property <code>data</code> and give it to <code>DataRefreshFactory</code> to do the update.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean updateCacheWithJson(final String json) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Using GSON for deserialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject jsonObject = GSON.fromJson(json, JsonObject.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // if the config cache will be updated?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory.executor(jsonObject.getAsJsonObject(&quot;data&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataRefreshFactory#executor()</li></ul><p>Update the data according to different data types and return the updated result. The specific update logic is given to the <code>dataRefresh.refresh()</code> method. In the update result, one of the data types is updated, which means that the operation has been updated.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class DataRefreshFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean executor(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Boolean&gt; result = ENUM_MAP.values().parallelStream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(dataRefresh -&gt; dataRefresh.refresh(data))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // one of the data types is updated, which means that the operation has been updated.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.stream().anyMatch(Boolean.TRUE::equals);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#refresh()</li></ul><p>The data update logic uses the template method design pattern, where the generic operation is done in the abstract method and the different implementation logic is done by subclasses. 5 data types have some differences in the specific update logic, but there is also a common update logic, and the class diagram relationship is as follows.</p><p><img src="/assets/images/data-refresh-a5628c71ea221ffb0a7a45f4ed40ae0e.png"></p><p>In the generic <code>refresh()</code> method, it is responsible for data type conversion, determining whether an update is needed, and the actual data refresh operation.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataRefresh&lt;T&gt; implements DataRefresh {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean refresh(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // convert data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject jsonObject = convert(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(jsonObject)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean updated = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigData&lt;T&gt; result = fromJson(jsonObject);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // does it need to be updated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.updateCacheIfNeed(result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updated = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // real update logic, data refresh operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            refresh(result.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return updated;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#updateCacheIfNeed()</li></ul><p>The process of data conversion, which is based on different data types, we will not trace further to see if the data needs to be updated logically. The method name is <code>updateCacheIfNeed()</code>, which is implemented by method overloading.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataRefresh&lt;T&gt; implements DataRefresh {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // result is data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract boolean updateCacheIfNeed(ConfigData&lt;T&gt; result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // newVal is the latest value obtained</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // What kind of data type is groupEnum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean updateCacheIfNeed(final ConfigData&lt;T&gt; newVal, final ConfigGroupEnum groupEnum) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If it is the first time, then it is put directly into the cache and returns true, indicating that the update was made this time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (GROUP_CACHE.putIfAbsent(groupEnum, newVal) == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResultHolder holder = new ResultHolder(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        GROUP_CACHE.merge(groupEnum, newVal, (oldVal, value) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // md5 value is the same, no need to update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.equals(oldVal.getMd5(), newVal.getMd5())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;Get the same config, the [{}] config cache will not be updated, md5:{}&quot;, groupEnum, oldVal.getMd5());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The current cached data has been modified for a longer period than the new data and does not need to be updated.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // must compare the last update time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (oldVal.getLastModifyTime() &gt;= newVal.getLastModifyTime()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;Last update time earlier than the current configuration, the [{}] config cache will not be updated&quot;, groupEnum);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;update {} config: {}&quot;, groupEnum, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            holder.result = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return newVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return holder.result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see from the source code above, there are two cases where updates are not required.</p><ul><li>The <code>md5</code> values of both data are the same, so no update is needed;</li><li>The current cached data has been modified longer than the new data, so no update is needed.</li></ul><p>In other cases, the data needs to be updated.</p><p>At this point, we have finished analyzing the logic of the <code>start()</code> method to get the full amount of data for the first time, followed by the long polling operation. For convenience, I will paste the <code>start()</code> method once more.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It could be initialized multiple times, so you need to control that.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch all group configs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Initial startup, get full data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // one backend service, one thread</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ThreadPoolExecutor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // start long polling, each server creates a thread to listen for changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="232-execute-long-polling-task"></a>2.3.2 Execute Long Polling Task<a class="hash-link" href="#232-execute-long-polling-task" title="Direct link to heading">#</a></h5><ul><li>HttpLongPollingTask#run()</li></ul><p>The long polling task is <code>HttpLongPollingTask</code>, which implements the <code>Runnable</code> interface and the task logic is in the <code>run()</code> method. The task is executed continuously through a <code>while()</code> loop, i.e., long polling. There are three retries in each polling logic, one polling task fails, wait <code>5s</code> and continue, <code>3</code> times all fail, wait <code>5</code> minutes and try again.</p><p>Start long polling, an <code>admin</code> service, and create a thread for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class HttpLongPollingTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpLongPollingTask(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.server = server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // long polling</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (RUNNING.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Default retry 3 times</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int retryTimes = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int time = 1; time &lt;= retryTimes; time++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doLongPolling(server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (time &lt; retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.warn(&quot;Long polling failed, tried {} times, {} times left, will be suspended for a while! {}&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                time, retryTimes - time, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // long polling failed, wait 5s and continue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ThreadUtils.sleep(TimeUnit.SECONDS, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // print error, then suspended for a while.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Long polling failed, try again after 5 minutes!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 3 次都失败了，等 5 分钟再试</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ThreadUtils.sleep(TimeUnit.MINUTES, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.warn(&quot;Stop http long polling.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doLongPolling()</li></ul><p>Core logic for performing long polling tasks.</p><ul><li>Assembling request parameters based on data types: <code>md5</code> and <code>lastModifyTime</code>.</li><li>Assembling the request header and request body.</li><li>Launching a request to <code>admin</code> to determine if the group data has changed.</li><li>Based on the group that has changed, go back and get the data.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doLongPolling(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build request params: md5 and lastModifyTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;(8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;?&gt; cacheConfig = factory.cacheConfigData(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cacheConfig != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                String value = String.join(&quot;,&quot;, cacheConfig.getMd5(), String.valueOf(cacheConfig.getLastModifyTime()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                params.put(group.name(), Lists.newArrayList(value));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build request head and body</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpHeaders headers = new HttpHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set accessToken</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(params, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String listenerUrl = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_LISTENER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonArray groupJson;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Initiate a request to admin to determine if the group data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Here it just determines whether a group has changed or not</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String json = this.restTemplate.postForEntity(listenerUrl, httpEntity, String.class).getBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;listener result: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            JsonObject responseFromServer = GsonUtils.getGson().fromJson(json, JsonObject.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            groupJson = responseFromServer.getAsJsonArray(&quot;data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String message = String.format(&quot;listener configs fail, server:[%s], %s&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Depending on the group where the change occurred, go back and get the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * The official website explains here.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * After the gateway receives the response message, it only knows which Group has made the configuration change, and it still needs to request the configuration data of that Group again.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * There may be a question here: why not write out the changed data directly?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * We also discussed this issue in depth during development, because the http long polling mechanism can only guarantee quasi-real time, if the processing at the gateway layer is not timely, * or the administrator frequently updates the configuration, it is very difficult to get the information from the gateway layer.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If it is not processed in time at the gateway level, or if the administrator updates the configuration frequently, it is very likely to miss the push of a configuration change, so for security reasons, we only inform a group that the information has changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *For security reasons, we only notify a group of changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Personal understanding.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If the change data is written out directly, when the administrator frequently updates the configuration, the first update will remove the client from the blocking queue and return the response information to the gateway.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If a second update is made at this time, the current client is not in the blocking queue, so this time the change is missed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * The same is true for untimely processing by the gateway layer.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * This is a long polling, one gateway one synchronization thread, there may be time consuming process.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If the admin has data changes, the current gateway client is not in the blocking queue and will not get the data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (groupJson != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch group configuration async.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigGroupEnum[] changedGroups = GSON.fromJson(groupJson, ConfigGroupEnum[].class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ArrayUtils.isNotEmpty(changedGroups)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;Group config changed: {}&quot;, Arrays.toString(changedGroups));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Proactively get the changed data from admin, depending on the grouping, and take the data in full</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.doFetchGroupConfig(server, changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(groupJson) &amp;&amp; groupJson.size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch group configuration async.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigGroupEnum[] changedGroups = GsonUtils.getGson().fromJson(groupJson, ConfigGroupEnum[].class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;Group config changed: {}&quot;, Arrays.toString(changedGroups));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Proactively get the changed data from admin, depending on the grouping, and take the data in full</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.doFetchGroupConfig(server, changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One special point needs to be explained here: In the long polling task, why don&#x27;t you get the changed data directly? Instead, we determine which group data has been changed, and then request <code>admin</code> again to get the changed data?</p><p>The official explanation here is.</p><blockquote><p>After the gateway receives the response information, it only knows which Group has changed its configuration, and it needs to request the configuration data of that Group again.
There may be a question here: Why not write out the changed data directly?
We have discussed this issue in depth during development, because the <code>http</code> long polling mechanism can only guarantee quasi-real time, and if it is not processed in time at the gateway layer, it will be very difficult to update the configuration data.
If the gateway layer is not processed in time, or the administrator updates the configuration frequently, it is likely to miss the push of a configuration change, so for security reasons, we only inform a group that the information has changed.</p></blockquote><p>My personal understanding is that.</p><blockquote><p>If the change data is written out directly, when the administrator updates the configuration frequently, the first update will remove the <code>client</code> from blocking queue and return the response information to the gateway. If a second update is made at this time, then the current <code>client</code> is not in the blocking queue, so this time the change is missed. The same is true for the gateway layer&#x27;s untimely processing. This is a long polling, one gateway one synchronization thread, there may be a time-consuming process. If <code>admin</code> has data changes, the current gateway client is not in the blocking queue and will not get the data.</p></blockquote><p>We have not yet analyzed the processing logic of the <code>admin</code> side, so let&#x27;s talk about it roughly. At the <code>admin</code> end, the gateway <code>client</code> will be put into the blocking queue, and when there is a data change, the gateway <code>client</code> will come out of the queue and send the change data. So, if the gateway <code>client</code> is not in the blocking queue when there is a data change, then the current changed data is not available.</p><p>When we know which grouping data has changed, we actively get the changed data from <code>admin</code> again, and get the data in full depending on the grouping. The call method is <code>doFetchGroupConfig()</code>, which has been analyzed in the previous section.</p><p>At this point of analysis, the data synchronization operation on the gateway side is complete. The long polling task is to keep making requests to <code>admin</code> to see if the data has changed, and if any group data has changed, then initiate another request to <code>admin</code> to get the changed data, and then update the data in the gateway&#x27;s memory.</p><p>Long polling task flow at the gateway side.</p><p><img src="/assets/images/http-long-polling-sequence-en-f767de4dee173a720d632db5c800e147.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-admin-data-sync"></a>3. Admin Data Sync<a class="hash-link" href="#3-admin-data-sync" title="Direct link to heading">#</a></h3><p>From the previous analysis, it can be seen that the gateway side mainly calls two interfaces of <code>admin</code>.</p><ul><li><code>/configs/listener</code>: determine whether the group data has changed.</li><li><code>/configs/fetch</code>: get the changed group data.</li></ul><p>If we analyze directly from these two interfaces, some parts may not be well understood, so let&#x27;s start analyzing the data synchronization process from the <code>admin</code> startup process.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-load-configuration"></a>3.1 Load Configuration<a class="hash-link" href="#31-load-configuration" title="Direct link to heading">#</a></h4><p>If the following configuration is done in the configuration file <code>application.yml</code>, it means that the data synchronization is done by <code>http long polling</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the program starts, the configuration of the data synchronization class is loaded through <code>springboot</code> conditional assembly. In this process, <code>HttpLongPollingDataChangedListener</code> is created to handle the implementation logic related to long polling.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronization configuration class</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Conditional assembly via springboot</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * http long polling.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;shenyu.sync.http.enabled&quot;, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(HttpSyncProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class HttpLongPollingListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public HttpLongPollingDataChangedListener httpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new HttpLongPollingDataChangedListener(httpSyncProperties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-data-change-listener-instantiation"></a>3.2 Data change listener instantiation<a class="hash-link" href="#32-data-change-listener-instantiation" title="Direct link to heading">#</a></h4><ul><li>HttpLongPollingDataChangedListener</li></ul><p>The data change listener is instantiated and initialized by means of a constructor. In the constructor, a blocking queue is created to hold clients, a thread pool is created to execute deferred tasks and periodic tasks, and information about the properties of long polling is stored.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default client (here is the gateway) 1024</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.clients = new ArrayBlockingQueue&lt;&gt;(1024);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create thread pool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ScheduledThreadPoolExecutor can perform delayed tasks, periodic tasks, and normal tasks</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.scheduler = new ScheduledThreadPoolExecutor(1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuThreadFactory.create(&quot;long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // http sync properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.httpSyncProperties = httpSyncProperties;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In addition, it has the following class diagram relationships.</p><p><img src="/assets/images/data-changed-listener-1c8e4c0f4279cdb33b27c52cc933cac5.png"></p><p>The <code>InitializingBean</code> interface is implemented, so the <code>afterInitialize()</code> method is executed during the initialization of the <code>bean</code>. Execute periodic tasks via thread pool: updating the data in memory <code>(CACHE)</code> is executed every <code>5</code> minutes and starts after <code>5</code> minutes. Refreshing the local cache is reading data from the database to the local cache (in this case the memory), done by <code>refreshLocalCache()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * is called in the afterPropertiesSet() method of the InitializingBean interface, which is executed during the initialization of the bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void afterInitialize() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long syncInterval = httpSyncProperties.getRefreshInterval().toMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Periodically check the data for changes and update the cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Execution cycle task: Update data in memory (CACHE) is executed every 5 minutes and starts after 5 minutes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Prevent the admin from starting up first for a while and then generating data; then the gateway doesn&#x27;t get the full amount of data when it first connects</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.scheduleWithFixedDelay(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;http sync strategy refresh config start.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Read data from database to local cache (in this case, memory)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.refreshLocalCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;http sync strategy refresh config success.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;http sync strategy refresh config error!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, syncInterval, syncInterval, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;http sync strategy refresh interval: {}ms&quot;, syncInterval);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>refreshLocalCache()</li></ul><p>Update for each of the 5 data types.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Read data from database to local cache (in this case, memory)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void refreshLocalCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateAppAuthCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateRuleCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateSelectorCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateMetaDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of the 5 update methods is similar, call the <code>service</code> method to get the data and put it into the memory <code>CACHE</code>. Take the updateRuleData method <code>updateRuleCache()</code> for example, pass in the rule enumeration type and call <code>ruleService.listAll()</code> to get all the rule data from the database.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Update rule cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateRuleCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateCache(ConfigGroupEnum.RULE, ruleService.listAll());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>updateCache()</li></ul><p>Update the data in memory using the data in the database.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // cache Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static final ConcurrentMap&lt;String, ConfigDataCache&gt; CACHE = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * if md5 is not the same as the original, then update lcoal cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param group ConfigGroupEnum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt; the type of class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the new config data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected &lt;T&gt; void updateCache(final ConfigGroupEnum group, final List&lt;T&gt; data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // data serialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // pass in md5 value and modification time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache newVal = new ConfigDataCache(group.name(), json, Md5Utils.md5(json), System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update group data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache oldVal = CACHE.put(newVal.getGroup(), newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;update config cache[{}], old: {}, updated: {}&quot;, group, oldVal, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The initialization process is to start periodic tasks to update the memory data by fetching data from the database at regular intervals.</p><p>Next, we start the analysis of two interfaces.</p><ul><li><code>/configs/listener</code>: determines if the group data has changed.</li><li><code>/configs/fetch</code>: fetching the changed group data.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33--data-change-polling-interface"></a>3.3  Data change polling interface<a class="hash-link" href="#33--data-change-polling-interface" title="Direct link to heading">#</a></h4><ul><li><code>/configs/listener</code>: determines if the group data has changed.</li></ul><p>The interface class is <code>ConfigController</code>, which only takes effect when using <code>http long polling</code> for data synchronization. The interface method <code>listener()</code> has no other logic and calls the <code>doLongPolling()</code> method directly.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * This Controller only when HttpLongPollingDataChangedListener exist, will take effect.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.longPollingListener = longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Omit other logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Listen for data changes and perform long polling</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request  the request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response the response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(value = &quot;/listener&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void listener(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        longPollingListener.doLongPolling(request, response);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#doLongPolling()</li></ul><p>Perform long polling tasks: If there are data changes, they will be responded to the client (in this case, the gateway side) immediately. Otherwise, the client will be blocked until there is a data change or a timeout.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Execute long polling: If there is a data change, it will be responded to the client (here is the gateway side) immediately.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Otherwise, the client will otherwise remain blocked until there is a data change or a timeout.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doLongPolling(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // compare group md5</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Compare the md5, determine whether the data of the gateway and the data of the admin side are consistent, and get the data group that has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConfigGroupEnum&gt; changedGroup = compareChangedGroup(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String clientIp = getRemoteIp(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // response immediately.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Immediate response to the gateway if there is changed data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(changedGroup)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.generateResponse(response, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Log.info(&quot;send response with the changed group, ip={}, group={}&quot;, clientIp, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // No change, then the client (in this case the gateway) is put into the blocking queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // listen for configuration changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final AsyncContext asyncContext = request.startAsync();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // AsyncContext.settimeout() does not timeout properly, so you have to control it yourself</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncContext.setTimeout(0L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // block client&#x27;s thread.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.execute(new LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#compareChangedGroup()</li></ul><p>To determine whether the group data has changed, the judgment logic is to compare the <code>md5</code> value and <code>lastModifyTime</code> at the gateway side and the <code>admin</code> side.</p><ul><li>If the <code>md5</code> value is different, then it needs to be updated.</li><li>If the <code>lastModifyTime</code> on the <code>admin</code> side is greater than the <code>lastModifyTime</code> on the gateway side, then it needs to be updated.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Determine if the group data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;ConfigGroupEnum&gt; compareChangedGroup(final HttpServletRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConfigGroupEnum&gt; changedGroup = new ArrayList&lt;&gt;(ConfigGroupEnum.values().length);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The md5 value and lastModifyTime of the data on the gateway side</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] params = StringUtils.split(request.getParameter(group.name()), &#x27;,&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (params == null || params.length != 2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuException(&quot;group param invalid:&quot; + request.getParameter(group.name()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String clientMd5 = params[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long clientModifyTime = NumberUtils.toLong(params[1]);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigDataCache serverCache = CACHE.get(group.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // do check. determine if the group data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.checkCacheDelayAndUpdate(serverCache, clientMd5, clientModifyTime)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changedGroup.add(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return changedGroup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>LongPollingClient</li></ul><p>No change data, then the client (in this case the gateway) is put into the blocking queue. The blocking time is 60 seconds, i.e. after 60 seconds remove and respond to the client.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class LongPollingClient implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // omitted other logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Removal after 60 seconds and response to the client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.asyncTimeoutFuture = scheduler.schedule(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    clients.remove(LongPollingClient.this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;ConfigGroupEnum&gt; changedGroups = compareChangedGroup((HttpServletRequest) asyncContext.getRequest());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendResponse(changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, timeoutTime, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Add to blocking queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.add(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;add long polling client error&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Send response.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param changedGroups the changed groups</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        void sendResponse(final List&lt;ConfigGroupEnum&gt; changedGroups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // cancel scheduler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (null != asyncTimeoutFuture) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                asyncTimeoutFuture.cancel(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Groups responding to changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            generateResponse((HttpServletResponse) asyncContext.getResponse(), changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            asyncContext.complete();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34--get-change-data-interface"></a>3.4  Get Change Data Interface<a class="hash-link" href="#34--get-change-data-interface" title="Direct link to heading">#</a></h4><ul><li><code>/configs/fetch</code>: get change data;</li></ul><p>Get the grouped data and return the result according to the parameters passed in by the gateway. The main implementation method is <code>longPollingListener.fetchConfig()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.longPollingListener = longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Fetch configs shenyu result.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupKeys the group keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the shenyu result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/fetch&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult fetchConfigs(@NotNull final String[] groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ConfigData&lt;?&gt;&gt; result = Maps.newHashMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String groupKey : groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;?&gt; data = longPollingListener.fetchConfig(ConfigGroupEnum.valueOf(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.put(groupKey, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.SUCCESS, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Other interfaces are omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataChangedListener#fetchConfig()</li></ul><p>Data fetching is taken directly from <code>CACHE</code>, and then matched and encapsulated according to different grouping types.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * fetch configuration from cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupKey the group key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the configuration data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigData&lt;?&gt; fetchConfig(final ConfigGroupEnum groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get data from CACHE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache config = CACHE.get(groupKey.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, AppAuthData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case PLUGIN: // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case RULE:   // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, RuleData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case SELECTOR:  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, SelectorData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case META_DATA: // meta data </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, MetaData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:  // other data type, throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new IllegalStateException(&quot;Unexpected groupKey: &quot; + groupKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="35-data-change"></a>3.5 Data Change<a class="hash-link" href="#35-data-change" title="Direct link to heading">#</a></h4><p>In the previous <code>websocket</code> data synchronization and <code>zookeeper</code> data synchronization source code analysis article, we know that the <code>admin</code> side data synchronization design structure is as follows.</p><p><img src="/assets/images/data-changed-listener-admin-2f384e703652e9e28db8447b1cbdaea7.png"></p><p>Various data change listeners are subclasses of <code>DataChangedListener</code>.</p><p>When the data is modified on the <code>admin</code> side, event notifications are sent through the <code>Spring</code> event handling mechanism. The sending logic is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Event forwarders, which forward the changed events to each ConfigEventListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data change event distributor: synchronize the change data to ShenYu gateway when there is a data change in admin side</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data changes rely on Spring&#x27;s event-listening mechanism: ApplicationEventPublisher --&gt; ApplicationEvent --&gt; ApplicationListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // other logic omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Call this method when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listeners (it&#x27;s generally good to use a kind of data synchronization)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // pull and save API document on seletor changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other data type, throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Suppose, the plugin information is modified and the data is synchronized by <code>http long polling</code>, then the actual call to <code>listener.onPluginChanged()</code> is <code>org.apache.shenyu.admin.listener. AbstractDataChangedListener#onPluginChanged</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * In the operation of the admin, there is an update of the plugin occurred</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param changed   the changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param eventType the event type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(changed)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update CACHE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // execute change task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.afterPluginChanged(changed, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There are two processing operations, one is to update the memory <code>CACHE</code>, which was analyzed earlier, and the other is to execute the change task, which is executed in the thread pool.</p><ul><li>HttpLongPollingDataChangedListener#afterPluginChanged()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void afterPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // execute by thread pool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.execute(new DataChangeTask(ConfigGroupEnum.PLUGIN));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataChangeTask</li></ul><p>Data change task: remove the clients in the blocking queue in turn and send a response to notify the gateway that a group of data has changed.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class DataChangeTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //other logic omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If the client in the blocking queue exceeds the given value of 100, it is executed in batches</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clients.size() &gt; httpSyncProperties.getNotifyBatchSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;LongPollingClient&gt; targetClients = new ArrayList&lt;&gt;(clients.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.drainTo(targetClients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;List&lt;LongPollingClient&gt;&gt; partitionClients = Lists.partition(targetClients, httpSyncProperties.getNotifyBatchSize());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // batch execution</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                partitionClients.forEach(item -&gt; scheduler.execute(() -&gt; doRun(item)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // execute task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                doRun(clients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void doRun(final Collection&lt;LongPollingClient&gt; clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Notify all clients that a data change has occurred</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Iterator&lt;LongPollingClient&gt; iter = clients.iterator(); iter.hasNext();) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LongPollingClient client = iter.next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                iter.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // send response to client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.sendResponse(Collections.singletonList(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Log.info(&quot;send response with the changed group,ip={}, group={}, changeTime={}&quot;, client.ip, groupKey, changeTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, the data synchronization logic on the <code>admin</code> side is analyzed. In the <code>http long polling</code> based data synchronization is, it has three main functions.</p><ul><li>providing a data change listening interface.</li><li>providing the interface to get the changed data.</li><li>When there is a data change, remove the client in the blocking queue and respond to the result.</li></ul><p>Finally, three diagrams describe the long polling task flow on the <code>admin</code> side.</p><ul><li><code>/configs/listener</code> data change listener interface.</li></ul><p><img src="/assets/images/http-long-polling-listener-en-e979b81dc72024abd7ca3c2258bdaeec.png"></p><ul><li><code>/configs/fetch</code> fetch change data interface.</li></ul><p><img src="/assets/images/http-long-polling-fetch-en-85412d758bccd904e0f798b12d0d19de.png"></p><ul><li>Update data in the admin backend management system for data synchronization.</li></ul><p><img src="/assets/images/http-long-polling-admin-update-en-f0892e8f170561e4237d2d89b07a3bc5.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-summary"></a>4. Summary<a class="hash-link" href="#4-summary" title="Direct link to heading">#</a></h3><p>This article focuses on the source code analysis of <code>http long polling</code> data synchronization in the <code>ShenYu</code> gateway. The main knowledge points involved are as follows.</p><ul><li><code>http long polling</code> is initiated by the gateway side, which constantly requests the <code>admin</code> side.</li><li>change data at group granularity (authentication information, plugins, selectors, rules, metadata).</li><li><code>http long polling</code> results in getting only the change group, and another request needs to be initiated to get the group data.</li><li>Whether the data is updated or not is determined by the <code>md5</code> value and the modification time <code>lastModifyTime</code>.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/http">http</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog"><div class="pagination-nav__label">« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/page/3"><div class="pagination-nav__label">Older Entries »</div></a></div></nav></main></div></div></div></div>
<script src="/assets/js/runtime~main.375b1e44.js"></script>
<script src="/assets/js/main.561e3b14.js"></script>
</body>
</html>