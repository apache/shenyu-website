"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[50589],{9425(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>l,frontMatter:()=>s,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"design/data-sync","title":"Data Sync Design","description":"Data Synchronization Design","source":"@site/versioned_docs/version-2.7.0.3/design/data-sync.md","sourceDirName":"design","slug":"/design/data-sync","permalink":"/docs/design/data-sync","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/shenyu-website/edit/main/versioned_docs/version-2.7.0.3/design/data-sync.md","tags":[],"version":"2.7.0.3","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Data Sync Design","keywords":["Apache ShenYu"],"description":"Data Synchronization Design"},"sidebar":"tutorialSidebar","previous":{"title":"Admin Database Design","permalink":"/docs/design/database-design"},"next":{"title":"Flow Control Design","permalink":"/docs/design/flow-control"}}');var o=i(74848),a=i(28453);const s={sidebar_position:2,title:"Data Sync Design",keywords:["Apache ShenYu"],description:"Data Synchronization Design"},r=void 0,c={},h=[{value:"Preface",id:"preface",level:2},{value:"Principle Analysis",id:"principle-analysis",level:2},{value:"Zookeeper Synchronization",id:"zookeeper-synchronization",level:3},{value:"WebSocket Synchronization",id:"websocket-synchronization",level:3},{value:"Http Long Polling",id:"http-long-polling",level:3},{value:"Nacos Synchronization",id:"nacos-synchronization",level:3},{value:"Etcd Synchronization",id:"etcd-synchronization",level:3},{value:"Consul Synchronization",id:"consul-synchronization",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"This document explains the principle of data synchronization. Data synchronization refers to the strategy used to synchronize data to ShenYu gateway after shenyu-admin background operation data. ShenYu gateway currently supports ZooKeeper, WebSocket, HTTP Long Polling, Nacos, Etcd and Consul for data synchronization."}),"\n",(0,o.jsxs)(n.p,{children:["See ",(0,o.jsx)(n.a,{href:"/docs/user-guide/property-config/use-data-sync",children:"Data Synchronization Configuration"}),"  for configuration information about data synchronization."]}),"\n",(0,o.jsx)("img",{src:"/img/shenyu/dataSync/data-sync-dir-en.png",width:"90%",height:"80%"}),"\n",(0,o.jsx)(n.h2,{id:"preface",children:"Preface"}),"\n",(0,o.jsx)(n.p,{children:"Gateway is the entrance of request and it is a very important part in micro service architecture, therefore the importance of gateway high availability is self-evident. When we use gateway, we have to change configuration such as flow rule, route rule for satisfying business requirement. Therefore, the dynamic configuration of the gateway is an important factor to ensure the high availability of the gateway."}),"\n",(0,o.jsx)(n.p,{children:"In the actual use of Apache ShenYu Gateway, users also feedback some problems:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Apache ShenYu depends on ZooKeeper, how to use Etcd, Consul, Nacos and other registry center?"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Apache ShenYu depends on Redis and InfluxDB, and do not use limiting plugins or monitoring plugins. Why need these?"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Why not use configuration center for configuration synchronization?"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Why can't updates be configured dynamically?"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Every time you want to query the database, Redis is a better way."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"According to the feedback of users, we have also partially reconstructed ShenYu. The current data synchronization features are as follows:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"All configuration is cached in ShenYu gateway memory, each request uses local cache, which is very fast."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Users can modify any data in the background of shenyu-admin, and immediately synchronize to the gateway memory."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Support ShenYu plugin, selector, rule data, metadata, signature data and other data synchronization."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"All plugin selectors and rules are configured dynamically and take effect immediately, no service restart required."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Data synchronization mode supports Zookeeper, HTTP long polling, Websocket, Nacos, Etcd and Consul."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"principle-analysis",children:"Principle Analysis"}),"\n",(0,o.jsx)(n.p,{children:"The following figure shows the process of data synchronization of ShenYu. ShenYu Gateway will synchronize configuration data from configuration service at startup, and support push-pull mode to get configuration change information, and then update local cache. The administrator can change the user permissions, rules, plugins and traffic configuration in the admin system(shenyu-admin), and synchronize the change information to ShenYu Gateway through the push-pull mode. Whether the mode is push or pull depends on the synchronization mode used."}),"\n",(0,o.jsx)("img",{src:"/img/shenyu/dataSync/shenyu-config-processor-en.png",width:"90%",height:"80%"}),"\n",(0,o.jsxs)(n.p,{children:["In the original version, the configuration service relied on the Zookeeper implementation to manage the back-end push of changes to the gateway. Now, WebSocket, HTTP long polling, ZooKeeper, Nacos, Etcd, and Consul can now be supported by specifying the corresponding synchronization policy by setting ",(0,o.jsx)(n.code,{children:"shenyu.sync.${strategy}"})," in the configuration file. The default WeboSocket synchronization policy can be used to achieve second level data synchronization. However, it is important to note that Apache ShenYu Gateway and shenyu-admin must use the same synchronization policy."]}),"\n",(0,o.jsxs)(n.p,{children:["As showing picture below,",(0,o.jsx)(n.code,{children:"shenyu-admin"})," will issue a configuration change notification through ",(0,o.jsx)(n.code,{children:"EventPublisher"})," after users change configuration,",(0,o.jsx)(n.code,{children:"EventDispatcher"})," will handle this modification and send configuration to corresponding event handler according to configured synchronization strategy."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["If it is a ",(0,o.jsx)(n.code,{children:"websocket"})," synchronization strategy,it will push modified data to ",(0,o.jsx)(n.code,{children:"shenyu-web"}),",and corresponding ",(0,o.jsx)(n.code,{children:"WebsocketDataHandler"})," handler will handle ",(0,o.jsx)(n.code,{children:"shenyu-admin"})," data push at the gateway layer"]}),"\n",(0,o.jsxs)(n.li,{children:["If it is a  ",(0,o.jsx)(n.code,{children:"zookeeper"})," synchronization strategy,it will push modified data to ",(0,o.jsx)(n.code,{children:"zookeeper"}),",and the ",(0,o.jsx)(n.code,{children:"ZookeeperSyncCache"})," will monitor the data changes of ",(0,o.jsx)(n.code,{children:"zookeeper"})," and process them"]}),"\n",(0,o.jsxs)(n.li,{children:["If it is a  ",(0,o.jsx)(n.code,{children:"http"})," synchronization strategy,",(0,o.jsx)(n.code,{children:"shenyu-web"})," proactively initiates long polling requests,90 seconds timeout by default,if there is no modified data in ",(0,o.jsx)(n.code,{children:"shenyu-admin"}),",http request will be blocked,if there is a data change, it will respond to the changed data information,if there is no data change after 60 seconds,then respond with empty data,gateway continue to make http request after getting response,this kind of request will repeat."]}),"\n"]}),"\n",(0,o.jsx)("img",{src:"/img/shenyu/dataSync/config-strategy-processor-en.png",width:"90%",height:"80%"}),"\n",(0,o.jsx)(n.h3,{id:"zookeeper-synchronization",children:"Zookeeper Synchronization"}),"\n",(0,o.jsxs)(n.p,{children:["The zookeeper-based synchronization principle is very simple,it mainly depends on ",(0,o.jsx)(n.code,{children:"zookeeper"})," watch mechanism,",(0,o.jsx)(n.code,{children:"shenyu-web"})," will monitor the configured node,when ",(0,o.jsx)(n.code,{children:"shenyu-admin"})," starts,all the data will be written to ",(0,o.jsx)(n.code,{children:"zookeeper"}),",it will incrementally update the nodes of ",(0,o.jsx)(n.code,{children:"zookeeper"})," when data changes,at the same time, ",(0,o.jsx)(n.code,{children:"shenyu-web"})," will monitor the node for configuration information, and update the local cache once the information changes"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Zookeeper Node Design",src:i(95604).A+"",width:"910",height:"1490"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"Apache ShenYu"})," writes the configuration information to the zookeeper node,and it is meticulously designed. If you want to learn more about the code implementation, refer to the source code ",(0,o.jsx)(n.code,{children:"ZookeeperSyncDataService"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"websocket-synchronization",children:"WebSocket Synchronization"}),"\n",(0,o.jsxs)(n.p,{children:["The mechanism of ",(0,o.jsx)(n.code,{children:"websocket"})," and ",(0,o.jsx)(n.code,{children:"zookeeper"})," is similar,when the gateway and the ",(0,o.jsx)(n.code,{children:"shenyu-admin"})," establish a ",(0,o.jsx)(n.code,{children:"websocket"})," connection,",(0,o.jsx)(n.code,{children:"shenyu-admin"})," will push all data at once,it will automatically push incremental data to ",(0,o.jsx)(n.code,{children:"shenyu-web"})," through ",(0,o.jsx)(n.code,{children:"websocket"})," when configured data changes"]}),"\n",(0,o.jsxs)(n.p,{children:["When we use websocket synchronization,pay attention to reconnect after disconnection,which also called keep heartbeat.",(0,o.jsx)(n.code,{children:"Apache ShenYu"})," uses ",(0,o.jsx)(n.code,{children:"java-websocket"})," ,a third-party library,to connect to ",(0,o.jsx)(n.code,{children:"websocket"}),". If you want to learn more about the code implementation, refer to the source code ",(0,o.jsx)(n.code,{children:"WebsocketSyncDataService"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"http-long-polling",children:"Http Long Polling"}),"\n",(0,o.jsxs)(n.p,{children:["The mechanism of zookeeper and websocket data synchronization is relatively simple,but http synchronization will be relatively complicated.ShenYu borrows the design ideas of ",(0,o.jsx)(n.code,{children:"Apollo"})," and ",(0,o.jsx)(n.code,{children:"Nacos"})," and realizes ",(0,o.jsx)(n.code,{children:"http"})," long polling data synchronization using their advantages.Note that this is not traditional ajax long polling."]}),"\n",(0,o.jsx)("img",{src:"/img/shenyu/dataSync/http-long-polling-en.png",width:"90%",height:"80%"}),"\n",(0,o.jsx)(n.p,{children:"http long polling mechanism as above,shenyu-web gateway requests shenyu-admin configuration services,timeout is 90 seconds,it means gateway layer request configuration service will wait at most 90 seconds,this is convenient for shenyu-admin configuration service to respond modified data in time,and therefore we realize near real-time push."}),"\n",(0,o.jsxs)(n.p,{children:["After the http request reaches shenyu-admin, it does not respond immediately,but uses the asynchronous mechanism of Servlet3.0 to asynchronously respond to the data.First of all,put long polling request task ",(0,o.jsx)(n.code,{children:"LongPollingClient"})," into ",(0,o.jsx)(n.code,{children:"BlocingQueue"}),",and then start scheduling task,execute after 60 seconds,this aims to remove the long polling request from the queue after 60 seconds,even there is no configured data change.Because even if there is no configuration change,gateway also need to know,otherwise it will wait,and there is a 90 seconds timeout when the gateway requests configuration services."]}),"\n",(0,o.jsx)(n.p,{children:"If the administrator changes the configuration data during this period,the long polling requests in the queue will be removed one by one, and respond which group\u2019s data has changed(we distribute plugins, rules, flow configuration , user configuration data into different groups).After gateway receives response,it only knows which Group has changed its configuration,it need to request again to get group configuration data.Someone may ask,why don't you write out the changed data directly?We also discussed this issue deeply during development, because the http long polling mechanism can only guarantee quasi real-time,if gateway layer does not handle it in time,or administrator updates configuration frequently,we probably missed some configuration change push.For security, we only inform that a certain Group information has changed."}),"\n",(0,o.jsxs)(n.p,{children:["When ",(0,o.jsx)(n.code,{children:"shenyu-web"})," gateway layer receives the http response information,pull modified information(if exists),and then request ",(0,o.jsx)(n.code,{children:"shenyu-admin"})," configuration service again,this will repeatedly execute.   If you want to learn more about the code implementation, refer to the source code ",(0,o.jsx)(n.code,{children:"HttpSyncDataService"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"nacos-synchronization",children:"Nacos Synchronization"}),"\n",(0,o.jsx)(n.p,{children:"The synchronization principle of Nacos is basically similar to that of ZooKeeper, and it mainly depends on the configuration management of Nacos. The path of each configuration node is similar to that of ZooKeeper."}),"\n",(0,o.jsx)(n.p,{children:"ShenYu gateway will monitor the configured node. At startup, if there is no configuration node in Nacos, it will write the synchronous full amount of data into Nacos. When the sequential data send changes, it will update the configuration node in Nacos in full amount. The local cache is updated."}),"\n",(0,o.jsxs)(n.p,{children:["If you want to learn more about the code implementation, please refer to the source code ",(0,o.jsx)(n.code,{children:"NacosSyncDataService"})," and the official documentation for ",(0,o.jsx)(n.a,{href:"https://nacos.io/zh-cn/docs/sdk.html",children:"Nacos"})," ."]}),"\n",(0,o.jsx)(n.h3,{id:"etcd-synchronization",children:"Etcd Synchronization"}),"\n",(0,o.jsx)(n.p,{children:"Etcd data synchronization principle is similar to Zookeeper, mainly relying on Etcd's watch mechanism, and each configuration node path is the same as that of Zookeeper."}),"\n",(0,o.jsx)(n.p,{children:"The native API for Etcd is a bit more complicated to use, so it's somewhat encapsulated."}),"\n",(0,o.jsx)(n.p,{children:"ShenYu gateway will listen to the configured node. When startup, if there is no configuration node in Etcd, it will write the synchronous full amount of data into Etcd. When the sequential data send changes, it will update the configuration node in Etcd incrementally."}),"\n",(0,o.jsxs)(n.p,{children:["If you want to learn more about the code implementation, refer to the source ",(0,o.jsx)(n.code,{children:"EtcdSyncDataService"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"consul-synchronization",children:"Consul Synchronization"}),"\n",(0,o.jsx)(n.p,{children:"Consul data synchronization principle is that the gateway regularly polls Consul's configuration center to get the configuration version number for local comparison."}),"\n",(0,o.jsx)(n.p,{children:"ShenYu gateway will poll the configured nodes regularly, and the default interval is 1s. When startup, if there is no configuration node in Consul, write the synchronous full amount of data into Consul, then incrementally update the configuration node in Consul when the subsequent data is sent to change. At the same time, Apache ShenYu Gateway will regularly polls the node of configuration information and pull the configuration version number for comparison with the local one. The local cache is updated when the version number is changed."}),"\n",(0,o.jsxs)(n.p,{children:["If you want to learn more about the code implementation, refer to the source ",(0,o.jsx)(n.code,{children:"ConsulsyncDataService"}),"."]})]})}function l(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453(e,n,i){i.d(n,{R:()=>s,x:()=>r});var t=i(96540);const o={},a=t.createContext(o);function s(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),t.createElement(a.Provider,{value:n},e.children)}},95604(e,n,i){i.d(n,{A:()=>t});const t=i.p+"assets/images/shenyu-data-sync-zookeeper-46808f3374aaa2ba781e90261596adf0.png"}}]);