<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Httpé•¿è½®è¯¢æ•°æ®åŒæ­¥æºç åˆ†æ | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Httpé•¿è½®è¯¢æ•°æ®åŒæ­¥æºç åˆ†æ | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Apache ShenYu æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚"><meta data-react-helmet="true" property="og:description" content="Apache ShenYu æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/DataSync-SourceCode-Analysis-Http-Data-Sync" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/DataSync-SourceCode-Analysis-Http-Data-Sync" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.4db9224e.css">
<link rel="preload" href="/zh/assets/js/runtime~main.b320993e.js" as="script">
<link rel="preload" href="/zh/assets/js/main.0d73c12b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/DataSync-SourceCode-Analysis-Http-Data-Sync" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="blogPostTitle_d4p0">Httpé•¿è½®è¯¢æ•°æ®åŒæ­¥æºç åˆ†æ</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-03-02T05:19:06.386Z">2023å¹´3æœˆ2æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>Etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>Httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.5.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-httpé•¿è½®è¯¢"></a>1. Httpé•¿è½®è¯¢<a class="hash-link" href="#1-httpé•¿è½®è¯¢" title="Direct link to heading">#</a></h3><p>è¿™é‡Œç›´æ¥å¼•ç”¨å®˜ç½‘çš„ç›¸å…³æè¿°ï¼š</p><blockquote><p><code>Zookeeper</code>å’Œ<code>WebSocket</code> æ•°æ®åŒæ­¥çš„æœºåˆ¶æ¯”è¾ƒç®€å•ï¼Œè€Œ <code>Httpé•¿è½®è¯¢</code>åˆ™æ¯”è¾ƒå¤æ‚ã€‚ <code>Apache ShenYu</code> å€Ÿé‰´äº† <code>Apollo</code>ã€<code>Nacos</code> çš„è®¾è®¡æ€æƒ³ï¼Œå–å…¶ç²¾åï¼Œè‡ªå·±å®ç°äº† <code>Httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚æ³¨æ„ï¼Œè¿™é‡Œå¹¶éä¼ ç»Ÿçš„ <code>ajax</code> é•¿è½®è¯¢ï¼</p></blockquote><p><img src="/zh/assets/images/http-long-polling-zh-bc8bd8fe6c4aa883a959f59fce05078a.png"></p><p><code>Httpé•¿è½®è¯¢</code> æœºåˆ¶å¦‚ä¸Šæ‰€ç¤ºï¼Œ<code>Apache ShenYu</code>ç½‘å…³ä¸»åŠ¨è¯·æ±‚ <code>shenyu-admin</code> çš„é…ç½®æœåŠ¡ï¼Œè¯»å–è¶…æ—¶æ—¶é—´ä¸º <code>90s</code>ï¼Œæ„å‘³ç€ç½‘å…³å±‚è¯·æ±‚é…ç½®æœåŠ¡æœ€å¤šä¼šç­‰å¾… <code>90s</code>ï¼Œè¿™æ ·ä¾¿äº <code>shenyu-admin</code> é…ç½®æœåŠ¡åŠæ—¶å“åº”å˜æ›´æ•°æ®ï¼Œä»è€Œå®ç°å‡†å®æ—¶æ¨é€ã€‚</p><p><code>Httpé•¿è½®è¯¢</code> æœºåˆ¶æ˜¯ç”±ç½‘å…³ä¸»åŠ¨è¯·æ±‚ <code>shenyu-admin</code> ï¼Œæ‰€ä»¥è¿™æ¬¡çš„æºç åˆ†æï¼Œæˆ‘ä»¬ä»ç½‘å…³è¿™ä¸€ä¾§å¼€å§‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-ç½‘å…³æ•°æ®åŒæ­¥"></a>2. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#2-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-åŠ è½½é…ç½®"></a>2.1 åŠ è½½é…ç½®<a class="hash-link" href="#21-åŠ è½½é…ç½®" title="Direct link to heading">#</a></h4><p><code>Httpé•¿è½®è¯¢</code> æ•°æ®åŒæ­¥é…ç½®çš„åŠ è½½æ˜¯é€šè¿‡<code>spring boot</code>çš„<code>starter</code>æœºåˆ¶ï¼Œå½“æˆ‘ä»¬å¼•å…¥ç›¸å…³ä¾èµ–å’Œåœ¨é…ç½®æ–‡ä»¶ä¸­æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šåŠ è½½ã€‚</p><p>åœ¨<code>pom</code>æ–‡ä»¶ä¸­å¼•å…¥ä¾èµ–ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!--shenyu data sync start use http--&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spring-boot-starter-sync-data-http</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>application.yml</code>é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½®ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“ç½‘å…³å¯åŠ¨æ—¶ï¼Œé…ç½®ç±»<code>HttpSyncDataConfiguration</code>å°±ä¼šæ‰§è¡Œï¼ŒåŠ è½½ç›¸åº”çš„<code>Bean</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Http sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HttpSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(value = HttpConfig.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Logger LOGGER = LoggerFactory.getLogger(HttpSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Rest template.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * åˆ›å»ºRestTemplate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param httpConfig the http config       httpé…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return the rest template</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public RestTemplate restTemplate(final HttpConfig httpConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    OkHttp3ClientHttpRequestFactory factory = new OkHttp3ClientHttpRequestFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    factory.setConnectTimeout(Objects.isNull(httpConfig.getConnectionTimeout()) ? (int) HttpConstants.CLIENT_POLLING_CONNECT_TIMEOUT : httpConfig.getConnectionTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    factory.setReadTimeout(Objects.isNull(httpConfig.getReadTimeout()) ? (int) HttpConstants.CLIENT_POLLING_READ_TIMEOUT : httpConfig.getReadTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    factory.setWriteTimeout(Objects.isNull(httpConfig.getWriteTimeout()) ? (int) HttpConstants.CLIENT_POLLING_WRITE_TIMEOUT : httpConfig.getWriteTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new RestTemplate(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * AccessTokenManager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * åˆ›å»ºAccessTokenManager,ä¸“é—¨ç”¨æˆ·å¯¹adminè¿›è¡Œhttpè¯·æ±‚æ—¶access tokençš„å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param httpConfig   the http config.      </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param restTemplate the rest template.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return the access token manager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AccessTokenManager accessTokenManager(final HttpConfig httpConfig, final RestTemplate restTemplate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new AccessTokenManager(restTemplate, httpConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Http sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * åˆ›å»º HttpSyncDataService </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param httpConfig         the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param pluginSubscriber   the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param restTemplate       the rest template</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param metaSubscribers    the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param authSubscribers    the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param accessTokenManager the access token manager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public SyncDataService httpSyncDataService(final ObjectProvider&lt;HttpConfig&gt; httpConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ObjectProvider&lt;RestTemplate&gt; restTemplate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ObjectProvider&lt;AccessTokenManager&gt; accessTokenManager) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;you use http long pull sync shenyu data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new HttpSyncDataService(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Objects.requireNonNull(httpConfig.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Objects.requireNonNull(pluginSubscriber.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Objects.requireNonNull(restTemplate.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaSubscribers.getIfAvailable(Collections::emptyList),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            authSubscribers.getIfAvailable(Collections::emptyList),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Objects.requireNonNull(accessTokenManager.getIfAvailable())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>HttpSyncDataConfiguration</code>æ˜¯<code>Httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥çš„é…ç½®ç±»ï¼Œè´Ÿè´£åˆ›å»º<code>HttpSyncDataService</code>ï¼ˆè´Ÿè´£<code>http</code>æ•°æ®åŒæ­¥çš„å…·ä½“å®ç°ï¼‰ã€<code>RestTemplate</code>å’Œ<code>AccessTokenManager</code> ï¼ˆè´Ÿè´£ä¸<code>admin</code>httpè°ƒç”¨æ—¶access tokençš„å¤„ç†ï¼‰ã€‚å®ƒçš„æ³¨è§£å¦‚ä¸‹ï¼š</p><ul><li><code>@Configuration</code>ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼›</li><li><code>@ConditionalOnClass(HttpSyncDataService.class)</code>ï¼šæ¡ä»¶æ³¨è§£ï¼Œè¡¨ç¤ºè¦æœ‰<code>HttpSyncDataService</code>è¿™ä¸ªç±»ï¼›</li><li><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</code>ï¼šæ¡ä»¶æ³¨è§£ï¼Œè¦æœ‰<code>shenyu.sync.http.url</code>è¿™ä¸ªå±æ€§é…ç½®ã€‚</li><li><code>@EnableConfigurationProperties(value = HttpConfig.class)</code>ï¼šè¡¨ç¤ºè®©HttpConfigä¸Šçš„æ³¨è§£<code>@ConfigurationProperties(prefix = &quot;shenyu.sync.http&quot;)</code>ç”Ÿæ•ˆï¼Œå°†<code>HttpConfig</code>è¿™ä¸ªé…ç½®ç±»æ³¨å…¥Iocå®¹å™¨ä¸­ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å±æ€§åˆå§‹åŒ–"></a>2.2 å±æ€§åˆå§‹åŒ–<a class="hash-link" href="#22-å±æ€§åˆå§‹åŒ–" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService</li></ul><p>åœ¨<code>HttpSyncDataService</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œå®Œæˆå±æ€§åˆå§‹åŒ–ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å±æ€§å­—æ®µ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpSyncDataService(final HttpConfig httpConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final RestTemplate restTemplate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final List&lt;AuthDataSubscriber&gt; authDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final AccessTokenManager accessTokenManager) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 1.è®¾ç½®accessTokenManager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.accessTokenManager = accessTokenManager;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 2.åˆ›å»ºæ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.factory = new DataRefreshFactory(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 3.shenyu-adminçš„urlï¼Œ å¤šä¸ªç”¨é€—å·(,)åˆ†å‰²</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(httpConfig.getUrl()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 4.åªç”¨äºhttpé•¿è½®è¯¢çš„restTemplate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.restTemplate = restTemplate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 5.å¼€å§‹æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸Šé¢ä»£ç ä¸­çœç•¥äº†å…¶ä»–å‡½æ•°å’Œç›¸å…³å­—æ®µï¼Œåœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆå±æ€§çš„åˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯ï¼š</p><ul><li><p>è®¾ç½®<code>accessTokenManager</code>ï¼Œå®šæ—¶å‘<code>admin</code>è¯·æ±‚æ›´æ–°<code>accessToken</code>çš„å€¼ã€‚ç„¶åæ¯æ¬¡å‘<code>admin</code>å‘èµ·è¯·æ±‚æ—¶éƒ½å¿…é¡»å°†<code>header</code>çš„<code>X-Access-Token</code>å±æ€§è®¾ç½®æˆ<code>accessToken</code>å¯¹åº”çš„å€¼ï¼›</p></li><li><p>åˆ›å»ºæ•°æ®å¤„ç†å™¨ï¼Œç”¨äºåç»­ç¼“å­˜å„ç§ç±»å‹çš„æ•°æ®ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œè®¤è¯æ•°æ®ï¼‰ï¼›</p></li><li><p>è·å–<code>admin</code>å±æ€§é…ç½®ï¼Œä¸»è¦æ˜¯è·å–<code>admin</code>çš„<code>url</code>ï¼Œ<code>admin</code>æœ‰å¯èƒ½æ˜¯é›†ç¾¤ï¼Œå¤šä¸ªç”¨é€—å·<code>(,)</code>åˆ†å‰²ï¼›</p></li><li><p>è®¾ç½®<code>RestTemplate</code>ï¼Œç”¨äºå‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼›</p></li><li><p>å¼€å§‹æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡ã€‚</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-å¼€å§‹é•¿è½®è¯¢"></a>2.3 å¼€å§‹é•¿è½®è¯¢<a class="hash-link" href="#23-å¼€å§‹é•¿è½®è¯¢" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService#start()</li></ul><p>åœ¨<code>start()</code>æ–¹æ³•ä¸­ï¼Œå¹²äº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€ä¸ªæ˜¯è·å–å…¨é‡æ•°æ®ï¼Œå³è¯·æ±‚<code>admin</code>ç«¯è·å–æ‰€æœ‰éœ€è¦åŒæ­¥çš„æ•°æ®ï¼Œç„¶åå°†è·å–åˆ°çš„æ•°æ®ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­ã€‚å¦ä¸€ä¸ªæ˜¯å¼€å¯å¤šçº¿ç¨‹æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // // åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œé€šè¿‡åŸå­ç±»å®ç°ã€‚ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆæ¬¡å¯åŠ¨ï¼Œè·å–å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¸€ä¸ªåå°æœåŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¼€å§‹é•¿è½®è¯¢ï¼Œä¸€ä¸ªadminæœåŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨äºæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="231-è·å–å…¨é‡æ•°æ®"></a>2.3.1 è·å–å…¨é‡æ•°æ®<a class="hash-link" href="#231-è·å–å…¨é‡æ•°æ®" title="Direct link to heading">#</a></h5><ul><li>HttpSyncDataService#fetchGroupConfig()</li></ul><p><code>ShenYu</code>å°†æ‰€æœ‰éœ€è¦åŒæ­¥çš„æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æœ‰5ç§æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯æ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œè®¤è¯æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum ConfigGroupEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    APP_AUTH, // è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PLUGIN, //æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RULE, // è§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECTOR, // é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA; // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>admin</code>æœ‰å¯èƒ½æ˜¯é›†ç¾¤ï¼Œè¿™é‡Œé€šè¿‡å¾ªç¯çš„æ–¹å¼å‘æ¯ä¸ª<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œæœ‰ä¸€ä¸ªæ‰§è¡ŒæˆåŠŸäº†ï¼Œé‚£ä¹ˆå‘<code>admin</code>è·å–å…¨é‡æ•°æ®å¹¶ç¼“å­˜åˆ°ç½‘å…³çš„æ“ä½œå°±æ‰§è¡ŒæˆåŠŸã€‚å¦‚æœå‡ºç°äº†å¼‚å¸¸ï¼Œå°±å‘ä¸‹ä¸€ä¸ª<code>admin</code>å‘èµ·è¯·æ±‚ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void fetchGroupConfig(final ConfigGroupEnum... groups) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // adminæœ‰å¯èƒ½æ˜¯é›†ç¾¤ï¼Œè¿™é‡Œé€šè¿‡å¾ªç¯çš„æ–¹å¼å‘æ¯ä¸ªadminå‘èµ·è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int index = 0; index &lt; this.serverList.size(); index++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      String server = serverList.get(index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // çœŸæ­£å»æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.doFetchGroupConfig(server, groups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æœ‰ä¸€ä¸ªæˆåŠŸï¼Œå°±æˆåŠŸäº†ï¼Œå¯ä»¥é€€å‡ºå¾ªç¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‡ºç°å¼‚å¸¸ï¼Œå°è¯•æ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æœ€åä¸€ä¸ªä¹Ÿæ‰§è¡Œå¤±è´¥äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (index &gt;= serverList.size() - 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          throw e;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.warn(&quot;fetch config fail, try another one: {}&quot;, serverList.get(index + 1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doFetchGroupConfig()</li></ul><p>åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ‹¼è£…è¯·æ±‚å‚æ•°ï¼Œç„¶åé€šè¿‡<code>httpClient</code>å‘èµ·è¯·æ±‚ï¼Œåˆ°<code>admin</code>ä¸­è·å–æ•°æ®ï¼Œæœ€åå°†è·å–åˆ°çš„æ•°æ®æ›´æ–°åˆ°ç½‘å…³å†…å­˜ä¸­ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void doFetchGroupConfig(final String server, final ConfigGroupEnum... groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. æ‹¼è¯·æ±‚å‚æ•°ï¼Œæ‰€æœ‰åˆ†ç»„æšä¸¾ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    StringBuilder params = new StringBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (ConfigGroupEnum groupKey : groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      params.append(&quot;groupKeys&quot;).append(&quot;=&quot;).append(groupKey.name()).append(&quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // adminç«¯æä¾›çš„æ¥å£  /configs/fetch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String url = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_FETCH + &quot;?&quot; + StringUtils.removeEnd(params.toString(), &quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;request configs: [{}]&quot;, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String json;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      HttpHeaders headers = new HttpHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // è®¾ç½®accessToken</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      HttpEntity&lt;String&gt; httpEntity = new HttpEntity&lt;&gt;(headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 2. å‘èµ·è¯·æ±‚ï¼Œè·å–å˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      json = this.restTemplate.exchange(url, HttpMethod.GET, httpEntity, String.class).getBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      String message = String.format(&quot;fetch config fail from server[%s], %s&quot;, url, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.warn(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3. æ›´æ–°ç½‘å…³å†…å­˜ä¸­æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean updated = this.updateCacheWithJson(json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (updated) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.debug(&quot;get latest configs: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ›´æ–°æˆåŠŸï¼Œæ­¤æ–¹æ³•å°±æ‰§è¡Œå®Œæˆäº†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;The config of the server[{}] has not been updated or is out of date. Wait for 30s to listen for changes again.&quot;, server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æœåŠ¡ç«¯æ²¡æœ‰æ•°æ®æ›´æ–°ï¼Œå°±ç­‰30s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ThreadUtils.sleep(TimeUnit.SECONDS, 30);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ° <code>admin</code>ç«¯æä¾›çš„è·å–å…¨é‡æ•°æ®æ¥å£æ˜¯  <code>/configs/fetch</code>ï¼Œè¿™é‡Œå…ˆä¸è¿›ä¸€æ­¥æ·±å…¥ï¼Œæ”¾åœ¨åæ–‡å†åˆ†æã€‚</p><p>è·å–åˆ°<code>admin</code>è¿”å›ç»“æœæ•°æ®ï¼Œå¹¶æˆåŠŸæ›´æ–°ï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•å°±æ‰§è¡Œç»“æŸäº†ã€‚å¦‚æœæ²¡æœ‰æ›´æ–°æˆåŠŸï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æ˜¯æœåŠ¡ç«¯æ²¡æœ‰æ•°æ®æ›´æ–°ï¼Œå°±ç­‰å¾…<code>30s</code>ã€‚</p><p>è¿™é‡Œéœ€è¦æå‰è¯´æ˜ä¸€ä¸‹ï¼Œç½‘å…³åœ¨åˆ¤æ–­æ˜¯å¦æ›´æ–°æˆåŠŸæ—¶ï¼Œæœ‰æ¯”å¯¹æ•°æ®çš„æ“ä½œï¼Œé©¬ä¸Šå°±ä¼šæåˆ°ã€‚</p><ul><li>HttpSyncDataService#updateCacheWithJson()</li></ul><p>æ›´æ–°ç½‘å…³å†…å­˜ä¸­çš„æ•°æ®ã€‚ä½¿ç”¨<code>GSON</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œä»å±æ€§<code>data</code>ä¸­æ‹¿çœŸæ­£çš„æ•°æ®ï¼Œç„¶åäº¤ç»™<code>DataRefreshFactory</code>å»åšæ›´æ–°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean updateCacheWithJson(final String json) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä½¿ç”¨GSONè¿›è¡Œååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject jsonObject = GSON.fromJson(json, JsonObject.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // if the config cache will be updated?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory.executor(jsonObject.getAsJsonObject(&quot;data&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataRefreshFactory#executor()</li></ul><p>æ ¹æ®ä¸åŒæ•°æ®ç±»å‹å»æ›´æ–°æ•°æ®ï¼Œè¿”å›æ›´æ–°ç»“æœã€‚å…·ä½“æ›´æ–°é€»è¾‘äº¤ç»™äº†<code>dataRefresh.refresh()</code>æ–¹æ³•ã€‚åœ¨æ›´æ–°ç»“æœä¸­ï¼Œæœ‰ä¸€ç§æ•°æ®ç±»å‹è¿›è¡Œäº†æ›´æ–°ï¼Œå°±è¡¨ç¤ºæ­¤æ¬¡æ“ä½œå‘ç”Ÿäº†æ›´æ–°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean executor(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¹¶è¡Œæ›´æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Boolean&gt; result = ENUM_MAP.values().parallelStream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(dataRefresh -&gt; dataRefresh.refresh(data))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æœ‰ä¸€ä¸ªæ›´æ–°å°±è¡¨ç¤ºæ­¤æ¬¡å‘ç”Ÿäº†æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.stream().anyMatch(Boolean.TRUE::equals);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#refresh()</li></ul><p>æ•°æ®æ›´æ–°é€»è¾‘é‡‡ç”¨çš„æ˜¯æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œé€šç”¨æ“ä½œåœ¨æŠ½è±¡æ–¹æ³•ä¸­å®Œæˆï¼Œä¸åŒçš„å®ç°é€»è¾‘ç”±å­ç±»å®Œæˆã€‚5ç§æ•°æ®ç±»å‹å…·ä½“çš„æ›´æ–°é€»è¾‘æœ‰äº›å·®å¼‚ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨é€šç”¨çš„æ›´æ–°é€»è¾‘ï¼Œç±»å›¾å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/data-refresh-a5628c71ea221ffb0a7a45f4ed40ae0e.png"></p><p>åœ¨é€šç”¨çš„<code>refresh()</code>æ–¹æ³•ä¸­ï¼Œè´Ÿè´£æ•°æ®ç±»å‹è½¬æ¢ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå’Œå®é™…çš„æ•°æ®åˆ·æ–°æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataRefresh&lt;T&gt; implements DataRefresh {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Boolean refresh(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ•°æ®ç±»å‹è½¬æ¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    JsonObject jsonObject = convert(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(jsonObject)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean updated = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¾—åˆ°æ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConfigData&lt;T&gt; result = fromJson(jsonObject);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ˜¯å¦éœ€è¦æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.updateCacheIfNeed(result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      updated = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // çœŸæ­£çš„æ›´æ–°é€»è¾‘ï¼Œæ•°æ®åˆ·æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      refresh(result.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return updated;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#updateCacheIfNeed()</li></ul><p>æ•°æ®è½¬æ¢çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹è¿›è¡Œè½¬æ¢ï¼Œæˆ‘ä»¬å°±ä¸å†è¿›ä¸€æ­¥è¿½è¸ªäº†ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦éœ€è¦æ›´æ–°çš„é€»è¾‘ã€‚æ–¹æ³•åæ˜¯<code>updateCacheIfNeed()</code>ï¼Œé€šè¿‡æ–¹æ³•é‡è½½å®ç°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataRefresh&lt;T&gt; implements DataRefresh {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // resultæ˜¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected abstract boolean updateCacheIfNeed(ConfigData&lt;T&gt; result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // newValæ˜¯è·å–åˆ°çš„æœ€æ–°çš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // groupEnum æ˜¯å“ªç§æ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected boolean updateCacheIfNeed(final ConfigData&lt;T&gt; newVal, final ConfigGroupEnum groupEnum) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆç›´æ¥æ”¾åˆ°cacheä¸­ï¼Œè¿”å› trueï¼Œè¡¨ç¤ºæ­¤æ¬¡è¿›è¡Œäº†æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (GROUP_CACHE.putIfAbsent(groupEnum, newVal) == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResultHolder holder = new ResultHolder(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    GROUP_CACHE.merge(groupEnum, newVal, (oldVal, value) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // md5 å€¼ç›¸åŒï¼Œä¸éœ€è¦æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (StringUtils.equals(oldVal.getMd5(), newVal.getMd5())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;Get the same config, the [{}] config cache will not be updated, md5:{}&quot;, groupEnum, oldVal.getMd5());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // å½“å‰ç¼“å­˜çš„æ•°æ®ä¿®æ”¹æ—¶é—´å¤§äº æ–°æ¥çš„æ•°æ®ï¼Œä¸éœ€è¦æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // must compare the last update time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (oldVal.getLastModifyTime() &gt;= newVal.getLastModifyTime()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;Last update time earlier than the current configuration, the [{}] config cache will not be updated&quot;, groupEnum);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;update {} config: {}&quot;, groupEnum, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      holder.result = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return newVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return holder.result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸¤ç§æƒ…å†µä¸éœ€è¦æ›´æ–°ï¼š</p><ul><li>ä¸¤ä¸ªçš„æ•°æ®çš„<code>md5</code> å€¼ç›¸åŒï¼Œä¸éœ€è¦æ›´æ–°;</li><li>å½“å‰ç¼“å­˜çš„æ•°æ®ä¿®æ”¹æ—¶é—´å¤§äº æ–°æ¥çš„æ•°æ®ï¼Œä¸éœ€è¦æ›´æ–°ã€‚</li></ul><p>å…¶ä»–æƒ…å†µéœ€è¦æ›´æ–°æ•°æ®ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œï¼Œå°±å°†<code>start()</code> æ–¹æ³•ä¸­åˆæ¬¡å¯åŠ¨ï¼Œè·å–å…¨é‡æ•°æ®çš„é€»è¾‘åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥æ˜¯é•¿è½®è¯¢çš„æ“ä½œã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å°†<code>start()</code>æ–¹æ³•å†ç²˜è´´ä¸€æ¬¡ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // // åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œé€šè¿‡åŸå­ç±»å®ç°ã€‚ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // åˆæ¬¡å¯åŠ¨ï¼Œè·å–å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // ä¸€ä¸ªåå°æœåŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // å¼€å§‹é•¿è½®è¯¢ï¼Œä¸€ä¸ªadminæœåŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨äºæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="232-æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡"></a>2.3.2 æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡<a class="hash-link" href="#232-æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡" title="Direct link to heading">#</a></h5><ul><li>HttpLongPollingTask#run()</li></ul><p>é•¿è½®è¯¢ä»»åŠ¡æ˜¯<code>HttpLongPollingTask</code>ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œä»»åŠ¡é€»è¾‘åœ¨<code>run()</code>æ–¹æ³•ä¸­ã€‚é€šè¿‡<code>while()</code>å¾ªç¯å®ç°ä¸æ–­æ‰§è¡Œä»»åŠ¡ï¼Œå³é•¿è½®è¯¢ã€‚åœ¨æ¯ä¸€æ¬¡çš„è½®è¯¢ä¸­æœ‰ä¸‰æ¬¡é‡è¯•é€»è¾‘ï¼Œä¸€æ¬¡è½®è¯¢ä»»åŠ¡å¤±è´¥äº†ï¼Œç­‰ <code>5s</code> å†ç»§ç»­ï¼Œ<code>3</code> æ¬¡éƒ½å¤±è´¥äº†ï¼Œç­‰<code>5</code> åˆ†é’Ÿå†è¯•ã€‚</p><p>å¼€å§‹é•¿è½®è¯¢ï¼Œä¸€ä¸ª<code>admin</code>æœåŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨äºæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class HttpLongPollingTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final String server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  HttpLongPollingTask(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.server = server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä¸€ç›´è½®è¯¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (RUNNING.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // é»˜è®¤é‡è¯• 3 æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      int retryTimes = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (int time = 1; time &lt;= retryTimes; time++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          doLongPolling(server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (time &lt; retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.warn(&quot;Long polling failed, tried {} times, {} times left, will be suspended for a while! {}&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    time, retryTimes - time, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é•¿è½®è¯¢å¤±è´¥äº†ï¼Œç­‰ 5s å†ç»§ç»­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadUtils.sleep(TimeUnit.SECONDS, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          LOG.error(&quot;Long polling failed, try again after 5 minutes!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 3 æ¬¡éƒ½å¤±è´¥äº†ï¼Œç­‰ 5 åˆ†é’Ÿå†è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          ThreadUtils.sleep(TimeUnit.MINUTES, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.warn(&quot;Stop http long polling.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doLongPolling()</li></ul><p>æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘ï¼š</p><ul><li>æ ¹æ®æ•°æ®ç±»å‹ç»„è£…è¯·æ±‚å‚æ•°ï¼š<code>md5</code> å’Œ <code>lastModifyTime</code>ï¼›</li><li>ç»„è£…è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ï¼›</li><li>å‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li><li>æ ¹æ®å‘ç”Ÿå˜æ›´çš„ç»„ï¼Œå†å»è·å–æ•°æ®ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void doLongPolling(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç»„è£…è¯·æ±‚å‚æ•°ï¼šmd5 å’Œ lastModifyTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;(8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      ConfigData&lt;?&gt; cacheConfig = factory.cacheConfigData(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (cacheConfig != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String value = String.join(&quot;,&quot;, cacheConfig.getMd5(), String.valueOf(cacheConfig.getLastModifyTime()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        params.put(group.name(), Lists.newArrayList(value));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç»„è£…è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpHeaders headers = new HttpHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¾ç½®accessToken</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(params, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String listenerUrl = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_LISTENER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    JsonArray groupJson;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å‘adminå‘èµ·è¯·æ±‚ï¼Œåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è¿™é‡Œåªæ˜¯åˆ¤æ–­äº†æŸä¸ªç»„æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      String json = this.restTemplate.postForEntity(listenerUrl, httpEntity, String.class).getBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;listener result: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      JsonObject responseFromServer = GsonUtils.getGson().fromJson(json, JsonObject.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      groupJson = responseFromServer.getAsJsonArray(&quot;data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      String message = String.format(&quot;listener configs fail, server:[%s], %s&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ ¹æ®å‘ç”Ÿå˜æ›´çš„ç»„ï¼Œå†å»è·å–æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å®˜ç½‘å¯¹æ­¤å¤„çš„è§£é‡Šï¼š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç½‘å…³æ”¶åˆ°å“åº”ä¿¡æ¯ä¹‹åï¼ŒåªçŸ¥é“æ˜¯å“ªä¸ª Group å‘ç”Ÿäº†é…ç½®å˜æ›´ï¼Œè¿˜éœ€è¦å†æ¬¡è¯·æ±‚è¯¥ Group çš„é…ç½®æ•°æ®ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨ä¸€ä¸ªç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥å°†å˜æ›´çš„æ•°æ®å†™å‡ºï¼Ÿ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™ï¼Œä¹Ÿæ·±å…¥è®¨è®ºè¿‡è¯¥é—®é¢˜ï¼Œå› ä¸º http é•¿è½®è¯¢æœºåˆ¶åªèƒ½ä¿è¯å‡†å®æ—¶ï¼Œå¦‚æœåœ¨ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æˆ–è€…ç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®ï¼Œå¾ˆæœ‰å¯èƒ½ä¾¿é”™è¿‡äº†æŸä¸ªé…ç½®å˜æ›´çš„æ¨é€ï¼Œå®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬åªå‘ŠçŸ¥æŸä¸ª Group ä¿¡æ¯å‘ç”Ÿäº†å˜æ›´ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸ªäººç†è§£ï¼š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¦‚æœå°†å˜æ›´æ•°æ®ç›´æ¥å†™å‡ºï¼Œå½“ç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®æ—¶ï¼Œç¬¬ä¸€æ¬¡æ›´æ–°äº†ï¼Œå°†clientç§»é™¤é˜»å¡é˜Ÿåˆ—ï¼Œè¿”å›å“åº”ä¿¡æ¯ç»™ç½‘å…³ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¦‚æœè¿™ä¸ªæ—¶å€™è¿›è¡Œäº†ç¬¬äºŒæ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆå½“å‰çš„clientæ˜¯ä¸åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡çš„å˜æ›´å°±ä¼šé”™è¿‡ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œä¹Ÿæ˜¯åŒç†ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¿™æ˜¯ä¸€ä¸ªé•¿è½®è¯¢ï¼Œä¸€ä¸ªç½‘å…³ä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼Œå¯èƒ½å­˜åœ¨è€—æ—¶çš„è¿‡ç¨‹ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¦‚æœadminæœ‰æ•°æ®å˜æ›´ï¼Œå½“å‰ç½‘å…³clientæ˜¯æ²¡æœ‰åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå°±ä¸åˆ°æ•°æ®ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(groupJson) &amp;&amp; groupJson.size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // fetch group configuration async.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      ConfigGroupEnum[] changedGroups = GsonUtils.getGson().fromJson(groupJson, ConfigGroupEnum[].class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;Group config changed: {}&quot;, Arrays.toString(changedGroups));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.doFetchGroupConfig(server, changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œéœ€è¦ç‰¹åˆ«è§£é‡Šä¸€ç‚¹çš„æ˜¯ï¼šåœ¨é•¿è½®è¯¢ä»»åŠ¡ä¸­ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥æ‹¿åˆ°å˜æ›´çš„æ•°æ®ï¼Ÿè€Œæ˜¯å…ˆåˆ¤æ–­å“ªä¸ªåˆ†ç»„æ•°æ®å‘ç”Ÿäº†å˜æ›´ï¼Œç„¶åå†æ¬¡è¯·æ±‚<code>admin</code>ï¼Œè·å–å˜æ›´æ•°æ®ï¼Ÿ</p><p>å®˜ç½‘å¯¹æ­¤å¤„çš„è§£é‡Šæ˜¯ï¼š</p><blockquote><p>ç½‘å…³æ”¶åˆ°å“åº”ä¿¡æ¯ä¹‹åï¼ŒåªçŸ¥é“æ˜¯å“ªä¸ª Group å‘ç”Ÿäº†é…ç½®å˜æ›´ï¼Œè¿˜éœ€è¦å†æ¬¡è¯·æ±‚è¯¥ Group çš„é…ç½®æ•°æ®ã€‚
è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨ä¸€ä¸ªç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥å°†å˜æ›´çš„æ•°æ®å†™å‡ºï¼Ÿ
æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™ï¼Œä¹Ÿæ·±å…¥è®¨è®ºè¿‡è¯¥é—®é¢˜ï¼Œå› ä¸º <code>http</code> é•¿è½®è¯¢æœºåˆ¶åªèƒ½ä¿è¯å‡†å®æ—¶ï¼Œå¦‚æœåœ¨ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œ
æˆ–è€…ç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®ï¼Œå¾ˆæœ‰å¯èƒ½ä¾¿é”™è¿‡äº†æŸä¸ªé…ç½®å˜æ›´çš„æ¨é€ï¼Œå®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬åªå‘ŠçŸ¥æŸä¸ª Group ä¿¡æ¯å‘ç”Ÿäº†å˜æ›´ã€‚</p></blockquote><p>ä¸ªäººç†è§£æ˜¯ï¼š</p><blockquote><p>å¦‚æœå°†å˜æ›´æ•°æ®ç›´æ¥å†™å‡ºï¼Œç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®æ—¶ï¼Œç¬¬ä¸€æ¬¡æ›´æ–°äº†ï¼Œå°†<code>client</code>ç§»é™¤é˜»å¡é˜Ÿåˆ—ï¼Œè¿”å›å“åº”ä¿¡æ¯ç»™ç½‘å…³ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™è¿›è¡Œäº†ç¬¬äºŒæ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆå½“å‰çš„<code>client</code>æ˜¯ä¸åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡çš„å˜æ›´å°±ä¼šé”™è¿‡ã€‚ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œä¹Ÿæ˜¯åŒç†ã€‚ è¿™æ˜¯ä¸€ä¸ªé•¿è½®è¯¢ï¼Œä¸€ä¸ªç½‘å…³ä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼Œå¯èƒ½å­˜åœ¨è€—æ—¶çš„è¿‡ç¨‹ã€‚å¦‚æœ<code>admin</code>æœ‰æ•°æ®å˜æ›´ï¼Œå½“å‰ç½‘å…³clientæ˜¯æ²¡æœ‰åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå°±ä¼šæ›´æ–°ä¸åˆ°æ•°æ®ã€‚</p></blockquote><p>æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ†æåˆ°<code>admin</code>ç«¯çš„å¤„ç†é€»è¾‘ï¼Œå…ˆå¤§æ¦‚è¯´ä¸€ä¸‹ã€‚åœ¨<code>admin</code>ç«¯ï¼Œä¼šå°†ç½‘å…³<code>client</code>æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œæœ‰æ•°æ®å˜æ›´ï¼Œç½‘å…³<code>client</code>å°±ä¼šå‡ºé˜Ÿåˆ—ï¼Œå‘é€å˜æ›´æ•°æ®ã€‚æ‰€ä»¥ï¼Œå¦‚æœæœ‰æ•°æ®å˜æ›´æ—¶ï¼Œç½‘å…³<code>client</code>ä¸åœ¨é˜»å¡é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±æ— æ³•å¾—åˆ°å½“å‰å˜æ›´çš„æ•°æ®ã€‚</p><p>çŸ¥é“å“ªä¸ªåˆ†ç»„æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œä¸»åŠ¨å†å‘<code>admin</code>è·å–å˜æ›´çš„æ•°æ®ï¼Œæ ¹æ®åˆ†ç»„ä¸åŒï¼Œå…¨é‡æ‹¿æ•°æ®ã€‚è°ƒç”¨æ–¹æ³•æ˜¯<code>doFetchGroupConfig()</code>ï¼Œè¿™ä¸ªåœ¨å‰é¢å·²ç»åˆ†æè¿‡äº†ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œï¼Œç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æ“ä½œå°±å®Œæˆäº†ã€‚é•¿è½®è¯¢ä»»åŠ¡å°±æ˜¯ä¸æ–­å‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼Œå¦‚æœæœ‰åˆ†ç»„æ•°æ®å‘ç”Ÿå˜æ›´ï¼Œé‚£ä¹ˆå°±å†ä¸»åŠ¨å‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œè·å–å˜æ›´æ•°æ®ï¼Œç„¶åæ›´æ–°ç½‘å…³å†…å­˜ä¸­çš„æ•°æ®ã€‚</p><p>ç½‘å…³ç«¯é•¿è½®è¯¢ä»»åŠ¡æµç¨‹ï¼š</p><p><img src="/zh/assets/images/http-long-polling-sequence-zh-9d03d97d038b1f3348c31b9eb0133086.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-adminæ•°æ®åŒæ­¥"></a>3. adminæ•°æ®åŒæ­¥<a class="hash-link" href="#3-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>ä»å‰é¢åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç½‘å…³ç«¯ä¸»è¦è°ƒç”¨<code>admin</code>çš„ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li><code>/configs/listener</code>ï¼šåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li><li><code>/configs/fetch</code>ï¼šè·å–å˜æ›´ç»„æ•°æ®ã€‚</li></ul><p>ç›´æ¥ä»è¿™ä¸¤ä¸ªæ¥å£åˆ†æçš„è¯ï¼Œå¯èƒ½æœ‰çš„åœ°æ–¹ä¸å¥½ç†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ä»<code>admin</code>å¯åŠ¨æµç¨‹å¼€å§‹åˆ†ææ•°æ®åŒæ­¥è¿‡ç¨‹ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-åŠ è½½é…ç½®"></a>3.1 åŠ è½½é…ç½®<a class="hash-link" href="#31-åŠ è½½é…ç½®" title="Direct link to heading">#</a></h4><p>å¦‚æœåœ¨é…ç½®æ–‡ä»¶<code>application.yml</code>ä¸­ï¼Œè¿›è¡Œäº†å¦‚ä¸‹é…ç½®ï¼Œå°±è¡¨ç¤ºé€šè¿‡<code>httpé•¿è½®è¯¢</code>çš„æ–¹å¼è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç¨‹åºå¯åŠ¨æ—¶ï¼Œé€šè¿‡<code>springboot</code>æ¡ä»¶è£…é…å®ç°æ•°æ®åŒæ­¥ç±»çš„é…ç½®åŠ è½½ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»º<code>HttpLongPollingDataChangedListener</code>ï¼Œè´Ÿè´£å¤„ç†é•¿è½®è¯¢çš„ç›¸å…³å®ç°é€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * httpé•¿è½®è¯¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * http long polling.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;shenyu.sync.http.enabled&quot;, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(HttpSyncProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class HttpLongPollingListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public HttpLongPollingDataChangedListener httpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new HttpLongPollingDataChangedListener(httpSyncProperties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-æ•°æ®å˜æ›´ç›‘å¬å™¨å®ä¾‹åŒ–"></a>3.2 æ•°æ®å˜æ›´ç›‘å¬å™¨å®ä¾‹åŒ–<a class="hash-link" href="#32-æ•°æ®å˜æ›´ç›‘å¬å™¨å®ä¾‹åŒ–" title="Direct link to heading">#</a></h4><ul><li>HttpLongPollingDataChangedListener</li></ul><p>æ•°æ®å˜æ›´ç›‘å¬å™¨é€šè¿‡æ„é€ å‡½æ•°çš„æ–¹å¼å®Œæˆå®ä¾‹åŒ–å’Œåˆå§‹åŒ–æ“ä½œã€‚åœ¨æ„é€ å‡½æ•°ä¸­ä¼šåˆ›å»ºé˜»å¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾å®¢æˆ·ç«¯ï¼›åˆ›å»ºçº¿ç¨‹æ± ï¼Œç”¨äºæ‰§è¡Œå»¶è¿Ÿä»»åŠ¡ï¼Œå‘¨æœŸä»»åŠ¡ï¼›ä¿å­˜é•¿è½®è¯¢ç›¸å…³å±æ€§ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œæ˜¯ç½‘å…³ï¼‰1024ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.clients = new ArrayBlockingQueue&lt;&gt;(1024);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºçº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ScheduledThreadPoolExecutor å¯ä»¥æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡ï¼Œå‘¨æœŸä»»åŠ¡ï¼Œæ™®é€šä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.scheduler = new ScheduledThreadPoolExecutor(1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuThreadFactory.create(&quot;long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é•¿è½®è¯¢çš„å±æ€§ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.httpSyncProperties = httpSyncProperties;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦å¤–ï¼Œå®ƒçš„ç±»å›¾å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-1c8e4c0f4279cdb33b27c52cc933cac5.png"></p><p>å®ç°äº†<code>InitializingBean</code>æ¥å£ï¼Œæ‰€ä»¥åœ¨<code>bean</code>çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ<code>afterInitialize()</code>æ–¹æ³•ã€‚é€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼šæ›´æ–°å†…å­˜ä¸­<code>ï¼ˆCACHEï¼‰</code>çš„æ•°æ®æ¯éš”<code>5</code>åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œ<code>5</code>åˆ†é’Ÿåå¼€å§‹æ‰§è¡Œã€‚åˆ·æ–°æœ¬åœ°ç¼“å­˜å°±æ˜¯ä»æ•°æ®åº“è¯»å–æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆè¿™é‡Œå°±æ˜¯å†…å­˜ï¼‰ï¼Œé€šè¿‡<code>refreshLocalCache()</code>å®Œæˆã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * åœ¨ InitializingBeanæ¥å£ä¸­çš„afterPropertiesSet()æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œå³åœ¨beançš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected void afterInitialize() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long syncInterval = httpSyncProperties.getRefreshInterval().toMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼šæ›´æ–°å†…å­˜ä¸­ï¼ˆCACHEï¼‰çš„æ•°æ®æ¯éš”5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œ5åˆ†é’Ÿåå¼€å§‹æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é˜²æ­¢adminå…ˆå¯åŠ¨ä¸€æ®µæ—¶é—´åï¼Œäº§ç”Ÿäº†æ•°æ®ï¼›ç„¶åç½‘å…³åˆæ¬¡è¿æ¥æ—¶ï¼Œæ²¡æœ‰æ‹¿åˆ°å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduler.scheduleWithFixedDelay(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;http sync strategy refresh config start.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä»æ•°æ®åº“è¯»å–æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆè¿™é‡Œå°±æ˜¯å†…å­˜ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.refreshLocalCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;http sync strategy refresh config success.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.error(&quot;http sync strategy refresh config error!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, syncInterval, syncInterval, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;http sync strategy refresh interval: {}ms&quot;, syncInterval);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>refreshLocalCache()</li></ul><p>åˆ†åˆ«å¯¹5ç§æ•°æ®ç±»å‹è¿›è¡Œæ›´æ–°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ä»æ•°æ®åº“è¯»å–æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆè¿™é‡Œå°±æ˜¯å†…å­˜ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void refreshLocalCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ›´æ–°è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.updateAppAuthCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ›´æ–°æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ›´æ–°è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.updateRuleCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ›´æ–°é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.updateSelectorCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ›´æ–°å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.updateMetaDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>5ä¸ªæ›´æ–°æ–¹æ³•çš„é€»è¾‘æ˜¯ç±»ä¼¼çš„ï¼Œè°ƒç”¨<code>service</code>æ–¹æ³•è·å–æ•°æ®ï¼Œç„¶åæ”¾åˆ°å†…å­˜<code>CACHE</code>ä¸­ã€‚ä»¥æ›´æ–°è§„åˆ™æ•°æ®æ–¹æ³•<code>updateRuleCache()</code>ä¸ºä¾‹ï¼Œä¼ å…¥è§„åˆ™æšä¸¾ç±»å‹ï¼Œè°ƒç”¨<code>ruleService.listAll()</code>ä»æ•°æ®åº“è·å–æ‰€æœ‰è§„åˆ™æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Update rule cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateRuleCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateCache(ConfigGroupEnum.RULE, ruleService.listAll());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>updateCache()</li></ul><p>ä½¿ç”¨æ•°æ®åº“ä¸­çš„æ•°æ®æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ç¼“å­˜æ•°æ®çš„ Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected static final ConcurrentMap&lt;String, ConfigDataCache&gt; CACHE = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * if md5 is not the same as the original, then update lcoal cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param group ConfigGroupEnum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param &lt;T&gt; the type of class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param data the new config data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected &lt;T&gt; void updateCache(final ConfigGroupEnum group, final List&lt;T&gt; data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ•°æ®åºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String json = GsonUtils.getInstance().toJson(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ä¼ å…¥md5å€¼å’Œä¿®æ”¹æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConfigDataCache newVal = new ConfigDataCache(group.name(), json, Md5Utils.md5(json), System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ›´æ–°åˆ†ç»„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConfigDataCache oldVal = CACHE.put(newVal.getGroup(), newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;update config cache[{}], old: {}, updated: {}&quot;, group, oldVal, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆå§‹åŒ–çš„è¿‡ç¨‹å°±æ˜¯å¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå®šæ—¶ä»æ•°æ®åº“è·å–æ•°æ®æ›´æ–°å†…å­˜æ•°æ®ã€‚</p><p>æ¥ä¸‹æ¥å¼€å§‹å¯¹ä¸¤ä¸ªæ¥å£å¼€å§‹åˆ†æï¼š</p><ul><li><code>/configs/listener</code>ï¼šåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li><li><code>/configs/fetch</code>ï¼šè·å–å˜æ›´ç»„æ•°æ®ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33--æ•°æ®å˜æ›´è½®è¯¢æ¥å£"></a>3.3  æ•°æ®å˜æ›´è½®è¯¢æ¥å£<a class="hash-link" href="#33--æ•°æ®å˜æ›´è½®è¯¢æ¥å£" title="Direct link to heading">#</a></h4><ul><li><code>/configs/listener</code>ï¼šåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li></ul><p>æ¥å£ç±»æ˜¯<code>ConfigController</code>ï¼Œåªæœ‰ä½¿ç”¨<code>httpé•¿è½®è¯¢</code>è¿›è¡Œæ•°æ®åŒæ­¥æ—¶æ‰ä¼šç”Ÿæ•ˆã€‚æ¥å£æ–¹æ³•<code>listener()</code>æ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>doLongPolling()</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * This Controller only when HttpLongPollingDataChangedListener exist, will take effect.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.longPollingListener = longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç›‘å¬æ•°æ®å˜æ›´ï¼Œæ‰§è¡Œé•¿è½®è¯¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request  the request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response the response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(value = &quot;/listener&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void listener(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        longPollingListener.doLongPolling(request, response);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#doLongPolling()</li></ul><p>æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡ï¼šå¦‚æœæœ‰æ•°æ®å˜æ›´ï¼Œå°†ä¼šç«‹å³å“åº”ç»™å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ç«¯ï¼‰ã€‚å¦åˆ™ï¼Œå®¢æˆ·ç«¯ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®å˜æ›´æˆ–è€…è¶…æ—¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * æ‰§è¡Œé•¿è½®è¯¢ï¼šå¦‚æœæœ‰æ•°æ®å˜æ›´ï¼Œä¼šç«‹å³å“åº”ç»™å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ç«¯ï¼‰ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * å¦åˆ™ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®å˜æ›´æˆ–è€…è¶…æ—¶ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void doLongPolling(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // compare group md5</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ¯”è¾ƒmd5ï¼Œåˆ¤æ–­ç½‘å…³çš„æ•°æ®å’Œadminç«¯çš„æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œå¾—åˆ°å‘ç”Ÿå˜æ›´çš„æ•°æ®ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;ConfigGroupEnum&gt; changedGroup = compareChangedGroup(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String clientIp = getRemoteIp(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // response immediately.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æœ‰å˜æ›´çš„æ•°æ®ï¼Œåˆ™ç«‹å³å‘ç½‘å…³å“åº”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (CollectionUtils.isNotEmpty(changedGroup)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.generateResponse(response, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Log.info(&quot;send response with the changed group, ip={}, group={}&quot;, clientIp, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ²¡æœ‰å˜æ›´ï¼Œåˆ™å°†å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ï¼‰æ”¾è¿›é˜»å¡é˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final AsyncContext asyncContext = request.startAsync();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncContext.setTimeout(0L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduler.execute(new LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#compareChangedGroup()</li></ul><p>åˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼Œåˆ¤æ–­é€»è¾‘æ˜¯æ¯”è¾ƒç½‘å…³ç«¯å’Œ<code>admin</code>ç«¯çš„<code>md5</code>å€¼å’Œ<code>lastModifyTime</code>ã€‚</p><ul><li>å¦‚æœ<code>md5</code>å€¼ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–°ï¼›</li><li>å¦‚æœ<code>admin</code>ç«¯çš„<code>lastModifyTime</code>å¤§äºç½‘å…³ç«¯çš„<code>lastModifyTime</code>ï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–°ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;ConfigGroupEnum&gt; compareChangedGroup(final HttpServletRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConfigGroupEnum&gt; changedGroup = new ArrayList&lt;&gt;(ConfigGroupEnum.values().length);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ç½‘å…³ç«¯æ•°æ®çš„md5å€¼å’ŒlastModifyTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] params = StringUtils.split(request.getParameter(group.name()), &#x27;,&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (params == null || params.length != 2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuException(&quot;group param invalid:&quot; + request.getParameter(group.name()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String clientMd5 = params[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long clientModifyTime = NumberUtils.toLong(params[1]);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigDataCache serverCache = CACHE.get(group.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // do check. åˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.checkCacheDelayAndUpdate(serverCache, clientMd5, clientModifyTime)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changedGroup.add(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return changedGroup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>LongPollingClient</li></ul><p>æ²¡æœ‰å˜æ›´æ•°æ®ï¼Œåˆ™å°†å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ï¼‰æ”¾è¿›é˜»å¡é˜Ÿåˆ—ã€‚é˜»å¡æ—¶é—´æ˜¯60ç§’ï¼Œå³60ç§’åç§»é™¤ï¼Œå¹¶å“åº”å®¢æˆ·ç«¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class LongPollingClient implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å…ˆè®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š60ç§’åç§»é™¤ï¼Œå¹¶å“åº”å®¢æˆ·ç«¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.asyncTimeoutFuture = scheduler.schedule(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    clients.remove(LongPollingClient.this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;ConfigGroupEnum&gt; changedGroups = compareChangedGroup((HttpServletRequest) asyncContext.getRequest());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendResponse(changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, timeoutTime, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.add(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;add long polling client error&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Send response.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param changedGroups the changed groups</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        void sendResponse(final List&lt;ConfigGroupEnum&gt; changedGroups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // cancel scheduler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (null != asyncTimeoutFuture) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                asyncTimeoutFuture.cancel(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“åº”å˜æ›´çš„ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            generateResponse((HttpServletResponse) asyncContext.getResponse(), changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            asyncContext.complete();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34--è·å–å˜æ›´æ•°æ®æ¥å£"></a>3.4  è·å–å˜æ›´æ•°æ®æ¥å£<a class="hash-link" href="#34--è·å–å˜æ›´æ•°æ®æ¥å£" title="Direct link to heading">#</a></h4><ul><li><code>/configs/fetch</code>ï¼šè·å–å˜æ›´æ•°æ®ï¼›</li></ul><p>æ ¹æ®ç½‘å…³ä¼ å…¥çš„å‚æ•°ï¼Œè·å–åˆ†ç»„æ•°æ®ï¼Œè¿”å›ç»“æœã€‚ä¸»è¦å®ç°æ–¹æ³•æ˜¯<code>longPollingListener.fetchConfig()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.longPollingListener = longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Fetch configs shenyu result.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡è·å–åˆ†ç»„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupKeys the group keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the shenyu result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/fetch&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult fetchConfigs(@NotNull final String[] groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ConfigData&lt;?&gt;&gt; result = Maps.newHashMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String groupKey : groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;?&gt; data = longPollingListener.fetchConfig(ConfigGroupEnum.valueOf(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.put(groupKey, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.SUCCESS, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // çœç•¥äº†å…¶ä»–æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataChangedListener#fetchConfig()</li></ul><p>æ•°æ®è·å–ç›´æ¥ä»<code>CACHE</code>ä¸­æ‹¿ï¼Œç„¶åæ ¹æ®ä¸åŒåˆ†ç»„ç±»å‹è¿›è¡ŒåŒ¹é…ï¼Œå°è£…ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * fetch configuration from cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * è·å–åˆ†ç»„ä¸‹çš„å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param groupKey the group key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return the configuration data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ConfigData&lt;?&gt; fetchConfig(final ConfigGroupEnum groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç›´æ¥ä» CACHE ä¸­æ‹¿æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConfigDataCache config = CACHE.get(groupKey.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      case APP_AUTH: // è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildConfigData(config, AppAuthData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      case PLUGIN: // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildConfigData(config, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      case RULE:   // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildConfigData(config, RuleData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      case SELECTOR:  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildConfigData(config, SelectorData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      case META_DATA: // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildConfigData(config, MetaData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;Unexpected groupKey: &quot; + groupKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="35-æ•°æ®å˜æ›´"></a>3.5 æ•°æ®å˜æ›´<a class="hash-link" href="#35-æ•°æ®å˜æ›´" title="Direct link to heading">#</a></h4><p>åœ¨ä¹‹å‰çš„<code>websocket</code>æ•°æ®åŒæ­¥å’Œ<code>zookeeper</code>æ•°æ®åŒæ­¥æºç åˆ†ææ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“<code>admin</code>ç«¯æ•°æ®åŒæ­¥è®¾è®¡ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-admin-2f384e703652e9e28db8447b1cbdaea7.png"></p><p>å„ç§æ•°æ®å˜æ›´ç›‘å¬å™¨éƒ½æ˜¯<code>DataChangedListener</code>çš„å­ç±»ã€‚</p><p>å½“åœ¨<code>admin</code>ç«¯ä¿®æ”¹æ•°æ®åï¼Œé€šè¿‡<code>Spring</code>çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œå‘é€äº‹ä»¶é€šçŸ¥ã€‚å‘é€é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Event forwarders, which forward the changed events to each ConfigEventListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®å˜æ›´äº‹ä»¶åˆ†å‘å™¨ï¼šå½“adminç«¯æœ‰æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œå°†å˜æ›´æ•°æ®åŒæ­¥åˆ° ShenYu ç½‘å…³</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®å˜æ›´ä¾èµ–äºSpringçš„äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼šApplicationEventPublisher --&gt; ApplicationEvent --&gt; ApplicationListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å½“é€‰æ‹©å™¨æ•°æ®æ›´æ–°æ—¶ï¼Œæ›´æ–°APIæ–‡æ¡£ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‡è®¾ï¼Œå¯¹æ’ä»¶ä¿¡æ¯è¿›è¡Œäº†ä¿®æ”¹ï¼Œé€šè¿‡<code>httpé•¿è½®è¯¢</code>çš„æ–¹å¼è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œé‚£ä¹ˆ<code>listener.onPluginChanged()</code>çš„å®é™…è°ƒç”¨çš„æ˜¯<code>org.apache.shenyu.admin.listener.AbstractDataChangedListener#onPluginChanged</code>ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åœ¨adminçš„æ“ä½œï¼Œæœ‰æ’ä»¶å‘ç”Ÿäº†æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param changed   the changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param eventType the event type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(changed)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°å†…å­˜CACHE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰§è¡Œå˜æ›´ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.afterPluginChanged(changed, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ‰ä¸¤ä¸ªå¤„ç†æ“ä½œï¼Œä¸€æ˜¯æ›´æ–°å†…å­˜<code>CACHE</code>ï¼Œè¿™ä¸ªåœ¨å‰é¢åˆ†æè¿‡äº†ï¼›å¦ä¸€ä¸ªæ˜¯æ‰§è¡Œå˜æ›´ä»»åŠ¡ï¼Œåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚</p><ul><li>HttpLongPollingDataChangedListener#afterPluginChanged()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void afterPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.execute(new DataChangeTask(ConfigGroupEnum.PLUGIN));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataChangeTask</li></ul><p>æ•°æ®å˜æ›´ä»»åŠ¡ï¼šå°†é˜»å¡é˜Ÿåˆ—ä¸­çš„å®¢æˆ·ç«¯ä¾æ¬¡ç§»é™¤ï¼Œå¹¶å‘é€å“åº”ï¼Œé€šçŸ¥ç½‘å…³æœ‰ç»„æ•°æ®å‘ç”Ÿå˜æ›´ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class DataChangeTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //çœç•¥äº†å…¶ä»–é€»è¾‘ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é˜»å¡é˜Ÿåˆ—ä¸­çš„å®¢æˆ·ç«¯è¶…è¿‡äº†ç»™å®šçš„å€¼100ï¼Œåˆ™åˆ†æ‰¹æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clients.size() &gt; httpSyncProperties.getNotifyBatchSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;LongPollingClient&gt; targetClients = new ArrayList&lt;&gt;(clients.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.drainTo(targetClients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;List&lt;LongPollingClient&gt;&gt; partitionClients = Lists.partition(targetClients, httpSyncProperties.getNotifyBatchSize());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // åˆ†æ‰¹æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                partitionClients.forEach(item -&gt; scheduler.execute(() -&gt; doRun(item)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ‰§è¡Œä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                doRun(clients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void doRun(final Collection&lt;LongPollingClient&gt; clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯å‘ç”Ÿäº†æ•°æ®å˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Iterator&lt;LongPollingClient&gt; iter = clients.iterator(); iter.hasNext();) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LongPollingClient client = iter.next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                iter.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å‘é€å“åº”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.sendResponse(Collections.singletonList(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;send response with the changed group,ip={}, group={}, changeTime={}&quot;, client.ip, groupKey, changeTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ï¼Œ<code>admin</code>ç«¯æ•°æ®åŒæ­¥é€»è¾‘å°±åˆ†æå®Œäº†ã€‚åœ¨åŸºäº<code>httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥æ˜¯ï¼Œå®ƒä¸»è¦æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š</p><ul><li>æä¾›æ•°æ®å˜æ›´ç›‘å¬æ¥å£ï¼›</li><li>æä¾›è·å–å˜æ›´æ•°æ®æ¥å£ï¼›</li><li>æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œç§»é™¤é˜»å¡é˜Ÿåˆ—ä¸­çš„å®¢æˆ·ç«¯ï¼Œå¹¶å“åº”ç»“æœã€‚</li></ul><p>æœ€åï¼Œç”¨ä¸‰å¼ å›¾æè¿°ä¸‹<code>admin</code>ç«¯é•¿è½®è¯¢ä»»åŠ¡æµç¨‹ï¼š</p><ul><li><code>/configs/listener</code>æ•°æ®å˜æ›´ç›‘å¬æ¥å£ï¼š</li></ul><p><img src="/zh/assets/images/http-long-polling-listener-zh-a0458f05d312cb977f000662b3791567.png"></p><ul><li><code>/configs/fetch</code>è·å–å˜æ›´æ•°æ®æ¥å£ï¼š</li></ul><p><img src="/zh/assets/images/http-long-polling-fetch-zh-59963a9119cc79d08e95aa5f4442f413.png"></p><ul><li>åœ¨adminåå°ç®¡ç†ç³»ç»Ÿæ›´æ–°æ•°æ®ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥ï¼š</li></ul><p><img src="/zh/assets/images/http-long-polling-admin-update-zh-97645cfabead723acf9243cfae2d2dbc.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-æ€»ç»“"></a>4. æ€»ç»“<a class="hash-link" href="#4-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡ä¸»è¦å¯¹<code>ShenYu</code>ç½‘å…³ä¸­çš„<code>httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li><code>httpé•¿è½®è¯¢</code>ç”±ç½‘å…³ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼Œä¸æ–­è¯·æ±‚<code>admin</code>ç«¯ï¼›</li><li>å˜æ›´æ•°æ®ä»¥ç»„ä¸ºç²’åº¦ï¼ˆè®¤è¯ä¿¡æ¯ã€æ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®ï¼‰ï¼›</li><li><code>httpé•¿è½®è¯¢</code>ç»“æœåªæ‹¿åˆ°äº†å˜æ›´ç»„ï¼Œè¿˜éœ€è¦å†æ¬¡å‘èµ·è¯·æ±‚è·å–ç»„æ•°æ®ï¼›</li><li>æ•°æ®æ˜¯å¦æ›´æ–°ç”±<code>md5</code>å€¼å’Œä¿®æ”¹æ—¶é—´<code>lastModifyTime</code>å†³å®šã€‚</li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/http">http</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Http-Data-Sync.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æœ¬æ–‡æ¡£</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Nacosæ•°æ®åŒæ­¥æºç åˆ†æ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">WebSocketæ•°æ®åŒæ­¥æºç åˆ†æ Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-httpé•¿è½®è¯¢" class="table-of-contents__link">1. Httpé•¿è½®è¯¢</a></li><li><a href="#2-ç½‘å…³æ•°æ®åŒæ­¥" class="table-of-contents__link">2. ç½‘å…³æ•°æ®åŒæ­¥</a></li><li><a href="#3-adminæ•°æ®åŒæ­¥" class="table-of-contents__link">3. adminæ•°æ®åŒæ­¥</a></li><li><a href="#4-æ€»ç»“" class="table-of-contents__link">4. æ€»ç»“</a></li></ul></div></div></div></div></div></div>
<script src="/zh/assets/js/runtime~main.b320993e.js"></script>
<script src="/zh/assets/js/main.0d73c12b.js"></script>
</body>
</html>