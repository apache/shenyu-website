<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Blog | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Blog | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/page/2"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/page/2"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/page/2" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.581a6ac8.css">
<link rel="preload" href="/zh/assets/js/runtime~main.2ef77e12.js" as="script">
<link rel="preload" href="/zh/assets/js/main.ca7c9a30.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">åŸºé‡‘ä¼š</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">è®¸å¯</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">æ´»åŠ¨</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">å®‰å…¨</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">èµåŠ©</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">éšç§</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">è‡´è°¢</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢ (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin">Dubboæ’ä»¶æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.463Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p><code>Apache ShenYu</code> ç½‘å…³ä½¿ç”¨ <code>dubbo</code> æ’ä»¶å®Œæˆå¯¹ <code>dubbo</code>æœåŠ¡çš„è°ƒç”¨ã€‚ä½ å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo" target="_blank" rel="noopener noreferrer">Dubboå¿«é€Ÿå¼€å§‹</a> äº†è§£å¦‚ä½•ä½¿ç”¨è¯¥æ’ä»¶ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.3</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/user-guide/dubbo-proxy/" target="_blank" rel="noopener noreferrer">DubboæœåŠ¡æ¥å…¥</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-æœåŠ¡æ³¨å†Œ"></a>1. æœåŠ¡æ³¨å†Œ<a class="hash-link" href="#1-æœåŠ¡æ³¨å†Œ" title="Direct link to heading">#</a></h3><p>ä»¥å®˜ç½‘æä¾›çš„ä¾‹å­ä¸ºä¾‹ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-dubbo/shenyu-examples-apache-dubbo-service" target="_blank" rel="noopener noreferrer">shenyu-examples-dubbo</a> ã€‚ å‡å¦‚ä½ çš„<code>dubbo</code>æœåŠ¡å®šä¹‰å¦‚ä¸‹(<code>spring-dubbo.xml</code>)ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">xsi</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">dubbo</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://code.alibabatech.com/schema/dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xsi:</span><span class="token tag attr-name" style="color:#00a4db">schemaLocation</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://code.alibabatech.com/schema/dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       https://code.alibabatech.com/schema/dubbo/dubbo.xsd</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">application</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">test-dubbo-service</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">registry</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">${dubbo.registry.address}</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">protocol</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">port</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">20888</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">service</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">timeout</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">10000</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">interface</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">org.apache.shenyu.examples.dubbo.api.service.DubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å£°æ˜åº”ç”¨æœåŠ¡åç§°ï¼Œæ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä½¿ç”¨<code>dubbo</code>åè®®ï¼Œå£°æ˜æœåŠ¡æ¥å£ï¼Œå¯¹åº”æ¥å£å®ç°ç±»ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * DubboTestServiceImpl.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨æ¥å£å®ç°ç±»ä¸­ï¼Œä½¿ç”¨æ³¨è§£<code>@ShenyuDubboClient</code>å‘<code>shenyu-admin</code>æ³¨å†ŒæœåŠ¡ã€‚è¯¥æ³¨è§£çš„ä½œç”¨åŠåŸç†ï¼Œç¨åå†è¿›è¡Œåˆ†æã€‚</p><p>åœ¨é…ç½®æ–‡ä»¶<code>application.yml</code>ä¸­çš„é…ç½®ä¿¡æ¯ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8011</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">servlet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">context-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">main</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">allow-bean-definition-overriding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2181</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># dubboä½¿ç”¨çš„æ³¨å†Œä¸­å¿ƒ</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span><span class="token comment" style="color:#999988;font-style:italic">#æ³¨å†Œæ–¹å¼</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#æ³¨å†Œåœ°å€</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dubbo  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜<code>dubbo</code>ä½¿ç”¨çš„æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œ<code>dubbo</code>æœåŠ¡å‘<code>shenyu-admin</code>æ³¨å†Œï¼Œä½¿ç”¨çš„æ–¹å¼æ˜¯<code>http</code>ï¼Œæ³¨å†Œåœ°å€æ˜¯<code>http://localhost:9095</code>ã€‚</p><p>å…³äºæ³¨å†Œæ–¹å¼çš„ä½¿ç”¨ï¼Œè¯·å‚è€ƒ <a href="https://shenyu.apache.org/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">åº”ç”¨å®¢æˆ·ç«¯æ¥å…¥</a> ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--å£°æ˜æ³¨å†Œæ¥å£"></a>1.1  å£°æ˜æ³¨å†Œæ¥å£<a class="hash-link" href="#11--å£°æ˜æ³¨å†Œæ¥å£" title="Direct link to heading">#</a></h4><p>ä½¿ç”¨æ³¨è§£<code>@ShenyuDubboClient</code>å°†æœåŠ¡æ³¨å†Œåˆ°ç½‘å…³ã€‚ç®€å•<code>demo</code>å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// dubboæœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;) // éœ€è¦æ³¨å†Œçš„æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ³¨è§£å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ä½œç”¨äºç±»å’Œæ–¹æ³•ä¸Š</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuDubboClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ˜¯å¦å¯ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-æ‰«ææ³¨è§£ä¿¡æ¯"></a>1.2 æ‰«ææ³¨è§£ä¿¡æ¯<a class="hash-link" href="#12-æ‰«ææ³¨è§£ä¿¡æ¯" title="Direct link to heading">#</a></h4><p>æ³¨è§£æ‰«æé€šè¿‡<code>ApacheDubboServiceBeanListener</code>å®Œæˆï¼Œå®ƒå®ç°äº†<code>ApplicationListener&lt;ContextRefreshedEvent&gt;</code>æ¥å£ï¼Œåœ¨<code>Spring</code>å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶æ—¶ï¼Œå¼€å§‹æ‰§è¡Œäº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ã€‚</p><p>åœ¨æ„é€ å™¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼š</p><ul><li>è¯»å–å±æ€§é…ç½®</li><li>å¼€å¯çº¿ç¨‹æ± </li><li>å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼Œç”¨äºå‘<code>shenyu-admin</code>æ³¨å†Œ</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboServiceBeanListener implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApacheDubboServiceBeanListener(final PropertiesConfig clientConfig, final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.è¯»å–å±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(&quot;apache dubbo client must config the contextPath or appName&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = contextPath;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = appName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.å¼€å¯çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executorService = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder().setNameFormat(&quot;shenyu-apache-dubbo-client-thread-pool-%d&quot;).build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.å¯åŠ¨æ³¨å†Œä¸­å¿ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ï¼Œæ‰§è¡Œæ–¹æ³•é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ApacheDubboServiceBeanListener#onApplicationEvent()</li></ul><p>é‡å†™çš„æ–¹æ³•é€»è¾‘ï¼šè¯»å–<code>Dubbo</code>æœåŠ¡<code>ServiceBean</code>ï¼Œæ„å»ºå…ƒæ•°æ®å¯¹è±¡å’Œ<code>URI</code>å¯¹è±¡ï¼Œå¹¶å‘<code>shenyu-admin</code>æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¯»å–ServiceBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ServiceBean&gt; serviceBean = contextRefreshedEvent.getApplicationContext().getBeansOfType(ServiceBean.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (serviceBean.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¿è¯è¯¥æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¤„ç†å…ƒæ•°æ®å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, ServiceBean&gt; entry : serviceBean.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler(entry.getValue());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¤„ç†URIå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceBean.values().stream().findFirst().ifPresent(bean -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(bean));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>handler()</p><p>åœ¨<code>handler()</code>æ–¹æ³•ä¸­ï¼Œä»<code>serviceBean</code>ä¸­è¯»å–æ‰€æœ‰æ–¹æ³•ï¼Œåˆ¤æ–­æ–¹æ³•ä¸Šæ˜¯å¦æœ‰<code>ShenyuDubboClient</code>æ³¨è§£ï¼Œå¦‚æœå­˜åœ¨å°±æ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œå¹¶é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼Œå‘<code>shenyu-admin</code>æ³¨å†Œè¯¥æ–¹æ³•ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void handler(final ServiceBean&lt;?&gt; serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–ä»£ç†å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object refProxy = serviceBean.getRef();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–classä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = refProxy.getClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (AopUtils.isAopProxy(refProxy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clazz = AopUtils.getTargetClass(refProxy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–æ‰€æœ‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è¯»å–ShenyuDubboClientæ³¨è§£ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuDubboClient shenyuDubboClient = method.getAnnotation(ShenyuDubboClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(shenyuDubboClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //æ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œå¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(serviceBean, shenyuDubboClient, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildMetaDataDTO()</p><p>æ„å»ºå…ƒæ•°æ®å¯¹è±¡ï¼Œåœ¨è¿™é‡Œæ„å»ºæ–¹æ³•æ³¨å†Œçš„å¿…è¦ä¿¡æ¯ï¼Œåç»­ç”¨äºé€‰æ‹©å™¨æˆ–è§„åˆ™åŒ¹é…ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO(final ServiceBean&lt;?&gt; serviceBean, final ShenyuDubboClient shenyuDubboClient, final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åº”ç”¨åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = buildAppName(serviceBean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ–¹æ³•è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = contextPath + shenyuDubboClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String desc = shenyuDubboClient.desc();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æœåŠ¡åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String serviceName = serviceBean.getInterface();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configRuleName = shenyuDubboClient.ruleName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleName = (&quot;&quot;.equals(configRuleName)) ? path : configRuleName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ–¹æ³•åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String methodName = method.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å‚æ•°ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] parameterTypesClazz = method.getParameterTypes();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String parameterTypes = Arrays.stream(parameterTypesClazz).map(Class::getName).collect(Collectors.joining(&quot;,&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .serviceName(serviceName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .methodName(methodName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(ruleName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(desc)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .parameterTypes(parameterTypes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcExt(buildRpcExt(serviceBean)) //dubboæœåŠ¡çš„æ‰©å±•ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuDubboClient.enabled())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildRpcExt()</p><p> <code>dubbo</code>æœåŠ¡çš„æ‰©å±•ä¿¡æ¯</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   private String buildRpcExt(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       DubboRpcExt build = DubboRpcExt.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .group(StringUtils.isNotEmpty(serviceBean.getGroup()) ? serviceBean.getGroup() : &quot;&quot;)//åˆ†ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .version(StringUtils.isNotEmpty(serviceBean.getVersion()) ? serviceBean.getVersion() : &quot;&quot;)//ç‰ˆæœ¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .loadbalance(StringUtils.isNotEmpty(serviceBean.getLoadbalance()) ? serviceBean.getLoadbalance() : Constants.DEFAULT_LOADBALANCE)//è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé»˜è®¤éšæœº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .retries(Objects.isNull(serviceBean.getRetries()) ? Constants.DEFAULT_RETRIES : serviceBean.getRetries())//é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .timeout(Objects.isNull(serviceBean.getTimeout()) ? Constants.DEFAULT_CONNECT_TIMEOUT : serviceBean.getTimeout())//è¶…æ—¶ï¼Œé»˜è®¤3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .sent(Objects.isNull(serviceBean.getSent()) ? Constants.DEFAULT_SENT : serviceBean.getSent())//sentï¼Œé»˜è®¤false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .cluster(StringUtils.isNotEmpty(serviceBean.getCluster()) ? serviceBean.getCluster() : Constants.DEFAULT_CLUSTER)//é›†ç¾¤ç­–ç•¥ï¼Œé»˜è®¤failover</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .url(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return GsonUtils.getInstance().toJson(build);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><ul><li><p>buildURIRegisterDTO()</p><p>æ„å»º<code>URI</code>å¯¹è±¡ï¼Œæ³¨å†ŒæœåŠ¡æœ¬èº«çš„ä¿¡æ¯ï¼Œåç»­å¯ç”¨äºæœåŠ¡æ¢æ´»ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private URIRegisterDTO buildURIRegisterDTO(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(this.contextPath) //ä¸Šä¸‹æ–‡è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(buildAppName(serviceBean))//åº”ç”¨åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())//rpcç±»å‹ï¼šdubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost()) //host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))//port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…·ä½“çš„æ³¨å†Œé€»è¾‘ç”±æ³¨å†Œä¸­å¿ƒå®ç°ï¼Œè¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥åŸç†</a> ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//å‘æ³¨å†Œä¸­å¿ƒï¼Œå‘å¸ƒæ³¨å†Œäº‹ä»¶   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">publisher.publishEvent();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-å¤„ç†æ³¨å†Œä¿¡æ¯"></a>1.3 å¤„ç†æ³¨å†Œä¿¡æ¯<a class="hash-link" href="#13-å¤„ç†æ³¨å†Œä¿¡æ¯" title="Direct link to heading">#</a></h4><p>å®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„å…ƒæ•°æ®å’Œ<code>URI</code>æ•°æ®ï¼Œåœ¨<code>shenyu-admin</code>ç«¯è¿›è¡Œå¤„ç†ï¼Œè´Ÿè´£å­˜å‚¨åˆ°æ•°æ®åº“å’ŒåŒæ­¥ç»™<code>shenyu</code>ç½‘å…³ã€‚<code>Dubbo</code>æ’ä»¶çš„å®¢æˆ·ç«¯æ³¨å†Œå¤„ç†é€»è¾‘åœ¨<code>ShenyuClientRegisterDubboServiceImpl</code>ä¸­ã€‚ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/ShenyuClientRegisterDubboServiceImpl-a48cc4b745cb6a47ee000cf08d4cff04.png"></p><ul><li>ShenyuClientRegisterServiceï¼šå®¢æˆ·ç«¯æ³¨å†ŒæœåŠ¡ï¼Œé¡¶å±‚æ¥å£ï¼›</li><li>FallbackShenyuClientRegisterServiceï¼šæ³¨å†Œå¤±è´¥ï¼Œæä¾›é‡è¯•æ“ä½œï¼›</li><li>AbstractShenyuClientRegisterServiceImplï¼šæŠ½è±¡ç±»ï¼Œå®ç°éƒ¨åˆ†å…¬å…±æ³¨å†Œé€»è¾‘ï¼›</li><li>ShenyuClientRegisterDubboServiceImplï¼šå®ç°<code>Dubbo</code>æ’ä»¶çš„æ³¨å†Œï¼›</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="131-æ³¨å†ŒæœåŠ¡"></a>1.3.1 æ³¨å†ŒæœåŠ¡<a class="hash-link" href="#131-æ³¨å†ŒæœåŠ¡" title="Direct link to heading">#</a></h5><ul><li><p>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</p><p>å®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„å…ƒæ•°æ®<code>MetaDataRegisterDTO</code>å¯¹è±¡åœ¨<code>shenyu-admin</code>çš„<code>register()</code>æ–¹æ³•è¢«æ¥é€åˆ°ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1311-æ³¨å†Œé€‰æ‹©å™¨"></a>1.3.1.1 æ³¨å†Œé€‰æ‹©å™¨<a class="hash-link" href="#1311-æ³¨å†Œé€‰æ‹©å™¨" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>æ„å»º<code>contextPath</code>ï¼ŒæŸ¥æ‰¾é€‰æ‹©å™¨ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è¿”å›<code>id</code>ï¼›ä¸å­˜åœ¨å°±åˆ›å»ºé»˜è®¤çš„é€‰æ‹©å™¨ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºcontextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é€šè¿‡åç§°æŸ¥æ‰¾é€‰æ‹©å™¨ä¿¡æ¯æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¸å­˜åœ¨å°±åˆ›å»ºé»˜è®¤çš„é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>é»˜è®¤é€‰æ‹©å™¨ä¿¡æ¯</p><p>åœ¨è¿™é‡Œæ„å»ºé»˜è®¤é€‰æ‹©å™¨ä¿¡æ¯åŠå…¶æ¡ä»¶å±æ€§ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ³¨å†Œé»˜è®¤é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //æ„å»ºé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºé»˜è®¤é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //æ„å»ºé»˜è®¤é€‰æ‹©å™¨çš„æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤é€‰æ‹©å™¨</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // é»˜è®¤ç±»å‹è‡ªå®šä¹‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //é»˜è®¤åŒ¹é…æ–¹å¼ and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //é»˜è®¤å¯å¼€å¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //é»˜è®¤è®°å½•æ—¥å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) //é»˜è®¤ç»§ç»­åç»­é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) //é»˜è®¤é¡ºåº1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤é€‰æ‹©å™¨æ¡ä»¶å±æ€§</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // é»˜è®¤å‚æ•°ç±»å‹URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // é»˜è®¤åŒ¹é…ç­–ç•¥ match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // é»˜è®¤å€¼ /contextPath/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ³¨å†Œé»˜è®¤é€‰æ‹©å™¨</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é€‰æ‹©å™¨æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘æ•°æ®åº“æ’å…¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // å‘æ•°æ®åº“æ’å…¥é€‰æ‹©å™¨æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());            selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‘å¸ƒåŒæ­¥äº‹ä»¶ï¼Œå‘ç½‘å…³åŒæ­¥é€‰æ‹©ä¿¡æ¯åŠå…¶æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1312-æ³¨å†Œè§„åˆ™"></a>1.3.1.2 æ³¨å†Œè§„åˆ™<a class="hash-link" href="#1312-æ³¨å†Œè§„åˆ™" title="Direct link to heading">#</a></h6><p>åœ¨æ³¨å†ŒæœåŠ¡çš„ç¬¬äºŒæ­¥ä¸­ï¼Œå¼€å§‹æ„å»ºé»˜è®¤è§„åˆ™ï¼Œç„¶åæ³¨å†Œè§„åˆ™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Dubbo</code>æ’ä»¶é»˜è®¤è§„åˆ™å¤„ç†å±æ€§</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * dubboæœåŠ¡ç‰ˆæœ¬ä¿¡æ¯.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String version;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ†ç»„.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String group;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * é‡è¯•æ¬¡æ•°.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer retries = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šé»˜è®¤éšæœº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadbalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¶…æ—¶ï¼Œé»˜è®¤3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  æ„å»ºé»˜è®¤è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId) //å…³è”çš„é€‰æ‹©å™¨id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) //è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) // é»˜è®¤åŒ¹é…æ¨¡å¼ and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) // é»˜è®¤å¼€å¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) //é»˜è®¤è®°å½•æ—¥å¿—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1) //é»˜è®¤é¡ºåº 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) // é»˜è®¤å‚æ•°ç±»å‹URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) //å‚æ•°å€¼path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //å¦‚æœpathä¸­æœ‰*ï¼Œæ“ä½œç±»å‹åˆ™é»˜è®¤ä¸º match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // å¦åˆ™ï¼Œé»˜è®¤æ“ä½œç±»å‹ = </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>æ³¨å†Œè§„åˆ™ï¼šå‘æ•°æ®åº“æ’å…¥è®°å½•ï¼Œå¹¶å‘ç½‘å…³å‘å¸ƒäº‹ä»¶ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘æ•°æ®åº“æ’å…¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å‘æ•°æ®åº“æ’å…¥è§„åˆ™ä½“æ¡ä»¶å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘ç½‘å…³å‘å¸ƒäº‹ä»¶ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1313-æ³¨å†Œå…ƒæ•°æ®"></a>1.3.1.3 æ³¨å†Œå…ƒæ•°æ®<a class="hash-link" href="#1313-æ³¨å†Œå…ƒæ•°æ®" title="Direct link to heading">#</a></h6><p>å…ƒæ•°æ®ä¸»è¦ç”¨äº<code>RPC</code>æœåŠ¡çš„è°ƒç”¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. æ³¨å†Œé€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. æ³¨å†Œè§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. æ³¨å†ŒContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDubboServiceImpl#registerMetadata()</p><p>æ’å…¥æˆ–æ›´æ–°å…ƒæ•°æ®ï¼Œç„¶åå‘å¸ƒåŒæ­¥äº‹ä»¶åˆ°ç½‘å…³ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–metaDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å…ƒæ•°æ®æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥æˆ–æ›´æ–°å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ•°æ®ç±»å‹è½¬æ¢ DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒåŒæ­¥äº‹ä»¶åˆ°ç½‘å…³</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="132-æ³¨å†Œuri"></a>1.3.2 æ³¨å†ŒURI<a class="hash-link" href="#132-æ³¨å†Œuri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯æ³¨å†Œçš„<code>URI</code>ä¿¡æ¯åï¼Œè¿›è¡Œå¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†Œå¤±è´¥åï¼Œè¿›è¡Œé‡è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>ä»å®¢æˆ·ç«¯æ³¨å†Œçš„<code>URI</code>ä¸­è·å–æœ‰æ•ˆçš„<code>URI</code>ï¼Œæ›´æ–°å¯¹åº”çš„é€‰æ‹©å™¨<code>handle</code>å±æ€§ï¼Œå‘ç½‘å…³å‘é€é€‰æ‹©å™¨æ›´æ–°äº‹ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å‚æ•°æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æœ‰æ•ˆçš„URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé€‰æ‹©å™¨çš„handleå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘æ•°æ®åº“æ›´æ–°é€‰æ‹©å™¨çš„handleå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘ç½‘å…³å‘é€é€‰æ‹©å™¨æ›´æ–°äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…³äºæœåŠ¡æ³¨å†Œçš„æºç åˆ†æå°±ä»¥åŠå®Œæˆäº†ï¼Œåˆ†ææµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/dubbo-register-zh-3a94f676f21cccb70d92c1e9e1eaad29.png"></p><p>æ¥ä¸‹æ¥å°±åˆ†æ<code>dubbo</code>æ’ä»¶æ˜¯å¦‚ä½•æ ¹æ®è¿™äº›ä¿¡æ¯å‘<code>http</code>æœåŠ¡å‘èµ·è°ƒç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-æœåŠ¡è°ƒç”¨"></a>2. æœåŠ¡è°ƒç”¨<a class="hash-link" href="#2-æœåŠ¡è°ƒç”¨" title="Direct link to heading">#</a></h3><p><code>dubbo</code>æ’ä»¶æ˜¯<code>ShenYu</code>ç½‘å…³ç”¨äºå°†<code>http</code>è¯·æ±‚è½¬æˆ <code>dubboåè®®</code>ï¼Œè°ƒç”¨<code>dubbo</code>æœåŠ¡çš„æ ¸å¿ƒå¤„ç†æ’ä»¶ã€‚</p><p>ä»¥å®˜ç½‘æä¾›çš„æ¡ˆä¾‹ <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo/" target="_blank" rel="noopener noreferrer">Dubboå¿«é€Ÿå¼€å§‹</a> ä¸ºä¾‹ï¼Œä¸€ä¸ª<code>dubbo</code>æœåŠ¡é€šè¿‡æ³¨å†Œä¸­å¿ƒå‘<code>shenyu-admin</code>æ³¨å†Œåï¼Œé€šè¿‡<code>ShenYu</code>ç½‘å…³ä»£ç†ï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/dubbo/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Dubbo</code>æ’ä»¶ä¸­ï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/ApacheDubboPlugin-286a36694f3fa121e7d3c7d67d08b833.png"></p><ul><li>ShenyuPluginï¼šé¡¶å±‚æ¥å£ï¼Œå®šä¹‰æ¥å£æ–¹æ³•ï¼›</li><li>AbstractShenyuPluginï¼šæŠ½è±¡ç±»ï¼Œå®ç°æ’ä»¶å…±æœ‰é€»è¾‘ï¼›</li><li>AbstractDubboPluginï¼šdubboæ’ä»¶æŠ½è±¡ç±»ï¼Œå®ç°<code>dubbo</code>å…±æœ‰é€»è¾‘ï¼›</li><li>ApacheDubboPluginï¼šApacheDubboæ’ä»¶ã€‚</li></ul><blockquote><p>ShenYuç½‘å…³æ”¯æŒApacheDubboå’ŒAlibabaDubbo</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶è¯·æ±‚"></a>2.1 æ¥æ”¶è¯·æ±‚<a class="hash-link" href="#21-æ¥æ”¶è¯·æ±‚" title="Direct link to heading">#</a></h4><p>é€šè¿‡<code>ShenYu</code>ç½‘å…³ä»£ç†åï¼Œè¯·æ±‚å…¥å£æ˜¯<code>ShenyuWebHandler</code>ï¼Œå®ƒå®ç°äº†<code>org.springframework.web.server.WebHandler</code>æ¥å£ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¤„ç†webè¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // æ‰§è¡Œé»˜è®¤æ’ä»¶é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * å®ä¾‹åŒ–é»˜è®¤æ’ä»¶é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * æ‰§è¡Œæ¯ä¸ªæ’ä»¶.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // è·å–å½“å‰æ‰§è¡Œæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ˜¯å¦è·³è¿‡å½“å‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœè·³è¿‡å°±æ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ‰§è¡Œå½“å‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-åŒ¹é…è§„åˆ™"></a>2.2 åŒ¹é…è§„åˆ™<a class="hash-link" href="#22-åŒ¹é…è§„åˆ™" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>åœ¨<code>execute()</code>æ–¹æ³•ä¸­æ‰§è¡Œé€‰æ‹©å™¨å’Œè§„åˆ™çš„åŒ¹é…é€»è¾‘ã€‚</p><ul><li>åŒ¹é…é€‰æ‹©å™¨ï¼›</li><li>åŒ¹é…è§„åˆ™ï¼›</li><li>æ‰§è¡Œæ’ä»¶ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŒ¹é…é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŒ¹é…è§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ‰§è¡Œæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-æ‰§è¡Œglobalplugin"></a>2.3 æ‰§è¡ŒGlobalPlugin<a class="hash-link" href="#23-æ‰§è¡Œglobalplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.global.GlobalPlugin#execute()</li></ul><p><code>GlobalPlugin</code>æ˜¯ä¸€ä¸ªå…¨å±€æ’ä»¶ï¼Œåœ¨<code>execute()</code>æ–¹æ³•ä¸­æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ShenyuContextBuilder builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¼ å…¥åˆ° exchange ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = builder.build(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.CONTEXT, shenyuContext);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.global.DefaultShenyuContextBuilder#build()</li></ul><p>æ„å»ºé»˜è®¤çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DefaultShenyuContextBuilder implements ShenyuContextBuilder {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext build(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ„å»ºå‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String, MetaData&gt; buildData = buildData(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åŒ…è£…ShenyuContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return decoratorMap.get(buildData.getLeft()).decorator(buildDefaultContext(exchange.getRequest()), buildData.getRight());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Pair&lt;String, MetaData&gt; buildData(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ ¹æ®è¯·æ±‚çš„uriè·å–å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = MetaDataCache.getInstance().obtain(request.getURI().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; Boolean.TRUE.equals(metaData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.META_DATA, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(metaData.getRpcType(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(RpcTypeEnum.HTTP.getName(), new MetaData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è®¾ç½®é»˜è®¤çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuContext buildDefaultContext(final ServerHttpRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appKey = request.getHeaders().getFirst(Constants.APP_KEY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sign = request.getHeaders().getFirst(Constants.SIGN);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = new ShenyuContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = request.getURI().getPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setPath(path); //è¯·æ±‚è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setAppKey(appKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setSign(sign);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setTimestamp(timestamp);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setStartDateTime(LocalDateTime.now());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -&gt; shenyuContext.setHttpMethod(httpMethod.name()));//è¯·æ±‚æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.dubbo.common.context.DubboShenyuContextDecorator#decorator()</li></ul><p>åŒ…è£…<code>ShenyuContext</code>ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboShenyuContextDecorator implements ShenyuContextDecorator {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext decorator(final ShenyuContext shenyuContext, final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setModule(metaData.getAppName());//è·å–AppName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setMethod(metaData.getServiceName()); //è·å–ServiceName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setContextPath(metaData.getContextPath()); //è·å–contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setRpcType(RpcTypeEnum.DUBBO.getName()); // dubboæœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String rpcType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RpcTypeEnum.DUBBO.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-æ‰§è¡Œrpcparamtransformplugin"></a>2.4 æ‰§è¡ŒRpcParamTransformPlugin<a class="hash-link" href="#24-æ‰§è¡Œrpcparamtransformplugin" title="Direct link to heading">#</a></h4><p><code>RpcParamTransformPlugin</code>è´Ÿè´£ä»<code>http</code>è¯·æ±‚ä¸­è¯»å–å‚æ•°ï¼Œä¿å­˜åˆ°<code>exchange</code>ä¸­ï¼Œä¼ é€’ç»™<code>rpc</code>æœåŠ¡ã€‚</p><ul><li>org.apache.shenyu.plugin.base.RpcParamTransformPlugin#execute()</li></ul><p>åœ¨<code>execute()</code>æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œè¯¥æ’ä»¶çš„æ ¸å¿ƒé€»è¾‘ï¼šä»<code>exchange</code>ä¸­è·å–è¯·æ±‚ä¿¡æ¯ï¼Œæ ¹æ®è¯·æ±‚ä¼ å…¥çš„å†…å®¹å½¢å¼å¤„ç†å‚æ•°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class RpcParamTransformPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä»exchangeä¸­è·å–è¯·æ±‚ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerHttpRequest request = exchange.getRequest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuContext)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MediaType mediaType = request.getHeaders().getContentType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return body(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return formData(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ä¸€èˆ¬æŸ¥è¯¢è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return query(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; body(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(body -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, resolveBodyFromRequest(body));//è§£æbodyï¼Œä¿å­˜åˆ°exchangeä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // å¦‚æœè¯·æ±‚å‚æ•°æ ¼å¼æ˜¯APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; formData(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(map -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String param = resolveBodyFromRequest(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LinkedMultiValueMap&lt;String, String&gt; linkedMultiValueMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        linkedMultiValueMap = BodyParamUtils.buildBodyParams(URLDecoder.decode(param, StandardCharsets.UTF_8.name())); //æ ¼å¼åŒ–æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (UnsupportedEncodingException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return Mono.error(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.toMap(() -&gt; linkedMultiValueMap));// ä¿å­˜åˆ°exchangeä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ä¸€èˆ¬æŸ¥è¯¢è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; query(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.ofString(() -&gt; serverHttpRequest.getURI().getQuery()));//ä¿å­˜åˆ°exchangeä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-æ‰§è¡Œdubboplugin"></a>2.5 æ‰§è¡ŒDubboPlugin<a class="hash-link" href="#25-æ‰§è¡Œdubboplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.dubbo.common.AbstractDubboPlugin#doExecute()</li></ul><p>åœ¨<code>doExecute()</code>æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯æ£€æŸ¥å…ƒæ•°æ®å’Œå‚æ•°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–å‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String param = exchange.getAttribute(Constants.PARAM_TRANSFORM);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = exchange.getAttribute(Constants.META_DATA);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ£€æŸ¥å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!checkMetaData(metaData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot; path is : {}, meta data have error : {}&quot;, shenyuContext.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.META_DATA_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ£€æŸ¥å…ƒæ•°æ®å’Œå‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; StringUtils.isNoneBlank(metaData.getParameterTypes()) &amp;&amp; StringUtils.isBlank(param)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.DUBBO_HAVE_BODY_PARAM, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¾ç½®rpcContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.rpcContext(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¿›è¡ŒdubboæœåŠ¡è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.doDubboInvoker(exchange, chain, selector, rule, metaData, param);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.ApacheDubboPlugin#doDubboInvoker()</li></ul><p>åœ¨<code>doDubboInvoker()</code>æ–¹æ³•ä¸­è®¾ç½®ç‰¹æ®Šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç„¶åå¼€å§‹dubboçš„æ³›åŒ–è°ƒç”¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPlugin extends AbstractDubboPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doDubboInvoker(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final RuleData rule,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final MetaData metaData,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final String param) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¾ç½®å½“å‰çš„é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯ï¼Œä»¥åŠè¯·æ±‚åœ°å€ï¼Œç”¨äºæ”¯æŒdubboçš„ç°åº¦</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_RULE_ID, rule.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_REMOTE_ADDRESS, Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //dubboçš„æ³›åŒ–è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;Object&gt; result = dubboProxyService.genericInvoker(param, metaData, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‰§è¡Œä¸‹ä¸€ä¸ªæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.then(chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.proxy.ApacheDubboProxyService#genericInvoker()</li></ul><p><code>genericInvoker()</code>æ–¹æ³•ï¼š</p><ul><li>è·å–<code>ReferenceConfig</code>å¯¹è±¡ï¼›</li><li>è·å–æ³›åŒ–æœåŠ¡<code>GenericService</code>å¯¹è±¡ï¼›</li><li>æ„é€ è¯·æ±‚å‚æ•°<code>pair</code>å¯¹è±¡ï¼›</li><li>å‘èµ·å¼‚æ­¥çš„æ³›åŒ–è°ƒç”¨ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboProxyService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Generic invoker object.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Object&gt; genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.è·å–ReferenceConfigå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReferenceConfig&lt;GenericService&gt; reference = ApacheDubboConfigCache.getInstance().get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœæ²¡æœ‰è·å–åˆ°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¤±æ•ˆå½“å‰ç¼“å­˜çš„ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ä½¿ç”¨å…ƒæ•°æ®è¿›è¡Œå†æ¬¡åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference = ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.è·å–æ³›åŒ–æœåŠ¡GenericServiceå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        GenericService genericService = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.æ„é€ è¯·æ±‚å‚æ•°pairå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String[], Object[]&gt; pair;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(metaData.getParameterTypes()) || ParamCheckUtils.dubboBodyIsEmpty(body)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = new ImmutablePair&lt;&gt;(new String[]{}, new Object[]{});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4.å‘èµ·å¼‚æ­¥çš„æ³›åŒ–è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.fromFuture(invokeAsync(genericService, metaData.getMethodName(), pair.getLeft(), pair.getRight()).thenApply(ret -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¤„ç†ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(ret)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = Constants.DUBBO_RPC_RESULT_EMPTY;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.RPC_RESULT, ret);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ret;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        })).onErrorMap(exception -&gt; exception instanceof GenericException ? new ShenyuException(((GenericException) exception).getExceptionMessage()) : new ShenyuException(exception));//å¤„ç†å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ³›åŒ–è°ƒç”¨ï¼Œå¼‚æ­¥æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private CompletableFuture&lt;Object&gt; invokeAsync(final GenericService genericService, final String method, final String[] parameterTypes, final Object[] args) throws GenericException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        genericService.$invoke(method, parameterTypes, args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object resultFromFuture = RpcContext.getContext().getFuture();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFromFuture instanceof CompletableFuture ? (CompletableFuture&lt;Object&gt;) resultFromFuture : CompletableFuture.completedFuture(resultFromFuture);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡æ³›åŒ–è°ƒç”¨å°±å¯ä»¥å®ç°åœ¨ç½‘å…³è°ƒç”¨<code>dubbo</code>æœåŠ¡äº†ã€‚</p><p><code>ReferenceConfig</code>å¯¹è±¡æ˜¯æ”¯æŒæ³›åŒ–è°ƒç”¨çš„å…³é”®å¯¹è±¡ ï¼Œå®ƒçš„åˆå§‹åŒ–æ“ä½œæ˜¯åœ¨æ•°æ®åŒæ­¥çš„æ—¶å€™å®Œæˆçš„ã€‚è¿™é‡Œæ¶‰åŠä¸¤éƒ¨åˆ†æ•°æ®ï¼Œä¸€æ˜¯åŒæ­¥çš„æ’ä»¶<code>handler</code>ä¿¡æ¯ï¼ŒäºŒæ˜¯åŒæ­¥çš„æ’ä»¶å…ƒæ•°æ®ä¿¡æ¯ã€‚</p><ul><li>org.apache.shenyu.plugin.dubbo.common.handler.AbstractDubboPluginDataHandler#handlerPlugin()</li></ul><p>å½“æ’ä»¶æ•°æ®æ›´æ–°æ—¶ï¼Œæ•°æ®åŒæ­¥æ¨¡å—ä¼šå°†æ•°æ®ä»<code>shenyu-admin</code>åŒæ­¥åˆ°ç½‘å…³ã€‚åœ¨<code>handlerPlugin()</code>ä¸­æ‰§è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åˆå§‹åŒ–é…ç½®ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   protected abstract void initConfigCache(DubboRegisterConfig dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerPlugin(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(pluginData) &amp;&amp; Boolean.TRUE.equals(pluginData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ•°æ®ååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig dubboRegisterConfig = GsonUtils.getInstance().fromJson(pluginData.getConfig(), DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig exist = Singleton.INST.get(DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || !dubboRegisterConfig.equals(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.initConfigCache(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Singleton.INST.single(DubboRegisterConfig.class, dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.handler.ApacheDubboPluginDataHandler#initConfigCache()</li></ul><p>æ‰§è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPluginDataHandler extends AbstractDubboPluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void initConfigCache(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().init(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¤±æ•ˆä¹‹å‰ç¼“å­˜çš„ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().invalidateAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#init()</li></ul><p>åœ¨åˆå§‹åŒ–ä¸­ï¼Œè®¾ç½®<code>registryConfig</code>å’Œ<code>consumerConfig</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åˆ›å»ºApplicationConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(applicationConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            applicationConfig = new ApplicationConfig(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åè®®æˆ–è€…åœ°å€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œéœ€è¦æ›´æ–°registryConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (needUpdateRegistryConfig(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RegistryConfig registryConfigTemp = new RegistryConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setProtocol(dubboRegisterConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setId(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setRegister(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setAddress(dubboRegisterConfig.getRegister());            Optional.ofNullable(dubboRegisterConfig.getGroup()).ifPresent(registryConfigTemp::setGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfig = registryConfigTemp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åˆ›å»ºConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(consumerConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            consumerConfig = ApplicationModel.getConfigManager().getDefaultConsumer().orElseGet(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConsumerConfig consumerConfig = new ConsumerConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                consumerConfig.refresh();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return consumerConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> //è®¾ç½®ConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getThreadpool()).ifPresent(consumerConfig::setThreadpool); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getCorethreads()).ifPresent(consumerConfig::setCorethreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Optional.ofNullable(dubboRegisterConfig.getThreads()).ifPresent(consumerConfig::setThreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Optional.ofNullable(dubboRegisterConfig.getQueues()).ifPresent(consumerConfig::setQueues);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ˜¯å¦éœ€è¦æ›´æ–°æ³¨å†Œé…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean needUpdateRegistryConfig(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getRegister(), registryConfig.getAddress())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.subscriber.ApacheDubboMetaDataSubscriber#onSubscribe()</li></ul><p>å½“å…ƒæ•°æ®æ›´æ–°æ—¶ï¼Œæ•°æ®åŒæ­¥æ¨¡å—ä¼šå°†æ•°æ®ä»<code>shenyu-admin</code>åŒæ­¥åˆ°ç½‘å…³ã€‚åœ¨<code>onSubscribe()</code>æ–¹æ³•ä¸­æ‰§è¡Œå…ƒæ•°æ®æ›´æ–°æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboMetaDataSubscriber implements MetaDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æœ¬åœ°å†…å­˜ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, MetaData&gt; META_DATA = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å…ƒæ•°æ®å‘ç”Ÿæ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // dubboæœåŠ¡çš„å…ƒæ•°æ®æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¯¹åº”çš„å…ƒæ•°æ®æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaData exist = META_DATA.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || Objects.isNull(ApacheDubboConfigCache.getInstance().get(metaData.getPath()))) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // é¦–æ¬¡åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å¯¹åº”çš„å…ƒæ•°æ®å‘ç”Ÿäº†æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!Objects.equals(metaData.getServiceName(), exist.getServiceName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getRpcExt(), exist.getRpcExt())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getParameterTypes(), exist.getParameterTypes())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getMethodName(), exist.getMethodName())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //æ ¹æ®æœ€æ–°çš„å…ƒæ•°æ®å†æ¬¡æ„å»ºReferenceConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApacheDubboConfigCache.getInstance().build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æœ¬åœ°å†…å­˜ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.put(metaData.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åˆ é™¤å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void unSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ä½¿ReferenceConfigå¤±æ•ˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.remove(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#initRef()</li></ul><p>é€šè¿‡<code>metaData</code>æ„å»º<code>ReferenceConfig</code>å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ReferenceConfig&lt;GenericService&gt; initRef(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œå­˜åœ¨å°±ç›´æ¥è¿”å›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ReferenceConfig&lt;GenericService&gt; referenceConfig = cache.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(referenceConfig.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return referenceConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init dubbo ref exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           //ä¸å­˜åœ¨ï¼Œå°±æ„å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Build reference config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @SuppressWarnings(&quot;deprecation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ReferenceConfig&lt;GenericService&gt; build(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(applicationConfig) || Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ReferenceConfig&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ReferenceConfig&lt;GenericService&gt; reference = new ReferenceConfig&lt;&gt;(); //æ–°å»ºReferenceConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setGeneric(&quot;true&quot;); //æ³›åŒ–è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setAsync(true);//æ”¯æŒå¼‚æ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setApplication(applicationConfig);//è®¾ç½®åº”ç”¨é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setRegistry(registryConfig);//è®¾ç½®æ³¨å†Œä¸­å¿ƒé…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setConsumer(consumerConfig);//è®¾ç½®æ¶ˆè´¹è€…é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setInterface(metaData.getServiceName());//è®¾ç½®æœåŠ¡æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setProtocol(&quot;dubbo&quot;);//è®¾ç½®dubboåè®®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setCheck(false); //ä¸æ£€æŸ¥ service provider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setLoadbalance(&quot;gray&quot;);//æ”¯æŒç°åº¦</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            parameters.put(&quot;dispatcher&quot;, &quot;direct&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setParameters(parameters);//è‡ªå®šä¹‰å‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String rpcExt = metaData.getRpcExt();//rpcæ‰©å±•å‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboParam dubboParam = parserToDubboParam(rpcExt);//ååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(dubboParam)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getVersion())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setVersion(dubboParam.getVersion());//è®¾ç½®ç‰ˆæœ¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getGroup())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setGroup(dubboParam.getGroup());//è®¾ç½®åˆ†ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getUrl())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setUrl(dubboParam.getUrl());//è®¾ç½®url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getCluster())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setCluster(dubboParam.getCluster());//è®¾ç½®Cluster type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getTimeout()).ifPresent(reference::setTimeout);//timeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getRetries()).ifPresent(reference::setRetries);//retires</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getSent()).ifPresent(reference::setSent);//Whether to ack async-sent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //è·å–GenericService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object obj = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(obj)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;init apache dubbo reference success there meteData is :{}&quot;, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //ç¼“å­˜å½“å‰çš„reference</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    cache.put(metaData.getPath(), reference);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init apache dubbo reference exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return reference;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="26-æ‰§è¡Œresponseplugin"></a>2.6 æ‰§è¡ŒResponsePlugin<a class="hash-link" href="#26-æ‰§è¡Œresponseplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>å“åº”ç»“æœç”±<code>ResponsePlugin</code>æ’ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®rpcç±»å‹å¤„ç†ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¤„ç†ç±»å‹ç”±<code>MessageWriter</code>å†³å®šï¼Œç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriterï¼šæ¥å£ï¼Œå®šä¹‰æ¶ˆæ¯å¤„ç†æ–¹æ³•ï¼›</li><li>NettyClientMessageWriterï¼šå¤„ç†<code>Netty</code>è°ƒç”¨ç»“æœï¼›</li><li>RPCMessageWriterï¼šå¤„ç†<code>RPC</code>è°ƒç”¨ç»“æœï¼›</li><li>WebClientMessageWriterï¼šå¤„ç†<code>WebClient</code>è°ƒç”¨ç»“æœï¼›</li></ul><p><code>Dubbo</code>æœåŠ¡è°ƒç”¨ï¼Œå¤„ç†ç»“æœå½“ç„¶æ˜¯<code>RPCMessageWriter</code>äº†ã€‚</p><ul><li>org.apache.shenyu.plugin.response.strategy.RPCMessageWriter#writeWith()</li></ul><p>åœ¨<code>writeWith()</code>æ–¹æ³•ä¸­å¤„ç†å“åº”ç»“æœã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RPCMessageWriter implements MessageWriter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object result = exchange.getAttribute(Constants.RPC_RESULT); //è·å–ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(result)) { //å¤„ç†å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, result);//è¿”å›ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ†æè‡³æ­¤ï¼Œå…³äº<code>Dubbo</code>æ’ä»¶çš„æºç åˆ†æå°±å®Œæˆäº†ï¼Œåˆ†ææµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/dubbo-execute-zh-cd073b32b44fa14c94a575450d8b320d.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-å°ç»“"></a>3. å°ç»“<a class="hash-link" href="#3-å°ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡æºç åˆ†æä»<code>Dubbo</code>æœåŠ¡æ³¨å†Œå¼€å§‹ï¼Œåˆ°<code>Dubbo</code>æ’ä»¶çš„æœåŠ¡è°ƒç”¨ã€‚<code>Dubbo</code>æ’ä»¶ä¸»è¦ç”¨æ¥å¤„ç†å°†<code>http</code>è¯·æ±‚è½¬æˆ<code>dubbo</code>åè®®,ä¸»è¦é€»è¾‘æ˜¯é€šè¿‡æ³›åŒ–è°ƒç”¨å®ç°ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/dubbo">dubbo</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register">æ³¨å†Œä¸­å¿ƒå®ç°åŸç†ä¹‹Httpæ³¨å†Œ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.463Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ³¨å†Œä¸­å¿ƒæ˜¯ç”¨äºå°†å®¢æˆ·ç«¯ä¿¡æ¯æ³¨å†Œåˆ°<code>shenyu-admin</code>ï¼Œ<code>admin</code>å†é€šè¿‡æ•°æ®åŒæ­¥å°†è¿™äº›ä¿¡æ¯åŒæ­¥åˆ°ç½‘å…³ï¼Œç½‘å…³é€šè¿‡è¿™äº›æ•°æ®å®Œæˆæµé‡ç­›é€‰ã€‚å®¢æˆ·ç«¯ä¿¡æ¯ä¸»è¦åŒ…æ‹¬<code>æ¥å£ä¿¡æ¯</code>å’Œ<code>URIä¿¡æ¯</code>ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.5.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/register-center-design" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-æ³¨å†Œä¸­å¿ƒåŸç†"></a>1. æ³¨å†Œä¸­å¿ƒåŸç†<a class="hash-link" href="#1-æ³¨å†Œä¸­å¿ƒåŸç†" title="Direct link to heading">#</a></h3><p>å½“å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œè¯»å–æ¥å£ä¿¡æ¯å’Œ<code>uriä¿¡æ¯</code>ï¼Œé€šè¿‡æŒ‡å®šçš„æ³¨å†Œç±»å‹ï¼Œå°†æ•°æ®å‘é€åˆ°<code>shenyu-admin</code>ã€‚</p><p><img src="/zh/assets/images/register-center-6df3139bde6babdb3360f928f93bf737.png"></p><p>å›¾ä¸­çš„æ³¨å†Œä¸­å¿ƒéœ€è¦ç”¨æˆ·æŒ‡å®šä½¿ç”¨å“ªç§æ³¨å†Œç±»å‹ï¼Œ<code>ShenYu</code>å½“å‰æ”¯æŒ<code>Http</code>ã€<code>Zookeeper</code>ã€<code>Etcd</code>ã€<code>Consul</code>å’Œ<code>Nacos</code>è¿›è¡Œæ³¨å†Œã€‚å…·ä½“å¦‚ä½•é…ç½®è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><p><code>ShenYu</code>åœ¨æ³¨å†Œä¸­å¿ƒçš„åŸç†è®¾è®¡ä¸Šå¼•å…¥äº†<code>Disruptor</code>ï¼Œ<code>Disruptor</code>é˜Ÿåˆ—åœ¨å…¶ä¸­èµ·åˆ°æ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œåˆ©äºæ‰©å±•ã€‚å¦‚æœæ³¨å†Œè¯·æ±‚è¿‡å¤šï¼Œå¯¼è‡´æ³¨å†Œå¼‚å¸¸ï¼Œä¹Ÿæœ‰æ•°æ®ç¼“å†²ä½œç”¨ã€‚</p><p><img src="/zh/assets/images/shenyu-register-center-679a8ce3a7173b5f7a29f312448efa47.png"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ³¨å†Œä¸­å¿ƒåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€æ˜¯æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯<code>register-client</code>ï¼Œè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯æ•°æ®è¯»å–ã€‚å¦ä¸€ä¸ªæ˜¯æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯<code>register-server</code>ï¼Œè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ï¼ˆå°±æ˜¯<code>shenyu-admin</code>ï¼‰æ•°æ®å†™å…¥ã€‚é€šè¿‡æŒ‡å®šæ³¨å†Œç±»å‹è¿›è¡Œæ•°æ®å‘é€å’Œæ¥æ”¶ã€‚</p><ul><li>å®¢æˆ·ç«¯ï¼šé€šå¸¸æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå¯ä»¥æ˜¯<code>springmvc</code>ï¼Œ<code>spring-cloud</code>ï¼Œ<code>dubbo</code>ï¼Œ<code>grpc</code>ç­‰ã€‚</li><li><code>register-client</code>ï¼šæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯ï¼Œè¯»å–å®¢æˆ·æ¥å£å’Œ<code>uri</code>ä¿¡æ¯ã€‚</li><li><code>Disruptor</code>ï¼šæ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œæ•°æ®ç¼“å†²ä½œç”¨ã€‚</li><li><code>register-server</code>ï¼šæ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯ï¼Œè¿™é‡Œå°±æ˜¯<code>shenyu-admin</code>ï¼Œæ¥æ”¶æ•°æ®ï¼Œå†™å…¥æ•°æ®åº“ï¼Œå‘æ•°æ®åŒæ­¥äº‹ä»¶ã€‚</li><li>æ³¨å†Œç±»å‹ï¼šæŒ‡å®šæ³¨å†Œç±»å‹ï¼Œå®Œæˆæ•°æ®æ³¨å†Œï¼Œå½“å‰æ”¯æŒ<code>Http</code>ã€<code>Zookeeper</code>ã€<code>Etcd</code>ã€<code>Consul</code>å’Œ<code>Nacos</code>ã€‚</li></ul><p>æœ¬æ–‡åˆ†æçš„æ˜¯ä½¿ç”¨<code>Http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥å…·ä½“çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/shenyu-register-center-http-540b66ff202c41000b463cfae8403699.png"></p><p>åœ¨å®¢æˆ·ç«¯ï¼Œæ•°æ®å‡ºé˜Ÿåˆ—åï¼Œé€šè¿‡<code>http</code>ä¼ è¾“æ•°æ®ï¼Œåœ¨æœåŠ¡ç«¯ï¼Œæä¾›ç›¸åº”çš„æ¥å£ï¼Œæ¥æ”¶æ•°æ®ï¼Œç„¶åå†™å…¥é˜Ÿåˆ—ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹"></a>2. å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹<a class="hash-link" href="#2-å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹" title="Direct link to heading">#</a></h3><p>å½“å®¢æˆ·ç«¯å¯åŠ¨åï¼Œæ ¹æ®ç›¸å…³é…ç½®ï¼Œè¯»å–å±æ€§ä¿¡æ¯ï¼Œç„¶åå†™å…¥é˜Ÿåˆ—ã€‚ä»¥å®˜æ–¹æä¾›çš„ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> ä¸ºä¾‹ï¼Œå¼€å§‹æºç åˆ†æã€‚å®˜æ–¹æä¾›çš„ä¾‹å­æ˜¯ä¸€ä¸ªç”±<code>springboot</code>æ„å»ºçš„å¾®æœåŠ¡ã€‚æ³¨å†Œä¸­å¿ƒçš„ç›¸å…³é…ç½®å¯ä»¥å‚è€ƒå®˜ç½‘  <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-åŠ è½½é…ç½®è¯»å–å±æ€§"></a>2.1 åŠ è½½é…ç½®ï¼Œè¯»å–å±æ€§<a class="hash-link" href="#21-åŠ è½½é…ç½®è¯»å–å±æ€§" title="Direct link to heading">#</a></h4><p>å…ˆç”¨ä¸€å¼ å›¾ä¸²è”ä¸‹æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯åˆå§‹åŒ–æµç¨‹ï¼š</p><p><img src="/zh/assets/images/client-register-init-zh-40a0219a500b6637453b6ad0daf1bf87.png"></p><p>æˆ‘ä»¬åˆ†æçš„æ˜¯é€šè¿‡<code>http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¯ä¸ªå±æ€§è¡¨ç¤ºçš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>registerType</code>: æœåŠ¡æ³¨å†Œç±»å‹ï¼Œå¡«å†™ <code>http</code>ã€‚</li><li><code>serverList</code>: ä¸º<code>http</code>æ³¨å†Œç±»å‹æ—¶ï¼Œå¡«å†™<code>Shenyu-Admin</code>é¡¹ç›®çš„åœ°å€ï¼Œæ³¨æ„åŠ ä¸Š<code>http://</code>ï¼Œå¤šä¸ªåœ°å€ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚</li><li><code>username</code>: <code>Shenyu-Admin</code>ç”¨æˆ·å</li><li><code>password</code>: <code>Shenyu-Admin</code>ç”¨æˆ·å¯¹åº”çš„å¯†ç </li><li><code>port</code>: ä½ æœ¬é¡¹ç›®çš„å¯åŠ¨ç«¯å£ï¼Œç›®å‰<code>springmvc/tars/grpc</code>éœ€è¦è¿›è¡Œå¡«å†™ã€‚</li><li><code>contextPath</code>: ä¸ºä½ çš„è¿™ä¸ª<code>mvc</code>é¡¹ç›®åœ¨<code>shenyu</code>ç½‘å…³çš„è·¯ç”±å‰ç¼€ï¼Œ æ¯”å¦‚<code>/order</code> ï¼Œ<code>/product</code> ç­‰ç­‰ï¼Œç½‘å…³ä¼šæ ¹æ®ä½ çš„è¿™ä¸ªå‰ç¼€æ¥è¿›è¡Œè·¯ç”±ã€‚</li><li><code>appName</code>ï¼šä½ çš„åº”ç”¨åç§°ï¼Œä¸é…ç½®çš„è¯ï¼Œä¼šé»˜è®¤å– <code>spring.application.name</code> çš„å€¼ã€‚</li><li><code>isFull</code>: è®¾ç½® <code>true</code> ä»£è¡¨ä»£ç†ä½ çš„æ•´ä¸ªæœåŠ¡ï¼Œ<code>false</code>è¡¨ç¤ºä»£ç†ä½ å…¶ä¸­æŸå‡ ä¸ª<code>controller</code>ï¼›ç›®å‰é€‚ç”¨äº<code>springmvc/springcloud</code>ã€‚</li></ul><p>é¡¹ç›®å¯åŠ¨åï¼Œä¼šå…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œè¯»å–å±æ€§ä¿¡æ¯ï¼Œç”Ÿæˆç›¸åº”çš„<code>Bean</code>ã€‚</p><p>é¦–å…ˆè¯»å–åˆ°çš„é…ç½®æ–‡ä»¶æ˜¯ <code>ShenyuSpringMvcClientConfiguration</code>ï¼Œå®ƒæ˜¯<code>shenyu</code> å®¢æˆ·ç«¯<code>http</code>æ³¨å†Œé…ç½®ç±»ï¼Œé€šè¿‡<code>@Configuration</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œé€šè¿‡<code>@ImportAutoConfiguration</code>å¼•å…¥å…¶ä»–é…ç½®ç±»ã€‚åˆ›å»º<code>SpringMvcClientEventListener</code>ï¼Œä¸»è¦å¤„ç†å…ƒæ•°æ®å’Œ <code>URI</code> ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyu å®¢æˆ·ç«¯httpæ³¨å†Œé…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // åˆ›å»ºSpringMvcClientEventListenerï¼Œä¸»è¦å¤„ç†å…ƒæ•°æ®å’ŒURIä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                     final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuClientCommonBeanConfiguration</code>æ˜¯<code>shenyu</code>å®¢æˆ·ç«¯é€šç”¨é…ç½®ç±»ï¼Œä¼šåˆ›å»ºæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯é€šç”¨çš„<code>bean</code>ã€‚</p><ul><li>åˆ›å»º<code>ShenyuClientRegisterRepository</code>ï¼Œé€šè¿‡å·¥å‚ç±»åˆ›å»ºè€Œæˆã€‚</li><li>åˆ›å»º<code>ShenyuRegisterCenterConfig</code>ï¼Œè¯»å–<code>shenyu.register</code>å±æ€§é…ç½®ã€‚</li><li>åˆ›å»º<code>ShenyuClientConfig</code>ï¼Œè¯»å–<code>shenyu.client</code>å±æ€§é…ç½®ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyuå®¢æˆ·ç«¯é€šç”¨é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientCommonBeanConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // åˆ›å»ºShenyuClientRegisterRepositoryï¼Œé€šè¿‡å·¥å‚ç±»åˆ›å»ºè€Œæˆã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientRegisterRepository shenyuClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuClientRegisterRepositoryFactory.newInstance(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºShenyuRegisterCenterConfigï¼Œè¯»å–shenyu.registerå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // åˆ›å»ºShenyuClientConfigï¼Œè¯»å–shenyu.clientå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientConfig shenyuClientConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuClientConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-ç”¨äºæ³¨å†Œçš„-httpclientregisterrepository"></a>2.2 ç”¨äºæ³¨å†Œçš„ HttpClientRegisterRepository<a class="hash-link" href="#22-ç”¨äºæ³¨å†Œçš„-httpclientregisterrepository" title="Direct link to heading">#</a></h4><p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¸­ç”Ÿæˆçš„<code>ShenyuClientRegisterRepository</code>æ˜¯å®¢æˆ·ç«¯æ³¨å†Œçš„å…·ä½“å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒçš„å®ç°ç±»å¦‚ä¸‹ã€‚</p><p><img src="/zh/assets/images/shenyu-client-register-repository-dba8edf50af1be31d8b53c9573b1e015.png"></p><ul><li><code>HttpClientRegisterRepository</code>ï¼šé€šè¿‡<code>http</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>ConsulClientRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>EtcdClientRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>NacosClientRegisterRepository</code>ï¼šé€šè¿‡<code>nacos</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>ZookeeperClientRegisterRepository</code>é€šè¿‡<code>Zookeeper</code>è¿›è¡Œæ³¨å†Œã€‚</li></ul><p>å…·ä½“æ˜¯å“ªä¸€ç§æ–¹å¼ï¼Œæ˜¯é€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½å®ç°çš„ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * åŠ è½½ ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»º ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡SPIçš„æ–¹å¼è¿›è¡ŒåŠ è½½ï¼Œç±»å‹ç”±registerTypeå†³å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŠ è½½ç±»å‹é€šè¿‡<code>registerType</code>æŒ‡å®šï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ç±»å‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆ‘ä»¬æŒ‡å®šçš„æ˜¯<code>http</code>ï¼Œæ‰€ä»¥ä¼šå»åŠ è½½<code>HttpClientRegisterRepository</code>ã€‚å¯¹è±¡åˆ›å»ºæˆåŠŸåï¼Œæ‰§è¡Œçš„åˆå§‹åŒ–æ–¹æ³•<code>init()</code>å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository implements ShenyuClientRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // æš‚æ—¶çœç•¥å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„<code>username</code>ã€<code>password</code>å’Œ<code>serverLists</code>ï¼Œå³<code>sheenyu-admin</code>çš„è®¿é—®è´¦å·ã€å¯†ç å’Œåœ°å€ä¿¡æ¯ï¼Œä¸ºåç»­æ•°æ®å‘é€åšå‡†å¤‡ã€‚ç±»æ³¨è§£<code>@Join</code>ç”¨äº<code>SPI</code>çš„åŠ è½½ã€‚</p><blockquote><p><code>SPI</code> å…¨ç§°ä¸º <code>Service Provider Interface</code>, æ˜¯ <code>JDK</code> å†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°åŠŸèƒ½, ä¸€ç§åŠ¨æ€æ›¿æ¢å‘ç°çš„æœºåˆ¶ã€‚</p><p><a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-spi" target="_blank" rel="noopener noreferrer">shenyu-spi</a> æ˜¯<code>Apache ShenYu</code>ç½‘å…³è‡ªå®šä¹‰çš„<code>SPI</code>æ‰©å±•å®ç°ï¼Œè®¾è®¡å’Œå®ç°åŸç†å‚è€ƒäº†<code>Dubbo</code>çš„ <a href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/" target="_blank" rel="noopener noreferrer">SPIæ‰©å±•å®ç°</a> ã€‚</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23--æ„å»º-å…ƒæ•°æ®-å’Œ-uriä¿¡æ¯-çš„-springmvcclienteventlistener"></a>2.3  æ„å»º å…ƒæ•°æ® å’Œ URIä¿¡æ¯ çš„ SpringMvcClientEventListener<a class="hash-link" href="#23--æ„å»º-å…ƒæ•°æ®-å’Œ-uriä¿¡æ¯-çš„-springmvcclienteventlistener" title="Direct link to heading">#</a></h4><p>åˆ›å»º <code>SpringMvcClientEventListener</code>ï¼Œè´Ÿè´£å®¢æˆ·ç«¯ <code>å…ƒæ•°æ®</code> å’Œ <code>URI</code> æ•°æ®çš„æ„å»ºå’Œæ³¨å†Œï¼Œå®ƒçš„åˆ›å»ºæ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®Œæˆã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  åˆ›å»º SpringMvcClientEventListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>SpringMvcClientEventListener</code>ç»§æ‰¿äº†<code>AbstractContextRefreshedEventListener</code></li></ul><p><img src="/zh/assets/images/shenyu-client-event-listener-0cd56409c59f2546a285a6426f9c8fee.png"></p><p><code>AbstractContextRefreshedEventListener</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº†<code>ApplicationListener</code>æ¥å£ï¼Œå¹¶é‡å†™äº†<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œå½“æœ‰Springäº‹ä»¶å‘ç”Ÿåï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œã€‚å®ƒçš„å®ç°ç›®å‰æœ‰å…«ç§ï¼Œæ¯ä¸€ç§è¡¨ç¤ºå¯¹åº”çš„RPCè°ƒç”¨åè®®çš„ <code>å…ƒæ•°æ®</code> å’Œ<code>URI</code> ä¿¡æ¯çš„æ³¨å†Œã€‚</p><ul><li><code>AlibabaDubboServiceBeanListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Alibaba Dubbo</code>åè®®ï¼›</li><li><code>ApacheDubboServiceBeanListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Apacge Dubbo</code>åè®®ï¼›</li><li><code>GrpcClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>grpc</code>åè®®ï¼›</li><li><code>MotanServiceEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Mortan</code>åè®®ï¼›</li><li><code>SofaServiceEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Sofa</code>åè®®ï¼›</li><li><code>SpringMvcClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>http</code>åè®®ï¼›</li><li><code>SpringWebSocketClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>websocket</code>åè®®ï¼›</li><li><code>TarsServiceBeanEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Tars</code>æ³¨å†Œç±»å‹ï¼›</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å®ç°äº†ApplicationListeneræ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractContextRefreshedEventListener&lt;T, A extends Annotation&gt; implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ„é€ å‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractContextRefreshedEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯»å– shenyu.client.http é…ç½®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // appName åº”ç”¨åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // contextPathä¸Šä¸‹æ–‡è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = Optional.ofNullable(props.getProperty(ShenyuClientConstants.CONTEXT_PATH)).map(UriUtils::repairData).orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;client register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.ipAndPort = props.getProperty(ShenyuClientConstants.IP_PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // hostä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // port å®¢æˆ·ç«¯ç«¯å£ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¼€å§‹äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“æœ‰ä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ContextRefreshedEventå‘ç”Ÿæ—¶ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¿è¯è¯¥æ–¹æ³•çš„å†…å®¹åªæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ApplicationContext context = event.getApplicationContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å£°æ˜RPCè°ƒç”¨çš„ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, T&gt; beans = getBeans(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (MapUtils.isEmpty(beans)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºURIæ•°æ®å¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildURIRegisterDTO(context, beans));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºå…ƒæ•°æ®å¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        beans.forEach(this::handle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº¤ç»™ä¸åŒçš„å­ç±»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;all&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract URIRegisterDTO buildURIRegisterDTO(ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                          Map&lt;String, T&gt; beans);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handle(final String beanName, final T bean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = getCorrectedClass(bean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„å¯¹åº”shenyuå®¢æˆ·ç«¯çš„æ³¨è§£ï¼ˆå¯¹åº”ä¸åŒçš„RPCè°ƒç”¨æ³¨è§£ä¸ä¸€æ ·ï¼Œåƒhttpçš„å°±æ˜¯@ShenyuSpringMvcClient,è€ŒåƒSpringCloudçš„åˆ™æ˜¯@ShenyuSpringCloudClientï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final A beanShenyuClient = AnnotatedElementUtils.findMergedAnnotation(clazz, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®beanè·å–å¯¹åº”çš„pathï¼ˆä¸åŒå­ç±»å®ç°ä¸ä¸€æ ·ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(clazz, beanShenyuClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœåŒ…å«Shenyuå®¢æˆ·ç«¯æ³¨è§£æˆ–è€…pathä¸­åŒ…æ‹¬&#x27;*&#x27;ï¼Œè¡¨ç¤ºæ³¨å†Œæ•´ä¸ªç±»çš„æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºç±»çš„å…ƒæ•°æ®ï¼Œå‘é€æ³¨å†Œäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleClass(clazz, bean, beanShenyuClient, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„æ‰€æœ‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†Œç¬¦åˆæ¡ä»¶çš„æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleMethod(bean, clazz, beanShenyuClient, method, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºç±»å…ƒæ•°æ®å¹¶æ³¨å†Œçš„é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleClass(final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               @NonNull final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildMetaDataDTO(bean, beanShenyuClient, pathJoin(contextPath, superPath), clazz, null));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºæ–¹æ³•å…ƒæ•°æ®å¹¶æ³¨å†Œçš„é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ–¹æ³•ä¸Šæœ‰Shenyuå®¢æˆ·ç«¯æ³¨è§£ï¼Œå°±è¡¨ç¤ºè¯¥æ–¹æ³•éœ€è¦æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        A methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºå…ƒæ•°æ®ï¼Œå‘é€æ³¨å†Œäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº¤ç»™ä¸åŒå­ç±»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract MetaDataRegisterDTO buildMetaDataDTO(T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            @NonNull A shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            String path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Method method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨æ„é€ å‡½æ•°ä¸­ä¸»è¦æ˜¯è¯»å–å±æ€§é…ç½®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åï¼Œæ‰§è¡Œäº†<code>publisher.start()</code>ï¼Œå¼€å§‹äº‹ä»¶å‘å¸ƒï¼Œä¸ºæ³¨å†Œåšå‡†å¤‡ã€‚</p><ul><li>ShenyuClientRegisterEventPublisher</li></ul><p><code>ShenyuClientRegisterEventPublisher</code>é€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ï¼Œä¸»è¦æ˜¯ç”Ÿæˆå…ƒæ•°æ®å’Œ<code>URI</code>è®¢é˜…å™¨ï¼ˆåç»­ç”¨äºæ•°æ®å‘å¸ƒï¼‰ï¼Œç„¶åå¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚æä¾›äº†ä¸€ä¸ªå…±æœ‰æ–¹æ³•<code>publishEvent()</code>ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œå‘Disruptoré˜Ÿåˆ—å‘æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientRegisterEventPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuClientRegisterEventPublisher INSTANCE = new ShenyuClientRegisterEventPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;DataTypeParent&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¬å¼€é™æ€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ShenyuClientRegisterEventPublisher instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterEventPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Startæ–¹æ³•æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param shenyuClientRegisterRepository shenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºå®¢æˆ·ç«¯æ³¨å†Œå·¥å‚ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientExecutorFactory factory = new RegisterClientExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ å…ƒæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientMetadataExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  æ·»åŠ URIè®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientURIExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯åŠ¨Disruptoré˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å‘å¸ƒäº‹ä»¶ï¼Œå‘Disruptoré˜Ÿåˆ—å‘æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publishEvent(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;DataTypeParent&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AbstractContextRefreshedEventListener</code>çš„æ„é€ å‡½æ•°é€»è¾‘åˆ†æå®Œæˆäº†ï¼Œä¸»è¦æ˜¯è¯»å–å±æ€§é…ç½®ï¼Œåˆ›å»º<code>å…ƒæ•°æ®</code>å’Œ<code>URI</code>è®¢é˜…å™¨ï¼Œå¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚</p><p><code>onApplicationEvent()</code>æ–¹æ³•æ˜¯æœ‰<code>Spring</code>äº‹ä»¶å‘ç”Ÿæ—¶ä¼šæ‰§è¡Œï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯<code>ContextRefreshedEvent</code>ï¼Œè¡¨ç¤ºä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ã€‚å½“<code>Spring</code>å®¹å™¨å°±ç»ªåæ‰§è¡Œæ­¤å¤„é€»è¾‘ï¼šå…ˆæ„å»º<code>URI</code>æ•°æ®å¹¶æ³¨å†Œï¼Œå†æ„å»ºå…ƒæ•°æ®å¹¶æ³¨å†Œï¼Œ</p><blockquote><p><code>ContextRefreshedEvent</code>æ˜¯<code>Spring</code>å†…ç½®äº‹ä»¶ã€‚<code>ApplicationContext</code>è¢«åˆå§‹åŒ–æˆ–åˆ·æ–°æ—¶ï¼Œè¯¥äº‹ä»¶è¢«è§¦å‘ã€‚è¿™ä¹Ÿå¯ä»¥åœ¨ <code>ConfigurableApplicationContext</code>æ¥å£ä¸­ä½¿ç”¨ <code>refresh()</code> æ–¹æ³•æ¥å‘ç”Ÿã€‚æ­¤å¤„çš„åˆå§‹åŒ–æ˜¯æŒ‡ï¼šæ‰€æœ‰çš„<code>Bean</code>è¢«æˆåŠŸè£…è½½ï¼Œåå¤„ç†<code>Bean</code>è¢«æ£€æµ‹å¹¶æ¿€æ´»ï¼Œæ‰€æœ‰<code>Singleton Bean</code> è¢«é¢„å®ä¾‹åŒ–ï¼Œ<code>ApplicationContext</code>å®¹å™¨å·²å°±ç»ªå¯ç”¨ã€‚</p></blockquote><p>å†æ¥çœ‹<code>AbstractContextRefreshedEventListener</code>çš„httpå®ç°<code>SpringMvcClientEventListener</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientEventListener extends AbstractContextRefreshedEventListener&lt;Object, ShenyuSpringMvcClient&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;Class&lt;? extends Annotation&gt;&gt; mappingAnnotation = new ArrayList&lt;&gt;(3);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Boolean isFull;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ å‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(clientConfig, shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å– isFull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¡¨ç¤ºæ˜¯httpåè®®çš„å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Map&lt;String, Object&gt; getBeans(final ApplicationContext context) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½®å±æ€§ï¼Œå¦‚æœ isFull=true çš„è¯ï¼Œè¡¨ç¤ºæ³¨å†Œæ•´ä¸ªå¾®æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .contextPath(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .appName(getAppName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .path(PathUtils.decoratorPathWithSlash(getContextPath()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ruleName(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦åˆ™è·å–å¸¦Controlleræ³¨è§£çš„bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context.getBeansWithAnnotation(Controller.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ URIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected URIRegisterDTO buildURIRegisterDTO(final ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final Map&lt;String, Object&gt; beans) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String buildApiSuperPath(final Class&lt;?&gt; clazz, @Nullable final ShenyuSpringMvcClient beanShenyuClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰å¸¦ä¸ŠShenyuå®¢æˆ·ç«¯æ³¨è§£ï¼Œåˆ™ä¼˜å…ˆå–æ³¨è§£ä¸­çš„ä¸ä¸ºç©ºçš„pathå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; StringUtils.isNotBlank(beanShenyuClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return beanShenyuClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰å¸¦ä¸ŠRequestMappingæ³¨è§£ï¼Œä¸”pathå±æ€§ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›pathæ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(clazz, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å£°æ˜httpå®ç°çš„å®¢æˆ·ç«¯æ³¨è§£æ˜¯ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Class&lt;ShenyuSpringMvcClient&gt; getAnnotationType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuSpringMvcClient.class;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final Object bean, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final ShenyuSpringMvcClient beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method, final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„RequestMappingæ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„ ShenyuSpringMvcClient æ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœæœ‰ ShenyuSpringMvcClient æ³¨è§£å¹¶ä¸”åŒ…å«RequestMappingæ³¨è§£ï¼ˆè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ¥å£ï¼‰ï¼Œåˆ™è¿›è¡Œæ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient) &amp;&amp; Objects.nonNull(requestMapping)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected MetaDataRegisterDTO buildMetaDataDTO(final Object bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   @NonNull final ShenyuSpringMvcClient shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final String path, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ³¨å†Œé€»è¾‘éƒ½æ˜¯é€šè¿‡ <code>publisher.publishEvent()</code>å®Œæˆã€‚</p><p><code>Controller</code>æ³¨è§£å’Œ<code>RequestMapping</code>æ³¨è§£æ˜¯ç”±<code>Spring</code>æä¾›çš„ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚<code>ShenyuSpringMvcClient</code> æ³¨è§£æ˜¯ç”±<code>Apache ShenYu</code>æä¾›çš„ï¼Œç”¨äºæ³¨å†Œ<code>SpringMvc</code>å®¢æˆ·ç«¯ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyu å®¢æˆ·ç«¯æ¥å£ï¼Œç”¨äºæ–¹æ³•ä¸Šæˆ–ç±»ä¸Š</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;path&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;value&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ruleName è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // desc æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // enabledæ˜¯å¦å¯ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // registerMetaData æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean  registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å®ƒçš„ä½¿ç”¨å¦‚ä¸‹ï¼š</p><ul><li>æ³¨å†Œæ•´ä¸ªæ¥å£</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/test/**&quot;)  // è¡¨ç¤ºæ•´ä¸ªæ¥å£æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpTestController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ³¨å†Œå½“å‰æ–¹æ³•</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Save order dto.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param orderDTO the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/save&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/save&quot;, desc = &quot;Save order&quot;) // æ³¨å†Œå½“å‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO save(@RequestBody final OrderDTO orderDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDTO.setName(&quot;hello world save order&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>publisher.publishEvent() å‘å¸ƒæ³¨å†Œäº‹ä»¶</li></ul><p>è¯¥æ–¹æ³•ä¼šå°†æ•°æ®å‘é€åˆ°<code>Disruptor</code>é˜Ÿåˆ—ä¸­ï¼Œå…³äº<code>Disruptor</code>é˜Ÿåˆ—æ›´å¤šç»†èŠ‚è¿™é‡Œä¸åšæ›´å¤šä»‹ç»ï¼Œè¿™ä¸å½±å“åˆ†ææ³¨å†Œçš„æµç¨‹ã€‚</p><p>å½“æ•°æ®å‘é€åï¼Œ<code>Disruptor</code>é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ä¼šå¤„ç†æ•°æ®ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚</p><ul><li>QueueConsumer æ¶ˆè´¹æ•°æ®</li></ul><p><code>QueueConsumer</code>æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå®ç°äº†<code>WorkHandler</code>æ¥å£ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹åœ¨<code>providerManage.startup()</code>é€»è¾‘ä¸­ã€‚<code>WorkHandler</code>æ¥å£æ˜¯<code>disruptor</code>çš„æ•°æ®æ¶ˆè´¹æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯<code>onEvent()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumer</code>é‡å†™äº†<code>onEvent()</code>æ–¹æ³•ï¼Œä¸»è¦é€»è¾‘æ˜¯ç”Ÿæˆæ¶ˆè´¹ä»»åŠ¡ï¼Œç„¶ååœ¨çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é˜Ÿåˆ—æ¶ˆè´¹è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®äº‹ä»¶ç±»å‹ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡å·¥å‚åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¿å­˜æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ”¾åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code>æ˜¯åœ¨çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå…·ä½“çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼š</p><ul><li><code>RegisterClientConsumerExecutor</code>ï¼šå®¢æˆ·ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼›</li><li><code>RegisterServerConsumerExecutor</code>ï¼šæœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ã€‚</li></ul><p>é¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯ä»»åŠ¡ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ä»»åŠ¡ï¼ˆæœåŠ¡ç«¯å°±æ˜¯<code>admin</code>ï¼Œåœ¨ä¸‹æ–‡è¿›è¡Œåˆ†æï¼‰ã€‚</p><p><img src="/zh/assets/images/consumer-executor-f7ad67d35abaa5a2fac94ef913445a19.png"></p><ul><li>RegisterClientConsumerExecutor æ¶ˆè´¹è€…æ‰§è¡Œå™¨</li></ul><p>é‡å†™çš„<code>run()</code>é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterClientConsumerExecutor&lt;T extends DataTypeParent&gt; extends QueueConsumerExecutor&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final T data = getData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®æ•°æ®ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†å™¨è¿›è¡Œå¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribers.get(data.getType()).executor(Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹è°ƒç”¨ä¸åŒçš„å¤„ç†å™¨å»æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ã€‚æ•°æ®ç±»å‹æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯å…ƒæ•°æ®ï¼Œè®°å½•å®¢æˆ·ç«¯æ³¨å†Œä¿¡æ¯ã€‚ä¸€ä¸ªæ˜¯<code>URI</code>æ•°æ®ï¼Œè®°å½•å®¢æˆ·ç«¯æœåŠ¡ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//æ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public enum DataType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // URIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    URI,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor() æ‰§è¡Œå™¨è®¢é˜…è€…</li></ul><p>æ‰§è¡Œå™¨è®¢é˜…è€…ä¹Ÿåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯å¤„ç†å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ˜¯å¤„ç†<code>URI</code>ã€‚åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥ä¸€å…±æ˜¯å››ä¸ªã€‚</p><p><img src="/zh/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><p>å…ˆçœ‹å…ƒæ•°æ®å¤„ç†</p><ul><li>ShenyuClientMetadataExecutorSubscriber#executor()</li></ul><p>å®¢æˆ·ç«¯è¿™è¾¹å¯¹å…ƒæ•°æ®å¤„ç†é€»è¾‘æ˜¯ï¼šéå†å…ƒæ•°æ®ä¿¡æ¯ï¼Œè°ƒç”¨æ¥å£æ–¹æ³•<code>persistInterface()</code>å®Œæˆæ•°æ®çš„å‘å¸ƒã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientMetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA; // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (MetaDataRegisterDTO metaDataRegisterDTO : metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è°ƒç”¨æ¥å£æ–¹æ³•persistInterface()å®Œæˆæ•°æ®çš„å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistInterface(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterRepository#persistInterface()</li></ul><p><code>ShenyuClientRegisterRepository</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºè¡¨ç¤ºå®¢æˆ·ç«¯æ•°æ®æ³¨å†Œï¼Œå®ƒçš„å®ç°ç±»ç›®å‰æœ‰äº”ç§ï¼Œæ¯ä¸€ç§å°±è¡¨ç¤ºä¸€ç§æ³¨å†Œæ–¹æ³•ã€‚</p><ul><li><code>ConsulClientRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>EtcdClientRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>HttpClientRegisterRepository</code>ï¼šé€šè¿‡<code>Http</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>NacosClientRegisterRepository</code>ï¼šé€šè¿‡<code>Nacos</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>ZookeeperClientRegisterRepository</code>ï¼šé€šè¿‡<code>Zookeeper</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li></ul><p><img src="/zh/assets/images/client-register-repository-61756e3284c1d3a27083b25d393edf9c.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ³¨å†Œä¸­å¿ƒçš„åŠ è½½æ˜¯é€šè¿‡<code>SPI</code>çš„æ–¹å¼å®Œæˆçš„ã€‚è¿™ä¸ªåœ¨å‰é¢æåˆ°è¿‡äº†ï¼Œåœ¨å®¢æˆ·ç«¯é€šç”¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æŒ‡å®šé…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å®Œæˆå…·ä½“çš„ç±»åŠ è½½ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * åŠ è½½ ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»º ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡SPIçš„æ–¹å¼è¿›è¡ŒåŠ è½½ï¼Œç±»å‹ç”±registerTypeå†³å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ¬æ–‡çš„æºç åˆ†ææ˜¯åŸºäº<code>Http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ†æ<code>HttpClientRegisterRepository</code>ï¼Œå…¶ä»–çš„æ³¨å†Œæ–¹å¼åç»­å†åˆ†æã€‚<code>HttpClientRegisterRepository</code>ç»§æ‰¿äº†<code>FailbackRegistryRepository</code>ï¼Œè€Œ<code>FailbackRegistryRepository</code>æœ¬èº«ä¸»è¦ç”¨äºå¯¹<code>Http</code>æ³¨å†Œè¿‡ç¨‹ä¸­çš„å¤±è´¥å¼‚å¸¸çš„å¤„ç†ï¼Œè¿™é‡Œå°±çœç•¥äº†ã€‚</p><p>é€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œå¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨å·¥å…·ç±»å‘é€<code>http</code>è¯·æ±‚ã€‚æ³¨å†Œå…ƒæ•°æ®å’ŒURIéƒ½æ˜¯è°ƒç”¨çš„åŒä¸€ä¸ªæ–¹æ³•<code>doRegister()</code>ï¼ŒæŒ‡å®šæ¥å£å’Œç±»å‹å°±å¥½ã€‚</p><ul><li><code>Constants.URI_PATH</code>çš„å€¼<code>/shenyu-client/register-metadata</code>ï¼šæœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†Œå…ƒæ•°æ®ã€‚</li><li><code>Constants.META_PATH</code>çš„å€¼<code>/shenyu-client/register-uri</code>ï¼š    æœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†ŒURIã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository extends FailbackRegistryRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientRegisterRepository.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static URIRegisterDTO uriRegisterDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;String&gt; serverList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        init(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminçš„ç”¨æˆ·å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminçš„ç”¨æˆ·åå¯¹åº”çš„å¯†ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminæœåŠ¡åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®è®¿é—®çš„token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Persist uri.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param registerDTO the register dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistURI(final URIRegisterDTO registerDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RuntimeUtils.listenByOther(registerDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(registerDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uriRegisterDTO = registerDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistInterface(final MetaDataRegisterDTO metadata) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(metadata, Constants.META_PATH, Constants.META_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uriRegisterDTO != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            uriRegisterDTO.setEventType(EventType.DELETED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRegister(uriRegisterDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setAccessToken() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional&lt;?&gt; login = RegisterUtils.doLogin(username, password, server.concat(Constants.LOGIN_PATH));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                login.ifPresent(v -&gt; this.accessToken = String.valueOf(v));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Login admin url :{} is fail, will retry. cause: {} &quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void doRegister(final T t, final String path, final String type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†adminæœåŠ¡åˆ—è¡¨ï¼ˆadminå¯èƒ½æ˜¯é›†ç¾¤ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            i++;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String concat = server.concat(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è®¾ç½®è®¿é—®token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new NullPointerException(&quot;accessToken is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è°ƒç”¨å·¥å…·ç±»å‘é€ http è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RegisterUtils.doRegister(GsonUtils.getInstance().toJson(t), concat, type, accessToken);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Register admin url :{} is fail, will retry. cause:{}&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (i == serverList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å°†æ•°æ®åºåˆ—åŒ–åï¼Œé€šè¿‡<code>OkHttp</code>å‘é€æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€šè¿‡OkHttpå‘é€æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void doRegister(final String json, final String url, final String type) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasLength(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error accessToken is null, please check the config : {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Headers headers = new Headers.Builder().add(Constants.X_ACCESS_TOKEN, accessToken).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result = OkHttpTools.getInstance().post(url, json, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.equals(SUCCESS, result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;{} client register success: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ï¼Œå®¢æˆ·ç«¯é€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œå…ƒæ•°æ®çš„é€»è¾‘å°±åˆ†æå®Œäº†ã€‚å°ç»“ä¸€ä¸‹ï¼šé€šè¿‡è¯»å–è‡ªå®šä¹‰çš„æ³¨è§£ä¿¡æ¯æ„é€ å…ƒæ•°æ®ï¼Œå°†æ•°æ®å‘åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œç„¶åä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ•°æ®ï¼Œå°†æ¶ˆè´¹è€…æ”¾åˆ°çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œï¼Œæœ€ç»ˆé€šè¿‡å‘é€<code>http</code>è¯·æ±‚åˆ°<code>admin</code>ã€‚</p><p>å†æ¥çœ‹çœ‹ <code>URI</code> æ•°æ®çš„å¤„ç†</p><ul><li>ShenyuClientURIExecutorSubscriber#executor()</li></ul><p>ä¸»è¦é€»è¾‘æ˜¯éå†URIæ•°æ®é›†åˆï¼Œé€šè¿‡<code>persistURI()</code>æ–¹æ³•å®ç°æ•°æ®æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientURIExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; //æ•°æ®ç±»å‹æ˜¯URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨å†ŒURIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (URIRegisterDTO uriRegisterDTO : dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Stopwatch stopwatch = Stopwatch.createStarted();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (Socket ignored = new Socket(uriRegisterDTO.getHost(), uriRegisterDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long sleepTime = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // maybe the port is delay exposed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 5) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;host:{}, port:{} connection failed, will retry&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                uriRegisterDTO.getHost(), uriRegisterDTO.getPort());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If the connection fails for a long time, Increase sleep time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 180) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sleepTime = 10000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TimeUnit.MILLISECONDS.sleep(sleepTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ex.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ·»åŠ hookï¼Œä¼˜é›…åœæ­¢å®¢æˆ·ç«¯ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.delayOtherHooks();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistURI(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»£ç ä¸­çš„<code>while(true)</code>å¾ªç¯æ˜¯ä¸ºäº†ä¿è¯å®¢æˆ·ç«¯å·²ç»æˆåŠŸå¯åŠ¨äº†ï¼Œé€šè¿‡<code>host</code>å’Œ<code>port</code>å¯ä»¥è¿æ¥ä¸Šã€‚</p><p>åé¢çš„é€»è¾‘æ˜¯ï¼šæ·»åŠ <code>hook</code>å‡½æ•°ï¼Œç”¨äºä¼˜é›…åœæ­¢å®¢æˆ·ç«¯ ã€‚</p><p>é€šè¿‡<code>persistURI()</code>æ–¹æ³•å®ç°æ•°æ®æ³¨å†Œã€‚æ•´ä¸ªé€»è¾‘ä¹Ÿåœ¨å‰é¢åˆ†æè¿‡äº†ï¼Œæœ€ç»ˆå°±æ˜¯é€šè¿‡<code>OkHttp</code>å®¢æˆ·ç«¯å‘<code>shenyu-admin</code>å‘èµ·<code>http</code>ï¼Œé€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œ<code>URI</code>ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œå°±å°†å®¢æˆ·ç«¯çš„æ³¨å†Œé€»è¾‘åˆ†æå®Œäº†ï¼Œå°†æ„å»ºçš„å…ƒæ•°æ®å’ŒURIæ•°æ®å‘é€åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œå†ä»ä¸­æ¶ˆè´¹ï¼Œè¯»å–æ•°æ®ï¼Œé€šè¿‡<code>http</code>å‘<code>admin</code>å‘é€æ•°æ®ã€‚</p><p>å®¢æˆ·ç«¯<code>å…ƒæ•°æ®</code>å’Œ<code>URI</code>æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œæˆäº†ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/client-metadata-uri-register-zh-a7094099a530101dee93b172a1bc0254.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-æœåŠ¡ç«¯æ³¨å†Œæµç¨‹"></a>3. æœåŠ¡ç«¯æ³¨å†Œæµç¨‹<a class="hash-link" href="#3-æœåŠ¡ç«¯æ³¨å†Œæµç¨‹" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-æ³¨å†Œæ¥å£shenyuclienthttpregistrycontroller"></a>3.1 æ³¨å†Œæ¥å£ShenyuClientHttpRegistryController<a class="hash-link" href="#31-æ³¨å†Œæ¥å£shenyuclienthttpregistrycontroller" title="Direct link to heading">#</a></h4><p>ä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼ŒæœåŠ¡ç«¯æä¾›äº†æ³¨å†Œçš„ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li><code>/shenyu-client/register-metadata</code>ï¼šæœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†Œå…ƒæ•°æ®ã€‚</li><li><code>/shenyu-client/register-uri</code>ï¼š    æœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†ŒURIã€‚</li></ul><p>è¿™ä¸¤ä¸ªæ¥å£ä½äº<code>ShenyuClientHttpRegistryController</code>ä¸­ï¼Œå®ƒå®ç°äº†<code>ShenyuClientServerRegisterRepository</code>æ¥å£ï¼Œæ˜¯æœåŠ¡ç«¯æ³¨å†Œçš„å®ç°ç±»ã€‚å®ƒç”¨<code>@Join</code>æ ‡è®°ï¼Œè¡¨ç¤ºé€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// shenuyuå®¢æˆ·ç«¯æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/shenyu-client&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientHttpRegistryController implements ShenyuClientServerRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuClientServerRegisterPublisher publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuClientServerRegisterPublisher publisher, final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.publisher = publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-metadata&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerMetadata(@RequestBody final MetaDataRegisterDTO metaDataRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-uri&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(@RequestBody final URIRegisterDTO uriRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸¤ä¸ªæ³¨å†Œæ¥å£è·å–åˆ°æ•°æ®å¥½ï¼Œå°±è°ƒç”¨äº†<code>publisher.publish()</code>æ–¹æ³•ï¼ŒæŠŠæ•°æ®å‘å¸ƒåˆ°<code>Disruptor</code>é˜Ÿåˆ—ä¸­ã€‚</p><ul><li><code>ShenyuClientServerRegisterRepository</code>æ¥å£</li></ul><p><code>ShenyuClientServerRegisterRepository</code>æ¥å£æ˜¯æœåŠ¡æ³¨å†Œæ¥å£ï¼Œå®ƒæœ‰äº”ä¸ªå®ç°ç±»ï¼Œè¡¨ç¤ºæœ‰äº”ç§æ³¨å†Œæ–¹å¼ï¼š</p><ul><li><code>ConsulClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>å®ç°æ³¨å†Œ;</li><li><code>EtcdClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>å®ç°æ³¨å†Œï¼›</li><li><code>NacosClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Nacos</code>å®ç°æ³¨å†Œï¼›</li><li><code>ShenyuClientHttpRegistryController</code>ï¼šé€šè¿‡<code>Http</code>å®ç°æ³¨å†Œï¼›</li><li><code>ZookeeperClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Zookeeper</code>å®ç°æ³¨å†Œã€‚</li></ul><p>å…·ä½“ç”¨å“ªä¸€ç§æ–¹å¼ï¼Œæ˜¯é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šçš„ï¼Œç„¶åé€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½ã€‚</p><p>åœ¨<code>shenyu-admin</code>ä¸­çš„<code>application.yml</code>æ–‡ä»¶ä¸­é…ç½®æ³¨å†Œæ–¹å¼ï¼Œ<code>registerType</code>æŒ‡å®šæ³¨å†Œç±»å‹ï¼Œå½“ç”¨<code>http</code>è¿›è¡Œæ³¨å†Œæ—¶ï¼Œ<code>serverLists</code>ä¸éœ€è¦å¡«å†™ï¼Œæ›´å¤šé…ç½®è¯´æ˜å¯ä»¥å‚è€ƒå®˜ç½‘  <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverLists</span><span class="token punctuation" style="color:#393A34">:</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>RegisterCenterConfiguration åŠ è½½é…ç½®</li></ul><p>åœ¨å¼•å…¥ç›¸å…³ä¾èµ–å’Œå±æ€§é…ç½®åï¼Œå¯åŠ¨<code>shenyu-admin</code>æ—¶ï¼Œä¼šå…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå’Œæ³¨å†Œä¸­å¿ƒç›¸å…³çš„é…ç½®æ–‡ä»¶ç±»æ˜¯<code>RegisterCenterConfiguration</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨å†Œä¸­å¿ƒé…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterCenterConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¯»å–é…ç½®å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åˆ›å»ºShenyuServerRegisterRepositoryï¼Œç”¨äºæœåŠ¡ç«¯æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuServerRegisterRepository shenyuServerRegisterRepository(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig, final List&lt;ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.ä»é…ç½®å±æ€§ä¸­è·å–æ³¨å†Œç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String registerType = shenyuRegisterCenterConfig.getRegisterType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.é€šè¿‡æ³¨å†Œç±»å‹ï¼Œä»¥SPIçš„æ–¹æ³•åŠ è½½å®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuClientServerRegisterRepository registerRepository = ExtensionLoader.getExtensionLoader(ShenyuClientServerRegisterRepository.class).getJoin(registerType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.è·å–publisherï¼Œå‘Disruptoré˜Ÿåˆ—ä¸­å†™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientServerDisruptorPublisher publisher = RegisterClientServerDisruptorPublisher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.æ³¨å†ŒServiceï¼Œ rpcType -&gt; registerService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuClientRegisterService&gt; registerServiceMap = shenyuClientRegisterService.stream().collect(Collectors.toMap(ShenyuClientRegisterService::rpcType, e -&gt; e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5.äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(registerServiceMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.æ³¨å†Œçš„åˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRepository.init(publisher, shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerRepository;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨é…ç½®ç±»ä¸­ç”Ÿæˆäº†ä¸¤ä¸ª<code>bean</code>ï¼š</p><ul><li><p><code>shenyuRegisterCenterConfig</code>ï¼šè¯»å–å±æ€§é…ç½®ï¼›</p></li><li><p><code>shenyuClientServerRegisterRepository</code>ï¼šç”¨äºæœåŠ¡ç«¯æ³¨å†Œã€‚</p></li></ul><p>åœ¨åˆ›å»º<code>shenyuClientServerRegisterRepository</code>çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè¿›è¡Œäº†ä¸€ç³»åˆ—çš„å‡†å¤‡å·¥ä½œï¼š</p><ul><li>1.ä»é…ç½®å±æ€§ä¸­è·å–æ³¨å†Œç±»å‹ã€‚</li><li>2.é€šè¿‡æ³¨å†Œç±»å‹ï¼Œä»¥<code>SPI</code>çš„æ–¹æ³•åŠ è½½å®ç°ç±»ï¼šæ¯”å¦‚æŒ‡å®šçš„ç±»å‹æ˜¯<code>http</code>ï¼Œå°±ä¼šåŠ è½½<code>ShenyuClientHttpRegistryController</code>ã€‚</li><li>3.è·å–<code>publisher</code>ï¼Œå‘<code>Disruptor</code>é˜Ÿåˆ—ä¸­å†™æ•°æ®ã€‚</li><li>4.æ³¨å†Œ<code>Service</code>ï¼Œ <code>rpcType -&gt; registerService</code>ï¼šè·å–æ³¨å†Œçš„<code>Service</code>ï¼Œæ¯ç§<code>rpc</code>éƒ½æœ‰å¯¹åº”çš„<code>Service</code>ã€‚æœ¬æ–‡çš„å®¢æˆ·ç«¯æ„å»ºæ˜¯é€šè¿‡<code>springboot</code>ï¼Œå±äº<code>http</code>ç±»å‹ï¼Œè¿˜æœ‰å…¶ä»–å®¢æˆ·ç«¯ç±»å‹ï¼š<code>dubbo</code>ï¼Œ<code>Spring Cloud</code>ï¼Œ<code>gRPC</code>ç­‰ã€‚</li><li>5.äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œï¼šæ·»åŠ æœåŠ¡ç«¯å…ƒæ•°æ®å’Œ<code>URI</code>è®¢é˜…å™¨ï¼Œå¤„ç†æ•°æ®ã€‚å¹¶ä¸”å¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚</li><li>6.æ³¨å†Œçš„åˆå§‹åŒ–æ“ä½œï¼š<code>http</code>ç±»å‹çš„æ³¨å†Œåˆå§‹åŒ–æ“ä½œå°±æ˜¯ä¿å­˜<code>publisher</code>ã€‚</li></ul><ul><li>RegisterServerDisruptorPublisher#publish()</li></ul><p>æœåŠ¡ç«¯å‘<code>Disruptor</code>é˜Ÿåˆ—å†™å…¥æ•°æ®çš„å‘å¸ƒè€… ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼æ„å»ºã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterClientServerDisruptorPublisher implements ShenyuClientServerRegisterPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ç§æœ‰å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final RegisterClientServerDisruptorPublisher INSTANCE = new RegisterClientServerDisruptorPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;Collection&lt;DataTypeParent&gt;&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å…¬å¼€é™æ€æ–¹æ³•è·å–å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static RegisterServerDisruptorPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œï¼Œæ·»åŠ æœåŠ¡ç«¯å…ƒæ•°æ®å’ŒURIè®¢é˜…å™¨ï¼Œå¤„ç†æ•°æ®ã€‚å¹¶ä¸”å¯åŠ¨Disruptoré˜Ÿåˆ—ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final Map&lt;String, ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æœåŠ¡ç«¯æ³¨å†Œå·¥å‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerExecutorFactory factory = new RegisterServerExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ·»åŠ URIæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new URIRegisterExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ·»åŠ å…ƒæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new MetadataExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¯åŠ¨Disruptoré˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(Collections.singleton(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰¹é‡å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final Collection&lt;? extends DataTypeParent&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(dataList.stream().map(DataTypeParent.class::cast).collect(Collectors.toList()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.getProvider().shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é…ç½®æ–‡ä»¶çš„åŠ è½½ï¼Œå¯çœ‹ä½œæ˜¯æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯åˆå§‹åŒ–æµç¨‹ï¼Œç”¨å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-register-init-zh-f459729f048f19f89b7eaa023ae4b4e8.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-æ¶ˆè´¹æ•°æ®queueconsumer"></a>3.2 æ¶ˆè´¹æ•°æ®QueueConsumer<a class="hash-link" href="#32-æ¶ˆè´¹æ•°æ®queueconsumer" title="Direct link to heading">#</a></h4><p>åœ¨å‰é¢åˆ†æäº†å®¢æˆ·ç«¯<code>disruptor</code>é˜Ÿåˆ—æ¶ˆè´¹æ•°æ®çš„è¿‡ã€‚æœåŠ¡ç«¯ä¹Ÿæ˜¯ä¸€æ ·çš„é€»è¾‘ï¼Œåªæ˜¯å…¶ä¸­æ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œè€…å˜äº†ã€‚</p><p><code>QueueConsumer</code>æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå®ç°äº†<code>WorkHandler</code>æ¥å£ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹åœ¨<code>providerManage.startup()</code>é€»è¾‘ä¸­ã€‚<code>WorkHandler</code>æ¥å£æ˜¯<code>disruptor</code>çš„æ•°æ®æ¶ˆè´¹æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯<code>onEvent()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumer</code>é‡å†™äº†<code>onEvent()</code>æ–¹æ³•ï¼Œä¸»è¦é€»è¾‘æ˜¯ç”Ÿæˆæ¶ˆè´¹ä»»åŠ¡ï¼Œç„¶ååœ¨çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é˜Ÿåˆ—æ¶ˆè´¹è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®äº‹ä»¶ç±»å‹è·å–ç›¸åº”çš„çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡å·¥å‚åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¿å­˜æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ”¾åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code>æ˜¯åœ¨çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå…·ä½“çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼š</p><ul><li><code>RegisterClientConsumerExecutor</code>ï¼šå®¢æˆ·ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼›</li><li><code>RegisterServerConsumerExecutor</code>ï¼šæœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ã€‚</li></ul><p>é¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯ä»»åŠ¡ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ä»»åŠ¡ã€‚</p><ul><li><code>RegisterServerConsumerExecutor#run()</code></li></ul><p><code>RegisterServerConsumerExecutor</code>æ˜¯æœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼Œå®ƒé€šè¿‡<code>QueueConsumerExecutor</code>é—´æ¥å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå¹¶é‡å†™äº†<code>run()</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterServerConsumerExecutor extends QueueConsumerExecutor&lt;Collection&lt;DataTypeParent&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–ä»disruptoré˜Ÿåˆ—ä¸­æ‹¿åˆ°çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;DataTypeParent&gt; results = getData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(this::isValidData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ ¹æ®ç±»å‹æ‰§è¡Œæ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectExecutor(results).executor(results);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ ¹æ®ç±»å‹è·å–è®¢é˜…è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ExecutorSubscriber&lt;DataTypeParent&gt; selectExecutor(final Collection&lt;DataTypeParent&gt; list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Optional&lt;DataTypeParent&gt; first = list.stream().findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return subscribers.get(first.orElseThrow(() -&gt; new RuntimeException(&quot;the data type is not found&quot;)).getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>æ‰§è¡Œå™¨è®¢é˜…è€…åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯å¤„ç†å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ˜¯å¤„ç†<code>URI</code>ã€‚åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥ä¸€å…±æ˜¯å››ä¸ªã€‚</p><p><img src="/zh/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><ul><li>MetadataExecutorSubscriber#executor()</li></ul><p>å¦‚æœæ˜¯æ³¨å†Œå…ƒæ•°æ®ï¼Œåˆ™é€šè¿‡<code>MetadataExecutorSubscriber#executor()</code>å®ç°ï¼šæ ¹æ®ç±»å‹è·å–æ³¨å†Œ<code>Service</code>ï¼Œè°ƒç”¨<code>register()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class MetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA;  // å…ƒæ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†å…ƒæ•°æ®åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataRegisterDTOList.forEach(meta -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(this.shenyuClientRegisterService.get(meta.getRpcType())) // æ ¹æ®ç±»å‹è·å–æ³¨å†ŒService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(shenyuClientRegisterService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¯¹å…ƒæ•°æ®è¿›è¡Œæ³¨å†Œï¼ŒåŠ é”ç¡®ä¿é¡ºåºæ‰§è¡Œï¼Œé˜²æ­¢å¹¶å‘é”™è¯¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            shenyuClientRegisterService.register(meta);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>URIRegisterExecutorSubscriber#executor()</li></ul><p>å¦‚æœæ˜¯æ³¨å†Œå…ƒæ•°æ®ï¼Œåˆ™é€šè¿‡<code>URIRegisterExecutorSubscriber#executor()</code>å®ç°ï¼šæ„å»º<code>URI</code>æ•°æ®ï¼Œæ ¹æ®æ³¨å†Œç±»å‹æŸ¥æ‰¾<code>Serviceï¼Œ</code>é€šè¿‡<code>registerURI</code>æ–¹æ³•å®ç°æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class URIRegisterExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; // URIæ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®rpcè°ƒç”¨ç±»å‹èšé›†æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; groupByRpcType = dataList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(data -&gt; StringUtils.isNotBlank(data.getRpcType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.groupingBy(URIRegisterDTO::getRpcType));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, List&lt;URIRegisterDTO&gt;&gt; entry : groupByRpcType.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String rpcType = entry.getKey();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®ç±»å‹æŸ¥æ‰¾Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(shenyuClientRegisterService.get(rpcType))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final List&lt;URIRegisterDTO&gt; list = entry.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // æ„å»ºURIæ•°æ®ç±»å‹ï¼Œé€šè¿‡registerURIæ–¹æ³•å®ç°æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(list);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterService#register()</li></ul><p><code>ShenyuClientRegisterService</code>æ˜¯æ³¨å†Œæ–¹æ³•æ¥å£ï¼Œå®ƒæœ‰å¤šä¸ªå®ç°ç±»ï¼š</p><p><img src="/zh/assets/images/client-register-service-949e3110cb57db2f250dafdc41446eb4.png"></p><ul><li><code>AbstractContextPathRegisterService</code>ï¼šæŠ½è±¡ç±»ï¼Œå¤„ç†éƒ¨åˆ†å…¬å…±é€»è¾‘ï¼›</li><li><code>AbstractShenyuClientRegisterServiceImpl</code>ï¼šï¼šæŠ½è±¡ç±»ï¼Œå¤„ç†éƒ¨åˆ†å…¬å…±é€»è¾‘ï¼›</li><li><code>ShenyuClientRegisterDivideServiceImpl</code>ï¼š<code>divide</code>ç±»ï¼Œå¤„ç†<code>http</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterDubboServiceImpl</code>ï¼š<code>dubbo</code>ç±»ï¼Œå¤„ç†<code>dubbo</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterGrpcServiceImpl</code>ï¼š<code>gRPC</code>ç±»ï¼Œå¤„ç†<code>gRPC</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterMotanServiceImpl</code>ï¼š<code>Motan</code>ç±»ï¼Œå¤„ç†<code>Motan</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterSofaServiceImpl</code>ï¼š<code>Sofa</code>ç±»ï¼Œå¤„ç†<code>Sofa</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterSpringCloudServiceImpl</code>ï¼š<code>SpringCloud</code>ç±»ï¼Œå¤„ç†<code>SpringCloud</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterTarsServiceImpl</code>ï¼š<code>Tars</code>ç±»ï¼Œå¤„ç†<code>Tars</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterWebSocketServiceImpl</code>ï¼š<code>Websocket</code>ç±»ï¼Œå¤„ç†<code>Websocket</code>æ³¨å†Œç±»å‹ï¼›</li></ul><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¯ç§å¾®æœåŠ¡éƒ½æœ‰å¯¹åº”çš„æ³¨å†Œå®ç°ç±»ï¼Œæœ¬æ–‡çš„æºç åˆ†ææ˜¯ ä»¥å®˜æ–¹æä¾›çš„ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> ä¸ºä¾‹ï¼Œæ˜¯å±<code>http</code>æ³¨å†Œç±»å‹ï¼Œæ‰€ä»¥å…ƒæ•°æ®å’ŒURIæ•°æ®çš„æ³¨å†Œå®ç°ç±»æ˜¯ <code>ShenyuClientRegisterDivideServiceImpl</code>ï¼š</p><ul><li>register(): æ³¨å†Œå…ƒæ•°æ®</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.æ³¨å†Œé€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.æ³¨å†Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.æ³¨å†Œå…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.æ³¨å†ŒcontextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ•´ä¸ªæ³¨å†Œé€»è¾‘å¯ä»¥åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼š</p><ul><li>1.æ³¨å†Œé€‰æ‹©å™¨ä¿¡æ¯</li><li>2.æ³¨å†Œè§„åˆ™ä¿¡æ¯</li><li>3.æ³¨å†Œå…ƒæ•°æ®ä¿¡æ¯</li><li>4.æ³¨å†Œ<code>contextPath</code></li></ul><p>åœ¨<code>admin</code>è¿™ä¸€ä¾§é€šè¿‡å®¢æˆ·ç«¯çš„å…ƒæ•°æ®ä¿¡æ¯éœ€è¦æ„å»ºé€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œ<code>ContextPath</code>ã€‚å…·ä½“çš„æ³¨å†Œè¿‡ç¨‹å’Œç»†èŠ‚å¤„ç†è·Ÿ<code>rpc</code>ç±»å‹æœ‰å…³ã€‚æˆ‘ä»¬å°±ä¸å†ç»§ç»­å‘ä¸‹è¿½è¸ªäº†ï¼Œå¯¹äºæ³¨å†Œä¸­å¿ƒçš„é€»è¾‘åˆ†æï¼Œè·Ÿè¸ªåˆ°è¿™é‡Œå°±å¤Ÿäº†ã€‚</p><p>æœåŠ¡ç«¯å…ƒæ•°æ®æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œäº†ï¼Œæµç¨‹å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-metadata-register-zh-1b1d9d30b0f3c8fedc59d9a82ab24896.png"></p><ul><li>registerURI(): æ³¨å†Œ<code>URI</code>æ•°æ®</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯¹åº”çš„é€‰æ‹©å™¨æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†é€‰æ‹©å™¨ä¸­çš„handlerä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®åº“ä¸­çš„è®°å½•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>admin</code>æ‹¿åˆ°<code>URI</code>æ•°æ®åï¼Œä¸»è¦æ˜¯æ›´æ–°é€‰æ‹©å™¨ä¸­çš„<code>handler</code>ä¿¡æ¯ï¼Œç„¶åå†™å…¥åˆ°æ•°æ®åº“ï¼Œæœ€åå‘å¸ƒäº‹ä»¶é€šçŸ¥ç½‘å…³ã€‚é€šçŸ¥ç½‘å…³çš„é€»è¾‘æ˜¯ç”±æ•°æ®åŒæ­¥æ“ä½œå®Œæˆï¼Œè¿™åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å·²ç»åˆ†æè¿‡äº†ï¼Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>æœåŠ¡ç«¯<code>URI</code>æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œæˆäº†ï¼Œç”¨å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-uri-register-zh-4d956ca81d252f021f22e8a28d15bf2d.png"></p><p>è‡³æ­¤ï¼ŒæœåŠ¡ç«¯æ³¨å†Œæµç¨‹ä¹Ÿå°±åˆ†æå®Œäº†ï¼Œä¸»è¦é€šè¿‡å¯¹å¤–æä¾›çš„æ¥å£ï¼Œæ¥å—å®¢æˆ·ç«¯çš„æ³¨å†Œä¿¡æ¯ï¼Œç„¶åå†™å…¥åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œå†ä»ä¸­æ¶ˆè´¹æ•°æ®ï¼Œæ ¹æ®æ¥æ”¶åˆ°çš„å…ƒæ•°æ®å’Œ<code>URI</code>æ•°æ®æ›´æ–°<code>admin</code>çš„é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œé€‰æ‹©å™¨çš„<code>handler</code>ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-æ€»ç»“"></a>4. æ€»ç»“<a class="hash-link" href="#4-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡ä¸»è¦å¯¹<code>Apache ShenYu</code>ç½‘å…³ä¸­çš„<code>httpæ³¨å†Œ</code>æ¨¡å—è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼Œå½’çº³å¦‚ä¸‹ï¼š</p><ul><li>æ³¨å†Œä¸­å¿ƒæ˜¯ä¸ºäº†å°†å®¢æˆ·ç«¯ä¿¡æ¯æ³¨å†Œåˆ°<code>admin</code>ï¼Œæ–¹ä¾¿æµé‡ç­›é€‰ï¼›</li><li><code>http</code>æ³¨å†Œæ˜¯å°†å®¢æˆ·ç«¯å…ƒæ•°æ®ä¿¡æ¯å’Œ<code>URI</code>ä¿¡æ¯æ³¨å†Œåˆ°<code>admin</code>ï¼›</li><li><code>http</code>æœåŠ¡çš„æ¥å…¥é€šè¿‡æ³¨è§£<code>@ShenyuSpringMvcClient</code>æ ‡è¯†ï¼›</li><li>æ³¨å†Œä¿¡æ¯çš„æ„å»ºä¸»è¦é€šè¿‡<code>Spring</code>åº”ç”¨ç›‘å¬å™¨<code>ApplicationListener</code>ï¼›</li><li>æ³¨å†Œç±»å‹çš„åŠ è½½é€šè¿‡<code>SPI</code>å®Œæˆï¼›</li><li>å¼•å…¥<code>Disruptor</code>é˜Ÿåˆ—æ˜¯ä¸ºäº†æ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œä»¥åŠæ•°æ®ç¼“å†²ã€‚</li><li>æ³¨å†Œä¸­å¿ƒçš„å®ç°é‡‡ç”¨äº†é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä½¿ç”¨æ¨¡æ¿æ–¹æ³•ã€å•ä¾‹ã€è§‚å¯Ÿè€…ç­‰è®¾è®¡æ¨¡å¼ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/http">http</a><a class="margin-horiz--sm" href="/zh/blog/tags/register-center">register center</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync">Nacosæ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.462Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>Etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>Nacos</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-å…³äºnacos"></a>1. å…³äºNacos<a class="hash-link" href="#1-å…³äºnacos" title="Direct link to heading">#</a></h3><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer"><code>Nacos</code></a> å¹³å°ç”¨äºåŠ¨æ€æœåŠ¡å‘ç°ï¼Œä»¥åŠé…ç½®å’ŒæœåŠ¡ç®¡ç†ã€‚ <code>Shenyu</code>ç½‘å…³å¯é€‰æ‹©ä½¿ç”¨<code>Nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-adminæ•°æ®åŒæ­¥"></a>2. Adminæ•°æ®åŒæ­¥<a class="hash-link" href="#2-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªå®é™…æ¡ˆä¾‹è¿›è¡Œæºç è¿½è¸ªï¼Œæ¯”å¦‚åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼š</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶æ•°æ®"></a>2.1 æ¥æ”¶æ•°æ®<a class="hash-link" href="#21-æ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorController.updateSelector()</li></ul><p>è¿›å…¥<code>SelectorController</code>ç±»ä¸­çš„<code>updateSelector()</code>æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ•°æ®çš„æ ¡éªŒï¼Œæ·»åŠ æˆ–æ›´æ–°æ•°æ®ï¼Œè¿”å›ç»“æœä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®å½“å‰é€‰æ‹©å™¨æ•°æ®id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæˆ–æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿”å›ç»“æœä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å¤„ç†æ•°æ®"></a>2.2 å¤„ç†æ•°æ®<a class="hash-link" href="#22-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>åœ¨<code>SelectorServiceImpl</code>ç±»ä¸­é€šè¿‡<code>createOrUpdate()</code>æ–¹æ³•å®Œæˆæ•°æ®çš„è½¬æ¢ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œæ›´æ–°<code>upstream</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è´Ÿè´£äº‹ä»¶å‘å¸ƒçš„eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ•°æ® DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­æ˜¯æ·»åŠ è¿˜æ˜¯æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨ä¸­çš„æ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æƒé™æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®ï¼Œå…ˆåˆ é™¤å†æ–°å¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>Service</code>ç±»å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼Œå³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸æ·±å…¥è¿½è¸ªäº†ã€‚å…³äºæ›´æ–°<code>upstream</code>æ“ä½œï¼Œæ”¾åˆ°åé¢å¯¹åº”çš„ç« èŠ‚ä¸­è¿›è¡Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨å‘å¸ƒäº‹ä»¶çš„æ“ä½œï¼Œå®ƒä¼šæ‰§è¡Œæ•°æ®åŒæ­¥ã€‚</p><p><code>publishEvent()</code>æ–¹æ³•çš„é€»è¾‘æ˜¯ï¼šæ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶ï¼Œæ„å»ºæ¡ä»¶æ•°æ®ï¼Œå‘å¸ƒå˜æ›´æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒå˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‘å¸ƒå˜æ›´æ•°æ®é€šè¿‡<code>eventPublisher.publishEvent()</code>å®Œæˆï¼Œè¿™ä¸ª<code>eventPublisher</code>å¯¹è±¡æ˜¯ä¸€ä¸ª<code>ApplicationEventPublisher</code>ç±»ï¼Œè¿™ä¸ªç±»çš„å…¨é™å®šåæ˜¯<code>org.springframework.context.ApplicationEventPublisher</code>ã€‚çœ‹åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬çŸ¥é“äº†å‘å¸ƒæ•°æ®æ˜¯é€šè¿‡<code>Spring</code>ç›¸å…³çš„åŠŸèƒ½æ¥å®Œæˆçš„ã€‚</p><blockquote><p>å…³äº<code>ApplicationEventPublisher</code>ï¼š</p><p>å½“æœ‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…è°ƒç”¨ <code>ApplicationEventPublisher</code> çš„ <code>publishEvent</code> æ–¹æ³•å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œ<code>Spring</code>å®¹å™¨å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onApplicationEvent</code> æ–¹æ³•æŠŠäº‹ä»¶å¯¹è±¡ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚è°ƒç”¨ <code>publishEvent</code>æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å®ç°æ¥å£ç”±å®¹å™¨æ³¨å…¥ <code>ApplicationEventPublisher</code> å¯¹è±¡ç„¶åè°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨å®¹å™¨çš„æ–¹æ³•ï¼Œä¸¤ç§æ–¹æ³•å‘å¸ƒäº‹ä»¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><ul><li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒäº‹ä»¶ï¼›</li><li><code>ApplicationEvent</code>ï¼š<code>Spring</code> äº‹ä»¶ï¼Œè®°å½•äº‹ä»¶æºã€æ—¶é—´å’Œæ•°æ®ï¼›</li><li><code>ApplicationListener</code>ï¼šäº‹ä»¶ç›‘å¬è€…ï¼Œè§‚å¯Ÿè€…ï¼›</li></ul></blockquote><p>åœ¨<code>Spring</code>çš„äº‹ä»¶å‘å¸ƒæœºåˆ¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œ</p><p>ä¸€ä¸ªæ˜¯å‘å¸ƒäº‹ä»¶çš„<code>ApplicationEventPublisher</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡æ„é€ å™¨æ³¨å…¥äº†ä¸€ä¸ª<code>eventPublisher</code>ã€‚</p><p>å¦ä¸€ä¸ªå¯¹è±¡æ˜¯<code>ApplicationEvent</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEvent</code>ç»§æ‰¿äº†å®ƒï¼Œè¡¨ç¤ºäº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åä¸€ä¸ªæ˜¯ <code>ApplicationListener</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEventDispatcher</code>ç±»å®ç°äº†è¯¥æ¥å£ï¼Œä½œä¸ºäº‹ä»¶çš„ç›‘å¬è€…ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-åˆ†å‘æ•°æ®"></a>2.3 åˆ†å‘æ•°æ®<a class="hash-link" href="#23-åˆ†å‘æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>å½“äº‹ä»¶å‘å¸ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿›å…¥åˆ°<code>DataChangedEventDispatcher</code>ç±»ä¸­çš„<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨<code>onApplicationEvent</code>æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œåˆ¤æ–­æ˜¯å“ªç§æ•°æ®ç±»å‹ï¼Œäº¤ç»™ç›¸åº”çš„æ•°æ®ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚</p><p><code>ShenYu</code>å°†æ‰€æœ‰æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æ˜¯äº”ç§ï¼šè®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯å’Œå…ƒæ•°æ®ã€‚</p><p>è¿™é‡Œçš„æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆ<code>DataChangedListener</code>ï¼‰ï¼Œå°±æ˜¯æ•°æ®åŒæ­¥ç­–ç•¥çš„æŠ½è±¡ï¼Œå®ƒçš„å…·ä½“å®ç°æœ‰ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>è¿™å‡ ä¸ªå®ç°ç±»å°±æ˜¯å½“å‰<code>ShenYu</code>æ”¯æŒçš„åŒæ­¥ç­–ç•¥ï¼š</p><ul><li><code>WebsocketDataChangedListener</code>ï¼šåŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ZookeeperDataChangedListener</code>ï¼šåŸºäº<code>zookeeper</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ConsulDataChangedListener</code>ï¼šåŸºäº<code>consul</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>EtcdDataDataChangedListener</code>ï¼šåŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>HttpLongPollingDataChangedListener</code>ï¼šåŸºäº<code>httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>NacosDataChangedListener</code>ï¼šåŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼›</li></ul><p>æ—¢ç„¶æœ‰è¿™ä¹ˆå¤šç§å®ç°ç­–ç•¥ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>å› ä¸ºæœ¬æ–‡æ˜¯åŸºäº<code>Nacos</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æï¼Œæ‰€ä»¥è¿™é‡Œä»¥<code>NacosDataChangedListener</code>ä¸ºä¾‹ï¼Œåˆ†æå®ƒæ˜¯å¦‚ä½•è¢«åŠ è½½å¹¶å®ç°çš„ã€‚</p><p>é€šè¿‡æŸ¥çœ‹å¯¹<code>NacosDataChangedListener</code>ç±»çš„è°ƒç”¨ï¼Œå¯ä»¥å‘ç°ï¼Œå®ƒæ˜¯åœ¨<code>DataSyncConfiguration</code>ç±»è¿›è¡Œé…ç½®çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Nacos listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(NacosConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class NacosListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Data changed listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener nacosDataChangedListener(final ConfigService configService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataChangedListener(configService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Nacos data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the nacos data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public NacosDataInit nacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataInit(configService, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªé…ç½®ç±»æ˜¯é€šè¿‡<code>SpringBoot</code>æ¡ä»¶è£…é…ç±»å®ç°çš„ã€‚åœ¨<code>NacosListener</code>ç±»ä¸Šé¢æœ‰å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p><code>@Configuration</code>ï¼šé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ä¸Šä¸‹æ–‡ï¼›</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>ï¼šå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šé‡‡ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(NacosConfiguration.class)</code>ï¼šå¯¼å…¥å¦ä¸€ä¸ªé…ç½®ç±»<code>NacosConfiguration</code>ï¼Œ<code>NacosConfiguration</code>æä¾›äº†ä¸€ä¸ªæ–¹æ³•<code>ConfigService nacosConfigService(final NacosProperties nacosProp)</code>ï¼Œå°†Nacoså±æ€§è½¬æ¢ä¸º<code>ConfigService</code>ç±»å‹çš„beanï¼Œè€ŒNacoså±æ€§æ˜¯é€šè¿‡<code>@EnableConfigurationProperties(NacosProperties.class)</code> å¯¼å…¥çš„ã€‚æˆ‘ä»¬å…ˆçœ‹ConfigServiceç±»å‹çš„beanå®šä¹‰ã€‚å†åˆ†æå±æ€§é…ç½®ç±»å’Œå¯¹åº”çš„å±æ€§é…ç½®æ–‡ä»¶ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(NacosProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register configService in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosProp the nacos configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ConfigService {@linkplain ConfigService}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(ConfigService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosProperties nacosProp) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosProp.getAcm() != null &amp;&amp; nacosProp.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use aliyun ACM service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosProp.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use subaccount ACM administrative authority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosProp.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosProp.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosProp.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getUsername())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosProp.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getPassword())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosProp.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦åˆ†æˆä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ ¹æ®æ˜¯å¦ä½¿ç”¨äº†aliyunçš„ACMæœåŠ¡ï¼Œä»NacosPropertiesä¸­è·å–ä¸åŒçš„nacosè·¯å¾„å’Œé‰´æƒä¿¡æ¯ï¼Œç¬¬äºŒæ­¥æ ¹æ®è·å–åˆ°çš„è¿™äº›å±æ€§ï¼Œä½¿ç”¨Nacoså®˜æ–¹çš„å·¥å‚æ–¹æ³•ï¼Œä½¿ç”¨åå°„çš„æ–¹å¼ï¼Œåˆ›å»ºconfigServiceã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åˆ†æä¸€ä¸‹Nacosçš„å±æ€§é…ç½®å’Œå¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private NacosACMProperties acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUrl() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param url url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUrl(final String url) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.url = url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param username username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(final String username) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param password password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPassword(final String password) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosACMProperties getAcm() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param acm acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAcm(final NacosACMProperties acm) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.acm = acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class NacosACMProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean isEnabled() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param enabled enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEnabled(final boolean enabled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.enabled = enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getEndpoint() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param endpoint endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEndpoint(final String endpoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.endpoint = endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getAccessKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param accessKey accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setAccessKey(final String accessKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.accessKey = accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getSecretKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param secretKey secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setSecretKey(final String secretKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.secretKey = secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†<code>shenyu.sync.nacos.url</code>å±æ€§æ—¶ï¼Œå°†é‡‡ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ­¤æ—¶é…ç½®ç±»<code>NacosListener</code>ä¼šç”Ÿæ•ˆï¼Œå¹¶ç”Ÿæˆ<code>NacosDataChangedListener</code>å’Œ<code>NacosDataInit</code>ç±»å‹çš„beanã€‚</p><ul><li>ç”Ÿæˆ<code>NacosDataChangedListener</code>ç±»å‹çš„beanï¼Œ<code>nacosDataChangedListener</code>ï¼Œè¿™ä¸ªbeanå°†<code>ConfigService</code>ç±»å‹çš„beanä½œä¸ºæˆå‘˜å˜é‡ï¼Œ<code>ConfigService</code>æ˜¯nacoså®˜æ–¹æä¾›çš„apiï¼Œå½“<code>nacosDataChangedListener</code>ç›‘å¬åˆ°äº‹ä»¶æ—¶ï¼Œè¿›è¡Œå›è°ƒæ“ä½œï¼Œå¯ä»¥é€šè¿‡è¯¥apiç›´æ¥ä¸nacosæœåŠ¡å™¨äº¤äº’ï¼Œä¿®æ”¹é…ç½®ã€‚</li><li>ç”Ÿæˆ<code>NacosDataInit</code>ç±»å‹çš„beanï¼Œ<code>nacosDataInit</code>ï¼Œè¿™ä¸ªbeanå°†bean<code>configService</code>å’Œbean<code>syncDataService</code>ä½œä¸ºæˆå‘˜å˜é‡ï¼Œè°ƒç”¨<code>Nacos</code>çš„api <code>configService</code>åˆ¤æ–­é…ç½®æ˜¯å¦æœªåˆå§‹åŒ–ï¼Œæœªåˆå§‹åŒ–åˆ™è°ƒç”¨<code>syncDataService</code>è¿›è¡Œåˆ·æ–°æ“ä½œï¼Œå°†åœ¨ä¸‹æ–‡è¯¦è¿°ã€‚
æ ¹æ®ä¸Šæ–‡æ‰€è¿°ï¼Œåœ¨äº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ä¸­ï¼Œä¼šè§¦å‘ç›¸åº”çš„<code>listener</code>çš„æ“ä½œã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ˜¯å¯¹ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæ•°æ®åŒæ­¥é‡‡ç”¨çš„æ˜¯<code>nacos</code>ï¼Œæ‰€ä»¥ï¼Œä»£ç ä¼šè¿›å…¥åˆ°<code>NacosDataChangedListener</code>è¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä¼šè¿›å…¥åˆ°NacosDataChangedListenerè¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-nacosæ•°æ®å˜æ›´ç›‘å¬å™¨"></a>2.4 Nacosæ•°æ®å˜æ›´ç›‘å¬å™¨<a class="hash-link" href="#24-nacosæ•°æ®å˜æ›´ç›‘å¬å™¨" title="Direct link to heading">#</a></h4><ul><li><p>NacosDataChangedListener.onSelectorChanged()</p><p>åœ¨<code>onSelectorChanged()</code>æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­æ“ä½œç±»å‹ï¼Œæ˜¯åˆ·æ–°åŒæ­¥è¿˜æ˜¯æ›´æ–°æˆ–åˆ›å»ºåŒæ­¥ã€‚æ ¹æ®å½“å‰é€‰æ‹©å™¨æ•°æ®ä¿¡æ¯åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨<code>nacos</code>ä¸­ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Use nacos to push data changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€‰æ‹©å™¨ä¿¡æ¯å‘ç”Ÿæ”¹å˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateSelectorMap(getConfig(NacosPathConstants.SELECTOR_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SELECTOR_MAP.keySet().removeAll(SELECTOR_MAP.keySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishConfig(NacosPathConstants.SELECTOR_DATA_ID, SELECTOR_MAP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™éƒ¨åˆ†æ˜¯æ ¸å¿ƒã€‚<code>changed</code>è¡¨ç¤ºéœ€æ›´æ–°çš„<code>SelectorData</code>åˆ—è¡¨ï¼Œ<code>eventType</code>è¡¨ç¤ºäº‹ä»¶ç±»å‹ã€‚<code>SELECTOR_MAP</code>çš„ç±»å‹æ˜¯<code>ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt;</code>ï¼Œè¯¥mapçš„keyä¸ºselectoræ‰€å±çš„pluginçš„åç§°ï¼Œvalueä¸ºè¯¥pluginä¸‹çš„selectoråˆ—è¡¨ã€‚<code>NacosPathConstants.SELECTOR_DATA_ID</code>çš„å€¼ä¸º<code>shenyu.selector.json</code>ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼Œç¬¬ä¸€æ­¥ï¼Œä½¿ç”¨<code>getConfig</code>æ–¹æ³•è°ƒç”¨<code>Nacos</code>çš„apiï¼Œä»<code>Nacos</code>è·å–<code>group</code>ä¸º<code>shenyu.selector.json</code>çš„é…ç½®ä¿¡æ¯ï¼Œ<code>updateSelectorMap</code>æ–¹æ³•ä½¿ç”¨è¿™äº›é…ç½®ä¿¡æ¯æ›´æ–°<code>SELECTOR_MAP</code>ï¼Œè¿™æ ·å°±åŒæ­¥åˆ°äº†<code>Nacos</code>ä¸Šæœ€æ–°çš„selectorä¿¡æ¯ã€‚ç¬¬äºŒæ­¥ï¼Œå†æ ¹æ®äº‹ä»¶ç±»å‹æ¥æ›´æ–°<code>SELECTOR_MAP</code>ï¼Œæœ€åä½¿ç”¨<code>publishConfig</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>Nacos</code>çš„apiï¼Œå°†<code>Nacos</code>ä¸Šï¼Œ<code>group</code>ä¸º<code>shenyu.selector.json</code>çš„é…ç½®è¿›è¡Œå…¨é‡æ›¿æ¢ã€‚</p><p>åªè¦å°†å˜åŠ¨çš„æ•°æ®æ­£ç¡®å†™å…¥åˆ°<code>Nacos</code>ä¸Šï¼Œ<code>admin</code>è¿™è¾¹çš„æ“ä½œå°±æ‰§è¡Œå®Œæˆäº†ã€‚</p><p>åœ¨æˆ‘ä»¬å½“å‰çš„æ¡ˆä¾‹ä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼Œå°±ä¼šå¯¹å›¾ä¸­çš„ç‰¹å®šèŠ‚ç‚¹æ›´æ–°ã€‚</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>æˆ‘ä»¬ç”¨æ—¶åºå›¾å°†ä¸Šé¢çš„æ›´æ–°æµç¨‹ä¸²è”èµ·æ¥ã€‚</p><p><img src="/zh/assets/images/nacos-sync-sequence-admin-zh-73003e7cb52938c5528bbfcc58adfc17.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-ç½‘å…³æ•°æ®åŒæ­¥"></a>3. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#3-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>å‡è®¾<code>ShenYu</code>ç½‘å…³å·²ç»åœ¨æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨çš„æ•°æ®åŒæ­¥æ–¹å¼ä¹Ÿæ˜¯<code>nacos</code>ã€‚é‚£ä¹ˆå½“åœ¨<code>admin</code>ç«¯æ›´æ–°é€‰æ‹©å™¨æ•°æ®åï¼Œå¹¶ä¸”å‘<code>nacos</code>å‘é€äº†å˜æ›´çš„æ•°æ®ï¼Œé‚£ç½‘å…³æ˜¯å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†æ•°æ®çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­è¿›è¡Œæºç åˆ†æï¼Œä¸€æ¢ç©¶ç«Ÿã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-nacossyncdataserviceæ¥æ”¶æ•°æ®"></a>3.1 <code>NacosSyncDataService</code>æ¥æ”¶æ•°æ®<a class="hash-link" href="#31-nacossyncdataserviceæ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><p>ç½‘å…³æ˜¯é€šè¿‡<code>NacosSyncDataService</code>å¯¹<code>nacos</code>è¿›è¡Œç›‘å¬å¹¶è·å–æ•°æ®æ›´æ–°çš„ï¼Œä½†æ˜¯åœ¨è¿™éƒ¨åˆ†å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<code>NacosSyncDataService</code>ç±»å‹çš„beanæ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚ç­”æ¡ˆæ˜¯åœ¨Springé…ç½®ç±»<code>NacosSyncDataConfiguration</code>ä¸­å®šä¹‰çš„ã€‚æˆ‘ä»¬çœ‹åˆ°<code>NacosSyncDataConfiguration</code>ç±»ä¸Šçš„æ³¨è§£ï¼Œ<code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>ï¼Œè¿™ä¸ªæ³¨è§£æˆ‘ä»¬åœ¨ä¸Šæ–‡å¯¹<code>ShenYu</code>çš„Adminç«¯ä¸­çš„<code>NacosListener</code>ç±»è¿›è¡Œåˆ†ææ—¶çœ‹åˆ°è¿‡ï¼Œæ˜¯ä¸€ä¸ªå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬åœ¨<code>Shenyu</code>ç½‘å…³ç«¯æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±è¡¨ç¤º<code>Shenyu</code>ç½‘å…³ç«¯é‡‡ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œ<code>NacosSyncDataConfiguration</code>è¿™ä¸ªé…ç½®ç±»ç”Ÿæ•ˆã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(NacosSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(NacosSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService     the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos config service config service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosConfig the nacos config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosConfig nacosConfig) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosConfig.getAcm() != null &amp;&amp; nacosConfig.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosConfig.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosConfig.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosConfig.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosConfig.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosConfig.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getUsername() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosConfig.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getPassword() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosConfig.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http config http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosConfig nacosConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹ä¸Šé¢ä»£ç ä¸­<code>nacosSyncDataService</code>è¿™ä¸ªbeançš„ç”Ÿæˆï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ˜¯ç›´æ¥è°ƒç”¨<code>NacosSyncDataService</code>çš„æ„é€ æ–¹æ³•newäº†ä¸€ä¸ªè¯¥ç±»å‹çš„å¯¹è±¡ã€‚æˆ‘ä»¬ç»§ç»­çœ‹æ„é€ æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public NacosSyncDataService(final ConfigService configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(configService, pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.PLUGIN_DATA_ID, this::updatePluginMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.SELECTOR_DATA_ID, this::updateSelectorMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.RULE_DATA_ID, this::updateRuleMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.META_DATA_ID, this::updateMetaDataMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.AUTH_DATA_ID, this::updateAuthMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void watcherData(final String dataId, final OnChange oc) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Listener listener = new Listener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void receiveConfigInfo(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                oc.change(configInfo);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Executor getExecutor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        oc.change(getConfigAndSignListener(dataId, listener));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LISTENERS.computeIfAbsent(dataId, key -&gt; new ArrayList&lt;&gt;()).add(listener);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>start</code>æ–¹æ³•ï¼Œå¹¶ä¸”é€šè¿‡<code>watcherData</code>æ–¹æ³•åˆ›å»ºäº†ç›‘å¬å™¨ï¼Œå¹¶ä¸”å…³è”äº†å›è°ƒå‡½æ•°ocï¼Œç”±äºæˆ‘ä»¬æ­£åœ¨åˆ†æselectorç±»å‹ç»„ä»¶çš„å˜åŒ–ï¼Œå¯¹åº”çš„å›è°ƒå‡½æ•°æ˜¯<code>updateSelectorMap</code>ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°ç”¨äºå¤„ç†æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-å¤„ç†æ•°æ®"></a>3.2 å¤„ç†æ•°æ®<a class="hash-link" href="#32-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>NacosCacheHandler.updateSelectorMap()</li></ul><p>ç»è¿‡åˆ¤ç©ºé€»è¾‘ä¹‹åï¼Œç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„æ“ä½œåˆäº¤ç»™äº†<code>PluginDataSubscriber</code>å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateSelectorMap(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; selectorDataList = GsonUtils.getInstance().toObjectMapList(configInfo, SelectorData.class).values().stream().flatMap(Collection::stream).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDataList.forEach(selectorData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.unSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.onSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (JsonParseException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;sync selector data have error:&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ª<code>CommonPluginDataSubscriber</code>å®ç°ç±»ï¼Œè´Ÿè´£å¤„ç†æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…"></a>3.3 é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…<a class="hash-link" href="#33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>å®ƒæ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>subscribeDataHandler()</code>æ–¹æ³•ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œæ›´å…·æ•°æ®ç±»å‹ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨æˆ–è§„åˆ™ï¼‰ï¼Œæ“ä½œç±»å‹ï¼ˆæ›´æ–°æˆ–åˆ é™¤ï¼‰ï¼Œå»æ‰§è¡Œä¸åŒé€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å¤„ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å¤„ç†å™¨ï¼Œå¤„ç†æ•°æ®çš„æ›´æ–°æˆ–åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜"></a>3.4 æ•°æ®ç¼“å­˜åˆ°å†…å­˜<a class="hash-link" href="#34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜" title="Direct link to heading">#</a></h4><p>é‚£ä¹ˆæ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³çš„å†…å­˜ä¸­ã€‚<code>BaseDataCache</code>æ˜¯æœ€ç»ˆç¼“å­˜æ•°æ®çš„ç±»ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ã€‚é€‰æ‹©å™¨æ•°æ®å°±å­˜åˆ°äº†<code>SELECTOR_MAP</code>è¿™ä¸ª<code>Map</code>ä¸­ã€‚åœ¨åç»­ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»è¿™é‡Œæ‹¿æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  å…¬å¼€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  ç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç¼“å­˜é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // æ›´æ–°æ“ä½œï¼Œå…ˆåˆ é™¤å†æ’å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // æ–°å¢æ“ä½œï¼Œç›´æ¥æ”¾åˆ°Mapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>äºŒæ˜¯å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†ã€‚  é€šè¿‡<code>idea</code>ç¼–è¾‘å™¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æ–°å¢ä¸€æ¡é€‰æ‹©å™¨åï¼Œæœ‰å¦‚ä¸‹çš„æ’ä»¶è¿˜æœ‰å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä¸å†å±•å¼€äº†ã€‚</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>ç»è¿‡ä»¥ä¸Šçš„æºç è¿½è¸ªï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼Œåœ¨<code>admin</code>ç«¯æ–°å¢æ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œå°±å°†<code>nacos</code>æ•°æ®åŒæ­¥çš„æµç¨‹åˆ†ææ¸…æ¥šäº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡æ—¶åºå›¾å°†ç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æµç¨‹ä¸²è”ä¸€ä¸‹ï¼š</p><p><img src="/zh/assets/images/nacos-sync-sequence-gateway-zh-bdc1404f8b15c4ebb82baaa4485660ac.png"></p><p>æ•°æ®åŒæ­¥çš„æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œä¸ºäº†ä¸è®©åŒæ­¥æµç¨‹è¢«æ‰“æ–­ï¼Œåœ¨åˆ†æè¿‡ç¨‹ä¸­å°±å¿½ç•¥äº†å…¶ä»–é€»è¾‘ã€‚ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–çš„æµç¨‹åœ¨<code>NacosSyncDataService</code>çš„<code>start</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡åˆ†æ<code>ç½‘å…³æ•°æ®åŒæ­¥</code>æ—¶åˆ†æè¿‡äº†ï¼Œä¸‹é¢åˆ†æ<code>Admin</code>çš„åŒæ­¥æ•°æ®åˆå§‹åŒ–ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–"></a>4. AdminåŒæ­¥æ•°æ®åˆå§‹åŒ–<a class="hash-link" href="#4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p><code>admin</code>ç«¯ï¼Œ<code>NacosDataInit</code>ç±»å‹çš„beanï¼Œåœ¨<code>NacosListener</code>ä¸­è¿›è¡Œå®šä¹‰å’Œç”Ÿæˆï¼Œå¦‚æœ<code>admin</code>çš„é…ç½®ä¸­æŒ‡å®šäº†ä½¿ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œå½“<code>admin</code>å¯åŠ¨åï¼Œä¼šå°†å½“å‰çš„æ•°æ®ä¿¡æ¯å…¨é‡åŒæ­¥åˆ°<code>nacos</code>ä¸­ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(NacosDataInit.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConfigService configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService the nacos config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginDataId = NacosPathConstants.PLUGIN_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authDataId = NacosPathConstants.AUTH_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataId = NacosPathConstants.META_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dataIdNotExist(pluginDataId) &amp;&amp; dataIdNotExist(authDataId) &amp;&amp; dataIdNotExist(metaDataId)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group = NacosPathConstants.GROUP;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long timeout = NacosPathConstants.DEFAULT_TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return configService.getConfig(pluginDataId, group, timeout) == null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NacosException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Get data from nacos error.&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ¤æ–­<code>nacos</code>ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŒæ­¥ã€‚</p><p><code>NacosDataInit</code>å®ç°äº†<code>CommandLineRunner</code>æ¥å£ã€‚å®ƒæ˜¯<code>springboot</code>æä¾›çš„æ¥å£ï¼Œä¼šåœ¨æ‰€æœ‰ <code>Spring Beans</code>åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ<code>run()</code>æ–¹æ³•ï¼Œå¸¸ç”¨äºé¡¹ç›®ä¸­åˆå§‹åŒ–çš„æ“ä½œã€‚</p><ul><li>SyncDataService.syncAll()</li></ul><p>ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œç„¶åè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œæ‰€æœ‰çš„è®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯å’Œå…ƒæ•°æ®ä¿¡æ¯ã€‚ä¸»è¦æ˜¯é€šè¿‡<code>eventPublisher</code>å‘å¸ƒåŒæ­¥äº‹ä»¶ã€‚è¿™é‡Œå°±è·Ÿå‰é¢æåˆ°çš„åŒæ­¥é€»è¾‘å°±åˆè”ç³»èµ·æ¥äº†ï¼Œ<code>eventPublisher</code>é€šè¿‡<code>publishEvent()</code>å‘å¸ƒå®Œäº‹ä»¶åï¼Œæœ‰<code>ApplicationListener</code>æ‰§è¡Œäº‹ä»¶å˜æ›´æ“ä½œï¼Œåœ¨<code>ShenYu</code>ä¸­å°±æ˜¯å‰é¢æåˆ°çš„<code>DataChangedEventDispatcher</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡æ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥å…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-æ€»ç»“"></a>5. æ€»ç»“<a class="hash-link" href="#5-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œå¯¹<code>nacos</code>çš„æ•°æ®åŒæ­¥åŸç†è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>åŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>watch</code>æœºåˆ¶å®ç°ï¼›</li><li>é€šè¿‡<code>Spring</code>å®Œæˆäº‹ä»¶å‘å¸ƒå’Œç›‘å¬ï¼›</li><li>é€šè¿‡æŠ½è±¡<code>DataChangedListener</code>æ¥å£ï¼Œæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼›</li><li>ä½¿ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼å®ç°ç¼“å­˜æ•°æ®ç±»<code>BaseDataCache</code>ï¼›</li><li>é€šè¿‡<code>SpringBoot</code>çš„æ¡ä»¶è£…é…å’Œ<code>starter</code>åŠ è½½æœºåˆ¶å®ç°é…ç½®ç±»çš„åŠ è½½ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/nacos">nacos</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocketæ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.462Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>WebSocket</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-å…³äºwebsocketé€šä¿¡"></a>1. å…³äºWebSocketé€šä¿¡<a class="hash-link" href="#1-å…³äºwebsocketé€šä¿¡" title="Direct link to heading">#</a></h3><p><code>WebSocket</code>åè®®è¯ç”Ÿäº<code>2008</code>å¹´ï¼Œåœ¨<code>2011</code>å¹´æˆä¸ºå›½é™…æ ‡å‡†ã€‚å®ƒå¯ä»¥åŒå‘é€šä¿¡ï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘æœåŠ¡å™¨å‘é€ä¿¡æ¯ã€‚<code>WebSocket</code>åè®®å»ºç«‹åœ¨ <code>TCP</code> åè®®ä¹‹ä¸Šï¼Œå±äºåº”ç”¨å±‚ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆï¼Œåè®®æ ‡è¯†ç¬¦æ˜¯<code>ws</code>ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-adminæ•°æ®åŒæ­¥"></a>2. Adminæ•°æ®åŒæ­¥<a class="hash-link" href="#2-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªå®é™…æ¡ˆä¾‹è¿›è¡Œæºç è¿½è¸ªï¼Œæ¯”å¦‚åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ–°å¢ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼š</p><p><img src="/zh/assets/images/add-selector-93ff1008c1b0b4627dd3329abc92a7bd.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶æ•°æ®"></a>2.1 æ¥æ”¶æ•°æ®<a class="hash-link" href="#21-æ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>è¿›å…¥<code>SelectorController</code>ç±»ä¸­çš„<code>createSelector()</code>æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ•°æ®çš„æ ¡éªŒï¼Œæ·»åŠ æˆ–æ›´æ–°æ•°æ®ï¼Œè¿”å›ç»“æœä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult createSelector(@Valid @RequestBody final SelectorDTO selectorDTO) { // @Valid æ•°æ ¡éªŒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ æˆ–æ›´æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer createCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿”å›ç»“æœä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.CREATE_SUCCESS, createCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å¤„ç†æ•°æ®"></a>2.2 å¤„ç†æ•°æ®<a class="hash-link" href="#22-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>åœ¨<code>SelectorServiceImpl</code>ç±»ä¸­é€šè¿‡<code>createOrUpdate()</code>æ–¹æ³•å®Œæˆæ•°æ®çš„è½¬æ¢ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œæ›´æ–°<code>upstream</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è´Ÿè´£äº‹ä»¶å‘å¸ƒçš„eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ•°æ® DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­æ˜¯æ·»åŠ è¿˜æ˜¯æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨ä¸­çš„æ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æƒé™æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®ï¼Œå…ˆåˆ é™¤å†æ–°å¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>Service</code>ç±»å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼Œå³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œå°±ä¸å±•å¼€ã€‚å…³äºæ›´æ–°<code>upstream</code>æ“ä½œï¼Œæ”¾åˆ°åé¢å¯¹åº”çš„ç« èŠ‚ä¸­è¿›è¡Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨å‘å¸ƒäº‹ä»¶çš„æ“ä½œï¼Œå®ƒä¼šè¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><p><code>publishEvent()</code>æ–¹æ³•çš„é€»è¾‘æ˜¯ï¼šæ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶ï¼Œæ„å»ºæ¡ä»¶æ•°æ®ï¼Œå‘å¸ƒå˜æ›´æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒå˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‘å¸ƒå˜æ›´æ•°æ®é€šè¿‡<code>eventPublisher.publishEvent()</code>å®Œæˆï¼Œè¿™ä¸ª<code>eventPublisher</code>å¯¹è±¡æ˜¯ä¸€ä¸ª<code>ApplicationEventPublisher</code>ç±»ï¼Œè¿™ä¸ªç±»çš„å…¨é™å®šåæ˜¯<code>org.springframework.context.ApplicationEventPublisher</code>ã€‚çœ‹åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬çŸ¥é“äº†å‘å¸ƒæ•°æ®æ˜¯é€šè¿‡<code>Spring</code>ç›¸å…³çš„åŠŸèƒ½æ¥å®Œæˆçš„ã€‚</p><blockquote><p>å…³äº<code>ApplicationEventPublisher</code>ï¼š</p><p>å½“æœ‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…è°ƒç”¨ <code>ApplicationEventPublisher</code> çš„ <code>publishEvent</code> æ–¹æ³•å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œ<code>Spring</code>å®¹å™¨å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onApplicationEvent</code> æ–¹æ³•æŠŠäº‹ä»¶å¯¹è±¡ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚è°ƒç”¨ <code>publishEvent</code>æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å®ç°æ¥å£ç”±å®¹å™¨æ³¨å…¥ <code>ApplicationEventPublisher</code> å¯¹è±¡ç„¶åè°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨å®¹å™¨çš„æ–¹æ³•ï¼Œä¸¤ç§æ–¹æ³•å‘å¸ƒäº‹ä»¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><ul><li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒäº‹ä»¶ï¼›</li><li><code>ApplicationEvent</code>ï¼š<code>Spring</code> äº‹ä»¶ï¼Œè®°å½•äº‹ä»¶æºã€æ—¶é—´å’Œæ•°æ®ï¼›</li><li><code>ApplicationListener</code>ï¼šäº‹ä»¶ç›‘å¬è€…ï¼Œè§‚å¯Ÿè€…ã€‚</li></ul></blockquote><p>åœ¨<code>Spring</code>çš„äº‹ä»¶å‘å¸ƒæœºåˆ¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œ</p><p>ä¸€ä¸ªæ˜¯å‘å¸ƒäº‹ä»¶çš„<code>ApplicationEventPublisher</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡æ„é€ å™¨æ³¨å…¥äº†ä¸€ä¸ª<code>eventPublisher</code>ã€‚</p><p>å¦ä¸€ä¸ªå¯¹è±¡æ˜¯<code>ApplicationEvent</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEvent</code>ç»§æ‰¿äº†å®ƒï¼Œè¡¨ç¤ºäº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åä¸€ä¸ªæ˜¯ <code>ApplicationListener</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEventDispatcher</code>ç±»å®ç°äº†è¯¥æ¥å£ï¼Œä½œä¸ºäº‹ä»¶çš„ç›‘å¬è€…ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-åˆ†å‘æ•°æ®"></a>2.3 åˆ†å‘æ•°æ®<a class="hash-link" href="#23-åˆ†å‘æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>å½“äº‹ä»¶å‘å¸ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿›å…¥åˆ°<code>DataChangedEventDispatcher</code>ç±»ä¸­çš„<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨<code>onApplicationEvent</code>æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œåˆ¤æ–­æ˜¯å“ªç§æ•°æ®ç±»å‹ï¼Œäº¤ç»™ç›¸åº”çš„æ•°æ®ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚</p><p><code>ShenYu</code>å°†æ‰€æœ‰æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æ˜¯äº”ç§ï¼šè®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯å’Œå…ƒæ•°æ®ã€‚</p><p>è¿™é‡Œçš„æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆ<code>DataChangedListener</code>ï¼‰ï¼Œå°±æ˜¯æ•°æ®åŒæ­¥ç­–ç•¥çš„æŠ½è±¡ï¼Œå®ƒçš„å…·ä½“å®ç°æœ‰ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>è¿™å‡ ä¸ªå®ç°ç±»å°±æ˜¯å½“å‰<code>ShenYu</code>æ”¯æŒçš„åŒæ­¥ç­–ç•¥ï¼š</p><ul><li><code>WebsocketDataChangedListener</code>ï¼šåŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ZookeeperDataChangedListener</code>ï¼šåŸºäº<code>zookeeper</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ConsulDataChangedListener</code>ï¼šåŸºäº<code>consul</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>EtcdDataDataChangedListener</code>ï¼šåŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>HttpLongPollingDataChangedListener</code>ï¼šåŸºäº<code>httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>NacosDataChangedListener</code>ï¼šåŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼›</li></ul><p>æ—¢ç„¶æœ‰è¿™ä¹ˆå¤šç§å®ç°ç­–ç•¥ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>å› ä¸ºæœ¬æ–‡æ˜¯åŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æï¼Œæ‰€ä»¥è¿™é‡Œä»¥<code>WebsocketDataChangedListener</code>ä¸ºä¾‹ï¼Œåˆ†æå®ƒæ˜¯å¦‚ä½•è¢«åŠ è½½å¹¶å®ç°çš„ã€‚</p><p>é€šè¿‡åœ¨æºç å·¥ç¨‹ä¸­è¿›è¡Œå…¨å±€æœç´¢ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å®ç°æ˜¯åœ¨<code>DataSyncConfiguration</code>ç±»å®Œæˆçš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * websocketæ•°æ®åŒæ­¥ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The WebsocketListener(default strategy).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;shenyu.sync.websocket.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(WebsocketSyncProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class WebsocketListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * é…ç½®websocketæ•°æ®å˜æ›´ç›‘å¬å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(WebsocketDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener websocketDataChangedListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new WebsocketDataChangedListener();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Websocket collector.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Websocketå¤„ç†ç±»ï¼šå»ºç«‹è¿æ¥ï¼Œå‘é€æ¶ˆæ¯ï¼Œå…³é—­è¿æ¥ç­‰æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the websocket collector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(WebsocketCollector.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public WebsocketCollector websocketCollector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new WebsocketCollector();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Server endpoint exporter </span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the server endpoint exporter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ServerEndpointExporter.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ServerEndpointExporter serverEndpointExporter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ServerEndpointExporter();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªé…ç½®ç±»æ˜¯é€šè¿‡<code>SpringBoot</code>æ¡ä»¶è£…é…ç±»å®ç°çš„ã€‚åœ¨<code>WebsocketListener</code>ç±»ä¸Šé¢æœ‰å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p><code>@Configuration</code>ï¼šé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ä¸Šä¸‹æ–‡ï¼›</p></li><li><p><code>@ConditionalOnProperty(name = &quot;shenyu.sync.websocket.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</code>ï¼šå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šé‡‡ç”¨<code>websocket</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚ä¸è¿‡ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸‹<code>matchIfMissing = true</code>è¿™ä¸ªå±æ€§ï¼Œå®ƒè¡¨ç¤ºï¼Œå¦‚æœä½ æ²¡æœ‰å¦‚ä¸‹çš„é…ç½®ï¼Œè¯¥é…ç½®ç±»ä¹Ÿä¼šç”Ÿæ•ˆã€‚åŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥æ—¶å®˜æ–¹æ¨èçš„æ–¹å¼ï¼Œä¹Ÿæ˜¯é»˜è®¤é‡‡ç”¨çš„æ–¹å¼ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    websocket:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties</code>ï¼šå¯ç”¨é…ç½®å±æ€§ï¼›</p></li></ul><p>å½“æˆ‘ä»¬ä¸»åŠ¨é…ç½®ï¼Œé‡‡ç”¨<code>websocket</code>è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œ<code>WebsocketDataChangedListener</code>å°±ä¼šç”Ÿæˆã€‚æ‰€ä»¥åœ¨äº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ä¸­ï¼Œå°±ä¼šåˆ°ç›¸åº”çš„<code>listener</code>ä¸­ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ˜¯æ–°å¢åŠ äº†ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œæ•°æ®é€šè¿‡é‡‡ç”¨çš„æ˜¯<code>websocket</code>ï¼Œæ‰€ä»¥ï¼Œä»£ç ä¼šè¿›å…¥åˆ°<code>WebsocketDataChangedListener</code>è¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // WebsocketDataChangedListenerè¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-websocketæ•°æ®å˜æ›´ç›‘å¬å™¨"></a>2.4 Websocketæ•°æ®å˜æ›´ç›‘å¬å™¨<a class="hash-link" href="#24-websocketæ•°æ®å˜æ›´ç›‘å¬å™¨" title="Direct link to heading">#</a></h4><ul><li><p>WebsocketDataChangedListener.onSelectorChanged()</p><p>åœ¨<code>onSelectorChanged()</code>æ–¹æ³•ä¸­ï¼Œå°†æ•°æ®è¿›è¡Œäº†å°è£…ï¼Œè½¬æˆ<code>WebsocketData</code>ï¼Œç„¶åé€šè¿‡<code>WebsocketCollector.send()</code>å‘é€æ•°æ®ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    // é€‰æ‹©å™¨æ•°æ®æœ‰æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; selectorDataList, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„é€  WebsocketData æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData&lt;SelectorData&gt; websocketData =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new WebsocketData&lt;&gt;(ConfigGroupEnum.SELECTOR.name(), eventType.name(), selectorDataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é€šè¿‡websocketå‘é€æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-websocketå‘é€æ•°æ®"></a>2.5 Websocketå‘é€æ•°æ®<a class="hash-link" href="#25-websocketå‘é€æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>WebsocketCollector.send()</li></ul><p>åœ¨<code>send()</code>æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­äº†ä¸€ä¸‹åŒæ­¥çš„ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„ç±»å‹ï¼Œè¿›è¡Œå¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ServerEndpoint(value = &quot;/websocket&quot;, configurator = WebsocketConfigurator.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketCollector {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Send.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param message the message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type    the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void send(final String message, final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(message)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¦‚æœæ˜¯MYSELFï¼ˆç¬¬ä¸€æ¬¡çš„å…¨é‡åŒæ­¥ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (DataEventTypeEnum.MYSELF == type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ä»threadlocalä¸­è·å–session</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Session session = (Session) ThreadLocalUtil.get(SESSION_KEY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (session != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å‘è¯¥sessionå‘é€å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendMessageBySession(session, message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åç»­çš„å¢é‡åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å‘æ‰€æœ‰çš„sessionä¸­åŒæ­¥å˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SESSION_SET.forEach(session -&gt; sendMessageBySession(session, message));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void sendMessageBySession(final Session session, final String message) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡websocketçš„sessionæŠŠæ¶ˆæ¯å‘é€å‡ºå»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            session.getBasicRemote().sendText(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;websocket send result is exception: &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆ‘ä»¬ç»™çš„æ¡ˆä¾‹æ˜¯ä¸€ä¸ªæ–°å¢æ“ä½œ ï¼Œæ˜¯ä¸€ä¸ªå¢é‡åŒæ­¥ï¼Œæ‰€ä»¥ä¼šèµ°</p><p><code>SESSION_SET.forEach(session -&gt; sendMessageBySession(session, message));</code></p><p>è¿™ä¸ªé€»è¾‘ã€‚</p><p>å†é€šè¿‡</p><p><code>session.getBasicRemote().sendText(message);</code></p><p>å°†æ•°æ®å‘é€äº†å‡ºå»ã€‚</p><p>è‡³æ­¤ï¼Œå½“<code>admin</code>ç«¯å‘ç”Ÿæ•°æ®å˜æ›´æ—¶ï¼Œå°±å°†å˜æ›´çš„æ•°æ®ä»¥å¢é‡å½¢å¼é€šè¿‡<code>WebSocket</code>å‘ç»™äº†ç½‘å…³ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰ç–‘é—®å‘¢ï¼Ÿæ¯”å¦‚<code>session</code>æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿç½‘å…³å¦‚ä½•å’Œ<code>admin</code>å»ºç«‹è¿æ¥çš„ï¼Ÿ</p><p>ä¸è¦ç€æ€¥ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¿›è¡Œç½‘å…³ç«¯çš„åŒæ­¥åˆ†æã€‚</p><p>ä¸è¿‡ï¼Œåœ¨ç»§ç»­æºç åˆ†æå‰ï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ å›¾å°†ä¸Šé¢çš„åˆ†æè¿‡ç¨‹ä¸²è”èµ·æ¥ã€‚</p><p><img src="/zh/assets/images/websocket-data-sync-admin-56f75ad149ca3cd1ec07fd24c6194c5b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-ç½‘å…³æ•°æ®åŒæ­¥"></a>3. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#3-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>å‡è®¾<code>ShenYu</code>ç½‘å…³å·²ç»åœ¨æ­£å¸¸è¿è¡Œäº†ï¼Œä½¿ç”¨çš„æ•°æ®åŒæ­¥æ–¹å¼ä¹Ÿæ˜¯<code>websocket</code>ã€‚é‚£ä¹ˆå½“åœ¨<code>admin</code>ç«¯æ–°å¢ä¸€æ¡é€‰æ‹©å™¨æ•°æ®åï¼Œå¹¶ä¸”é€šè¿‡<code>WebSocket</code>å‘é€åˆ°ç½‘å…³ï¼Œé‚£ç½‘å…³æ˜¯å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†æ•°æ®çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­è¿›è¡Œæºç åˆ†æï¼Œä¸€æ¢ç©¶ç«Ÿã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-websocketclientæ¥æ”¶æ•°æ®"></a>3.1 WebsocketClientæ¥æ”¶æ•°æ®<a class="hash-link" href="#31-websocketclientæ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>ShenyuWebsocketClient.onMessage()</li></ul><p>åœ¨ç½‘å…³ç«¯æœ‰ä¸€ä¸ª<code>ShenyuWebsocketClient</code>ç±»ï¼Œå®ƒç»§æ‰¿äº†<code>WebSocketClient</code>ï¼Œå¯ä»¥å’Œ<code>WebSocket</code>å»ºç«‹è¿æ¥å¹¶é€šä¿¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“åœ¨<code>admin</code>ç«¯é€šè¿‡<code>websocket</code>å‘é€æ•°æ®åï¼Œ<code>ShenyuWebsocketClient</code>å°±å¯ä»¥é€šè¿‡<code>onMessage()</code>æ¥æ”¶åˆ°æ•°æ®ï¼Œç„¶åå°±å¯ä»¥è‡ªå·±è¿›è¡Œå¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // æ¥å—åˆ°æ¶ˆæ¯åæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleResult(result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void handleResult(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ•°æ®ååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å“ªç§æ•°æ®ç±»å‹ï¼Œæ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å“ªç§æ“ä½œç±»å‹ï¼Œæ›´æ–°ã€åˆ é™¤...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String eventType = websocketData.getEventType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(websocketData.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        websocketDataHandler.executor(groupEnum, json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥æ”¶åˆ°æ•°æ®åï¼Œé¦–å…ˆè¿›è¡Œäº†ååºåˆ—åŒ–æ“ä½œï¼Œè¯»å–æ•°æ®ç±»å‹å’Œæ“ä½œç±»å‹ï¼Œç´§æ¥ç€ï¼Œå°±äº¤ç»™<code>websocketDataHandler.executor()</code>è¿›è¡Œå¤„ç†ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-æ‰§è¡Œwebsocketäº‹ä»¶å¤„ç†å™¨"></a>3.2 æ‰§è¡ŒWebsocketäº‹ä»¶å¤„ç†å™¨<a class="hash-link" href="#32-æ‰§è¡Œwebsocketäº‹ä»¶å¤„ç†å™¨" title="Direct link to heading">#</a></h4><ul><li>WebsocketDataHandler.executor()</li></ul><p>é€šè¿‡å·¥å‚æ¨¡å¼åˆ›å»ºäº†<code>Websocket</code>æ•°æ®å¤„ç†å™¨ï¼Œæ¯ç§æ•°æ®ç±»å‹ï¼Œéƒ½æä¾›äº†ä¸€ä¸ªå¤„ç†å™¨ï¼š</p><blockquote><p>æ’ä»¶ --&gt; æ’ä»¶æ•°æ®å¤„ç†å™¨;</p><p>é€‰æ‹©å™¨ --&gt; é€‰æ‹©å™¨æ•°æ®å¤„ç†å™¨ï¼›</p><p>è§„åˆ™ --&gt; è§„åˆ™æ•°æ®å¤„ç†å™¨ï¼›</p><p>è®¤è¯ä¿¡æ¯ --&gt; è®¤è¯æ•°æ®å¤„ç†å™¨ï¼›</p><p>å…ƒæ•°æ® --&gt; å…ƒæ•°æ®å¤„ç†å™¨ã€‚</p></blockquote><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡å·¥å‚æ¨¡å¼åˆ›å»º Websocketæ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Websocket cache handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final EnumMap&lt;ConfigGroupEnum, DataHandler&gt; ENUM_MAP = new EnumMap&lt;&gt;(ConfigGroupEnum.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Websocket data handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ¯ç§æ•°æ®ç±»å‹ï¼Œæä¾›ä¸€ä¸ªå¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketDataHandler(final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶ --&gt; æ’ä»¶æ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.PLUGIN, new PluginDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é€‰æ‹©å™¨ --&gt; é€‰æ‹©å™¨æ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.SELECTOR, new SelectorDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è§„åˆ™ --&gt; è§„åˆ™æ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.RULE, new RuleDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¤è¯ä¿¡æ¯ --&gt; è®¤è¯æ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.APP_AUTH, new AuthDataHandler(authDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å…ƒæ•°æ® --&gt; å…ƒæ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.META_DATA, new MetaDataHandler(metaDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Executor.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type      the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param json      the json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param eventType the event type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final ConfigGroupEnum type, final String json, final String eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®æ•°æ®ç±»å‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.get(type).handle(json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œæœ‰ä¸åŒçš„æ•°æ®å¤„ç†æ–¹å¼ï¼Œæ‰€ä»¥æœ‰ä¸åŒçš„å®ç°ç±»ã€‚ä½†æ˜¯å®ƒä»¬ä¹‹é—´ä¹Ÿæœ‰ç›¸åŒçš„å¤„ç†é€»è¾‘ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼æ¥å®ç°ã€‚ç›¸åŒçš„é€»è¾‘æ”¾åœ¨æŠ½è±¡ç±»ä¸­çš„<code>handle()</code>æ–¹æ³•ä¸­ï¼Œä¸åŒé€»è¾‘å°±äº¤ç»™å„è‡ªçš„å®ç°ç±»ã€‚</p><p><img src="/zh/assets/images/data-handler-313ae788eadfdabf405cdc55c74dbb21.png"></p><p>æˆ‘ä»¬çš„æ¡ˆä¾‹æ˜¯æ–°å¢äº†ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œæ‰€ä»¥ä¼šäº¤ç»™<code>SelectorDataHandler</code>ï¼ˆ é€‰æ‹©å™¨ --&gt; é€‰æ‹©å™¨æ•°æ®å¤„ç†å™¨ï¼‰è¿›è¡Œæ•°æ®å¤„ç†ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-åˆ¤æ–­äº‹ä»¶ç±»å‹"></a>3.3 åˆ¤æ–­äº‹ä»¶ç±»å‹<a class="hash-link" href="#33-åˆ¤æ–­äº‹ä»¶ç±»å‹" title="Direct link to heading">#</a></h4><ul><li>AbstractDataHandler.handle()</li></ul><p>å®ç°æ•°æ®å˜æ›´çš„é€šç”¨é€»è¾‘å¤„ç†ï¼šæ ¹æ®ä¸åŒçš„æ“ä½œç±»å‹è°ƒç”¨ä¸åŒæ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataHandler&lt;T&gt; implements DataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Convert list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸åŒçš„é€»è¾‘ç”±å„è‡ªå®ç°ç±»å»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param json the json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract List&lt;T&gt; convert(String json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do refresh.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸åŒçš„é€»è¾‘ç”±å„è‡ªå®ç°ç±»å»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doRefresh(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do update.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸åŒçš„é€»è¾‘ç”±å„è‡ªå®ç°ç±»å»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doUpdate(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do delete.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ä¸åŒçš„é€»è¾‘ç”±å„è‡ªå®ç°ç±»å»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doDelete(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€šç”¨é€»è¾‘ï¼ŒæŠ½è±¡ç±»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handle(final String json, final String eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;T&gt; dataList = convert(json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DataEventTypeEnum eventTypeEnum = DataEventTypeEnum.acquireByName(eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (eventTypeEnum) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doRefresh(dataList);  //åˆ·æ–°æ•°æ®ï¼Œå…¨é‡åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case UPDATE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case CREATE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doUpdate(dataList); // æ›´æ–°æˆ–åˆ›å»ºæ•°æ®ï¼Œå¢é‡åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doDelete(dataList);  // åˆ é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ–°å¢ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œæ˜¯æ–°å¢æ“ä½œï¼Œé€šè¿‡<code>switch-case</code>è¿›å…¥åˆ°<code>doUpdate()</code>æ–¹æ³•ä¸­ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-è¿›å…¥å…·ä½“çš„æ•°æ®å¤„ç†å™¨"></a>3.4 è¿›å…¥å…·ä½“çš„æ•°æ®å¤„ç†å™¨<a class="hash-link" href="#34-è¿›å…¥å…·ä½“çš„æ•°æ®å¤„ç†å™¨" title="Direct link to heading">#</a></h4><ul><li>SelectorDataHandler.doUpdate()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€‰æ‹©å™¨æ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Selector data handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorDataHandler extends AbstractDataHandler&lt;SelectorData&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PluginDataSubscriber pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doUpdate(final List&lt;SelectorData&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataList.forEach(pluginDataSubscriber::onSelectorSubscribe);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>éå†æ•°æ®ï¼Œè¿›å…¥<code>onSelectorSubscribe()</code>æ–¹æ³•ã€‚</p><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>å®ƒæ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>subscribeDataHandler()</code>æ–¹æ³•ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œæ›´å…·æ•°æ®ç±»å‹ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨æˆ–è§„åˆ™ï¼‰ï¼Œæ“ä½œç±»å‹ï¼ˆæ›´æ–°æˆ–åˆ é™¤ï¼‰ï¼Œå»æ‰§è¡Œä¸åŒé€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å¤„ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å¤„ç†å™¨ï¼Œå¤„ç†æ•°æ®çš„æ›´æ–°æˆ–åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç† </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é‚£ä¹ˆæ–°å¢ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³çš„å†…å­˜ä¸­ã€‚<code>BaseDataCache</code>æ˜¯æœ€ç»ˆç¼“å­˜æ•°æ®çš„ç±»ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ã€‚é€‰æ‹©å™¨æ•°æ®å°±å­˜åˆ°äº†<code>SELECTOR_MAP</code>è¿™ä¸ª<code>Map</code>ä¸­ã€‚åœ¨åç»­ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»è¿™é‡Œæ‹¿æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  å…¬å¼€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  ç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç¼“å­˜é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // æ›´æ–°æ“ä½œï¼Œå…ˆåˆ é™¤å†æ’å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // æ–°å¢æ“ä½œï¼Œç›´æ¥æ”¾åˆ°Mapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>äºŒæ˜¯å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†ã€‚  é€šè¿‡<code>idea</code>ç¼–è¾‘å™¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æ–°å¢ä¸€æ¡é€‰æ‹©å™¨åï¼Œæœ‰å¦‚ä¸‹çš„æ’ä»¶è¿˜æœ‰å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä¸å†å±•å¼€äº†ã€‚</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>ç»è¿‡ä»¥ä¸Šçš„æºç è¿½è¸ªï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼Œåœ¨<code>admin</code>ç«¯æ–°å¢ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œå°±å°†<code>websocket</code>æ•°æ®åŒæ­¥çš„æµç¨‹åˆ†ææ¸…æ¥šäº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸‹é¢çš„ä¸€å¼ å›¾å°†ç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æµç¨‹ä¸²è”ä¸€ä¸‹ï¼š</p><p><img src="/zh/assets/images/websocket-data-sync-gateway-181e89c69dc9b9d2569e858eb82431bf.png"></p><p>æ•°æ®åŒæ­¥çš„æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›é—®é¢˜æ²¡æœ‰åˆ†æåˆ°ï¼Œå°±æ˜¯ç½‘å…³æ˜¯å¦‚ä½•è·Ÿ<code>admin</code>å»ºç«‹è¿æ¥çš„ï¼Ÿ</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-ç½‘å…³å’Œadminå»ºç«‹websocketè¿æ¥"></a>4. ç½‘å…³å’Œadminå»ºç«‹websocketè¿æ¥<a class="hash-link" href="#4-ç½‘å…³å’Œadminå»ºç«‹websocketè¿æ¥" title="Direct link to heading">#</a></h3><ul><li>websocketé…ç½®</li></ul><p>åœ¨ç½‘å…³çš„é…ç½®æ–‡ä»¶ä¸­æœ‰å¦‚ä¸‹é…ç½®ï¼Œå¹¶ä¸”å¼•å…¥äº†ç›¸å…³ä¾èµ–ï¼Œå°±ä¼šå¯åŠ¨<code>websocket</code>ç›¸å…³æœåŠ¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cross</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">parameter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> multi</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">websocket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä½¿ç”¨websocketè¿›è¡Œæ•°æ®åŒæ­¥</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">9095/websocket   </span><span class="token comment" style="color:#999988;font-style:italic"># adminç«¯çš„websocketåœ°å€</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">allowOrigin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9195</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨ç½‘å…³ä¸­å¼•å…¥<code>websocket</code>çš„ä¾èµ–ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!--shenyu data sync start use websocket--&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spring-boot-starter-sync-data-websocket</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Websocketæ•°æ®åŒæ­¥é…ç½®</li></ul><p>é€šè¿‡<code>springboot</code>çš„æ¡ä»¶è£…é…ï¼Œåˆ›å»ºç›¸å…³çš„<code>bean</code>ã€‚åœ¨ç½‘å…³å¯åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬é…ç½®äº†<code>shenyu.sync.websocket.urls</code>ï¼Œé‚£ä¹ˆ<code>Websocket</code>æ•°æ®åŒæ­¥é…ç½®å°±ä¼šè¢«åŠ è½½ã€‚è¿™é‡Œé€šè¿‡<code>spring boot starter</code>å®Œæˆä¾èµ–çš„åŠ è½½ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocketæ•°æ®åŒæ­¥é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootå®ç°æ¡ä»¶æ³¨å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(WebsocketSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.websocket&quot;, name = &quot;urls&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Websocket sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Websocketæ•°æ®åŒæ­¥æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param websocketConfig   the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºwebsocketSyncDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService websocketSyncDataService(final ObjectProvider&lt;WebsocketConfig&gt; websocketConfig, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;you use websocket sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new WebsocketSyncDataService(websocketConfig.getIfAvailable(WebsocketConfig::new), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Config websocket config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.websocket&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketConfig websocketConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new WebsocketConfig();  // åˆ›å»ºWebsocketConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨é¡¹ç›®çš„<code>resources/META-INF</code>ç›®å½•å…ˆæ–°å»º<code>spring.factories</code>æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­æŒ‡æ˜é…ç½®ç±»ã€‚</p><p><img src="/zh/assets/images/websocket-springboot-starter-2cfd149ba2fb69ab514241e061fc22c9.png"></p><ul><li>Websocketæ•°æ®åŒæ­¥æœåŠ¡</li></ul><p>åœ¨<code>WebsocketSyncDataService</code>ä¸­åšäº†å¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>è¯»å–é…ç½®ä¸­çš„<code>urls</code>ï¼Œè¿™ä¸ªè¡¨ç¤º<code>admin</code>ç«¯çš„åŒæ­¥åœ°å€ï¼Œæœ‰å¤šä¸ªçš„è¯ï¼Œä½¿ç”¨&quot;,&quot;åˆ†å‰²ï¼›</li><li>åˆ›å»ºè°ƒåº¦çº¿ç¨‹æ± ï¼Œä¸€ä¸ª<code>admin</code>åˆ†é…ä¸€ä¸ªï¼Œç”¨äºæ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼›</li><li>åˆ›å»º<code>ShenyuWebsocketClient</code>ï¼Œä¸€ä¸ª<code>admin</code>åˆ†é…ä¸€ä¸ªï¼Œç”¨äºå’Œ<code>admin</code>å»ºç«‹<code>websocket</code>é€šä¿¡ï¼›</li><li>å¼€å§‹å’Œ<code>admin</code>ç«¯çš„<code>websocket</code> å»ºç«‹è¿æ¥ï¼›</li><li>æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”10ç§’æ‰§è¡Œä¸€æ¬¡ã€‚ä¸»è¦ä½œç”¨æ˜¯åˆ¤æ–­<code>websocket</code>è¿æ¥æ˜¯å¦å·²ç»æ–­å¼€ï¼Œå¦‚æœå·²ç»æ–­å¼€ï¼Œåˆ™å°è¯•é‡è¿ã€‚å¦‚æœæ²¡æœ‰æ–­å¼€ï¼Œå°±è¿›è¡Œ <code>ping-pong</code> æ£€æµ‹ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocketæ•°æ®åŒæ­¥æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;WebSocketClient&gt; clients = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ScheduledThreadPoolExecutor executor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Websocket sync cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»ºWebsocketæ•°æ®åŒæ­¥æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param websocketConfig      the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketSyncDataService(final WebsocketConfig websocketConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminç«¯çš„åŒæ­¥åœ°å€ï¼Œæœ‰å¤šä¸ªçš„è¯ï¼Œä½¿ç”¨&quot;,&quot;åˆ†å‰²</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] urls = StringUtils.split(websocketConfig.getUrls(), &quot;,&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºè°ƒåº¦çº¿ç¨‹æ± ï¼Œä¸€ä¸ªadminåˆ†é…ä¸€ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor = new ScheduledThreadPoolExecutor(urls.length, ShenyuThreadFactory.create(&quot;websocket-connect&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String url : urls) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //åˆ›å»ºWebsocketClientï¼Œä¸€ä¸ªadminåˆ†é…ä¸€ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.add(new ShenyuWebsocketClient(new URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (URISyntaxException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;websocket url({}) is error&quot;, url, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (WebSocketClient client : clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å’Œwebsocket serverå»ºç«‹è¿æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean success = client.connectBlocking(3000, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (success) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.info(&quot;websocket connection is successful.....&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.error(&quot;websocket connection is error.....&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”10ç§’æ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ä¸»è¦ä½œç”¨æ˜¯åˆ¤æ–­websocketè¿æ¥æ˜¯å¦å·²ç»æ–­å¼€ï¼Œå¦‚æœå·²ç»æ–­å¼€ï¼Œåˆ™å°è¯•é‡è¿ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å¦‚æœæ²¡æœ‰æ–­å¼€ï¼Œå°±è¿›è¡Œ ping-pong æ£€æµ‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                executor.scheduleAtFixedRate(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (client.isClosed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            boolean reconnectSuccess = client.reconnectBlocking();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (reconnectSuccess) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.info(&quot;websocket reconnect server[{}] is successful.....&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.error(&quot;websocket reconnection server[{}] is error.....&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            client.sendPing();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.debug(&quot;websocket send to [{}] ping message successful&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.error(&quot;websocket connect is error :{}&quot;, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, 10, 10, TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            /* client.setProxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress(&quot;proxyaddress&quot;, 80)));*/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;websocket connection...exception....&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å…³é—­ websocket client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (WebSocketClient client : clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!client.isClosed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å…³é—­çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(executor)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuWebsocketClient</li></ul><p>åœ¨<code>ShenYu</code>ä¸­åˆ›å»ºçš„<code>WebSocket</code>å®¢æˆ·ç«¯ï¼Œç”¨äºå’Œ<code>admin</code>ç«¯é€šä¿¡ã€‚ç¬¬ä¸€æ¬¡æˆåŠŸå»ºç«‹è¿æ¥åï¼ŒåŒæ­¥å…¨é‡æ•°æ®ï¼Œåç»­è¿›è¡Œå¢é‡åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * åœ¨ShenYuä¸­è‡ªå®šä¹‰çš„WebSocketå®¢æˆ·ç«¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type shenyu websocket client.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile boolean alreadySync = Boolean.FALSE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final WebsocketDataHandler websocketDataHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new shenyu websocket client.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»ºShenyuWebsocketClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param serverUri             the server uri  æœåŠ¡ç«¯uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber æ’ä»¶æ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers   the meta data subscribers å…ƒæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers   the auth data subscribers è®¤è¯æ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuWebsocketClient(final URI serverUri, final PluginDataSubscriber pluginDataSubscriber,final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(serverUri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.websocketDataHandler = new WebsocketDataHandler(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆåŠŸå»ºç«‹è¿æ¥åæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onOpen(final ServerHandshake serverHandshake) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é˜²æ­¢é‡æ–°å»ºç«‹è¿æ¥æ—¶ï¼Œå†æ¬¡æ‰§è¡Œï¼Œæ‰€ä»¥ç”¨alreadySyncè¿›è¡Œåˆ¤æ–­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!alreadySync) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŒæ­¥æ‰€æœ‰æ•°æ®ï¼ŒMYSELF ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            send(DataEventTypeEnum.MYSELF.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            alreadySync = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ¥æ”¶åˆ°æ¶ˆæ¯åæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleResult(result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å…³é—­åæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onClose(final int i, final String s, final boolean b) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¤±è´¥åæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onError(final Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;ALL&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void handleResult(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ•°æ®ååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å“ªç§æ•°æ®ç±»å‹ï¼Œæ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å“ªç§æ“ä½œç±»å‹ï¼Œæ›´æ–°ã€åˆ é™¤...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String eventType = websocketData.getEventType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(websocketData.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        websocketDataHandler.executor(groupEnum, json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-æ€»ç»“"></a>5. æ€»ç»“<a class="hash-link" href="#5-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œå¯¹<code>websocket</code>çš„æ•°æ®åŒæ­¥åŸç†è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li><code>websocket</code>æ”¯æŒåŒå‘é€šä¿¡ï¼Œæ€§èƒ½å¥½ï¼Œæ¨èä½¿ç”¨ï¼›</li><li>é€šè¿‡<code>Spring</code>å®Œæˆäº‹ä»¶å‘å¸ƒå’Œç›‘å¬ï¼›</li><li>é€šè¿‡æŠ½è±¡<code>DataChangedListener</code>æ¥å£ï¼Œæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼›</li><li>ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»º <code>WebsocketDataHandler</code>ï¼Œå®ç°ä¸åŒæ•°æ®ç±»å‹çš„å¤„ç†ï¼›</li><li>ä½¿ç”¨æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼å®ç°<code>AbstractDataHandler</code>ï¼Œå¤„ç†é€šç”¨çš„æ“ä½œç±»å‹ï¼›</li><li>ä½¿ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼å®ç°ç¼“å­˜æ•°æ®ç±»<code>BaseDataCache</code>ï¼›</li><li>é€šè¿‡<code>SpringBoot</code>çš„æ¡ä»¶è£…é…å’Œ<code>starter</code>åŠ è½½æœºåˆ¶å®ç°é…ç½®ç±»çš„åŠ è½½ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/websocket">websocket</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/IntegrationTest-Analysis">é›†æˆæµ‹è¯•å‰–æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.462Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>è¿™ç¯‡æ–‡ç« å°†ä¼šå¯¹Apache ShenYuçš„é›†æˆæµ‹è¯•è¿›è¡Œæ·±å…¥å‰–æã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•"></a>ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•ï¼Ÿ<a class="hash-link" href="#ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•" title="Direct link to heading">#</a></h3><p>é›†æˆæµ‹è¯•åœ¨ä¸€äº›é¡¹ç›®é‡Œä¹Ÿå«E2E (End To End)æµ‹è¯•ï¼Œä¸»è¦ç”¨äºæµ‹è¯•å„ä¸ªæ¨¡å—ç»„è£…æˆä¸€ä¸ªç³»ç»Ÿåæ˜¯å¦èƒ½ç¬¦åˆé¢„æœŸã€‚</p><p>Apache ShenYuå°†é›†æˆæµ‹è¯•æ”¾åœ¨äº†æŒç»­é›†æˆä¸­ï¼Œåˆ©ç”¨GitHub Actionï¼Œåœ¨æ¯æ¬¡å‘ä¸»åˆ†æ”¯æäº¤Pull Requestæˆ–æ˜¯Mergeæ—¶è§¦å‘ã€‚è¿™æ ·å¯ä»¥å¤§å¤§é™ä½é¡¹ç›®çš„ç»´æŠ¤æˆæœ¬ï¼Œæå‡Apache ShenYuçš„ç¨³å®šæ€§ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è‡ªåŠ¨åŒ–çš„é›†æˆæµ‹è¯•å¦‚ä½•å®ç°"></a>è‡ªåŠ¨åŒ–çš„é›†æˆæµ‹è¯•å¦‚ä½•å®ç°ï¼Ÿ<a class="hash-link" href="#è‡ªåŠ¨åŒ–çš„é›†æˆæµ‹è¯•å¦‚ä½•å®ç°" title="Direct link to heading">#</a></h3><p>Apache ShenYuä¸­ï¼Œé›†æˆæµ‹è¯•çš„ä¸»è¦æ­¥éª¤ä½“ç°åœ¨GitHub Actionå·¥ä½œæµçš„è„šæœ¬ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¯¥è„šæœ¬ä½äº <a href="https://github.com/apache/incubator-shenyu/tree/master/.github/workflows" target="_blank" rel="noopener noreferrer">~/.github/workflows</a>ç›®å½•ä¸‹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> it</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> master</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matrix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alibaba</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸‹é¢æˆ‘å°†ä»è¿™ä¸ªyamlæ–‡ä»¶å‡ºå‘ï¼Œå¸¦ä½ å‰–ææ•´ä¸ªè‡ªåŠ¨åŒ–é›†æˆæµ‹è¯•çš„æµç¨‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å·¥ä½œæµçš„è§¦å‘"></a>å·¥ä½œæµçš„è§¦å‘<a class="hash-link" href="#å·¥ä½œæµçš„è§¦å‘" title="Direct link to heading">#</a></h3><p>ç”±äºæˆ‘ä»¬åœ¨ <code>on</code> ä¸­æŒ‡å®šäº† <code>pull_request</code> å’Œ <code>push.branch: master</code>ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬æäº¤pull_requestæˆ–æ˜¯mergeåˆ†æ”¯åˆ°masterï¼ˆpushï¼‰çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªå·¥ä½œæµã€‚</p><p>å…³äºæ›´å¤šGitHub Actionçš„ç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒ <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreferrer">GitHub Action</a> çš„æ–‡æ¡£ï¼Œè¿™é‡Œä¸ä¼šåšè¯¦ç»†çš„ä»‹ç»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="åˆå§‹åŒ–ç¯å¢ƒ"></a>åˆå§‹åŒ–ç¯å¢ƒ<a class="hash-link" href="#åˆå§‹åŒ–ç¯å¢ƒ" title="Direct link to heading">#</a></h3><ul><li>æ‹‰å–ä»£ç </li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>è®¾ç½®è·³è¿‡æ ‡å¿—</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set Skip Env Var</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./.github/actions/skip</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ci</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“å‘ç”Ÿçš„æ˜¯ä¸€äº›å¯¹åŠŸèƒ½æ— å…³çš„æ”¹åŠ¨ï¼ˆå¦‚æ”¹åŠ¨æ–‡æ¡£ï¼‰æ—¶ï¼Œä¼šè·³è¿‡é›†æˆæµ‹è¯•ï¼Œä»¥èŠ‚çº¦èµ„æºã€‚</p><ul><li>ç¼“å­˜mavenä¾èµ–ã€å®‰è£…Java</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cache Maven Repos</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ„å»ºæ•´ä¸ªé¡¹ç›®åŒæ—¶æ„å»ºdockeré•œåƒ"></a>æ„å»ºæ•´ä¸ªé¡¹ç›®ï¼ŒåŒæ—¶æ„å»ºdockeré•œåƒ<a class="hash-link" href="#æ„å»ºæ•´ä¸ªé¡¹ç›®åŒæ—¶æ„å»ºdockeré•œåƒ" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">./mvnw -B clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Prelease,docker -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Dmaven.test.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸Šé¢è¿™è¡Œå‘½ä»¤ä¸­ï¼Œ-Påé¢è·Ÿç€<code>release,docker</code>ï¼Œè¡¨ç¤ºä¼šæ¿€æ´»pomæ–‡ä»¶ä¸­ç›¸å…³çš„profileé…ç½®ã€‚</p><p>è€Œreleaseå’Œdockerè¿™ä¸¤ä¸ªprofileï¼Œç›®å‰åªåœ¨ <code>shenyu-dist</code> ä¸‹çš„å‡ ä¸ªå­æ¨¡å—ä¸­å­˜åœ¨ã€‚ä¸‹é¢å°†ä»¥ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-dist/shenyu-admin-dist" target="_blank" rel="noopener noreferrer">shenyu-dist-admin</a> æ¨¡å—ä¸ºä¾‹ï¼Œä»‹ç»profileä¸ºreleaseå’Œdockerçš„é…ç½®çš„å…·ä½“å†…å®¹ã€‚å¦å¤–ï¼Œé›†æˆæµ‹è¯•åªä½¿ç”¨äº†è¿™ä¸€æ­¥æ„å»ºçš„ <code>shenyu-admin</code> é•œåƒã€‚</p><ul><li><p>é¦–å…ˆæ˜¯release</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">release</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.maven.plugins</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven-assembly-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">package</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">single</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.basedir}/src/main/assembly/binary.xml</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">posix</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“-Påé¢è·Ÿç€releaseæ—¶ï¼Œå°±ä¼šæ¿€æ´»ä¸Šé¢çš„ <code>maven-assembly-plugin</code> æ’ä»¶ã€‚è€Œexecutionsä¸­å°†æ’ä»¶çš„æ‰§è¡Œæ—¶æœºç»‘å®šåœ¨äº†mavenç”Ÿå‘½å‘¨æœŸpackageä¸­ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ <code>mvn install</code> çš„æ—¶å€™å°±ä¼šè§¦å‘ã€‚</p><p>configurationä¸­æŒ‡å®šäº†æˆ‘ä»¬ç¼–å†™å¥½çš„ <code>binary.xml</code>ï¼Œ<code>maven-assembly-plugin</code> æ’ä»¶å°†ä¼šæŒ‰ç…§è¿™ä¸ªæ–‡ä»¶ï¼Œå°†éœ€è¦çš„æ–‡ä»¶å¤åˆ¶è¿›æ¥ï¼Œå¹¶æ‰“åŒ…ã€‚ä½ å¯ä»¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹è¯¥æ–‡ä»¶ï¼š<a href="https://github.com/apache/incubator-shenyu/blob/master/shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml" target="_blank" rel="noopener noreferrer">shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml</a></p><p>æ ¹æ®è¿™ä¸ªæ–‡ä»¶ï¼Œæ’ä»¶ä¼šå°†å…¶ä»–æ¨¡å—ä¸‹æ‰“åŒ…å¥½çš„jaråŒ…ã€é…ç½®æ–‡ä»¶ã€å¯åŠ¨è„šæœ¬ç­‰â€œå¤åˆ¶â€è¿‡æ¥ï¼Œæœ€ç»ˆæ‰“æˆ <code>tar.gz</code> æ ¼å¼çš„å‹ç¼©åŒ…ã€‚</p></li><li><p>ç„¶åæ˜¯docker</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">docker</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.spotify</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dockerfile-maven-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${dockerfile-maven-plugin.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-version</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache/shenyu-admin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}-admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç±»æ¯”ä¸Šé¢çš„releaseï¼Œè¿™é‡Œæ˜¯æ¿€æ´» <code>dockerfile-maven-plugin</code> æ’ä»¶ã€‚å½“ <code>mvn install -Pdocker</code> æ—¶ï¼Œæ’ä»¶å°±ä¼šåˆ©ç”¨æˆ‘ä»¬ç¼–å†™å¥½çš„dockerfileæ„å»ºdockeré•œåƒã€‚</p></li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdockerfile-maven-pluginç›®å‰å¯¹aarch64æ¶æ„çš„è®¾å¤‡æ”¯æŒæœ‰é™ï¼Œåœ¨aarch64æ¶æ„çš„æœºå™¨ä¸Šè¿è¡Œè¯¥æ’ä»¶æ—¶ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ã€‚ä¸”åœ¨æœ¬äººå†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å·²ç»å¾ˆä¹…æ²¡æœ‰ç»´æŠ¤ï¼Œè¿™æ„å‘³ç€aarch64æ¶æ„çš„è®¾å¤‡ä½¿ç”¨è¿™ä¸ªæ’ä»¶çš„é—®é¢˜åœ¨çŸ­æœŸå†…ä¸ä¼šè§£å†³ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Failed to execute goal com.spotify:dockerfile-maven-plugin:1.4.6:build </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tag-latest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> on project shenyu-admin-dist: Could not build image: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: java.lang.UnsatisfiedLinkError: could not load FFI provider jnr.ffi.provider.jffi.Provider: ExceptionInInitializerError: Can&#x27;t overwrite cause with java.lang.UnsatisfiedLinkError: java.lang.UnsatisfiedLinkError: /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: dlopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib, </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: no suitable image found.  Did find:</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œæœ‰ä¸ªä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆï¼š</p><ol><li><p>æ‰“å¼€ä¸€ä¸ªæ–°çš„shellï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œåˆ©ç”¨ socat å°† unix socket è·¯ç”±åˆ° tcp ç«¯å£</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">socat TCP-LISTEN:2375,range</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1/32,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>è®¾ç½®ç¯å¢ƒå˜é‡</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">DOCKER_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tcp://127.0.0.1:2375</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ„å»ºexamplesæ¨¡å—"></a>æ„å»ºexamplesæ¨¡å—<a class="hash-link" href="#æ„å»ºexamplesæ¨¡å—" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build examples</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pexample </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.javadoc.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.test.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å› ä¸ºè€ƒè™‘åˆ°releaseçš„éœ€è¦ï¼Œç›®å‰é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„pomæ–‡ä»¶ä¸­ä¸é¥±å«exampleå­æ¨¡å—ï¼Œæ‰€ä»¥ä¸Šé¢è¿™ä¸ªæ­¥éª¤å¦å¤–æ„å»ºäº†examplesæ¨¡å—ã€‚</p><p>ä¸ä¸Šé¢ç±»ä¼¼ï¼Œè¿™è¡Œå‘½ä»¤ä¹Ÿä¼šåˆ©ç”¨mavençš„æ’ä»¶æ„å»ºé•œåƒï¼Œä»¥ä¾›æˆ‘ä»¬åç»­dockerç¼–æ’ä½¿ç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ„å»ºå®šåˆ¶åŒ–ç½‘å…³"></a>æ„å»ºå®šåˆ¶åŒ–ç½‘å…³<a class="hash-link" href="#æ„å»ºå®šåˆ¶åŒ–ç½‘å…³" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build integrated tests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">DskipTests </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸ºäº†ç»†åˆ†Apache ShenYuçš„ä¸åŒåŠŸèƒ½çš„é›†æˆæµ‹è¯•ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸€æ­¥å°†æ„å»ºé›†æˆæµ‹è¯•æ¨¡å—å®šåˆ¶çš„ç½‘å…³ã€‚æ‰€è°“çš„â€œå®šåˆ¶â€å°±æ˜¯åœ¨pomæ–‡ä»¶ä¸­å¼•å…¥éœ€è¦çš„æœ€å°‘ä¾èµ–ï¼Œç„¶åä»£æ›¿é»˜è®¤çš„ <code>shenyu-bootstrap</code>ã€‚ä¸ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤ç±»ä¼¼ï¼Œè¿™ä¸€æ­¥ä¹Ÿä¼šæ„å»ºå‡ºdockeré•œåƒã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„æ‰“åŒ…æ„å»ºçš„æ–¹å¼ä¸ <code>shenyu-dist</code> æ¨¡å—çš„æœ‰ä¸€äº›ä¸åŒï¼Œä½ å¯ä»¥é€šè¿‡å¯¹æ¯”pomæ–‡ä»¶å‘ç°ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è¿è¡Œdocker-compose"></a>è¿è¡Œdocker compose<a class="hash-link" href="#è¿è¡Œdocker-compose" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Start docker compose</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose.yml up </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">d</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸€æ­¥å°†ä¼šæ ¹æ®é›†æˆæµ‹è¯•æ¨¡å—ä¸‹ç¼–å†™å¥½çš„ä¸åŒçš„ <code>docker-compose.yml</code> æ–‡ä»¶ï¼Œè¿›è¡Œdockerç¼–æ’ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3.9&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-zk</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">6.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpine</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">redis</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-examples-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2048M</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-integrated-test-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">condition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service_healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">healthcheck</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CMD&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;wget&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://shenyu-integrated-test-http:9195/actuator/health&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">retries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¾‹å¦‚ <code>shenyu-integrated-test-http</code> æ¨¡å—ä¸‹çš„ <code>docker-compose.yml</code>ï¼ŒæŒ‰é¡ºåºå¯åŠ¨äº†zookeeperã€redisã€exampleã€adminã€ç½‘å…³ç­‰æœåŠ¡ã€‚å…¶ä¸­ï¼Œexampleã€adminã€ç½‘å…³çš„é•œåƒæ˜¯æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„ã€‚</p><p>å…¶ä¸­ï¼Œdocker-composeåˆ©ç”¨ <code>depends_on</code> ç¡®å®šäº†æœåŠ¡ä¹‹é—´çš„æ‹“æ‰‘å…³ç³»ï¼Œå¹¶ä¸”å¤§éƒ¨åˆ†æœåŠ¡éƒ½æœ‰ç›¸åº”çš„å¥åº·æ£€æŸ¥ï¼Œå¾…å¥åº·æ£€æŸ¥é€šè¿‡åæ‰ä¼šå¯åŠ¨ä¸‹ä¸€ä¸ªæœåŠ¡ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è¿è¡Œå¥åº·æ£€æŸ¥ç­‰å¾…docker-composeå¯åŠ¨å®Œæ¯•"></a>è¿è¡Œå¥åº·æ£€æŸ¥ï¼Œç­‰å¾…docker-composeå¯åŠ¨å®Œæ¯•<a class="hash-link" href="#è¿è¡Œå¥åº·æ£€æŸ¥ç­‰å¾…docker-composeå¯åŠ¨å®Œæ¯•" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Wait for docker compose start up completely</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/script/healthcheck.sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨è¿™ä¸€æ­¥ï¼Œå®¿ä¸»æœºä¼šè¿è¡Œ <code>healthcheck.sh</code> è¿™ä¸ªè„šæœ¬ï¼Œç„¶ååˆ©ç”¨ curl å‘½ä»¤è®¿é—®å„ä¸ªæœåŠ¡åˆ—è¡¨ï¼ˆåœ¨services.listæ–‡ä»¶ä¸­ï¼‰çš„å¥åº·çŠ¶æ€æ¥å£ <code>/actuator/health</code>ï¼Œä¸€ç›´åˆ°æœåŠ¡çŠ¶æ€éƒ½ä¸ºæ­£å¸¸æ‰ä¼šç»§ç»­ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è¿è¡Œæµ‹è¯•"></a>è¿è¡Œæµ‹è¯•<a class="hash-link" href="#è¿è¡Œæµ‹è¯•" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw test </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/pom.xml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">continue-on-error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸€æ­¥å°±æ˜¯åˆ©ç”¨maven testå‘½ä»¤ï¼Œé€ä¸ªæ‰§è¡Œ <code>/src/test/</code>  ç›®å½•ä¸‹çš„æµ‹è¯•ç±»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æŸ¥çœ‹docker-composeæ—¥å¿—"></a>æŸ¥çœ‹Docker Composeæ—¥å¿—<a class="hash-link" href="#æŸ¥çœ‹docker-composeæ—¥å¿—" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Check test result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    docker-compose -f ./shenyu-integrated-test/${{ matrix.case }}/docker-compose.yml logs --tail=&quot;all&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    if [[ ${{steps.test.outcome}} == &quot;failure&quot; ]]; then</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Failed&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 1</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    else</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Successful&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 0</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    fi</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“å·¥ä½œæµå‡ºç°é”™è¯¯æ—¶ï¼Œdocker composeçš„æ—¥å¿—å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„æ’æŸ¥é—®é¢˜ï¼Œæ‰€ä»¥åœ¨è¿™ä¸€æ­¥æˆ‘ä»¬å°†docker composeçš„æ—¥å¿—æ‰“å°å‡ºæ¥ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/integration-test">Integration Test</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/E2eTest-Analysis">e2eæµ‹è¯•è¯¦è§£</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.462Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/HaiqiQin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/80969210?v=4" alt="Haiqi Qin"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/HaiqiQin" target="_blank" rel="noopener noreferrer">Haiqi Qin</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>è¿™ç¯‡æ–‡ç« å°†ä¼šå¯¹Apache ShenYuçš„e2eæ¨¡å—è¿›è¡Œæ·±å…¥å‰–æã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»€ä¹ˆæ˜¯e2e"></a>ä»€ä¹ˆæ˜¯e2e<a class="hash-link" href="#ä»€ä¹ˆæ˜¯e2e" title="Direct link to heading">#</a></h3><p>e2e(end to end)ï¼Œä¹Ÿå«ç«¯åˆ°ç«¯æµ‹è¯•ï¼Œæ˜¯ä¸€ç§ç”¨äºæµ‹è¯•åº”ç”¨ç¨‹åºæµæ˜¯å¦ä»å¤´åˆ°å°¾æŒ‰è®¾è®¡æ‰§è¡Œçš„æ–¹æ³•ã€‚ æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•çš„ç›®çš„æ˜¯è¯†åˆ«ç³»ç»Ÿä¾èµ–å…³ç³»ï¼Œå¹¶ç¡®ä¿åœ¨å„ç§ç³»ç»Ÿç»„ä»¶å’Œç³»ç»Ÿä¹‹é—´ä¼ é€’æ­£ç¡®çš„ä¿¡æ¯ã€‚ç«¯åˆ°ç«¯æµ‹è¯•çš„ç›®çš„æ˜¯æµ‹è¯• æ•´ä¸ªè½¯ä»¶çš„ä¾èµ–æ€§ã€æ•°æ®å®Œæ•´æ€§ä»¥åŠä¸å…¶ä»–ç³»ç»Ÿã€æ¥å£å’Œæ•°æ®åº“çš„é€šä¿¡ï¼Œä»¥æ¨¡æ‹Ÿå®Œæ•´çš„ç”Ÿäº§åœºæ™¯ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="e2eçš„ä¼˜åŠ¿"></a>e2eçš„ä¼˜åŠ¿<a class="hash-link" href="#e2eçš„ä¼˜åŠ¿" title="Direct link to heading">#</a></h3><p>e2eæµ‹è¯•èƒ½å¤Ÿæ¨¡æ‹ŸçœŸå®ç”¨æˆ·åœºæ™¯ä¸‹æµ‹è¯•è½¯ä»¶ç³»ç»Ÿçš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§ï¼Œèƒ½å¤ŸéªŒè¯æ•´ä¸ªç³»ç»Ÿæ˜¯å¦æŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œä»¥åŠä¸åŒç»„ä»¶æ˜¯å¦èƒ½å¤ŸååŒå·¥ä½œã€‚ e2eæµ‹è¯•æœ‰ä»¥ä¸‹å‡ ä¸ªå¥½å¤„:</p><ol><li>å¸®åŠ©ä¿è¯ç³»ç»ŸåŠŸèƒ½çš„æ­£ç¡®æ€§ï¼še2eæµ‹è¯•èƒ½å¤Ÿæ¨¡æ‹ŸçœŸå®ç”¨æˆ·åœºæ™¯ä¸‹çš„äº¤äº’å’Œæ“ä½œï¼ŒéªŒè¯æ•´ä¸ªç³»ç»Ÿæ˜¯å¦èƒ½å¤ŸæŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œå¸®åŠ©å‘ç°ç³»ç»Ÿä¸­çš„æ½œåœ¨é—®é¢˜å’Œç¼ºé™·ã€‚</li><li>æé«˜æµ‹è¯•è¦†ç›–ç‡ï¼še2eæµ‹è¯•èƒ½å¤Ÿè¦†ç›–æ•´ä¸ªç³»ç»Ÿï¼ŒåŒ…æ‹¬å‰ç«¯ã€åç«¯ã€æ•°æ®åº“ç­‰ä¸åŒå±‚é¢å’Œç»„ä»¶ï¼Œä»è€Œæé«˜æµ‹è¯•è¦†ç›–ç‡ï¼Œä¿è¯æµ‹è¯•çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§ã€‚</li><li>ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼šE2Eæµ‹è¯•å¯ä»¥æ£€æŸ¥ç³»ç»Ÿåœ¨å„ç§æƒ…å†µä¸‹çš„ç¨³å®šæ€§å’Œå¥å£®æ€§ï¼ŒåŒ…æ‹¬ç³»ç»Ÿçš„å“åº”æ—¶é—´ã€é”™è¯¯å¤„ç†èƒ½åŠ›ã€å¹¶å‘æ€§ç­‰æ–¹é¢ï¼Œå¸®åŠ©ç¡®ä¿ç³»ç»Ÿåœ¨é¢å¯¹é«˜è´Ÿè½½å’Œå¼‚å¸¸æƒ…å†µæ—¶ä»ç„¶èƒ½å¤Ÿä¿æŒç¨³å®šè¿è¡Œã€‚</li><li>å‡å°‘æµ‹è¯•æˆæœ¬ï¼še2eæµ‹è¯•èƒ½å¤Ÿæé«˜æµ‹è¯•æ•ˆç‡å’Œå‡†ç¡®æ€§ï¼Œå‡å°‘æµ‹è¯•æˆæœ¬å’Œæ—¶é—´ï¼Œä»è€Œå¸®åŠ©ä¼ä¸šæ›´å¿«é€Ÿåœ°å‘å¸ƒå’Œäº¤ä»˜é«˜è´¨é‡çš„è½¯ä»¶äº§å“ã€‚</li></ol><p>æ€»ä¹‹ï¼Œe2eæµ‹è¯•æ˜¯ä¸€ç§å…¨é¢çš„æµ‹è¯•æ–¹å¼ï¼Œèƒ½å¤ŸéªŒè¯æ•´ä¸ªç³»ç»Ÿæ˜¯å¦æŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œæé«˜æµ‹è¯•è¦†ç›–ç‡å’Œæµ‹è¯•æ•ˆç‡ï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ­£ç¡®æ€§ï¼Œå‡å°‘æµ‹è¯•æˆæœ¬å’Œæ—¶é—´ï¼Œæ˜¯ä¸€ç§éå¸¸é‡è¦å’Œæœ‰æ•ˆçš„æµ‹è¯•æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®Œå–„ e2eç›¸å…³ä»£ç ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è‡ªåŠ¨åŒ–e2eæµ‹è¯•å¦‚ä½•å®ç°"></a>è‡ªåŠ¨åŒ–e2eæµ‹è¯•å¦‚ä½•å®ç°<a class="hash-link" href="#è‡ªåŠ¨åŒ–e2eæµ‹è¯•å¦‚ä½•å®ç°" title="Direct link to heading">#</a></h3><p>åœ¨Apache ShenYuä¸­ï¼Œe2eæµ‹è¯•çš„ä¸»è¦æ­¥éª¤ä½“ç°åœ¨GitHub Actionå·¥ä½œæµçš„è„šæœ¬ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¯¥è„šæœ¬ä½äº <a href="https://github.com/apache/incubator-shenyu/tree/master/.github/workflows" target="_blank" rel="noopener noreferrer">~/.github/workflows</a>ç›®å½•ä¸‹çš„e2eæ–‡ä»¶ä¸­ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> e2e</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> master</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">changes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build-docker-images</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">e2e-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">e2e-case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">needs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">images</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> needs.changes.outputs.e2e == &#x27;true&#x27; </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matrix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-e2e-case-spring-cloud&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-e2e-case-apache-dubbo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-e2e-case-sofa&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Load ShenYu Docker Images</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          docker load --input /tmp/apache-shenyu-admin.tar</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          docker load --input /tmp/apache-shenyu-bootstrap.tar</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          docker image ls -a</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build examples with Maven</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pexample </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.javadoc.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.test.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples/pom.xml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run ShenYu E2E Tests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mysql</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          bash ./shenyu-e2e/script/storage_init.sh</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          ./mvnw -B -f ./shenyu-e2e/pom.xml -pl shenyu-e2e-case/${{ matrix.case }} -Dstorage=mysql test</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“å·¥ä½œæµè§¦å‘æ—¶ï¼Œä½¿ç”¨shenyu-distæ¨¡å—ä¸‹çš„dockerfileæ–‡ä»¶æ„å»ºadminä¸bootstrapé¡¹ç›®çš„é•œåƒå¹¶ä¸Šä¼ ï¼Œå½“e2eæµ‹è¯•æ¨¡å—è¿è¡Œæ—¶å¯ä»¥åŠ è½½adminä¸bootstrapé•œåƒã€‚ç´§æ¥ç€æ„å»ºexamplesä¸­çš„æ¨¡å—ï¼Œæœ€åæ‰§è¡Œå¯¹åº”æµ‹è¯•æ¨¡å—çš„æµ‹è¯•æ–¹æ³•ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æœ¬åœ°å¦‚ä½•è¿è¡Œe2eæµ‹è¯•"></a>æœ¬åœ°å¦‚ä½•è¿è¡Œe2eæµ‹è¯•<a class="hash-link" href="#æœ¬åœ°å¦‚ä½•è¿è¡Œe2eæµ‹è¯•" title="Direct link to heading">#</a></h3><p>å¦‚æœéœ€è¦ç¼–å†™e2eæµ‹è¯•ç”¨ä¾‹ï¼Œé¦–å…ˆéœ€è¦åœ¨æœ¬åœ°ç¼–ç å¹¶è°ƒè¯•ã€‚ç›®å‰e2eæ”¯æŒä¸¤ç§å¯åŠ¨æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯dockerå¯åŠ¨ï¼Œå¦ä¸€ä¸ªæ˜¯hostå¯åŠ¨ã€‚è¿™ä¸¤ç§æ¨¡å¼å¯ä»¥é€šè¿‡åœ¨æµ‹è¯•ç±»ä¸­çš„@ShenYuTestæ³¨è§£ä¸­åˆ‡æ¢ã€‚hostå¯åŠ¨æ–¹å¼ç›´æ¥åœ¨æœ¬åœ°å°†éœ€è¦å¯åŠ¨çš„æœåŠ¡ç›´æ¥å¯åŠ¨å³å¯è¿è¡Œæµ‹è¯•ä»£ç ã€‚é‡‡ç”¨dockerè¿›è¡Œå¯åŠ¨å‰ï¼Œéœ€è¦åœ¨å…ˆæ„å»ºå‡ºç›¸åº”é•œåƒã€‚å› ä¸ºShenYuç›®å‰éœ€è¦æ”¯æŒåœ¨githubå·¥ä½œæµè¿›è¡Œe2eæµ‹è¯•ï¼Œå»ºè®®é‡‡ç”¨dockerå¯åŠ¨æ–¹å¼ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="e2eå¯åŠ¨æµç¨‹å‰–æ"></a>e2eå¯åŠ¨æµç¨‹å‰–æ<a class="hash-link" href="#e2eå¯åŠ¨æµç¨‹å‰–æ" title="Direct link to heading">#</a></h3><p>ç›®å‰e2eæ¨¡å—ä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«ä¸ºï¼šcaseã€clientã€commonä»¥åŠengineã€‚</p><p><img alt="e2e-modules" src="/zh/assets/images/e2e-modules-1ff1ff840f0fe5a53970e750624f61b6.png"></p><p>caseæ¨¡å—å­˜æ”¾æ’ä»¶çš„æµ‹è¯•ç”¨ä¾‹ï¼Œclientæ¨¡å—ç¼–å†™äº†adminä¸gatewayçš„å®¢æˆ·ç«¯ï¼Œä»¥ä¾¿è¯·æ±‚å¯¹åº”æ¥å£ã€‚commonå­˜æ”¾ä¸€äº›å…¬å…±ç±»ï¼Œengineæ¨¡å—æ˜¯æ¡†æ¶çš„æ ¸å¿ƒï¼Œä¾æ‰˜testcontaineræ¡†æ¶åˆ©ç”¨javaä»£ç å¯åŠ¨dockerå®¹å™¨å¹¶å®Œæˆå¯¹adminä»¥åŠgatewatçš„é…ç½®æ“ä½œã€‚</p><p>æ¥ä¸‹æ¥æˆ‘å°†ä¾æ‰˜æºç å¯¹e2eå¯åŠ¨æµç¨‹è¿›è¡Œå‰–æã€‚</p><p>å½“æˆ‘ä»¬æ‰§è¡Œcaseä¸­çš„æµ‹è¯•æ–¹æ³•æ—¶ï¼Œ@ShenYuTestæ³¨è§£å°†ä¼šç”Ÿæ•ˆï¼Œå¯¹æµ‹è¯•ç±»è¿›è¡Œæ‰©å±•ã€‚é€šè¿‡@ShenYuTestï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å¯åŠ¨æ–¹æ³•ã€å¯¹adminä»¥åŠgatewayé…ç½®ç›¸å…³å‚æ•°ï¼Œä»¥åŠé€‰æ‹©å°†è¦æ‰§è¡Œçš„docker-composeæ–‡ä»¶ã€‚å¯¹äºadminä»¥åŠgatewayï¼Œå¯ä»¥é…ç½®ç™»é™†æ‰€éœ€çš„ç”¨æˆ·åã€å¯†ç ã€æ•°æ®åŒæ­¥æ–¹å¼ä»¥åŠä¿®æ”¹yamlçš„å†…å®¹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@ShenYuTest(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mode = ShenYuEngineConfigure.Mode.DOCKER,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        services = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @ShenYuTest.ServiceConfigure(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        serviceName = &quot;admin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        port = 9095,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        baseUrl = &quot;http://{hostname:localhost}:9095&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        parameters = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @ShenYuTest.Parameter(key = &quot;username&quot;, value = &quot;admin&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @ShenYuTest.Parameter(key = &quot;password&quot;, value = &quot;123456&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @ShenYuTest.Parameter(key = &quot;dataSyn&quot;, value = &quot;admin_websocket&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @ShenYuTest.ServiceConfigure(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        serviceName = &quot;gateway&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        port = 9195,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        baseUrl = &quot;http://{hostname:localhost}:9195&quot;, </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        type = ShenYuEngineConfigure.ServiceType.SHENYU_GATEWAY,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        parameters = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          @ShenYuTest.Parameter(key = &quot;application&quot;, value =  &quot;spring.cloud.discovery.enabled:true,eureka.client.enabled:true&quot;), </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          @ShenYuTest.Parameter(key = &quot;dataSyn&quot;, value = &quot;gateway_websocket&quot;)})},           dockerComposeFile = &quot;classpath:./docker-compose.mysql.yml&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>@ShenYuTesté€šè¿‡ShenYuExtensionç±»è¿›è¡Œæ‰©å±•ï¼Œå¯¹adminä¸gatewayçš„é…ç½®åœ¨ShenYuExtensionä¸­çš„beforeAllä¸­ç”Ÿæ•ˆã€‚å…·ä½“çš„ç”Ÿæ•ˆé€»è¾‘åœ¨DockerServiceComposeç±»ä¸­å®ç°ã€‚</p><p><img alt="e2e-shenyutest" src="/zh/assets/images/e2e-shenyutest-8ea26c9ea373d2c182be8d19c53cb021.png"></p><p><img alt="e2e-beforeall" src="/zh/assets/images/e2e-beforeall-51fdb9d49dbc3eae99f77268b0e1a5c9.png"></p><p>@ShenYuTesté…ç½®é¡¹åœ¨dockerå¯åŠ¨å‰ç”Ÿæ•ˆï¼Œä¸»è¦é€šè¿‡ä¿®æ”¹æµ‹è¯•æ¨¡å—ä¸­resourceç›®å½•ä¸‹çš„yamlæ–‡ä»¶ã€‚ç›®å‰e2eæ”¯æŒå¯¹ä¸åŒæ•°æ®åŒæ­¥æ–¹å¼è¿›è¡Œæµ‹è¯•ï¼Œå…¶åŸç†å°±æ˜¯é€šè¿‡DockerServiceComposeç±»ä¸­çš„chooseDataSynæ–¹æ³•ã€‚åœ¨DataSyncHandlerä¸­å¯¹å„ç§æ•°æ®åŒæ­¥æ–¹å¼éœ€è¦ä¿®æ”¹çš„å†…å®¹è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åå¯åŠ¨containerã€‚</p><p><img alt="e2e-docer-service-compose" src="/zh/assets/images/e2e-docer-service-compose-ac329d9290f48407e5c8310031913fb2.png"></p><p><img alt="e2e-datahandle-syn" src="/zh/assets/images/e2e-datahandle-syn-92a7b3dc57bc8b46972128042b8281cb.png"></p><p>å½“dockerå¯åŠ¨å®Œåï¼Œå¼€å§‹å¯¹æ’ä»¶åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚åœ¨PluginsTestç±»ä¸­ï¼Œæœ‰é’ˆå¯¹æµ‹è¯•è¿›è¡Œçš„å‰ç½®ä»¥åŠåç½®æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @BeforeAll</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void setup(final AdminClient adminClient, final GatewayClient gatewayClient) throws InterruptedException, JsonProcessingException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        adminClient.login();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread.sleep(10000);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorDTO&gt; selectorDTOList = adminClient.listAllSelectors();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;MetaDataDTO&gt; metaDataDTOList = adminClient.listAllMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleDTO&gt; ruleDTOList = adminClient.listAllRules();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(2, selectorDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(13, metaDataDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(14, ruleDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorDTO selectorDTO : selectorDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorDTO.getHandle() != null &amp;&amp; !&quot;&quot;.equals(selectorDTO.getHandle())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SpringCloudPluginCases.verifierUri(selectorDTO.getHandle());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;MetaData&gt; metaDataCacheList = gatewayClient.getMetaDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorCacheData&gt; selectorCacheList = gatewayClient.getSelectorCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleCacheData&gt; ruleCacheList = gatewayClient.getRuleCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(2, selectorCacheList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(13, metaDataCacheList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(14, ruleCacheList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MultiValueMap&lt;String, String&gt; formData = new LinkedMultiValueMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;id&quot;, &quot;8&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;name&quot;, &quot;springCloud&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;enabled&quot;, &quot;true&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;role&quot;, &quot;Proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;sort&quot;, &quot;200&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        adminClient.changePluginStatus(&quot;8&quot;, formData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String id = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorDTO selectorDTO : selectorDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!&quot;&quot;.equals(selectorDTO.getHandle())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                id = selectorDTO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        adminClient.deleteSelectors(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTOList = adminClient.listAllSelectors();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(1, selectorDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»¥springcloudæ’ä»¶ä¸ºä¾‹ï¼Œé¦–å…ˆéœ€è¦æµ‹è¯•æ³¨å†Œä¸­å¿ƒä»¥åŠæ•°æ®åŒæ­¥èƒ½å¦æ­£å¸¸å·¥ä½œï¼Œæ¥ç€å¯åŠ¨æ’ä»¶å¹¶åˆ é™¤å·²å­˜åœ¨çš„é€‰æ‹©å™¨ã€‚æµ‹è¯•æ•°æ®æ˜¯å¦æˆåŠŸæ³¨å†Œè¿›æ³¨å†Œä¸­å¿ƒï¼Œå¯ä»¥è°ƒç”¨adminå®¢æˆ·ç«¯çš„æ¥å£è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•æ•°æ®åŒæ­¥æ˜¯å¦æˆåŠŸï¼Œå¯ä»¥è·å–gatewayçš„ç¼“å­˜è¿›è¡Œæµ‹è¯•ã€‚</p><p>æ¥ç€è¿è¡Œcaseæ–‡ä»¶ä¸­çš„æµ‹è¯•ç”¨ä¾‹ï¼Œé€šè¿‡@ShenYuScenarioè·å–ç”¨ä¾‹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenYuScenario(provider = SpringCloudPluginCases.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void testSpringCloud(GatewayClient gateway, CaseSpec spec) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec.getVerifiers().forEach(verifier -&gt; verifier.verify(gateway.getHttpRequesterSupplier().get()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é’ˆå¯¹ä¸åŒçš„æ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºCaseç±»ï¼Œå­˜æ”¾è¦æµ‹è¯•çš„è§„åˆ™ã€‚æ‰€æœ‰çš„æµ‹è¯•è§„åˆ™å­˜æ”¾è¿›listä¸­ï¼ŒæŒ‰é¡ºåºè¿›è¡Œæµ‹è¯•ã€‚beforeEachSpecä¸­è¿›è¡Œæ„å»ºé€‰æ‹©å™¨ä¸è§„åˆ™ï¼ŒcaseSpecå­˜æ”¾æµ‹è¯•å®ä½“ï¼Œå¦‚æœç¬¦åˆuriè§„åˆ™çš„åº”å­˜åœ¨ï¼Œå¦åˆ™ä¸å­˜åœ¨ã€‚æˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿç”¨æˆ·å¯¹é€‰æ‹©å™¨å’Œè§„åˆ™è¿›è¡Œæ–°å¢ï¼Œå› ä¸ºå„ä¸ªæ’ä»¶çš„é€‰æ‹©å™¨çš„handlerè§„åˆ™ä¸ä¸€å®šç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®æ’ä»¶éœ€æ±‚å»ç¼–å†™å…¶handleç±»ã€‚å¹¶é€šè¿‡è¯·æ±‚éªŒè¯å…¶ç¬¦åˆè§„åˆ™ã€‚å…·ä½“æµ‹è¯•ç”¨ä¾‹ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œä¸€ç±»æ˜¯å¯¹uriè§„åˆ™è¿›è¡ŒåŒ¹é…ï¼Œæ¯”å¦‚euqalã€path_patternã€start_withã€end_withï¼Œä¸€ç±»æ˜¯è¯·æ±‚ç±»å‹ï¼Œæ¯”å¦‚getã€putã€postã€deleteã€‚</p><p>å½“å…«ç§åŒ¹é…æƒ…å†µéƒ½æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥åˆ¤æ–­è¯¥æ’ä»¶åŠŸèƒ½æ­£å¸¸ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•ç»“æŸåéœ€è¦æ¢å¤ç¯å¢ƒï¼Œå°†æ‰€æœ‰çš„é€‰æ‹©å™¨åˆ é™¤ï¼Œå°†è¯¥æ’ä»¶è®¾ç½®ä¸ºä¸å¯ç”¨ï¼Œæœ€åå…³é—­æ‰€æœ‰å®¹å™¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;ScenarioSpec&gt; get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Lists.newArrayList(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithUriEquals(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithUriPathPattern(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithUriStartWith(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithEndWith(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodGet(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodPost(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodPut(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodDelete()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenYuScenarioSpec testWithUriEquals() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenYuScenarioSpec.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(&quot;single-spring-cloud uri =]&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .beforeEachSpec(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenYuBeforeEachSpec.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addSelectorAndRule(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        newSelectorBuilder(&quot;selector&quot;, Plugin.SPRING_CLOUD)                                               .handle(SpringCloudSelectorHandle.builder().serviceId(&quot;springCloud-test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        .gray(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        .divideUpstreams(DIVIDE_UPSTREAMS)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        .build())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .conditionList(newConditions(Condition.ParamType.URI, Condition.Operator.EQUAL, TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .build(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        newRuleBuilder(&quot;rule&quot;)                               .handle(SpringCloudRuleHandle.builder().loadBalance(&quot;hash&quot;).timeout(3000).build())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .conditionList(newConditions(Condition.ParamType.URI, Condition.Operator.EQUAL, TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                )</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .checker(notExists(TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .waiting(exists(TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .caseSpec(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenYuCaseSpec.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addExists(TEST)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addNotExists(&quot;/springcloud/te&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addNotExists(&quot;/put&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addNotExists(&quot;/get&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .afterEachSpec(ShenYuAfterEachSpec.DEFAULT)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/e-2-e-test">E2e Test</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeperæ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.462Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>Etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>ZooKeeper</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-å…³äºzookeeper"></a>1. å…³äºZooKeeper<a class="hash-link" href="#1-å…³äºzookeeper" title="Direct link to heading">#</a></h3><p><a href="https://zh.wikipedia.org/wiki/Apache_ZooKeeper" target="_blank" rel="noopener noreferrer"><code>Apache ZooKeeper</code></a>æ˜¯<code>Apache</code>è½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€ä¸ªè½¯ä»¶é¡¹ç›®ï¼Œå®ƒä¸ºå¤§å‹åˆ†å¸ƒå¼è®¡ç®—æä¾›å¼€æºçš„åˆ†å¸ƒå¼é…ç½®æœåŠ¡ã€åŒæ­¥æœåŠ¡å’Œå‘½åæ³¨å†Œã€‚<code>ZooKeeper</code>èŠ‚ç‚¹å°†å®ƒä»¬çš„æ•°æ®å­˜å‚¨äºä¸€ä¸ªåˆ†å±‚çš„åå­—ç©ºé—´ï¼Œéå¸¸ç±»ä¼¼äºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæˆ–ä¸€ä¸ªå‰ç¼€æ ‘ç»“æ„ã€‚å®¢æˆ·ç«¯å¯ä»¥åœ¨èŠ‚ç‚¹è¯»å†™ï¼Œä»è€Œä»¥è¿™ç§æ–¹å¼æ‹¥æœ‰ä¸€ä¸ªå…±äº«çš„é…ç½®æœåŠ¡ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-adminæ•°æ®åŒæ­¥"></a>2. Adminæ•°æ®åŒæ­¥<a class="hash-link" href="#2-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªå®é™…æ¡ˆä¾‹è¿›è¡Œæºç è¿½è¸ªï¼Œæ¯”å¦‚åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼š</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶æ•°æ®"></a>2.1 æ¥æ”¶æ•°æ®<a class="hash-link" href="#21-æ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>è¿›å…¥<code>SelectorController</code>ç±»ä¸­çš„<code>updateSelector()</code>æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ•°æ®çš„æ ¡éªŒï¼Œæ·»åŠ æˆ–æ›´æ–°æ•°æ®ï¼Œè¿”å›ç»“æœä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®å½“å‰é€‰æ‹©å™¨æ•°æ®id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæˆ–æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿”å›ç»“æœä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å¤„ç†æ•°æ®"></a>2.2 å¤„ç†æ•°æ®<a class="hash-link" href="#22-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>åœ¨<code>SelectorServiceImpl</code>ç±»ä¸­é€šè¿‡<code>createOrUpdate()</code>æ–¹æ³•å®Œæˆæ•°æ®çš„è½¬æ¢ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œæ›´æ–°<code>upstream</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è´Ÿè´£äº‹ä»¶å‘å¸ƒçš„eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ•°æ® DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­æ˜¯æ·»åŠ è¿˜æ˜¯æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨ä¸­çš„æ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æƒé™æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®ï¼Œå…ˆåˆ é™¤å†æ–°å¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>Serrvice</code>ç±»å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼Œå³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸æ·±å…¥è¿½è¸ªäº†ã€‚å…³äºæ›´æ–°<code>upstream</code>æ“ä½œï¼Œæ”¾åˆ°åé¢å¯¹åº”çš„ç« èŠ‚ä¸­è¿›è¡Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨å‘å¸ƒäº‹ä»¶çš„æ“ä½œï¼Œå®ƒä¼šæ‰§è¡Œæ•°æ®åŒæ­¥ã€‚</p><p><code>publishEvent()</code>æ–¹æ³•çš„é€»è¾‘æ˜¯ï¼šæ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶ï¼Œæ„å»ºæ¡ä»¶æ•°æ®ï¼Œå‘å¸ƒå˜æ›´æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒå˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‘å¸ƒå˜æ›´æ•°æ®é€šè¿‡<code>eventPublisher.publishEvent()</code>å®Œæˆï¼Œè¿™ä¸ª<code>eventPublisher</code>å¯¹è±¡æ˜¯ä¸€ä¸ª<code>ApplicationEventPublisher</code>ç±»ï¼Œè¿™ä¸ªç±»çš„å…¨é™å®šåæ˜¯<code>org.springframework.context.ApplicationEventPublisher</code>ã€‚çœ‹åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬çŸ¥é“äº†å‘å¸ƒæ•°æ®æ˜¯é€šè¿‡<code>Spring</code>ç›¸å…³çš„åŠŸèƒ½æ¥å®Œæˆçš„ã€‚</p><blockquote><p>å…³äº<code>ApplicationEventPublisher</code>ï¼š</p><p>å½“æœ‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…è°ƒç”¨ <code>ApplicationEventPublisher</code> çš„ <code>publishEvent</code> æ–¹æ³•å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œ<code>Spring</code>å®¹å™¨å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onApplicationEvent</code> æ–¹æ³•æŠŠäº‹ä»¶å¯¹è±¡ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚è°ƒç”¨ <code>publishEvent</code>æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å®ç°æ¥å£ç”±å®¹å™¨æ³¨å…¥ <code>ApplicationEventPublisher</code> å¯¹è±¡ç„¶åè°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨å®¹å™¨çš„æ–¹æ³•ï¼Œä¸¤ç§æ–¹æ³•å‘å¸ƒäº‹ä»¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><ul><li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒäº‹ä»¶ï¼›</li><li><code>ApplicationEvent</code>ï¼š<code>Spring</code> äº‹ä»¶ï¼Œè®°å½•äº‹ä»¶æºã€æ—¶é—´å’Œæ•°æ®ï¼›</li><li><code>ApplicationListener</code>ï¼šäº‹ä»¶ç›‘å¬è€…ï¼Œè§‚å¯Ÿè€…ï¼›</li></ul></blockquote><p>åœ¨<code>Spring</code>çš„äº‹ä»¶å‘å¸ƒæœºåˆ¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œ</p><p>ä¸€ä¸ªæ˜¯å‘å¸ƒäº‹ä»¶çš„<code>ApplicationEventPublisher</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡æ„é€ å™¨æ³¨å…¥äº†ä¸€ä¸ª<code>eventPublisher</code>ã€‚</p><p>å¦ä¸€ä¸ªå¯¹è±¡æ˜¯<code>ApplicationEvent</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEvent</code>ç»§æ‰¿äº†å®ƒï¼Œè¡¨ç¤ºäº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åä¸€ä¸ªæ˜¯ <code>ApplicationListener</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEventDispatcher</code>ç±»å®ç°äº†è¯¥æ¥å£ï¼Œä½œä¸ºäº‹ä»¶çš„ç›‘å¬è€…ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-åˆ†å‘æ•°æ®"></a>2.3 åˆ†å‘æ•°æ®<a class="hash-link" href="#23-åˆ†å‘æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>å½“äº‹ä»¶å‘å¸ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿›å…¥åˆ°<code>DataChangedEventDispatcher</code>ç±»ä¸­çš„<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨<code>onApplicationEvent</code>æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œåˆ¤æ–­æ˜¯å“ªç§æ•°æ®ç±»å‹ï¼Œäº¤ç»™ç›¸åº”çš„æ•°æ®ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚</p><p><code>ShenYu</code>å°†æ‰€æœ‰æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æ˜¯äº”ç§ï¼šè®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯å’Œå…ƒæ•°æ®ã€‚</p><p>è¿™é‡Œçš„æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆ<code>DataChangedListener</code>ï¼‰ï¼Œå°±æ˜¯æ•°æ®åŒæ­¥ç­–ç•¥çš„æŠ½è±¡ï¼Œå®ƒçš„å…·ä½“å®ç°æœ‰ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>è¿™å‡ ä¸ªå®ç°ç±»å°±æ˜¯å½“å‰<code>ShenYu</code>æ”¯æŒçš„åŒæ­¥ç­–ç•¥ï¼š</p><ul><li><code>WebsocketDataChangedListener</code>ï¼šåŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ZookeeperDataChangedListener</code>ï¼šåŸºäº<code>zookeeper</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ConsulDataChangedListener</code>ï¼šåŸºäº<code>consul</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>EtcdDataDataChangedListener</code>ï¼šåŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>HttpLongPollingDataChangedListener</code>ï¼šåŸºäº<code>httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>NacosDataChangedListener</code>ï¼šåŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼›</li></ul><p>æ—¢ç„¶æœ‰è¿™ä¹ˆå¤šç§å®ç°ç­–ç•¥ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>å› ä¸ºæœ¬æ–‡æ˜¯åŸºäº<code>Zookeeper</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æï¼Œæ‰€ä»¥è¿™é‡Œä»¥<code>ZookeeperDataChangedListener</code>ä¸ºä¾‹ï¼Œåˆ†æå®ƒæ˜¯å¦‚ä½•è¢«åŠ è½½å¹¶å®ç°çš„ã€‚</p><p>é€šè¿‡åœ¨æºç å·¥ç¨‹ä¸­è¿›è¡Œå…¨å±€æœç´¢ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å®ç°æ˜¯åœ¨<code>DataSyncConfiguration</code>ç±»å®Œæˆçš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * zookeeperæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Zookeeper listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)  // æ¡ä»¶å±æ€§ï¼Œæ»¡è¶³æ‰ä¼šè¢«åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(ZookeeperConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class ZookeeperListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * åˆ›å»ºZookeeperæ•°æ®å˜æ›´ç›‘å¬å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener zookeeperDataChangedListener(final ZkClient zkClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataChangedListener(zkClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Zookeeper data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *  åˆ›å»º Zookeeper æ•°æ®åˆå§‹åŒ–ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the zookeeper data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ZookeeperDataInit zookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataInit(zkClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªé…ç½®ç±»æ˜¯é€šè¿‡<code>SpringBoot</code>æ¡ä»¶è£…é…ç±»å®ç°çš„ã€‚åœ¨<code>ZookeeperListener</code>ç±»ä¸Šé¢æœ‰å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p><code>@Configuration</code>ï¼šé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ä¸Šä¸‹æ–‡ï¼›</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)</code>ï¼šå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šé‡‡ç”¨<code>zookeeper</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     zookeeper:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          sessionTimeout: 5000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          connectionTimeout: 2000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(ZookeeperConfiguration.class)</code>ï¼šå¯¼å…¥å¦ä¸€ä¸ªç±»<code>ZookeeperConfiguration</code>ï¼›</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  @EnableConfigurationProperties(ZookeeperProperties.class)  // å¯ç”¨zkå±æ€§é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public class ZookeeperConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register zkClient in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å‘ Spring IOC å®¹å™¨æ³¨å†Œ zkClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zookeeperProp the zookeeper configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ZkClient {@linkplain ZkClient}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @ConditionalOnMissingBean(ZkClient.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      public ZkClient zkClient(final ZookeeperProperties zookeeperProp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ZkClient(zookeeperProp.getUrl(), zookeeperProp.getSessionTimeout(), zookeeperProp.getConnectionTimeout()); // è¯»å–zké…ç½®ä¿¡æ¯ï¼Œå¹¶åˆ›å»ºzkClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.zookeeper&quot;) // zkå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æˆ‘ä»¬ä¸»åŠ¨é…ç½®ï¼Œé‡‡ç”¨<code>zookeeper</code>è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œ<code>zookeeperDataChangedListener</code>å°±ä¼šç”Ÿæˆã€‚æ‰€ä»¥åœ¨äº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ä¸­ï¼Œå°±ä¼šåˆ°ç›¸åº”çš„<code>listener</code>ä¸­ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ˜¯å¯¹ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæ•°æ®åŒæ­¥é‡‡ç”¨çš„æ˜¯<code>zookeeper</code>ï¼Œæ‰€ä»¥ï¼Œä»£ç ä¼šè¿›å…¥åˆ°<code>ZookeeperDataChangedListener</code>è¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä¼šè¿›å…¥åˆ°ZookeeperDataChangedListenerè¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-zookeeperæ•°æ®å˜æ›´ç›‘å¬å™¨"></a>2.4 Zookeeperæ•°æ®å˜æ›´ç›‘å¬å™¨<a class="hash-link" href="#24-zookeeperæ•°æ®å˜æ›´ç›‘å¬å™¨" title="Direct link to heading">#</a></h4><ul><li><p>ZookeeperDataChangedListener.onSelectorChanged()</p><p>åœ¨<code>onSelectorChanged()</code>æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­æ“ä½œç±»å‹ï¼Œæ˜¯åˆ·æ–°åŒæ­¥è¿˜æ˜¯æ›´æ–°æˆ–åˆ›å»ºåŒæ­¥ã€‚æ ¹æ®å½“å‰é€‰æ‹©å™¨æ•°æ®ä¿¡æ¯åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨<code>zk</code>ä¸­ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ä½¿ç”¨ zookeeper å‘å¸ƒå˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€‰æ‹©å™¨ä¿¡æ¯å‘ç”Ÿæ”¹å˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ·æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            deleteZkPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘ç”Ÿå˜æ›´çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºé€‰æ‹©å™¨æ•°æ®çš„çœŸå®è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¦‚æœæ˜¯åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åˆ é™¤å½“å‰æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                deleteZkPath(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // çˆ¶èŠ‚ç‚¹è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(data.getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºçˆ¶èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createZkNode(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥æˆ–æ›´æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            insertZkNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»º zk èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void createZkNode(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¸å­˜åœ¨æ‰åˆ›å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(path, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ’å…¥zkèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void insertZkNode(final String path, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºèŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        createZkNode(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é€šè¿‡ zkClient å†™å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.writeData(path, null == data ? &quot;&quot; : GsonUtils.getInstance().toJson(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åªè¦å°†å˜åŠ¨çš„æ•°æ®æ­£ç¡®å†™å…¥åˆ°<code>zk</code>çš„èŠ‚ç‚¹ä¸Šï¼Œ<code>admin</code>è¿™è¾¹çš„æ“ä½œå°±æ‰§è¡Œå®Œæˆäº†ã€‚<code>ShenYu</code>åœ¨ä½¿ç”¨<code>zk</code>è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œ<code>zk</code>çš„èŠ‚ç‚¹æ˜¯é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„ã€‚</p><p>åœ¨æˆ‘ä»¬å½“å‰çš„æ¡ˆä¾‹ä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼Œå°±ä¼šå¯¹å›¾ä¸­çš„ç‰¹å®šèŠ‚ç‚¹æ›´æ–°ã€‚</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>æˆ‘ä»¬ç”¨æ—¶åºå›¾å°†ä¸Šé¢çš„æ›´æ–°æµç¨‹ä¸²è”èµ·æ¥ã€‚</p><p><img src="/zh/assets/images/zk-sync-sequence-admin-zh-afad1ef642b7130231c2ceacce236b34.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-ç½‘å…³æ•°æ®åŒæ­¥"></a>3. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#3-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>å‡è®¾<code>ShenYu</code>ç½‘å…³å·²ç»åœ¨æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨çš„æ•°æ®åŒæ­¥æ–¹å¼ä¹Ÿæ˜¯<code>zookeeper</code>ã€‚é‚£ä¹ˆå½“åœ¨<code>admin</code>ç«¯æ›´æ–°é€‰æ‹©å™¨æ•°æ®åï¼Œå¹¶ä¸”å‘<code>zk</code>å‘é€äº†å˜æ›´çš„æ•°æ®ï¼Œé‚£ç½‘å…³æ˜¯å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†æ•°æ®çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­è¿›è¡Œæºç åˆ†æï¼Œä¸€æ¢ç©¶ç«Ÿã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-zkclientæ¥æ”¶æ•°æ®"></a>3.1 ZkClientæ¥æ”¶æ•°æ®<a class="hash-link" href="#31-zkclientæ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>ZkClient.subscribeDataChanges()</li></ul><p>åœ¨ç½‘å…³ç«¯æœ‰ä¸€ä¸ª<code>ZookeeperSyncDataService</code>ç±»ï¼Œå®ƒé€šè¿‡<code>ZkClient</code>è®¢é˜…äº†æ•°æ®èŠ‚ç‚¹ï¼Œå½“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œå¯ä»¥æ„ŸçŸ¥åˆ°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ä½¿ç”¨ zookeeper ç¼“å­˜æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // zkClientè®¢é˜…æ•°æ®èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(path, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cacheSelectorData(GsonUtils.getInstance().fromJson(data.toString(), SelectorData.class)); // èŠ‚ç‚¹æ•°æ®è¢«æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                unCacheSelectorData(dataPath);  // èŠ‚ç‚¹æ•°æ®è¢«åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ZooKeeper</code>çš„<code>Watch</code>æœºåˆ¶ï¼Œä¼šç»™è®¢é˜…çš„å®¢æˆ·ç«¯å‘é€èŠ‚ç‚¹å˜æ›´é€šçŸ¥ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ›´æ–°é€‰æ‹©å™¨ä¿¡æ¯ï¼Œå°±ä¼šè¿›å…¥åˆ°<code>handleDataChange()</code>æ–¹æ³•ã€‚é€šè¿‡<code>cacheSelectorData()</code>å»å¤„ç†æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-å¤„ç†æ•°æ®"></a>3.2 å¤„ç†æ•°æ®<a class="hash-link" href="#32-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>ZookeeperSyncDataService.cacheSelectorData()</li></ul><p>ç»è¿‡åˆ¤ç©ºé€»è¾‘ä¹‹åï¼Œç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„æ“ä½œåˆäº¤ç»™äº†<code>PluginDataSubscriber</code>å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ª<code>CommonPluginDataSubscriber</code>å®ç°ç±»ï¼Œè´Ÿè´£å¤„ç†æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…"></a>3.3 é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…<a class="hash-link" href="#33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>å®ƒæ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>subscribeDataHandler()</code>æ–¹æ³•ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œæ›´å…·æ•°æ®ç±»å‹ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨æˆ–è§„åˆ™ï¼‰ï¼Œæ“ä½œç±»å‹ï¼ˆæ›´æ–°æˆ–åˆ é™¤ï¼‰ï¼Œå»æ‰§è¡Œä¸åŒé€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å¤„ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å¤„ç†å™¨ï¼Œå¤„ç†æ•°æ®çš„æ›´æ–°æˆ–åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜"></a>3.4 æ•°æ®ç¼“å­˜åˆ°å†…å­˜<a class="hash-link" href="#34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜" title="Direct link to heading">#</a></h4><p>é‚£ä¹ˆæ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³çš„å†…å­˜ä¸­ã€‚<code>BaseDataCache</code>æ˜¯æœ€ç»ˆç¼“å­˜æ•°æ®çš„ç±»ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ã€‚é€‰æ‹©å™¨æ•°æ®å°±å­˜åˆ°äº†<code>SELECTOR_MAP</code>è¿™ä¸ª<code>Map</code>ä¸­ã€‚åœ¨åç»­ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»è¿™é‡Œæ‹¿æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  å…¬å¼€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  ç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç¼“å­˜é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // æ›´æ–°æ“ä½œï¼Œå…ˆåˆ é™¤å†æ’å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // æ–°å¢æ“ä½œï¼Œç›´æ¥æ”¾åˆ°Mapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>äºŒæ˜¯å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†ã€‚  é€šè¿‡<code>idea</code>ç¼–è¾‘å™¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æ–°å¢ä¸€æ¡é€‰æ‹©å™¨åï¼Œæœ‰å¦‚ä¸‹çš„æ’ä»¶è¿˜æœ‰å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä¸å†å±•å¼€äº†ã€‚</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>ç»è¿‡ä»¥ä¸Šçš„æºç è¿½è¸ªï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼Œåœ¨<code>admin</code>ç«¯æ–°å¢æ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œå°±å°†<code>zookeeper</code>æ•°æ®åŒæ­¥çš„æµç¨‹åˆ†ææ¸…æ¥šäº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡æ—¶åºå›¾å°†ç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æµç¨‹ä¸²è”ä¸€ä¸‹ï¼š</p><p><img src="/zh/assets/images/zk-sync-sequence-gateway-zh-0494aedc4de3f64c781fe8bb6c4b69bc.png"></p><p>æ•°æ®åŒæ­¥çš„æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œä¸ºäº†ä¸è®©åŒæ­¥æµç¨‹è¢«æ‰“æ–­ï¼Œåœ¨åˆ†æè¿‡ç¨‹ä¸­å°±å¿½ç•¥äº†å…¶ä»–é€»è¾‘ã€‚æˆ‘ä»¬è¿˜éœ€è¦åˆ†æ<code>Admin</code>åŒæ­¥æ•°æ®åˆå§‹åŒ–å’Œç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–çš„æµç¨‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–"></a>4. AdminåŒæ­¥æ•°æ®åˆå§‹åŒ–<a class="hash-link" href="#4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>å½“<code>admin</code>å¯åŠ¨åï¼Œä¼šå°†å½“å‰çš„æ•°æ®ä¿¡æ¯å…¨é‡åŒæ­¥åˆ°<code>zk</code>ä¸­ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Zookeeper æ•°æ®åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ZkClient zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­zkä¸­æ˜¯å¦å­˜åœ¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath) &amp;&amp; !zkClient.exists(authPath) &amp;&amp; !zkClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ¤æ–­<code>zk</code>ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŒæ­¥ã€‚</p><p><code>ZookeeperDataInit</code>å®ç°äº†<code>CommandLineRunner</code>æ¥å£ã€‚å®ƒæ˜¯<code>springboot</code>æä¾›çš„æ¥å£ï¼Œä¼šåœ¨æ‰€æœ‰ <code>Spring Beans</code>åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ<code>run()</code>æ–¹æ³•ï¼Œå¸¸ç”¨äºé¡¹ç›®ä¸­åˆå§‹åŒ–çš„æ“ä½œã€‚</p><ul><li>SyncDataService.syncAll()</li></ul><p>ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œç„¶åè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œæ‰€æœ‰çš„è®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯å’Œå…ƒæ•°æ®ä¿¡æ¯ã€‚ä¸»è¦æ˜¯é€šè¿‡<code>eventPublisher</code>å‘å¸ƒåŒæ­¥äº‹ä»¶ã€‚è¿™é‡Œå°±è·Ÿå‰é¢æåˆ°çš„åŒæ­¥é€»è¾‘å°±åˆè”ç³»èµ·æ¥äº†ï¼Œ<code>eventPublisher</code>é€šè¿‡<code>publishEvent()</code>å‘å¸ƒå®Œäº‹ä»¶åï¼Œæœ‰<code>ApplicationListener</code>æ‰§è¡Œäº‹ä»¶å˜æ›´æ“ä½œï¼Œåœ¨<code>ShenYu</code>ä¸­å°±æ˜¯å‰é¢æåˆ°çš„<code>DataChangedEventDispatcher</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡æ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥å…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–"></a>5. ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–<a class="hash-link" href="#5-ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>ç½‘å…³è¿™è¾¹çš„æ•°æ®åŒæ­¥åˆå§‹åŒ–æ“ä½œä¸»è¦æ˜¯è®¢é˜…<code>zk</code>ä¸­çš„èŠ‚ç‚¹ï¼Œå½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œæ”¶åˆ°å˜æ›´æ•°æ®ã€‚è¿™ä¾èµ–äº<code>ZooKeeper</code>çš„<code>Watch</code>æœºåˆ¶ã€‚åœ¨<code>ShenYu</code>ä¸­ï¼Œè´Ÿè´£<code>zk</code>æ•°æ®åŒæ­¥çš„æ˜¯<code>ZookeeperSyncDataService</code>ï¼Œä¹Ÿåœ¨å‰é¢æåˆ°è¿‡ã€‚</p><p><code>ZookeeperSyncDataService</code>çš„åŠŸèƒ½é€»è¾‘æ˜¯åœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­å®Œæˆçš„ï¼šå¯¹<code>zk</code>ä¸­çš„<code>shenyu</code>æ•°æ®åŒæ­¥èŠ‚ç‚¹å®Œæˆè®¢é˜…ã€‚è¿™é‡Œçš„è®¢é˜…åˆ†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å·²ç»å­˜åœ¨çš„èŠ‚ç‚¹ä¸Šé¢æ•°æ®å‘ç”Ÿæ›´æ–°ï¼Œè¿™é€šè¿‡<code>zkClient.subscribeDataChanges()</code>æ–¹æ³•å®ç°ï¼›å¦ä¸€ç±»æ˜¯å½“å‰èŠ‚ç‚¹ä¸‹æœ‰æ–°å¢æˆ–åˆ é™¤èŠ‚ç‚¹ï¼Œå³å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼Œè¿™é€šè¿‡<code>zkClient.subscribeChildChanges()</code>æ–¹æ³•å®ç°ã€‚</p><p><code>ZookeeperSyncDataService</code>çš„ä»£ç æœ‰ç‚¹å¤šï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥æ’ä»¶æ•°æ®çš„è¯»å–å’Œè®¢é˜…è¿›è¡Œè¿½è¸ªï¼Œå…¶ä»–ç±»å‹çš„æ•°æ®æ“ä½œåŸç†æ˜¯ä¸€æ ·çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *  zookeeper æ•°æ®åŒæ­¥æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå®Œæˆä»zkä¸­è¯»å–æ•°æ®çš„æ“ä½œï¼Œå¹¶è®¢é˜…èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperSyncDataService( /*çœç•¥æ„é€ å‚æ•°å‚æ•°*/ ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶èŠ‚ç‚¹è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰€æœ‰æ’ä»¶èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; pluginZKs = zkClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è®¢é˜…å½“å‰æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…å­èŠ‚ç‚¹ï¼ˆæ–°å¢æˆ–åˆ é™¤ä¸€ä¸ªæ’ä»¶ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeChildChanges(pluginParent, (parentPath, currentChildren) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isNotEmpty(currentChildren)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (String pluginName : currentChildren) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // éœ€è¦è®¢é˜…å­èŠ‚ç‚¹çš„æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å½“å‰æ’ä»¶è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(pluginPath, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯»å–zkä¸Šå½“å‰èŠ‚ç‚¹æ•°æ®ï¼Œå¹¶ååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = null == zkClient.readData(pluginPath) ? null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : GsonUtils.getInstance().fromJson((String) zkClient.readData(pluginPath), PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…æ’ä»¶èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private void cachePluginData(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // çœç•¥å®ç°é€»è¾‘ï¼Œå…¶å®å°±æ˜¯ CommonPluginDataSubscriber ä¸­çš„æ“ä½œï¼Œè·Ÿå‰é¢éƒ½èƒ½è”ç³»èµ·æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¢é˜…æ•°æ®å˜æ›´ï¼šæ›´æ–°æˆ–åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(pluginPath, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {  // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                 // çœç•¥å®ç°é€»è¾‘ï¼Œå…¶å®å°±æ˜¯ CommonPluginDataSubscriber ä¸­çš„æ“ä½œï¼Œè·Ÿå‰é¢éƒ½èƒ½è”ç³»èµ·æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {   // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  // çœç•¥å®ç°é€»è¾‘ï¼Œå…¶å®å°±æ˜¯ CommonPluginDataSubscriber ä¸­çš„æ“ä½œï¼Œè·Ÿå‰é¢éƒ½èƒ½è”ç³»èµ·æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸Šé¢çš„æºä»£ç ä¸­éƒ½ç»™å‡ºäº†æ³¨é‡Šï¼Œç›¸ä¿¡å¤§å®¶å¯ä»¥çœ‹æ˜ç™½ã€‚è®¢é˜…æ’ä»¶æ•°æ®çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><blockquote><ol><li>æ„é€ å½“å‰æ’ä»¶è·¯å¾„</li><li>è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»º</li><li>è¯»å–zkä¸Šå½“å‰èŠ‚ç‚¹æ•°æ®ï¼Œå¹¶ååºåˆ—åŒ–</li><li>æ’ä»¶æ•°æ®ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­</li><li>è®¢é˜…æ’ä»¶èŠ‚ç‚¹</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-æ€»ç»“"></a>6. æ€»ç»“<a class="hash-link" href="#6-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œå¯¹<code>zookeeper</code>çš„æ•°æ®åŒæ­¥åŸç†è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>åŸºäº<code>zookeeper</code>çš„æ•°æ®åŒæ­¥ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>watch</code>æœºåˆ¶å®ç°ï¼›</li><li>é€šè¿‡<code>Spring</code>å®Œæˆäº‹ä»¶å‘å¸ƒå’Œç›‘å¬ï¼›</li><li>é€šè¿‡æŠ½è±¡<code>DataChangedListener</code>æ¥å£ï¼Œæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼›</li><li>ä½¿ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼å®ç°ç¼“å­˜æ•°æ®ç±»<code>BaseDataCache</code>ï¼›</li><li>é€šè¿‡<code>SpringBoot</code>çš„æ¡ä»¶è£…é…å’Œ<code>starter</code>åŠ è½½æœºåˆ¶å®ç°é…ç½®ç±»çš„åŠ è½½ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/zookeeper">zookeeper</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Loader-SourceCode-Analysis-ExtLoader">æ‰©å±•æ’ä»¶åŠ è½½é€»è¾‘</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.462Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/hql0312" target="_blank" rel="noopener noreferrer">hql0312</a></div><small class="avatar__subtitle">hql0312 Coder</small></div></div></header><div class="markdown"><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.6.1</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æ.</p></blockquote><header><h1 class="h1Heading_dC7a">æ­£æ–‡</h1></header><p>Shenyu æä¾›äº†ä¸€ç§æœºåˆ¶æ¥å®šåˆ¶è‡ªå·±çš„æ’ä»¶æˆ–æ˜¯ä¿®æ”¹å·²æœ‰çš„æ’ä»¶ï¼Œåœ¨å…¶å†…éƒ¨é€šè¿‡extPluginçš„é…ç½®å®ç°ï¼Œå…¶éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ol><li>å®ç°æ¥å£ <code>ShenyuPlugin</code> æˆ–æ˜¯ <code>PluginDataHandler</code></li><li>å°†å®ç°çš„åŒ…æ‰“åŒ…åï¼Œæ”¾ç½®äº<code>shenyu.extPlugin.path</code>å¯¹åº”çš„è·¯å¾„ä¸‹</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å…¥å£"></a>å…¥å£<a class="hash-link" href="#å…¥å£" title="Direct link to heading">#</a></h2><p>çœŸæ­£å®ç°è¯¥é€»è¾‘çš„ç±»æ˜¯<code>ShenyuLoaderService</code>,æ¥ä¸‹æ¥çœ‹ä¸‹è¯¥ç±»æ˜¯å¦‚ä½•å¤„ç†</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuLoaderService(final ShenyuWebHandler webHandler, final CommonPluginDataSubscriber subscriber, final ShenyuConfig shenyuConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶ä¿¡æ¯çš„ä¿¡æ¯è®¢é˜…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.subscriber = subscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Shenyuå°è£…çš„WebHandlerï¼ŒåŒ…å«äº†æ‰€æœ‰çš„æ’ä»¶é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.webHandler = webHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.shenyuConfig = shenyuConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰©å±•æ’ä»¶çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚è·¯å¾„ï¼Œæ˜¯å¦å¯ç”¨ã€å¼€å¯å¤šå°‘çº¿ç¨‹æ¥å¤„ç†ã€æ£€æŸ¥åŠ è½½çš„é¢‘ç‡ç­‰ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtPlugin config = shenyuConfig.getExtPlugin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœå¯ç”¨çš„ï¼Œåˆ™åˆ›å»ºå®šæ—¶ä»»åŠ¡æ¥æ£€æŸ¥å¹¶åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (config.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºä¸€ä¸ªæŒ‡å®šçº¿ç¨‹åç§°çš„å®šæ—¶ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScheduledThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(config.getThreads(), ShenyuThreadFactory.create(&quot;plugin-ext-loader&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºå›ºå®šé¢‘ç‡æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤åœ¨30sï¼Œæ¯300sï¼Œæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.scheduleAtFixedRate(() -&gt; loadExtOrUploadPlugins(null), config.getScheduleDelay(), config.getScheduleTime(), TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥ç±»æœ‰ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š</p><p><code>webHandler</code>: è¯¥ç±»æ˜¯shenyu å¤„ç†è¯·æ±‚çš„å…¥å£ï¼Œå¼•ç”¨äº†æ‰€æœ‰çš„æ’ä»¶æ•°æ®ï¼Œåœ¨æ‰©å±•æ’ä»¶åŠ è½½åï¼Œéœ€è¦è¿›è¡Œæ›´æ–°</p><p><code>subscriber</code>: è¯¥ç±»æ˜¯æ’ä»¶çš„è®¢é˜…çš„å…¥å£ï¼Œå¼•ç”¨äº†æ‰€æœ‰æ’ä»¶çš„è®¢é˜…å¤„ç†ç±»ï¼Œåœ¨æ‰©å±•é…ç½®åŠ è½½åï¼Œä¹Ÿéœ€è¦è¿›è¡ŒåŒæ­¥æ›´æ–°</p><p><code>executor</code>: åœ¨<code>ShenyuLoaderService</code>å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¥å®šæ—¶æ‰«æåŠ è½½æŒ‡å®šè·¯å¾„ä¸‹çš„jaråŒ…ï¼Œä¾¿äºåŠ è½½æ‰©å±•çš„æ’ä»¶ï¼Œå®ç°åŠ¨æ€å‘ç°
é»˜è®¤ä¼šåœ¨å¯åŠ¨30ç§’åï¼Œæ¯300ç§’æ‰«æä¸€æ¬¡</p><p>åŒæ—¶è¿™é‡Œå¯ä»¥é€šè¿‡ <code>shenyu.extPlugin.enabled</code>é…ç½®æ¥å†³å®šæ˜¯å¦è¦å¼€å¯æ‰©å±•æ’ä»¶åŠŸèƒ½çš„å¯ç”¨</p><p>ä»¥ä¸Šçš„é…ç½®å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè°ƒæ•´ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extPlugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># æ‰©å±•æ’ä»¶çš„å­˜å‚¨ç›®å½•</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># æ˜¯å¦å¯ç”¨æ‰©å±•åŠŸèƒ½</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">threads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># æ‰«æåŠ è½½çš„çº¿ç¨‹æ•°</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleTime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ä»»åŠ¡æ‰§è¡Œçš„é¢‘ç‡</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleDelay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ä»»åŠ¡å¯åŠ¨åå¤šä¹…å¼€å§‹æ‰§è¡Œ</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥ä¸‹æ¥çœ‹ä¸‹åŠ è½½çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   public void loadExtOrUploadPlugins(final PluginData uploadedJarResource) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;ShenyuLoaderResult&gt; plugins = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–ShenyuPluginClassloaderçš„æŒæœ‰å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuPluginClassloaderHolder singleton = ShenyuPluginClassloaderHolder.getSingleton();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(uploadedJarResource)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å‚æ•°ä¸ºç©ºï¼Œåˆ™ä»æ‰©å±•çš„ç›®å½•ï¼ŒåŠ è½½æ‰€æœ‰çš„jaråŒ…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // PluginJarï¼šåŒ…å«ShenyuPluginæ¥å£ã€PluginDataHandleræ¥å£çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;PluginJarParser.PluginJar&gt; uploadPluginJars = ShenyuExtPathPluginJarLoader.loadExtendPlugins(shenyuConfig.getExtPlugin().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // éå†æ‰€æœ‰çš„å¾…åŠ è½½æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (PluginJarParser.PluginJar extPath : uploadPluginJars) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;shenyu extPlugin find new {} to load&quot;, extPath.getAbsolutePath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä½¿ç”¨æ‰©å±•æ’ä»¶çš„åŠ è½½å™¨æ¥åŠ è½½æŒ‡å®šçš„æ’ä»¶ï¼Œä¾¿äºåç»­çš„åŠ è½½å’Œå¸è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPluginClassLoader extPathClassLoader = singleton.createPluginClassLoader(extPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä½¿ç”¨ShenyuPluginClassLoader è¿›è¡ŒåŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä¸»è¦é€»è¾‘æ˜¯ï¼šåˆ¤æ–­æ˜¯å¦å®ç°ShenyuPluginæ¥å£ã€PluginDataHandleræ¥å£ æˆ–æ˜¯å¦æ ‡è¯† @Component\@Serviceç­‰æ³¨è§£ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ³¨å†Œä¸ºSpringBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ„é€  ShenyuLoaderResultå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    plugins.addAll(extPathClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åŠ è½½æŒ‡å®šjarï¼Œé€»è¾‘åŒåŠ è½½å…¨éƒ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginJarParser.PluginJar pluginJar = PluginJarParser.parseJar(Base64.getDecoder().decode(uploadedJarResource.getPluginJar()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu upload plugin jar find new {} to load&quot;, pluginJar.getJarKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuPluginClassLoader uploadPluginClassLoader = singleton.createPluginClassLoader(pluginJar);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                plugins.addAll(uploadPluginClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å°†æ‰©å±•çš„æ’ä»¶ï¼ŒåŠ å…¥åˆ°ShenyuWebHandlerçš„æ’ä»¶åˆ—è¡¨ï¼Œåç»­çš„è¯·æ±‚åˆ™ä¼šç»è¿‡åŠ å…¥çš„æ’ä»¶å†…å®¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            loaderPlugins(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;shenyu plugins load has error &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥æ–¹æ³•å¤„ç†çš„é€»è¾‘ï¼š</p><ol><li>åˆ¤æ–­å‚æ•°uploadedJarResourceæ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šåŠ è½½å…¨éƒ¨ï¼Œå¦åˆ™åŠ è½½æŒ‡å®šèµ„æºjaråŒ…è¿›è¡Œå¤„ç†</li><li>ä» <code>shenyu.extPlugin.path</code> ä¸­è·å–åˆ°æŒ‡å®šjaråŒ…ï¼Œå¹¶å°è£…æˆ PluginJarå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº†jaråŒ…ä»¥ä¸‹ä¿¡æ¯<ul><li>version: ç‰ˆæœ¬ä¿¡æ¯</li><li>groupIdï¼šåŒ…çš„groupId</li><li>artifactId: åŒ…çš„ artifactId</li><li>absolutePathï¼š ç»å¯¹è·¯å¾„</li><li>clazzMapï¼šclasså¯¹åº”çš„å­—èŠ‚ç </li><li>resourceMapï¼šjaråŒ…çš„å­—èŠ‚ç </li></ul></li><li>é€šè¿‡<code>ShenyuPluginClassloaderHolder</code>åˆ›å»ºå¯¹åº”çš„ClassLoader,å¯¹åº”çš„ç±»æ˜¯<code>ShenyuPluginClassLoader</code>, å¹¶è¿›è¡ŒåŠ è½½å¯¹åº”çš„ç±»<ul><li>è°ƒç”¨<code>ShenyuPluginClassLoader.loadUploadedJarPlugins</code> åŠ è½½å¯¹åº”çš„ç±»å¹¶æ³¨å†ŒæˆSpring Beanï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨Springå®¹å™¨æ¥ç®¡ç†</li></ul></li><li>è°ƒç”¨<code>loaderPlugins</code>æ–¹æ³•ï¼Œå°†æ‰©å±•çš„æ’ä»¶æ›´æ–°åˆ° <code>webHandler</code> ä»¥åŠ <code>subscriber</code>ä¸­</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ’ä»¶æ³¨å†Œ"></a>æ’ä»¶æ³¨å†Œ<a class="hash-link" href="#æ’ä»¶æ³¨å†Œ" title="Direct link to heading">#</a></h2><p>å¯¹äºæä¾›çš„jaråŒ…é‡Œçš„å†…å®¹ï¼ŒåŠ è½½å™¨åªä¼šå¤„ç†æŒ‡å®šæ¥å£ç±»å‹çš„ç±»ï¼Œå®ç°é€»è¾‘åœ¨ <code>ShenyuPluginClassLoader.loadUploadedJarPlugins()</code> æ–¹æ³•</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;ShenyuLoaderResult&gt; loadUploadedJarPlugins() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuLoaderResult&gt; results = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰€æœ‰çš„ç±»æ˜ å°„å…³ç³»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; names = pluginJar.getClazzMap().keySet();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ‰€æœ‰çš„ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        names.forEach(className -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å°è¯•åˆ›å»ºå¯¹è±¡ï¼Œå¦‚æœå¯ä»¥ï¼Œåˆ™åŠ å…¥åˆ°Springå®¹å™¨ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                instance = getOrCreateSpringBean(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(instance)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ„å»ºShenyuLoaderResultå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.add(buildResult(instance));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;The class successfully loaded into a upload-Jar-plugin {} is registered as a spring bean&quot;, className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ClassNotFoundException | IllegalAccessException | InstantiationException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.warn(&quot;Registering upload-Jar-plugins succeeds spring bean fails:{}&quot;, className, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥æ–¹æ³•å°±æ˜¯è´Ÿè´£æ„å»ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡ï¼Œå¹¶å°è£…æˆ <code>ShenyuLoaderResult</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯¹äºåˆ›å»ºåå¯¹è±¡ï¼Œè¿›è¡Œäº†å°è£…ï¼Œä¼šåœ¨æ–¹æ³• <code>buildResult()</code>ä¸­è¿›è¡Œå¤„ç†</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuLoaderResult buildResult(final Object instance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuLoaderResult result = new ShenyuLoaderResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºçš„å¯¹è±¡æ˜¯å¦å®ç°äº†ShenyuPlugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (instance instanceof ShenyuPlugin) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setShenyuPlugin((ShenyuPlugin) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºçš„å¯¹è±¡æ˜¯å¦å®ç°äº†PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (instance instanceof PluginDataHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setPluginDataHandler((PluginDataHandler) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŒæ—¶è¿›å…¥æ–¹æ³• <code>getOrCreateSpringBean()</code> è¿›ä¸€æ­¥åˆ†æ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; T getOrCreateSpringBean(final String className) throws ClassNotFoundException, IllegalAccessException, InstantiationException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç¡®è®¤æ˜¯å¦å·²ç»æ³¨å†Œè¿‡äº†ï¼Œå¦‚æœæœ‰åˆ™ä¸å¤„ç†ï¼Œç›´æ¥è¿”å›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SpringBeanUtils.getInstance().existBean(className)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Double check,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            T inst = SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(inst)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ä½¿ç”¨ ShenyuPluginClassLoader è¿›è¡ŒåŠ è½½ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Class&lt;?&gt; clazz = Class.forName(className, false, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Exclude ShenyuPlugin subclass and PluginDataHandler subclass</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // without adding @Component @Service annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ç¡®è®¤æ˜¯å¦æ˜¯ ShenyuPlugin æˆ–æ˜¯ PluginDataHandlerçš„å­ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean next = ShenyuPlugin.class.isAssignableFrom(clazz)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || PluginDataHandler.class.isAssignableFrom(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœä¸æ˜¯ï¼Œç¡®è®¤æ˜¯å¦æ ‡è¯†äº† @Component ä¸ @Service æ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Annotation[] annotations = clazz.getAnnotations();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    next = Arrays.stream(annotations).anyMatch(e -&gt; e.annotationType().equals(Component.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            || e.annotationType().equals(Service.class));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœç¬¦åˆä»¥ä¸Šå†…å®¹ï¼Œåˆ™æ³¨å†ŒBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    GenericBeanDefinition beanDefinition = new GenericBeanDefinition();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setBeanClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setAutowireCandidate(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ³¨å†Œbean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String beanName = SpringBeanUtils.getInstance().registerBean(beanDefinition, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // åˆ›å»ºå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inst = SpringBeanUtils.getInstance().getBeanByClassName(beanName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return inst;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li>åˆ¤æ–­æ˜¯å¦å®ç°äº†æ¥å£ <code>ShenyuPlugin</code> æˆ– <code>PluginDataHandler</code>, å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ˜¯å¦æ ‡è¯†äº† <code>@Component</code> æˆ–æ˜¯ <code>@Service</code></li><li>å¦‚æœç¬¦åˆ1çš„æ¡ä»¶ï¼Œåˆ™å°†è¯¥å¯¹è±¡æ³¨å†Œåˆ°Spring å®¹å™¨ï¼Œå¹¶è¿”å›åˆ›å»ºçš„å¯¹è±¡</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="åŒæ­¥"></a>åŒæ­¥<a class="hash-link" href="#åŒæ­¥" title="Direct link to heading">#</a></h2><p>åœ¨æ’ä»¶æ³¨å†ŒæˆåŠŸåï¼Œè¿™æ—¶åªæ˜¯å®ä¾‹åŒ–äº†æ’ä»¶ï¼Œä½†å®ƒè¿˜ä¸ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºå®ƒè¿˜æœªæ·»åŠ åˆ° Shenyuçš„æ’ä»¶é“¾ä¸­ï¼ŒåŒæ­¥é€»è¾‘ç”± <code>loaderPlugins()</code>æ–¹æ³•å®ç°</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void loaderPlugins(final List&lt;ShenyuLoaderResult&gt; results) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ‰€æœ‰å®ç°äº†æ¥å£ShenyuPluginçš„å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; shenyuExtendPlugins = results.stream().map(ShenyuLoaderResult::getShenyuPlugin).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ›´æ–°webHandlerä¸­plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        webHandler.putExtPlugins(shenyuExtendPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ‰€æœ‰å®ç°äº†æ¥å£PluginDataHandlerçš„å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginDataHandler&gt; handlers = results.stream().map(ShenyuLoaderResult::getPluginDataHandler).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ‰©å±•çš„PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscriber.putExtendPluginDataHandler(handlers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥æ–¹æ³•çš„é€»è¾‘å¤„ç†äº†ä¸¤ä¸ªæ•°æ®ï¼š</p><ol><li>å°†å®ç°äº† <code>ShenyuPlugin</code> æ¥å£çš„æ•°æ®ï¼ŒåŒæ­¥è‡³ <code>webHandler</code>çš„plugins åˆ—è¡¨</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtPlugins(final List&lt;ShenyuPlugin&gt; extPlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(extPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿‡æ»¤å‡ºæ–°å¢çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuAddPlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().noneMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿‡æ»¤å‡ºæ›´æ–°çš„æ’ä»¶ï¼Œä»¥åç§°å’Œæ—§çš„ç›¸åŒæ¥åˆ¤æ–­ï¼Œåˆ™ä¸ºæ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuUpdatePlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().anyMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™è·³è¿‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(shenyuAddPlugins) &amp;&amp; CollectionUtils.isEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤åˆ¶æ—§çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // copy new list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; newPluginList = new ArrayList&lt;&gt;(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ æ–°çš„æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add extend plugin from pluginData or shenyu ext-lib</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sourcePlugins.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuAddPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuAddPlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto add extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newPluginList.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¿®æ”¹æ›´æ–°çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuUpdatePlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto update extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ShenyuPlugin updatePlugin : shenyuUpdatePlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; newPluginList.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (newPluginList.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        newPluginList.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; this.sourcePlugins.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (this.sourcePlugins.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.sourcePlugins.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é‡æ–°æ’åº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        plugins = sortPlugins(newPluginList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li>å°†å®ç°äº† <code>PluginDataHandler</code> æ¥å£çš„æ•°æ®ï¼ŒåŒæ­¥è‡³ <code>subscriber</code> çš„handlers åˆ—è¡¨</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtendPluginDataHandler(final List&lt;PluginDataHandler&gt; handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(handlers)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ‰€æœ‰æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (PluginDataHandler handler : handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String pluginNamed = handler.pluginNamed();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°ç°æœ‰çš„PluginDataHandleråˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MapUtils.computeIfAbsent(handlerMap, pluginNamed, name -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu auto add extends plugin data handler name is :{}&quot;, pluginNamed);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ï¼Œæ‰©å±•æ’ä»¶çš„åŠ è½½è¿‡ç¨‹åˆ†æç»“æŸã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/ext">ext</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync">Apolloæ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.461Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/hql0312" target="_blank" rel="noopener noreferrer">hql0312</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.6.1</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="adminç®¡ç†ç«¯"></a>Adminç®¡ç†ç«¯<a class="hash-link" href="#adminç®¡ç†ç«¯" title="Direct link to heading">#</a></h3><p>ä»¥æ–°å¢æ’ä»¶çš„æµç¨‹æ¥ç†è§£ä¸‹æ•´ä½“çš„æµç¨‹</p><p><img src="/zh/assets/images/Apollo-Sync-b0720ba3b1fe0dfcb554b104a78ce2bd.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ¥æ”¶æ•°æ®"></a>æ¥æ”¶æ•°æ®<a class="hash-link" href="#æ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h3><ul><li>PluginController.createPlugin()</li></ul><p>è¿›å…¥<code>PluginController</code>ç±»ä¸­çš„<code>createPlugin()</code>æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ•°æ®çš„æ ¡éªŒï¼Œæ·»åŠ æˆ–æ›´æ–°æ•°æ®ï¼Œè¿”å›ç»“æœä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/plugin&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @PostMapping(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @RequiresPermissions(&quot;system:plugin:add&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ShenyuAdminResult createPlugin(@Valid @ModelAttribute final PluginDTO pluginDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // è°ƒç”¨pluginService.createOrUpdate è¿›è¡Œå¤„ç†é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return ShenyuAdminResult.success(pluginService.createOrUpdate(pluginDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¤„ç†æ•°æ®"></a>å¤„ç†æ•°æ®<a class="hash-link" href="#å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h3><ul><li>PluginServiceImpl.createOrUpdate() -&gt; PluginServiceImpl.create()</li></ul><p>åœ¨<code>PluginServiceImpl</code>ç±»ä¸­é€šè¿‡<code>create()</code>æ–¹æ³•å®Œæˆæ•°æ®çš„è½¬æ¢ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œå‘å¸ƒäº‹ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº‹ä»¶å‘å¸ƒå¯¹è±¡ pluginEventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PluginEventPublisher pluginEventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String create(final PluginDTO pluginDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // åˆ¤æ–­æœ‰æ²¡æœ‰å¯¹åº”çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Assert.isNull(pluginMapper.nameExisted(pluginDTO.getName()), AdminConstants.PLUGIN_NAME_IS_EXIST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // è‡ªå®šä¹‰çš„æ’ä»¶jar</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!Objects.isNull(pluginDTO.getFile())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assert.isTrue(checkFile(Base64.decode(pluginDTO.getFile())), AdminConstants.THE_PLUGIN_JAR_FILE_IS_NOT_CORRECT_OR_EXCEEDS_16_MB);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // åˆ›å»ºpluginå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      PluginDO pluginDO = PluginDO.buildPluginDO(pluginDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // æ’å…¥å¯¹è±¡åˆ°æ•°æ®åº“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (pluginMapper.insertSelective(pluginDO) &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶æ–°å¢æˆåŠŸï¼Œåˆ™å‘å¸ƒåˆ›å»ºäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish create event. init plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pluginEventPublisher.onCreated(pluginDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return ShenyuResultMessage.CREATE_SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>PluginServiceImpl</code>ç±»å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼Œå³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œå¹¶é€šè¿‡ <code>pluginEventPublisher</code> è¿›è¡Œå‘å¸ƒäº‹ä»¶ã€‚</p><p><code>pluginEventPublisher.onCreateed</code>æ–¹æ³•çš„é€»è¾‘æ˜¯ï¼šå‘å¸ƒå˜æ›´çš„äº‹ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public void onCreated(final PluginDO plugin) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒDataChangeEventäº‹ä»¶ï¼šäº‹ä»¶åˆ†ç»„(æ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™)ã€äº‹ä»¶ç±»å‹(åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°)ã€å˜æ›´çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, DataEventTypeEnum.CREATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collections.singletonList(PluginTransfer.INSTANCE.mapToData(plugin))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒPluginCreatedEvent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publish(new PluginCreatedEvent(plugin, SessionUtil.visitorName()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‘å¸ƒå˜æ›´æ•°æ®é€šè¿‡<code>publisher.publishEvent()</code>å®Œæˆï¼Œè¿™ä¸ª<code>publisher</code>å¯¹è±¡æ˜¯ä¸€ä¸ª<code>ApplicationEventPublisher</code>ç±»ï¼Œè¿™ä¸ªç±»çš„å…¨é™å®šåæ˜¯<code>org.springframework.context.ApplicationEventPublisher</code>ã€‚çœ‹åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬çŸ¥é“äº†å‘å¸ƒæ•°æ®æ˜¯é€šè¿‡<code>Spring</code>ç›¸å…³çš„åŠŸèƒ½æ¥å®Œæˆçš„ã€‚</p><blockquote><p>å…³äº<code>ApplicationEventPublisher</code>ï¼š</p><p>å½“æœ‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…è°ƒç”¨ <code>ApplicationEventPublisher</code> çš„ <code>publishEvent</code> æ–¹æ³•å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œ<code>Spring</code>å®¹å™¨å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onApplicationEvent</code> æ–¹æ³•æŠŠäº‹ä»¶å¯¹è±¡ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚è°ƒç”¨ <code>publishEvent</code>æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å®ç°æ¥å£ç”±å®¹å™¨æ³¨å…¥ <code>ApplicationEventPublisher</code> å¯¹è±¡ç„¶åè°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨å®¹å™¨çš„æ–¹æ³•ï¼Œä¸¤ç§æ–¹æ³•å‘å¸ƒäº‹ä»¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><ul><li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒäº‹ä»¶ï¼›</li><li><code>ApplicationEvent</code>ï¼š<code>Spring</code> äº‹ä»¶ï¼Œè®°å½•äº‹ä»¶æºã€æ—¶é—´å’Œæ•°æ®ï¼›</li><li><code>ApplicationListener</code>ï¼šäº‹ä»¶ç›‘å¬è€…ï¼Œè§‚å¯Ÿè€…ï¼›</li></ul></blockquote><p>åœ¨<code>Spring</code>çš„äº‹ä»¶å‘å¸ƒæœºåˆ¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œ</p><p>ä¸€ä¸ªæ˜¯å‘å¸ƒäº‹ä»¶çš„<code>ApplicationEventPublisher</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡æ„é€ å™¨æ³¨å…¥äº†ä¸€ä¸ª<code>eventPublisher</code>ã€‚</p><p>å¦ä¸€ä¸ªå¯¹è±¡æ˜¯<code>ApplicationEvent</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEvent</code>ç»§æ‰¿äº†å®ƒï¼Œè¡¨ç¤ºäº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åä¸€ä¸ªæ˜¯ <code>ApplicationListener</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEventDispatcher</code>ç±»å®ç°äº†è¯¥æ¥å£ï¼Œä½œä¸ºäº‹ä»¶çš„ç›‘å¬è€…ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="åˆ†å‘æ•°æ®"></a>åˆ†å‘æ•°æ®<a class="hash-link" href="#åˆ†å‘æ•°æ®" title="Direct link to heading">#</a></h3><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>å½“äº‹ä»¶å‘å¸ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿›å…¥åˆ°<code>DataChangedEventDispatcher</code>ç±»ä¸­çš„<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆè¿™é‡Œåªä¼šæ³¨å†ŒApolloDataChangedListenerï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // ä¾æ®ä¸åŒçš„åˆ†ç»„ç±»å‹è¿›è¡Œè½¬å‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case PLUGIN: // æ’ä»¶äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // è°ƒç”¨æ³¨å†Œçš„listenerå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RULE: // è§„åˆ™äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case SELECTOR: // é€‰æ‹©å™¨äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case META_DATA: // å…ƒæ•°æ®äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case PROXY_SELECTOR: // ä»£ç†é€‰æ‹©å™¨äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onProxySelectorChanged((List&lt;ProxySelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case DISCOVER_UPSTREAM: // æ³¨å†Œå‘ç°ä¸‹æ¸¸åˆ—è¡¨äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onDiscoveryUpstreamChanged((List&lt;DiscoverySyncData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnUpstreamChanged((List&lt;DiscoverySyncData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨<code>onApplicationEvent</code>æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œåˆ¤æ–­æ˜¯å“ªç§æ•°æ®ç±»å‹ï¼Œäº¤ç»™ç›¸åº”çš„æ•°æ®ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚</p><p><code>ShenYu</code>å°†æ‰€æœ‰æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±ä¼šæœ‰ä»¥ä¸‹ç§ï¼šè®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯ã€å…ƒæ•°æ®ã€ä»£ç†é€‰æ‹©å™¨ã€å‘ç°ä¸‹æ¸¸äº‹ä»¶ã€‚</p><p>è¿™é‡Œçš„æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆ<code>DataChangedListener</code>ï¼‰ï¼Œå°±æ˜¯æ•°æ®åŒæ­¥ç­–ç•¥çš„æŠ½è±¡,ç”±ç‰¹å®šçš„å®ç°æ¥å¤„ç†ï¼Œè€Œä¸åŒçš„ç›‘å¬ç”±ä¸åŒçš„å®ç°æ¥å¤„ç†ï¼Œå½“å‰åˆ†æçš„æ˜¯Apolloæ¥
ç›‘å¬ï¼Œæ‰€ä»¥è¿™é‡Œåªå…³æ³¨ <code>ApolloDataChangedListener</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ç»§æ‰¿AbstractNodeDataChangedListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedListener extends AbstractNodeDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ApolloDataChangedListener</code> ç»§æ‰¿äº† <code>AbstractNodeDataChangedListener</code> ç±»ï¼Œè¯¥ç±»ä¸»è¦æ˜¯ä»¥keyä½œä¸ºå­˜å‚¨æ–¹å¼çš„åŸºç±»ï¼Œå¦‚apolloã€nacosç­‰ï¼Œå…¶ä»–çš„å¦‚zookeeperã€
consulã€etcd ç­‰æ˜¯ä»¥pathçš„æ–¹å¼è¿›è¡Œåˆ†å±‚çº§æ¥æŸ¥æ‰¾çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ä»¥keyä½œä¸ºæŸ¥æ‰¾å­˜å‚¨æ–¹å¼çš„åŸºç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractNodeDataChangedListener implements DataChangedListener { </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected AbstractNodeDataChangedListener(final ChangeData changeData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.changeData = changeData;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AbstractNodeDataChangedListener</code> æ¥æ”¶ <code>ChangeData</code>ä½œä¸ºå‚æ•°ï¼Œè¯¥å¯¹è±¡å®šä¹‰äº†å­˜å‚¨äºApolloä¸­çš„å„ä¸ªæ•°æ®çš„keyå‘½åï¼Œå­˜å‚¨äºApolloä¸­çš„æ•°æ®åŒ…æ‹¬ä»¥ä¸‹æ•°æ®ï¼š</p><ul><li>æ’ä»¶(plugin)</li><li>é€‰æ‹©å™¨(selector)</li><li>è§„åˆ™(rule)</li><li>æˆæƒ(auth)</li><li>å…ƒæ•°æ®(meta)</li><li>ä»£ç†é€‰æ‹©å™¨(proxy.selector)</li><li>ä¸‹æ¸¸åˆ—è¡¨(discovery)</li></ul><p>è¿™äº›ä¿¡æ¯ç”±ApolloDataChangedListeneræ„é€ å™¨æŒ‡å®š:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedListener extends AbstractNodeDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ApolloDataChangedListener(final ApolloClient apolloClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é…ç½®å‡ ç±»åˆ†ç»„æ•°æ®çš„å‰ç¼€</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.RULE_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.AUTH_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.META_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.PROXY_SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.DISCOVERY_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ“ä½œapolloçš„å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.apolloClient = apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>DataChangedListener</code> å®šä¹‰äº†ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// æ•°æ®å˜æ›´ç›‘å¬å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆæƒä¿¡æ¯å˜æ›´æ—¶è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onAppAuthChanged(List&lt;AppAuthData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ’ä»¶ä¿¡æ¯å˜æ›´æ—¶è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onPluginChanged(List&lt;PluginData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€‰æ‹©å™¨ä¿¡æ¯å˜æ›´æ—¶è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onSelectorChanged(List&lt;SelectorData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å…ƒæ•°æ®ä¿¡æ¯å˜æ›´æ—¶è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onMetaDataChanged(List&lt;MetaData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è§„åˆ™ä¿¡æ¯å˜æ›´æ—¶è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onRuleChanged(List&lt;RuleData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»£ç†é€‰æ‹©å™¨å˜æ›´æ—¶è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onProxySelectorChanged(List&lt;ProxySelectorData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‘ç°ä¸‹æ¸¸ä¿¡æ¯å˜æ›´æ—¶è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onDiscoveryUpstreamChanged(List&lt;DiscoverySyncData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç”± <code>DataChangedEventDispatcher</code>å¤„ç†æ’ä»¶æ—¶ï¼Œè°ƒç”¨æ–¹æ³• <code>listener.onPluginChanged</code>, æ¥ä¸‹æ¥åˆ†æä¸‹å¯¹è±¡çš„é€»è¾‘ï¼Œå®ç°ç”±<code>AbstractNodeDataChangedListener</code>å¤„ç†ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractNodeDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é…ç½®å‰ç¼€ä¸ºplugin.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String configKeyPrefix = changeData.getPluginDataId() + DefaultNodeConstants.JOIN_POINT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.onCommonChanged(configKeyPrefix, changed, eventType, PluginData::getName, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.debug(&quot;[DataChangedListener] PluginChanged {}&quot;, configKeyPrefix);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é¦–å…ˆæ„å»ºé…ç½®æ•°æ®çš„keyå‰ç¼€ä¸ºï¼š<code>plugin.</code>, å†è°ƒç”¨<code>onCommonChanged</code>ç»Ÿä¸€å¤„ç†ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private &lt;T&gt; void onCommonChanged(final String configKeyPrefix, final List&lt;T&gt; changedList,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     final DataEventTypeEnum eventType, final Function&lt;? super T, ? extends String&gt; mapperToKey,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     final Class&lt;T&gt; tClass) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Avoiding concurrent operations on list nodes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock reentrantLock = listSaveLockMap.computeIfAbsent(configKeyPrefix, key -&gt; new ReentrantLock());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reentrantLock.lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å½“å‰ä¼ å…¥çš„æ’ä»¶åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;String&gt; changeNames = changedList.stream().map(mapperToKey).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æŒ‰ plugin.${pluginName} è¿›è¡Œåˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.stream().map(mapperToKey).forEach(removeKey -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        delConfig(configKeyPrefix + removeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»plugin.listä¸­ç§»é™¤å¯¹åº”çš„æ’ä»¶åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // plugin.list è®°å½•ä¸‹äº†ç›®å‰å¯ç”¨çš„åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    delChangedData(configKeyPrefix, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // é‡è½½é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // è·å–plugin.listä¸­çš„æ‰€æœ‰æ’ä»¶åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final List&lt;String&gt; configDataNames = this.getConfigDataNames(configKeyPrefix);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä¾æ¬¡æ›´æ–°å½“å‰è°ƒæ•´çš„æ¯ä¸ªæ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.forEach(changedData -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å‘å¸ƒé…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ç›®å‰å­˜å‚¨çš„åˆ—è¡¨ä¸­ï¼Œå¦‚æœæ•°æ®æ¯”å½“å‰ä¼ å…¥çš„å¤šï¼Œåˆ™åˆ é™¤å¤šä½™çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (configDataNames != null &amp;&amp; configDataNames.size() &gt; changedList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // è¸¢é™¤å½“å‰åŠ è½½çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configDataNames.removeAll(changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // é€ä¸ªåˆ é™¤å·²ç»å–æ¶ˆçš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configDataNames.forEach(this::delConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // é‡æ–°æ›´æ–°åˆ—è¡¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    publishConfig(configKeyPrefix + DefaultNodeConstants.LIST_STR, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ–°å¢æˆ–æ˜¯æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.forEach(changedData -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ–°åŠ çš„æ’ä»¶æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    putChangeData(configKeyPrefix, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;AbstractNodeDataChangedListener onCommonMultiChanged error &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reentrantLock.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨ä»¥ä¸Šé€»è¾‘ï¼Œå…¶å®åŒ…å«å…¨é‡é‡è½½(REFRESHã€MYSELF)ä¸å¢é‡(DELETEã€UPDATEã€CREATE)çš„å¤„ç†</p><p>åœ¨æ’ä»¶ä¸­ä¸»è¦åŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ï¼š</p><ul><li><code>plugin.list</code> å½“å‰ç”Ÿæ•ˆçš„æ’ä»¶åˆ—è¡¨</li><li><code>plugin.${plugin.name}</code> å…·ä½“æ’ä»¶çš„è¯¦ç»†ä¿¡æ¯
æœ€åï¼Œå°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹å¯¹åº”çš„æ•°æ®å†™å…¥Apolloã€‚</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ•°æ®åˆå§‹åŒ–"></a>æ•°æ®åˆå§‹åŒ–<a class="hash-link" href="#æ•°æ®åˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>å½“<code>admin</code>å¯åŠ¨åï¼Œä¼šå°†å½“å‰çš„æ•°æ®ä¿¡æ¯å…¨é‡åŒæ­¥åˆ°<code>apollo</code>ä¸­ï¼Œç”±<code>ApolloDataChangedInit</code>å®ç°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ç»§æ‰¿AbstractDataChangedInit</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedInit extends AbstractDataChangedInit {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // apolloæ“ä½œå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApolloClient apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApolloDataChangedInit(final ApolloClient apolloClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.apolloClient = apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean notExist() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­ pluginã€authã€metaã€proxy.selectorç­‰èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åªè¦æœ‰ä¸€ä¸ªä¸å­˜åœ¨ï¼Œåˆ™è¿›å…¥é‡æ–°åŠ è½½(è¿™äº›èŠ‚ç‚¹ä¸ä¼šåˆ›å»ºï¼Œä¸ºä»€ä¹ˆè¦åˆ¤æ–­ä¸€æ¬¡å‘¢ï¼Ÿ)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Stream.of(ApolloPathConstants.PLUGIN_DATA_ID, ApolloPathConstants.AUTH_DATA_ID, ApolloPathConstants.META_DATA_ID, ApolloPathConstants.PROXY_SELECTOR_DATA_ID).allMatch(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this::dataIdNotExist);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data id not exist boolean.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataId the plugin data id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the boolean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.isNull(apolloClient.getItemValue(pluginDataId));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ¤æ–­<code>apollo</code>ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŒæ­¥ã€‚
è¿™é‡Œæœ‰ä¸€ä¸ªbug, å› ä¸ºè¿™é‡Œåˆ¤æ–­çš„keyï¼Œåœ¨åŒæ­¥æ—¶ï¼Œå¹¶ä¸ä¼šåˆ›å»ºï¼Œåˆ™ä¼šå¯¼è‡´æ¯æ¬¡é‡å¯æ—¶éƒ½é‡æ–°åŠ è½½æ•°æ®ï¼Œå·²æ<a href="https://github.com/apache/shenyu/pull/5435" target="_blank" rel="noopener noreferrer">PR#5435</a></p><p><code>ApolloDataChangedInit</code>å®ç°äº†<code>CommandLineRunner</code>æ¥å£ã€‚å®ƒæ˜¯<code>springboot</code>æä¾›çš„æ¥å£ï¼Œä¼šåœ¨æ‰€æœ‰ <code>Spring Beans</code>åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ<code>run()</code>æ–¹æ³•ï¼Œå¸¸ç”¨äºé¡¹ç›®ä¸­åˆå§‹åŒ–çš„æ“ä½œã€‚</p><ul><li>SyncDataService.syncAll()</li></ul><p>ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œç„¶åè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œæ‰€æœ‰çš„è®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯ã€å…ƒæ•°æ®ã€ä»£ç†é€‰æ‹©å™¨ã€å‘ç°ä¸‹æ¸¸äº‹ä»¶ã€‚ä¸»è¦æ˜¯é€šè¿‡<code>eventPublisher</code>å‘å¸ƒåŒæ­¥äº‹ä»¶ï¼Œ<code>eventPublisher</code>é€šè¿‡<code>publishEvent()</code>å‘å¸ƒå®Œäº‹ä»¶åï¼Œæœ‰<code>ApplicationListener</code>æ‰§è¡Œäº‹ä»¶å˜æ›´æ“ä½œï¼Œåœ¨<code>ShenYu</code>ä¸­å°±æ˜¯å‰é¢æåˆ°çš„<code>DataChangedEventDispatcher</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡æ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // åŒæ­¥authæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // åŒæ­¥æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // é€šè¿‡springå‘å¸ƒ/è®¢é˜…æœºåˆ¶è¿›è¡Œé€šçŸ¥è®¢é˜…è€…(å‘å¸ƒDataChangedEvent)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // ç»Ÿä¸€ç”±DataChangedEventDispatcherè¿›è¡Œç›‘å¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // DataChangedEventå¸¦ä¸Šäº†é…ç½®åˆ†ç»„ç±»å‹ã€å½“å‰æ“ä½œç±»å‹ã€æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // åŒæ­¥é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // åŒæ­¥è§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // ä¸‹æ¸¸åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         discoveryService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="bootstrapåŒæ­¥æ“ä½œåˆå§‹åŒ–"></a>bootstrapåŒæ­¥æ“ä½œåˆå§‹åŒ–<a class="hash-link" href="#bootstrapåŒæ­¥æ“ä½œåˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>ç½‘å…³è¿™è¾¹çš„æ•°æ®åŒæ­¥åˆå§‹åŒ–æ“ä½œä¸»è¦æ˜¯è®¢é˜…<code>apollo</code>ä¸­çš„èŠ‚ç‚¹ï¼Œå½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œæ”¶åˆ°å˜æ›´æ•°æ®ã€‚è¿™ä¾èµ–äº<code>apollo</code>çš„<code>listener</code>æœºåˆ¶ã€‚åœ¨<code>ShenYu</code>ä¸­ï¼Œè´Ÿè´£<code>apollo</code>æ•°æ®åŒæ­¥çš„æ˜¯<code>ApolloDataService</code>ã€‚</p><p><code>ApolloDataService</code>çš„åŠŸèƒ½é€»è¾‘æ˜¯åœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­å®Œæˆçš„ï¼šå¯¹<code>apollo</code>ä¸­çš„<code>shenyu</code>æ•°æ®åŒæ­¥èŠ‚ç‚¹å®Œæˆè®¢é˜…ã€‚é€šè¿‡<code>configService.addChangeListener()</code>æ–¹æ³•å®ç°ï¼›</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataService extends AbstractNodeDataSyncService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApolloDataService(final Config configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;AuthDataSubscriber&gt; authDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;ProxySelectorDataSubscriber&gt; proxySelectorDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;DiscoveryUpstreamDataSubscriber&gt; discoveryUpstreamDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½®ç›‘å¬çš„å‰ç¼€</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.RULE_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.AUTH_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.META_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.PROXY_SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.DISCOVERY_DATA_ID),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                pluginDataSubscriber, metaDataSubscribers, authDataSubscribers, proxySelectorDataSubscribers, discoveryUpstreamDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¼€å§‹ç›‘å¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ³¨ï¼šApolloè¯¥æ–¹æ³•ï¼Œåªè´Ÿè´£è·å–apolloçš„æ•°æ®è·å–ï¼Œå¹¶æ·»åŠ åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œä¸å¤„ç†ç›‘å¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        startWatch();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½®ç›‘å¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        apolloWatchPrefixes();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é¦–å…ˆé…ç½®éœ€è¦å¤„ç†çš„keyä¿¡æ¯ï¼ŒåŒadminåŒæ­¥çš„keyã€‚æ¥ç€è°ƒç”¨<code>startWatch()</code> æ–¹æ³•è¿›è¡Œå¤„ç†æ•°æ®è·å–ä¸ç›‘å¬ã€‚ä½†å¯¹äºApolloçš„å®ç°ä¸­ï¼Œè¯¥æ–¹æ³•åªè´Ÿè´£å¤„ç†æ•°æ®çš„è·å–å¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ä¸­ã€‚
ç›‘å¬ç”±<code>apolloWatchPrefixes</code>æ–¹æ³•æ¥å¤„ç†</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void apolloWatchPrefixes() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å®šä¹‰ç›‘å¬å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConfigChangeListener listener = changeEvent -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            changeEvent.changedKeys().forEach(changeKey -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final ConfigChange configChange = changeEvent.getChange(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æœªå˜æ›´åˆ™è·³è¿‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (configChange == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;apollo watchPrefixes error configChange is null {}&quot;, changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final String newValue = configChange.getNewValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // skip last is &quot;list&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ˜¯listç»“å°¾çš„Keyï¼Œå¦‚plugin.liståˆ™è·³è¿‡ï¼Œå› ä¸ºè¿™é‡Œåªæ˜¯è®°å½•ç”Ÿæ•ˆçš„ä¸€ä¸ªåˆ—è¡¨ï¼Œä¸ä¼šåœ¨æœ¬åœ°ç¼“å­˜ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final int lastListStrIndex = changeKey.length() - DefaultNodeConstants.LIST_STR.length();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (changeKey.lastIndexOf(DefaultNodeConstants.LIST_STR) == lastListStrIndex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ˜¯plugin.å¼€å¤´ =&gt; å¤„ç†æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (changeKey.indexOf(ApolloPathConstants.PLUGIN_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // æ¸…é™¤ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCachePluginData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // æ›´æ–°ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cachePluginData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœæ˜¯selector.å¼€å¤´ =&gt; å¤„ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.SELECTOR_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheSelectorData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheSelectorData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœæ˜¯rule.å¼€å¤´ =&gt; å¤„ç†è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.RULE_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheRuleData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheRuleData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœæ˜¯auth.å¼€å¤´ =&gt; å¤„ç†æˆæƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.AUTH_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheAuthData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheAuthData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœæ˜¯meta.å¼€å¤´ =&gt; å¤„ç†å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.META_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheMetaData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheMetaData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœæ˜¯proxy.selector.å¼€å¤´ =&gt; å¤„ç†ä»£ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.PROXY_SELECTOR_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheProxySelectorData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheProxySelectorData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¦‚æœæ˜¯discovery.å¼€å¤´ =&gt; å¤„ç†ä¸‹æ¸¸åˆ—è¡¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.DISCOVERY_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheDiscoveryUpstreamData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheDiscoveryUpstreamData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;apollo sync listener change key handler error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchConfigChangeListener = listener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ ç›‘å¬</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configService.addChangeListener(listener, Collections.emptySet(), ApolloPathConstants.pathKeySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç”±å‰é¢adminåŠ è½½æ•°æ®çš„é€»è¾‘ï¼Œæ’ä»¶åªä¼šå¢åŠ ä¸¤ä¸ªKeyï¼š<code>plugin.list</code> ä¸ <code>plugin.${plugin.name}</code>,è€Œ <code>plugin.list</code> æ˜¯æ‰€æœ‰å¯ç”¨çš„æ’ä»¶åˆ—è¡¨ï¼Œè¯¥keyçš„æ•°æ®åœ¨
æœ¬åœ°ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œåªä¼šå…³æ³¨<code>plugin.${plugin.name}</code> keyå¯¹åº”çš„æ•°æ®ï¼Œè¿™æ˜¯å¯¹åº”çš„æ’ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>è‡³æ­¤ï¼Œbootstrapåœ¨<code>apollo</code>ä¸­çš„åŒæ­¥é€»è¾‘å°±åˆ†æå®Œæˆã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/apollo">apollo</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcdæ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:13:22.461Z">2025å¹´10æœˆ22æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>Etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>Etcd</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-å…³äºetcd"></a>1. å…³äºEtcd<a class="hash-link" href="#1-å…³äºetcd" title="Direct link to heading">#</a></h3><p><a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener noreferrer"><code>Etcd</code></a>æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒä¸ºå¤§å‹åˆ†å¸ƒå¼è®¡ç®—æä¾›åˆ†å¸ƒå¼é…ç½®æœåŠ¡ã€åŒæ­¥æœåŠ¡å’Œå‘½åæ³¨å†Œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-adminæ•°æ®åŒæ­¥"></a>2. Adminæ•°æ®åŒæ­¥<a class="hash-link" href="#2-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªå®é™…æ¡ˆä¾‹è¿›è¡Œæºç è¿½è¸ªï¼Œæ¯”å¦‚åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼š</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶æ•°æ®"></a>2.1 æ¥æ”¶æ•°æ®<a class="hash-link" href="#21-æ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>è¿›å…¥<code>SelectorController</code>ç±»ä¸­çš„<code>updateSelector()</code>æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ•°æ®çš„æ ¡éªŒï¼Œæ·»åŠ æˆ–æ›´æ–°æ•°æ®ï¼Œè¿”å›ç»“æœä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®å½“å‰é€‰æ‹©å™¨æ•°æ®id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæˆ–æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿”å›ç»“æœä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å¤„ç†æ•°æ®"></a>2.2 å¤„ç†æ•°æ®<a class="hash-link" href="#22-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>åœ¨<code>SelectorServiceImpl</code>ç±»ä¸­é€šè¿‡<code>createOrUpdate()</code>æ–¹æ³•å®Œæˆæ•°æ®çš„è½¬æ¢ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œæ›´æ–°<code>upstream</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è´Ÿè´£äº‹ä»¶å‘å¸ƒçš„eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ•°æ® DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­æ˜¯æ·»åŠ è¿˜æ˜¯æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨ä¸­çš„æ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æƒé™æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®ï¼Œå…ˆåˆ é™¤å†æ–°å¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>Service</code>ç±»å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼Œå³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸æ·±å…¥è¿½è¸ªäº†ã€‚å…³äºæ›´æ–°<code>upstream</code>æ“ä½œï¼Œæ”¾åˆ°åé¢å¯¹åº”çš„ç« èŠ‚ä¸­è¿›è¡Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨å‘å¸ƒäº‹ä»¶çš„æ“ä½œï¼Œå®ƒä¼šæ‰§è¡Œæ•°æ®åŒæ­¥ã€‚</p><p><code>publishEvent()</code>æ–¹æ³•çš„é€»è¾‘æ˜¯ï¼šæ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶ï¼Œæ„å»ºæ¡ä»¶æ•°æ®ï¼Œå‘å¸ƒå˜æ›´æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒå˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‘å¸ƒå˜æ›´æ•°æ®é€šè¿‡<code>eventPublisher.publishEvent()</code>å®Œæˆï¼Œè¿™ä¸ª<code>eventPublisher</code>å¯¹è±¡æ˜¯ä¸€ä¸ª<code>ApplicationEventPublisher</code>ç±»ï¼Œè¿™ä¸ªç±»çš„å…¨é™å®šåæ˜¯<code>org.springframework.context.ApplicationEventPublisher</code>ã€‚çœ‹åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬çŸ¥é“äº†å‘å¸ƒæ•°æ®æ˜¯é€šè¿‡<code>Spring</code>ç›¸å…³çš„åŠŸèƒ½æ¥å®Œæˆçš„ã€‚</p><blockquote><p>å…³äº<code>ApplicationEventPublisher</code>ï¼š</p><p>å½“æœ‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…è°ƒç”¨ <code>ApplicationEventPublisher</code> çš„ <code>publishEvent</code> æ–¹æ³•å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œ<code>Spring</code>å®¹å™¨å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onApplicationEvent</code> æ–¹æ³•æŠŠäº‹ä»¶å¯¹è±¡ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚è°ƒç”¨ <code>publishEvent</code>æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å®ç°æ¥å£ç”±å®¹å™¨æ³¨å…¥ <code>ApplicationEventPublisher</code> å¯¹è±¡ç„¶åè°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨å®¹å™¨çš„æ–¹æ³•ï¼Œä¸¤ç§æ–¹æ³•å‘å¸ƒäº‹ä»¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><ul><li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒäº‹ä»¶ï¼›</li><li><code>ApplicationEvent</code>ï¼š<code>Spring</code> äº‹ä»¶ï¼Œè®°å½•äº‹ä»¶æºã€æ—¶é—´å’Œæ•°æ®ï¼›</li><li><code>ApplicationListener</code>ï¼šäº‹ä»¶ç›‘å¬è€…ï¼Œè§‚å¯Ÿè€…ï¼›</li></ul></blockquote><p>åœ¨<code>Spring</code>çš„äº‹ä»¶å‘å¸ƒæœºåˆ¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œ</p><p>ä¸€ä¸ªæ˜¯å‘å¸ƒäº‹ä»¶çš„<code>ApplicationEventPublisher</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡æ„é€ å™¨æ³¨å…¥äº†ä¸€ä¸ª<code>eventPublisher</code>ã€‚</p><p>å¦ä¸€ä¸ªå¯¹è±¡æ˜¯<code>ApplicationEvent</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEvent</code>ç»§æ‰¿äº†å®ƒï¼Œè¡¨ç¤ºäº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åä¸€ä¸ªæ˜¯ <code>ApplicationListener</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEventDispatcher</code>ç±»å®ç°äº†è¯¥æ¥å£ï¼Œä½œä¸ºäº‹ä»¶çš„ç›‘å¬è€…ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-åˆ†å‘æ•°æ®"></a>2.3 åˆ†å‘æ•°æ®<a class="hash-link" href="#23-åˆ†å‘æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>å½“äº‹ä»¶å‘å¸ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿›å…¥åˆ°<code>DataChangedEventDispatcher</code>ç±»ä¸­çš„<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨<code>onApplicationEvent</code>æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œåˆ¤æ–­æ˜¯å“ªç§æ•°æ®ç±»å‹ï¼Œäº¤ç»™ç›¸åº”çš„æ•°æ®ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚</p><p><code>ShenYu</code>å°†æ‰€æœ‰æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æ˜¯äº”ç§ï¼šè®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯å’Œå…ƒæ•°æ®ã€‚</p><p>è¿™é‡Œçš„æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆ<code>DataChangedListener</code>ï¼‰ï¼Œå°±æ˜¯æ•°æ®åŒæ­¥ç­–ç•¥çš„æŠ½è±¡ï¼Œå®ƒçš„å…·ä½“å®ç°æœ‰ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>è¿™å‡ ä¸ªå®ç°ç±»å°±æ˜¯å½“å‰<code>ShenYu</code>æ”¯æŒçš„åŒæ­¥ç­–ç•¥ï¼š</p><ul><li><code>WebsocketDataChangedListener</code>ï¼šåŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ZookeeperDataChangedListener</code>ï¼šåŸºäº<code>zookeeper</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ConsulDataChangedListener</code>ï¼šåŸºäº<code>consul</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>EtcdDataDataChangedListener</code>ï¼šåŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>HttpLongPollingDataChangedListener</code>ï¼šåŸºäº<code>httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>NacosDataChangedListener</code>ï¼šåŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼›</li></ul><p>æ—¢ç„¶æœ‰è¿™ä¹ˆå¤šç§å®ç°ç­–ç•¥ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>å› ä¸ºæœ¬æ–‡æ˜¯åŸºäº<code>Etcd</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æï¼Œæ‰€ä»¥è¿™é‡Œä»¥<code>EtcdDataDataChangedListener</code>ä¸ºä¾‹ï¼Œåˆ†æå®ƒæ˜¯å¦‚ä½•è¢«åŠ è½½å¹¶å®ç°çš„ã€‚</p><p>é€šè¿‡æŸ¥çœ‹å¯¹<code>EtcdDataDataChangedListener</code>ç±»çš„è°ƒç”¨ï¼Œå¯ä»¥å‘ç°ï¼Œå®ƒæ˜¯åœ¨<code>DataSyncConfiguration</code>ç±»è¿›è¡Œé…ç½®çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * The type Etcd listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @EnableConfigurationProperties(EtcdProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class EtcdListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdClient etcdClient(final EtcdProperties etcdProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Client client = Client.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .endpoints(etcdProperties.getUrl())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdClient(client);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»ºEtcdæ•°æ®å˜æ›´ç›‘å¬å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdDataDataChangedListener(etcdClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»ºEtcdæ•°æ®åˆå§‹åŒ–ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient        the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the etcd data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(EtcdDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdDataInit(etcdClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªé…ç½®ç±»æ˜¯é€šè¿‡<code>SpringBoot</code>æ¡ä»¶è£…é…ç±»å®ç°çš„ã€‚åœ¨<code>EtcdListener</code>ç±»ä¸Šé¢æœ‰å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p><code>@Configuration</code>ï¼šé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ä¸Šä¸‹æ–‡ï¼›</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</code>ï¼šå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šé‡‡ç”¨<code>etcd</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     etcd:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties(EtcdProperties.class)</code>ï¼šå¯¼å…¥å¦ä¸€ä¸ªå±æ€§ç±»<code>EtcdProperties</code>ï¼Œ<code>EtcdProperties</code>ä¸­å„å±æ€§å¯¹åº”é…ç½®æ–‡ä»¶ä¸­ä»¥<code>shenyu.sync.etcd</code>ä½œä¸ºå‰ç¼€çš„å„å±æ€§ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.etcd&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†<code>shenyu.sync.etcd.url</code>å±æ€§æ—¶ï¼Œ<code>Admin</code>å°†é‡‡ç”¨<code>etcd</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ­¤æ—¶é…ç½®ç±»<code>EtcdListener</code>ä¼šç”Ÿæ•ˆï¼Œå¹¶ç”Ÿæˆ<code>EtcdClient</code>, <code>EtcdDataDataChangedListener</code>å’Œ<code>EtcdDataInit</code>ç±»å‹çš„beanã€‚</p><ul><li>ç”Ÿæˆ<code>EtcdClient</code>ç±»å‹çš„beanï¼Œ<code>etcdClient</code>ï¼Œè¿™ä¸ªbeanæ ¹æ®é…ç½®æ–‡ä»¶ï¼Œé…ç½®äº†ä¸etcdæœåŠ¡å™¨çš„è¿æ¥ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æ“ä½œetcdèŠ‚ç‚¹ã€‚</li><li>ç”Ÿæˆ<code>EtcdDataDataChangedListener</code>ç±»å‹çš„beanï¼Œ<code>etcdDataDataChangedListener</code>ï¼Œè¿™ä¸ªbeanå°†bean<code>etcdClient</code>ä½œä¸ºæˆå‘˜å˜é‡ï¼Œå½“ç›‘å¬åˆ°äº‹ä»¶æ—¶ï¼Œè¿›è¡Œå›è°ƒæ“ä½œï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥beanæ“ä½œetcdèŠ‚ç‚¹ã€‚</li><li>ç”Ÿæˆ<code>EtcdDataInit</code>ç±»å‹çš„beanï¼Œ<code>etcdDataInit</code>ï¼Œè¿™ä¸ªbeanå°†bean<code>etcdClient</code>å’Œbean<code>syncDataService</code>ä½œä¸ºæˆå‘˜å˜é‡ï¼Œä½¿ç”¨<code>etcdClient</code>æ ¹æ®etcdè·¯å¾„ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦æœªåˆå§‹åŒ–ï¼Œå½“æœªåˆå§‹åŒ–æ—¶ï¼Œå°†è°ƒç”¨syncDataServiceè¿›è¡Œåˆ·æ–°æ“ä½œï¼Œå°†åœ¨ä¸‹æ–‡è¯¦è¿°ã€‚
æ ¹æ®ä¸Šæ–‡æ‰€è¿°ï¼Œåœ¨äº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ä¸­ï¼Œå°±ä¼šåˆ°ç›¸åº”çš„<code>listener</code>ä¸­ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ˜¯å¯¹ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæ•°æ®åŒæ­¥é‡‡ç”¨çš„æ˜¯<code>etcd</code>ï¼Œæ‰€ä»¥ï¼Œä»£ç ä¼šè¿›å…¥åˆ°<code>EtcdDataDataChangedListener</code>è¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä¼šè¿›å…¥åˆ°EtcdDataDataChangedListenerè¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-etcdæ•°æ®å˜æ›´ç›‘å¬å™¨"></a>2.4 Etcdæ•°æ®å˜æ›´ç›‘å¬å™¨<a class="hash-link" href="#24-etcdæ•°æ®å˜æ›´ç›‘å¬å™¨" title="Direct link to heading">#</a></h4><ul><li><p>EtcdDataDataChangedListener.onSelectorChanged()</p><p>åœ¨<code>onSelectorChanged()</code>æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­æ“ä½œç±»å‹ï¼Œæ˜¯åˆ·æ–°åŒæ­¥è¿˜æ˜¯æ›´æ–°æˆ–åˆ›å»ºåŒæ­¥ã€‚æ ¹æ®å½“å‰é€‰æ‹©å™¨æ•°æ®ä¿¡æ¯åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨<code>etcd</code>ä¸­ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataDataChangedListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdDataDataChangedListener(final EtcdClient client) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€‰æ‹©å™¨ä¿¡æ¯å‘ç”Ÿæ”¹å˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // åˆ·æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcdClient.deleteEtcdPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // å‘ç”Ÿå˜æ›´çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºé€‰æ‹©å™¨æ•°æ®çš„çœŸå®è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          etcdClient.delete(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //create or updateï¼Œåˆ›å»ºæˆ–æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™éƒ¨åˆ†æ˜¯æ ¸å¿ƒã€‚<code>changed</code>è¡¨ç¤ºéœ€æ›´æ–°çš„<code>SelectorData</code>åˆ—è¡¨ï¼Œ<code>eventType</code>è¡¨ç¤ºäº‹ä»¶ç±»å‹ã€‚å½“äº‹ä»¶ç±»å‹ä¸ºåˆ·æ–°<code>REFRESH</code>ï¼Œå¹¶ä¸”<code>SelectorData</code>æœ‰æ”¹åŠ¨æ—¶ï¼Œä¼šå…ˆå°†etcdä¸­è¯¥pluginä¸‹çš„selectorèŠ‚ç‚¹éƒ½å…ˆåˆ é™¤ã€‚æ³¨æ„è¿™é‡Œçš„æ¡ä»¶<code>SelectorData</code>æœ‰æ”¹åŠ¨æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ä¼šå‡ºç°æ²¡æœ‰æ”¹åŠ¨æ—¶è¿›è¡Œåˆ·æ–°ï¼Œå°†æ‰€æœ‰selectorèŠ‚ç‚¹éƒ½åˆ é™¤çš„bugã€‚
è·å–åˆ°selectorå¯¹åº”è·¯å¾„åï¼Œä¼šå¯¹èŠ‚ç‚¹è¿›è¡Œåˆ é™¤ã€åˆ›å»ºæˆ–æ›´æ–°ã€‚</p><p>åªè¦å°†å˜åŠ¨çš„æ•°æ®æ­£ç¡®å†™å…¥åˆ°<code>etcd</code>çš„èŠ‚ç‚¹ä¸Šï¼Œ<code>admin</code>è¿™è¾¹çš„æ“ä½œå°±æ‰§è¡Œå®Œæˆäº†ã€‚</p><p>åœ¨æˆ‘ä»¬å½“å‰çš„æ¡ˆä¾‹ä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼Œå°±ä¼šå¯¹å›¾ä¸­çš„ç‰¹å®šèŠ‚ç‚¹æ›´æ–°ã€‚</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>æˆ‘ä»¬ç”¨æ—¶åºå›¾å°†ä¸Šé¢çš„æ›´æ–°æµç¨‹ä¸²è”èµ·æ¥ã€‚</p><p><img src="/zh/assets/images/etcd-sync-sequence-admin-zh-d9ccd2c6bd5f9b3f135c5420b60fd403.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-ç½‘å…³æ•°æ®åŒæ­¥"></a>3. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#3-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>å‡è®¾<code>ShenYu</code>ç½‘å…³å·²ç»åœ¨æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨çš„æ•°æ®åŒæ­¥æ–¹å¼ä¹Ÿæ˜¯<code>etcd</code>ã€‚é‚£ä¹ˆå½“åœ¨<code>admin</code>ç«¯æ›´æ–°é€‰æ‹©å™¨æ•°æ®åï¼Œå¹¶ä¸”å‘<code>etcd</code>å‘é€äº†å˜æ›´çš„æ•°æ®ï¼Œé‚£ç½‘å…³æ˜¯å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†æ•°æ®çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­è¿›è¡Œæºç åˆ†æï¼Œä¸€æ¢ç©¶ç«Ÿã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-etcdclientæ¥æ”¶æ•°æ®"></a>3.1 EtcdClientæ¥æ”¶æ•°æ®<a class="hash-link" href="#31-etcdclientæ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>EtcdClient.watchDataChange()</li></ul><p>åœ¨ç½‘å…³ç«¯æœ‰ä¸€ä¸ª<code>EtcdSyncDataService</code>ç±»ï¼Œå®ƒé€šè¿‡<code>etcdClient</code>è®¢é˜…äº†æ•°æ®èŠ‚ç‚¹ï¼Œå½“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œå¯ä»¥æ„ŸçŸ¥åˆ°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //çœç•¥å…¶å®ƒä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      etcdClient.watchDataChange(path, (updateNode, updateValue) -&gt; cacheSelectorData(updateValue),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              this::unCacheSelectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //çœç•¥å…¶å®ƒä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Etcd</code>çš„<code>Watch</code>æœºåˆ¶ï¼Œä¼šç»™è®¢é˜…çš„å®¢æˆ·ç«¯å‘é€èŠ‚ç‚¹å˜æ›´é€šçŸ¥ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ›´æ–°é€‰æ‹©å™¨ä¿¡æ¯ï¼Œå°±ä¼šè¿›å…¥åˆ°<code>watchDataChange()</code>æ–¹æ³•ã€‚é€šè¿‡<code>cacheSelectorData()</code>å»å¤„ç†æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-å¤„ç†æ•°æ®"></a>3.2 å¤„ç†æ•°æ®<a class="hash-link" href="#32-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>EtcdSyncDataService.cacheSelectorData()</li></ul><p>ç»è¿‡åˆ¤ç©ºé€»è¾‘ä¹‹åï¼Œç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„æ“ä½œåˆäº¤ç»™äº†<code>PluginDataSubscriber</code>å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final SelectorData selectorData = GsonUtils.getInstance().fromJson(dataString, SelectorData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ª<code>CommonPluginDataSubscriber</code>å®ç°ç±»ï¼Œè´Ÿè´£å¤„ç†æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…"></a>3.3 é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…<a class="hash-link" href="#33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>å®ƒæ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>subscribeDataHandler()</code>æ–¹æ³•ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œæ›´å…·æ•°æ®ç±»å‹ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨æˆ–è§„åˆ™ï¼‰ï¼Œæ“ä½œç±»å‹ï¼ˆæ›´æ–°æˆ–åˆ é™¤ï¼‰ï¼Œå»æ‰§è¡Œä¸åŒé€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å¤„ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å¤„ç†å™¨ï¼Œå¤„ç†æ•°æ®çš„æ›´æ–°æˆ–åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜"></a>3.4 æ•°æ®ç¼“å­˜åˆ°å†…å­˜<a class="hash-link" href="#34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜" title="Direct link to heading">#</a></h4><p>é‚£ä¹ˆæ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³çš„å†…å­˜ä¸­ã€‚<code>BaseDataCache</code>æ˜¯æœ€ç»ˆç¼“å­˜æ•°æ®çš„ç±»ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ã€‚é€‰æ‹©å™¨æ•°æ®å°±å­˜åˆ°äº†<code>SELECTOR_MAP</code>è¿™ä¸ª<code>Map</code>ä¸­ã€‚åœ¨åç»­ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»è¿™é‡Œæ‹¿æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  å…¬å¼€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  ç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç¼“å­˜é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // æ›´æ–°æ“ä½œï¼Œå…ˆåˆ é™¤å†æ’å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // æ–°å¢æ“ä½œï¼Œç›´æ¥æ”¾åˆ°Mapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>äºŒæ˜¯å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†ã€‚  é€šè¿‡<code>idea</code>ç¼–è¾‘å™¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æ–°å¢ä¸€æ¡é€‰æ‹©å™¨åï¼Œæœ‰å¦‚ä¸‹çš„æ’ä»¶è¿˜æœ‰å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä¸å†å±•å¼€äº†ã€‚</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>ç»è¿‡ä»¥ä¸Šçš„æºç è¿½è¸ªï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼Œåœ¨<code>admin</code>ç«¯æ–°å¢æ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œå°±å°†<code>etcd</code>æ•°æ®åŒæ­¥çš„æµç¨‹åˆ†ææ¸…æ¥šäº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡æ—¶åºå›¾å°†ç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æµç¨‹ä¸²è”ä¸€ä¸‹ï¼š</p><p><img src="/zh/assets/images/etcd-sync-sequence-gateway-zh-708de62d8fafbb80c133b20247674db6.png"></p><p>æ•°æ®åŒæ­¥çš„æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œä¸ºäº†ä¸è®©åŒæ­¥æµç¨‹è¢«æ‰“æ–­ï¼Œåœ¨åˆ†æè¿‡ç¨‹ä¸­å°±å¿½ç•¥äº†å…¶ä»–é€»è¾‘ã€‚æˆ‘ä»¬è¿˜éœ€è¦åˆ†æ<code>Admin</code>åŒæ­¥æ•°æ®åˆå§‹åŒ–å’Œç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–çš„æµç¨‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–"></a>4. AdminåŒæ­¥æ•°æ®åˆå§‹åŒ–<a class="hash-link" href="#4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>å½“<code>admin</code>å¯åŠ¨åï¼Œä¼šå°†å½“å‰çš„æ•°æ®ä¿¡æ¯å…¨é‡åŒæ­¥åˆ°<code>etcd</code>ä¸­ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataInit.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void run(final String... args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!etcdClient.exists(pluginPath) &amp;&amp; !etcdClient.exists(authPath) &amp;&amp; !etcdClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.info(&quot;Init all data from database&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ¤æ–­<code>etcd</code>ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŒæ­¥ã€‚</p><p><code>EtcdDataInit</code>å®ç°äº†<code>CommandLineRunner</code>æ¥å£ã€‚å®ƒæ˜¯<code>springboot</code>æä¾›çš„æ¥å£ï¼Œä¼šåœ¨æ‰€æœ‰ <code>Spring Beans</code>åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ<code>run()</code>æ–¹æ³•ï¼Œå¸¸ç”¨äºé¡¹ç›®ä¸­åˆå§‹åŒ–çš„æ“ä½œã€‚</p><ul><li>SyncDataService.syncAll()</li></ul><p>ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œç„¶åè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œæ‰€æœ‰çš„è®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯å’Œå…ƒæ•°æ®ä¿¡æ¯ã€‚ä¸»è¦æ˜¯é€šè¿‡<code>eventPublisher</code>å‘å¸ƒåŒæ­¥äº‹ä»¶ã€‚è¿™é‡Œå°±è·Ÿå‰é¢æåˆ°çš„åŒæ­¥é€»è¾‘å°±åˆè”ç³»èµ·æ¥äº†ï¼Œ<code>eventPublisher</code>é€šè¿‡<code>publishEvent()</code>å‘å¸ƒå®Œäº‹ä»¶åï¼Œæœ‰<code>ApplicationListener</code>æ‰§è¡Œäº‹ä»¶å˜æ›´æ“ä½œï¼Œåœ¨<code>ShenYu</code>ä¸­å°±æ˜¯å‰é¢æåˆ°çš„<code>DataChangedEventDispatcher</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡æ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥å…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–"></a>5. ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–<a class="hash-link" href="#5-ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p>ç½‘å…³è¿™è¾¹çš„æ•°æ®åŒæ­¥åˆå§‹åŒ–æ“ä½œä¸»è¦æ˜¯è®¢é˜…<code>etcd</code>ä¸­çš„èŠ‚ç‚¹ï¼Œå½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œæ”¶åˆ°å˜æ›´æ•°æ®ã€‚è¿™ä¾èµ–äº<code>Etcd</code>çš„<code>Watch</code>æœºåˆ¶ã€‚åœ¨<code>ShenYu</code>ä¸­ï¼Œè´Ÿè´£<code>etcd</code>æ•°æ®åŒæ­¥çš„æ˜¯<code>EtcdSyncDataService</code>ï¼Œä¹Ÿåœ¨å‰é¢æåˆ°è¿‡ã€‚</p><p><code>EtcdSyncDataService</code>çš„åŠŸèƒ½é€»è¾‘æ˜¯åœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­å®Œæˆçš„ï¼šå¯¹<code>etcd</code>ä¸­çš„<code>shenyu</code>æ•°æ®åŒæ­¥èŠ‚ç‚¹å®Œæˆè®¢é˜…ã€‚è¿™é‡Œçš„è®¢é˜…åˆ†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å·²ç»å­˜åœ¨çš„èŠ‚ç‚¹ä¸Šé¢æ•°æ®å‘ç”Ÿæ›´æ–°ï¼Œè¿™é€šè¿‡<code>etcdClient.watchDataChange()</code>æ–¹æ³•å®ç°ï¼›å¦ä¸€ç±»æ˜¯å½“å‰èŠ‚ç‚¹ä¸‹æœ‰æ–°å¢æˆ–åˆ é™¤èŠ‚ç‚¹ï¼Œå³å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼Œè¿™é€šè¿‡<code>etcdClient.watchChildChange()</code>æ–¹æ³•å®ç°ã€‚</p><p><code>EtcdSyncDataService</code>çš„ä»£ç æœ‰ç‚¹å¤šï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥æ’ä»¶æ•°æ®çš„è¯»å–å’Œè®¢é˜…è¿›è¡Œè¿½è¸ªï¼Œå…¶ä»–ç±»å‹çš„æ•°æ®æ“ä½œåŸç†æ˜¯ä¸€æ ·çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * etcd æ•°æ®åŒæ­¥æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå®Œæˆä»etcdä¸­è¯»å–æ•°æ®çš„æ“ä½œï¼Œå¹¶è®¢é˜…èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdSyncDataService(/*çœç•¥æ„é€ å‚æ•°*/) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ’ä»¶èŠ‚ç‚¹è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰€æœ‰æ’ä»¶èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; pluginZKs = etcdClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // è®¢é˜…å½“å‰æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…å­èŠ‚ç‚¹ï¼ˆæ–°å¢æˆ–åˆ é™¤ä¸€ä¸ªæ’ä»¶ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!updateNode.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éœ€è¦è®¢é˜…å­èŠ‚ç‚¹çš„æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherAll(updateNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰æ’ä»¶è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cachePluginData(etcdClient.get(pluginPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ’ä»¶èŠ‚ç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void cachePluginData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional.ofNullable(pluginData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .flatMap(data -&gt; Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -&gt; e.onSubscribe(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å˜æ›´ï¼šæ›´æ–°æˆ–åˆ é™¤ï¼Œä¸¤ä¸ªlambdaè¡¨è¾¾å¼åˆ†åˆ«ä¸ºæ›´æ–°å’Œåˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataPath = buildRealPath(pluginPath, updatePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataStr = etcdClient.get(dataPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Optional.ofNullable(data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .ifPresent(d -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSubscribe(d)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, deleteNode -&gt; deletePlugin(pluginName));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸Šé¢çš„æºä»£ç ä¸­éƒ½ç»™å‡ºäº†æ³¨é‡Šï¼Œç›¸ä¿¡å¤§å®¶å¯ä»¥çœ‹æ˜ç™½ã€‚è®¢é˜…æ’ä»¶æ•°æ®çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><blockquote><ol><li>æ„é€ å½“å‰æ’ä»¶è·¯å¾„</li><li>è¯»å–etcdä¸Šå½“å‰èŠ‚ç‚¹æ•°æ®ï¼Œå¹¶ååºåˆ—åŒ–</li><li>æ’ä»¶æ•°æ®ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­</li><li>è®¢é˜…æ’ä»¶èŠ‚ç‚¹</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-æ€»ç»“"></a>6. æ€»ç»“<a class="hash-link" href="#6-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œå¯¹<code>etcd</code>çš„æ•°æ®åŒæ­¥åŸç†è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>åŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>watch</code>æœºåˆ¶å®ç°ï¼›</li><li>é€šè¿‡<code>Spring</code>å®Œæˆäº‹ä»¶å‘å¸ƒå’Œç›‘å¬ï¼›</li><li>é€šè¿‡æŠ½è±¡<code>DataChangedListener</code>æ¥å£ï¼Œæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼›</li><li>ä½¿ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼å®ç°ç¼“å­˜æ•°æ®ç±»<code>BaseDataCache</code>ï¼›</li><li>é€šè¿‡<code>SpringBoot</code>çš„æ¡ä»¶è£…é…å’Œ<code>starter</code>åŠ è½½æœºåˆ¶å®ç°é…ç½®ç±»çš„åŠ è½½ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/etcd">etcd</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/page/3"><div class="pagination-nav__label">Older Entries Â»</div></a></div></nav></main></div></div></div></div>
<script src="/zh/assets/js/runtime~main.2ef77e12.js"></script>
<script src="/zh/assets/js/main.ca7c9a30.js"></script>
</body>
</html>