<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">One post tagged with &quot;mcp&quot; | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;mcp&quot; | Apache ShenYu"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/tags/mcp"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/tags/mcp"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/mcp" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/tags/mcp" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/mcp" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.581a6ac8.css">
<link rel="preload" href="/zh/assets/js/runtime~main.998966a2.js" as="script">
<link rel="preload" href="/zh/assets/js/main.99739915.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">åŸºé‡‘ä¼š</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">è®¸å¯</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">æ´»åŠ¨</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">å®‰å…¨</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">èµåŠ©</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">éšç§</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">è‡´è°¢</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/mcp" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/tags/mcp" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢ (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><header class="margin-bottom--xl"><h1>One post tagged with &quot;mcp&quot;</h1><a href="/zh/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin">McpServer æ’ä»¶æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-12-01T03:40:34.450Z">2025å¹´12æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/478320" target="_blank" rel="noopener noreferrer">yusiheng</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>åœ¨ shenyu ç½‘å…³ä¸­ï¼Œå¯åŠ¨è¯¥æ’ä»¶ï¼Œshenyu å°†æˆä¸ºä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„ mcpServer,
ä½ å¯ä»¥é€šè¿‡ç®€å•é…ç½®æ¥å°†ä¸€ä¸ªæœåŠ¡ä½œä¸º tool æ³¨å†Œåˆ° shenyu ç½‘å…³ä¸­ï¼Œå¹¶ä½¿ç”¨ç½‘å…³æä¾›çš„æ‰©å±•åŠŸèƒ½ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.7.0.2</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œ åœ¨æœ¬ç¯‡ä¸­æˆ‘å°†è¿½è¸ª Shenyu Mcp æ’ä»¶é“¾è·¯ï¼Œå¯¹ Mcp æ’ä»¶çš„ sse é€šä¿¡æ–¹å¼è¿›è¡Œæºç åˆ†æ</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å‰è¨€"></a>å‰è¨€<a class="hash-link" href="#å‰è¨€" title="Direct link to heading">#</a></h3><blockquote><p>shenyu ç½‘å…³çš„ mcp æ’ä»¶åŸºäº spring-ai-mcp æ‰©å±•è€Œæ¥ï¼Œä¸ºäº†æ›´å¥½çš„äº†è§£ mcp æ’ä»¶çš„å·¥ä½œåŸç†
ï¼Œæˆ‘å°†ç®€å•ä»‹ç» mcp å®˜æ–¹æä¾›çš„ jdk ä¸­å„ä¸ª java ç±»æ˜¯å¦‚ä½•ååŒè¿ä½œçš„</p></blockquote><p>æˆ‘æƒ³å…ˆç®€å•ä»‹ç»ä¸‰ä¸ª Mcp å®˜æ–¹æä¾›çš„ java ç±»</p><blockquote><ol><li><code>McpServer</code></li></ol><p>è¯¥ç±»è´Ÿè´£ç®¡ç†ï¼Œtoolï¼ŒResourceï¼Œpromote ç­‰èµ„æº</p><ol start="2"><li><code>TransportProvider</code></li></ol><p>æ ¹æ®å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´é€šä¿¡åè®®ï¼Œæä¾›ä¹‹ç›¸å¯¹åº”çš„é€šè®¯æ–¹æ³•</p><ol start="3"><li><code>Session</code></li></ol><p>å¤„ç†è¯·æ±‚æ•°æ®ã€å“åº”æ•°æ®å’Œé€šçŸ¥æ•°æ®ï¼Œæä¾›ä¸€äº›åŸºæœ¬æ–¹æ³•å’Œå…¶å¯¹åº”çš„å¤„ç†å™¨ï¼ŒæŸ¥è¯¢å·¥å…·ï¼Œè°ƒç”¨å·¥å…·éƒ½åœ¨æ­¤å¤„æ‰§è¡Œ</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-æœåŠ¡æ³¨å†Œ"></a>1. æœåŠ¡æ³¨å†Œ<a class="hash-link" href="#1-æœåŠ¡æ³¨å†Œ" title="Direct link to heading">#</a></h3><p>åœ¨ shenyu admin çš„ McpServer ä¸­æ’ä»¶å¡«å†™ endpoint å’Œ tool ä¿¡æ¯åï¼Œè¿™äº›ä¿¡æ¯å°†è‡ªåŠ¨æ³¨å†Œåˆ° shenyu bootstrap ä¸­ï¼Œ
æ•°æ®åŒæ­¥æºç å¯ä»¥å‚è€ƒå®˜ç½‘<a href="https://shenyu.incubator.apache.org/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync" target="_blank" rel="noopener noreferrer">websocketæ•°æ®åŒæ­¥</a></p><p>shenyu bootstrap å°†åœ¨ <code>McpServerPluginDataHandler</code> çš„ <code>handler()</code> æ–¹æ³•ä¸­æ¥æ”¶åˆ° admin åŒæ­¥æ¥çš„æ•°æ®ã€‚</p><p><code>handlerSelector()</code> æ–¹æ³•æ¥æ”¶ url æ•°æ®åˆ›å»º McpServer</p><p><code>handlerRule()</code> æ–¹æ³•æ¥æ”¶ tool ä¿¡æ¯ï¼Œæ³¨å†Œ tool</p><p>è¿™ä¸¤ä¸ªæ–¹æ³•å…±åŒç»„æˆäº† Shenyu Mcp æ’ä»¶çš„æœåŠ¡æ³¨å†Œéƒ¨åˆ†ï¼Œä¸‹é¢æˆ‘å°†å¯¹è¿™ä¸ªä¸¤ä¸ªæ–¹æ³•ï¼Œè¯¦ç»†å±•å¼€åˆ†æ</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11-transportmcpserveræ³¨å†Œ"></a>1.1 Transportï¼ŒMcpServeræ³¨å†Œ<a class="hash-link" href="#11-transportmcpserveræ³¨å†Œ" title="Direct link to heading">#</a></h4><p>æˆ‘ä»¬å…ˆæ¥åˆ†æ <code>handlerSelector()</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ McpServer çš„æ³¨å†Œ</p><ul><li><code>handlerSelector()</code> æ–¹æ³• å·¥ä½œå†…å®¹å¦‚ä¸‹</li></ul><ol><li>æ•æ‰ç”¨æˆ·åœ¨ Selector ä¸Šçš„å¡«å†™çš„ urlï¼Œè¿™ä¸ª url å°†ä½œä¸ºä¸€ä¸ª key å­˜å‚¨ McpServer TransportProvider ç­‰ä¿¡æ¯</li><li>åºåˆ—åŒ–åˆ›å»º <code>ShenyuMcpServer</code>ï¼Œ<code>ShenyuMcpServer</code> å°† SelectorId å’Œè¿™äº› url ä¹Ÿå°±æ˜¯è¿™äº› key ç»‘å®šï¼Œä»¥æ­¤æ¥å®ç° selectorId å’Œ key çš„ç»‘å®šã€‚</li></ol><blockquote><p>æ³¨æ„ <code>ShenyuMcpServer</code> æ˜¯ Shenyu ç”¨äºç»‘å®š SelectorId å’Œ url çš„å¯¹è±¡ï¼Œå’Œ <code>McpServer</code> æ²¡æœ‰ç»§æ‰¿å…³ç³»ï¼ŒåŠŸèƒ½ä¹Ÿå®Œå…¨ä¸åŒ</p></blockquote><ol start="3"><li>è°ƒç”¨ <code>ShenyuMcpServerManager</code> çš„ <code>getOrCreateMcpServerTransport()</code> æ–¹æ³•æ³¨å†Œ McpServer TransportProvider</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerSelector(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String uri = selectorData.getConditionList().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(condition -&gt; Constants.URI.equals(condition.getParamType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ConditionData::getParamValue)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .findFirst()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºMcpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuMcpServer shenyuMcpServer = GsonUtils.getInstance().fromJson(Objects.isNull(selectorData.getHandle()) ? DEFAULT_MESSAGE_ENDPOINT : selectorData.getHandle(), ShenyuMcpServer.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuMcpServer.setPath(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç¼“å­˜shenyuMcpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        CACHED_SERVER.get().cachedHandle(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorData.getId(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                shenyuMcpServer);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String messageEndpoint = shenyuMcpServer.getMessageEndpoint();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å°è¯•è·å–æˆ–è€…æ³¨å†ŒtransportProvider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuMcpServerManager.getOrCreateMcpServerTransport(uri, messageEndpoint);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p><code>ShenyuMcpServerManager</code> è¯¥ç±»æ˜¯ ShenYu ä¸­ McpServer çš„ç®¡ç†ä¸­å¿ƒï¼Œä¸ä»…å‚¨å­˜äº† <code>McpAsyncServer</code> <code>CompositeTransportProvider</code> ç­‰å†…å®¹ï¼Œæ³¨å†Œ Transport å’Œ McpServer
çš„æ–¹æ³•ä¹Ÿåœ¨å…¶ä¸­</p><ul><li><code>getOrCreateMcpServerTransport()</code> æ–¹æ³•å·¥ä½œå†…å®¹å…·ä½“å¦‚ä¸‹</li></ul></blockquote><ol><li>å¤„ç†ä¼ é€’æ¥çš„ url å»é™¤/streamablehttp ä»¥åŠ /messageåç¼€ ä½¿å…¶æ¢å¤ä¸ºåŸå§‹çš„ url</li><li>å°è¯•è·å– <code>CompositeTransportProvider</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯ Transport çš„å¤åˆå¯¹è±¡ï¼ŒåŒ…å«äº†å¤šç§åè®®å¯¹åº”çš„ Transport</li><li>å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™è°ƒç”¨ <code>createSseTransport()</code> æ–¹æ³•åˆ›å»º <code>CompositeTransportProvider</code> å¯¹è±¡</li><li>åˆ›å»º <code>McpAsyncServer</code> å¯¹è±¡ï¼Œä¿å­˜ Transport å¯¹è±¡åˆ° Map ä¸­ï¼Œå°† Transport æ³¨å†Œåˆ° <code>McpAsyncServer</code> ä¸­</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuMcpServerManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuSseServerTransportProvider getOrCreateMcpServerTransport(final String uri, final String messageEndPoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å»é™¤/streamablehttp ä»¥åŠ /messageåç¼€</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String normalizedPath = processPath(uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getOrCreateTransport(normalizedPath, SSE_PROTOCOL,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                () -&gt; createSseTransport(normalizedPath, messageEndPoint));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; T getOrCreateTransport(final String normalizedPath, final String protocol,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final java.util.function.Supplier&lt;T&gt; transportFactory) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å¤åˆTransportå®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        CompositeTransportProvider compositeTransport = getOrCreateCompositeTransport(normalizedPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        T transport = switch (protocol) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case SSE_PROTOCOL -&gt; (T) compositeTransport.getSseTransport();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case STREAMABLE_HTTP_PROTOCOL -&gt; (T) compositeTransport.getStreamableHttpTransport();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default -&gt; null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰è¯¥å®ä¾‹ï¼Œåˆ™éœ€è¦é‡æ–°åˆ›å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(transport)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è°ƒç”¨createSseTransport()æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„transportå¹¶å­˜å‚¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            transport = transportFactory.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºMcpAsyncServerï¼Œå¹¶æ³¨å†Œtransport</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            addTransportToSharedServer(normalizedPath, protocol, transport);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return transport;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="111-transportæ³¨å†Œ"></a>1.1.1 Transportæ³¨å†Œ<a class="hash-link" href="#111-transportæ³¨å†Œ" title="Direct link to heading">#</a></h5><ul><li><code>createSseTransport()</code> æ–¹æ³•<blockquote><p>è¯¥æ–¹æ³•åœ¨ <code>getOrCreateMcpServerTransport()</code> æ–¹æ³•è¢«è°ƒç”¨ï¼Œç”¨äºåˆ›å»º Transport</p></blockquote></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuMcpServerManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuSseServerTransportProvider createSseTransport(final String normalizedPath, final String messageEndPoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String messageEndpoint = normalizedPath + messageEndPoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSseServerTransportProvider transportProvider = ShenyuSseServerTransportProvider.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .objectMapper(objectMapper)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sseEndpoint(normalizedPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .messageEndpoint(messageEndpoint)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘Managerçš„routeMapä¸­æ³¨å†ŒtransportProviderçš„ä¸¤ä¸ªå‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRoutes(normalizedPath, messageEndpoint, transportProvider::handleSseConnection, transportProvider::handleMessage);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return transportProvider;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="112-mcpserveræ³¨å†Œ"></a>1.1.2 mcpServeræ³¨å†Œ<a class="hash-link" href="#112-mcpserveræ³¨å†Œ" title="Direct link to heading">#</a></h5><ul><li><code>addTransportToSharedServer()</code> æ–¹æ³•<blockquote><p>è¯¥æ–¹æ³•åœ¨ <code>getOrCreateMcpServerTransport()</code> æ–¹æ³•è¢«è°ƒç”¨ï¼Œç”¨äºåˆ›å»º McpServer å¹¶ä¿å­˜</p></blockquote></li></ul><p>è¯¥æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ McpServerå¹¶å­˜å‚¨åˆ° <code>sharedServerMap</code> ä¸­ï¼Œå¹¶å°†ä¸Šä¸€æ­¥å¾—åˆ°çš„ TransportProvider å­˜å…¥ <code>compositeTransportMap</code> ä¸­</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuMcpServerManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void addTransportToSharedServer(final String normalizedPath, final String protocol, final Object transportProvider) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æˆ–è€…åˆ›å»ºå¹¶æ³¨å†Œ McpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getOrCreateSharedServer(normalizedPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å°†æ–°å¢çš„ä¼ è¾“åè®®å­˜è¿›compositeTransportMapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        compositeTransport.addTransport(protocol, transportProvider);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private McpAsyncServer getOrCreateSharedServer(final String normalizedPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sharedServerMap.computeIfAbsent(normalizedPath, path -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–ä¼ è¾“åè®®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            CompositeTransportProvider compositeTransport = getOrCreateCompositeTransport(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€‰æ‹©Serveræ‹¥æœ‰çš„èƒ½åŠ›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            var capabilities = McpSchema.ServerCapabilities.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .tools(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .logging()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºMcpServerå¹¶å­˜å‚¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            McpAsyncServer server = McpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .async(compositeTransport)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .serverInfo(&quot;MCP Shenyu Server (Multi-Protocol)&quot;, &quot;1.0.0&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .capabilities(capabilities)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .tools(Lists.newArrayList())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-toolsæ³¨å†Œ"></a>1.2 Toolsæ³¨å†Œ<a class="hash-link" href="#12-toolsæ³¨å†Œ" title="Direct link to heading">#</a></h4><ul><li><code>handlerRule()</code> æ–¹æ³• å·¥ä½œå†…å®¹å¦‚ä¸‹</li></ul><ol><li>æ•æ‰ç”¨æˆ·åœ¨ Tool ä¸Šçš„å¡«å†™çš„ tool é…ç½®ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å°†å…¨éƒ¨ç”¨äº tool çš„æ„å»º</li><li>åºåˆ—åŒ–åˆ›å»º <code>ShenyuMcpServerTool</code> è·å– tool ä¿¡æ¯</li></ol><blockquote><p>æ³¨æ„ <code>ShenyuMcpServerTool</code> ä¹Ÿæ˜¯ Shenyu å­˜å‚¨ tool ä¿¡æ¯çš„å·¥å…·ï¼Œå’Œ <code>McpServerTool</code> æ²¡æœ‰ç»§æ‰¿å…³ç³»</p></blockquote><ol start="3"><li>è°ƒç”¨ <code>addTool()</code> æ–¹æ³•ï¼Œ åˆ©ç”¨è¯¥ tool ä¿¡æ¯åˆ›å»º toolï¼Œå¹¶æ ¹æ® SelectorId å°† tool æ³¨å†Œåˆ°ä¸ä¹‹åŒ¹é…çš„ McpServer ä¸­</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerRule(final RuleData ruleData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(ruleData.getHandle()).ifPresent(s -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åºåˆ—åŒ–ä¸€ä¸ªæ–°çš„ ShenyuMcpServerTool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuMcpServerTool mcpServerTool = GsonUtils.getInstance().fromJson(s, ShenyuMcpServerTool.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ç¼“å­˜mcpServerTool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            CACHED_TOOL.get().cachedHandle(CacheKeyUtils.INST.getKey(ruleData), mcpServerTool);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–å¹¶æ„å»º mcp schema</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;McpServerToolParameter&gt; parameters = mcpServerTool.getParameters();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String inputSchema = JsonSchemaUtil.createParameterSchema(parameters);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuMcpServer server = CACHED_SERVER.get().obtainHandle(ruleData.getSelectorId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(server)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å‘Managerçš„sharedServerMapä¸­å­˜å‚¨Toolä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                shenyuMcpServerManager.addTool(server.getPath(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        StringUtils.isBlank(mcpServerTool.getName()) ? ruleData.getName()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                : mcpServerTool.getName(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mcpServerTool.getDescription(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mcpServerTool.getRequestConfig(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputSchema);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>addTool()</code>æ–¹æ³•<blockquote><p>è¯¥æ–¹æ³•è¢« <code>handlerRule()</code> æ–¹æ³•è°ƒç”¨ï¼Œç”¨äºæ–°å¢å·¥å…·</p></blockquote></li></ul><p>è¯¥æ–¹æ³•åšäº†ä¸‹è¿°å·¥ä½œ</p><ol><li><p>å°†ä¸Šä¸€æ­¥ä¼ æ¥çš„ tool ä¿¡æ¯è½¬æ¢ä¸º <code>shenyuToolDefinition</code> å¯¹è±¡</p></li><li><p>åˆ©ç”¨è½¬æ¢æ¥çš„ <code>shenyuToolDefinition</code> å¯¹è±¡åˆ›å»º <code>ShenyuToolCallback</code> å¯¹è±¡</p><blockquote><p><code>ShenyuToolCallback</code> é‡å†™äº† <code>ToolCallBack</code> çš„ <code>call()</code> æ–¹æ³•ï¼Œå¹¶å°†è¯¥ <code>call()</code> æ–¹æ³•æ³¨å†Œåˆ°äº† <code>AsyncToolSpecification</code> ä¸­ï¼Œ
æ­¤åè°ƒç”¨ tool çš„ <code>call()</code> æ–¹æ³•ï¼Œåˆ™å®é™…ä¼šè°ƒç”¨è¿™ä¸ªé‡å†™çš„ <code>call()</code> æ–¹æ³•</p></blockquote></li><li><p>å°† <code>ShenyuToolCallback</code> è½¬æ¢ä¸º <code>AsyncToolSpecification</code> å¹¶æ³¨å†Œåˆ°ç›¸å…³çš„ mcpServer ä¸­</p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void addTool(final String serverPath, final String name, final String description,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String requestTemplate, final String inputSchema) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String normalizedPath = normalizeServerPath(serverPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºDefinitionå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ToolDefinition shenyuToolDefinition = ShenyuToolDefinition.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(name)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .description(description)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .requestConfig(requestTemplate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .inputSchema(inputSchema)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuToolCallback shenyuToolCallback = new ShenyuToolCallback(shenyuToolDefinition);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–åˆ°å…ˆå‰æ³¨å†Œçš„ McpServerï¼Œ å¹¶å‘å…¶ä¸­æ³¨å†ŒTool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        McpAsyncServer sharedServer = sharedServerMap.get(normalizedPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AsyncToolSpecification asyncToolSpecification : McpToolUtils.toAsyncToolSpecifications(shenyuToolCallback)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            sharedServer.addTool(asyncToolSpecification).block();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒæœåŠ¡æ³¨å†Œåˆ†æå®Œæ¯•</p><p>æœåŠ¡æ³¨å†Œä¸€å›¾è§ˆ
<img src="/zh/assets/images/Mcp-server-register-zh-87a3e3bf2133de216e36e9609dcd5aad.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-æ’ä»¶è°ƒç”¨"></a>2. æ’ä»¶è°ƒç”¨<a class="hash-link" href="#2-æ’ä»¶è°ƒç”¨" title="Direct link to heading">#</a></h3><p>å®¢æˆ·ç«¯å…ˆåä¼šå‘é€åç¼€ä¸º <code>/sse</code> å’Œ <code>/message</code> çš„ä¸¤ç§æ¶ˆæ¯ï¼Œè¿™ä¸¤ç§æ¶ˆæ¯éƒ½ä¼šè¢« <code>Shenyu McpServer plugin</code> æ•æ‰ï¼Œ<code>Shenyu McpServer plugin</code>
ä¼šå¯¹ <code>/sse</code> æ¶ˆæ¯å’Œ <code>/message</code> æ¶ˆæ¯åšä¸åŒå¤„ç†ã€‚æ”¶åˆ° <code>/sse</code> æ¶ˆæ¯æ—¶ plugin ä¼šåˆ›å»º session å¯¹è±¡å¹¶ä¿å­˜ï¼Œæœ€åè¿”å› session id
ä¾› message æ¶ˆæ¯ä½¿ç”¨ã€‚æ”¶åˆ° <code>/message</code> æ¶ˆæ¯æ—¶ï¼Œä¼šæ ¹æ® <code>/message</code> æ¶ˆæ¯æºå¸¦çš„ method ä¿¡æ¯ï¼Œé€‰æ‹©æ‰§è¡Œçš„æ–¹æ³•
å¦‚ï¼šè·å–å·¥ä½œåˆ—è¡¨ï¼Œå·¥å…·è°ƒç”¨ï¼Œè·å–èµ„æºåˆ—è¡¨ç­‰ç­‰</p><ul><li><code>doExecute()</code> æ–¹æ³• å·¥ä½œå†…å®¹å¦‚ä¸‹</li></ul><ol><li>è·¯å¾„åŒ¹é…ï¼Œåˆ¤æ–­ mcp plugin æ˜¯å¦æ³¨å†Œè¯¥è·¯å¾„</li><li>è°ƒç”¨ <code>routeByProtocol()</code> æ–¹æ³•ï¼Œæ ¹æ®è¯·æ±‚åè®®é€‰æ‹©åˆé€‚çš„å¤„ç†æ–¹æ¡ˆ</li></ol><blockquote><p>æœ¬ç¯‡æ˜¯å¯¹ sse è¯·æ±‚æ–¹å¼çš„è§£æï¼Œå› æ­¤æ¥ç€è¿›å…¥ <code>handleSseRequest()</code> æ–¹æ³•</p></blockquote><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String uri = exchange.getRequest().getURI().getRawPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­ Mcp æ’ä»¶æ˜¯å¦æ³¨å†Œäº†è¯¥è·¯ç”±è§„åˆ™ï¼Œæ²¡æœ‰åˆ™ä¸æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!shenyuMcpServerManager.canRoute(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServerRequest request = ServerRequest.create(exchange, messageReaders);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ® uri åˆ¤æ–­è·¯ç”±åè®®ï¼Œé€‰æ‹©å¯¹åº”çš„å¤„ç†æ–¹æ¡ˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return routeByProtocol(exchange, chain, request, selector, uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; routeByProtocol(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final ServerRequest request,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final String uri) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isStreamableHttpProtocol(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleStreamableHttpRequest(exchange, chain, request, uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (isSseProtocol(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¤„ç†sseè¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleSseRequest(exchange, chain, request, selector, uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>handlerSseRequest()</code> æ–¹æ³•</p><blockquote><p>è¯¥æ–¹æ³•ç”± <code>routeByProtocol()</code> æ–¹æ³•è°ƒç”¨ï¼Œæ ¹æ®è¯·æ±‚åç¼€åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯è¦åˆ›å»º session è¿˜æ˜¯è°ƒç”¨å·¥å…·</p></blockquote><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; handleSseRequest(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ServerRequest request,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final String uri) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuMcpServer server = McpServerPluginDataHandler.CACHED_SERVER.get().obtainHandle(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String messageEndpoint = server.getMessageEndpoint();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–ä¼ è¾“è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSseServerTransportProvider transportProvider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                = shenyuMcpServerManager.getOrCreateMcpServerTransport(uri, messageEndpoint);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®è¯·æ±‚çš„åç¼€åˆ¤æ–­æ˜¯ sse è¿æ¥è¯·æ±‚è¿˜æ˜¯ message è°ƒç”¨è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uri.endsWith(messageEndpoint)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            setupSessionContext(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleMessageEndpoint(exchange, transportProvider, request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleSseEndpoint(exchange, transportProvider, request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-å®¢æˆ·ç«¯å‘é€-sse-è¯·æ±‚"></a>2.1 å®¢æˆ·ç«¯å‘é€ sse è¯·æ±‚<a class="hash-link" href="#21-å®¢æˆ·ç«¯å‘é€-sse-è¯·æ±‚" title="Direct link to heading">#</a></h4><blockquote><p>å¦‚æœæˆ‘ä»¬å®¢æˆ·ç«¯å‘é€çš„æ˜¯åç¼€ä¸º <code>/sse</code> çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†ä¼šæ‰§è¡Œ <code>handleSseEndpoint()</code> æ–¹æ³•</p></blockquote><ul><li><code>handleSseEndpoint()</code> æ–¹æ³•ä¸»è¦åšäº†å¦‚ä¸‹å·¥ä½œ</li></ul><ol><li>é…ç½® sse è¯·æ±‚å¤´</li><li>è°ƒç”¨ <code>ShenyuSseServerTransportProvider</code> çš„ <code>createSseFlux()</code> åˆ›å»º sse æµ</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; handleSseEndpoint(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         final ShenyuSseServerTransportProvider transportProvider,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½® sse è¯·æ±‚å¤´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configureSseHeaders(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»º sse æµ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return exchange.getResponse()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .writeWith(transportProvider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .createSseFlux(request));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>createSseFlux()</code> æ–¹æ³•<blockquote><p>è¯¥æ–¹æ³•è¢« <code>handleSseEndpoint()</code>è°ƒç”¨ ä¸»è¦ç”¨äºåˆ›å»ºå¹¶ä¿å­˜ session</p></blockquote></li></ul><ol><li>åˆ›å»º session ï¼Œåˆ›å»º session çš„å·¥å‚åœ¨åˆ›å»º session æ—¶ä¼šå°†ä¸€ç³»åˆ— handler æ³¨å†Œåˆ° session ä¸­ï¼Œè¿™äº› handler æ˜¯çœŸæ­£æ‰§è¡Œ
callTool çš„å¯¹è±¡</li><li>å°† session ä¿å­˜ï¼Œsessionå¤ç”¨</li><li>å°† session id ä½œä¸º endpoint çš„è¯·æ±‚å‚æ•°è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œåœ¨è°ƒç”¨ message æ–¹æ³•æ—¶ä¼šä½¿ç”¨è¯¥ endpoint</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSseServerTransportProvider implements McpServerTransportProvider {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Flux&lt;ServerSentEvent&lt;?&gt;&gt; createSseFlux(final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Flux.&lt;ServerSentEvent&lt;?&gt;&gt;create(sink -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    WebFluxMcpSessionTransport sessionTransport = new WebFluxMcpSessionTransport(sink);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // åˆ›å»º McpServerSession å¹¶æš‚å­˜æ’ä»¶é“¾ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    McpServerSession session = sessionFactory.create(sessionTransport);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String sessionId = session.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sessions.put(sessionId, session);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°† session idç­‰ä¿¡æ¯ä¼ é€’å›å®¢æˆ·ç«¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String endpointUrl = this.baseUrl + this.messageEndpoint + &quot;?sessionId=&quot; + sessionId;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ServerSentEvent&lt;String&gt; endpointEvent = ServerSentEvent.&lt;String&gt;builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .event(ENDPOINT_EVENT_TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .data(endpointUrl)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).doOnSubscribe(subscription -&gt; LOGGER.info(&quot;SSE Flux subscribed&quot;))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnRequest(n -&gt; LOGGER.debug(&quot;SSE Flux requested {} items&quot;, n));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å®¢æˆ·ç«¯å‘é€-message-è¯·æ±‚"></a>2.2 å®¢æˆ·ç«¯å‘é€ message è¯·æ±‚<a class="hash-link" href="#22-å®¢æˆ·ç«¯å‘é€-message-è¯·æ±‚" title="Direct link to heading">#</a></h4><blockquote><p>å¦‚æœæˆ‘ä»¬å®¢æˆ·ç«¯å‘é€çš„æ˜¯åç¼€ä¸º <code>/message</code> çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†ä¼šæ‰§è¡Œ æŠŠå½“å‰ <code>ShenyuPluginChain</code> ä¿¡æ¯å­˜å…¥ session ä¸­ï¼Œå¹¶è°ƒç”¨ <code>handleMessageEndpoint()</code> æ–¹æ³•ï¼Œ
åç»­å·¥å…·è°ƒç”¨æ—¶ä¼šç»§ç»­æ‰§è¡Œè¯¥æ’ä»¶é“¾ï¼Œå› æ­¤ mcp plugin åçš„æ’ä»¶ä¼šå¯¹è¿›å…¥ tool çš„è¯·æ±‚é€ æˆå½±å“</p></blockquote><ul><li><code>handleMessageEndpoint()</code> æ–¹æ³•ï¼Œè°ƒç”¨ <code>ShenyuSseServerTransportProvider</code> çš„ <code>handleMessageEndpoint()</code> æ–¹æ³•</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">if (uri.endsWith(messageEndpoint)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       setupSessionContext(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return handleMessageEndpoint(exchange, transportProvider, request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; handleMessageEndpoint(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ShenyuSseServerTransportProvider transportProvider,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†messageè¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return transportProvider.handleMessageEndpoint(request)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(result -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return exchange.getResponse()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .writeWith(Mono.just(exchange.getResponse().bufferFactory().wrap(responseBody.getBytes())));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>handleMessageEndpoint()</code> æ–¹æ³•<blockquote><p>è¯¥æ–¹æ³•ç”± <code>McpServerPlugin.handleMessageEndpoint()</code> è°ƒç”¨ï¼Œå°†è¯·æ±‚äº¤ç»™ session å¤„ç†</p></blockquote></li></ul><p>session çš„ <code>handler()</code> æ–¹æ³•ä¼šå¯¹ message çš„ä¸åŒï¼Œè€Œè¿›è¡Œå¯¹åº”çš„æ“ä½œ
ä¾‹å¦‚ ï¼š å½“ message ä¸­ method æ˜¯ &quot;tools/call&quot; æ—¶ï¼Œåˆ™ä¼šä½¿ç”¨å·¥å…·è°ƒç”¨çš„ handler() æ‰§è¡Œ <code>call()</code> æ–¹æ³•è°ƒç”¨å·¥å…·
ç›¸å…³æºç åœ¨æ­¤ä¸è¿‡å¤šèµ˜è¿°</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSseServerTransportProvider implements McpServerTransportProvider {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;MessageHandlingResult&gt; handleMessageEndpoint(final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–åˆ°session</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sessionId = request.queryParam(&quot;sessionId&quot;).get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        McpServerSession session = sessions.get(sessionId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return request.bodyToMono(String.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(body -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    McpSchema.JSONRPCMessage message = McpSchema.deserializeJsonRpcMessage(objectMapper, body);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return session.handle(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ <code>Shenyu Mcp Plugin</code> æœåŠ¡è°ƒç”¨æºç åˆ†æå®Œæ¯•</p><p>æµç¨‹å›¾ä¸€è§ˆ
<img src="/zh/assets/images/Mcp-server-execute-zh-9cf2daaf68b9189ce0d70536f72f73b8.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-å·¥å…·è°ƒç”¨"></a>3. å·¥å…·è°ƒç”¨<a class="hash-link" href="#3-å·¥å…·è°ƒç”¨" title="Direct link to heading">#</a></h3><blockquote><p>å¦‚æœå®¢æˆ·ç«¯ä¼ é€’çš„æ¶ˆæ¯æ˜¯è°ƒç”¨å·¥å…·çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆ session å°†ä½¿ç”¨å·¥å…·è°ƒç”¨çš„ handler() å¹¶æ‰§è¡Œ tool çš„ <code>call()</code> æ–¹æ³•ï¼Œ
åœ¨æœåŠ¡æ³¨å†Œä¸­ï¼Œæˆ‘ä»¬è¯´æ˜äº† tool åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå®é™…æ‰§è¡Œçš„æ˜¯ <code>ShenyuToolCallback()</code> çš„ <code>call()</code> æ–¹æ³•</p></blockquote><p>å› æ­¤æ‰§è¡Œå·¥å…·è°ƒç”¨æ—¶ä¼šæ‰§è¡Œä»¥ä¸‹æ–¹æ³•</p><ul><li><code>call()</code> ä¸»è¦å·¥ä½œå†…å®¹å¦‚ä¸‹</li></ul><ol><li>è·å– session id</li><li>è·å– <code>requestTemplate</code> å³ shenyu æä¾›çš„é¢å¤–åŠŸèƒ½çš„é…ç½®ä¿¡æ¯</li><li>è·å–ä¸Šä¸€æ­¥æš‚å­˜çš„ shenyu æ’ä»¶é“¾ï¼Œå¹¶å°†å·¥å…·è°ƒç”¨çš„ä¿¡æ¯äº¤ç»™æ’ä»¶é“¾ç»§ç»­æ‰§è¡Œ</li><li>å¼‚æ­¥ç­‰å¾…å·¥å…·å“åº”</li></ol><p>æ’ä»¶é“¾æ‰§è¡Œå®Œæˆåï¼Œä¼šå°†è°ƒç”¨ tool è¯·æ±‚çœŸæ­£çš„å‘é€åˆ° tool æ‰€åœ¨çš„æœåŠ¡ä¹‹ä¸­</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuToolCallback implements ToolCallback {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NonNull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String call(@NonNull final String input, final ToolContext toolContext) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä» mcp è¯·æ±‚ä¸­æå– sessionId</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final McpSyncServerExchange mcpExchange = extractMcpExchange(toolContext);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String sessionId = extractSessionId(mcpExchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æå–requestTemplateä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String configStr = extractRequestConfig(shenyuTool);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ©ç”¨sessionId è·å–åˆ°å…ˆå‰æš‚å­˜çš„æ’ä»¶æ‰§è¡Œé“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServerWebExchange originExchange = getOriginExchange(sessionId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuPluginChain chain = getPluginChain(originExchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰§è¡Œå·¥å…·è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return executeToolCall(originExchange, chain, sessionId, configStr, input);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String executeToolCall(final ServerWebExchange originExchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final String sessionId,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final String configStr,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final String input) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CompletableFuture&lt;String&gt; responseFuture = new CompletableFuture&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServerWebExchange decoratedExchange = buildDecoratedExchange(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                originExchange, responseFuture, sessionId, configStr, input);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰§è¡Œæ’ä»¶é“¾ï¼Œè°ƒç”¨å®é™…å·¥å…·</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        chain.execute(decoratedExchange)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .subscribe();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç­‰å¾…å“åº”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String result = responseFuture.get(DEFAULT_TIMEOUT_SECONDS, TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤Shenyu MCP Plugin å·¥å…·è°ƒç”¨åˆ†æå®Œæ¯•</p><p><img src="data:image/png;base64,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"></p><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-å°ç»“"></a>4. å°ç»“<a class="hash-link" href="#4-å°ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡æºç åˆ†æä» mcp æœåŠ¡æ³¨å†Œå¼€å§‹ï¼Œåˆ° mcp æ’ä»¶çš„æœåŠ¡è°ƒç”¨ï¼Œå†åˆ° tool çš„è°ƒç”¨ã€‚
mcpServer æ’ä»¶è®© shenyu æˆä¸ºä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ï¼Œé›†ä¸­ç®¡ç†çš„ mcpServerã€‚</p><hr></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/mcp">mcp</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about McpServer æ’ä»¶æºç åˆ†æ" href="/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"><b>Read More</b></a></div></footer></article></main></div></div></div></div>
<script src="/zh/assets/js/runtime~main.998966a2.js"></script>
<script src="/zh/assets/js/main.99739915.js"></script>
</body>
</html>