<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">æ‰©å±•æ’ä»¶åŠ è½½é€»è¾‘ | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="æ‰©å±•æ’ä»¶åŠ è½½é€»è¾‘ | Apache ShenYu"><meta data-react-helmet="true" name="description" content="æœ¬æ–‡åŸºäºshenyu-2.6.1ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æ."><meta data-react-helmet="true" property="og:description" content="æœ¬æ–‡åŸºäºshenyu-2.6.1ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æ."><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/Loader-SourceCode-Analysis-ExtLoader"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/Loader-SourceCode-Analysis-ExtLoader"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Loader-SourceCode-Analysis-ExtLoader" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/Loader-SourceCode-Analysis-ExtLoader" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Loader-SourceCode-Analysis-ExtLoader" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.581a6ac8.css">
<link rel="preload" href="/zh/assets/js/runtime~main.998966a2.js" as="script">
<link rel="preload" href="/zh/assets/js/main.99739915.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">åŸºé‡‘ä¼š</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">è®¸å¯</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">æ´»åŠ¨</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">å®‰å…¨</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">èµåŠ©</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">éšç§</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">è‡´è°¢</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/Loader-SourceCode-Analysis-ExtLoader" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/Loader-SourceCode-Analysis-ExtLoader" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢ (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="blogPostTitle_d4p0">æ‰©å±•æ’ä»¶åŠ è½½é€»è¾‘</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-12-01T03:40:34.450Z">2025å¹´12æœˆ1æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/hql0312" target="_blank" rel="noopener noreferrer">hql0312</a></div><small class="avatar__subtitle">hql0312 Coder</small></div></div></header><div class="markdown"><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.6.1</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æ.</p></blockquote><header><h1 class="h1Heading_dC7a">æ­£æ–‡</h1></header><p>Shenyu æä¾›äº†ä¸€ç§æœºåˆ¶æ¥å®šåˆ¶è‡ªå·±çš„æ’ä»¶æˆ–æ˜¯ä¿®æ”¹å·²æœ‰çš„æ’ä»¶ï¼Œåœ¨å…¶å†…éƒ¨é€šè¿‡extPluginçš„é…ç½®å®ç°ï¼Œå…¶éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ol><li>å®ç°æ¥å£ <code>ShenyuPlugin</code> æˆ–æ˜¯ <code>PluginDataHandler</code></li><li>å°†å®ç°çš„åŒ…æ‰“åŒ…åï¼Œæ”¾ç½®äº<code>shenyu.extPlugin.path</code>å¯¹åº”çš„è·¯å¾„ä¸‹</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å…¥å£"></a>å…¥å£<a class="hash-link" href="#å…¥å£" title="Direct link to heading">#</a></h2><p>çœŸæ­£å®ç°è¯¥é€»è¾‘çš„ç±»æ˜¯<code>ShenyuLoaderService</code>,æ¥ä¸‹æ¥çœ‹ä¸‹è¯¥ç±»æ˜¯å¦‚ä½•å¤„ç†</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuLoaderService(final ShenyuWebHandler webHandler, final CommonPluginDataSubscriber subscriber, final ShenyuConfig shenyuConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ’ä»¶ä¿¡æ¯çš„ä¿¡æ¯è®¢é˜…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.subscriber = subscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Shenyuå°è£…çš„WebHandlerï¼ŒåŒ…å«äº†æ‰€æœ‰çš„æ’ä»¶é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.webHandler = webHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.shenyuConfig = shenyuConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰©å±•æ’ä»¶çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚è·¯å¾„ï¼Œæ˜¯å¦å¯ç”¨ã€å¼€å¯å¤šå°‘çº¿ç¨‹æ¥å¤„ç†ã€æ£€æŸ¥åŠ è½½çš„é¢‘ç‡ç­‰ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtPlugin config = shenyuConfig.getExtPlugin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœå¯ç”¨çš„ï¼Œåˆ™åˆ›å»ºå®šæ—¶ä»»åŠ¡æ¥æ£€æŸ¥å¹¶åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (config.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºä¸€ä¸ªæŒ‡å®šçº¿ç¨‹åç§°çš„å®šæ—¶ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScheduledThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(config.getThreads(), ShenyuThreadFactory.create(&quot;plugin-ext-loader&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºå›ºå®šé¢‘ç‡æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤åœ¨30sï¼Œæ¯300sï¼Œæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.scheduleAtFixedRate(() -&gt; loadExtOrUploadPlugins(null), config.getScheduleDelay(), config.getScheduleTime(), TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥ç±»æœ‰ä»¥ä¸‹å‡ ä¸ªå±æ€§ï¼š</p><p><code>webHandler</code>: è¯¥ç±»æ˜¯shenyu å¤„ç†è¯·æ±‚çš„å…¥å£ï¼Œå¼•ç”¨äº†æ‰€æœ‰çš„æ’ä»¶æ•°æ®ï¼Œåœ¨æ‰©å±•æ’ä»¶åŠ è½½åï¼Œéœ€è¦è¿›è¡Œæ›´æ–°</p><p><code>subscriber</code>: è¯¥ç±»æ˜¯æ’ä»¶çš„è®¢é˜…çš„å…¥å£ï¼Œå¼•ç”¨äº†æ‰€æœ‰æ’ä»¶çš„è®¢é˜…å¤„ç†ç±»ï¼Œåœ¨æ‰©å±•é…ç½®åŠ è½½åï¼Œä¹Ÿéœ€è¦è¿›è¡ŒåŒæ­¥æ›´æ–°</p><p><code>executor</code>: åœ¨<code>ShenyuLoaderService</code>å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¥å®šæ—¶æ‰«æåŠ è½½æŒ‡å®šè·¯å¾„ä¸‹çš„jaråŒ…ï¼Œä¾¿äºåŠ è½½æ‰©å±•çš„æ’ä»¶ï¼Œå®ç°åŠ¨æ€å‘ç°
é»˜è®¤ä¼šåœ¨å¯åŠ¨30ç§’åï¼Œæ¯300ç§’æ‰«æä¸€æ¬¡</p><p>åŒæ—¶è¿™é‡Œå¯ä»¥é€šè¿‡ <code>shenyu.extPlugin.enabled</code>é…ç½®æ¥å†³å®šæ˜¯å¦è¦å¼€å¯æ‰©å±•æ’ä»¶åŠŸèƒ½çš„å¯ç”¨</p><p>ä»¥ä¸Šçš„é…ç½®å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè°ƒæ•´ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extPlugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># æ‰©å±•æ’ä»¶çš„å­˜å‚¨ç›®å½•</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># æ˜¯å¦å¯ç”¨æ‰©å±•åŠŸèƒ½</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">threads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># æ‰«æåŠ è½½çš„çº¿ç¨‹æ•°</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleTime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ä»»åŠ¡æ‰§è¡Œçš„é¢‘ç‡</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleDelay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ä»»åŠ¡å¯åŠ¨åå¤šä¹…å¼€å§‹æ‰§è¡Œ</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥ä¸‹æ¥çœ‹ä¸‹åŠ è½½çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   public void loadExtOrUploadPlugins(final PluginData uploadedJarResource) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;ShenyuLoaderResult&gt; plugins = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–ShenyuPluginClassloaderçš„æŒæœ‰å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuPluginClassloaderHolder singleton = ShenyuPluginClassloaderHolder.getSingleton();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(uploadedJarResource)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å‚æ•°ä¸ºç©ºï¼Œåˆ™ä»æ‰©å±•çš„ç›®å½•ï¼ŒåŠ è½½æ‰€æœ‰çš„jaråŒ…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // PluginJarï¼šåŒ…å«ShenyuPluginæ¥å£ã€PluginDataHandleræ¥å£çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;PluginJarParser.PluginJar&gt; uploadPluginJars = ShenyuExtPathPluginJarLoader.loadExtendPlugins(shenyuConfig.getExtPlugin().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // éå†æ‰€æœ‰çš„å¾…åŠ è½½æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (PluginJarParser.PluginJar extPath : uploadPluginJars) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;shenyu extPlugin find new {} to load&quot;, extPath.getAbsolutePath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä½¿ç”¨æ‰©å±•æ’ä»¶çš„åŠ è½½å™¨æ¥åŠ è½½æŒ‡å®šçš„æ’ä»¶ï¼Œä¾¿äºåç»­çš„åŠ è½½å’Œå¸è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPluginClassLoader extPathClassLoader = singleton.createPluginClassLoader(extPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä½¿ç”¨ShenyuPluginClassLoader è¿›è¡ŒåŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä¸»è¦é€»è¾‘æ˜¯ï¼šåˆ¤æ–­æ˜¯å¦å®ç°ShenyuPluginæ¥å£ã€PluginDataHandleræ¥å£ æˆ–æ˜¯å¦æ ‡è¯† @Component\@Serviceç­‰æ³¨è§£ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ³¨å†Œä¸ºSpringBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ„é€  ShenyuLoaderResultå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    plugins.addAll(extPathClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // åŠ è½½æŒ‡å®šjarï¼Œé€»è¾‘åŒåŠ è½½å…¨éƒ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginJarParser.PluginJar pluginJar = PluginJarParser.parseJar(Base64.getDecoder().decode(uploadedJarResource.getPluginJar()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu upload plugin jar find new {} to load&quot;, pluginJar.getJarKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuPluginClassLoader uploadPluginClassLoader = singleton.createPluginClassLoader(pluginJar);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                plugins.addAll(uploadPluginClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å°†æ‰©å±•çš„æ’ä»¶ï¼ŒåŠ å…¥åˆ°ShenyuWebHandlerçš„æ’ä»¶åˆ—è¡¨ï¼Œåç»­çš„è¯·æ±‚åˆ™ä¼šç»è¿‡åŠ å…¥çš„æ’ä»¶å†…å®¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            loaderPlugins(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;shenyu plugins load has error &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥æ–¹æ³•å¤„ç†çš„é€»è¾‘ï¼š</p><ol><li>åˆ¤æ–­å‚æ•°uploadedJarResourceæ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¼šåŠ è½½å…¨éƒ¨ï¼Œå¦åˆ™åŠ è½½æŒ‡å®šèµ„æºjaråŒ…è¿›è¡Œå¤„ç†</li><li>ä» <code>shenyu.extPlugin.path</code> ä¸­è·å–åˆ°æŒ‡å®šjaråŒ…ï¼Œå¹¶å°è£…æˆ PluginJarå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº†jaråŒ…ä»¥ä¸‹ä¿¡æ¯<ul><li>version: ç‰ˆæœ¬ä¿¡æ¯</li><li>groupIdï¼šåŒ…çš„groupId</li><li>artifactId: åŒ…çš„ artifactId</li><li>absolutePathï¼š ç»å¯¹è·¯å¾„</li><li>clazzMapï¼šclasså¯¹åº”çš„å­—èŠ‚ç </li><li>resourceMapï¼šjaråŒ…çš„å­—èŠ‚ç </li></ul></li><li>é€šè¿‡<code>ShenyuPluginClassloaderHolder</code>åˆ›å»ºå¯¹åº”çš„ClassLoader,å¯¹åº”çš„ç±»æ˜¯<code>ShenyuPluginClassLoader</code>, å¹¶è¿›è¡ŒåŠ è½½å¯¹åº”çš„ç±»<ul><li>è°ƒç”¨<code>ShenyuPluginClassLoader.loadUploadedJarPlugins</code> åŠ è½½å¯¹åº”çš„ç±»å¹¶æ³¨å†ŒæˆSpring Beanï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨Springå®¹å™¨æ¥ç®¡ç†</li></ul></li><li>è°ƒç”¨<code>loaderPlugins</code>æ–¹æ³•ï¼Œå°†æ‰©å±•çš„æ’ä»¶æ›´æ–°åˆ° <code>webHandler</code> ä»¥åŠ <code>subscriber</code>ä¸­</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ’ä»¶æ³¨å†Œ"></a>æ’ä»¶æ³¨å†Œ<a class="hash-link" href="#æ’ä»¶æ³¨å†Œ" title="Direct link to heading">#</a></h2><p>å¯¹äºæä¾›çš„jaråŒ…é‡Œçš„å†…å®¹ï¼ŒåŠ è½½å™¨åªä¼šå¤„ç†æŒ‡å®šæ¥å£ç±»å‹çš„ç±»ï¼Œå®ç°é€»è¾‘åœ¨ <code>ShenyuPluginClassLoader.loadUploadedJarPlugins()</code> æ–¹æ³•</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;ShenyuLoaderResult&gt; loadUploadedJarPlugins() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuLoaderResult&gt; results = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰€æœ‰çš„ç±»æ˜ å°„å…³ç³»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; names = pluginJar.getClazzMap().keySet();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ‰€æœ‰çš„ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        names.forEach(className -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å°è¯•åˆ›å»ºå¯¹è±¡ï¼Œå¦‚æœå¯ä»¥ï¼Œåˆ™åŠ å…¥åˆ°Springå®¹å™¨ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                instance = getOrCreateSpringBean(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(instance)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ„å»ºShenyuLoaderResultå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.add(buildResult(instance));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;The class successfully loaded into a upload-Jar-plugin {} is registered as a spring bean&quot;, className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ClassNotFoundException | IllegalAccessException | InstantiationException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.warn(&quot;Registering upload-Jar-plugins succeeds spring bean fails:{}&quot;, className, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥æ–¹æ³•å°±æ˜¯è´Ÿè´£æ„å»ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡ï¼Œå¹¶å°è£…æˆ <code>ShenyuLoaderResult</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯¹äºåˆ›å»ºåå¯¹è±¡ï¼Œè¿›è¡Œäº†å°è£…ï¼Œä¼šåœ¨æ–¹æ³• <code>buildResult()</code>ä¸­è¿›è¡Œå¤„ç†</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuLoaderResult buildResult(final Object instance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuLoaderResult result = new ShenyuLoaderResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºçš„å¯¹è±¡æ˜¯å¦å®ç°äº†ShenyuPlugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (instance instanceof ShenyuPlugin) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setShenyuPlugin((ShenyuPlugin) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆ›å»ºçš„å¯¹è±¡æ˜¯å¦å®ç°äº†PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (instance instanceof PluginDataHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setPluginDataHandler((PluginDataHandler) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŒæ—¶è¿›å…¥æ–¹æ³• <code>getOrCreateSpringBean()</code> è¿›ä¸€æ­¥åˆ†æ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; T getOrCreateSpringBean(final String className) throws ClassNotFoundException, IllegalAccessException, InstantiationException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç¡®è®¤æ˜¯å¦å·²ç»æ³¨å†Œè¿‡äº†ï¼Œå¦‚æœæœ‰åˆ™ä¸å¤„ç†ï¼Œç›´æ¥è¿”å›</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SpringBeanUtils.getInstance().existBean(className)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Double check,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            T inst = SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(inst)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ä½¿ç”¨ ShenyuPluginClassLoader è¿›è¡ŒåŠ è½½ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Class&lt;?&gt; clazz = Class.forName(className, false, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Exclude ShenyuPlugin subclass and PluginDataHandler subclass</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // without adding @Component @Service annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ç¡®è®¤æ˜¯å¦æ˜¯ ShenyuPlugin æˆ–æ˜¯ PluginDataHandlerçš„å­ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean next = ShenyuPlugin.class.isAssignableFrom(clazz)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || PluginDataHandler.class.isAssignableFrom(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœä¸æ˜¯ï¼Œç¡®è®¤æ˜¯å¦æ ‡è¯†äº† @Component ä¸ @Service æ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Annotation[] annotations = clazz.getAnnotations();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    next = Arrays.stream(annotations).anyMatch(e -&gt; e.annotationType().equals(Component.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            || e.annotationType().equals(Service.class));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœç¬¦åˆä»¥ä¸Šå†…å®¹ï¼Œåˆ™æ³¨å†ŒBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    GenericBeanDefinition beanDefinition = new GenericBeanDefinition();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setBeanClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setAutowireCandidate(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // æ³¨å†Œbean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String beanName = SpringBeanUtils.getInstance().registerBean(beanDefinition, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // åˆ›å»ºå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inst = SpringBeanUtils.getInstance().getBeanByClassName(beanName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return inst;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li>åˆ¤æ–­æ˜¯å¦å®ç°äº†æ¥å£ <code>ShenyuPlugin</code> æˆ– <code>PluginDataHandler</code>, å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ˜¯å¦æ ‡è¯†äº† <code>@Component</code> æˆ–æ˜¯ <code>@Service</code></li><li>å¦‚æœç¬¦åˆ1çš„æ¡ä»¶ï¼Œåˆ™å°†è¯¥å¯¹è±¡æ³¨å†Œåˆ°Spring å®¹å™¨ï¼Œå¹¶è¿”å›åˆ›å»ºçš„å¯¹è±¡</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="åŒæ­¥"></a>åŒæ­¥<a class="hash-link" href="#åŒæ­¥" title="Direct link to heading">#</a></h2><p>åœ¨æ’ä»¶æ³¨å†ŒæˆåŠŸåï¼Œè¿™æ—¶åªæ˜¯å®ä¾‹åŒ–äº†æ’ä»¶ï¼Œä½†å®ƒè¿˜ä¸ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºå®ƒè¿˜æœªæ·»åŠ åˆ° Shenyuçš„æ’ä»¶é“¾ä¸­ï¼ŒåŒæ­¥é€»è¾‘ç”± <code>loaderPlugins()</code>æ–¹æ³•å®ç°</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void loaderPlugins(final List&lt;ShenyuLoaderResult&gt; results) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ‰€æœ‰å®ç°äº†æ¥å£ShenyuPluginçš„å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; shenyuExtendPlugins = results.stream().map(ShenyuLoaderResult::getShenyuPlugin).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ›´æ–°webHandlerä¸­plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        webHandler.putExtPlugins(shenyuExtendPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ‰€æœ‰å®ç°äº†æ¥å£PluginDataHandlerçš„å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginDataHandler&gt; handlers = results.stream().map(ShenyuLoaderResult::getPluginDataHandler).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ‰©å±•çš„PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscriber.putExtendPluginDataHandler(handlers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯¥æ–¹æ³•çš„é€»è¾‘å¤„ç†äº†ä¸¤ä¸ªæ•°æ®ï¼š</p><ol><li>å°†å®ç°äº† <code>ShenyuPlugin</code> æ¥å£çš„æ•°æ®ï¼ŒåŒæ­¥è‡³ <code>webHandler</code>çš„plugins åˆ—è¡¨</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtPlugins(final List&lt;ShenyuPlugin&gt; extPlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(extPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿‡æ»¤å‡ºæ–°å¢çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuAddPlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().noneMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿‡æ»¤å‡ºæ›´æ–°çš„æ’ä»¶ï¼Œä»¥åç§°å’Œæ—§çš„ç›¸åŒæ¥åˆ¤æ–­ï¼Œåˆ™ä¸ºæ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuUpdatePlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().anyMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™è·³è¿‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(shenyuAddPlugins) &amp;&amp; CollectionUtils.isEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤åˆ¶æ—§çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // copy new list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; newPluginList = new ArrayList&lt;&gt;(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ æ–°çš„æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add extend plugin from pluginData or shenyu ext-lib</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sourcePlugins.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuAddPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuAddPlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto add extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newPluginList.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¿®æ”¹æ›´æ–°çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuUpdatePlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto update extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ShenyuPlugin updatePlugin : shenyuUpdatePlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; newPluginList.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (newPluginList.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        newPluginList.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; this.sourcePlugins.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (this.sourcePlugins.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.sourcePlugins.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é‡æ–°æ’åº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        plugins = sortPlugins(newPluginList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li>å°†å®ç°äº† <code>PluginDataHandler</code> æ¥å£çš„æ•°æ®ï¼ŒåŒæ­¥è‡³ <code>subscriber</code> çš„handlers åˆ—è¡¨</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtendPluginDataHandler(final List&lt;PluginDataHandler&gt; handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(handlers)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ‰€æœ‰æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (PluginDataHandler handler : handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String pluginNamed = handler.pluginNamed();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°ç°æœ‰çš„PluginDataHandleråˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MapUtils.computeIfAbsent(handlerMap, pluginNamed, name -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu auto add extends plugin data handler name is :{}&quot;, pluginNamed);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ï¼Œæ‰©å±•æ’ä»¶çš„åŠ è½½è¿‡ç¨‹åˆ†æç»“æŸã€‚</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/ext">ext</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Loader-SourceCode-Analysis-ExtLoader.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æœ¬æ–‡æ¡£</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Context-Pathæ’ä»¶æºç åˆ†æ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/Plugin-SourceCode-Analysis-Divide-Plugin"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Divideæ’ä»¶æºç åˆ†æ Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#å…¥å£" class="table-of-contents__link">å…¥å£</a></li><li><a href="#æ’ä»¶æ³¨å†Œ" class="table-of-contents__link">æ’ä»¶æ³¨å†Œ</a></li><li><a href="#åŒæ­¥" class="table-of-contents__link">åŒæ­¥</a></li></ul></div></div></div></div></div></div>
<script src="/zh/assets/js/runtime~main.998966a2.js"></script>
<script src="/zh/assets/js/main.99739915.js"></script>
</body>
</html>