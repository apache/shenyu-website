<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">21 posts tagged with &quot;apache shenyu&quot; | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="21 posts tagged with &quot;apache shenyu&quot; | Apache ShenYu"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//blog/tags/apache-shen-yu"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//blog/tags/apache-shen-yu"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/apache-shen-yu" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/tags/apache-shen-yu" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/apache-shen-yu" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.554d8e36.css">
<link rel="preload" href="/assets/js/runtime~main.cbde5fcb.js" as="script">
<link rel="preload" href="/assets/js/main.a121fc16.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/document">Docs</a><a class="navbar__item navbar__link" href="/community/contributor-guide">Community</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/event">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/apache-shen-yu" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/tags/apache-shen-yu" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><header class="margin-bottom--xl"><h1>21 posts tagged with &quot;apache shenyu&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy  -- analyze the design based on SPI</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.309Z">September 28, 2024</time> · 5 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>In most of the <code>plugins</code> ( such as <code>Dubbo</code>, <code>gRPC</code>,<code>Spring-cloud</code>, etc) of <code>Apache Shenyu</code>, the <code>routing</code>parameters are designed to support the combination of multiple conditions. In order to realize such requirements,  the parameters and behaviors are abstracted to three parts according to its <code>SPI</code> mechanism,  and implemented in <strong><em>shenyu-plugin-base</em></strong>  module.</p><ul><li><code>ParameterData</code>-parameters</li><li><code>PredictJudge</code>-predicate</li><li><code>MatchStrategy</code>-matching strategy</li></ul><p>Relatively speaking, the <code>MatchStrategy</code> is the part that needs the least extension points. For the combined judgement of multiple conditions, the common selection rules are: All conditions are matched, at least one is matched, at least the first is met, or most of conditions  satisfied.  As we will  need to handle various types of parameters, for example: <code>IP</code>, <code>header</code>, <code>uri</code>, etc. </p><p>How to make the <code>MatchStrategy</code> to be simple to use and extensible?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy"></a>MatchStrategy<a class="hash-link" href="#matchstrategy" title="Direct link to heading">#</a></h2><p>The implementation of <code>MatchStrategy</code> is in <strong><em>shenyu-plugin-base</em></strong> module. It is based on the SPI creation mechanism, and has used factory pattern and strategy design pattern. The class diagram of <code>MatchStrategy</code> <code>is</code> showed as follows.</p><p><img alt="MatchStrategy-class-diagram" src="/assets/images/MatchStrategy-class-diagram-ac006eef5089ce92a972e039b431100b.PNG"></p><p>Based on the interface <code>MatchStrategy</code> we design the implementation classes, and the  abstract class <code>AbstractMatchStrategy</code> supplies common method, while the factory class <code>MatchStrategyFactory</code> provides creation  functions.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy-interface"></a>MatchStrategy Interface<a class="hash-link" href="#matchstrategy-interface" title="Direct link to heading">#</a></h2><p>First, let&#x27;s look at the <code>MatchStrategy</code> <code>SPI</code> interface</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean match(List&lt;ConditionData&gt; conditionDataList, ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The annotation <code>@SPI</code> means that this is an <code>SPI</code> interface. Where <code>ServerWebExchange</code> is <code>org.springframework.web.server.ServerWebExchange</code>, represents the request-response  interactive content of HTTP. Following is the code of <code>ConditionData</code>, the more detail about this class can refer to <a href="https://shenyu.apache.org/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI/" target="_blank" rel="noopener noreferrer">code analysis</a> of <code>PredicteJudge</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionData {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String operator;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramValue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractmatchstrategy"></a>AbstractMatchStrategy<a class="hash-link" href="#abstractmatchstrategy" title="Direct link to heading">#</a></h2><p>Second, let&#x27;s look at the abstract class <code>AbstractMatchStrategy</code>，it has defined a <code>buildRealData</code>  method，In this method it wraps various parameters to a unified interface through the functionality of <code>ParameterDataFactory</code>,  which is the factory class of <code>ParameterData</code>. It supports a variety of types of  parameters , such as <code>Ip</code>, <code>Cookie</code>, <code>Header</code>,<code>uri</code>, etc.  Modifications of such parameters will not impact the calling of matching rules of <code>MatchStrategy</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractMatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String buildRealData(final ConditionData condition, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ParameterDataFactory.builderData(condition.getParamType(), condition.getParamName(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="implementation-class-and-profile"></a>Implementation class and profile<a class="hash-link" href="#implementation-class-and-profile" title="Direct link to heading">#</a></h2><p>Now, let&#x27;s look at the two implementation class based on the above interface in  <strong><em>shenyu-plugin-base</em></strong> module , that is:</p><ul><li><p><code>AndMatchStrategy</code>- <code>AND</code> -All conditions are matched</p></li><li><p><code>OrMatchStrategy</code>-   <code>OR</code> -at least one is match</p><p>The properties file containing the SPI implementation is shown as follows, which located at the <code>SHENYU_DIRECTORY</code>directory. When starting up, the top-level SPI classes will read the key-value and  load the classes and cache them.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">and=org.apache.shenyu.plugin.base.condition.strategy.AndMatchStrategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">or=org.apache.shenyu.plugin.base.condition.strategy.OrMatchStrategy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>These two implementation classes inherit <code>AbstractMatchStrategy</code> class and implement <code>MatchStrategy</code> interface.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="andmatchstrategy---and-relation"></a>AndMatchStrategy-  “AND” relation<a class="hash-link" href="#andmatchstrategy---and-relation" title="Direct link to heading">#</a></h3><p>Since the <code>PredicateJudge</code> interface can encapsulate different variety of Predicates , for example  EqualsPredicateJudge, EndsWithPredicateJudge and so on, the <code>ConditionData</code> and <code>ParamData</code> passed to it can present with variety of parameters, for treating of multiple conditions. So using<code>stream</code> and <code>lambda</code> expression, it can be very simple and efficient to process &quot;AND&quot; logic (all conditions must be matched).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AndMatchStrategy extends AbstractMatchStrategy implements MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean match(final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return conditionDataList</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .allMatch(condition -&gt; PredicateJudgeFactory.judge(condition, buildRealData(condition, exchange)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>OrMatchStrategy</code> similarly implements the &quot;OR&quot; logic- at least one is match.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategyfactory"></a>MatchStrategyFactory<a class="hash-link" href="#matchstrategyfactory" title="Direct link to heading">#</a></h2><p>This is the factory class of <code>MatchStrategy</code>，there are  two methods,  one is <code>newInstance()</code>, which will return the <code>MatchStrategy</code> implementation class instance cached by the <code>SPI</code> <code>ExtensionLoader</code> indexed by the key-value.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static MatchStrategy newInstance(final Integer strategy) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String matchMode = MatchModeEnum.getMatchModeByCode(strategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(MatchStrategy.class).getJoin(matchMode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>the <code>matchMode</code> will be the name of strategy, the value will be &quot;and&quot; or &quot;or&quot;. The <code>MatchModeEnum</code> defines the code and name of match strategy as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">AND(0, &quot;and&quot;), </span></span><span class="token-line" style="color:#393A34"><span class="token plain">OR(1, &quot;or&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Another method is <code>match()</code> method, which will invoke the <code>match()</code> method of  implementation class. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean match(final Integer strategy, final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(strategy).match(conditionDataList, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-it-works"></a>How it works<a class="hash-link" href="#how-it-works" title="Direct link to heading">#</a></h2><p><code>AbstractShenyuPlugin</code> is the base class of <code>plugins</code> in <code>shenyu-plugin</code> module. In this class two selection method are defined: <code>filterSelector()</code> and <code>filterRule()</code> , Both of them call the  <code>match()</code> method of <code>MatchStrategyFactory</code>. The code  of <code>filterSelector()</code> is shown as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterSelector(final SelectorData selector, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (selector.getType() == SelectorTypeEnum.CUSTOM_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selector.getConditionList())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return MatchStrategyFactory.match(selector.getMatchMode(), selector.getConditionList(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In <code>filterSelector</code>() method, after validation of  the <code>SelectorData</code>, calls the <code>match</code> method of <code>MatchStrategyFactory</code>, and then this factory class will invokes the <code>match</code> method of corresponding implementation class. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterRule(final RuleData ruleData, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleData.getEnabled() &amp;&amp; MatchStrategyFactory.match(ruleData.getMatchMode(), ruleData.getConditionDataList(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In <code>filterRule()</code> it is also calls the  <code>match()</code> method of <code>MatchStrategyFactory</code>.  Does it look particularly concise or even simple?  In the <a href="https://shenyu.apache.org/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI/" target="_blank" rel="noopener noreferrer">code analysis</a> of  <code>PredicteJudge</code> , you can  see more detail about parameter processing in <code>shenyu-plugin</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Due to the use of  <code>SPI</code> mechanism of <code>Apache Shenyu</code>, the parameter selection module has the characteristic of loose coupling and extensibility. In terms of  the combination of multiple conditions, <code>MatchStrategy</code> provides a good design.  Although currently only two implementation classes are present, it can be easily used to develop more complex <code>MatchStrategy</code> rules in the future,  such as &quot;<code>firstOf</code>&quot;-first condition must matched, or &quot;<code>mostOf</code>&quot;- most of the conditions must be matched, etc.</p><p>Interested readers can read the source code of <code>&#x27;shenyu-plugin&#x27;</code> to learn more.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about MatchStrategy  -- analyze the design based on SPI" href="/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge -- analyze the design based on SPI</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.309Z">September 28, 2024</time> · 6 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p><strong>Apache Shenyu</strong> has been identified as a gateway application which supports a variety of protocols and  microservice frameworks such as  Dubbo, gRPC, Spring-Cloud, etc.  To do this, the product has accomplished an elegant <code>SPI</code> (Service Provider Interface) as its foundation, and make the  Rule data parsing and predicting program very simple , resiliency and security. As to rule data parsing processing,  the <code>SPI</code> design increases the product&#x27;s scalability. When appending new plugin, in most cases, the   existing module is enough for rule data parsing , otherwise it can be rapidly carry out with tiny effort. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="top-level-design-of-spi"></a>Top level design of SPI<a class="hash-link" href="#top-level-design-of-spi" title="Direct link to heading">#</a></h2><p> In <code>Apache Shenyu</code>, the <code>SPI</code> archtecure is defined in <strong><em>shenyu-spi</em></strong> module and composed of three parts:   <code>SPI</code> interface,  factory  design pattern,  and configuration file. There is  two interface defined as annotation: @SPI and @Join. When class file with  @Join annotation,  it means that it will join as an <code>SPI</code> extension class, in other words, it is an application or registration.  The  @SPI denotes that the class is an <code>SPI</code> extension class.</p><p>Fig 1 classes in the <strong><em>shenyu-spi</em></strong></p><p><img alt="toplevel-SPI" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASkAAACeCAYAAABuIfz7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAABX0SURBVHhe7Z39kxXVmcf5l1L70/y2STbRaLTKJEQoeTFBBtYkG8iS2ggoiChCcBCFlEQriElF0RWoiplaYGCDMRiRXQEtglNmABdKN1izI+iaicBJP6fP6T4vz+nue29f7pnu78c65b3d5637nudzTx/udM8SAAAQMZAUACBqICkAQNRAUgCAqBmYpM5f/FCcfu+slcbPvi8uf/KpygEAAAOU1KvHTog9+3/npX0HjkhZge4ZHZ4lZg2Pqnc3hkG0GRvyHAyNiHH1HtQDK6kXXnhB7N69W0xMTKgtNpOTk2LPnj0yH6VuCElKpzN/Pqdygk6BpAbBuBgZgqT6ASspElRIVK6g+iWpKonqAD6QFGgSrKRITJyoXEG98cYbMnUDJNU/ICnQJIJrUq6oTp065Qnq+vXrMnVD3yU1PiKGZiWBYyQ3hmRgJdPz0ZGhNI85VR8dtsoOjYym0/nCQFRT/qzcsDBz6/bG3b55dRbXkzIqhs06jL5rYYzr4wrV4faj9FLFbtPsdj1tquMuqCc7h+q9Rm9/V/VxaMTOESqXU3JsVLbkcytvA3RD4cK5KSozaUH1giup3xx+TZy78IH4+Mon8v+vHP6DtZ9LQUkpwVhjSA0wc/DKQcUMNh0g3kBl8pqMjwyLvHp/jSKrwxzIeuAb9ZbVo4/PCsSknsSjEt1Ovl8FoFfHUHE7Fn7wj474x9Zbm+o9V48+P14dRJonzeL3k5D96/HYrPLM51bcBuiWQkkRrqjqEBThSuri/15Se1IufvgXaz+XeEnxg5RI5eN8K3vf9qHyKoAKJOUhA6qsPb9fHlY95f3ggsVuI63Dq0IGnisAhQrKULP1tKmOrUI91udjnZ8uJFXl2LL6c9jxBEnVTqmkCC2qugRFuJL6/OpVtSfl88+vWvu5xEqqaMA538LsoAqWL5cDkQ5oM1UYxMzsIFhPSUARsqyTwQooVYddf574utXxUx7mGOppkz/Hrgzk+6wPrrS6mUlVOLYKn1txG6BbKkmqH7iSmpz6WO1Joffmfi7FJak0OMxgStvL31cb7CX11CipojqCmLIxjqWeNqtJKq1LnS/ztaQbSSmKjq30c6vYBuiYaCQ19oc3xZVP/1/uo//Te3M/l1hJBQYp4Q52flCFyit5hKLMGbAE254ZbAqrH6X1hI9PI+srDPTyOkqR/cylU0+bFSWl8lFdcp/1GfJ18J91AO7Yyj435j2oh2gkpRMtoHPbucRLSg9q51vbGXhEaFClg9IWRbotSVkFjrTc+rNv5Xxw+3UkuOUq1BM6Pv1etmPt1GVK6qC2sg3O8SX7hu0TkpR3ZhE9t1lVUgnU/lByzEl+J3vaFzO/Oqf5Z93FsZn5CVWnvclsA9RFdJLqJIUkJdEDM0u2dIiiQZUNTJWGR90A8gNKB6FMVK/sQx4sur3sJw9Z3SqDoqweiXt8RiWyHadSLtCtdihZ58I/PvucMBLvQ5sEV0/SYioabzuh6tFtJPXpc5+21cWxVfjc7DZAXTRXUrXDB1AnYBDXSe+fR1XwuQ2WgUlq6vIn4tLk//WUqI4bhrrs6iUmMNhrRH4e/uy4H+BzGywDk1TM0OWFvcCrLi16HKgY7PUhz+UNmEUR+NwGCyQVQA5MY/2hjoDAYO+dbE3rBp5HfG6DBZICAEQNJAUAiBpICgAQNZAUACBqICkAQNRAUgCAqIGkAABRA0kBAKKmdZL627VpcXbqjDh64aA4dH6fTPSattE+AEBctEZS15P/3rn0pnj+9Hax6+0RNtE+ykN5AQBx0ApJTV/9q9g/8RIrJi5RXirTVCbunyWemjsiJtV7AGKm8ZKiWVEngtKJyhTNqCZ3Dokd/zDLS2NHVIZoGRfH5/ZPUjP3vIBYabyk6PKNk1CVRGVDUDD2FuijYuwLzQteeV6+MCz4B/TXQTPPGwjTaEnRQnhoDWrJ2rvEwhXflIlec3mobGgxHZLigaRA3TRaUmen3mXlQ2nL/gfEvGV3yESvuTyUqA6OIknRPv8SJw2up+4fzfab6aWdxo1Azo6Il5K8ep/djrpcc+rxxZC2p/ebfWHXpJw23TJV25XnpVBSaT2h8il233VfOz1vlFyZ6WOfUHXR65OBNTqs3cVBoyX1+sUxVjw63bt+gUzcPp2oDg4ZjAUD2B7geYDnBGYER4aTwB0Sx8+q994aUh7keYDmAjTfmwE8sTPvqxd8SZteQKuAz+uo0m65pCZ3DhccW4Lqiyuf41nfwuet/BjSY6d81mfhnXMi0A644TRaUofO7WPFo1MVSVEdHNy3uh2cuSj4wOWCIA1aLzBksOkgYgI7wWpDBWcowGxJ5f10sftdoV31vvi8OEhBOG1YMnfhzlvVY1DH7vUnbdcqb/ULDBJIqgdJuQHroWThf0sTTLCp/G6Q65Tm5QOZEwqV4fpoSapIaNYMo0q7/nsOPZvRKctfIteU8HkrPwZX0Dn258lICwwMXO6VSKrbyz1Jl5IqDtJqspCo+lxZDU5S6TFb+80ZS6Xj74+k0jpUPvM1GDitXTh//MCabOGcXnN5KHWzcJ6SfxvzeZlgU9uKv8E7kJQmCVQSlW7LDtRwm3adNUjKEQZh569y/J2dN7c/QUmVfl5gUDRaUoP8CYIdDFyA84FF9ZpCkdA3e1a2giyS/GNmvSWzCbZNR2x1ScqqU82A3PJcX/L3HZw37xiKJJVA52lu0lZynFY9YKA0WlJEP3/MSQHgJgpiGQju5YIOSDPIVRBRMoPOrdsOqmqyoD5k5Z2+sIFq9IUrU4ukEsxjk30gMbj53b44bYbOW/kxlEhKCbCo/+DG03hJ9evPYkAT4UUMBkvjJUXgD4xBJbBgHiWtkBRBsyK6fAutUVGifZQHM6h2Ii8FMYuKjtZISkML4bjpHTDR62ThtSowSFonKQDAzAKSAgBEDSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKhpvKQuf/KpOHz0uNj18m/Fq8feUlsBADOFRkvqg798JJ7bMyp+/vw+mXa/clBMX7su/jQ1LQ5cuCL2nr8sE72mbbQPABAXjZUUzaBMQVHad/SE2HZ6Umx++yM20b5jlz7DH8UAEBGNlRRd4pmCembvfvHYiQ9ZObnpxYmPxWdXr6mamkfx7UpmMriLQRNprKR2vZzPop7Zs19s+a//EVv++OeORFU0ozLvi2Sm+G+WpgK5T5Iqu59Uf4GkmkhjJfXqsRNi9ytj8hKPxESC+vmLvxFPHvpvVkpcoku/EDIYewp07ja4Mx9ICtRNoxfOaSFcr0GRqEhQO/79P+Tr5b/eLxasf0LMXrFWfGfTDrHm8DuepKhsaDEdkuKBpEDdNFpSZ6amPfE89tYHYtFDj4ub5i8Wdz/6M7HkyV+KOSsfEbct/ZHYyFwKUh0cRZKiff6ln7o1bRJAer+ZrNvgqlsN6312O3kgmvX4Ykjb0/vNvrBrUk6bbpmq7crzUiap0raItL1QOxLvNsMjvKQKz2d+PsynGnf/5QPqptGSOnjxiiedZb8aFTcvXCLWH33P2r4pkZf5Xieqg0MGY8FgtkXAfcMHZlLynt/m3SFVWacuCqZcbLkAzfem+GJ5gnG1tqieak86Nuuh46Jt1nkuPZ+BciAaGi2pvecue9KZ/+AWOYNyt4cS1cFhziZ0soMzFwUfuJyk0gDyxCWDWAcaE7AJVhsq6L16FLakfKFp7H5XaJd5b1O1LQYpG70/VI/qYyabKudTnY+itsFAaaekNmz3todSkaTcgPVQsuCeWsJKSuV35adTmtcNxBROKFSG66MlqSKhWbOQKu2WyKZyWyl6hqNTVm+wHqePlc6nK20QG+283FswLNb9ftzavmbspPVep24v9yQqSDqVFBvEGdVkITGC1Oxr/JJKz41VjzmTCtbDS6r4fEJSsdO6hfPNpy6JOas2iJvm3SNoRjW8dZf4xvLV4ub5i8WGY+97+btZOE9JAya73PPyMpIKXsaYdCApTRLg4ZlDuE27zhokVbUtZlZl1xuqJ92e97HK+YSkYqfRkjJ/gmClRFQ0o5q3dkTMue9hsXjrs+Kh1+yZFaVefoJgD3wuwPkAonpNoUhoRpCVrSCLJH+UTzBOqNSW+17NiMx65TE4IqNtVM7sI9uedT4hqdhptKQI+kGmK5+qqezHnDT43UQBwgVQFmhmkKtgpGTKyq3bDqBqstABK8szwewFpdEXrkwnkjLryeoLHLfc57Vl1yP7mpRx5WceI6WxI+E+mvncY4ek4qbxkqJ5EP2JCyeholT2ZzEAgBtD4yVF0B8LdyKqpv+BMQAziVZIiqBZEV2+sWtUKtE+3KoFgLhojaQ0tBCOm94BMHNonaQAADMLSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCiBpICAERN6yT1t2vT4uzUGXH0wkFx6Pw+meg1baN9AIC4aI2krif/vXPpTfH86e1i19sjbKJ9lIfyAgDioBWSmr76V7F/4iVWTFyivFSmn+D2IABUo/GSollRJ4LSicqUz6j4+xeVo8pBUgCU0nhJ0eWbKZ9nT42INc8tEwtWfEvcftc/iVvnfEl8e+nXxfKRe8TTxx618lLZYrqVFACgKo2WFC2Em2tQO08+JhatvFPMufc28dDuFeIXb22W27f9bp249+GFYvbiW8VTr2/I8lPZ4sV0SAqAftNoSZ2dejcTDqVVz3xfzF5yq3jmzY3JrGmjWL3zX8SKbUvEfTvuFTuOPiLuWT1X/GDj3VYZqiNMQFLqVsHmLWute2wn2GtSeT3WbXML7hUOQFtotKRevzhmCeeuZXdIUe1441HxzUVfE8s2f1ds2PMTccudXxI/fWWlfE3bzTJURxhGUu5DBAglLfM+5pykqFyex33yCQDtpNGSOnRunyWc2+d/VWz+7Sqx5rkfijv/+Ta5jS4Bb/n2F8XI/gfE4wfWSGGZZaiOMK6kwo9Qch9YwM6knIV0twwAbaRdkpr3FSmjnySXdwtXfEtu2/bqevG12f8onvjPdWLd8//qzaQ6kpSaMbmXdhL5tJP8qSihyz0TSAqAll3uzf3e7eL+XT+UM6avz/2yvPRbtGqOuH3BV8XSdfPE7OFbxY+fXGKVqXK5l82cICkAaqdVC+ckoHnL75A/Q6AZ1Y+3LxWPvPxvciF9ZSIs+hc/2meWKV44Ty/vcin1eLkHSQHg0WhJuT9BePr4JrkWtfj+uWLr4QflNlqTeiJ5TQvnOp9OZT9B4CRC27yFc2YxHZICoBqNlhTh/pjz6WTWtOyxRfIHnLQWdcudX5SXgat/8QMrHyX+x5ypUNKfCPhP3pUoKenE5YOkAKhG4yXV3z+LAQD0m8ZLiojxD4wBANVohaQImhXR5Zu5RuUm2kd5MIMCIB5aIykNLYTjpncAzBxaJykAwMwCkgIARA0kBQCIGkgKABA1kBQAIGogKQBA1EBSAICogaQAAFEDSQEAoqZ1ksIvzgGYWbRGUvjbPQBmJq2QFO6CAMDMpfGSollRJ4LSicqUzqjcm9tlN7FL0XfpLMpj3/wOAODSeEnR5Zspn7oes87eNTORlnl/c5nHEpC6A6exDZICoJhGS4oWws01qPoesx5+4IKJL6kE54kykBQAxTRaUv17zHq1pwuzknKeMANJAVBMoyXVz8esk1zkGlOBqMIzqdDz9wAALo2WVL8fs04SyhbEGVn5kvJnYJAUAMW0S1K1P2Y9JZtVOY+uMiWmk7uOBUkBUEyrLvfqf8y6ifqXO+Nf/Pg1KRtICoBiWrVwXv9j1h2ODENSANRMoyXl/gShvses09qS+1Ri/ynEkBQAvdNoSRHujzl7f8y6Jl0EL1pvgqQA6J3GS6qvfxYDAOg7jZcUgT8wBmDm0gpJETQross3c43KTbSP8mAGBUA8tEZSGloIx03vAJg5tE5SAICZBSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCipnWSmr52XfxpalocuHBF7D1/WSZ6TdtoHwAgLlojKdLPsUufiW2nJ8Xmtz9iE+2jPFAVAPHQCkl9dvWaeHHiY1ZMXKK8VOZG0aTbteDWM6BuGi8pmhV1IiidqEzpjKrkCcbV8B8Yyt0bnZJ+DFa8+MdSJzP3vIBeaLyk6PKNk1CVRGVDyBvalTzBuFuq3CyvGPvZfk2BPee10szzNtNptKRoITy0BrX81/vFgvVPiNkr1orvbNoh1hx+x8tDZakOn3Qw1yEkDkiKB5JqJ42W1JmpaU88m09dEnc98FNx0/zF4u5HfyaWPPlLMWflI+K2pT8SG0986OWnOnzSwVz2BONsfUY9Wl1fnrjl3HWcIknRPv8SJ++P3m8mS6ZuX6x28vu0m/X4Ykjb0/vNvrBrUk6bbpmq7crzUiiptJ5Q+RS777qvnZ43Sq7M9LFPqLro9cnAGh3W7qrTaEkdvHjFk86yX42KmxcuEeuPvmdt3/TWB9Z7nagODhpkciAWiCrLYw5GNdjNcu6AlcFYMIDt/HmA5wRmBPJpNuYDJNw1pDzI8wB1hZy+NwN4YmfeVy/41Lqd1Rd1DvI6qrRbLqnJncMFx5ag+uLK53jWt/B5Kz8G4/M2PwvvnBOBdgBLoyW199xlTzrzH9wiZ1Du9lCiOkJY3/qWJFJkwDJB5QYbJyldb1a/VU8uCj5wuSBIg9YLDBlsOoiYwE6w2lDBGQow+1jyfrrY/a7QrnpffF4cpCCcNpjPKYc7b1WPIfR5p+1a5a1+gTLaKakN273toVQkKU32Dep8Y7ryyXC+XTlJseVMlCz8b2mCCTaV3w1yndK8fCBzQqEyXB+tYykSmnUOqrTrv+fQn4VOWf4SuaaEz1v5MYQ/b/vzZKQFCmnn5d6CYbHu9+PW9jVjJ633OoUu93xUoBlBFKOkioO0miwkqj5XVoOTVHrM1n7Zhnpf6fj7I6m0DpXPfA0q0cqF8zmrNoib5t0jaEY1vHWX+Mby1eLm+YvFhmPve/n5hfMAZlAkyEHLBJU7mDuXVP5tzOdlgk1tK/4G70BSmuSYSVS6LftYwm3addYgKUcYhJ2/yvF3dt7c/gQlVfp5gSIaLangTxASUdGMat7aETHnvofF4q3Piodes2dWlIp/guB+G/qBRoNWzjTM4HOCmuhUUnZ+LsD5wKJ63bblN3tWtoIskvxjZr0lswm2Te8c1CMpq041A3LLc33J33dw3ip8jhZ0nuYmbSXHadUDSmm0pIh+/ZhTD2gaqDq5g1sPWv1P0jq5gzQU2G6iIJZ5XUHqgDSDXAURJbNfbt12UFWTBfUhK+/0hQ1Uoy9cmVoklWAem+wDicHN7/bFaTN03sqPoURSarwU9R/wNF5Sff2zmBKKBy1oF7yIQTmNlxQxqD8whqRABhbMu6YVkiJoVkSXb6E/k6FE+yhPrzMoDSQFNHIsYBbVFa2RlIYWwm/UTe8gKaDXyTAOuqd1kgIAzCwgKQBA1EBSAICogaQAAFEDSQEAogaSAgBEjBB/B3o1C04w+m2JAAAAAElFTkSuQmCC"></p><p>The SPI configuration directory is  <code>META-INF/shenyu/.</code>  that is specified:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When starting the gateway system , the <code>ExtensionLoader</code> will scan the profiles under  <code>SHENYU_DIRECTORY</code>,  in turn, load and validate and then  initialize each configed class. The configuration file uses  &quot;Key = class-file&quot; format.  During operation of the system,  the corresponding <code>SPI</code> implementation class will be invoked through the factory mechanism.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="implementation-of-shenyu-plugin-spi"></a>Implementation of shenyu-plugin SPI<a class="hash-link" href="#implementation-of-shenyu-plugin-spi" title="Direct link to heading">#</a></h2><p>In <strong><em>shenyu-plugin</em></strong> module,  various plugins for HTTP routing are implemented according to the plugin mechanism, including  request, redirect, response and rewrite, etc.  Plugins for microservice frameworks such as Dubbo, gRPC , Spring-Cloud and Tars have been developed in the gateway product.  And plugins are still increasing. If  no such  dependent module fo parsing and judge routing  parameters and data,  each plugin is necessary to implement the parsing functions, and has to frequently  modify  to support their matching rules, such as wildcard, regular expression, SpEL expression, etc. Therefore,  they made a high level abstraction for routing parameter data following the <code>SPI</code> framework in  <strong><em>shenyu-plugin</em></strong> module.  The rule analysis consists of three parts:</p><ul><li><p><code>ParameterData</code>- parameter data</p></li><li><p><code>PredicatJudge</code>-  predicate whether the actural data match the rule</p></li><li><p><code>MatchStrategy</code>- combine multiple conditions, the final used strategy</p></li></ul><p>These implementation classes are defined in <strong><em>shenyu-plugin-base</em></strong> module. In each plugin, resolution and predication of  the routing parameter can be realized through <code>AbstractShenyuPlugin</code> using the above  <code>SPIs</code>. That is dedicated and easy to extend, in line with SOLID principle.</p><p>​      This section analyzes the  <code>PredictJudge</code> in detail. You can find the dependency to <strong><em>shenyu-spi</em></strong> in the pom.xml of this module.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-predicatejudge-spi"></a>Design of PredicateJudge SPI<a class="hash-link" href="#design-of-predicatejudge-spi" title="Direct link to heading">#</a></h3><p><code>PredicateJudge</code> <code>SPI</code>  is used to analyze and judge various routing rules configed in <code>Apache Shenyu</code> gateway.  The name and functions of this SPI are similar to <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener noreferrer">Predicate</a>  in Java, but the acceptance behavior is further  abstracted applying for routing aspect. This <code>SPI</code> is implemented through the Factory pattern.  Let&#x27;s look at the <code>Predictejudge</code> <code>SPI</code> interface:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@FunctionalInterface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PredicateJudge {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * judge conditionData and realData is match.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param conditionData {@linkplain ConditionData}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param realData       realData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true is pass  false is not pass.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean judge(ConditionData conditionData, String realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The class diagram is as follows:</p><p>Fig 2-<code>Predicate</code> class diagram</p><p><img alt="predicate-class-diagram" src="/assets/images/predicate-class-diagram-67a93b8c3e49800b23fe717c22027c54.png"></p><p>The important  methods of <code>PredicateJudgeFactory</code>  are shown as follows:</p><p>Whenever need to parsing and matching routing data, you can use</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static PredicateJudge newInstance(final String operator) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(PredicateJudge.class).getJoin(processSpecialOperator(operator));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static Boolean judge(final ConditionData conditionData, final String realData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(conditionData) || StringUtils.isBlank(realData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(conditionData.getOperator()).judge(conditionData, realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ConditionData</code> contains of four attributes of String type: <code>paramType</code>, <code>operator</code>,<code>paramName</code>,<code>paramValue</code> </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="paramtypeenum"></a>ParamTypeEnum<a class="hash-link" href="#paramtypeenum" title="Direct link to heading">#</a></h4><p>Where <strong>paramType</strong> must be the  enumeration type  <code>ParamTypeEnum</code>. The default supported <code>paramType</code> are:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">post, uri,query, host, ip,header, cookie,req_method</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="operatorenum"></a>OperatorEnum<a class="hash-link" href="#operatorenum" title="Direct link to heading">#</a></h4><p><strong>operator</strong> must be the enumeration type <code>OperatorEnum</code>, currently  supported operators are:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   match, =,regex, &gt;,&lt;, contains, SpEL,  Groovy, TimeBefore,TimeAfter</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Base on the above defination , the plugin module provides  the following  eight <code>PredicateJudge</code>  implemetation classes to realize the logic of these operators respectively. </p><table><thead><tr><th>Implementation class</th><th>Logic description</th><th>corespondece operator</th></tr></thead><tbody><tr><td><code>ContainsPredicateJudge</code></td><td>&quot;contain&quot; relation, the actual data needs contain the specified string</td><td>contains</td></tr><tr><td><code>EqualsPredicateJudge</code></td><td>equals &quot;=&quot;</td><td>=</td></tr><tr><td><code>MatchPredicateJudge</code></td><td>used for URI context path matching</td><td>match</td></tr><tr><td><code>TimerAfterPredicateJudge</code></td><td>Whether the local time is after the specified time</td><td>TimeAfter</td></tr><tr><td><code>TimerBeforePredicateJudge</code></td><td>Whether the local time is before the specified time</td><td>TimeBefore</td></tr><tr><td><code>GroovyPredicateJudge</code></td><td>used Groovy syntax toe set ParamName and value data</td><td>Groovy</td></tr><tr><td><code>RegexPredicateJudge</code></td><td>used Regex to match</td><td>regex</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-use-predicatejudge"></a>How to use PredicateJudge<a class="hash-link" href="#how-to-use-predicatejudge" title="Direct link to heading">#</a></h3><p>When you want to parse parameters, you only need to call <code>PredicateJudgeFactory</code> as follows. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">PredicateJudgeFactory.judge(final ConditionData conditionData, final String realData);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi-profile"></a>SPI profile<a class="hash-link" href="#spi-profile" title="Direct link to heading">#</a></h3><p>The implementation class is configed in the file under directory <code>SHENYU_DIRECTORY</code> . It  will be loaded and cached at startup. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">equals=org.apache.shenyu.plugin.base.condition.judge.EqualsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">contains=org.apache.shenyu.plugin.base.condition.judge.ContainsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Groovy=org.apache.shenyu.plugin.base.condition.judge.GroovyPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">match=org.apache.shenyu.plugin.base.condition.judge.MatchPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">regex=org.apache.shenyu.plugin.base.condition.judge.RegexPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SpEL=org.apache.shenyu.plugin.base.condition.judge.SpELPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeAfter=org.apache.shenyu.plugin.base.condition.judge.TimerAfterPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeBefore=org.apache.shenyu.plugin.base.condition.judge.TimerBeforePredicateJudge</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-usage-of-predicatejudge-spi-in-shenyu-gateway"></a>The usage of PredicateJudge SPI in Shenyu gateway<a class="hash-link" href="#the-usage-of-predicatejudge-spi-in-shenyu-gateway" title="Direct link to heading">#</a></h2><p>Most plugins in <code>Apache Shenyu</code> are inherited from <code>AbstractShenyuPlugin</code>.  In this abstract class, the filter functions (selection and matching) are achieved through  <code>MatchStrategy</code> <code>SPI</code>, and <code>PredicateJudge</code> will be invoked from <code>MatchStrategy</code>  to predicate each condition data. </p><p>Fig 3- class diagram of plugins with <code>PredicateJudge</code> and <code>MatchStrategy</code> <code>SPI</code></p><p><img alt="plugin-SPI-class-diagram" src="/assets/images/plugin-SPI-class-diagram-fa432591b833ff178cb662ce352f5b23.png"></p><p>The process from client request  calling the routing parsing moodule is showed as following chart.</p><p>Fig 4- flow chart for Shenyu gateway filter  with parameter processing</p><p><img alt="SPI-flow-diagram" src="/assets/images/SPI-flow-diagram-590f2cd298ae7655330a62a2010b006e.png"></p><ul><li>When startup, the system will load <code>SPI</code> classes from profile and cache them.</li><li>When the client sends a new request to the Shenyu gateway,  will call the corresponding plugin within  the gateway.</li><li>When analyzing real data with routing rules, the  <code>PredicateJudge</code> implementation class  will be invoked according to the contained operator.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="others"></a>Others<a class="hash-link" href="#others" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="examples-of-predicatejudge--judgement"></a>Examples of PredicateJudge  judgement<a class="hash-link" href="#examples-of-predicatejudge--judgement" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="containspredicatejudge---contains-rule"></a>ContainsPredicateJudge- &quot; contains“ rule<a class="hash-link" href="#containspredicatejudge---contains-rule" title="Direct link to heading">#</a></h4><p>For example, giving a <code>ConditionData</code>  with: <code>paramType</code>=&quot;uri&quot;, <code>paramValue</code> 是 &quot;/http/**&quot;,  when using the &quot;contains&quot; relation: <code>ContainsPredicateJudge</code>, the matching result is as follows.</p><table><thead><tr><th><code>ConditionData</code>  (operator=&quot;contains&quot;)</th><th>real data</th><th>judge result</th></tr></thead><tbody><tr><td>paramType=&quot;uri&quot;,    &quot;/http/**&quot;</td><td>&quot;/http/**/test&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/test/http/**/other&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/http1/**&quot;</td><td>false</td></tr></tbody></table><p>About other <code>PredicateJudge</code> implemetantion classes, you  can  refer to the code and test classes.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about PredicateJudge -- analyze the design based on SPI" href="/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI code analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.309Z">September 28, 2024</time> · 16 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p><em>Rate limiter</em> is a very important integral of  gateway application, to deal with  high traffic.  When the system is attacked abnormally by a large number of traffic gathered in a short time;  When there are a large number of lower priority request need to be slow down or else it  will effect your high  priority transactions;  Or sometimes your system can not afford the regular traffic; in these  scenarios, we need to start <em>rate limiter</em> component to protect our system,  through rejection, wait, load  shedding,etc,  limit the requests to an acceptable quantities, or only  certain domains (or services) requests can get through.  </p><p>Facing above scenarios, following need to be considered when designing the rate limiter component of an gateway.</p><ol><li>Supports a variety  of rate limiter algorithms and easy to extends.</li><li>Resilient resolvers  which can distinguish traffic by different way, such as  ip, url, even user group  etc.</li><li>High availability, can quickly get allow or reject result from rate limiter</li><li>With fault tolerance against when rate limiter is down, the gateway can continue work.</li></ol><p>This article will first introduce the overall architecture of the rate limiter module in Apache Shenyu, and then focus on the code analysis of rate limiter SPI.</p><blockquote><p>This article based on <code>shenyu-2.4.0</code> version of the source code analysis.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="overall-design-of-ratelimiter"></a>Overall design of RateLimiter<a class="hash-link" href="#overall-design-of-ratelimiter" title="Direct link to heading">#</a></h2><p>Spring <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html" target="_blank" rel="noopener noreferrer">WebFlux</a> is reactive and  non-blocking web framework,  which can benefit throughput and  make applications more resilient. The plugin of <code>Apache Shenyu</code> is based on <code>WebFlux</code>，its rate limiter component is implemented in <code>ratelimiter-plugin</code>. In rate limiter process, the commonly used algorithms are token bucket, leaky bucket, etc.  To speed up concurrency performance,  the counting and calculation logic is treated in Redis, and Java code is responsible for  the transmission of parameters.  When applying Redis, the Lua script can be resident memory,  and be executed as  a whole, so it is atomic. Let alone the reducing of network overhead.  Redis commands abstraction and automatic serialization/deserialization with Redis store is provided in  <a href="https://spring.io/projects/spring-data-redis" target="_blank" rel="noopener noreferrer">Spring Data Redis</a>.   Because of based on reactive framework, the  Spring Redis Reactive is used in <code>ratelimiter-plugin</code>.</p><p> The class diagram of this plugin is as follows, highlighting two packages related to <code>RateLimiter SPI</code>: resolver 和algorithm.</p><p><img alt="ratelimiter-package-diagram" src="/assets/images/ratelimiter-package-diagram-b041571cdf2f8592c23ab33bf07fbc71.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-ratelimiter-spi"></a>Design of RateLimiter SPI<a class="hash-link" href="#design-of-ratelimiter-spi" title="Direct link to heading">#</a></h2><p>High performance issue is  achieved through the architecture of Spring data+ Redis+Lua ,  two <code>SPI</code> are supplied in  <code>ratelimiter-plugin</code>  for the extension of algorithm and key resolver。</p><ul><li>RateLimiterAlgorithm：used for algorithms expansion.</li><li>RateLimiterKeyResolver： used for resolver expansion, to distinguish requests by various information, including ip, url, ect.  </li></ul><p>The profile of SPI is located at  directory of <code>SHENYU_DIRECTORY</code>  (default<code>/META-INF/shenyu</code>).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiterkeyresolver"></a>RateLimiterKeyResolver<a class="hash-link" href="#ratelimiterkeyresolver" title="Direct link to heading">#</a></h3><p>Obtain the critical info of the request used for packet rate limiter，the interface of <code>RateLimiterKeyResolver</code>  is follows：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterKeyResolver {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get Key resolver&#x27;s name.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Key resolver&#x27;s name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getKeyResolverName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * resolve.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param exchange exchange the current server exchange {@linkplain ServerWebExchange}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return rate limiter key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolve(ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code>  registers the current interface as  Apache Shenyu SPI. Method <code>resolve(ServerWebExchange exchange)</code> is used to provide  the resolution way.  Currently there are two key resolvers in  <code>RateLimiterKeyResolver</code>  <code>SPI</code>:<code>WholeKeyResolve</code> and <code>RemoteAddrKeyResolver</code>.  The  resolve method of <code>RemoteAddrKeyResolver</code>is as follows：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String resolve(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Where the resolved key is ip of request.  Based on <code>SPI</code> mechanism and its factory pattern,  new resolver can be easily developed.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiteralgorithm-spi"></a>RateLimiterAlgorithm SPI<a class="hash-link" href="#ratelimiteralgorithm-spi" title="Direct link to heading">#</a></h3><p><code>RateLimiterAlgorithm</code> <code>SPI</code> is used to identify and define different rate limiter algorithms, following is the class diagram of this module.</p><p><img alt="ratelimiteral-class-diagram" src="/assets/images/ratelimiteral-class-diagram-24df4785848602bdc5b321cf609d5cda.png"></p><p>In this module, factory pattern is used , providing interface, abstract class and factory class, and four implementation classes. The <code>lua</code> script corresponding to the implementation class is enumerated in <code>RateLimitEnum</code> and located in  <code>/META-INF/scripts</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterAlgorithm&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisScript&lt;T&gt; getScript();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; getKeys(String id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param script the script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param keys the keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param scriptArgs the script args</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code>  registers the current interface as  Apache Shenyu SPI. There are three methods:</p><ul><li><code>getScript()</code> returns a <code>RedisScript</code> object, which will be passed to Redis.</li><li><code>getKeys(String id)</code>  returns a List contains with  keys.</li><li><code>callback()</code> the callback function which will be executed asynchronously later on, and default is an empty method.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractratelimiteralgorithm"></a>AbstractRateLimiterAlgorithm<a class="hash-link" href="#abstractratelimiteralgorithm" title="Direct link to heading">#</a></h4><p>The template method is implemented in this abstract class, and the reified generics used is <code>List&lt;Long&gt;</code>. Two abstract methods getScriptName()  and getKeyName()  are left for  the implementation class. Following is the code to load <code>lua</code> script.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public RedisScript&lt;List&lt;Long&gt;&gt; getScript() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.initialized.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultRedisScript redisScript = new DefaultRedisScript&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String scriptPath = &quot;/META-INF/scripts/&quot; + getScriptName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(scriptPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setResultType(List.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.script = redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialized.compareAndSet(false, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return script;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>initialized</code>  is an <code>AtomicBoolean</code>  type variable used to indicate whether the <code>lua</code> script is loaded.  If has not been loaded, the system will read specified scripts form <code>META-INF/scripts</code>;  After reading,  specify the result with <code>List</code> type, and set  <code>initialized=true</code>, then returning  <code>RedisScript</code>object.</p><p>The code of <code>getKeys()</code>  in <code>AbstractRateLimiterAlgorithm</code> is  as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String prefix = getKeyName() + &quot;.{&quot; + id;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = prefix + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestampKey = prefix + &quot;}.timestamp&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, timestampKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Two strings are generated in this template method, where the <code>tokenKey</code> will work as Key to a Sorted map in Redis.  </p><p>We can observe from above class diagram that  <code>ConcurrentRateLimiterAlgorithm</code> and <code>SlidingWindowRateLimiterAlgorithm</code>  override <code>getKeys(String id)</code> method  but another two implementation classes not, and use template method in <code>AbstractRateLimiterAlgorithm</code>. Only  in  <code>ConcurrentRateLimiterAlgorithm</code> has override callback() method, the others not.  We will do further analysis in the following.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiteralgorithmfactory"></a>RateLimiterAlgorithmFactory<a class="hash-link" href="#ratelimiteralgorithmfactory" title="Direct link to heading">#</a></h4><p>The  method gets<code>RateLimiterAlgorithm</code> instance  by <code>name</code>  in  <code>RateLimiterAlgorithmFactory</code> is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static RateLimiterAlgorithm&lt;?&gt; newInstance(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Optional.ofNullable(ExtensionLoader.getExtensionLoader(RateLimiterAlgorithm.class).getJoin(name)).orElse(new TokenBucketRateLimiterAlgorithm());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ExtensionLoader</code> of <code>SPI</code> is responsible for loading SPI classes by &quot;name&quot;, if cannot find the specified algorithm class, it will return <code>TokenBucketRateLimiterAlgorithm</code> by default.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="data-access-with-redis"></a>Data access with Redis<a class="hash-link" href="#data-access-with-redis" title="Direct link to heading">#</a></h3><p>Above detailed the  extension interface in <code>RateLimiter</code> <code>SPI</code>. In Apache Shenyu, we use <code>ReactiveRedisTemplate</code>  to perform   Redis processing reactively, which is implemented  in<code>isAllowed()</code> method of <code>RedisRateLimiter</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;RateLimiterResponse&gt; isAllowed(final String id, final RateLimiterHandle limiterHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get parameters that will pass to redis from RateLimiterHandle Object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double replenishRate = limiterHandle.getReplenishRate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double burstCapacity = limiterHandle.getBurstCapacity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double requestCount = limiterHandle.getRequestCount();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the current used RateLimiterAlgorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RateLimiterAlgorithm&lt;?&gt; rateLimiterAlgorithm = RateLimiterAlgorithmFactory.newInstance(limiterHandle.getAlgorithmName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ........</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flux&lt;List&lt;Long&gt;&gt; resultFlux = Singleton.INST.get(ReactiveRedisTemplate.class).execute(script, keys, scriptArgs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFlux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(1L, -1L)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .reduce(new ArrayList&lt;Long&gt;(), (longs, l) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    longs.addAll(l);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return longs;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).map(results -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean allowed = results.get(0) == 1L;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Long tokensLeft = results.get(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new RateLimiterResponse(allowed, tokensLeft);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(throwable -&gt; log.error(&quot;Error occurred while judging if user is allowed by RedisRateLimiter:{}&quot;, throwable.getMessage()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doFinally(signalType -&gt; rateLimiterAlgorithm.callback(script, keys, scriptArgs));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>POJO</code> class <code>RateLimiterHandle</code> wraps the parameters needed in rate limiter, they are <code>algorithName</code>, <code>replenishRate</code>, <code>burstCapacity</code>, <code>requestCount</code>, etc.  First, gets the parameters  that need to be passed into Redis from <code>RateLimiterHandle</code> class. Then obtain the current implementation class from <code>RateLimiterAlgorithmFactory</code>.</p><p>For convenience,  we give an flow image to show the parameters I/O  and execution procedure in Java and Redis respectively.  On the left is the second half of <code>isAllowed</code>() ,  and on the right is the processing of <code>Lua</code> script.</p><p>Following is the execution process of the JAVA code.</p><ol><li><p>Get two keys value in <code>List&lt;String&gt;</code> type from the <code>getKeys()</code> method, the first element  will map to a sorted set in Redis.</p></li><li><p>Set four parameters,  <code>replenishRate</code> ,  <code>burstCapacity</code>,  <code>timestamp</code> (<code>EpochSecond</code>) and <code>requestcount</code>.</p></li><li><p>Calling <code>ReactiveRedisTemplate</code> with the scripts, keys and parameters,  the return a  <code>Flux&lt;List&lt;Long&gt;&gt;</code></p></li><li><p>The  return value is converted from <code>Flux&lt;ArrayList&lt;Long&gt;&gt;</code> to <code>Mono&lt;ArrayList&lt;Long&gt;&gt;</code> the through <code>reduce()</code> of <code>Flux</code> ，and then transform it to <code>Mono&lt;RateLimiterResponse&gt;</code> via <code>map()</code> function.  Returned two data, one is <code>allowed</code> (1-allow, 0- not allowed),  the other is <code>tokensLeft</code>, the number of available remaining request.  </p></li><li><p>As for the fault tolerance,  due to using of reactor non-blocking model, when an error occurs, the fallback  function <code>onErrorResume()</code> will be executed and a new stream <code>(1L, -1L)</code> will  generated by <code>Flux.just,</code> which means  allow the request getting through, and log the error on the side.  </p></li><li><p>After that, performs the  <code>doFinally()</code>  method, that is to execute the callback() method of the implementation class.</p></li></ol><p><img alt="io-with-lua" src="/assets/images/io-with-lua-eefcd28d4b59a8bd0e69e29400018c50.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="four-rate-limiter-algorithms"></a>Four rate limiter algorithms<a class="hash-link" href="#four-rate-limiter-algorithms" title="Direct link to heading">#</a></h2><p>From above we  know that  how the  java code works with Redis in the gateway. In this chapter we briefly analysis some code of the  four rate limiter algorithms, to understand how to develop the interface of  <code>RateLimiter SPI</code>  and work efficiently with Redis.  </p><p>Four rate limiter algorithms are supplied in Apache Shenyu <code>Ratelimit SPI</code>:</p><table><thead><tr><th>Algorithm name</th><th>Java class</th><th>Lua script file</th></tr></thead><tbody><tr><td>Request rate limiter</td><td><code>TokenBucketRateLimiterAlgorithm</code></td><td>request_rate_limiter.lua</td></tr><tr><td>Slide window rate limiter</td><td><code>SlidingWindowRateLimiterAlgorithm</code></td><td>liding_window_request_rate_limiter.lua</td></tr><tr><td>Concurrent rate limiter</td><td><code>ConcurrentRateLimiterAlgorithm</code></td><td>concurrent_request_rate_limiter.lua</td></tr><tr><td>Leaky bucket algorithm</td><td><code>LeakyBucketRateLimiterAlgorithm</code></td><td>request_leaky_rate_limiter.lua</td></tr></tbody></table><ol><li>Token bucket rate limiter： Limiting the traffic according to the number of requests. Assuming that <em>N</em> requests can be passed per second, when requests exceeding <em>N</em> will be rejected.  In implementing of the algorithm, the requests will be grouped by bucket,  the tokens will be generated at an evenly rate.  If  the number of requests is less than the tokens in the bucket, then it is allowed to pass.  The time window is 2* capacity/rate.</li><li>Slide window rate limiter:   Different from token bucket algorithm, its window size is smaller than that of token bucket rate limiter,  which is a capacity/rate.  And move backward one time window at a time. Other rate limiter principles are similar to token bucket.</li><li>Concurrent rate limiter： Strictly limit the concurrent requests to <em>N</em>. Each time when there is a new request, it will check whether the number of concurrent requests is greater than N. If it is less than <code>N</code>, it is allowed to pass through, and the count is increased by 1. When the requests call ends, the signal is released (count minus 1).</li><li>Leaky bucket rate limiter:   In contrast with token bucket algorithm, the leaky bucket algorithm can help to smooths the burst of requests and only allows a pre-defined <em>N</em> number of requests. This limiter can force the output flow at a constant rate of <em>N</em>.  It is based on a leaky bucket model, the leaky water quantity is  time interval*rate.  if the leaky water quantity is greater than the number of has used (represented by <code>key_bucket_count</code>), then clear the bucket, that is, set the <code>key_bucket_count</code> to 0. Otherwise, set <code>key_bucket_count</code>  minus the leaky water quantity.  If the number  (requests + <code>key_bucket_count</code> ) is less than the capacity, then allow the requests passing through.</li></ol><p>Let&#x27;s understand the functionality of  <code>callback()</code> by reading concurrent rate limiter code, and understand the usage of <code>getKeys()</code> through reading the  Lua script of token rate limiter and slide window rate limiter.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="callback-used-in-concurrent-requests-limiter"></a>callback() used in Concurrent requests limiter<a class="hash-link" href="#callback-used-in-concurrent-requests-limiter" title="Direct link to heading">#</a></h3><p>The <code>getKeys()</code>  method of <code>ConcurrentRateLimiterAlgorithm</code> overrides the template method in <code>AbstractRateLimiterAlgorithm</code> ：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = getKeyName() + &quot;.{&quot; + id + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String requestKey = UUIDUtils.getInstance().generateShortUuid();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, requestKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The second element, <code>requestKey</code>  is a long type and non-duplicate  value (generated by a distributed ID generator，it is incremented and smaller than the current time Epochsecond value). The corresponding <code>Lua</code> script in <code>concurrent_request_rate_limiter.lua</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local capacity = tonumber(ARGV[2])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp = tonumber(ARGV[3])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local id = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here <code>id</code>  is <code>requestKey</code>  generated by <code>getKeys()</code> method, it is an <code>uuid</code>(unique value).  Subsequent process is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local count = redis.call(&quot;zcard&quot;, key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if count &lt; capacity then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis.call(&quot;zadd&quot;, key, timestamp, id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count = count + 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed, count }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>First, using <code>zcard</code> command to obtain the cardinality  of the sorted set, and set count equals the  cardinality , if the cardinality is less than the capacity, we will add a new member <code>id</code> (it is an <code>uuid</code>) to the sorted set, with the score of current time(in seconds) . then <code>count =count+1</code>, the cardinality is also incremented by 1 in reality.</p><p>All of the code above is executed in Redis as an atomic transaction.  If there are a large number of concurrent requests from the same key( such as ip) , the cardinality of the sorted set of this key will increasing sharply, when then capacity limit is exceeded, the  service will be denied, that is <code>allowed =0</code>。</p><p>In concurrent requests limiter, It is required to release the semaphore when the request is completed. However, it is not included in Lua script.</p><p>Let&#x27;s see the callback function of  <code>ConcurrentRateLimiterAlgorithm</code>：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton.INST.get(ReactiveRedisTemplate.class).opsForZSet().remove(keys.get(0), keys.get(1)).subscribe();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here gives asynchronous subscription, using <code>ReactiveRedisTemplate</code> to delete the elements  (<code>key</code>,<code>id</code>)  in Redis store. That is once the request operation ends, the semaphore will be released.  This remove operation  cannot be executed in Lua script. This is just what design intention of <code>callback</code> in <code>RateLimiterAlgorithm</code> <code>SPI</code> .</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="getkeys-used--in-token-bucket-rate-limiter"></a>getKeys() used  in token bucket rate limiter<a class="hash-link" href="#getkeys-used--in-token-bucket-rate-limiter" title="Direct link to heading">#</a></h3><p>Following is the corresponding Lua code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local tokens_key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here we omit the code that get the parameters of rate ,capacity, etc.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local fill_time = capacity/rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local ttl = math.floor(fill_time*2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The window size variable(ttl) is approximately  two times of  capacity/rate.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_tokens = tonumber(redis.call(&quot;get&quot;, tokens_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_tokens == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_tokens = capacity</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Get last_tokens from the sorted set, if it not exist, then last_tokens equals capacity.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_refreshed = tonumber(redis.call(&quot;get&quot;, timestamp_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_refreshed == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_refreshed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Get the last refreshed time by the key =timestamp_key from the sorted set, and default 0.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local delta = math.max(0, now-last_refreshed)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local filled_tokens = math.min(capacity, last_tokens+(delta*rate))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = filled_tokens &gt;= requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if allowed then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  new_tokens = filled_tokens - requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The filled_tokens is produced evenly by time interval * rate，if the number of tokens greater than requests, then allowed=1,  and update  new_tokens.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, tokens_key, ttl, new_tokens)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, timestamp_key, ttl, now)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, new_tokens }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here <code>now</code> is  current time parameters passed in,  set <code>tokens_key</code> to hold the string <code>new_tokens</code> and set<code>tokens_key</code> to timeout after <code>ttl</code> of seconds.  Set  <code>timestamp_key</code> to hold the string value <code>now</code>, and expires after <code>ttl</code> seconds.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="getkeys-used--in-sliding-window-rate-limiter"></a>getKeys() used  in sliding window rate limiter<a class="hash-link" href="#getkeys-used--in-sliding-window-rate-limiter" title="Direct link to heading">#</a></h3><p>The  <code>getKeys()</code> in <code>SlidingWindowRateLimiterAlgorithm</code> also overrides the parent class, and the code is consistent with the method in <code>ConcurrentRateLimiterAlgorithm</code></p><p>Following is the Lua code of slide window rate limiter, the  receiving of other parameters is omitted.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_size = tonumber(capacity / rate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_time = 1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here set the window_size to capacity/rate.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_requested = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local exists_key = redis.call(&#x27;exists&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (exists_key == 1) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_requested = redis.call(&#x27;zcard&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Obtain the cardinality(<code>last_requested</code>) of the <code>tokens_key</code> in the sorted set.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local remain_request = capacity - last_requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (last_requested &lt; capacity) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;zadd&#x27;, tokens_key, now, timestamp_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Calculate remaining available <code>remain_request</code> equals  capacity minus <code>last_requested</code> .  If  <code>last_requested</code> less than  capacity ,then allow current requests passing through，add element in the sorted set with (key=<code>timestamp_key</code>, value=<code>now</code>) .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;zremrangebyscore&#x27;, tokens_key, 0, now - window_size / window_time)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;expire&#x27;, tokens_key, window_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, remain_request }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Previously has set <code>window_time</code>=1, using <code>zremrangebyscore</code> command of Redis to remove all the elements in the sorted set stored at  <code>tokens_key</code> with a score in [0,now - window_size / window_time] ,  that is,  move the window a window size. Set the expire time of <code>tokens_key</code>  to <code>window_size</code>.</p><p>In the template method <code>getKeys(final String id)</code>  of <code>AbstractRateLimiterAlgorithm</code>，the second key ( represented y <code>secondKey</code>)  is a  fixed string which concat  the input parameter{id}. As we can see from the above three algorithm codes, in the token bucket algorithm,  <code>secondKey</code> will be updated to the latest time in the Lua code, so it doesn&#x27;t matter what value is passed in.  In the concurrent rate limiter, <code>secondKey</code> will be used as the key to remove Redis data in the java <code>callback</code> method.  In the sliding window algorithm, the  <code>secondKey</code> will be added to the sorted set  as the key of a new element, and will be removed during window sliding.</p><p>That&#x27;s all, when in a new rate limiter algorithm, the <code>getKeys(final String id)</code>method should be carefully designed according to the logic of the algorithm.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-use-ratelimiter-spi"></a>How to use RateLimiter SPI<a class="hash-link" href="#how-to-use-ratelimiter-spi" title="Direct link to heading">#</a></h2><p>The three parameters in <code>doExecute()</code> method of  <code>RateLimiter</code> plugin， <code>exchange</code>  is an web request， <code>chain</code>  is the execution chain of the plugins，<code>selector</code> is the selection parameters，<code>rule</code>  is the  policies or rules of rate limiter setting in the system.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get  the `RateLimiterHandle` parameters from cache </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RateLimiterHandle limiterHandle = RatelimiterRuleHandleCache.getInstance()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //find the resolver name </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolverKey = Optional.ofNullable(limiterHandle.getKeyResolverName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(name -&gt; Optional.of(&quot;-&quot; + RateLimiterKeyResolverFactory.newInstance(name).resolve(exchange)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return redisRateLimiter.isAllowed(rule.getId() + resolverKey, limiterHandle)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(response -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!response.isAllowed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(ShenyuResultEnum.TOO_MANY_REQUESTS.getCode(), ShenyuResultEnum.TOO_MANY_REQUESTS.getMsg(), null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li><p>Firstly get the <code>RateLimiterHandle</code>  parameters from cache.</p></li><li><p>Obtains the corresponding Key resolver by <code>RateLimiterHandle</code> instance.  </p></li><li><p>Reactively executes <code>isAllowed()</code>  method of  <code>RedisRateLimiter</code>.</p></li><li><p>If not allowed, error handling is performed.</p></li><li><p>If the request is allowed, dispatch it to the next process of execution chain.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p><code>RateLimiter</code> plugin is based on <code>Spring WebFlux</code>,and with <code>Apache Shen SPI</code>, with Redis and Lua script to responsible for the critical algorithm and logic process, make it with characteristics of high concurrency and elastic.  As for the <code>RateLimiter SPI</code>.</p><ol><li><code>RateLimiter</code> <code>SPI</code> provides two <code>SPI</code> interface, with interface oriented design and various design patterns, it&#x27;s easy to develop new rate limiter algorithm and key resolver rule.</li><li><code>RateLimiterAlgorithm</code> <code>SPI</code> supplies four rate limiter algorithms, token bucket,concurrency rate limiter, leaky bucket and sliding window rate limiter. When designing rate limiter algorithm, the KEY generation need to be carefully designed according to the algorithm characteristic.  Using Lua script to realize the logic of the algorithm, and  design callback()  method for asynchronous processing when needed.</li><li>Reactive programming, simple and efficient implementation.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/rate-limiter">rate limiter</a><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about RateLimiter SPI code analysis" href="/blog/SPI-SourceCode-Analysis-RateLimiter-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor">Guide for New Contributors to Start avoid Pitfalls</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.309Z">September 28, 2024</time> · 5 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/61108539?s=400&amp;u=f065b78a2944f2cea9160de7f7df054e2f157867&amp;v=4" alt="Yuxuan Zhang"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zuobiao-zhou" target="_blank" rel="noopener noreferrer">Yuxuan Zhang</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="preface"></a>Preface<a class="hash-link" href="#preface" title="Direct link to heading">#</a></h2><p>As a first-time developer in the <code>Shenyu</code> community, I encountered some &quot;Pitfalls&quot; that were not mentioned in the tutorials I followed to start and develop the project. I have documented the detailed steps I took to start <code>shenyu</code>, <code>shenyu-dashboard</code>, <code>shenyu-website</code> in this blog, hoping to help more new contributors in the community.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="environmental-preparation"></a>Environmental Preparation<a class="hash-link" href="#environmental-preparation" title="Direct link to heading">#</a></h2><ul><li>Correct local installation of <code>JDK1.8+</code></li><li>Properly install <code>Git</code> locally</li><li>Choose a development tool, this article uses <code>IDEA</code> as an example</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-backend-startup-guide"></a>ShenYu Backend Startup Guide<a class="hash-link" href="#shenyu-backend-startup-guide" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="install-and-configure-maven"></a>Install and Configure Maven<a class="hash-link" href="#install-and-configure-maven" title="Direct link to heading">#</a></h3><p>Maven is a cross-platform project management tool . As the Apache organization&#x27;s top open source projects , its main service for Java-based platform project creation , dependency management and project information management.</p><ol><li><p><a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener noreferrer">Download maven</a> and extract it to a path with no Chinese and no spaces.</p><img src="/img/activities/start-demo-for-contributor/maven-install.png" width="100%" height="100%"></li><li><p>Add the <code>bin</code> directory under the <code>maven</code> directory to the environment variables. For <code>Windows</code>, if the download directory is <code>E:\apache-maven-3.9.1</code>, add <code>E:\apache-maven-3.9.1\bin</code> to the <code>Path</code> system variable.</p></li><li><p>Verify that the installation was successful. Type <code>mvn -v</code> in the cmd window, and if the Maven version and Java version appear, the installation is successful. This is shown below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">mvn -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Apache Maven </span><span class="token number" style="color:#36acaa">3.9</span><span class="token plain">.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">2e178502fcdbffc201671fb2537d0cb4b4cc58f8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Maven home: E:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">apache-maven-3.9.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Java version: </span><span class="token number" style="color:#36acaa">18.0</span><span class="token plain">.1.1, vendor: Oracle Corporation, runtime: C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Program Files</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Java</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">jdk-18.0.1.1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Default locale: zh_CN, platform encoding: UTF-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain">OS name: </span><span class="token string" style="color:#e3116c">&quot;windows 10&quot;</span><span class="token plain">, version: </span><span class="token string" style="color:#e3116c">&quot;10.0&quot;</span><span class="token plain">, arch: </span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain">, family: </span><span class="token string" style="color:#e3116c">&quot;windows&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>To speed up the download of project-related dependencies, you need to change the Maven mirrors, here add Aliyun and other mirrors. Change the <code>&lt;mirrors&gt; &lt;/mirrors&gt;</code> tag pair in <code>conf/settings.xml</code> to the following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/groups/public/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">alimaven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">aliyun maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://maven.aliyun.com/nexus/content/repositories/central/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">name_</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://repo1.maven.org/maven2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">central</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrorOf</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit address/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://jcenter.bintray.com/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirror</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">mirrors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>and add <code>&lt;localRepository&gt;E:/maven_local_repository&lt;/localRepository&gt;</code> to the next line of <code>&lt;/mirrors&gt;</code> to set the location of Maven local repository. You can specify the exact location yourself.</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pull-shenyu-code"></a>Pull ShenYu Code<a class="hash-link" href="#pull-shenyu-code" title="Direct link to heading">#</a></h3><ol><li><p>Fork <a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer">ShenYu</a> repository on Github to your own repository, where you can develop and commit PRs in the future</p></li><li><p>Use Git to download the repository from the previous step locally:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If prompted for a long file name, execute the following command via the command line:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> config --global core.longpaths </span><span class="token boolean" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-first-start"></a>ShenYu First Start<a class="hash-link" href="#shenyu-first-start" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="preparation"></a>Preparation<a class="hash-link" href="#preparation" title="Direct link to heading">#</a></h4><ol><li><p>Compile with Maven in the <code>shenyu</code> directory:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>Configure IDEA environment. Open <code>shenyu</code> project with IDEA, click <code>File</code> -&gt; <code>Settings</code> in the top left corner, and configure Maven as shown below. Where <code>User settings file</code> select your <code>settings.xml</code> directory, and then <code>Local repository</code> will automatically load the <code>localRepository</code> path set in <code>settings.xml</code>:</p><img src="/img/activities/start-demo-for-contributor/idea-config.png" width="60%" height="60%"></li><li><p>At this point, IDEA will automatically download the project-related dependencies, you need to wait for a while, when finished, as shown in the following figure:</p><img src="/img/activities/start-demo-for-contributor/project-without-example.png" width="60%" height="60%"><p>As you can see, <code>shenyu-e2e</code>, <code>shenyu-examples</code>, <code>shenyu-integrated-test</code> are not marked as Maven projects by IDEA and need to be added manually. Select the <code>pom.xml</code> file in the package and right-click <code>Add as Maven Project</code>.
If the shenyu-e2e build fails, then add the <code>&lt;relativePath&gt;. /pom.xml&lt;/relativePath&gt;</code> to <code>&lt;relativePath/&gt;</code>.</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-gateway-service"></a>Start Gateway Service<a class="hash-link" href="#start-gateway-service" title="Direct link to heading">#</a></h4><ol><li><p>Start the <code>shenyu-admin</code> console (H2 database is used by default)</p><img src="/img/activities/start-demo-for-contributor/admin.png" width="60%" height="60%"></li><li><p>start <code>shenyu-bootstrap</code></p><img src="/img/activities/start-demo-for-contributor/bootstrap.png" width="100%" height="100%"></li></ol><blockquote><p>By this point, the shenyu gateway has been started.</p><p>We can open the browser and access the admin console: <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p><p>Default account: admin , default password: 123456</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-application-service"></a>Start Application Service<a class="hash-link" href="#start-application-service" title="Direct link to heading">#</a></h4><p>Apache ShenYu provides samples of Http, Dubbo, SpringCloud and other applications to access the shenyu gateway, located in the <code>shenyu-example</code> module, here the <code>Http service</code> is used as an example.</p><p>Start <code>shenyu-examples-http</code>。</p><img src="/img/activities/start-demo-for-contributor/shenyu-examples-http.png" width="80%" height="80%"><p>At this point, <code>shenyu-examples-http</code> will automatically register the interface methods annotated with <code>@ShenyuSpringMvcClient</code> and the relevant configuration in application.yml to the gateway. We can open the <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">admin console</a> and see the configuration in <code>Client List -&gt; Proxy -&gt; divide</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="test-http-request"></a>Test Http Request<a class="hash-link" href="#test-http-request" title="Direct link to heading">#</a></h4><p>The following uses the <code>IDEA HTTP Client Plugin</code> to mock http to access http services.</p><ul><li><p>Local access without using shenyu proxy</p><img src="/img/activities/start-demo-for-contributor/shenyu-http-test-api-local.png" width="60%" height="60%"></li><li><p>Use shenyu proxy</p><img src="/img/activities/start-demo-for-contributor/shenyu-http-test-api.png" width="60%" height="60%"></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="use-more-plugins"></a>Use more plugins<a class="hash-link" href="#use-more-plugins" title="Direct link to heading">#</a></h3><p>We can refer to the <a href="/blog/docs/index">official documentation</a> to the left of <code>Plugins collection</code> to use the required plugins.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-front-end-startup-guide"></a>Shenyu Front End Startup Guide<a class="hash-link" href="#shenyu-front-end-startup-guide" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="install-nodejs"></a>Install Node.js<a class="hash-link" href="#install-nodejs" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="download"></a>Download<a class="hash-link" href="#download" title="Direct link to heading">#</a></h4><ol><li><p>Download and install Node.js from <a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">official website</a> and select <code>LTS</code> version.</p></li><li><p>When installing, except for setting the installation path, just keep clicking <code>Next</code>.</p></li><li><p>After the installation is complete, verify at the command line:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">node -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain">v12.22.12</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Users</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">pc</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">npm -v</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6.14</span><span class="token plain">.16</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pull-shenyu-dashboard-code"></a>Pull ShenYu Dashboard Code<a class="hash-link" href="#pull-shenyu-dashboard-code" title="Direct link to heading">#</a></h3><ol><li><p>Fork <a href="https://github.com/apache/shenyu-dashboard" target="_blank" rel="noopener noreferrer">ShenYu Dashboard</a> repository</p></li><li><p>Using Git to download locally</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:</span><span class="token variable" style="color:#36acaa">${YOUR_USERNAME}</span><span class="token plain">/</span><span class="token variable" style="color:#36acaa">${TARGET_REPO}</span><span class="token plain">.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="front-and-back-end-co-development"></a>Front and Back End Co-development<a class="hash-link" href="#front-and-back-end-co-development" title="Direct link to heading">#</a></h3><ol><li><p>Add <code>enablePrintApiLog: true</code> to the <code>shenyu-admin/src/main/resources/application.yml</code> file in the backend repository <code>shenyu</code> as shown below to show the log of frontend interface calls in the backend console.</p><img src="/img/activities/start-demo-for-contributor/enable-api-log.png" width="60%" height="60%"></li><li><p>Start <code>ShenyuAdminBootstrap</code></p></li><li><p>Switch to the front-end repository <code>shenyu-dashboard</code>, open <code>README</code>, click <code>npm install</code>, <code>npm start</code> or enter the above command from cmd to access the front-end interface via <a href="http://localhost:8000" target="_blank" rel="noopener noreferrer">http://localhost:8000</a>, and display the log of the front-end interface called in the back-end console. Realize the co-development of front-end and back-end.</p><img src="/img/activities/start-demo-for-contributor/admin-log.png" width="60%" height="60%"></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="package-front-end-code"></a>Package Front-end Code<a class="hash-link" href="#package-front-end-code" title="Direct link to heading">#</a></h3><p>Execute the <code>npm build</code> command in <code>README</code> and copy all the generated files from the <code>dist</code> folder to the <code>shenyu-admin/src/main/resources/static/</code> directory in the backend repository.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="contribute-to-shenyu-official-website"></a>Contribute to Shenyu Official Website<a class="hash-link" href="#contribute-to-shenyu-official-website" title="Direct link to heading">#</a></h2><p>Just follow the <code>README</code> in <a href="https://github.com/apache/shenyu-website" target="_blank" rel="noopener noreferrer">shenyu-website</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="tips"></a>Tips<a class="hash-link" href="#tips" title="Direct link to heading">#</a></h3><ol><li>I recommend downloading the <code>LTS</code> version from the <code>Node</code> <a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer">website</a>.</li><li><code>Windows</code> systems cannot be deployed, if you want to verify your changes, you can deploy on a Linux virtual machine or server.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/first-start">first-start</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Guide for New Contributors to Start avoid Pitfalls" href="/blog/Start-SourceCode-Analysis-Start-Demo-for-Contributor"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu Start Demo</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.309Z">September 28, 2024</time> · 2 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="environmental-preparation"></a>Environmental preparation<a class="hash-link" href="#environmental-preparation" title="Direct link to heading">#</a></h3><ul><li>Install JDK1.8+ locally</li><li>Install Git locally</li><li>Install Maven locally</li><li>Choose a development tool, such as IDEA</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="pull-shenyu-code"></a>Pull ShenYu code<a class="hash-link" href="#pull-shenyu-code" title="Direct link to heading">#</a></h3><p>Use Git to clone code</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/apache/incubator-shenyu.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="compile-code"></a>Compile code<a class="hash-link" href="#compile-code" title="Direct link to heading">#</a></h3><p>Compile with Maven</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> incubator-shenyu</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-the-gateway-service"></a>Start the gateway service<a class="hash-link" href="#start-the-gateway-service" title="Direct link to heading">#</a></h3><p>Use development tools, take IDEA as an example.</p><p>Start <code>shenyu-admin</code> (use H2 database by default)</p><p><img alt="start-demo-admin" src="/assets/images/start-demo-admin-debdd1ee5e979a4892f26e4d54572ead.png"></p><p>Start <code>shenyu-bootstrap</code></p><p><img alt="start-demo-bootstrap" src="/assets/images/start-demo-bootstrap-cafa4d22b0d69bb6ee82c01e7b45d239.png"></p><blockquote><p>At this point, shenyu gateway has been activated.</p><p>We can open the browser and access the admin console: <a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="start-application-service"></a>Start application service<a class="hash-link" href="#start-application-service" title="Direct link to heading">#</a></h3><p>Apache ShenYu provides examples for Http, Dubbo, SpringCloud and other applications to access the shenyu gateway, located in the <code>shenyu-example</code> module. Here we take the Http service as an example.</p><p>If <code>shenyu-example</code> is not marked as a Maven project by IDEA, you can right-click the <code>pom.xml</code> file in the <code>shenyu-example</code> directory to add it as a Maven project.</p><p><img alt="start-demo-maven" src="/assets/images/start-demo-maven-a52eeb99414c79d32a127312a5d22d6f.png"></p><p>Start <code>shenyu-examples-http</code>。</p><p><img alt="start-demo-examples-http" src="/assets/images/start-demo-examples-http-a42235638d82a4be8aeefbb819d419be.png"></p><p>At this time, <code>shenyu-examples-http</code> will automatically register the interface method annotated with <code>@ShenyuSpringMvcClient</code> and the related configuration in application.yml to the gateway. When we open the admin console, you can see the relevant configuration in divide and context-path.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="test-http-request"></a>Test Http request<a class="hash-link" href="#test-http-request" title="Direct link to heading">#</a></h3><p>Now use <code>postman</code> to simulate <code>http</code> to request your <code>http</code> service:</p><p><img alt="start-demo-post-http" src="/assets/images/start-demo-post-http-a7e95883d3147d67e6080236d980d72b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="use-more-plugins"></a>Use more plugins<a class="hash-link" href="#use-more-plugins" title="Direct link to heading">#</a></h3><p>We can refer to <a href="/blog/docs/index">Official Document</a> to use other plugins.</p><p>Here is an example of using the param-mapping plugin.</p><p>Edit the param-mapping plugin in <code>BasicConfig -&gt; Plugin</code> and set <code>status</code>.</p><p><img alt="start-demo-plugin" src="/assets/images/start-demo-plugin-8525f3812e42bed70e28ce23540069b7.png"></p><p>Configure selectors and rules in <code>PluginList -&gt; http process</code>.</p><p><img alt="start-demo-selector" src="/assets/images/start-demo-selector-98b0b1ae460bdbed17edc40ab730a182.png"></p><p><img alt="start-demo-rules" src="/assets/images/start-demo-rules-581013f9d7f0f9996b01aab85efcc8e7.png"></p><p>Then use <code>postman</code> to make an http request to <code>/http/test/payment</code>.</p><p><img alt="start-demo-post-param-mapping" src="/assets/images/start-demo-post-param-mapping-d5d632dc96eb1f0080c451820e8f7df4.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Apache ShenYu Start Demo" href="/blog/Start-SourceCode-Analysis-Start-Demo"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Loader-SourceCode-Analysis-ExtLoader">Extension plugin loading logic</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.308Z">September 28, 2024</time> · 8 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/hql0312" target="_blank" rel="noopener noreferrer">hql0312</a></div><small class="avatar__subtitle">hql0312 Coder</small></div></div></header><div class="markdown"><blockquote><p>This article is based on the source code analysis of version &#x27;shenyu-2.6.1&#x27;</p></blockquote><header><h1 class="h1Heading_dC7a">Content</h1></header><p>Shenyu provides a mechanism to customize its own plugins or modify existing plugins, which is implemented internally through the configuration of extPlugin. It needs to meet the following two points：</p><ol><li>Implement interface <code>ShenyuPlugin</code> or <code>PluginDataHandler</code>.</li><li>After packaging the implemented package, place it in the corresponding path of &#x27;shenyu. extPlugin. path&#x27;.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="entry"></a>Entry<a class="hash-link" href="#entry" title="Direct link to heading">#</a></h2><p>The class that truly implements this logic is&#x27; ShenyuLoaderService &#x27;. Now let&#x27;s take a look at how this class handles it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuLoaderService(final ShenyuWebHandler webHandler, final CommonPluginDataSubscriber subscriber, final ShenyuConfig shenyuConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Information subscription for plugin information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.subscriber = subscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The WebHandler encapsulated by Shenyu contains all the plugin logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.webHandler = webHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // configuration information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.shenyuConfig = shenyuConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The configuration information of the extension plugin, such as path, whether it is enabled, how many threads are enabled to process, and the frequency of loading checks</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtPlugin config = shenyuConfig.getExtPlugin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If enabled, create a scheduled task to check and load</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (config.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a scheduled task with a specified thread name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScheduledThreadPoolExecutor executor = new ScheduledThreadPoolExecutor(config.getThreads(), ShenyuThreadFactory.create(&quot;plugin-ext-loader&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a task to be executed at a fixed frequency, with a default time of 30 seconds and execution every 300 seconds</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.scheduleAtFixedRate(() -&gt; loadExtOrUploadPlugins(null), config.getScheduleDelay(), config.getScheduleTime(), TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This class has the following properties:</p><p><code>WebHandler</code>: This class is the entry point for shenyu to process requests, referencing all plugin data. After the extension plugin is loaded, it needs to be updated.</p><p><code>Subscriber</code>: This class is the entry point for the subscription of plugins, referencing the subscription processing classes of all plugins. After the extension configuration is loaded, synchronous updates are also required.</p><p><code>Executor</code>: A scheduled task will be created inside&#x27; ShenyuLoaderService &#x27;to periodically scan and load jar packages under the specified path, facilitating the loading of extended plugins and achieving dynamic discovery
By default, it will scan every 300 seconds after 30 seconds of startup.</p><p>Meanwhile, the decision to enable extension plugin functionality can be made through the configuration of <code>shenyu. extPlugin. enabled</code>.</p><p>The above configurations can be adjusted in the configuration file:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extPlugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Storage directory for extension plugins</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Is the extension function enabled</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">threads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Number of threads loaded by scanning</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleTime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># The frequency of task execution</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheduleDelay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># How long after the task starts to execute</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Next, let&#x27;s take a look at the loading logic：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   public void loadExtOrUploadPlugins(final PluginData uploadedJarResource) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;ShenyuLoaderResult&gt; plugins = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Obtain the holding object of ShenyuPluginClassloader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuPluginClassloaderHolder singleton = ShenyuPluginClassloaderHolder.getSingleton();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(uploadedJarResource)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If the parameter is empty, load all jar packages from the extended directory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // PluginJar: Data containing the ShenyuPlugin interface and PluginDataHandler interface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;PluginJarParser.PluginJar&gt; uploadPluginJars = ShenyuExtPathPluginJarLoader.loadExtendPlugins(shenyuConfig.getExtPlugin().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Traverse all pending plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (PluginJarParser.PluginJar extPath : uploadPluginJars) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;shenyu extPlugin find new {} to load&quot;, extPath.getAbsolutePath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Use the loader of the extension plugin to load the specified plugin, facilitating subsequent loading and unloading</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPluginClassLoader extPathClassLoader = singleton.createPluginClassLoader(extPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Using ShenyuPluginClassLoader for loading</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // The main logic is to determine whether to implement ShenyuPlugin interface, PluginDataHandler interface, or identify annotations such as @ Component \ @ Service. If so, register as SpringBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Construct ShenyuLoaderResult object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    plugins.addAll(extPathClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Load the specified jar, with the same logic as loading all</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginJarParser.PluginJar pluginJar = PluginJarParser.parseJar(Base64.getDecoder().decode(uploadedJarResource.getPluginJar()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu upload plugin jar find new {} to load&quot;, pluginJar.getJarKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuPluginClassLoader uploadPluginClassLoader = singleton.createPluginClassLoader(pluginJar);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                plugins.addAll(uploadPluginClassLoader.loadUploadedJarPlugins());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Add the extended plugins to the plugin list of ShenyuWebHandler, and subsequent requests will go through the added plugin content</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            loaderPlugins(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;shenyu plugins load has error &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic processed by this method:</p><ol><li><p>Check if the parameter uploadedJarResource has a value. If not, all will be loaded. Otherwise, load the specified resource jar package for processing.</p></li><li><p>Retrieve the specified jar package from <code>shenyu. extPlugin. path</code> and encapsulate it as a PluginJar object, which contains the following information about the jar package:</p><ul><li><p>version: version information</p></li><li><p>groupId: The groupId of the package</p></li><li><p>artifactId: The artifactId of the package</p></li><li><p>absolutePath: Absolute path</p></li><li><p>clazzMap: Bytecode corresponding to class</p></li><li><p>resourceMap: Bytecode of jar package</p></li></ul></li><li><p>Create a corresponding ClassLoader using <code>ShenyuPluginClassloaderHolder</code>, with the corresponding class being &#x27;ShenyuPluginClassLoader&#x27;, and load the corresponding class accordingly.</p><ul><li>Call <code>ShenyuPluginClassLoader. loadUploadedJarPlugins</code> to load the corresponding class and register it as a Spring Bean, which can be managed using the Spring container</li></ul></li><li><p>Call the <code>loaderPlugins</code> method to update the extended plugin to&#x27;<code>webHandler</code> and <code>subscriber</code>.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="plugin-registration"></a>Plugin Registration<a class="hash-link" href="#plugin-registration" title="Direct link to heading">#</a></h2><p>For the content in the provided jar package, the loader will only handle classes of the specified interface type, and the implementation logic is in the <code>ShenyuPluginClassLoader.loadUploadedJarPlugins()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;ShenyuLoaderResult&gt; loadUploadedJarPlugins() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuLoaderResult&gt; results = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // All class mapping relationships</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; names = pluginJar.getClazzMap().keySet();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Traverse all classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        names.forEach(className -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object instance;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Try creating objects and, if possible, add them to the Spring container</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                instance = getOrCreateSpringBean(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(instance)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Building the ShenyuLoaderResult object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.add(buildResult(instance));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;The class successfully loaded into a upload-Jar-plugin {} is registered as a spring bean&quot;, className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ClassNotFoundException | IllegalAccessException | InstantiationException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.warn(&quot;Registering upload-Jar-plugins succeeds spring bean fails:{}&quot;, className, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return results;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This method is responsible for building all eligible objects and encapsulating them into a <code>ShenyuLoaderResult</code> object. This object is encapsulated for the created object and will be processed in the method <code>buildResult()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuLoaderResult buildResult(final Object instance) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuLoaderResult result = new ShenyuLoaderResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Does the created object implement ShenyuPlugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (instance instanceof ShenyuPlugin) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setShenyuPlugin((ShenyuPlugin) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Does the created object implement PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (instance instanceof PluginDataHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.setPluginDataHandler((PluginDataHandler) instance);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Simultaneously enter the method <code>getOrCreatSpringBean()</code> for further analysis:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; T getOrCreateSpringBean(final String className) throws ClassNotFoundException, IllegalAccessException, InstantiationException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Confirm if it has been registered. If so, do not process it and return directly</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SpringBeanUtils.getInstance().existBean(className)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Double check,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            T inst = SpringBeanUtils.getInstance().getBeanByClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(inst)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Using ShenyuPluginClassLoader to load classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Class&lt;?&gt; clazz = Class.forName(className, false, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Exclude ShenyuPlugin subclass and PluginDataHandler subclass</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // without adding @Component @Service annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Confirm if it is a subclass of ShenyuPlugin or PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean next = ShenyuPlugin.class.isAssignableFrom(clazz)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || PluginDataHandler.class.isAssignableFrom(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If not, confirm if @ Component and @ Service annotations are identified</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Annotation[] annotations = clazz.getAnnotations();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    next = Arrays.stream(annotations).anyMatch(e -&gt; e.annotationType().equals(Component.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            || e.annotationType().equals(Service.class));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (next) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If the above content is met, register the bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    GenericBeanDefinition beanDefinition = new GenericBeanDefinition();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setBeanClassName(className);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setAutowireCandidate(true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Registering beans</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String beanName = SpringBeanUtils.getInstance().registerBean(beanDefinition, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // create object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inst = SpringBeanUtils.getInstance().getBeanByClassName(beanName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return inst;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic is roughly as follows:</p><ol><li>Check if the interface <code>ShenyuPlugin</code> or <code>PluginDataHandler</code> has been implemented. If not, check if <code>@Component</code> or <code>@Service</code> has been identified`.</li><li>If the condition of 1 is met, register the object in the Spring container and return the created object.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="sync-data"></a>Sync Data<a class="hash-link" href="#sync-data" title="Direct link to heading">#</a></h2><p>After the plugin registration is successful, the plugin is only instantiated, but it will not take effect yet because it has not been added to Shenyu&#x27;s plugin chain. The synchronization logic is implemented by the <code>loaderPlugins()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void loaderPlugins(final List&lt;ShenyuLoaderResult&gt; results) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get all objects that implement the interface ShenyuPlugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; shenyuExtendPlugins = results.stream().map(ShenyuLoaderResult::getShenyuPlugin).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Synchronize updating plugins in webHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        webHandler.putExtPlugins(shenyuExtendPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get all objects that implement the interface PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginDataHandler&gt; handlers = results.stream().map(ShenyuLoaderResult::getPluginDataHandler).filter(Objects::nonNull).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Synchronize updating handlers in subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscriber.putExtendPluginDataHandler(handlers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of this method processes two data points:</p><ol><li>Synchronize the data that implements the <code>ShenyuPlugin</code> interface to the plugins list of  <code>webHandler</code>.</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtPlugins(final List&lt;ShenyuPlugin&gt; extPlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(extPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Filter out newly added plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuAddPlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().noneMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Filter out updated plugins and determine if they have the same name as the old one, then it is an update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final List&lt;ShenyuPlugin&gt; shenyuUpdatePlugins = extPlugins.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(e -&gt; plugins.stream().anyMatch(plugin -&gt; plugin.named().equals(e.named())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If there is no data, skip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(shenyuAddPlugins) &amp;&amp; CollectionUtils.isEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Copy old data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // copy new list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ShenyuPlugin&gt; newPluginList = new ArrayList&lt;&gt;(plugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add new plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add extend plugin from pluginData or shenyu ext-lib</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sourcePlugins.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add new data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuAddPlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuAddPlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto add extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newPluginList.addAll(shenyuAddPlugins);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Modify updated data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(shenyuUpdatePlugins)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuUpdatePlugins.forEach(plugin -&gt; LOG.info(&quot;shenyu auto update extends plugins:{}&quot;, plugin.named()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ShenyuPlugin updatePlugin : shenyuUpdatePlugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; newPluginList.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (newPluginList.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        newPluginList.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int i = 0; i &lt; this.sourcePlugins.size(); i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (this.sourcePlugins.get(i).named().equals(updatePlugin.named())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.sourcePlugins.set(i, updatePlugin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // REORDER</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        plugins = sortPlugins(newPluginList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li>Synchronize the data that implements the <code>PluginDataHandler</code> interface to the handlers list of the <code>subscriber</code>.</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void putExtendPluginDataHandler(final List&lt;PluginDataHandler&gt; handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(handlers)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Traverse all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (PluginDataHandler handler : handlers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String pluginNamed = handler.pluginNamed();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update existing PluginDataHandler list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MapUtils.computeIfAbsent(handlerMap, pluginNamed, name -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;shenyu auto add extends plugin data handler name is :{}&quot;, pluginNamed);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, the analysis of the loading process of the extension plugin is completed.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/blog/tags/ext">ext</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Extension plugin loading logic" href="/blog/Loader-SourceCode-Analysis-ExtLoader"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Code Analysis For Context-Path Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.308Z">September 28, 2024</time> · 3 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>Before starting, you can refer to <a href="/blog/tags/start-demo">this article</a> to start the gateway</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="body"></a>Body<a class="hash-link" href="#body" title="Direct link to heading">#</a></h3><p>First, look at the <code>ContextPathPlugin#doExecute</code> method, which is the core of this plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. get the contextMappingHandle from the JVM cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ContextMappingHandle contextMappingHandle = ContextPathPluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. set shenyu context according to contextMappingHandle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    buildContextPath(shenyuContext, contextMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li><p>Get the <code>contextMappingHandle</code> from the JVM cache</p><p>The <code>contextMappingHandle</code> here is an instance of the <code>ContextMappingHandle</code> class, which has two member variables: <code>contextPath</code> and <code>addPrefix</code></p><p>These two variables have appeared in the Rules form in the Admin before, and they are updated when the data is synchronized.</p></li><li><p>Set shenyu context according to contextMappingHandle</p><p>Below is the source code of the <code>ContextPathPlugin#buildContextPath</code> method</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void buildContextPath(final ShenyuContext context, final ContextMappingHandle handle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String realURI = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. set the context path of shenyu, remove the prefix of the real URI according to the length of the contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNoneBlank(handle.getContextPath())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setContextPath(handle.getContextPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setModule(handle.getContextPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        realURI = context.getPath().substring(handle.getContextPath().length());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // add prefix</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNoneBlank(handle.getAddPrefix())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(realURI)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            realURI = handle.getAddPrefix() + realURI;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            realURI = handle.getAddPrefix() + context.getPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.setRealUrl(realURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>Set the context path of shenyu, <strong>remove the prefix of the real URI according to the length of the contextPath</strong></p><p>You may be wondering whether <strong>there is a problem with the so-called &quot;according to the length of the contextPath&quot; here</strong>?</p><p>In fact, such a judgment is not a problem, because the request will be processed by the plugin only after it is matched by the Selector and Rules. Therefore, under the premise of setting up Selector and Rules, it is completely possible to meet the needs of converting a specific contextPath.</p></li></ul></li></ol><p>Then, the <code>ContextPathPlugin</code> class has a more important method <code>skip</code>, part of the code is shown below. We can find: <strong>If it is a call to the RPC service, the context_path plugin will be skipped directly.</strong></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Boolean skip(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Objects.equals(rpcType, RpcTypeEnum.DUBBO.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.GRPC.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.TARS.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.MOTAN.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.SOFA.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, the context-path plugin has another class <code>ContextPathPluginDataHandler</code>. The function of this class is to subscribe to the data of the plug-in. When the plugin configuration is modified, deleted, or added, the data is modified, deleted, or added to the JVM cache.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/context-path">Context-Path</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Code Analysis For Context-Path Plugin" href="/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin">Code Analysis For Param-Mapping Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.308Z">September 28, 2024</time> · 5 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>Before starting, you can refer to <a href="/blog/tags/Start-SourceCode-Analysis-Start-Demo">this article</a> to start the gateway</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="body"></a>Body<a class="hash-link" href="#body" title="Direct link to heading">#</a></h3><p>Let&#x27;s take a look at the structure of this plugin first, as shown in the figure below.</p><p><img alt="param-mapping-structure" src="/assets/images/param-mapping-structure-1d2b4243e835eeff74fc6ea114dcbee7.png"></p><p>Guess: handler is used for data synchronization; strategy may be adapted to various request bodies, which should be the focus of this plugin; <code>ParamMappingPlugin</code> should be the implementation of <code>ShenyuPlugin</code>.</p><p>First, take a look at the <code>ParamMappingPlugin</code>, the focus is on the override of the <code>doExecute</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... // judge whether paramMappingHandle is null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Determine the request body type according to the contentType in the header line</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpHeaders headers = exchange.getRequest().getHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaType contentType = headers.getContentType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return match(contentType).apply(exchange, chain, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>The match method returns the corresponding <code>Operator</code> according to contentType</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private Operator match(final MediaType mediaType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return operatorMap.get(MediaType.APPLICATION_JSON.toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return operatorMap.get(MediaType.APPLICATION_FORM_URLENCODED.toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return operatorMap.get(Constants.DEFAULT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As can be seen from the code of the match method, there are currently three types of <code>DefaultOperator</code>, <code>FormDataOperator</code>, and <code>JsonOperator</code>, which support the request body in two formats: <code>x-www-form-urlencoded</code> and <code>json</code>.</p></li></ul><p>So let&#x27;s take a look at what the above three operators are like.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-defaultoperator"></a>1. DefaultOperator<a class="hash-link" href="#1-defaultoperator" title="Direct link to heading">#</a></h4><p>Nothing happens, its apply method just continues to execute the plug-in chain, and has no real function. When the request body does not match the Operator, it will be skipped by <code>DefaultOperator</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-formdataoperator"></a>2. FormDataOperator<a class="hash-link" href="#2-formdataoperator" title="Direct link to heading">#</a></h4><p>This class is used to process the request body in the format of <code>x-www-form-urlencoded</code>.</p><p>Mainly depends on the <code>apply</code> method, but it looks a bit strange.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;Void&gt; apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return exchange.getFormData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .switchIfEmpty(Mono.defer(() -&gt; Mono.just(new LinkedMultiValueMap&lt;&gt;())))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .flatMap(multiValueMap -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The code in the ellipsis is the processing of the request body, as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// judge whether it is empty</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (Objects.isNull(multiValueMap) || multiValueMap.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return shenyuPluginChain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// convert form-data to json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">String original = GsonUtils.getInstance().toJson(multiValueMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG.info(&quot;get from data success data:{}&quot;, original);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// *modify request body*</span></span><span class="token-line" style="color:#393A34"><span class="token plain">String modify = operation(original, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (StringUtils.isEmpty(modify)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return shenyuPluginChain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Convert the modified json into LinkedMultiValueMap. Pay attention to this line, it will be mentioned later!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">LinkedMultiValueMap&lt;String, String&gt; modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">final BodyInserter bodyInserter = BodyInserters.fromValue(modifyMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// modify the request body in the exchange, and then continue to execute the plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return bodyInserter.insert(cachedBodyOutputMessage, new BodyInserterContext())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .then(Mono.defer(() -&gt; shenyuPluginChain.execute(exchange.mutate()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .request(new ModifyServerHttpRequestDecorator(httpHeaders, exchange.getRequest(), cachedBodyOutputMessage))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        )).onErrorResume((Function&lt;Throwable, Mono&lt;Void&gt;&gt;) throwable -&gt; release(cachedBodyOutputMessage, throwable));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p>PS: The omitted part is to set the request first and other operations.</p></blockquote><p>The more important thing above should be the modification request body of the star, that is, the call of the <code>operation</code> method. Here, because of the parameter type, the default method of the <code>Operator</code> interface will be called first (instead of being overridden by the <code>FormDataOperator</code>).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">default String operation(final String jsonValue, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DocumentContext context = JsonPath.parse(jsonValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // call the override operation method and add addParameterKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    operation(context, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // replace the related replacedParameterKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getReplaceParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getReplaceParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.renameKey(info.getPath(), info.getKey(), info.getValue());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Delete the related removeParameterKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getRemoveParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getRemoveParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.delete(info);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return context.jsonString();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After sorting it out, we can find that the json tool <a href="https://github.com/json-path/JsonPath" target="_blank" rel="noopener noreferrer">JsonPath</a> imported here makes the processing of the request body much simpler and clearer.</p><p><strong>In addition, we can notice that the <code>FormDataOperator</code> overrides the <code>operation(DocumentContext, ParamMappingHandle)</code> method.</strong></p><p><strong>Why override it?</strong> There is a default method for handling addParameterKey in the interface.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Default method in Operator interface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">default void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getAddParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.put(info.getPath(), info.getKey(), info.getValue()); //不同之处</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// method overridden by FormDataOperator</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paramMappingHandle.getAddParameterKeys().forEach(info -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.put(info.getPath(), info.getKey(), Arrays.asList(info.getValue()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In fact, there is such a line in <code>FormDataOperator#apply</code> (mentioned earlier):
<code>LinkedMultiValueMap&lt;String, String&gt; modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);</code></p><p>This line converts the modified json into <code>LinkedMultiValueMap</code>, <code>GsonUtils#toLinkedMultiValueMap</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public LinkedMultiValueMap&lt;String, String&gt; toLinkedMultiValueMap(final String json) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return GSON.fromJson(json, new TypeToken&lt;LinkedMultiValueMap&lt;String, String&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }.getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The attribute <code>targetMap</code> in the <code>LinkedMultiValueMap</code> class is defined as: <code>private final Map&lt;K, List&lt;V&gt;&gt; targetMap</code></p><p>Therefore, the value in the json string must be in the form of a list, otherwise Gson will throw a conversion error exception, which is why the <code>FormDataOperator</code> must override the operator method.</p><p><strong>But why use <code>LinkedMultiValueMap</code>?</strong></p><p>Go back to the first line <code>exchange.getFormData</code> of the <code>FormDataOperator#apply</code> method. In SpringMVC, the return value type of <code>DefaultServerWebExchange#getFormData</code> is <code>Mono&lt;MultiValueMap&lt;String, String&gt;&gt;</code>, and <code>LinkedMultiValueMap</code> is a subclass of <code>MultiValueMap</code>. And, the <code>getFormData</code> method is for the request body in the format of <code>x-www-form-urlencoded</code>.</p><p><img alt="param-mapping-getFormData" src="/assets/images/param-mapping-getFormData-04b664908cd5f52d149eb1098d5648c9.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="三jsonoperator"></a>三、JsonOperator<a class="hash-link" href="#三jsonoperator" title="Direct link to heading">#</a></h4><p>Obviously, this class is used to process the request body in Json format.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;Void&gt; apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerRequest serverRequest = ServerRequest.create(exchange, MESSAGE_READERS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mono&lt;String&gt; mono = serverRequest.bodyToMono(String.class).switchIfEmpty(Mono.defer(() -&gt; Mono.just(&quot;&quot;))).flatMap(originalBody -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;get body data success data:{}&quot;, originalBody);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // call the default operation method to modify the request body</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String modify = operation(originalBody, paramMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.just(modify);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    BodyInserter bodyInserter = BodyInserters.fromPublisher(mono, String.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... //process the header line</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    CachedBodyOutputMessage outputMessage = new CachedBodyOutputMessage(exchange, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // modify the request body in the exchange, and then continue to execute the plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return bodyInserter.insert(outputMessage, new BodyInserterContext())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ServerHttpRequestDecorator decorator = new ModifyServerHttpRequestDecorator(headers, exchange.getRequest(), outputMessage);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return shenyuPluginChain.execute(exchange.mutate().request(decorator).build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            })).onErrorResume((Function&lt;Throwable, Mono&lt;Void&gt;&gt;) throwable -&gt; release(outputMessage, throwable));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The processing flow of <code>JsonOperator</code> is roughly similar to that of <code>FormDataOperator</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>Finally, use a picture to briefly summarize.</p><p><img alt="param-mapping-summary" src="/assets/images/param-mapping-summary-490cf9ee499bf9efc03d0c963b39118c.jpg"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/param-mapping">Param-Mapping</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Code Analysis For Param-Mapping Plugin" href="/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Divide-Plugin">Code Analysis For Divide Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.308Z">September 28, 2024</time> · 21 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>The <code>ShenYu</code> gateway uses the <code>divide</code> plugin to handle <code>http</code> requests. You can see the official documentation <a href="https://shenyu.apache.org/docs/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Quick start with Http</a> to learn how to use this plugin.</p><blockquote><p>This article is based on <code>shenyu-2.4.3</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/docs/user-guide/http-proxy" target="_blank" rel="noopener noreferrer">Http Proxy</a> for the introduction of the official website.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-register-service"></a>1. Register Service<a class="hash-link" href="#1-register-service" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--declaration-of-registration-interface"></a>1.1  Declaration of registration interface<a class="hash-link" href="#11--declaration-of-registration-interface" title="Direct link to heading">#</a></h4><p>Use the annotation <code>@ShenyuSpringMvcClient</code> to register the service to the gateway. The simple <code>demo</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)  // API</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/findById&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/findById&quot;, desc = &quot;Find by id&quot;) // method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO findById(@RequestParam(&quot;id&quot;) final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return build(id, &quot;hello world findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>define annotation:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //desc info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //is enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //register MetaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-scan-annotation"></a>1.2 Scan annotation<a class="hash-link" href="#12-scan-annotation" title="Direct link to heading">#</a></h4><p>Annotation scanning is done through <code>SpringMvcClientBeanPostProcessor</code>, which implements the <code>BeanPostProcessor</code> interface and is a post-processor provided by <code>Spring</code>.</p><p>During constructor instantiation.</p><ul><li>Read the property configuration</li><li>Add annotations, read <code>path</code> information</li><li>Start the registry and register with <code>shenyu-admin</code></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientBeanPostProcessor implements BeanPostProcessor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Constructor instantiation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientBeanPostProcessor(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. read Properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;http register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. add annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PostMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(GetMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(DeleteMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(PutMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. start register cneter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // override post process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>SpringMvcClientBeanPostProcessor#postProcessAfterInitialization()</li></ul><p>Rewrite post-processor logic: read annotation information, construct metadata objects and <code>URI</code> objects, and register them with <code>shenyu-admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(@NonNull final Object bean, @NonNull final String beanName) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. If the all service is registered or is not a Controller class, it is not handled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull) || !hasAnnotation(bean.getClass(), Controller.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Read the annotations on the class ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuSpringMvcClient beanShenyuClient = AnnotationUtils.findAnnotation(bean.getClass(), ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1 build  superPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.2 whether to register the entire class method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // build the metadata object and register it with shenyu-admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(beanShenyuClient, pathJoin(contextPath, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. read all methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(bean.getClass());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3.1 read the annotations on the method ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuSpringMvcClient methodShenyuClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If there is no annotation on the method, use the annotation on the class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // 3.2 Build path information, build metadata objects, register with shenyu-admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(methodShenyuClient, buildApiPath(method, superPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><ol><li>If you are registering the whole service or not <code>Controller</code> class, do not handle it</li></ol></li><li><ol start="2"><li>read the annotation on the class <code>ShenyuSpringMvcClient</code>, if the whole class is registered, build the metadata object here and register it with <code>shenyu-admin</code>.</li></ol></li><li><ol start="3"><li>Annotation on the handler method <code>ShenyuSpringMvcClient</code>, build <code>path</code> information for the specific method, build the metadata object and then register it with <code>shenyu-admin</code></li></ol></li></ul><p>There are two methods here that take <code>path</code> and need special instructions.</p><ul><li>buildApiSuperPath()</li></ul><p>Construct <code>SuperPath</code>: first take the <code>path</code> property from the annotation <code>ShenyuSpringMvcClient</code> on the class, if not, take the <code>path</code> information from the <code>RequestMapping</code> annotation on the current class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiSuperPath(@NonNull final Class&lt;?&gt; method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // First take the path property from the annotation ShenyuSpringMvcClient on the class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return shenyuSpringMvcClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Take the path information from the RequestMapping annotation of the current class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>buildApiPath()</li></ul><p>Build <code>path</code>: first read the annotation <code>ShenyuSpringMvcClient</code> on the method and build it if it exists; otherwise get the <code>path</code> information from other annotations on the method; complete <code>path = contextPath(context information) + superPath(class information) + methodPath(method information)</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildApiPath(@NonNull final Method method, @NonNull final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Read the annotation ShenyuSpringMvcClient on the method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient shenyuSpringMvcClient = AnnotationUtils.findAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.1 If path exists, build</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuSpringMvcClient) &amp;&amp; StringUtils.isNotBlank(shenyuSpringMvcClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //1.2  path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, shenyuSpringMvcClient.path());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Get path information from other annotations on the method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String path = getPathByMethod(method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // 2.1 path = contextPath+superPath+methodPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pathJoin(contextPath, superPath, path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return pathJoin(contextPath, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>getPathByMethod()</li></ul><p>Get <code>path</code> information from other annotations on the method, other annotations include.</p><ul><li>ShenyuSpringMvcClient</li><li>PostMapping</li><li>GetMapping</li><li>DeleteMapping</li><li>PutMapping</li><li>RequestMapping</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getPathByMethod(@NonNull final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through interface annotations to get path information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class&lt;? extends Annotation&gt; mapping : mappingAnnotation) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String pathByAnnotation = getPathByAnnotation(AnnotationUtils.findAnnotation(method, mapping), pathAttributeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(pathByAnnotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return pathByAnnotation;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After the scanning annotation is finished, construct the metadata object and send the object to <code>shenyu-admin</code> to complete the registration.</p><ul><li>Metadata </li></ul><p>Includes the rule information of the currently registered method: contextPath, appName, registration path, description information, registration type, whether it is enabled, rule name and whether to register metadata.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private MetaDataRegisterDTO buildMetaDataDTO(@NonNull final ShenyuSpringMvcClient shenyuSpringMvcClient, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path) // Registered path, used when gateway rules match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(shenyuSpringMvcClient.desc()) // desc info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.HTTP.getName()) // divide plugin, http type when default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuSpringMvcClient.enabled()) // is enabled?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(StringUtils.defaultIfBlank(shenyuSpringMvcClient.ruleName(), path))//rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .registerMetaData(shenyuSpringMvcClient.registerMetaData()) // whether to register metadata information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The specific registration logic is implemented by the registration center, which has been analyzed in the previous articles and will not be analyzed in depth here.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-register-uri-data"></a>1.3 Register URI Data<a class="hash-link" href="#13-register-uri-data" title="Direct link to heading">#</a></h4><p><code>ContextRegisterListener</code> is responsible for registering the client&#x27;s <code>URI</code> information to <code>shenyu-admin</code>, it implements the <code>ApplicationListener</code> interface, when the context refresh event <code>ContextRefreshedEvent</code> occurs, the <code>onApplicationEvent()</code> method is executed to implement the registration logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ContextRegisterListener implements ApplicationListener&lt;ContextRefreshedEvent&gt;, BeanFactoryAware {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Constructor instantiation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ContextRegisterListener(final PropertiesConfig clientConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read Properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String errorMsg = &quot;http register param must config the contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = Integer.parseInt(Optional.ofNullable(props.getProperty(ShenyuClientConstants.PORT)).orElseGet(() -&gt; &quot;-1&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setBeanFactory(final BeanFactory beanFactory) throws BeansException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execute application events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // The method is guaranteed to be executed once</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. If you are registering for the entire service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Build metadata and register</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // get port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final int mergedPort = port &lt;= 0 ? PortUtils.findPort(beanFactory) : port;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. Constructing URI data and registering</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(mergedPort));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage() + &quot;please config ${shenyu.client.http.props.port} in xml/yml !&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // build URI data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private URIRegisterDTO buildURIRegisterDTO(final int port) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(this.contextPath) // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName) // appName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .protocol(protocol) // protocol</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .host(IpUtils.isCompleteHost(this.host) ? this.host : IpUtils.getHost(this.host)) //host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .port(port) // port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName()) // divide plugin, default registration http type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // build MetaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .path(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ruleName(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="14-handle-registration-information"></a>1.4 Handle registration information<a class="hash-link" href="#14-handle-registration-information" title="Direct link to heading">#</a></h4><p>The metadata and <code>URI</code> data registered by the client through the registry are processed in <code>shenyu-admin</code>, which is responsible for storing to the database and synchronizing to the <code>shenyu</code> gateway. The client registration processing logic of <code>Divide</code> plugin is in <code>ShenyuClientRegisterDivideServiceImpl</code>. The inheritance relationship is as follows.</p><p><img src="/assets/images/ShenyuClientRegisterDivideServiceImpl-4d9351b1efbb545cde2a3a172e35f59c.png"></p><ul><li>ShenyuClientRegisterService: client registration service, top-level interface.</li><li>FallbackShenyuClientRegisterService: registration failure, provides retry operation.</li><li>AbstractShenyuClientRegisterServiceImpl: abstract class, implements part of the public registration logic;</li><li>AbstractContextPathRegisterService: abstract class, responsible for registering <code>ContextPath</code>.</li><li>ShenyuClientRegisterDivideServiceImpl: implementation of the <code>Divide</code> plug-in registration.</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="141-register-service"></a>1.4.1 Register Service<a class="hash-link" href="#141-register-service" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</li></ul><p>The metadata <code>MetaDataRegisterDTO</code> object registered by the client through the registry is picked up and dropped in the <code>register()</code> method of <code>shenyu-admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadat</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1411-register-selector"></a>1.4.1.1 Register Selector<a class="hash-link" href="#1411-register-selector" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>Build <code>contextPath</code>, find if the selector information exists, if it does, return <code>id</code>; if it doesn&#x27;t, create the default selector information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Find if selector information exists by name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a default selector message if it does not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Default Selector Information</li></ul><p>Construct the default selector information and its conditional properties here.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build selector </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //register default Selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //build</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //build the conditional properties of the default selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build Default Selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // default CUSTOM_FLOW</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //default  AND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) //default 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build default selector conditional properties</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // default URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // default match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); // default /contextPath/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Register default selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector condition  info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert selector information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // insert selector condition information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Publish synchronization events to synchronize selection information and its conditional attributes to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1412-register-rule"></a>1.4.1.2 Register Rule<a class="hash-link" href="#1412-register-rule" title="Direct link to heading">#</a></h6><p>In the second step of registering the service, start building the default rules and then register the rules.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default rule handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register Metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>default rule handle</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default rule handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DivideRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Divide</code> plugin default rule handle.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DivideRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * load balance: default RANDOM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadBalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * retry strategy: default CURRENT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String retryStrategy = RetryEnum.CURRENT.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * retry: default 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int retry = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  retry: default 3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  retry: default  10240 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long headerMaxSize = Constants.HEADER_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  retry: default 102400 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long requestMaxSize = Constants.REQUEST_MAX_SIZE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>build default rule info</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // build default rule info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  build default rule info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId) //selector Id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) //rule Name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) // default and</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) // default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) //default TRUE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1) //default 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) // default URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); //if the path conatins *, default match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); // default = </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>Registration rules: insert records to the database and publish events to the gateway for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert rule into database </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //insert rule condition into database </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());           </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish events to the gateway for data synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1413-register-metadata"></a>1.4.1.3 Register Metadata<a class="hash-link" href="#1413-register-metadata" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDivideServiceImpl#registerMetadata()</li></ul><p>Insert or update metadata and then publish sync events to the gateway.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dto.isRegisterMetaData()) { </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // save or update MetaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event to  gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1414-register-contextpath"></a>1.4.1.4 Register ContextPath<a class="hash-link" href="#1414-register-contextpath" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractContextPathRegisterService#registerContextPath()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerContextPath(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set contextPath for selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPathSelectorId = getSelectorService().registerDefault(dto, PluginEnum.CONTEXT_PATH.getName(), &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ContextMappingRuleHandle handle = new ContextMappingRuleHandle();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handle.setContextPath(PathUtils.decoratorContextPath(dto.getContextPath()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set contextPath for rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getRuleService().registerDefault(buildContextPathDefaultRuleDTO(contextPathSelectorId, dto, handle.toJson()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="142-register-uri"></a>1.4.2 Register URI<a class="hash-link" href="#142-register-uri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>The server side receives the <code>URI</code> information registered by the client and processes it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Retry after registration failure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>Get a valid <code>URI</code> from the <code>URI</code> registered by the client, update the corresponding selector <code>handle</code> property, and send a selector update event to the gateway.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get selector </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // gte valid URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update the handle property of the selector to the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Send selector update events to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The source code analysis on service registration is completed as well as the analysis flow chart is as follows.</p><p><img src="/assets/images/divide-register-zh-0697d4849e6ae1dbd2f15a0fd528cd32.png"></p><p>The next step is to analyze how the <code>divide</code> plugin initiates a call to the <code>http</code> service based on this information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-call-http-service"></a>2. Call Http Service<a class="hash-link" href="#2-call-http-service" title="Direct link to heading">#</a></h3><p>The <code>divide</code> plugin is the core processing plugin used by the gateway to handle <code>http protocol</code> requests.</p><p>Take the case provided on the official website <a href="https://shenyu.apache.org/docs/quick-start/quick-start-http" target="_blank" rel="noopener noreferrer">Quick start with Http</a> as an example, a direct connection request is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:8189/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After proxying through the <code>ShenYu</code> gateway, the request is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/http/order/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The services proxied by the <code>ShenYu</code> gateway are still able to request the previous services, where the <code>divide</code> plugin comes into play. The class inheritance relationship is as follows.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdYAAAGoCAIAAAB0UFO8AAAACXBIWXMAAB2HAAAdhwGP5fFlAAAgAElEQVR42u2d3ZfbRJqH59/ZEzLbsJCAp+3uzhchBAwmgkzmsz07aJpZDwPj7IbgkJAYw5yFHQeyNHhgLvoqc9V3PefsXmf+o9nrLVm2VJKqSiVZsmX5+R2dnO6O7JLen97Hr0pV5R+cKkKNqU4tXVtT0W7Zwl/8Jc4ltfsDLKRd/MVf/AXBWEiK4i/+gmAspF38xV/iDIKxkBTFX/wFwVhIu/iLv8QZBGMhKUq7+AuCsZAUJc74S5xBMBaSorSLvyAYC0lR4oy/xBkE0y4pSrv4C4KxkBQlzvhLnEEw7ZKitIu/IBgLSVHijL/EGQTTLv7SLv6CYCwkRYkz/uIvCKZd/KVd/AXBWEiKEmf8BcFYSLv4i7/EGQRjISmKv/gLgrGQdvEXf4kzCMZCUpR28RcEYyEpSpzxlziDYCwkRWkXf0EwFpKixBl/iTMIxkJSlHbxd40R3EAIIbQibTSCbyGElqtOpyOX3mijOyLEBXFwcHADIVS+RK7JCKYjgr5gD8HiythGCJUvkWsgGASDYIRAMAgGwQiBYBAMgkEwQiAYBINghEAwCAbBCCEQDIJBMEIgGASDYIQQCAbBIBghEAyCQTBCCASDYBCMEAgGwSAYIQSCQfCSEbx3pXl5v3X1vVb79k7n/q7YxA/iV/FH8V8kG0IgGASXguDz15rtD3be+GTXsIkdxG6kHEIgGAQXhuCdi9uv3kyBr7yJncVL6qf24Pivf/u72A4HDlhZx9A1Gk5/fHw4HnY7DRAMgtcDwedebb5+d9eev/4mXiJeuBZ0aHR6XlqePPEZEWyHR5O+64BgFcUmI+U2EGhzqozg7njm8uOjYbvRAMEguOoIFhh940Fm/s62B1WnsKBJd3wcI6+8xRIVBE+D1hslPq4iQTs5HrkOCAbBIHhRBO9c3M5R/8Zq4cr2SHjV3NETibbHUkE3K4pBsBnBh0fH/pYEcSxEVemI6AxH3gFP+nREgODqIzhT/6+hXzj1AnU+333r4V6wXX13ZwlZEUBBVG1911F3UAx6IFiH4GQh2e70RvNPNS+qHUIHgkFwXgSfv9ZcnL/+Zh4j4XyxJ/PX3y44zZI5EpbAI7eRldogWHcvLwf28bhH6EAwCM6JYPP4s2da/xTbzCPVDA35zA1+vfSzlvj12me7Zd+QzroaTibdBgguDMG62IJgEAyCMyB470pKCXyu+9zZl0778BU/iF/N+xtmbcQQ3GzF/1JlBDc6TncwnHYfD7uuk/qEx3sA6Pr7T/pur63pkRS7tTvTbf6GXkOzFw77iYYandn+KcefeM/pXxr6KCl2SEdwsIPUF6FDcL5jiO2gjEzsZHWBzRdwEAyCy0Xw5f2WTQ9Dav0bbOINLRGs/Eu5z5Ss6zKZI8rRFNPBAFqq9lWjLwTIkmNUszYU9mtL9/7mz4+gx0D3ISSRNLJDgQjOfQxBZ/3o6IlyPEbDnSgDovskWMRZEAyCi0fwK+/vFItg8YaVQrCcdfYUlhK1F/R4ekMCpEFascdQISykfWKjCJJ8ydpQalGfhF2JCLbuiFgEwUErQTTkkIrqNS+CszkLgkFwKQhOnYicFcGG7mAZuMnncsmtjEJ4CpRJ6owpmdp+ukr3reG7xdJefkIVeYlUbelIMX9g6ChpLr8qGPGqLNZCLM5fUh6Cw5Jc2qFYBMvexW4j2u4kws2MCLYPOAgGwSUiuPPxbrEIFm9YNQRvJ4YG+zPiDCA2F866UtTwJEpikHoIlxKpyoZ0t96xNwzerSQEy8WpsqukEASbO17kY8iBYMuAg2AQXBMEJ3G8NATPStHBJDY7WbeGgLK+M/PU3Jspo1OGQrENhftL71YsgqePsyLzvG3Yl+8YlH3NMYWz4DIi2D7gIBgE16QjYrUITvYJLDLL1s98dS+t5h5WuYNlQ7pKM1bHKSlfSCeA5cTughGcFlLDPYHN4zj7gINgEFyHx3FVQLAOxLF8y5GoUnmlWdpG1R2cjwg6NiU/GMpDsPKjq2AEqz5RQDAIZlBazkFp1UFwcqhT1lm2BgSnbqkPr9IRrCJaSDHNQ8L8HREn8qoaw77bs+lGXxzBNrM8QDAIXm8Ep07NOP+rM89fmU3NED+IX3NPzagaghNjGJySq+BgpcfeggiW0RM+dkv8pewREUtDsIGGIBgErzeCt5c4QbmCCI7k8GLFab6JufkRnODjvBdC/4xubRFMFQyC64zgpS3TU28Em8eKFY7gWM9vgDDl+yj7iFNHYhWI4HzHYBNS3ag1EAyC1wbB20tcrLLSCF7sKVnqoLTCERxgS7zWfx8d4FJmcwQRKB/BmY5B4rIG3JrV2kAwCF4zBNd4yXYvjfWzMHQrSORLVHmMqmZRBafrFkaE8O5+PJz/0LOv9JMRKBXB+Y7BHFJ5WAsIBsFrjODt+n5xUVhJHR3733g2Wyir05NnamT91gzNQAV5Nu1E/na16UJrXnOWpLAkQmK6bfonjTzNt+3Gll8oE8H5jkGe/yZ9lPpfAxgZZwKCQfBaI3i7pl/fGVvkRTNKLF4m539KltZcsQg21I9mWEeH95b+OC73MUwZPTEN7+Nx3FogeKsI+QjeWjfxJfaizkoudSjPL0jyZbEu2p56sUrR1qBnM5csExGCHVJHYsTWtfE/e+RHeWUjOMcx6Bz01kubBrPiIyK20FQg+Eamy+j8tWbqxGWxg/34h8pUxE7b7XWnW3Ix7+LR35m11S2zLfNIA2UQ5hForNCIHMcQ2if38FjMoFumQLAawXRE5LiY9q40L++3rr7Xat/e6dzfFZv4Qfwq/mg5/wItsad7qV/VXqFbHIvpGytEMB0R9AXnRzACQFX/BFp4YTMQDIJBMMoNoDwjkWv5CZR7hXUQDIJBMMpZAC744Gg9TtOdeM/rFF9jGj7zrE4JDIJBMAjehM7f6PfRVaYALAnBsW+NS37PW6U+gUAwCAbBtUew9PWgmml4dT3f1AHdIBgEg2BU8gOo2YqXw6rRp0wQO1132JfWLO66TjU/e0AwCAbBCIFgEAyCEQLBIBgEg2CEQDAIBsEIgWAQDIIRQiAYBINghEAwCAbBCCEQDILLRPDBwcENhFD5ErkGgkFwHMFo7dT/6PdiIw5rKhAMgkN10BrqJ3dfExtxWFO1Wi0QDILRuurM7jO//PI1sYkfiMa6CwSDYLRmeq1/8ZdfvSY28QPRAMEgeEMRvGntVsTfWQk8RXCphTD+kkcgGAtJ0fj5BiVw2YUw/pJHIBgLSdHI+UZK4JILYfwlj0AwFpKikfONlcClFsL4Sx6BYCwkRcPzVZTAZRbC+EsegWAsJEXD81WWwOUVwvhLHoFgLCRFZ+erLYFLK4TxlzwCwVhIis7O11ACl1QI4y95BIKxkBT1zrdx4YypBC6nEMZf8ggEYyEp6p3v6zcvpfC3hEIYf8kjEIyFpOgpqxK4hEIYf8kjEIyFpOgpyxK48EIYf8kjEIyFm56iKQMhyiyE8Zc8AsFYuOkpmjoQorxCGH/JIxCMhRudoplL4EILYfwlj0AwFm50iuYogQsshPGXPALBWLi5KZqzBC6uEMZf8ggEY+HmpmjuErioQhh/ySMQjIUbmqILlcAFFcL4Sx4tD8FbRci3cAvVVMv0N9NYYN0m3gTXyN+1EAhG1fL3zPaz5u1l95yArPjXvBuukb/rgWBuZGh3vfy99IuWQLD4F3/piKAvGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/JXxCMhaQoCMZf8hcE0y4Ixl/yFwRjISkKgvEXBGMh7a6Nv89ffFbwV/yLvyAYBGMhKUqc8Zc4g2DaJUVpF39BMBaSosQZf4kzCKbd2qYofcEgGARjISm6svNlRAQIBsFYSIqCYPwlziAYC0Ew/pK/IBgLSVEQjL/EGQTTLgjGX/IXBGMhKQqC8Zc4g2DaBcH4S/6CYCwkRUEw/pK/IJh2QTD+kr8gGAtJURCMv+QvCKZdEIy/5C8IxkJS1Pp8WSMCBINgLCRFiTP+EmcQjIWkKO3iLwjGQlKUOOMvcQbBtFv/FKUvGASDYCwkRVd2voyIAMEgGAtJURCMv8QZBGMhCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/J30ojeKsI+RZuoZqqUv5e3t8VCBb/4kst/d00gWAEgvGX/F0dgrmRoV06IvCX/KUvGAtJURCMvyAYC2m32v6yRgQIBsFYSIoSZ/wlziAYC0lR2sVfEIyFpChxxl/iDIJpt/4pSl8wCAbBWEiKrux8GREBgkEwFpKiIBh/iTMIxkIQjL/kLwjGQlIUBOMvcQbBtAuC8Zf8BcFYSIqCYPwlziCYdkEw/pK/IBgLSVEQjL/kLwimXRCMv+QvCMZCUhQE4y/5C4JpFwTjL/kLgrGQFLU+X9aIAMEgGAtJUeKMv8QZBGMhKUq7+AuCsZAUJc74S5xBMO3WP0XpCwbBIBgLSdGVnS8jIkAwCMZCUhQE4y9xBsFYCILxl/wFwVhIioJg/CXOIJh2QTD+kr8gGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxl/wFwbQLgvGX/AXBWEiKgmD8JX9BMO2CYPwlf0EwFpKi1ufLGhEgGASrLbyFEEL1UqfTWScEHxwc3EAIofWXoNn6IVgc9zZCCK2/BM2WgeBGcQLBCKG6IrhRjkAwQgitDsF0RCCE0Mo6IkAwQgiBYIQQAsEgGCGEQDBCCIFgEIwQAsEgGCGEQDAIRgiBYBCMEEIgeGEEN5ut5r8NWsPvFNu9w2YHpiOEQHAZCG7ttD7+Rg3f2Lb/Oy4IhBAILhLBVvCVttpb3h4c//Vvfxfb4cAhAQgsoQvUaDj98fHheNjtNEAwCM5y6XR6/fFkNN1Srx5IkT22x4cnT/ygBdvh0aTvOgRWRbHZpRjfBgJtTpWvye545vLjo2G7sSQK1xbBd0afL4Lg8xcurmMRYXMRQwp7mnTHxzHyylssUQnsNGi9UeLjKhK0k+OR64DgmiPY7b336ZffLoLg4OXrUXccPZEu8UnXePUs53IXR9V2h6OjJyO3Udm4GY4wHtWjY6mgmxXFINiM4MOjY39LgjgWoqp0RHTE9XDs3d/QEbEIgls7OwKgiyP4o0+/SA2f8/nuWw/3gu3quzsruW58IgTXupl6y7ncg1Yqi2DzEQb/K6q2vuuoOygGPRCsQ3CykGx3eqP5p5oX1Q6hqymCH/zXo0IQLLZz586b+PvFnsxff7vgNFdy9zQlxYzFj8c9ELzIEcolsP3xg2AzgmOBla9SEFwfBDdbLZ+eSgQ3733z1N7l081L8nbWvaVD8Mf/+dAQO5+5wa+XftYSv177bHd1V/zs+o6VGCA4M4LnNxapvTogOBOCdbEFwfVB8O9u3tYh+Ow7gxh8g+3pV64rEWzuEY4huNmK/2UZV7w7ka9dm0s5uY/33Mkd+g+y+26vndYRJu7Bu4Oh3zEqbsZjj7nbHUds3RBwjv+XtrSb1w/r/zFIQvGerrfF8rYh3sqdj/cYDLuubYq24wfZsD/CohDsHfzsGLwjT33C4xsxSjMiGb1plGYN9RMNNRLx10Qs/p7TvzT0l4Fih3QEBztIhYLuus13DInrRxGZ2MnqApsv4BuN4ACdMQQ3P/rvWc37TnSO3IM/n77wsq4KFtvVV9uWCFb+peSKI172huzQP9KVL3fdQ//DsbaEGR09MYwNCD4SlFtQb0aPoSe/Z7iPOzlUtqV6pB6h2GByeKI9SJsjjDxTsq7LUgM7PXItVfsqI8QxJ0cZZm0o7NfW91DFIChdWuoPIYmkkR0KRHDuYwgKheS16l88wTUQC4juk2ARZ0HwDMFP7bwo+PvCuw8y9QWL7eD3/eoiuBPv/G1Y9EXI15M0Cif+5DqZQjK8xPvLD7sXQHCvH82TJATDZ+snClLruhrlF2ZF8HbGcX6Gk4odttIXDxaJkzUMccnaUGpRn4RdiQi27ohYBMFBK/LlGro8zo3gbM6C4BDBfgmc9XGceVyEDNzkc7nktpzezNSSR4bLtOCNPtZ3wxIymg9S8eLG7hYjYwNsOiLCa3qaGNP5SP4+sx4Dv7nkPKXw7JKfEPKjnsRBeuPP5qW9XVdJBIuPjzLMeQnSVbpvDd8t5ot82JGXSNWWjhTB8StpLr8q+KxVf3SZPssLRrDSwWIRLHsXu42QL+8cCLYPOAguDMGf/OnraiJYd4Ga785i15Pyoglv06R30N275Xscl34MDXUHn6HMVx72Ig8MVTW1CcTmwllXihq673UnKzdk+SzRbF8yFCUhWC5OlXVDIQg2VyHyMeRAcFEPb0GwLYLvf/6lTRxXgGB9UplLHmnEa8ptaSQny0FwjqtW+c4Nu9EgWcdsKHuWdWsIGCp03RGmfl7GHreW0VC4v/RuxSJ4+oEamedtw758x6Dsa9YlSFYE2wccBGsQ/ODPWRF8886DaiLYwNkQl6orJsfDmUT94hSG4Iz3bo1IB0JDUYlYTy21HzaXfAKTb5ZtOII72UuriYNyB8uGdJVm7HyVlC+kE8ByYnfBCO6kj45f5HFc1mQEwTMEP/1jVyD4qZ0Xk8x97tc3DQj+effXFURwyrNgYyFgM3BNeY0G15nfN9o3gtgSweYnXf4cYm9E2pFioZwIglUcKQrBOhDHXpgjUaXySrO0jao7OB8RdGxKfjCUh2DdaJYiEWxxJYDgEhH84ItHunHBp3dno4Cf/dUfmve+aX706OzBh/5ICXlcWgzBzVarggiOdDvOZ+LLm6FTMjeClcVg7GleUQhOXSLHpjOxWAQnhzplnWVrQHDqlvrwKh3BKqKFFNM8JMzfEXEir6ox7Lu9bsbpQvmOIfflDYKLQfAbb143zI5LTo1LdlDEEGwZx2UiOPmYaPGbPvuOZn/xxhiIDbV2PgSHvXUe5f0Enj2gM48DyTGfOGvaRMcwOCVXwcFKj70FESzbmuzij+9Z2oiIpSHY1MUPgktdI8KA4OkcjUdPd34hWCw28cP27T8Z+oL33XeqiGCpW1ZZAscK4az3y7ZVqvScyjB2NQeCLfuyV1IFG45wEQRnmpibH8EJPs57IfTP6NYWwVTBK0Nw9ze/LWqZHvs4LhPBlnmre+Rl83LLS0pXDy6IYMvXKvuCy3gcVx6Cs44zWZwIcs9vgDDl+yj7iBU9y6UhON8x2IQ0a2qA4MzrBX/68JvFEdxx3qoggm3G3JiTxDzCZttipFSmgiIHgk2DPTRrmNmHpWAEL/aULFOoCyFCuLTpwPHfRxexlNkcmlHYZSA40zFIl70G3JrV2kBwkQj2lwxeBMG3Ph5tV1L25V5ql6VuOoBy1GSjo16LRPcA2rLOzfq/hkHy6eOdO7ZH6KWxfhaGbgWJfIkqR1vzieh03cKIEN7dj4fzH3pZr7TI9LMyEZzvGMwhlR/zguASv7joxZeuLILgyiow26b30Hy/nJxoEH3cH00td+I9444tUu5qK45IhTKbcxxOeLPtC5bGMKWOCYtNUB5FlsXyHiHG0thwhNIo42P/G8/awfxpuQc847dmaAYqyLNpJ/Kyc9NB0F5zWbuSLOfmpE0OVE/zDUxfBoLzHYM8/036KFU8SQbBfH1nvgdxlrfbaatSqZc9MyNVuamqacX4UMvHUIYhH14empZa7430Y0XiCNYfYWyRF827TXTrV2R+SpbWXLEINtSPZlhHh/eW/jgu9zFMGT0xXQY8jlsqggcP7fnbfP3HVUZwajeuTdUcW3kvuUaicgKucuk/8xyN5MqW9iMBlOOC/THI5j5c3WKVXj3rOhmO0DV9Po1US8Qu1kXbUy9WmbjzKIQI9vdSsXVtZo5Lj/LKRnCOY9A56A1wnAaTERFLRbBQc+9866NHKcXvfm97UzWdhDZdMb3jpPYvB2urp+4c3k17++dZ1lo+sOx3DI7lcZqP0OsEd+fLyXecsr9YN2t4F+nOsn90GQSz3VnZd6DkO4bQPrmHJ/tcyvK0EQgOWfzyay3331sfjj3s3vmq9YdR86fuNkIb9YmbfT2NmqlS36q1WQhGCFX/a/3KvudbZGGzdUXwVhECwQgtDKA8I5Fr+QmUb4X1shG8VY5AMEKVKAAXeXC0NqfpTvynxImvMQ2feVakBF4egumIQGhlSPI6f6PfRzeu88Nn5Zccxr7nrTqfQPQFI7QJCH6i+7bA2p9v6oBuEAyCESq3/6E/W/FyWCn6lAxip+uv9z9fszjfyEgQDIIRQrUVCEYIIRAMghFCIBgEI4QQCAbBCCEQDIIRQggEg2CEEAiuBIIPDg5uIITQ+kvQbP0QjFDZev/el2IjDmg5WicEdxAqX2+OnoiNOKDlqNVqrQ2CTyFUsp49d+36d/8Qm/iBaKD1EghGa6+XP/yf69//n9jED0QDgeAVI1h5SrRbuCri76wEniK41EIYf8kjEIyFpGj8fIMSuOxCGH/JIxCMhaRo5HwjJXDJhTD+kkcgGAtJ0cj5xkrgUgth/CWPQDAWkqLh+SpK4DILYfwlj0AwFpKi4fkqS+DyCmH8JY9AMBaSorPz1ZbApRXC+EsegWAsJEVn52sogUsqhPGXPALBWEiKeuf7/KXrphK4nEIYf8kjEIyFpKh3vlcH/5vC3xIKYfwlj0AwFpKip6xK4BIKYfwlj0AwFpKipyxL4MILYfwlj0AwFm56iqYMhCizEMZf8ggEY+Gmp2jqQIjyCmH8JY9AMBZudIpmLoELLYTxlzwCwVi40SmaowQusBDGX/IIBGPh5qZozhK4uEIYf8kjEIyFm5uiuUvgogph/CWPQDAWbmiKLlQCF1QI4y95BIKxcENTdMESuJBCGH/JIxCMhRuaok+/cOHpxkV/e671ktiCX/3t4m//IiAr/o39PbK9cAF/yV8QjIWkaPHne+5fHwoEi3/xFwSDYCwkRUEw/hLnBRC8VYR8C7dQTVUpfy+8/ZVAsPgXX2rp76YJBCMQjL/k7+oQzI0M7dIRgb/kL33BWEiKgmD8BcFYSLsgGH/JIxCMhaQoCAbBIBgLaRcE4y9xBsFYSIqCYBAMgrGQFAXB+EucQTAWgmD8BcEgGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxlziDYNoFwfhL/oJgLCRFQTD+EmcQTLsgGH/JXxCMhaQoCMZf8hcE0y4Ixl/yFwRjISkKgvEXBGMh7YJg/CWPQDAWkqIgGASDYCykXRCMv+QRCMZCUhQEg2AQjIWkKAjGX+IMgrEQBINgEAyCsZAUBcH4S5xBMBaCYPwlf0EwFpKiIBh/iTMIpl0QjL/kLwjGQlIUBOMvcQbBtAuC8Zf8BcFYSIqCYPwlf0Ew7YJg/CV/QTAWkqIgGH/JXxBMuyAYf8lfEIyFpCgIxl8QjIW0C4LxlzwCwVhIioJgEAyCsZB2QTD+EmcQjIWkKAgGwXVE8FYR8i3cQjVVpfy98PZXAsHiX3yppb+bJhCMQDD+kr+rQzA3MrRLRwT+kr/0BWMhKQqC8RcEYyHtgmD8JY9AMBaSoiAYBINgLKRdEIy/xBkEYyEpCoJBMAjGQlIUBOMvcQbBWAiC8RcEg2AsJEVBMP4SZxBMuyAYf8lfEIyFpCgIxl/iDIJpFwTjL/kLgrGQFAXB+EucQTDtgmD8JX9BMBaSoiAYf8lfEEy7IBh/yV8QjIWkKAjGXxCMhbQLgvGXPALBWEiKgmAQDIKxkHZBMP6SRyAYC0lREAyCQTAWkqIgGH+JMwjGQhAMgkEwCMZCUhQE4y9xBsFYCILxl/wFwVhIioJg/CXOIJh2QTD+kr8gGAtJURCMv8QZBNMuCMZf8hcEYyEpCoLxl/wFwbS77v6eefHngr/iX/wFwSC4hhbeQggVoU6nA4JBcB4EHxwc3EAI5ZXIIBAMgvMjWFxD2wihvBIZBIJBMAhGCASDYBCMEAgGwSAYBCMEgkEwCEYIBIPgOYIbKCoQjFCxCIYqBoFgEIwQCF4dgumIoCMCIToi6AsGwQiBYBAMgkEwQiAYBINghEAwCAbBCCEQDIKrj+Ar7eZ+r/nesHl73Lo/EZv4wft1vyf+i7REIBgEg+BSENy89tPmB39qffIXwyZ2ELuRnAgEg2AQXByCL15u3fyjGb6R7eYfxUs2IQkbDac/Pj4cD7udxkrep+FO/vq3v4vt8bi3kgi0B8f+ARwOnBoYAYJBcPUQ/Oq11t2vM/DX3+5+LV5YeXpORupt2HWddiM9mbvjJzMCHg1t9i/8fQpEsCkgA4E2p8oILsoIEAyCK4Zgwd8H32Xmr789+K7KFG40eqOTWd7qtsdHk77rbAyCUwLy+OR4lIgGCAbBILg0BF+8nKf+jdXCVe2RsEFwAGLd7W2jMxwdHR8KUi/YEZH3fUpC8KF3MN6WjEYMtVXpiCjICBAMgiuE4Gz9v4Z+4TQ5n+++9XAv2K6+u7NMBCfrJnFL3u70+uNjuQBcZm6vFsHJgIhojI6eKENREQTzOA4E1w3BzWs/LYC//jAJ4xgJ54s9mb/+dsFprhDBUm3V62vQs1EInvUUB6GQ2gLBIBgEl4Ng/fiz5vC7swcfbrV/8tS5K6daF09feu3pN35xtne3NfxeN1LN0JDP3ODXSz9riV+vfbZbBQT76FlJP2PVEOzf7B/6O5xMuvMdQDAIBsElIPhKW8ff7btfb71yXZA3uT3jdLWv0s/aiCG42Yr/ZbUIjhWAIzfZZTHd5u/Q6Mz+Yn7D+KsSf1ER0Om6Q3/ARn8+YMMGwd6nyOyFk77ba+v6tVMRHOwg3RDoEDyPg+l0UndInu+0V0QRKF0AlQYp3xYEg+AKIbi539PVv1uvvCVo+89Xromyd/vOI/HHH9159Hzv7vQv97SF837PEsHKv6wWwRHSRXdOAij4i4GJQVkdAN1cSzakrtjY+AQzgv3RsqoHjIrxswUiODfVj0IAAAYoSURBVPjQkutlzVspdshxvroAyn+f3tAcq962AYJBcMUQ/P4nSpKe+c0Hgr8/fPnN5v1v4/+r6YWYIfj9T9YbwSr6KDNfebeeSh8DgoM3nNMzMlBBVHM6BHsgk14YG+GQPLwCOyIWQXD8fE+sztcCwWG3vheKaBP5evlBMAguDcGajmC/C+L53w8zP5HTdwfLwE0+l0tuK0Kwui9CgWB9r0WsoJZhob2dlwaKxUrXthtFVRRJ8mEI+sg9HkElmHhJSkDCAl/aoVgEG893YjjfVATPHXGUH1H5etJBMAguC8Gtj79VkvT0nvf8TVECp24ff7vWCFb2HmgBZOwc8N/HcmiXuVtDLhgtkRTlY+QYUkZESG2lRyAvggs/XxnByU/E1FsWEAyC64/gJI7XHsGGu+zgvywIouv9SGW0uadVV4krAxIMkc7EvnwItjnfcHRKRgSbR9rl64sAwSB4NR0RLxTaEVE/BOt2lvfX/T0CsqBGM4x2UFXcqS9U7mA3Yzsxa6NABOc9X8vHcfa2gmAQXNXHcW/f8oZDvPRG89438WFnd75q3jvM8ThuLRBs3xdsIqMeTOYODcOQWyW2pNJPtw6RqXa2XyCiYATbnC8IBsGbPCit9cn3P7zieNMxLrbP/vaONyht+P2Pbo+fe/s/Tp+/Kmrk5v1J1kFpa4LglL7LxGM0BYMCXCZxoHwfm1kPZgRbLH8h9zmE/QDyonF9t2dYAbJABFudLwgGwZuAYNPUjDuPfvjym8qpGf/ykwPd0DTLL9SoLoKtxwUb+hz8vyi7Hc0INtAhbxUcrELZUyA4yyTAMhBsOl8QDII3AsHGCcqiFj7z9i1R8z6199JTu5dPX379metvv9D/bMGO4Moi2DDOzGY8rw+LkEqq5vJXwSok5Zs0XB0EUwWDYBC8vGV6qo/gcCCt3cMoJYYCIitTPcfgNtOIiFwLRxSIYN3YO/NosNznC4JBcA0RvL3ExSori+DIRAbrDoQkCkV6z3sh1FVhyogIHcg0q5elDkpbGoJT56eoR0RkPF8QDILrieANWbJdOxnMHcqL5NpXr6pRwMNZRayp71JBJl6YPEh5xYPYO5tfOPt0cZ3yEKzrPY8NvYh9SOQ+XxAMguuI4O2N+OKi6AAAbzuMrhFjMzPCnOGPp4sS5HifyHww6cs7GtEV5Q2zjecvlItrpzvwJvtmnaCc7cg1U43j86pjE5Tzni8IBsE1RfB2jb++0+qLiw41VaRlhgfFoBltNiMr1EPKXMMyPRHYKV5eJoINRz69pdB2lbSliNmfLwgGwfVF8HY9v8TegGCvaPWW1k1fTDYdwWmr9ti8j9wlEvtsSFmsMlE8hhAc9NoZV0rLdeST2MfA4+nXu5l7q5Pn662XNjCdLwgGwbVG8HyMhHGk2mz8mf34B5TtM6PjtN1e15sokfn7Kdqd6Qunr13+F39MV0n3Wm9nWYdBeb42M+iWJhAMgpeK4JmutJv7veZ7w+btcev+RGziB+/X/Z7l/AuEcstm+gYIBsG1RjBCK+s7WmhhMxAMgkEwQgWUwIt/VykIBsEgGKFEnetOvOd1iQeh8nPFipTAIBgEg2BUQwTHvjUu+T1vVegFBsEgGASjOiLYOJZZnqwBgtcMwVtFyEfwVi0EglGFQex03WFfWrO4665gLF1WBG8hvUAwCEYIBK8OwXRE0BGBEB0R9AWDYIRAMAgGwSAYIRAMgkEwQiAYBINghBAIBsEgGCEQDII3AcEHBwc3EEJ5JTIIBIPg/AhGCC0uEAyC86iDECpCrVYLBINghFBFBYJBMEIIBINgLKx2u/iLv8QZBGMhKUq7+AuCsZAUJc74S5xBMBaSorSLvyAYC0lR4oy/xBkE0y4pSrv4C4KxkBQlzvhLnEEw7ZKitIu/IBgLSVHijL/EGQTTLv7SLv6CYCwkRYkz/uIvCKZd/KVd/AXBWEiKEmf8BcFYSLv4i7/EGQRjISmKv/gLgrGQdvEXf4kzCMZCUpR28RcEYyEpSpzxlziDYCwkRWkXf0EwFpKixBl/iTMIJkVJUdrFXxCMhaQoccZf4gyCaZcUpV38BcFYSIoSZ/wlziCYdvGXdvG3su3+P1nK/SpJ8iNQAAAAAElFTkSuQmCC"></p><ul><li>ShenyuPlugin: top-level interface, defining interface methods.</li><li>AbstractShenyuPlugin: abstract class that implements the common logic of the pluin.</li><li>DividePlugin: Divide pluin.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-request"></a>2.1 Accept Request<a class="hash-link" href="#21-accept-request" title="Direct link to heading">#</a></h4><p>After passing the <code>ShenYu</code> gateway proxy, the request entry is <code>ShenyuWebHandler</code>, which implements the <code>org.springframework.web.server.WebHandler</code> interface.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * hanlde web reuest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // execute plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Instantiating the default plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Execute each plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // get current plugin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // is skip ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If skipped, execute the next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // execute current plugin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-matching-rule"></a>2.2 Matching rule<a class="hash-link" href="#22-matching-rule" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>Execute the matching logic for selectors and rules in the <code>execute()</code> method.</p><ul><li>Matching selectors.</li><li>Matching rules.</li><li>Execute the plugin.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // selector </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // rule </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match rule </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // execute </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-execute-divide-plugin"></a>2.3 Execute Divide Plugin<a class="hash-link" href="#23-execute-divide-plugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.divide.DividePlugin#doExecute()</li></ul><p>Execute the specific logic of the <code>divide</code> plugin in the <code>doExecute()</code> method.</p><ul><li>Checks the <code>header</code> size.</li><li>Checking the <code>request</code> size.</li><li>Obtaining the list of services.</li><li>implementing load balancing.</li><li>Set request <code>url</code>, timeout time, retry policy.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // shenyu Context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Get the handle property of the rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DivideRuleHandle ruleHandle = DividePluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long headerSize = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // check header size</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (List&lt;String&gt; multiHeader : exchange.getRequest().getHeaders().values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String value : multiHeader) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                headerSize += value.getBytes(StandardCharsets.UTF_8).length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (headerSize &gt; ruleHandle.getHeaderMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request header is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_HEADER_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // check request size</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (exchange.getRequest().getHeaders().getContentLength() &gt; ruleHandle.getRequestMaxSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;request entity is too large&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.REQUEST_ENTITY_TOO_LARGE, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide upstream configuration error： {}&quot;, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // request ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // load balance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;divide has no upstream&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String domain = upstream.buildDomain();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_DOMAIN, domain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set timeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_TIME_OUT, ruleHandle.getTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.HTTP_RETRY, ruleHandle.getRetry());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set retry </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.RETRY_STRATEGY, ruleHandle.getRetryStrategy());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.LOAD_BALANCE, ruleHandle.getLoadBalance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.DIVIDE_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-do-request"></a>2.4 Do Request<a class="hash-link" href="#24-do-request" title="Direct link to heading">#</a></h4><p>By default, the <code>WebClientPlugin</code> initiates a call request to the <code>http</code> service with the following class inheritance relationship.</p><p><img src="/assets/images/WebClientPlugin-64ae237cda7fd819160795669ee2e2bd.png"></p><ul><li>ShenyuPlugin: top-level plug-in, defining plug-in methods.</li><li>AbstractHttpClientPlugin: abstract class that implements the public logic of request invocation.</li><li>WebClientPlugin: initiating requests through <code>WebClient</code>.</li><li>NettyHttpClientPlugin: initiating requests through <code>Netty</code>.</li></ul><p>Initiate the request call.</p><ul><li>org.apache.shenyu.plugin.httpclient.AbstractHttpClientPlugin#execute()</li></ul><p>Initiate the request call in the <code>execute()</code> method.</p><ul><li>Get the specified timeout, number of retries</li><li>Initiate the request</li><li>Retry after failure according to the specified retry policy</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractHttpClientPlugin&lt;R&gt; implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static final Logger LOG = LoggerFactory.getLogger(AbstractHttpClientPlugin.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // shenyu Context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final URI uri = exchange.getAttribute(Constants.HTTP_URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.CANNOT_FIND_URL, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get time out</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final long timeout = (long) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_TIME_OUT)).orElse(3000L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Duration duration = Duration.ofMillis(timeout);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get retry times</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int retryTimes = (int) Optional.ofNullable(exchange.getAttribute(Constants.HTTP_RETRY)).orElse(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get retry strategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String retryStrategy = (String) Optional.ofNullable(exchange.getAttribute(Constants.RETRY_STRATEGY)).orElseGet(RetryEnum.CURRENT::getName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;The request urlPath is {}, retryTimes is {}, retryStrategy is {}&quot;, uri.toASCIIString(), retryTimes, retryStrategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build header</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final HttpHeaders httpHeaders = buildHttpHeaders(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // do request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;R&gt; response = doRequest(exchange, exchange.getRequest().getMethodValue(), uri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Retry Policy CURRENT, retries the current service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RetryEnum.CURRENT.getName().equals(retryStrategy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //old version of DividePlugin and SpringCloudPlugin will run on this</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return response.retryWhen(Retry.anyOf(TimeoutException.class, ConnectTimeoutException.class, ReadTimeoutException.class, IllegalStateException.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .retryMax(retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .backoff(Backoff.exponential(Duration.ofMillis(200), Duration.ofSeconds(20), 2, true)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Retry for other services</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Exclude services that have already been called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Set&lt;URI&gt; exclude = Sets.newHashSet(uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // resend</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resend(response, exchange, duration, httpHeaders, exclude, retryTimes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .onErrorMap(TimeoutException.class, th -&gt; new ResponseStatusException(HttpStatus.GATEWAY_TIMEOUT, th.getMessage(), th))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap((Function&lt;Object, Mono&lt;? extends Void&gt;&gt;) o -&gt; chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; clientResponse,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final int retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;R&gt; result = clientResponse;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Retry according to the specified number of retries</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; retryTimes; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = resend(result, exchange, duration, httpHeaders, exclude);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;R&gt; resend(final Mono&lt;R&gt; response,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Duration duration,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final HttpHeaders httpHeaders,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                           final Set&lt;URI&gt; exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response.onErrorResume(th -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String selectorId = exchange.getAttribute(Constants.DIVIDE_SELECTOR_ID);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String loadBalance = exchange.getAttribute(Constants.LOAD_BALANCE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Check available services</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selectorId)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .stream().filter(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String trimUri = data.getUrl().trim();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (URI needToExclude : exclude) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // exclude already called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if ((needToExclude.getHost() + &quot;:&quot; + needToExclude.getPort()).equals(trimUri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // requets ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Load Balance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Upstream upstream = LoadBalancerFactory.selector(upstreamList, loadBalance, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(upstream)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no need to retry anymore</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.error(new ShenyuException(ShenyuResultEnum.CANNOT_FIND_HEALTHY_UPSTREAM_URL_AFTER_FAILOVER.getMsg()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final URI newUri = RequestUrlUtils.buildRequestUri(exchange, upstream.buildDomain());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Exclude uri that has already been called</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exclude.add(newUri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             // Make another call</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doRequest(exchange, exchange.getRequest().getMethodValue(), newUri, httpHeaders, exchange.getRequest().getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .timeout(duration, Mono.error(new TimeoutException(&quot;Response took longer than timeout: &quot; + duration)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnError(e -&gt; LOG.error(e.getMessage(), e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.httpclient.WebClientPlugin#doRequest()</li></ul><p>Initiate a real request call via <code>webClient</code> in the <code>doRequest()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;ClientResponse&gt; doRequest(final ServerWebExchange exchange, final String httpMethod, final URI uri,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final HttpHeaders httpHeaders, final Flux&lt;DataBuffer&gt; body) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return webClient.method(HttpMethod.valueOf(httpMethod)).uri(uri) // uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .headers(headers -&gt; headers.addAll(httpHeaders)) // header</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .body(BodyInserters.fromDataBuffers(body))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .exchange() // request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnSuccess(res -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (res.statusCode().is2xxSuccessful()) { // success</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else { // error</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.ERROR.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getResponse().setStatusCode(res.statusCode());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.CLIENT_RESPONSE_ATTR, res);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-response-result"></a>2.5 Response Result<a class="hash-link" href="#25-response-result" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>The response results are handled by the <code>ResponsePlugin</code> plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Processing results according to rpc type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The processing type is determined by <code>MessageWriter</code> and the class inheritance relationship is as follows.</p><p><img src="/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriter: interface, defining message processing methods.</li><li>NettyClientMessageWriter: processing of <code>Netty</code> call results.</li><li>RPCMessageWriter: processing the results of <code>RPC</code> calls.</li><li>WebClientMessageWriter: processing <code>WebClient</code> call results.</li></ul><p>The default is to initiate <code>http</code> requests via <code>WebCient</code>.</p><ul><li>org.apache.shenyu.plugin.response.strategy.WebClientMessageWriter#writeWith()</li></ul><p>Process the response results in the <code>writeWith()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // get response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerHttpResponse response = exchange.getResponse();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientResponse clientResponse = exchange.getAttribute(Constants.CLIENT_RESPONSE_ATTR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(clientResponse)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //cookies and headers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getCookies().putAll(clientResponse.cookies());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getHeaders().putAll(clientResponse.headers().asHttpHeaders());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // image, pdf or stream does not do format processing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Handling special response types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clientResponse.headers().contentType().isPresent()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                final String media = clientResponse.headers().contentType().get().toString().toLowerCase();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (media.matches(COMMON_BIN_MEDIA_TYPE_REGEX)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return response.writeWith(clientResponse.body(BodyExtractors.toDataBuffers()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Handling general response types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clientResponse = ResponseUtils.buildClientResponse(response, clientResponse.body(BodyExtractors.toDataBuffers()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return clientResponse.bodyToMono(byte[].class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .flatMap(originData -&gt; WebFluxResultUtils.result(exchange, originData))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .doOnCancel(() -&gt; clean(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Analysis to this point, the source code analysis on <code>Divide</code> plugin is complete, the analysis flow chart is as follows.</p><p><img src="/assets/images/divide-execute-zh-c145705430fc3aec6e561cc4ad183a05.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-summary"></a>3. Summary<a class="hash-link" href="#3-summary" title="Direct link to heading">#</a></h3><p>The source code analysis in this article starts from the <code>http</code> service registration to the <code>divide</code> plugin service calls. The <code>divide</code> plugin is mainly used to handle <code>http</code> requests. Some of the source code does not enter the in-depth analysis, such as the implementation of load balancing, service probe live, will continue to analyze in the following.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/blog/tags/divide">divide</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Code Analysis For Divide Plugin" href="/blog/Plugin-SourceCode-Analysis-Divide-Plugin"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin">Code Analysis For Dubbo Plugin</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.308Z">September 28, 2024</time> · 22 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive <code>API</code> gateway.</p></blockquote><p>The <code>Apache ShenYu</code> gateway uses the <code>dubbo</code> plugin to make calls to the <code>dubbo</code> service. You can see the official documentation <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo" target="_blank" rel="noopener noreferrer">Dubbo Quick Start</a> to learn how to use the plugin.</p><blockquote><p>This article is based on <code>shenyu-2.4.3</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/zh/docs/user-guide/dubbo-proxy/" target="_blank" rel="noopener noreferrer">Dubbo Service Access</a> for the introduction of the official website.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-service-registration"></a>1. Service Registration<a class="hash-link" href="#1-service-registration" title="Direct link to heading">#</a></h3><p>Take the example provided on the official website <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-dubbo/shenyu-examples-apache-dubbo-service" target="_blank" rel="noopener noreferrer">shenyu-examples-dubbo</a>. Suppose your <code>dubbo</code> service is defined as follows (<code>spring-dubbo.xml</code>).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">xsi</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">dubbo</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://code.alibabatech.com/schema/dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">       </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xsi:</span><span class="token tag attr-name" style="color:#00a4db">schemaLocation</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.springframework.org/schema/beans</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       http://code.alibabatech.com/schema/dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">       https://code.alibabatech.com/schema/dubbo/dubbo.xsd</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">application</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">test-dubbo-service</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">registry</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">address</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">${dubbo.registry.address}</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">protocol</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubbo</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">port</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">20888</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag namespace" style="color:#00009f;opacity:0.7">dubbo:</span><span class="token tag" style="color:#00009f">service</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">timeout</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">10000</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">interface</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">org.apache.shenyu.examples.dubbo.api.service.DubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubboTestService</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">beans</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Declare the application service name, register the center address, use the <code>dubbo</code> protocol, declare the service interface, and the corresponding interface implementation class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * DubboTestServiceImpl.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the interface implementation class, use the annotation <code>@ShenyuDubboClient</code> to register the service with <code>shenyu-admin</code>. The role of this annotation and its rationale will be analyzed later.</p><p>The configuration information in the configuration file <code>application.yml</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8011</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">servlet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">context-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">main</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">allow-bean-definition-overriding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2181</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># dubbo registry</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dubbo  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the configuration file, declare the registry address used by <code>dubbo</code>. The <code>dubbo</code> service registers with <code>shenyu-admin</code>, using the method <code>http</code>, and the registration address is <code>http://localhost:9095</code>.</p><p>See <a href="https://shenyu.apache.org/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">Application Client Access</a> for more information on the use of the registration method.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11--declaration-of-registration-interface"></a>1.1  Declaration of registration interface<a class="hash-link" href="#11--declaration-of-registration-interface" title="Direct link to heading">#</a></h4><p>Use the annotation <code>@ShenyuDubboClient</code> to register the service to the gateway. The simple <code>demo</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// dubbo sevice</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(&quot;dubboTestService&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboTestServiceImpl implements DubboTestService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;) // need to be registered method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DubboTest findById(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboTest(id, &quot;hello world shenyu Apache, findById&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>annotation definition:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Works on classes and methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuDubboClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //desc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-scan-annotation-information"></a>1.2 Scan annotation information<a class="hash-link" href="#12-scan-annotation-information" title="Direct link to heading">#</a></h4><p>Annotation scanning is done through the <code>ApacheDubboServiceBeanListener</code>, which implements the <code>ApplicationListener&lt;ContextRefreshedEvent&gt;</code> interface and starts executing the event handler method when a context refresh event occurs during the <code>Spring</code> container startup <code>onApplicationEvent()</code>.</p><p>During constructor instantiation.</p><ul><li>Read property configuration</li><li>Start the thread pool</li><li>Start the registry for registering with <code>shenyu-admin</code></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboServiceBeanListener implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApacheDubboServiceBeanListener(final PropertiesConfig clientConfig, final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.Read property configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = props.getProperty(ShenyuClientConstants.CONTEXT_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(&quot;apache dubbo client must config the contextPath or appName&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = contextPath;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = appName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.Start the thread pool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executorService = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder().setNameFormat(&quot;shenyu-apache-dubbo-client-thread-pool-%d&quot;).build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.Start the registry for registering with `shenyu-admin`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Context refresh event, execute method logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ApacheDubboServiceBeanListener#onApplicationEvent()</li></ul><p>Rewritten method logic: read <code>Dubbo</code> service <code>ServiceBean</code>, build metadata object and <code>URI</code> object, and register it with <code>shenyu-admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final ContextRefreshedEvent contextRefreshedEvent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //read ServiceBean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ServiceBean&gt; serviceBean = contextRefreshedEvent.getApplicationContext().getBeansOfType(ServiceBean.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (serviceBean.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //The method is guaranteed to be executed only once</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //handle metadata </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, ServiceBean&gt; entry : serviceBean.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler(entry.getValue());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //handle URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceBean.values().stream().findFirst().ifPresent(bean -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildURIRegisterDTO(bean));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>handler()</p><p>In the <code>handler()</code> method, read all methods from the <code>serviceBean</code>, determine if there is a <code>ShenyuDubboClient</code> annotation on the method, build a metadata object if it exists, and register the method with <code>shenyu-admin</code> through the registry.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void handler(final ServiceBean&lt;?&gt; serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get proxy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object refProxy = serviceBean.getRef();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = refProxy.getClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (AopUtils.isAopProxy(refProxy)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            clazz = AopUtils.getTargetClass(refProxy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //all methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //read ShenyuDubboClient annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuDubboClient shenyuDubboClient = method.getAnnotation(ShenyuDubboClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(shenyuDubboClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //build meatdata and registry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                publisher.publishEvent(buildMetaDataDTO(serviceBean, shenyuDubboClient, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildMetaDataDTO()</p><p>Constructs a metadata object where the necessary information for method registration is constructed and subsequently used for selector or rule matching.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private MetaDataRegisterDTO buildMetaDataDTO(final ServiceBean&lt;?&gt; serviceBean, final ShenyuDubboClient shenyuDubboClient, final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //app name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appName = buildAppName(serviceBean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = contextPath + shenyuDubboClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //desc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String desc = shenyuDubboClient.desc();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //service name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String serviceName = serviceBean.getInterface();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //rule name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configRuleName = shenyuDubboClient.ruleName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleName = (&quot;&quot;.equals(configRuleName)) ? path : configRuleName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //method name </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String methodName = method.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //parameter Types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] parameterTypesClazz = method.getParameterTypes();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String parameterTypes = Arrays.stream(parameterTypesClazz).map(Class::getName).collect(Collectors.joining(&quot;,&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(appName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .serviceName(serviceName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .methodName(methodName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(contextPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(path)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ruleName(ruleName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .pathDesc(desc)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .parameterTypes(parameterTypes)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcExt(buildRpcExt(serviceBean)) //dubbo ext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(shenyuDubboClient.enabled())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>buildRpcExt()</p><p> <code>dubbo</code> ext information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   private String buildRpcExt(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       DubboRpcExt build = DubboRpcExt.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .group(StringUtils.isNotEmpty(serviceBean.getGroup()) ? serviceBean.getGroup() : &quot;&quot;)//group</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .version(StringUtils.isNotEmpty(serviceBean.getVersion()) ? serviceBean.getVersion() : &quot;&quot;)//version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .loadbalance(StringUtils.isNotEmpty(serviceBean.getLoadbalance()) ? serviceBean.getLoadbalance() : Constants.DEFAULT_LOADBALANCE)//load balance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .retries(Objects.isNull(serviceBean.getRetries()) ? Constants.DEFAULT_RETRIES : serviceBean.getRetries())//retry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .timeout(Objects.isNull(serviceBean.getTimeout()) ? Constants.DEFAULT_CONNECT_TIMEOUT : serviceBean.getTimeout())//time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .sent(Objects.isNull(serviceBean.getSent()) ? Constants.DEFAULT_SENT : serviceBean.getSent())//sent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .cluster(StringUtils.isNotEmpty(serviceBean.getCluster()) ? serviceBean.getCluster() : Constants.DEFAULT_CLUSTER)//cluster</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .url(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return GsonUtils.getInstance().toJson(build);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><ul><li><p>buildURIRegisterDTO()</p><p>Construct <code>URI</code> objects to register information about the service itself, which can be subsequently used for service probing live.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private URIRegisterDTO buildURIRegisterDTO(final ServiceBean serviceBean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return URIRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .contextPath(this.contextPath) //context path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .appName(buildAppName(serviceBean))//app name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .rpcType(RpcTypeEnum.DUBBO.getName())//dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .host(buildHost()) //host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .port(buildPort(serviceBean))//port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The specific registration logic is implemented by the registration center, please refer to <a href="https://shenyu.apache.org/zh/docs/design/register-center-design/" target="_blank" rel="noopener noreferrer">Client Access Principles</a> .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//To the registration center, post registration events   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">publisher.publishEvent();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-processing-registration-information"></a>1.3 Processing registration information<a class="hash-link" href="#13-processing-registration-information" title="Direct link to heading">#</a></h4><p>The metadata and <code>URI</code> data registered by the client through the registry are processed at the <code>shenyu-admin</code> end, which is responsible for storing to the database and synchronizing to the <code>shenyu</code> gateway. The client-side registration processing logic of the <code>Dubbo</code> plugin is in the <code>ShenyuClientRegisterDubboServiceImpl</code>. The inheritance relationship is as follows.</p><p><img src="/assets/images/ShenyuClientRegisterDubboServiceImpl-a48cc4b745cb6a47ee000cf08d4cff04.png"></p><ul><li>ShenyuClientRegisterService: client registration service, top-level interface.</li><li>FallbackShenyuClientRegisterService: registration failure, provides retry operation.</li><li>AbstractShenyuClientRegisterServiceImpl: abstract class, implements part of the public registration logic.</li><li>ShenyuClientRegisterDubboServiceImpl: implementation of the <code>Dubbo</code> plugin registration.</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="131-registration-service"></a>1.3.1 Registration Service<a class="hash-link" href="#131-registration-service" title="Direct link to heading">#</a></h5><ul><li><p>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#register()</p><p>The metadata <code>MetaDataRegisterDTO</code> object registered by the client through the registry is picked up and dropped in the <code>register()</code> method of <code>shenyu-admin</code>.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1311-register-selector"></a>1.3.1.1 Register Selector<a class="hash-link" href="#1311-register-selector" title="Direct link to heading">#</a></h6><ul><li>org.apache.shenyu.admin.service.impl.SelectorServiceImpl#registerDefault()</li></ul><p>Construct <code>contextPath</code>, find if the selector information exists, if it does, return <code>id</code>; if it doesn&#x27;t, create the default selector information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final MetaDataRegisterDTO dto, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = ContextPathUtils.buildContextPath(dto.getContextPath(), dto.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Find if selector information exists by name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = findByNameAndPluginName(contextPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create a default selector message if it does not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return registerSelector(contextPath, pluginName, selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>Default selector information</p><p>Construct the default selector information and its conditional properties here.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String registerSelector(final String contextPath, final String pluginName, final String selectorHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildSelectorDTO(contextPath, pluginMapper.selectByName(pluginName).getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setHandle(selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //register default selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerDefault(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //build selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SelectorDTO buildSelectorDTO(final String contextPath, final String pluginId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDTO selectorDTO = buildDefaultSelectorDTO(contextPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setPluginId(pluginId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //build the conditional properties of the default selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setSelectorConditions(buildDefaultSelectorConditionDTO(contextPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build default selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private SelectorDTO buildDefaultSelectorDTO(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SelectorDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .name(name) // name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .type(SelectorTypeEnum.CUSTOM_FLOW.getCode()) // default type cutom</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .matchMode(MatchModeEnum.AND.getCode()) //default match mode</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .enabled(Boolean.TRUE)  //enable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loged(Boolean.TRUE)  //log</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .continued(Boolean.TRUE) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sort(1) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build default selector conditional properties</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;SelectorConditionDTO&gt; buildDefaultSelectorConditionDTO(final String contextPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorConditionDTO selectorConditionDTO = new SelectorConditionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamType(ParamTypeEnum.URI.getName()); // default URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamName(&quot;/&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); // default  match</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectorConditionDTO.setParamValue(contextPath + AdminConstants.URI_SUFFIX); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.singletonList(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Register default selector</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public String registerDefault(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //selector conditional properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert selector information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // inserting selector conditional properties to the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTO.setSelectorId(selectorDO.getId());            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Publish synchronization events to synchronize selection information and its conditional attributes to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return selectorDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1312-registration-rules"></a>1.3.1.2 Registration Rules<a class="hash-link" href="#1312-registration-rules" title="Direct link to heading">#</a></h6><p>In the second step of registering the service, start building the default rules and then register the rules.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. handle selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. handle rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. reigster metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>默认规则处理属性</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String ruleHandler() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DubboRuleHandle().toJson();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Dubbo</code> plugin default rule handling properties.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboRuleHandle implements RuleHandle {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * dubbo version.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String version;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * group.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String group;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * retry.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer retries = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * loadbalance:RANDOM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loadbalance = LoadBalanceEnum.RANDOM.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * timeout default 3000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timeout = Constants.TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>build default rule</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  // build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRpcDefaultRuleDTO(final String selectorId, final MetaDataRegisterDTO metaDataDTO, final String ruleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildRuleDTO(selectorId, ruleHandler, metaDataDTO.getRuleName(), metaDataDTO.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //  build default rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RuleDTO buildRuleDTO(final String selectorId, final String ruleHandler, final String ruleName, final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = RuleDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .selectorId(selectorId)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(ruleName) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .matchMode(MatchModeEnum.AND.getCode()) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .enabled(Boolean.TRUE) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .loged(Boolean.TRUE) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sort(1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .handle(ruleHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleConditionDTO ruleConditionDTO = RuleConditionDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramType(ParamTypeEnum.URI.getName()) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramName(&quot;/&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .paramValue(path) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (path.indexOf(&quot;*&quot;) &gt; 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.MATCH.getAlias()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditionDTO.setOperator(OperatorEnum.EQ.getAlias()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleDTO.setRuleConditions(Collections.singletonList(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.impl.RuleServiceImpl#registerDefault()</li></ul><p>Registration rules: insert records to the database and publish events to the gateway for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerDefault(final RuleDTO ruleDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO exist = ruleMapper.findBySelectorIdAndName(ruleDTO.getSelectorId(), ruleDTO.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDO ruleDO = RuleDO.buildRuleDO(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleConditionDTO&gt; ruleConditions = ruleDTO.getRuleConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(ruleDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert rule information into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleMapper.insertSelective(ruleDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //insert  rule body conditional attributes into the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleConditions.forEach(ruleConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionDTO.setRuleId(ruleDO.getId());     </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ruleConditionMapper.insertSelective(RuleConditionDO.buildRuleConditionDO(ruleConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish events to the gateway for data synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(ruleDO, ruleConditions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleDO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1313-register-metadata"></a>1.3.1.3 Register Metadata<a class="hash-link" href="#1313-register-metadata" title="Direct link to heading">#</a></h6><p>Metadata is mainly used for <code>RPC</code> service calls.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1. register selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2. register rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3. register metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4. register ContextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>org.apache.shenyu.admin.service.register.ShenyuClientRegisterDubboServiceImpl#registerMetadata()</p><p>Insert or update metadata and then publish sync events to the gateway.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void registerMetadata(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // get metaDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataService metaDataService = getMetaDataService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaDataDO exist = metaDataService.findByPath(dto.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //insert or update metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataService.saveOrUpdateMetaData(exist, dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void saveOrUpdateMetaData(final MetaDataDO exist, final MetaDataRegisterDTO metaDataDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataEventTypeEnum eventType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // DTO-&gt;DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaDataDO metaDataDO = MetaDataTransfer.INSTANCE.mapRegisterDTOToEntity(metaDataDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(UUIDUtils.getInstance().generateShortUuid());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateCreated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setDateUpdated(currentTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.insert(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.CREATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataDO.setId(exist.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            metaDataMapper.update(metaDataDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventType = DataEventTypeEnum.UPDATE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish sync events to gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.META_DATA, eventType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(MetaDataTransfer.INSTANCE.mapToData(metaDataDO))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="132-register-uri"></a>1.3.2 Register URI<a class="hash-link" href="#132-register-uri" title="Direct link to heading">#</a></h5><ul><li>org.apache.shenyu.admin.service.register.FallbackShenyuClientRegisterService#registerURI()</li></ul><p>The server side receives the <code>URI</code> information registered by the client and processes it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = key(selectorName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.removeFallBack(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = this.doRegisterURI(selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;Register success: {},{}&quot;, selectorName, uriList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.warn(&quot;Register exception: cause:{}&quot;, ex.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Retry after registration failure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.addFallback(key, new FallbackHolder(selectorName, uriList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.admin.service.register.AbstractShenyuClientRegisterServiceImpl#doRegisterURI()</li></ul><p>Get a valid <code>URI</code> from the <code>URI</code> registered by the client, update the corresponding selector <code>handle</code> property, and send a selector update event to the gateway.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // gte valid URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build handle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Update the handle property of the selector to the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Send selector update events to the gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The source code analysis on service registration is completed as well as the analysis flow chart is as follows.</p><p><img src="/assets/images/dubbo-register-en-37db6c1d92c1763193e88e60de554e93.png"></p><p>The next step is to analyze how the <code>dubbo</code> plugin initiates calls to the <code>http</code> service based on this information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-service-invocation"></a>2. Service Invocation<a class="hash-link" href="#2-service-invocation" title="Direct link to heading">#</a></h3><p>The <code>dubbo</code> plugin is the core processing plugin used by the <code>ShenYu</code> gateway to convert <code>http</code> requests into the <code>dubbo protocol</code> and invoke the <code>dubbo</code> service.</p><p>Take the case provided by the official website <a href="https://shenyu.apache.org/docs/quick-start/quick-start-dubbo/" target="_blank" rel="noopener noreferrer">Quick Start with Dubbo</a> as an example, a <code>dubbo</code> service is registered with <code>shenyu-admin</code> through the registry, and then requested through the <code>ShenYu</code> gateway proxy, the request is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">GET http://localhost:9195/dubbo/findById?id=100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept: application/json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The class inheritance relationship in the <code>Dubbo</code> plugin is as follows.</p><p><img src="/assets/images/ApacheDubboPlugin-286a36694f3fa121e7d3c7d67d08b833.png"></p><ul><li>ShenyuPlugin: top-level interface, defining interface methods.</li><li>AbstractShenyuPlugin: abstract class that implements plugin common logic.</li><li>AbstractDubboPlugin: dubbo plugin abstract class, implementing <code>dubbo</code> common logic.</li><li>ApacheDubboPlugin: ApacheDubbo plugin.</li></ul><blockquote><p>ShenYu Gateway supports ApacheDubbo and AlibabaDubbo\</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-receive-requests"></a>2.1 Receive requests<a class="hash-link" href="#21-receive-requests" title="Direct link to heading">#</a></h4><p>After passing the <code>ShenYu</code> gateway proxy, the request entry is <code>ShenyuWebHandler</code>, which implements the <code>org.springframework.web.server.WebHandler</code> interface.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebHandler implements WebHandler, ApplicationListener&lt;SortPluginEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * hanlde request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // execute default plugin chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mono&lt;Void&gt; execute = new DefaultShenyuPluginChain(plugins).execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (scheduled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute.subscribeOn(scheduler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class DefaultShenyuPluginChain implements ShenyuPluginChain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int index;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final List&lt;ShenyuPlugin&gt; plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultShenyuPluginChain(final List&lt;ShenyuPlugin&gt; plugins) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.plugins = plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * execute.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Void&gt; execute(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.index &lt; plugins.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // get plugin </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuPlugin plugin = plugins.get(this.index++);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean skip = plugin.skip(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (skip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return this.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // execute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return plugin.execute(exchange, this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-match-rule"></a>2.2 Match Rule<a class="hash-link" href="#22-match-rule" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.base.AbstractShenyuPlugin#execute()</li></ul><p>Execute the matching logic for selectors and rules in the <code>execute()</code> method.</p><ul><li>Matching selectors.</li><li>Matching rules.</li><li>Execute the plugin.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginName = named();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = BaseDataCache.getInstance().obtainPluginData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pluginData != null &amp;&amp; pluginData.getEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;SelectorData&gt; selectors = BaseDataCache.getInstance().obtainSelectorData(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selectors)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = matchSelector(exchange, selectors);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(selectorData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleSelectorIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorLog(selectorData, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;RuleData&gt; rules = BaseDataCache.getInstance().obtainRuleData(selectorData.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(rules)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // match rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RuleData rule;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorData.getType() == SelectorTypeEnum.FULL_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get last</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = rules.get(rules.size() - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rule = matchRule(exchange, rules);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(rule)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return handleRuleIfNull(pluginName, exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ruleLog(rule, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // execute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(exchange, chain, selectorData, rule);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-execute-globalplugin"></a>2.3 Execute GlobalPlugin<a class="hash-link" href="#23-execute-globalplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.global.GlobalPlugin#execute()</li></ul><p><code>GlobalPlugin</code> is a global plugin that constructs contextual information in the <code>execute()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // shenyu context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ShenyuContextBuilder builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // build context information to be passed into the exchange</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = builder.build(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.CONTEXT, shenyuContext);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.global.DefaultShenyuContextBuilder#build()</li></ul><p>Build the default context information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DefaultShenyuContextBuilder implements ShenyuContextBuilder {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext build(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //build data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String, MetaData&gt; buildData = buildData(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //wrap ShenyuContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return decoratorMap.get(buildData.getLeft()).decorator(buildDefaultContext(exchange.getRequest()), buildData.getRight());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Pair&lt;String, MetaData&gt; buildData(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get the metadata according to the requested uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = MetaDataCache.getInstance().obtain(request.getURI().getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; Boolean.TRUE.equals(metaData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.META_DATA, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(metaData.getRpcType(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Pair.of(RpcTypeEnum.HTTP.getName(), new MetaData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //set the default context information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuContext buildDefaultContext(final ServerHttpRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String appKey = request.getHeaders().getFirst(Constants.APP_KEY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sign = request.getHeaders().getFirst(Constants.SIGN);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = new ShenyuContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String path = request.getURI().getPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setPath(path); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setAppKey(appKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setSign(sign);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setTimestamp(timestamp);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setStartDateTime(LocalDateTime.now());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -&gt; shenyuContext.setHttpMethod(httpMethod.name()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.dubbo.common.context.DubboShenyuContextDecorator#decorator()</li></ul><p>wrap <code>ShenyuContext</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DubboShenyuContextDecorator implements ShenyuContextDecorator {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuContext decorator(final ShenyuContext shenyuContext, final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setModule(metaData.getAppName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setMethod(metaData.getServiceName()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setContextPath(metaData.getContextPath()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuContext.setRpcType(RpcTypeEnum.DUBBO.getName()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return shenyuContext;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String rpcType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RpcTypeEnum.DUBBO.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-execute-rpcparamtransformplugin"></a>2.4 Execute RpcParamTransformPlugin<a class="hash-link" href="#24-execute-rpcparamtransformplugin" title="Direct link to heading">#</a></h4><p>The <code>RpcParamTransformPlugin</code> is responsible for reading the parameters from the <code>http</code> request, saving them in the <code>exchange</code> and passing them to the <code>rpc</code> service.</p><ul><li>org.apache.shenyu.plugin.base.RpcParamTransformPlugin#execute()</li></ul><p>In the <code>execute()</code> method, the core logic of the plugin is executed: get the request information from <code>exchange</code> and process the parameters according to the form of content passed in by the request.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class RpcParamTransformPlugin implements ShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get request information from exchange</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerHttpRequest request = exchange.getRequest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(shenyuContext)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MediaType mediaType = request.getHeaders().getContentType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return body(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return formData(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //query</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return query(exchange, request, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //APPLICATION_JSON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; body(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(body -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, resolveBodyFromRequest(body));//解析body，保存到exchange中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // APPLICATION_FORM_URLENCODED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; formData(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.from(DataBufferUtils.join(serverHttpRequest.getBody())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(map -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String param = resolveBodyFromRequest(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LinkedMultiValueMap&lt;String, String&gt; linkedMultiValueMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        linkedMultiValueMap = BodyParamUtils.buildBodyParams(URLDecoder.decode(param, StandardCharsets.UTF_8.name())); //格式化数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (UnsupportedEncodingException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return Mono.error(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.toMap(() -&gt; linkedMultiValueMap));// 保存到exchange中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //query</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; query(final ServerWebExchange exchange, final ServerHttpRequest serverHttpRequest, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange.getAttributes().put(Constants.PARAM_TRANSFORM, HttpParamConverter.ofString(() -&gt; serverHttpRequest.getURI().getQuery()));//保存到exchange中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-execute-dubboplugin"></a>2.5 Execute DubboPlugin<a class="hash-link" href="#25-execute-dubboplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.dubbo.common.AbstractDubboPlugin#doExecute()</li></ul><p>In the <code>doExecute()</code> method, the main purpose is to check the metadata and parameters.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //param</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String param = exchange.getAttribute(Constants.PARAM_TRANSFORM);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //context</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //metaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetaData metaData = exchange.getAttribute(Constants.META_DATA);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check metaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!checkMetaData(metaData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot; path is : {}, meta data have error : {}&quot;, shenyuContext.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.META_DATA_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //check</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(metaData) &amp;&amp; StringUtils.isNoneBlank(metaData.getParameterTypes()) &amp;&amp; StringUtils.isBlank(param)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.DUBBO_HAVE_BODY_PARAM, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set rpcContext</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.rpcContext(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //dubbo invoke</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.doDubboInvoker(exchange, chain, selector, rule, metaData, param);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.ApacheDubboPlugin#doDubboInvoker()</li></ul><p>Set special context information in the <code>doDubboInvoker()</code> method, and then start the dubbo generalization call.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPlugin extends AbstractDubboPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doDubboInvoker(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final RuleData rule,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final MetaData metaData,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final String param) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set the current selector and rule information, and request address for dubbo graying support</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_SELECTOR_ID, selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_RULE_ID, rule.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RpcContext.getContext().setAttachment(Constants.DUBBO_REMOTE_ADDRESS, Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //dubbo generic invoker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Mono&lt;Object&gt; result = dubboProxyService.genericInvoker(param, metaData, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //execute next plugin in chain</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.then(chain.execute(exchange));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.proxy.ApacheDubboProxyService#genericInvoker()</li></ul><p><code>genericInvoker()</code> method.</p><ul><li>Gets the <code>ReferenceConfig</code> object.</li><li>Gets the generalization service <code>GenericService</code> object.</li><li>Constructs the request parameter <code>pair</code> object.</li><li>Initiates an asynchronous generalization invocation.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboProxyService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Generic invoker object.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Object&gt; genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.Get the ReferenceConfig object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReferenceConfig&lt;GenericService&gt; reference = ApacheDubboConfigCache.getInstance().get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Failure of the current cache information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Reinitialization with metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference = ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.Get the GenericService object of the generalization service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        GenericService genericService = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.Constructing the request parameter pair object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pair&lt;String[], Object[]&gt; pair;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(metaData.getParameterTypes()) || ParamCheckUtils.dubboBodyIsEmpty(body)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = new ImmutablePair&lt;&gt;(new String[]{}, new Object[]{});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pair = dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4.Initiating asynchronous generalization calls</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.fromFuture(invokeAsync(genericService, metaData.getMethodName(), pair.getLeft(), pair.getRight()).thenApply(ret -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //handle result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(ret)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret = Constants.DUBBO_RPC_RESULT_EMPTY;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.RPC_RESULT, ret);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ret;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        })).onErrorMap(exception -&gt; exception instanceof GenericException ? new ShenyuException(((GenericException) exception).getExceptionMessage()) : new ShenyuException(exception));//处理异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Generalized calls, asynchronous operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private CompletableFuture&lt;Object&gt; invokeAsync(final GenericService genericService, final String method, final String[] parameterTypes, final Object[] args) throws GenericException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        genericService.$invoke(method, parameterTypes, args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object resultFromFuture = RpcContext.getContext().getFuture();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFromFuture instanceof CompletableFuture ? (CompletableFuture&lt;Object&gt;) resultFromFuture : CompletableFuture.completedFuture(resultFromFuture);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Calling the <code>dubbo</code> service at the gateway can be achieved by generalizing the call.</p><p>The <code>ReferenceConfig</code> object is the key object to support generalization calls , and its initialization operation is done during data synchronization. There are two parts of data involved here, one is the synchronized plugin <code>handler</code> information and the other is the synchronized plugin metadata information.</p><ul><li>org.apache.shenyu.plugin.dubbo.common.handler.AbstractDubboPluginDataHandler#handlerPlugin()</li></ul><p>When the plugin data is updated, the data synchronization module synchronizes the data from <code>shenyu-admin</code> to the gateway. The initialization operation is performed in <code>handlerPlugin()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDubboPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Initializing the configuration cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   protected abstract void initConfigCache(DubboRegisterConfig dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerPlugin(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(pluginData) &amp;&amp; Boolean.TRUE.equals(pluginData.getEnabled())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Data deserialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig dubboRegisterConfig = GsonUtils.getInstance().fromJson(pluginData.getConfig(), DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboRegisterConfig exist = Singleton.INST.get(DubboRegisterConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || !dubboRegisterConfig.equals(exist)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Perform initialization operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.initConfigCache(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Singleton.INST.single(DubboRegisterConfig.class, dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.handler.ApacheDubboPluginDataHandler#initConfigCache()</li></ul><p>Perform initialization operations.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboPluginDataHandler extends AbstractDubboPluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void initConfigCache(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //perform initialization operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().init(dubboRegisterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //cached results before failure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApacheDubboConfigCache.getInstance().invalidateAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#init()</li></ul><p>In the initialization, set <code>registryConfig</code> and <code>consumerConfig</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ApplicationConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(applicationConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            applicationConfig = new ApplicationConfig(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //When the protocol or address changes, you need to update the registryConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (needUpdateRegistryConfig(dubboRegisterConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            RegistryConfig registryConfigTemp = new RegistryConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setProtocol(dubboRegisterConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setId(&quot;shenyu_proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setRegister(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfigTemp.setAddress(dubboRegisterConfig.getRegister());            Optional.ofNullable(dubboRegisterConfig.getGroup()).ifPresent(registryConfigTemp::setGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryConfig = registryConfigTemp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(consumerConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            consumerConfig = ApplicationModel.getConfigManager().getDefaultConsumer().orElseGet(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConsumerConfig consumerConfig = new ConsumerConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                consumerConfig.refresh();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return consumerConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ConsumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getThreadpool()).ifPresent(consumerConfig::setThreadpool); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getCorethreads()).ifPresent(consumerConfig::setCorethreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getThreads()).ifPresent(consumerConfig::setThreads);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(dubboRegisterConfig.getQueues()).ifPresent(consumerConfig::setQueues);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Does the registration configuration need to be updated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean needUpdateRegistryConfig(final DubboRegisterConfig dubboRegisterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getRegister(), registryConfig.getAddress())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                || !Objects.equals(dubboRegisterConfig.getProtocol(), registryConfig.getProtocol());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.subscriber.ApacheDubboMetaDataSubscriber#onSubscribe()</li></ul><p>When the metadata is updated, the data synchronization module synchronizes the data from <code>shenyu-admin</code> to the gateway. The metadata update operation is performed in the <code>onSubscribe()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApacheDubboMetaDataSubscriber implements MetaDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //local memory cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, MetaData&gt; META_DATA = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //update metaData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Whether the corresponding metadata exists</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaData exist = META_DATA.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(exist) || Objects.isNull(ApacheDubboConfigCache.getInstance().get(metaData.getPath()))) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // initRef</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ApacheDubboConfigCache.getInstance().initRef(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The corresponding metadata has undergone an update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!Objects.equals(metaData.getServiceName(), exist.getServiceName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getRpcExt(), exist.getRpcExt())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getParameterTypes(), exist.getParameterTypes())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        || !Objects.equals(metaData.getMethodName(), exist.getMethodName())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //Build ReferenceConfig again based on the latest metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApacheDubboConfigCache.getInstance().build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //local memory cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.put(metaData.getPath(), metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //dalete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void unSubscribe(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //使ReferenceConfig失效</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApacheDubboConfigCache.getInstance().invalidate(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            META_DATA.remove(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>org.apache.shenyu.plugin.apache.dubbo.cache.ApacheDubboConfigCache#initRef()</li></ul><p>Build <code>ReferenceConfig</code> objects from <code>metaData</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ApacheDubboConfigCache extends DubboConfigCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ReferenceConfig&lt;GenericService&gt; initRef(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //First try to get it from the cache, and return it directly if it exists</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ReferenceConfig&lt;GenericService&gt; referenceConfig = cache.get(metaData.getPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(referenceConfig.getInterface())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return referenceConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init dubbo ref exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //build if not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return build(metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Build reference config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @SuppressWarnings(&quot;deprecation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ReferenceConfig&lt;GenericService&gt; build(final MetaData metaData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(applicationConfig) || Objects.isNull(registryConfig)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ReferenceConfig&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ReferenceConfig&lt;GenericService&gt; reference = new ReferenceConfig&lt;&gt;(); //ReferenceConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setGeneric(&quot;true&quot;); //generic invoke</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setAsync(true);//async</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setApplication(applicationConfig);//applicationConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setRegistry(registryConfig);//registryConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setConsumer(consumerConfig);//consumerConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setInterface(metaData.getServiceName());//serviceName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setProtocol(&quot;dubbo&quot;);//dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setCheck(false); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setLoadbalance(&quot;gray&quot;);//gray</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;(2);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            parameters.put(&quot;dispatcher&quot;, &quot;direct&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reference.setParameters(parameters);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String rpcExt = metaData.getRpcExt();//rpc ext param</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DubboParam dubboParam = parserToDubboParam(rpcExt);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(dubboParam)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getVersion())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setVersion(dubboParam.getVersion());//version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getGroup())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setGroup(dubboParam.getGroup());//group</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getUrl())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setUrl(dubboParam.getUrl());//url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNoneBlank(dubboParam.getCluster())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reference.setCluster(dubboParam.getCluster());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getTimeout()).ifPresent(reference::setTimeout);//timeout</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getRetries()).ifPresent(reference::setRetries);//retires</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional.ofNullable(dubboParam.getSent()).ifPresent(reference::setSent);//Whether to ack async-sent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //get GenericService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object obj = reference.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Objects.nonNull(obj)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.info(&quot;init apache dubbo reference success there meteData is :{}&quot;, metaData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //cache reference</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    cache.put(metaData.getPath(), reference);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;init apache dubbo reference exception&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return reference;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="26-execute-responseplugin"></a>2.6 Execute ResponsePlugin<a class="hash-link" href="#26-execute-responseplugin" title="Direct link to heading">#</a></h4><ul><li>org.apache.shenyu.plugin.response.ResponsePlugin#execute()</li></ul><p>The response results are handled by the <code>ResponsePlugin</code> plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; execute(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuContext shenyuContext = exchange.getAttribute(Constants.CONTEXT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert shenyuContext != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handle results according to rpc type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return writerMap.get(shenyuContext.getRpcType()).writeWith(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The processing type is determined by <code>MessageWriter</code> and the class inheritance relationship is as follows.</p><p><img src="/assets/images/MessageWriter-81d10e88b3d5524b1eb2737c238956a6.png"></p><ul><li>MessageWriter: interface, defining message processing methods.</li><li>NettyClientMessageWriter: processing of <code>Netty</code> call results.</li><li>RPCMessageWriter: processing the results of <code>RPC</code> calls.</li><li>WebClientMessageWriter: processing the results of <code>WebClient</code> calls.</li></ul><p><code>Dubbo</code> service call, the processing result is <code>RPCMessageWriter</code> of course.</p><ul><li>org.apache.shenyu.plugin.response.strategy.RPCMessageWriter#writeWith()</li></ul><p>Process the response results in the <code>writeWith()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RPCMessageWriter implements MessageWriter {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Void&gt; writeWith(final ServerWebExchange exchange, final ShenyuPluginChain chain) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return chain.execute(exchange).then(Mono.defer(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object result = exchange.getAttribute(Constants.RPC_RESULT); //result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(result)) { </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(exchange, ShenyuResultEnum.SERVICE_RESULT_ERROR, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return WebFluxResultUtils.result(exchange, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point in the analysis, the source code analysis of the <code>Dubbo</code> plugin is complete, and the analysis flow chart is as follows.</p><p><img src="/assets/images/dubbo-execute-en-230f6fe5b81c0ab5d10ed68025c16020.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-summary"></a>3. Summary<a class="hash-link" href="#3-summary" title="Direct link to heading">#</a></h3><p>The source code analysis in this article starts from <code>Dubbo</code> service registration to <code>Dubbo</code> plug-in service calls. The <code>Dubbo</code> plugin is mainly used to handle the conversion of <code>http</code> requests to the <code>dubbo</code> protocol, and the main logic is implemented through generalized calls.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/blog/tags/dubbo">dubbo</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Code Analysis For Dubbo Plugin" href="/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/RegisterCenter-SourceCode-Analysis-Http-Register">Register Center Source Code Analysis of Http Register</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.308Z">September 28, 2024</time> · 29 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, the registration center is used to register the client information to <code>shenyu-admin</code>, <code>admin</code> then synchronizes this information to the gateway through data synchronization, and the gateway completes traffic filtering through these data. The client information mainly includes <code>interface information</code> and <code>URI information</code>.</p><blockquote><p>This article is based on <code>shenyu-2.5.0</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/docs/design/register-center-design" target="_blank" rel="noopener noreferrer">Client Access Principles</a> for the introduction of the official website.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-registration-center-principle"></a>1. Registration Center Principle<a class="hash-link" href="#1-registration-center-principle" title="Direct link to heading">#</a></h3><p>When the client starts, it reads the interface information and <code>uri information</code>, and sends the data to <code>shenyu-admin</code> by the specified registration type.</p><p><img src="/assets/images/register-center-en-d38e8150e48eec9bef3727dbadc124ec.png"></p><p>The registration center in the figure requires the user to specify which registration type to use. <code>ShenYu</code> currently supports <code>Http</code>, <code>Zookeeper</code>, <code>Etcd</code>, <code>Consul</code> and <code>Nacos</code> for registration. Please refer to <a href="https://shenyu.apache.org/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">Client Access Configuration</a> for details on how to configure them.</p><p><code>ShenYu</code> introduces <code>Disruptor</code> in the principle design of the registration center, in which the <code>Disruptor</code> queue plays a role in decoupling data and operations, which is conducive to expansion. If too many registration requests lead to registration exceptions, it also has a data buffering role.</p><p><img src="/assets/images/shenyu-register-center-en-732853d1dc114c56034d14f70e92be06.png"></p><p>As shown in the figure, the registration center is divided into two parts, one is the registration center client <code>register-client</code>, the load processing client data reading. The other is the registration center server <code>register-server</code>, which is loaded to handle the server side (that is <code>shenyu-admin</code>) data writing. Data is sent and received by specifying the registration type.</p><ul><li>Client: Usually it is a microservice, which can be <code>springmvc</code>, <code>spring-cloud</code>, <code>dubbo</code>, <code>grpc</code>, etc.</li><li><code>register-client</code>: register the central client, read the client interface and <code>uri</code> information.</li><li><code>Disruptor</code>: decoupling data from operations, data buffering role.</li><li><code>register-server</code>: registry server, here is <code>shenyu-admin</code>, receive data, write to database, send data synchronization events.</li><li>registration-type: specify the registration type, complete data registration, currently supports <code>Http</code>, <code>Zookeeper</code>, <code>Etcd</code>, <code>Consul</code> and <code>Nacos</code>.</li></ul><p>This article analyzes the use of <code>Http</code> for registration, so the specific processing flow is as follows.</p><p><img src="/assets/images/shenyu-register-center-http-en-2bf3e3a1e2c72d3fca6059fae46886f8.png"></p><p>On the client side, after the data is out of the queue, the data is transferred via <code>http</code> and on the server side, the corresponding interface is provided to receive the data and then write it to the queue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-client-registration-process"></a>2. Client Registration Process<a class="hash-link" href="#2-client-registration-process" title="Direct link to heading">#</a></h3><p>When the client starts, it reads the attribute information according to the relevant configuration, and then writes it to the queue. Let&#x27;s take the official <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> as an example and start the source code analysis . The official example is a microservice built by <code>springboot</code>. For the configuration of the registration center, please refer to the official website <a href="https://shenyu.apache.org/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">client access configuration</a> .</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-load-configuration-read-properties"></a>2.1 Load configuration, read properties<a class="hash-link" href="#21-load-configuration-read-properties" title="Direct link to heading">#</a></h4><p>Let&#x27;s start with a diagram that ties together the initialization process of the registry client.</p><p><img src="/assets/images/client-register-init-en-782b6467880bcb85cee72f2beba708c5.png"></p><p>We are analyzing registration by means of <code>http</code>, so the following configuration is required.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Each attribute indicates the following meaning.</p><ul><li><code>registerType</code>: the service registration type, fill in <code>http</code>.</li><li><code>serverList</code>: The address of the <code>Shenyu-Admin</code> project to fill in for the <code>http</code> registration type, note the addition of <code>http://</code> and separate multiple addresses with English commas.</li><li><code>username</code>: The username of the <code>Shenyu-Admin</code></li><li><code>password</code>: The password of the <code>Shenyu-Admin</code></li><li><code>port</code>: the start port of your project, currently <code>springmvc/tars/grpc</code> needs to be filled in.</li><li><code>contextPath</code>: the routing prefix for your <code>mvc</code> project in <code>shenyu</code> gateway, such as <code>/order</code>, <code>/product</code>, etc. The gateway will route according to your prefix.</li><li><code>appName</code>: the name of your application, if not configured, it will take the value of <code>spring.application.name</code> by default.</li><li><code>isFull</code>: set <code>true</code> to proxy your entire service, <code>false</code> to proxy one of your <code>controllers</code>; currently applies to <code>springmvc/springcloud</code>.</li></ul><p>After the project starts, it will first load the configuration file, read the property information and generate the corresponding <code>Bean</code>.</p><p>The first configuration file read is <code>ShenyuSpringMvcClientConfiguration</code>, which is the <code>http</code> registration configuration class for the <code>shenyu</code> client, indicated by <code>@Configuration</code> which is a configuration class, and by <code>@ImportAutoConfiguration</code> which is a configuration class. to introduce other configuration classes. Create <code>SpringMvcClientEventListener</code>, which mainly handles metadata and <code>URI</code> information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Shenyu SpringMvc Client Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create SpringMvcClientEventListener to handle metadata and URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuClientCommonBeanConfiguration</code> is a <code>shenyu</code> client common configuration class that will create the <code>bean</code> common to the registry client.</p><ul><li>Create <code>ShenyuClientRegisterRepository</code>, which is created by factory class.</li><li>Create <code>ShenyuRegisterCenterConfig</code>, which reads the <code>shenyu.register</code> property configuration.</li><li>Create <code>ShenyuClientConfig</code>, read the <code>shenyu.client</code> property configuration.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Shenyu Client Common Bean Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientCommonBeanConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // create ShenyuClientRegisterRepository by factory </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientRegisterRepository shenyuClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuClientRegisterRepositoryFactory.newInstance(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create ShenyuRegisterCenterConfig to read shenyu.register properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // create ShenyuClientConfig to read shenyu.client properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientConfig shenyuClientConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuClientConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-httpclientregisterrepository"></a>2.2 HttpClientRegisterRepository<a class="hash-link" href="#22-httpclientregisterrepository" title="Direct link to heading">#</a></h4><p>The <code>ShenyuClientRegisterRepository</code> generated in the configuration file above is a concrete implementation of the client registration, which is an interface with the following implementation class.</p><p><img src="/assets/images/shenyu-client-register-repository-dba8edf50af1be31d8b53c9573b1e015.png"></p><ul><li><code>HttpClientRegisterRepository</code>: registration via <code>http</code>.</li><li><code>ConsulClientRegisterRepository</code>: registration via <code>Consul</code>.</li><li><code>EtcdClientRegisterRepository</code>: registration via <code>Etcd</code>; <code>EtcdClientRegisterRepository</code>: registration via <code>Etcd</code>.</li><li><code>NacosClientRegisterRepository</code>: registration via <code>nacos</code>; <code>NacosClientRegisterRepository</code>: registration via <code>nacos</code>.</li><li><code>ZookeeperClientRegisterRepository</code>: registration through <code>Zookeeper</code>.</li></ul><p>The specific way which is achieved by loading through <code>SPI</code>, the implementation logic is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * load ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Loading by means of SPI, type determined by registerType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //init ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The load type is specified by <code>registerType</code>, which is the type we specify in the configuration file at</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We specified <code>http</code>, so it will go to load <code>HttpClientRegisterRepository</code>. After the object is successfully created, the initialization method <code>init()</code> is executed as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository implements ShenyuClientRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Read <code>username</code>, <code>password</code> and <code>serverLists</code> from the configuration file, the username, password and address of <code>sheenyu-admin</code>, in preparation for subsequent data sending. The class annotation <code>@Join</code> is used for <code>SPI</code> loading.</p><blockquote><p><code>SPI</code>, known as <code>Service Provider Interface</code>, is a service provider discovery feature built into the <code>JDK</code>, a mechanism for dynamic replacement discovery.</p><p><a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-spi" target="_blank" rel="noopener noreferrer">shenyu-spi</a> is a custom <code>SPI</code> extension implementation for the <code>Apache ShenYu</code> gateway, designed and implemented with reference to Dubbo <a href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/" target="_blank" rel="noopener noreferrer">SPI extension implementation</a>.</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-springmvcclienteventlistener"></a>2.3 SpringMvcClientEventListener<a class="hash-link" href="#23-springmvcclienteventlistener" title="Direct link to heading">#</a></h4><p>Create <code>SpringMvcClientEventListener</code>, which is responsible for the construction and registration of client-side metadata and <code>URI</code> data, and its creation is done in the configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create SpringMvcClientEventListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>SpringMvcClientEventListener</code> implements the <code>AbstractContextRefreshedEventListener</code></p><p><img src="/assets/images/shenyu-client-event-listener-0cd56409c59f2546a285a6426f9c8fee.png"></p><p>The <code>AbstractContextRefreshedEventListener</code> is an abstract class. it implements the <code>ApplicationListener</code> interface and overrides the <code>onApplicationEvent()</code> method, which is executed when a Spring event occurs. It has several implementation classes, which support different kind of <code>RPC</code> styles.</p><ul><li><code>AlibabaDubboServiceBeanListener</code>：handles <code>Alibaba Dubbo</code> protocol.</li><li><code>ApacheDubboServiceBeanListener</code>：handles <code>Apache Dubbo</code> protocol.</li><li><code>GrpcClientEventListener</code>：handles <code>grpc</code> protocol.</li><li><code>MotanServiceEventListener</code>：handles <code>Motan</code> protocol.</li><li><code>SofaServiceEventListener</code>：handles <code>Sofa</code> protocol.</li><li><code>SpringMvcClientEventListener</code>：handles <code>http</code> protocol.</li><li><code>SpringWebSocketClientEventListener</code>：handles <code>Websocket</code> protocol.</li><li><code>TarsServiceBeanEventListener</code>：handles <code>Tars</code> protocol.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractContextRefreshedEventListener&lt;T, A extends Annotation&gt; implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Instantiation is done through the constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractContextRefreshedEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read shenyu.client.http properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // appName </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = Optional.ofNullable(props.getProperty(ShenyuClientConstants.CONTEXT_PATH)).map(UriUtils::repairData).orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;client register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.ipAndPort = props.getProperty(ShenyuClientConstants.IP_PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // This method is executed when a context refresh event(ContextRefreshedEvent), occurs</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The contents of the method are guaranteed to be executed only once</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ApplicationContext context = event.getApplicationContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the specific beans </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, T&gt; beans = getBeans(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (MapUtils.isEmpty(beans)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build URI data and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildURIRegisterDTO(context, beans));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build metadata and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        beans.forEach(this::handle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;all&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract URIRegisterDTO buildURIRegisterDTO(ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                          Map&lt;String, T&gt; beans);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handle(final String beanName, final T bean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = getCorrectedClass(bean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final A beanShenyuClient = AnnotatedElementUtils.findMergedAnnotation(clazz, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(clazz, beanShenyuClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleClass(clazz, bean, beanShenyuClient, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleMethod(bean, clazz, beanShenyuClient, method, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // default implementation. build URI data and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleClass(final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               @NonNull final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildMetaDataDTO(bean, beanShenyuClient, pathJoin(contextPath, superPath), clazz, null));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // default implementation. build metadata and register it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        A methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 构建元数据，发送注册事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract MetaDataRegisterDTO buildMetaDataDTO(T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            @NonNull A shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            String path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Method method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the constructor, the main purpose is to read the property information and then perform the checksum.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, publisher.start() is executed to start event publishing and prepare for registration.</p><p>ShenyuClientRegisterEventPublisher is implemented via singleton pattern, mainly generating metadata and URI subscribers (subsequently used for data publishing), and then starting the Disruptor queue. A common method publishEvent() is provided to publish events and send data to the Disruptor queue.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientRegisterEventPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuClientRegisterEventPublisher INSTANCE = new ShenyuClientRegisterEventPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;DataTypeParent&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterEventPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientExecutorFactory factory = new RegisterClientExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientMetadataExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientURIExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publishEvent(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;DataTypeParent&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of the constructor of <code>AbstractContextRefreshedEventListener</code> is analyzed, it mainly reads the property configuration, creates metadata and URI subscribers, and starts the Disruptor queue.</p><p>The <code>onApplicationEvent()</code> method is executed when a <code>Spring</code> event occurs, the parameter here is <code>ContextRefreshedEvent</code>, which means the context refresh event. </p><blockquote><p><code>ContextRefreshedEvent</code> is a <code>Spring</code> built-in event. It is fired when the <code>ApplicationContext</code> is initialized or refreshed. This can also happen in the <code>ConfigurableApplicationContext</code> interface using the <code>refresh()</code> method. Initialization here means that all <code>Bean</code>s have been successfully loaded, post-processing <code>Bean</code>s have been detected and activated, all <code>Singleton Bean</code>s have been pre-instantiated, and the <code>ApplicationContext</code> container is ready to be used.</p></blockquote><ul><li><code>SpringMvcClientEventListener</code>: the <code>http</code> implementation of <code>AbstractContextRefreshedEventListener</code>:</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientEventListener extends AbstractContextRefreshedEventListener&lt;Object, ShenyuSpringMvcClient&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;Class&lt;? extends Annotation&gt;&gt; mappingAnnotation = new ArrayList&lt;&gt;(3);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Boolean isFull;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构造函数</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(clientConfig, shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get isFull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // http protocol</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Map&lt;String, Object&gt; getBeans(final ApplicationContext context) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configuration attribute, if isFull=true, means register the whole microservice</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .contextPath(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .appName(getAppName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .path(PathUtils.decoratorPathWithSlash(getContextPath()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ruleName(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get bean with Controller annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context.getBeansWithAnnotation(Controller.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected URIRegisterDTO buildURIRegisterDTO(final ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final Map&lt;String, Object&gt; beans) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String buildApiSuperPath(final Class&lt;?&gt; clazz, @Nullable final ShenyuSpringMvcClient beanShenyuClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; StringUtils.isNotBlank(beanShenyuClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return beanShenyuClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(clazz, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Only the first path is supported temporarily</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Class&lt;ShenyuSpringMvcClient&gt; getAnnotationType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuSpringMvcClient.class;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final Object bean, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final ShenyuSpringMvcClient beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method, final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get RequestMapping annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get ShenyuSpringMvcClient annotation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // the result of ReflectionUtils#getUniqueDeclaredMethods contains method such as hashCode, wait, toSting</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add Objects.nonNull(requestMapping) to make sure not register wrong method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient) &amp;&amp; Objects.nonNull(requestMapping)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构造元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected MetaDataRegisterDTO buildMetaDataDTO(final Object bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   @NonNull final ShenyuSpringMvcClient shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final String path, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The registration logic is done through <code>publisher.publishEvent()</code>. </p><p>The <code>Controller</code> annotation and the <code>RequestMapping</code> annotation are provided by <code>Spring</code>, which you should be familiar with, so I won&#x27;t go into details. The <code>ShenyuSpringMvcClient</code> annotation is provided by <code>Apache ShenYu</code> to register the <code>SpringMvc</code> client, which is defined as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;path&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;value&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ruleName</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // desc info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register MetaData </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean  registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It is used as follows.</p><ul><li>register the entire interface</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/test/**&quot;)  // register the entire interface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpTestController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>register current method</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Save order dto.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param orderDTO the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/save&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/save&quot;, desc = &quot;Save order&quot;) // register current method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO save(@RequestBody final OrderDTO orderDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDTO.setName(&quot;hello world save order&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>publisher.publishEvent()</li></ul><p>This method sends the data to the <code>Disruptor</code> queue. More details about the <code>Disruptor</code> queue are not described here, which does not affect the flow of analyzing the registration.</p><p>When the data is sent, the consumers of the <code>Disruptor</code> queue will process the data for consumption.</p><p>This method sends the data to the <code>Disruptor</code> queue. More details about the <code>Disruptor</code> queue are not described here, which does not affect the flow of analyzing the registration.</p><ul><li>QueueConsumer</li></ul><p><code>QueueConsumer</code> is a consumer that implements the <code>WorkHandler</code> interface, which is created in the <code>providerManage.startup()</code> logic. The <code>WorkHandler</code> interface is the data consumption interface for <code>Disruptor</code>, and the only method is <code>onEvent()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>QueueConsumer</code> overrides the <code>onEvent()</code> method, and the main logic is to generate the consumption task and then go to the thread pool to execute it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * QueueConsumer</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use different thread pools based on DataEvent type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create queue consumption tasks via factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // put in the thread pool to execute the consumption task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code> is the task that is executed in the thread pool, it implements the <code>Runnable</code> interface, and there are two specific implementation classes.</p><ul><li><code>RegisterClientConsumerExecutor</code>：the client-side consumer executor.</li><li><code>RegisterServerConsumerExecutor</code>：server-side consumer executor.</li></ul><p>As the name implies, one is responsible for handling client-side tasks, and one is responsible for handling server-side tasks (the server side is <code>admin</code>, which is analyzed below).</p><p><img src="/assets/images/consumer-executor-f7ad67d35abaa5a2fac94ef913445a19.png"></p><ul><li>RegisterClientConsumerExecutor</li></ul><p>The logic of the rewritten <code>run()</code> is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterClientConsumerExecutor&lt;T extends DataTypeParent&gt; extends QueueConsumerExecutor&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final T data = getData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // call the appropriate processor for processing according to the data type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribers.get(data.getType()).executor(Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Different processors are called to perform the corresponding tasks based on different data types. There are two types of data, one is metadata, which records the client registration information. One is the <code>URI</code> data, which records the client service information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum DataType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    URI,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>The actuator subscribers are divided into two categories, one that handles metadata and one that handles <code>URIs</code>. There are two on the client side and two on the server side, so there are four in total.</p><p><img src="/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><p>Here is the registration metadata information, so the execution class is <code>ShenyuClientMetadataExecutorSubscriber</code>.</p><ul><li>ShenyuClientMetadataExecutorSubscriber#executor()</li></ul><p>The metadata processing logic on the client side is: iterate through the metadata information and call the interface method <code>persistInterface()</code> to finish publishing the data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientMetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (MetaDataRegisterDTO metaDataRegisterDTO : metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // call the interface method persistInterface() to finish publishing the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistInterface(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The two registration interfaces get the data well and call the <code>publish()</code> method to publish the data to the <code>Disruptor</code> queue.</p><ul><li><code>ShenyuServerRegisterRepository</code></li></ul><p>The <code>ShenyuServerRegisterRepository</code> interface is a service registration interface, which has five implementation classes, indicating five types of registration.</p><ul><li><code>ConsulServerRegisterRepository</code>: registration is achieved through <code>Consul</code>;</li><li><code>EtcdServerRegisterRepository</code>: registration through <code>Etcd</code>.</li><li><code>NacosServerRegisterRepository</code>: registration through <code>Nacos</code>.</li><li><code>ShenyuHttpRegistryController</code>: registration via <code>Http</code>; <code>ShenyuHttpRegistryController</code>: registration via <code>Http</code>.</li><li><code>ZookeeperServerRegisterRepository</code>: registration through <code>Zookeeper</code>.</li></ul><p><img src="/assets/images/client-register-repository-61756e3284c1d3a27083b25d393edf9c.png"></p><p>As you can see from the diagram, the loading of the registry is done by means of SPI. This was mentioned earlier, and the specific class loading is done in the client-side generic configuration file by specifying the properties in the configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * load ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // loading by means of SPI, type determined by registerType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // perform initialization operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The source code analysis in this article is based on the Http way of registration, so we first analyze the HttpClientRegisterRepository, and the other registration methods will be analyzed afterwards.</p><p>Registration by way of <code>http</code> is very simple, it is to call the tool class to send http requests. The registration metadata and URI are both called by the same method <code>doRegister()</code>, specifying the interface and type.</p><ul><li><code>Constants.URI_PATH</code> = <code>/shenyu-client/register-metadata</code>: the interface provided by the server for registering metadata.</li><li><code>Constants.META_PATH</code> = <code>/shenyu-client/register-uri</code>: Server-side interface for registering URIs.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository extends FailbackRegistryRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientRegisterRepository.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static URIRegisterDTO uriRegisterDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;String&gt; serverList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        init(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin paaword</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin server address</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set access token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Persist uri.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param registerDTO the register dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistURI(final URIRegisterDTO registerDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RuntimeUtils.listenByOther(registerDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(registerDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uriRegisterDTO = registerDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistInterface(final MetaDataRegisterDTO metadata) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(metadata, Constants.META_PATH, Constants.META_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uriRegisterDTO != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            uriRegisterDTO.setEventType(EventType.DELETED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRegister(uriRegisterDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setAccessToken() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional&lt;?&gt; login = RegisterUtils.doLogin(username, password, server.concat(Constants.LOGIN_PATH));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                login.ifPresent(v -&gt; this.accessToken = String.valueOf(v));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Login admin url :{} is fail, will retry. cause: {} &quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void doRegister(final T t, final String path, final String type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // iterate through the list of admin services (admin may be clustered)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            i++;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String concat = server.concat(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 设置访问token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new NullPointerException(&quot;accessToken is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // calling the tool class to send http requests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RegisterUtils.doRegister(GsonUtils.getInstance().toJson(t), concat, type, accessToken);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Register admin url :{} is fail, will retry. cause:{}&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (i == serverList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Serialize the data and send it via OkHttp.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Sending data via OkHttp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void doRegister(final String json, final String url, final String type) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasLength(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error accessToken is null, please check the config : {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Headers headers = new Headers.Builder().add(Constants.X_ACCESS_TOKEN, accessToken).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result = OkHttpTools.getInstance().post(url, json, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.equals(SUCCESS, result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;{} client register success: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, the logic of the client registering metadata by means of <code>http</code> is finished. To summarize: construct metadata by reading custom annotation information, send the data to the <code>Disruptor</code> queue, then consume the data from the queue, put the consumer into the thread pool to execute, and finally send an <code>http</code> request to the <code>admin</code>.</p><p>Similarly, <code>ShenyuClientURIExecutorSubscriber</code> is the execution class of registering <code>URI</code> information.</p><ul><li>ShenyuClientURIExecutorSubscriber#executor()</li></ul><p>The main logic is to iterate through the URI data collection and implement data registration through the persistURI() method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientURIExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (URIRegisterDTO uriRegisterDTO : dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Stopwatch stopwatch = Stopwatch.createStarted();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (Socket ignored = new Socket(uriRegisterDTO.getHost(), uriRegisterDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long sleepTime = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // maybe the port is delay exposed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 5) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;host:{}, port:{} connection failed, will retry&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                uriRegisterDTO.getHost(), uriRegisterDTO.getPort());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If the connection fails for a long time, Increase sleep time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 180) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sleepTime = 10000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TimeUnit.MILLISECONDS.sleep(sleepTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ex.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.delayOtherHooks();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistURI(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>while(true)</code> loop in the code is to ensure that the client has been successfully started and can connect via <code>host</code> and <code>port</code>.</p><p>The logic behind it is: add the <code>hook</code> function for gracefully stopping the client .</p><p>Data registration is achieved through the <code>persistURI()</code> method. The whole logic is also analyzed in the previous section, and ultimately it is the <code>OkHttp</code> client that initiates <code>http</code> to <code>shenyu-admin</code> and registers the <code>URI</code> by way of <code>http</code>.</p><p>The analysis of the registration logic of the client is finished here, and the metadata and URI data constructed are sent to the <code>Disruptor</code> queue, from which they are then consumed, read, and sent to <code>admin</code> via <code>http</code>.</p><p>The source code analysis of the client-side metadata and <code>URI</code> registration process is complete, with the following flow chart.</p><p><img src="/assets/images/client-metadata-uri-register-en-7ccc8df4fc77fdf28480f15a6de6022b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-server-side-registration-process"></a>3. Server-side registration process<a class="hash-link" href="#3-server-side-registration-process" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-shenyuhttpregistrycontroller"></a>3.1 ShenyuHttpRegistryController<a class="hash-link" href="#31-shenyuhttpregistrycontroller" title="Direct link to heading">#</a></h4><p>From the previous analysis, we know that the server side provides two interfaces for registration.</p><ul><li><code>/shenyu-client/register-metadata</code>: The interface provided by the server side is used to register metadata.</li><li><code>/shenyu-client/register-uri</code>: The server-side interface is provided for registering URIs.</li></ul><p>These two interfaces are located in <code>ShenyuHttpRegistryController</code>, which implements the <code>ShenyuServerRegisterRepository</code> interface and is the implementation class for server-side registration. It is marked with <code>@Join</code> to indicate loading via <code>SPI</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/shenyu-client&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuHttpRegistryController implements ShenyuServerRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuServerRegisterPublisher publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuServerRegisterPublisher publisher, final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.publisher = publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register Metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-metadata&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerMetadata(@RequestBody final MetaDataRegisterDTO metaDataRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // register URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-uri&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(@RequestBody final URIRegisterDTO uriRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The exact method used is specified by the configuration file and then loaded via <code>SPI</code>.</p><p>In the <code>application.yml</code> file in <code>shenyu-admin</code> configure the registration method, <code>registerType</code> specify the registration type, when registering with <code>http</code>, <code>serverLists</code> do not need to be filled in, for more configuration instructions you can refer to the official website <a href="https://shenyu.apache.org/zh/docs/user-guide/register-center-access" target="_blank" rel="noopener noreferrer">Client Access Configuration</a>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>RegisterCenterConfiguration </li></ul><p>After introducing the relevant dependencies and properties configuration, when starting <code>shenyu-admin</code>, the configuration file will be loaded first, and the configuration file class related to the registration center is <code>RegisterCenterConfiguration</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterCenterConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //create ShenyuServerRegisterRepository to register in admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuServerRegisterRepository shenyuServerRegisterRepository(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig, final List&lt;ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. get the registration type from the configuration property</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String registerType = shenyuRegisterCenterConfig.getRegisterType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. load the implementation class by registering the type with the SPI method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuServerRegisterRepository registerRepository = ExtensionLoader.getExtensionLoader(ShenyuServerRegisterRepository.class).getJoin(registerType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. get the publisher and write data to the Disruptor queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerDisruptorPublisher publisher = RegisterServerDisruptorPublisher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. ShenyuClientRegisterService, rpcType -&gt; registerService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuClientRegisterService&gt; registerServiceMap = shenyuClientRegisterService.stream().collect(Collectors.toMap(ShenyuClientRegisterService::rpcType, e -&gt; e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. start publisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(registerServiceMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6. init registerRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRepository.init(publisher, shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerRepository;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Two <code>bean</code>s are generated in the configuration class.</p><ul><li><p><code>shenyuRegisterCenterConfig</code>: to read the attribute configuration.</p></li><li><p><code>shenyuServerRegisterRepository</code>: for server-side registration.</p></li></ul><p>In the process of creating <code>shenyuServerRegisterRepository</code>, a series of preparations are also performed.</p><ul><li><ol><li>get the registration type from the configuration property.</li></ol></li><li><ol start="2"><li>Load the implementation class by the registration type with the <code>SPI</code> method: for example, if the specified type is <code>http</code>, <code>ShenyuHttpRegistryController</code> will be loaded.</li></ol></li><li><ol start="3"><li>Get <code>publisher</code> and write data to the <code>Disruptor</code> queue.</li></ol></li><li><ol start="4"><li>Register <code>Service</code>, <code>rpcType -&gt; registerService</code>: get the registered <code>Service</code>, each <code>rpc</code> has a corresponding <code>Service</code>. The client for this article is built through <code>springboot</code>, which belongs to the <code>http</code> type, and other client types: <code>dubbo</code>, <code>Spring Cloud</code>, <code>gRPC</code>, etc.</li></ol></li><li><ol start="5"><li>Preparation for event publishing: add server-side metadata and <code>URI</code> subscribers, process the data. And start the <code>Disruptor</code> queue.</li></ol></li><li><ol start="6"><li>Initialization operation for registration: <code>http</code> type registration initialization operation is to save <code>publisher</code>.</li></ol></li></ul><ul><li>RegisterClientServerDisruptorPublisher#publish()</li></ul><p>The server-side publisher that writes data to the <code>Disruptor</code> queue , built via the singleton pattern.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterClientServerDisruptorPublisher implements ShenyuServerRegisterPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final RegisterClientServerDisruptorPublisher INSTANCE = new     private static final RegisterClientServerDisruptorPublisher INSTANCE = new RegisterServerDisruptorPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static RegisterClientServerDisruptorPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //prepare for event publishing, add server-side metadata and URI subscribers, process data. And start the Disruptor queue.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final Map&lt;String, ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerExecutorFactory factory = new RegisterServerExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add URI data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new URIRegisterExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // add Metadata subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new MetadataExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //start Disruptor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write data to queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publish(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Object&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(Collections.singleton(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write data to queue on batch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final Collection&lt;? extends DataTypeParent&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(dataList.stream().map(DataTypeParent.class::cast).collect(Collectors.toList()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.getProvider().shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The loading of the configuration file, which can be seen as the initialization process of the registry server, is described in the following diagram.</p><p><img src="/assets/images/server-register-init-en-c20ecd9991817e159730a8aea38db110.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-queueconsumer"></a>3.2 QueueConsumer<a class="hash-link" href="#32-queueconsumer" title="Direct link to heading">#</a></h4><p>In the previous analysis of the client-side <code>disruptor</code> queue consumption of data over. The server side has the same logic, except that the executor performing the task changes.</p><p>The <code>QueueConsumer</code> is a consumer that implements the <code>WorkHandler</code> interface, which is created in the <code>providerManage.startup()</code> logic. The <code>WorkHandler</code> interface is the data consumption interface for <code>disruptor</code>, and the only method is <code>onEvent()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T var1) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>QueueConsumer</code> overrides the <code>onEvent()</code> method, and the main logic is to generate the consumption task and then go to the thread pool to execute it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * QueueConsumer</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use different thread pools based on DataEvent type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create queue consumption tasks via factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // put in the thread pool to execute the consumption task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code> is the task that is executed in the thread pool, it implements the <code>Runnable</code> interface, and there are two specific implementation classes.</p><ul><li><code>RegisterClientConsumerExecutor</code>: the client-side consumer executor.</li><li><code>RegisterServerConsumerExecutor</code>: server-side consumer executor.</li></ul><p>As the name implies, one is responsible for handling client-side tasks and one is responsible for handling server-side tasks.</p><ul><li><code>RegisterServerConsumerExecutor#run()</code></li></ul><p><code>RegisterServerConsumerExecutor</code> is a server-side consumer executor that indirectly implements the <code>Runnable</code> interface via <code>QueueConsumerExecutor</code> and overrides the <code>run()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterServerConsumerExecutor extends QueueConsumerExecutor&lt;List&lt;DataTypeParent&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //get the data from the disruptor queue and check data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;DataTypeParent&gt; results = getData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(this::isValidData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //execute operations according to type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getType(results).executor(results);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get subscribers by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ExecutorSubscriber&lt;DataTypeParent&gt; selectExecutor(final Collection&lt;DataTypeParent&gt; list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Optional&lt;DataTypeParent&gt; first = list.stream().findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return subscribers.get(first.orElseThrow(() -&gt; new RuntimeException(&quot;the data type is not found&quot;)).getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>The actuator subscribers are divided into two categories, one that handles metadata and one that handles <code>URIs</code>. There are two on the client side and two on the server side, so there are four in total.</p><p><img src="/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><ul><li>MetadataExecutorSubscriber#executor()</li></ul><p>In case of registering metadata, this is achieved by <code>MetadataExecutorSubscriber#executor()</code>: get the registered <code>Service</code> according to the type and call <code>register()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class MetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Traversing the metadata list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataRegisterDTOList.forEach(meta -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(this.shenyuClientRegisterService.get(meta.getRpcType())) // Get registered Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(shenyuClientRegisterService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Registration of metadata, locking to ensure sequential execution and prevent concurrent errors</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            shenyuClientRegisterService.register(meta);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>URIRegisterExecutorSubscriber#executor()</li></ul><p>In case of registration metadata, this is achieved by <code>URIRegisterExecutorSubscriber#executor()</code>: construct <code>URI</code> data, find <code>Service</code> according to the registration type, and achieve registration by the <code>registerURI</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class URIRegisterExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        findService(dataList).ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; groupByRpcType = dataList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(data -&gt; StringUtils.isNotBlank(data.getRpcType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.groupingBy(URIRegisterDTO::getRpcType));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, List&lt;URIRegisterDTO&gt;&gt; entry : groupByRpcType.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String rpcType = entry.getKey();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Get registered Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(shenyuClientRegisterService.get(rpcType))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final List&lt;URIRegisterDTO&gt; list = entry.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Build URI data types and register them with the registerURI method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(list);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Find Service by type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Optional&lt;ShenyuClientRegisterService&gt; findService(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dataList.stream().map(dto -&gt; shenyuClientRegisterService.get(dto.getRpcType())).findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterService#register()</li></ul><p><code>ShenyuClientRegisterService</code> is the registration method interface, which has several implementation classes.</p><p><img src="/assets/images/client-register-service-949e3110cb57db2f250dafdc41446eb4.png"></p><ul><li><code>AbstractContextPathRegisterService</code>: abstract class, handling part of the public logic.</li><li><code>AbstractShenyuClientRegisterServiceImpl</code>: : abstract class, handles part of the public logic.</li><li><code>ShenyuClientRegisterDivideServiceImpl</code>: <code>divide</code> class, handles <code>http</code> registration types.</li><li><code>ShenyuClientRegisterDubboServiceImpl</code>: <code>dubbo</code> class, handles <code>dubbo</code> registration types.</li><li><code>ShenyuClientRegisterGrpcServiceImpl</code>: <code>gRPC</code> class, handles <code>gRPC</code> registration types.</li><li><code>ShenyuClientRegisterMotanServiceImpl</code>: <code>Motan</code> class, handles <code>Motan</code> registration types.</li><li><code>ShenyuClientRegisterSofaServiceImpl</code>: <code>Sofa</code> class, handles <code>Sofa</code> registration types.</li><li><code>ShenyuClientRegisterSpringCloudServiceImpl</code>: <code>SpringCloud</code> class, handles <code>SpringCloud</code> registration types.</li><li><code>ShenyuClientRegisterTarsServiceImpl</code>: <code>Tars</code> class, handles <code>Tars</code> registration types.</li><li><code>ShenyuClientRegisterWebSocketServiceImpl</code>： <code>Websocket</code> class，handles <code>Websocket</code> registration types.</li></ul><p>From the above, we can see that each microservice has a corresponding registration implementation class. The source code analysis in this article is based on the official <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> as an example, it is of <code>http</code> registration type, so the registration implementation class for metadata and URI data is <code>ShenyuClientRegisterDivideServiceImpl</code>: <code>ShenyuClientRegisterDivideServiceImpl</code>.</p><ul><li>register(): </li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.register selector information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.register rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.register metadata information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.register contextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The whole registration logic can be divided into 4 steps.</p><ul><li><ol><li>Register selector information</li></ol></li><li><ol start="2"><li>Register rule information</li></ol></li><li><ol start="3"><li>Register metadata information</li></ol></li><li><ol start="4"><li>Register `contextPath</li></ol></li></ul><p>This side of <code>admin</code> requires the construction of selectors, rules, metadata and <code>ContextPath</code> through the metadata information of the client. The specific registration process and details of processing are related to the <code>rpc</code> type. We will not continue to track down the logical analysis of the registration center, tracking to this point is enough.</p><p>The source code of the server-side metadata registration process is analyzed and the flow chart is described as follows.</p><p><img src="/assets/images/server-metadata-register-en-8290907a57a1189a4b5863f3c47254bb.png"></p><ul><li>registerURI()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Does the corresponding selector exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Handle handler information in the selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(uriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Update records in the database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish Event to gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After <code>admin</code> gets the <code>URI</code> data, it mainly updates the <code>handler</code> information in the selector, then writes it to the database, and finally publishes the event notification gateway. The logic of notifying the gateway is done by the data synchronization operation, which has been analyzed in the previous article, so we will not repeat it.</p><p>The source code analysis of the server-side <code>URI</code> registration process is complete and is described in the following diagram.</p><p><img src="/assets/images/server-uri-register-en-6026d791dbc404cadee04b237add0691.png"></p><p>At this point, the server-side registration process is also analyzed, mainly through the interface provided externally, accept the registration information from the client, and then write to the <code>Disruptor</code> queue, and then consume data from it, and update the <code>admin</code> selector, rules, metadata and selector <code>handler</code> according to the received metadata and <code>URI</code> data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-summary"></a>4. Summary<a class="hash-link" href="#4-summary" title="Direct link to heading">#</a></h3><p>This article focuses on the <code>http registration</code> module of the <code>Apache ShenYu</code> gateway for source code analysis. The main knowledge points involved are summarized as follows.</p><ul><li>The register center is for registering client information to <code>admin</code> to facilitate traffic filtering.</li><li><code>http</code> registration is to register client metadata information and <code>URI</code> information to <code>admin</code>.</li><li><code>http</code> service access is identified by the annotation <code>@ShenyuSpringMvcClient</code>.</li><li>construction of the registration information mainly through the application listener <code>ApplicationListener</code>.</li><li>loading of the registration type is done through <code>SPI</code>.</li><li>The <code>Disruptor</code> queue was introduced to decouple data from operations, and data buffering.</li><li>The implementation of the registry uses interface-oriented programming, using design patterns such as template methods, singleton, and observer.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/http">http</a><a class="margin-horiz--sm" href="/blog/tags/register-center">register center</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Register Center Source Code Analysis of Http Register" href="/blog/RegisterCenter-SourceCode-Analysis-Http-Register"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalancer SPI Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.308Z">September 28, 2024</time> · 14 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>Gateway applications need to support a variety of load balancing  strategies, including <code>random</code>,<code>Hashing</code>, <code>RoundRobin</code> and so on. In <code>Apache Shenyu</code> gateway, it not only realizes such traditional algorithms, but also makes smoother traffic processing for the entry of server nodes through detailed processing such as traffic <code>warm-up,</code> so as to obtain better overall stability. In this article, let&#x27;s walk through how <code>Apache Shenyu</code> is designed and implemented this part of the function.</p><blockquote><p>This article based on <code>shenyu-2.5.0</code> version of the source code analysis.</p></blockquote><p>[TOC]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalancer-spi"></a>LoadBalancer <code>SPI</code><a class="hash-link" href="#loadbalancer-spi" title="Direct link to heading">#</a></h2><p>The implementation of <code>LoadBalancer</code> is in <strong><em>shenyu-loadbalancer</em></strong> module. It has based on its <code>SPI</code> creation mechanism. The core interface code is shown as follows. This interface  well explains the concept: load balancing is to select the most appropriate node from a series of server nodes.  Routing, traffic processing and load balancing is the basic function of <code>LoadBalancer</code> <code>SPI</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface LoadBalancer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * this is select one for upstream list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream select(List&lt;Upstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Where <code>upstreamList</code> represents the server nodes list available for routing. <code>Upstream</code> is the data structure of server node, the  important elements including <code>protocol</code>, <code>upstreamUrl</code> , <code>weight</code>, <code>timestamp</code>, <code>warmup</code>、<code>healthy</code>.  </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class Upstream {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * protocol.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * weight.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * false close, true open.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean status;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * startup time.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final long timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * warmup.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int warmup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * healthy.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean healthy;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * lastHealthTimestamp.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastHealthTimestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * lastUnhealthyTimestamp.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUnhealthyTimestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * group.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String group;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * version.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String version;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-loadbalancer-module"></a>Design of LoadBalancer module<a class="hash-link" href="#design-of-loadbalancer-module" title="Direct link to heading">#</a></h2><p>The class diagram of <code>LoadBalancer</code> module<code>is</code>shown as follows.</p><p><img alt="loadbalancer-class-diagram" src="/assets/images/loadBalancer-class-diagram-7fa8d2dd07f1210da7d25fa787b69d5f.png"></p><p>We can draw the outline of <code>LoadBalancer</code> module from the class diagram:</p><ol><li><p>The abstract class <code>AbstractLoadBalancer</code> implements the SPI <code>LoadBalancer</code> interface，and supplies the template methods for selection related, such as select(), selector()，and gives the calculation of weight.</p></li><li><p>Three implementation classes which inherit <code>AbstractLoadBalancer</code> to realize their own logic:</p><ul><li><code>RandomLoadBalancer</code> - Weight Random</li><li><code>HashLoadBalancer</code>  - Consistent Hashing</li><li><code>RoundRobinLoadBalancer</code> -Weight Round Robin per-packet</li></ul></li><li><p>The factory class <code>LoadBalancerFactory</code> provides public static method to be called.</p><p>The implementation classes and algorithms are configurable.   According to its specification,   by adding profile in <code>SHENYU_DIERECTORY</code> directory, the data in profile should be  <em>key</em>=<em>value-class</em> format, where the <em>value-class</em> will be load by the <code>Apache Shenyu SPI</code> class loader, and <em>key</em> value should be an <code>name</code> defined in <code>LoadBalanceEnum.</code></p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">random=org.apache.shenyu.loadbalancer.spi.RandomLoadBalancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">roundRobin=org.apache.shenyu.loadbalancer.spi.RoundRobinLoadBalancer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hash=org.apache.shenyu.loadbalancer.spi.HashLoadBalancer</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>The code of LoadBalanceEnum</code> is as follows：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum LoadBalanceEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Hash load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HASH(1, &quot;hash&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Random load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RANDOM(2, &quot;random&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Round robin load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ROUND_ROBIN(3, &quot;roundRobin&quot;, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int code;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final boolean support;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractloadbalancer"></a>AbstractLoadBalancer<a class="hash-link" href="#abstractloadbalancer" title="Direct link to heading">#</a></h2><p>This abstract class implements the <code>LoadBalancer</code> interface and define the abstract method <code>doSelect()</code> to be processed by the implementation classes. In the template method <code>select()</code>,  It will do validation first then call the <code>doSelect()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractLoadBalancer implements LoadBalancer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do select divide upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Upstream doSelect(List&lt;Upstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream select(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (upstreamList.size() == 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doSelect(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the <code>timestamp</code> of server node  is not null, and the interval between current time and <code>timestamp</code> is within the traffic warm-up time, the formula for weight calculation is.
$$ {1-1}
ww = min(1,uptime/(warmup/weight))
$$
It can be seen from the formula that the final weight(<code>ww</code>) is proportional to the original-<code>weight</code> value. The closer the time interval is to the <code>warmup</code> time, the greater the final <code>ww</code>. That is, the longer the waiting time of the request, the higher the final <code>weight</code>. When there is no <code>timestamp</code> or other conditions, the <code>ww</code> is equal to the <code>weight</code> value of <code>Upstream</code> object.</p><p>The central of thinking about <em>warm-up</em>is to avoid  bad performance when adding new server and the new <code>JVMs</code> starting up.</p><p>Let&#x27;s see how the load balancing  with <code>Random</code>, <code>Hashing</code> and <code>RoundRobin</code> strategy is implemented.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="randomloadbalancer"></a>RandomLoadBalancer<a class="hash-link" href="#randomloadbalancer" title="Direct link to heading">#</a></h2><p>The <code>RandomLoadBalancer</code> can handle two situations:</p><ol><li>Each node without weight, or every node has the same weight, randomly choose one.</li><li>Server Nodes with different weight, choose one randomly by weight.</li></ol><p>Following is the <code>random()</code> method of <code>RandomLoadBalancer</code>. When traversing server node list, if the randomly generated value is less than the weight of node, then the current node will be chosen. If after one round traversing, there is no server node match, then it will choose one randomly. The <code>getWeight(final Upstream upstream)</code> is defined in <code>AbstractLoadBalancer</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int length = upstreamList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // every upstream has the same weight?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean sameWeight = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // the weight of every upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int[] weights = new int[length];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int firstUpstreamWeight = getWeight(upstreamList.get(0));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weights[0] = firstUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // init the totalWeight</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int totalWeight = firstUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int halfLengthTotalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 1; i &lt; length; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int currentUpstreamWeight = getWeight(upstreamList.get(i));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i &lt;= (length + 1) / 2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                halfLengthTotalWeight = totalWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weights[i] = currentUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            totalWeight += currentUpstreamWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (sameWeight &amp;&amp; currentUpstreamWeight != firstUpstreamWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Calculate whether the weight of ownership is the same.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                sameWeight = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (totalWeight &gt; 0 &amp;&amp; !sameWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return random(totalWeight, halfLengthTotalWeight, weights, upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return random(upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Upstream random(final int totalWeight, final int halfLengthTotalWeight, final int[] weights, final List&lt;Upstream&gt; upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the weights are not the same and the weights are greater than 0, then random by the total number of weights.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int offset = RANDOM.nextInt(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int index = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int end = weights.length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (offset &gt;= halfLengthTotalWeight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            index = (weights.length + 1) / 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset -= halfLengthTotalWeight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            end = (weights.length + 1) / 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine which segment the random value falls on</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (; index &lt; end; index++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset -= weights[index];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (offset &lt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return upstreamList.get(index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return random(upstreamList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="hashloadbalancer"></a>HashLoadBalancer<a class="hash-link" href="#hashloadbalancer" title="Direct link to heading">#</a></h2><p>In <code>HashLoadBalancer</code>, it takes the advantages of <a href="https://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener noreferrer">consistent hashing</a> , that maps both the input traffic and the servers to a unit circle, or name as  <em>hash ring</em>. For the requested<code>ip</code> address, with its hash value to find the node closest in clockwise order as the node to be routed.  Let&#x27;s see how consistent hashing is implemented in <code>HashLoadBalancer</code>.</p><p>As to the hash algorithms, <code>HashLoadBalancer</code> uses <code>MD5</code> hash, which has the advantage of mixing the input in an unpredictable but deterministic way. The output is a 32-bit integer.  the code is shown as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private static long hash(final String key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // md5 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MessageDigest md5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5 = MessageDigest.getInstance(&quot;MD5&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (NoSuchAlgorithmException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShenyuException(&quot;MD5 not supported&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] keyBytes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyBytes = key.getBytes(StandardCharsets.UTF_8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.update(keyBytes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] digest = md5.digest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // hash code, Truncate to 32-bits</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long hashCode = (long) (digest[3] &amp; 0xFF) &lt;&lt; 24</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[2] &amp; 0xFF) &lt;&lt; 16)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[1] &amp; 0xFF) &lt;&lt; 8)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | (digest[0] &amp; 0xFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return hashCode &amp; 0xffffffffL;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Importantly, how to generate the hash ring and avoid skewness?  Let&#x27;s the<code>doSelect()</code> method in<code>HashLoadBalancer</code> as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int VIRTUAL_NODE_NUM = 5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConcurrentSkipListMap&lt;Long, Upstream&gt; treeMap = new ConcurrentSkipListMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        upstreamList.forEach(upstream -&gt; IntStream.range(0, VIRTUAL_NODE_NUM).forEach(i -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long addressHash = hash(&quot;SHENYU-&quot; + upstream.getUrl() + &quot;-HASH-&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            treeMap.put(addressHash, upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hash = hash(ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SortedMap&lt;Long, Upstream&gt; lastRing = treeMap.tailMap(hash);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!lastRing.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return lastRing.get(lastRing.firstKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return treeMap.firstEntry().getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this method, duplicated labels are used which are called &quot;virtual nodes&quot; (i.e.  5 virtual nodes point to a single &quot;real&quot; server).  It will make the distribution in hash ring more evenly, and reduce the occurrence of data skewness.</p><p>In order to rescue the data sorted in the hash ring, and can be accessed quickly, we use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html" target="_blank" rel="noopener noreferrer">ConcurrentSkipListMap</a> of Java to store the server node lists ( with virtual nodes) and its hash value as key.  This class a member of <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/collections/index.html" target="_blank" rel="noopener noreferrer">Java Collections Framework</a>, providing expected average <em>log(n)</em> time cost for retrieve and access operations safely execute concurrent by multiple threads.  </p><p>Furthermore, the method tailMap(K fromKey) of  <code>ConcurrentSkipListMap</code> can return a view of portion of the map whose keys are greater or equal to the <code>fromKey</code>, and not need to navigate the whole map.</p><p>In the above code section, after the hash ring is generated, it uses <code>tailMap(K fromKey)</code> of <code>ConcurrentSkipListMap</code> to find the subset that the elements greater, or equal to the hash value of the requested <code>ip</code>, its first element is just the node to be routed. With the suitable data structure, the code looks particularly clear and concise.</p><p>Consistent hashing resolved the poor scalability of the traditional hashing by modular operation.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="roundrobinloadbalancer"></a>RoundRobinLoadBalancer<a class="hash-link" href="#roundrobinloadbalancer" title="Direct link to heading">#</a></h2><p>The original Round-robin selection is to select server nodes one by one from the candidate list. Whenever some nodes has crash ( ex, cannot be connected after 1 minute), it will be removed from the candidate list, and do not attend the next round, until the server node is recovered and it will be add to the candidate list again.  In <code>RoundRobinLoadBalancer</code>,the weight Round Robin per-packet schema is implemented.</p><p>In order to work in concurrent system, it provides an inner static class <code>WeigthRoundRobin</code> to store and calculate the rolling selections of each server node. Following is the main section of this class( removed remark )</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected static class WeightedRoundRobin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicLong current = new AtomicLong(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setWeight(final int weight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.weight = weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.set(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long increaseCurrent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return current.addAndGet(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void sel(final int total) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.addAndGet(-1 * total);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setLastUpdate(final long lastUpdate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.lastUpdate = lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Please focus on the these method:</p><ul><li><p><code>setWeight(final int weight)</code> : set the current value by <em>weight</em></p></li><li><p><code>increaseCurrent()</code>: Increment the <code>current</code> value by <code>weight</code>, and <code>current</code> set to 0. </p></li><li><p><code>sel(final int total)</code>: decrement  the <code>current</code> value by  <em>total</em></p><p>Let&#x27;s see how the weight factor being used in this round-robin  selection? </p><p>First it defines a two-level  <code>ConcurrentMap</code> type variable named as <code>methodWeightMap</code> , to cache the server node lists and the rolling selection data about each server node.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt; methodWeightMap = new ConcurrentHashMap&lt;&gt;(16);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this map, the key of first level is  set to <code>upstreamUrl</code> of first element in server node list. The type of second object is <code>ConcurrentMap&lt;String, WeightedRoundRobin&gt;,</code> the key of this inner Map is  the value <code>upstreamUrl</code>variable of each server node in this server list, the value object is <code>WeightedRoundRobin</code>, used to trace the rolling selection data about each server node. As to the implementation class for the  Map object, we use <code>ConcurrentHashMap</code> of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html" target="_blank" rel="noopener noreferrer">JUC</a>,  a hash table supporting full concurrency of retrievals and high expected concurrency for updates.</p><p>In the second level of the map, the embedded  static class - <code>WeighedRoundRobin</code> of each node is thread-safe, implementing the weighted <code>RoundRobin</code> per bucket. The following is the code of the <code>doselect()</code> method of this class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public Upstream doSelect(final List&lt;Upstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String key = upstreamList.get(0).getUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(map)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodWeightMap.putIfAbsent(key, new ConcurrentHashMap&lt;&gt;(16));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int totalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long maxCurrent = Long.MIN_VALUE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long now = System.currentTimeMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream selectedInvoker = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WeightedRoundRobin selectedWeightedRoundRobin = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Upstream upstream : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rKey = upstream.getUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WeightedRoundRobin weightedRoundRobin = map.get(rKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int weight = getWeight(upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(weightedRoundRobin)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin = new WeightedRoundRobin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.putIfAbsent(rKey, weightedRoundRobin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (weight != weightedRoundRobin.getWeight()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // weight changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long cur = weightedRoundRobin.increaseCurrent();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weightedRoundRobin.setLastUpdate(now);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cur &gt; maxCurrent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            maxCurrent = cur;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedInvoker = upstream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedWeightedRoundRobin = weightedRoundRobin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalWeight += weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......  //erase the section which handles the time-out upstreams. </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (selectedInvoker != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWeightedRoundRobin.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example we assume <code>upstreamUrl</code> values of three server nodes is: LIST = [upstream-20, upstream-50, upstream-30]. After a round of execution, the data in newly created <code>methodWeightMap</code> is as follows:</p><p><img alt="methodWeightMap" src="/assets/images/methodWeightMap-90b4a77aedffd8cd88bc12b9551739ad.png"></p><p>For the above example LIST, assumes the  <code>weight</code> array is  [20,50,30].  the following figure shows the value change and polling selection process of the <code>current</code> array in <code>WeighedRoundRobin</code> object.</p><p><img alt="weighted-roundrobin-demo" src="/assets/images/weighted-roundrobin-demo-cec02fd422fb01ef73e882e0966a8cec.png"></p><p>In each round, it will choose the server node with max <code>current</code> value.</p><ul><li>Round1:<ul><li>Traverse the server node list, initialize the <code>weightedRoundRobin</code> instance of each server node or update  the <code>weight</code> value of server nodes object <code>Upstream</code></li><li>Traverse the server node list, initialize the <code>weightedRoundRobin</code> instance of each server node or update  the <code>weight</code> value of server nodes object <code>Upstream</code></li><li>say, in this case,  after traverse, the <code>current</code> array  of the node list changes to  [20, 50,30]，so according to rule, the node Stream-50 would be chosen, and then the static object <code>WeightedRoundRobin</code> of  Stream-50 executes <code>sel(-total)</code> , the <code>current</code> array is now [20,-50, 30].</li></ul></li><li>Round 2:  after traverse, the <code>current</code> array should be [40,0,60],  so the Stream-30 node would be chosen， <code>current</code> array is now  [40,0,-40].</li><li>Round 3:  after traverse, <code>current</code> array  changes to [60,50,-10],  Stream-20 would be chosen，and <code>current</code> array is now [-40,50,-10].</li></ul><p>When there is any inconsistence or some server crashed, for example, the lists size does not match with the elements in map, it would copy and modify the element with lock mechanism, and remove the timeout server node,  the data in Map updated. Following is the fault tolerance code segment.  </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Java"><pre tabindex="0" class="prism-code language-Java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    if (!updateLock.get() &amp;&amp; upstreamList.size() != map.size() &amp;&amp; updateLock.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // copy -&gt; modify -&gt; update reference.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = new ConcurrentHashMap&lt;&gt;(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; recyclePeriod);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodWeightMap.put(key, newMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateLock.set(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(selectedInvoker)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWeightedRoundRobin.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalancerfactory"></a>LoadBalancerFactory<a class="hash-link" href="#loadbalancerfactory" title="Direct link to heading">#</a></h2><p>In this class, a static method calling <code>LoadBalancer</code> is provided, where<code>ExtensionLoader</code> is the entry point of <code>Apache Shenyu SPI</code>. That is to say, <code>LoadBalancer</code> module is configurable and extensible. The <code>algorithm</code> variable in this static method is the <code>name</code> enumeration type defined in <code>LoadBalanceEnum</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Selector upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param algorithm    the loadBalance algorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Upstream selector(final List&lt;Upstream&gt; upstreamList, final String algorithm, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LoadBalancer loadBalance = ExtensionLoader.getExtensionLoader(LoadBalancer.class).getJoin(algorithm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return loadBalance.select(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="using-of-loadbalancer-module"></a>Using of LoadBalancer module<a class="hash-link" href="#using-of-loadbalancer-module" title="Direct link to heading">#</a></h2><p>In the above section, we describe the <code>LoadBalancer</code> <code>SPI</code> and three implementation classes. Let&#x27;s take a look at how the <code>LoadBalancer</code> to be used in <code>Apache Shenyu</code>. <a href="http://shenyu.apache.org/docs/plugin-center/http-handle/divide-plugin" target="_blank" rel="noopener noreferrer">DividePlugin</a> is a <code>plugin</code> in <code>Apache Shenyu</code> responsible for routing <code>http</code> request. when enable to use this <code>plugin</code>, it will transfer traffic according to selection data and rule data, and deliver to next plugin downstream.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The type of second parameter of <code>doExecute()</code> is <code>ShenyuPluginChain</code>, which represents the execution chain of <code>plugins</code>. For details, see the mechanism of <a href="http://shenyu.apache.org/docs/design/flow-control" target="_blank" rel="noopener noreferrer">Apache Shenyu Plugins</a>. The third one is <code>SelectorData</code> type, and the fourth is <code>RuleData</code> type working as  the rule data.</p><p>In <code>doExecute()</code> of <code>DividePlugin</code>,  first verify the size of <code>header</code>, content length,  etc, then preparing for load balancing.</p><p>Following is a code fragment using<code>LoadBalancer</code> in the <code>doExecute()</code> method:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    // find the routing server node list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Upstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // the requested ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //calling the Utility class and invoke the LoadBalance processing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upstream upstream = LoadBalancerFactory.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p> In the above code, the output of<code>ruleHandle.getLoadBalance()</code> is the <code>name</code> variable defined in <code>LoadBalanceEnum</code>, that is <code>random</code>, <code>hash</code>, <code>roundRobin</code>, etc.  It is very convenient to use <code>LoadBalancer</code> by <code>LoadBalancerFactory</code>. When adding more  <code>LoadBalancer</code> implementing classes,  the interface in <code>plugin</code> module will not be effect at all.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>After reading through the code of <code>LoadBalancer</code> module, from the design perspective, it is concluded that this module has the  following characteristics:</p><ol><li>Extensibility: Interface oriented design and implemented on <code>Apache Shenyu SPI</code> mechanism, it can be easily extended to other dynamic load balancing algorithms (for example, least connection, fastest mode, etc), and supports cluster processing.</li><li>Scalability： Every load balancing implementation,  weighted Random, consistency  Hashing and weighted <code>RoundRobin</code> can well support increase or decrease cluster overall capacity.</li><li>More detailed design such as <em>warm-up</em> can bring better performance and obtain better overall stability.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/load-balance">load balance</a><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about LoadBalancer SPI Source Code Analysis" href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync">Nacos Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.307Z">September 28, 2024</time> · 22 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>etcd</code> and <code>Consul</code>. The main content of this article is based on <code>Nacos</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-nacos"></a>1. About Nacos<a class="hash-link" href="#1-about-nacos" title="Direct link to heading">#</a></h3><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer"><code>Nacos</code></a>  can be used for dynamic service discovery and configuration and service management. <code>Shenyu</code> use <code>Nacos</code> as an option to sync data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>We traced the source code from a real case, such as updating a selector data in the <code>Divide</code> plugin to a weight of 90 in a background administration system:</p><p><img src="/assets/images/update-selector-en-4efb58e488bd424a54213d31929d7eb1.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-data"></a>2.1 Accept Data<a class="hash-link" href="#21-accept-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set the current selector data ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>：</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: <code>APP_AUTH</code>, <code>PLUGIN</code>, <code>RULE</code>, <code>SELECTOR</code> and <code>META_DATA</code>.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket;</li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper;</li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>：data synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>：data synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>：data synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>nacos</code> data synchronization source code analysis, so here to <code>NacosDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // some codes omitted here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Nacos listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(NacosConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class NacosListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Data changed listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener nacosDataChangedListener(final ConfigService configService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataChangedListener(configService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Nacos data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the nacos data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public NacosDataInit nacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataInit(configService, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // some codes omitted here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the SpringBoot conditional assembly class. The <code>NacosListener</code> class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>nacos</code> is used for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(NacosConfiguration.class)</code>：import  a configration class <code>NacosConfiguration</code>, which provides a method <code>ConfigService nacosConfigService(final NacosProperties nacosProp)</code> to convert the nacos properties to a bean with the <code>ConfigService</code> type. We would take a look at how to generate the bean and then analyze the property configuration class and the property configuration file.  </p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(NacosProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register configService in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosProp the nacos configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ConfigService {@linkplain ConfigService}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(ConfigService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosProperties nacosProp) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosProp.getAcm() != null &amp;&amp; nacosProp.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use aliyun ACM service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosProp.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use subaccount ACM administrative authority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosProp.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosProp.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosProp.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getUsername())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosProp.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getPassword())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosProp.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There are two steps in this method. Firstly, <code>Properties</code> object is generated and populated with the specified nacos path value and authority values on whether the alyun ACM service is used. Secondly, the nacos factory class would use its static factory method to create a <code>configService</code> object via reflect methods and then populate the object with the <code>Properties</code> object generated in the first step.</p><p>Now, let&#x27;s analyze the <code>NacosProperties</code> class and its counterpart property file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private NacosACMProperties acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUrl() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param url url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUrl(final String url) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.url = url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param username username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(final String username) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param password password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPassword(final String password) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosACMProperties getAcm() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param acm acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAcm(final NacosACMProperties acm) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.acm = acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class NacosACMProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean isEnabled() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param enabled enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEnabled(final boolean enabled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.enabled = enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getEndpoint() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param endpoint endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEndpoint(final String endpoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.endpoint = endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getAccessKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param accessKey accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setAccessKey(final String accessKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.accessKey = accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getSecretKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param secretKey secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setSecretKey(final String secretKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.secretKey = secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the property <code>shenyu.sync.nacos.url</code> is set in the property file, the <code>shenyu</code> admin would choose the <code>nacos</code> to sync data. At this time, the configuration class <code>NacosListener</code> would take effect and a bean with the type <code>NacosDataChangedListener</code> and another bean with the type <code>NacosDataInit</code> would both be generated.</p><ul><li><p><code>nacosDataChangedListener</code>, the bean with the type <code>NacosDataChangedListener</code> , takes the bean with the type <code>ConfigService</code> as a member variable. <code>ConfigService</code> is an api provided by <code>nacos</code> and can be used to send request to nacos server to modify configurations once the <code>nacosDataChangedListener</code> has accepted an event and trigger the callback method.</p></li><li><p><code>nacosDataInit</code>, the bean with the type <code>NacosDataInit</code>, takes the bean <code>configService</code> and the bean <code>syncDataService</code> as memeber variables. It use <code>configService</code> to call the <code>Nacos</code> api to judge whether the configurations have been initialized, and would use <code>syncDataService</code> to refresh them if the answer is no. </p><p>As mentioned above, some operations of the  <code>listener</code> would be triggered in the event handle method <code>onApplicationEvent()</code>. In this example, we update selector data and choose <code>nacos</code> to sync data, so the code about logic of the selector data changes in the <code>NacosDataChangedListener</code> class would be called.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                 // some codes omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-nacos-data-changed-listener"></a>2.4 Nacos Data Changed Listener<a class="hash-link" href="#24-nacos-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>NacosDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, determine the type of action, whether to refresh synchronization or update or create synchronization. Determine whether the node is in <code>etcd</code> based on the current selector data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Use nacos to push data changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateSelectorMap(getConfig(NacosPathConstants.SELECTOR_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SELECTOR_MAP.keySet().removeAll(SELECTOR_MAP.keySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishConfig(NacosPathConstants.SELECTOR_DATA_ID, SELECTOR_MAP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This is the core part. The variable <code>changed</code> represents the list , which needs to be updated, with the elements of the <code>SelectorData</code> type. The variable <code>eventType</code> represents the event type. The variable <code>SELECTOR_MAP</code> is with the type <code>ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt;</code>, so the key of the map is with the <code>String</code> type and the value is the selector list of this plugin.  The value of the constant <code>NacosPathConstants.SELECTOR_DATA_ID</code> is <code>shenyu.selector.json</code>. The steps are as follows, firstly, use the method <code>getConfig</code> to call the api of <code>Nacos</code> to fetch the config with the <code>group</code> value of <code>shenyu.selector.json</code> from <code>Nacos</code> and call the <code>updateSelectorMap</code> method to use the config fetched above to update the <code>SELECTOR_MAP</code> so that the we refresh the selector config from <code>Nacos</code>. Secondly, we can update <code>SELECTOR_MAP</code> according to the event type and then use the <code>publishConfig</code> method to call the <code>Nacos</code> api to update all the config with the <code>group</code> value of <code>shenyu.selector.json</code>.</p><p>As long as the changed data is correctly written to the <code>Nacos</code> node, the <code>admin</code> side of the operation is complete. </p><p>In our current case, updating one of the selector data in the <code>Divide</code> plugin with a weight of 90 updates specific nodes in the graph.</p><p><img src="/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>We series the above update flow with a sequence diagram.</p><p><img src="/assets/images/nacos-sync-sequence-admin-en-826456f35e436cb61d20b07a883532c5.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume that the ShenYu gateway is already running properly, and the data synchronization mode is also <code>nacos</code>. How does the gateway receive and process the selector data after updating it on the <code>admin</code> side and sending the changed data to <code>nacos</code>? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-nacossyncdataservice-accept-data"></a>3.1 NacosSyncDataService Accept Data<a class="hash-link" href="#31-nacossyncdataservice-accept-data" title="Direct link to heading">#</a></h4><p>The gateway side use <code>NacosSyncDataService</code> to watch <code>nacos</code> and fetch the data update, but before we dive into this part, let us take a look on how the bean with the type <code>NacosSyncDataService</code> is generated. The answer is it&#x27;s defined in the Spring config class <code>NacosSyncDataConfiguration</code>. Let&#x27;s focus on the annotation <code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code> on the class <code>NacosSyncDataConfiguration</code> again. We have met this annotation when we  analyzed the <code>NacosListener</code> class on the <code>Admin</code> side before, this config class would take effect only and if only the condition on this annotation is matched. In other words, when we have the config as below on the gateway side, the gateway would use <code>nacos</code> to sync data and the config class <code>NacosSyncDataConfiguration</code> would take effect.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(NacosSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(NacosSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService     the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos config service config service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosConfig the nacos config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosConfig nacosConfig) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosConfig.getAcm() != null &amp;&amp; nacosConfig.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosConfig.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosConfig.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosConfig.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosConfig.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosConfig.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getUsername() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosConfig.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getPassword() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosConfig.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http config http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosConfig nacosConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s focus on the part of code above which is about the  generation of the bean <code>nacosSyncDataService</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As we can see, the bean is generated by the construction method of the Class <code>NacosSyncDataService</code>. Let&#x27;s dive into the construction method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public NacosSyncDataService(final ConfigService configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(configService, pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.PLUGIN_DATA_ID, this::updatePluginMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.SELECTOR_DATA_ID, this::updateSelectorMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.RULE_DATA_ID, this::updateRuleMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.META_DATA_ID, this::updateMetaDataMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.AUTH_DATA_ID, this::updateAuthMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void watcherData(final String dataId, final OnChange oc) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Listener listener = new Listener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void receiveConfigInfo(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                oc.change(configInfo);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Executor getExecutor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        oc.change(getConfigAndSignListener(dataId, listener));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LISTENERS.computeIfAbsent(dataId, key -&gt; new ArrayList&lt;&gt;()).add(listener);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As we can see, the construction method calls the <code>start</code> method and calls the <code>watcherData</code> method to create a listener which relates itself to a callback method <code>oc</code>, since we&#x27;re analyzing the changes on the component with the <code>selector</code> type, the relative callback method is <code>updateSelectorMap</code>. This callback method is used to handle data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-handle-data"></a>3.2 Handle Data<a class="hash-link" href="#32-handle-data" title="Direct link to heading">#</a></h4><ul><li>NacosCacheHandler.updateSelectorMap()</li></ul><p>The data is not null, and caching the selector data is again handled by <code>PluginDataSubscriber</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateSelectorMap(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; selectorDataList = GsonUtils.getInstance().toObjectMapList(configInfo, SelectorData.class).values().stream().flatMap(Collection::stream).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDataList.forEach(selectorData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.unSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.onSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (JsonParseException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;sync selector data have error:&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code> is an interface, it is only a <code>CommonPluginDataSubscriber</code> implementation class, responsible for data processing plugin, selector and rules.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-common-plugin-data-subscriber"></a>3.3 Common Plugin Data Subscriber<a class="hash-link" href="#33-common-plugin-data-subscriber" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.unSelectorSubscribe()</li><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>unSelectorSubscribe()</code>and<code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void unSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.DELETE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-data-cached-to-memory"></a>3.4 Data cached to Memory<a class="hash-link" href="#34-data-cached-to-memory" title="Direct link to heading">#</a></h4><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracking, and through a practical case, in the <code>admin</code> end to update a selector data, the <code>ZooKeeper</code> data synchronization process analysis is clear.</p><p>Let&#x27;s series the data synchronization process on the gateway side through the sequence diagram:</p><p><img src="/assets/images/nacos-sync-sequence-gateway-en-be485f797e80f6c71e910d72e41affdc.png"></p><p>The data synchronization process has been analyzed. In order to prevent the synchronization process from being interrupted, other logic is ignored during the analysis. We have analyzed the process of  gateway synchronization operation initialization in the <code>start</code> method of <code>NacosSyncDataService</code> class. We also need to analyze the process of Admin synchronization data initialization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin-data-sync--initialization"></a>4. Admin Data Sync  initialization<a class="hash-link" href="#4-admin-data-sync--initialization" title="Direct link to heading">#</a></h3><p>On the <code>admin</code> side, the bean with the type <code>NacosDataInit</code>, is defined and generated in the <code>NacosListener</code>, if the configuration of the admin side decides to use <code>nacos</code> to sync data, when <code>admin</code> starts, the current data will be fully synchronized to <code>nacos</code>, the implementation logic is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(NacosDataInit.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConfigService configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService the nacos config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginDataId = NacosPathConstants.PLUGIN_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authDataId = NacosPathConstants.AUTH_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataId = NacosPathConstants.META_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dataIdNotExist(pluginDataId) &amp;&amp; dataIdNotExist(authDataId) &amp;&amp; dataIdNotExist(metaDataId)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group = NacosPathConstants.GROUP;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long timeout = NacosPathConstants.DEFAULT_TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return configService.getConfig(pluginDataId, group, timeout) == null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NacosException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Get data from nacos error.&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check whether there is data in <code>nacos</code>, if not, then synchronize.</p><p><code>NacosDataInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>SpringBoot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> initializations and is often used for initialization operations in a project.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, and then perform full data synchronization, all authentication information, plugin information, selector information, rule information, and metadata information. Synchronous events are published primarily through <code>eventPublisher</code>. After publishing the event via <code>publishEvent()</code>, the <code>ApplicationListener</code> performs the event change operation. In <code>ShenYu</code> is mentioned in <code>DataChangedEventDispatcher</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * sync all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-summary"></a>5. Summary<a class="hash-link" href="#5-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, <code>nacos</code> data synchronization principle source code analysis. The main knowledge points involved are as follows:</p><ul><li><p>Data synchronization based on <code>nacos</code> is mainly implemented through <code>watch</code> mechanism;</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of <code>SpringBoot</code> and <code>starter</code> loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/nacos">nacos</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Nacos Data Synchronization Source Code Analysis" href="/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocket Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.307Z">September 28, 2024</time> · 22 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>etcd</code> and <code>Consul</code>. The main content of this article is based on <code>WebSocket</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-websocket-communication"></a>1. About WebSocket Communication<a class="hash-link" href="#1-about-websocket-communication" title="Direct link to heading">#</a></h3><p>The WebSocket protocol was born in 2008 and became an international standard in 2011. It can be two-way communication, the server can take the initiative to push information to the client, the client can also take the initiative to send information to the server. The WebSocket protocol is based on the TCP protocol and belongs to the application layer, with low performance overhead and high communication efficiency. The protocol identifier is <code>ws</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>Let&#x27;s trace the source code from a real case, such as adding a selector data in the background management system:</p><p><img src="/assets/images/add-selector-93ff1008c1b0b4627dd3329abc92a7bd.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-changed-data"></a>2.1 Accept Changed Data<a class="hash-link" href="#21-accept-changed-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult createSelector(@Valid @RequestBody final SelectorDTO selectorDTO) { // @Valid 数校验</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer createCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.CREATE_SUCCESS, createCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>：</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // Other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: APP_AUTH, PLUGIN, RULE, SELECTOR and META_DATA.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket; </li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper; </li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>：data synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>：data synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>：data synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>websocket</code> data synchronization source code analysis, so here to <code>WebsocketDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data Sync Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * By springboot conditional assembly</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The WebsocketListener(default strategy).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;shenyu.sync.websocket.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(WebsocketSyncProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class WebsocketListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(WebsocketDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener websocketDataChangedListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new WebsocketDataChangedListener();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Websocket collector.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Websocket collector class: establish a connection, send a message, close the connection and other operations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the websocket collector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(WebsocketCollector.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public WebsocketCollector websocketCollector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new WebsocketCollector();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Server endpoint exporter </span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the server endpoint exporter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ServerEndpointExporter.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ServerEndpointExporter serverEndpointExporter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ServerEndpointExporter();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the <code>SpringBoot</code> conditional assembly class. The <code>WebsocketListener</code> class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(name = &quot;shenyu.sync.websocket.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>websocket</code> is used for data synchronization. Note, however, the <code>matchIfMissing = true</code> attribute, which means that this configuration class will work if you don&#x27;t have the following configuration. Data synchronization based on <code>webSocket</code> is officially recommended and the default.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    websocket:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties</code>：enable configuration properties;</p></li></ul><p>When we take the initiative to configuration, use the <code>websocket</code> data synchronization, <code>WebsocketDataChangedListener</code> is generated. So in the event handler <code>onApplicationEvent()</code>, it goes to the corresponding <code>listener</code>. In our case, a selector is to increase the new data, the data by adopting the <code>websocket</code>, so, the code will enter the <code>WebsocketDataChangedListener</code> selector data change process.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // other logic is omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // WebsocketDataChangedListener handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-websocket-data-changed-listener"></a>2.4 Websocket Data Changed Listener<a class="hash-link" href="#24-websocket-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>WebsocketDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, the data is encapsulated into <code>WebsocketData</code> and then sent via <code>webSocketCollector.send()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    // selector data has been updated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; selectorDataList, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build WebsocketData </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData&lt;SelectorData&gt; websocketData =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new WebsocketData&lt;&gt;(ConfigGroupEnum.SELECTOR.name(), eventType.name(), selectorDataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // websocket send data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-websocket-send-data"></a>2.5 Websocket Send Data<a class="hash-link" href="#25-websocket-send-data" title="Direct link to heading">#</a></h4><ul><li>WebsocketCollector.send()</li></ul><p>In the <code>send()</code> method, the type of synchronization is determined and processed according to the different types.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ServerEndpoint(value = &quot;/websocket&quot;, configurator = WebsocketConfigurator.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketCollector {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Send.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param message the message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type    the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void send(final String message, final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(message)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If it&#x27;s MYSELF (first full synchronization)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (DataEventTypeEnum.MYSELF == type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // get the session from ThreadLocal</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Session session = (Session) ThreadLocalUtil.get(SESSION_KEY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (session != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // send full data to the session</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   sendMessageBySession(session, message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // subsequent incremental synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // synchronize change data to all sessions</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               SESSION_SET.forEach(session -&gt; sendMessageBySession(session, message));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void sendMessageBySession(final Session session, final String message) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The message is sent through the Websocket session</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           session.getBasicRemote().sendText(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;websocket send result is exception: &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The example we give is a new operation, an incremental synchronization, so it goes</p><p><code>SESSION_SET.forEach(session -&gt; sendMessageBySession(session, message));</code></p><p>then through</p><p><code>session.getBasicRemote().sendText(message);</code></p><p>the data was sent out.</p><p>At this point, when data changes occur on the admin side, the changed data is increments sent to the gateway through the <code>WebSocket</code>.</p><p>At this point, do you have any questions? For example, where does session come from? How does the gateway establish a connection with admin?</p><p>Don&#x27;t worry, let&#x27;s do the synchronization analysis on the gateway side.</p><p>However, before continuing with the source code analysis, let&#x27;s use a diagram to string together the above analysis process.</p><p><img src="/assets/images/websocket-data-sync-admin-en-e19e1829e21c675463bd2df0e79528fa.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume <code>ShenYu</code> gateway is already in normal operation, using the data synchronization mode is also <code>websocket</code>. How does the gateway receive and process new selector data from admin and send it to the gateway via WebSocket? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-websocketclient-accept-data"></a>3.1 WebsocketClient Accept Data<a class="hash-link" href="#31-websocketclient-accept-data" title="Direct link to heading">#</a></h4><ul><li>ShenyuWebsocketClient.onMessage()</li></ul><p>There is a <code>ShenyuWebsocketClient</code> class on the gateway, which inherits from <code>WebSocketClient</code> and can establish a connection and communicate with <code>WebSocket</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After sending data via <code>websocket</code> on the admin side, <code>ShenyuWebsocketClient</code> can receive data via <code>onMessage()</code> and then process it itself.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // execute after receiving the message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handle accept data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleResult(result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void handleResult(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // data deserialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // which data types, plug-ins, selectors, rules...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // which operation type, update, delete...      </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String eventType = websocketData.getEventType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(websocketData.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handle data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        websocketDataHandler.executor(groupEnum, json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After receiving the data, first has carried on the deserialization operation, read the data type and operation type, then hand over to <code>websocketDataHandler.executor()</code> for processing.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-execute-websocket-data-handler"></a>3.2 Execute Websocket Data Handler<a class="hash-link" href="#32-execute-websocket-data-handler" title="Direct link to heading">#</a></h4><ul><li>WebsocketDataHandler.executor()</li></ul><p>A <code>Websocket</code> data handler is created in factory mode, providing one handler for each data type:</p><blockquote><p>plugin --&gt; PluginDataHandler;</p><p>selector --&gt; SelectorDataHandler;</p><p>rule --&gt; RuleDataHandler;</p><p>auth --&gt; AuthDataHandler;</p><p>metadata --&gt; MetaDataHandler.</p></blockquote><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Create Websocket data handlers through factory mode</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Websocket cache handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final EnumMap&lt;ConfigGroupEnum, DataHandler&gt; ENUM_MAP = new EnumMap&lt;&gt;(ConfigGroupEnum.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Websocket data handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketDataHandler(final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin --&gt; PluginDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.PLUGIN, new PluginDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector --&gt; SelectorDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.SELECTOR, new SelectorDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule --&gt; RuleDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.RULE, new RuleDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // auth --&gt; AuthDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.APP_AUTH, new AuthDataHandler(authDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata --&gt; MetaDataHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.META_DATA, new MetaDataHandler(metaDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Executor.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type      the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param json      the json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param eventType the event type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final ConfigGroupEnum type, final String json, final String eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find the corresponding data handler based on the data type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.get(type).handle(json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Different data types have different ways of handling data, so there are different implementation classes. But they also have the same processing logic between them, so they can be implemented through the template approach to design patterns. The same logic is placed in the <code>handle()</code> method of the abstract class, and the different logic is handed over to the respective implementation class.</p><p><img src="/assets/images/data-handler-313ae788eadfdabf405cdc55c74dbb21.png"></p><p>In our case, a new selector is added, so it will be passed to the <code>SelectorDataHandler</code> for data processing.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-determine-the-event-type"></a>3.3 Determine the Event Type<a class="hash-link" href="#33-determine-the-event-type" title="Direct link to heading">#</a></h4><ul><li>AbstractDataHandler.handle()</li></ul><p>Implement common logical handling of data changes: invoke different methods based on different operation types.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataHandler&lt;T&gt; implements DataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Convert list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The different logic is implemented by the respective implementation classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param json the json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract List&lt;T&gt; convert(String json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do refresh.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The different logic is implemented by the respective implementation classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doRefresh(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do update.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The different logic is implemented by the respective implementation classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doUpdate(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do delete.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The different logic is implemented by the respective implementation classes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doDelete(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // General purpose logic, abstract class implementation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handle(final String json, final String eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;T&gt; dataList = convert(json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DataEventTypeEnum eventTypeEnum = DataEventTypeEnum.acquireByName(eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (eventTypeEnum) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doRefresh(dataList);  //Refreshes data and synchronizes all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case UPDATE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case CREATE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doUpdate(dataList); // Update or create data, incremental synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doDelete(dataList);  // delete data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>New selector data, new operation, through <code>switch-case</code> into <code>doUpdate()</code> method.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-enter-the-specific-data-handler"></a>3.4 Enter the Specific Data Handler<a class="hash-link" href="#34-enter-the-specific-data-handler" title="Direct link to heading">#</a></h4><ul><li>SelectorDataHandler.doUpdate()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Selector data handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorDataHandler extends AbstractDataHandler&lt;SelectorData&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PluginDataSubscriber pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // update data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doUpdate(final List&lt;SelectorData&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataList.forEach(pluginDataSubscriber::onSelectorSubscribe);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Iterate over the data and enter the <code>onSelectorSubscribe()</code> method.</p><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracing, and through a practical case, in the <code>admin</code> side to add a selector data, will <code>websocket</code> data synchronization process analysis cleared.</p><p>Let&#x27;s use the following figure to concatenate the data synchronization process on the gateway side:</p><p><img src="/assets/images/websocket-data-sync-gateway-en-3703ea52c109a681e970cbf79108280d.png"></p><p>The data synchronization process has been analyzed, but there are still some problems that have not been analyzed, that is, how does the gateway establish a connection with admin?</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-the-gateway-establishes-a-websocket-connection-with-admin"></a>4. The Gateway Establishes a Websocket Connection with Admin<a class="hash-link" href="#4-the-gateway-establishes-a-websocket-connection-with-admin" title="Direct link to heading">#</a></h3><ul><li>websocket config</li></ul><p>With the following configuration in the gateway configuration file and the dependency introduced, the <code>websocket</code> related service is started.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cross</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">parameter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> multi</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">websocket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Use websocket for data synchronization</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">9095/websocket   </span><span class="token comment" style="color:#999988;font-style:italic"># websocket address of admin</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">allowOrigin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9195</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Add a dependency on websocket in the gateway.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!--shenyu data sync start use websocket--&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spring-boot-starter-sync-data-websocket</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Websocket Data Sync Config</li></ul><p>The associated bean is created by conditional assembly of springboot. In the gateway started, if we configure the <code>shenyu.sync.websocket.urls</code>, then <code>websocket</code> data synchronization configuration will be loaded. The dependency loading is done through the <code>springboot starter</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * WebsocketSyncDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Conditional injection is implemented through SpringBoot</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(WebsocketSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.websocket&quot;, name = &quot;urls&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Websocket sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param websocketConfig   the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService websocketSyncDataService(final ObjectProvider&lt;WebsocketConfig&gt; websocketConfig, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;you use websocket sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new WebsocketSyncDataService(websocketConfig.getIfAvailable(WebsocketConfig::new), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Config websocket config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.websocket&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketConfig websocketConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new WebsocketConfig();  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Start a new <code>spring.factories</code> file in the <code>resources/META-INF</code> directory of your project and specify the configuration classes in the file.</p><p><img src="/assets/images/websocket-springboot-starter-2cfd149ba2fb69ab514241e061fc22c9.png"></p><ul><li>WebsocketSyncDataService</li></ul><p>The following things are done in &#x27;WebsocketSyncDataService&#x27; :</p><ul><li><p>Read configuration <code>urls</code>, which represent the admin side of the synchronization address, if there are more than one, use &quot;,&quot; split;</p></li><li><p>Create a scheduling thread pool, with each <code>admin</code> assigned one to perform scheduled tasks;</p></li><li><p>Create <code>ShenyuWebsocketClient</code>, assign one to each <code>admin</code>, set up <code>websocket</code> communication with <code>admin</code>;</p></li><li><p>Start connection with admin end <code>websocket</code>;</p></li><li><p>Executes a scheduled task every 10 seconds. The main function is to determine whether the <code>websocket</code> connection has been disconnected, if so, try to reconnect. If not, a <code>ping-pong</code> test is performed.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;WebSocketClient&gt; clients = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ScheduledThreadPoolExecutor executor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Websocket sync cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param websocketConfig      the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketSyncDataService(final WebsocketConfig websocketConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If there are multiple synchronization addresses on the admin side, use commas (,) to separate them</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] urls = StringUtils.split(websocketConfig.getUrls(), &quot;,&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Create a scheduling thread pool, one for each admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor = new ScheduledThreadPoolExecutor(urls.length, ShenyuThreadFactory.create(&quot;websocket-connect&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String url : urls) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Create a WebsocketClient and assign one to each admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.add(new ShenyuWebsocketClient(new URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (URISyntaxException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;websocket url({}) is error&quot;, url, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (WebSocketClient client : clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Establish a connection with the WebSocket Server</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean success = client.connectBlocking(3000, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (success) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.info(&quot;websocket connection is successful.....&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.error(&quot;websocket connection is error.....&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Run a scheduled task every 10 seconds</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The main function is to check whether the WebSocket connection is disconnected. If the connection is disconnected, retry the connection.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If it is not disconnected, the ping-pong test is performed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                executor.scheduleAtFixedRate(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (client.isClosed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            boolean reconnectSuccess = client.reconnectBlocking();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (reconnectSuccess) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.info(&quot;websocket reconnect server[{}] is successful.....&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.error(&quot;websocket reconnection server[{}] is error.....&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            client.sendPing();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.debug(&quot;websocket send to [{}] ping message successful&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.error(&quot;websocket connect is error :{}&quot;, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, 10, 10, TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            /* client.setProxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress(&quot;proxyaddress&quot;, 80)));*/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;websocket connection...exception....&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // close websocket client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (WebSocketClient client : clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!client.isClosed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // close threadpool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(executor)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuWebsocketClient</li></ul><p>The <code>WebSocket</code> client created in <code>ShenYu</code> to communicate with the <code>admin</code> side. After the connection is successfully established for the first time, full data is synchronized and incremental data is subsequently synchronized.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type shenyu websocket client.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile boolean alreadySync = Boolean.FALSE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final WebsocketDataHandler websocketDataHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new shenyu websocket client.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param serverUri             the server uri  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers   the meta data subscribers </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers   the auth data subscribers </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuWebsocketClient(final URI serverUri, final PluginDataSubscriber pluginDataSubscriber,final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(serverUri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.websocketDataHandler = new WebsocketDataHandler(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execute after the connection is successfully established</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onOpen(final ServerHandshake serverHandshake) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // To prevent re-execution when reconnecting, use alreadySync to determine</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!alreadySync) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Synchronize all data, type MYSELF</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            send(DataEventTypeEnum.MYSELF.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            alreadySync = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execute after receiving the message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handle data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleResult(result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execute after shutdown</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onClose(final int i, final String s, final boolean b) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execute after error</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onError(final Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;ALL&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void handleResult(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Data deserialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Which data types, plugins, selectors, rules...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Which operation type, update, delete...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String eventType = websocketData.getEventType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(websocketData.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handle data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        websocketDataHandler.executor(groupEnum, json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-summary"></a>5. Summary<a class="hash-link" href="#5-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, the data synchronization principle of websocket source code analysis. The main knowledge points involved are as follows:</p><ul><li><p><code>WebSocket</code> supports bidirectional communication and has good performance. It is recommended.</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use factory mode to create <code>WebsocketDataHandler</code> to handle different data types;</p></li><li><p>Implement <code>AbstractDataHandler</code> using template method design patterns to handle general operation types;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of SpringBoot and starter loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/websocket">websocket</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about WebSocket Data Synchronization Source Code Analysis" href="/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Http Long Polling Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.307Z">September 28, 2024</time> · 31 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>etcd</code> and <code>Consul</code>. The main content of this article is based on <code>http long poll</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.5.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-http-long-polling"></a>1. Http Long Polling<a class="hash-link" href="#1-http-long-polling" title="Direct link to heading">#</a></h3><p>Here is a direct quote from the official website with the relevant description.</p><blockquote><p>The mechanism of <code>Zookeeper</code> and <code>WebSocket</code> data synchronization is relatively simple, while <code>Http long polling</code> is more complex. <code>Apache ShenYu</code> borrowed the design ideas of <code>Apollo</code> and <code>Nacos</code>, took their essence, and implemented <code>Http long polling</code> data synchronization function by itself. Note that this is not the traditional <code>ajax</code> long polling!</p></blockquote><p><img src="/assets/images/http-long-polling-en-6d21af33dd02e70f631cddca7aa9d387.png"></p><p><code>Http Long Polling</code> mechanism as shown above, <code>Apache ShenYu</code> gateway active request <code>shenyu-admin</code> configuration service, read timeout time is <code>90s</code>, means that the gateway layer request configuration service will wait at most <code>90s</code>, so as to facilitate <code>shenyu-admin</code> configuration service timely response to change data, so as to achieve quasi real-time push.</p><p>The <code>Http long polling</code> mechanism is initiated by the gateway requesting <code>shenyu-admin</code>, so for this source code analysis, we start from the gateway side.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-gateway-data-sync"></a>2. Gateway Data Sync<a class="hash-link" href="#2-gateway-data-sync" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-load-configuration"></a>2.1 Load Configuration<a class="hash-link" href="#21-load-configuration" title="Direct link to heading">#</a></h4><p>The <code>Http long polling</code> data synchronization configuration is loaded through <code>spring boot starter</code> mechanism when we introduce the relevant dependencies and have the following configuration in the configuration file.</p><p>Introduce dependencies in the <code>pom</code> file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!--shenyu data sync start use http--&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spring-boot-starter-sync-data-http</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Add the following configuration to the <code>application.yml</code> configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the gateway is started, the configuration class <code>HttpSyncDataConfiguration</code> is executed, loading the corresponding <code>Bean</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Http sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HttpSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(value = HttpConfig.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Rest template.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param httpConfig the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the rest template</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RestTemplate restTemplate(final HttpConfig httpConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        OkHttp3ClientHttpRequestFactory factory = new OkHttp3ClientHttpRequestFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setConnectTimeout(Objects.isNull(httpConfig.getConnectionTimeout()) ? (int) HttpConstants.CLIENT_POLLING_CONNECT_TIMEOUT : httpConfig.getConnectionTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setReadTimeout(Objects.isNull(httpConfig.getReadTimeout()) ? (int) HttpConstants.CLIENT_POLLING_READ_TIMEOUT : httpConfig.getReadTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setWriteTimeout(Objects.isNull(httpConfig.getWriteTimeout()) ? (int) HttpConstants.CLIENT_POLLING_WRITE_TIMEOUT : httpConfig.getWriteTimeout());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new RestTemplate(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * AccessTokenManager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param httpConfig   the http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param restTemplate the rest template.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the access token manager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AccessTokenManager accessTokenManager(final HttpConfig httpConfig, final RestTemplate restTemplate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new AccessTokenManager(restTemplate, httpConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param httpConfig         the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber   the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param restTemplate       the rest template</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers    the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers    the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param accessTokenManager the access token manager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService httpSyncDataService(final ObjectProvider&lt;HttpConfig&gt; httpConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;RestTemplate&gt; restTemplate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               final ObjectProvider&lt;AccessTokenManager&gt; accessTokenManager) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use http long pull sync shenyu data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new HttpSyncDataService(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(httpConfig.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(pluginSubscriber.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(restTemplate.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                authSubscribers.getIfAvailable(Collections::emptyList),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Objects.requireNonNull(accessTokenManager.getIfAvailable())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>HttpSyncDataConfiguration</code> is the configuration class for <code>Http long polling</code> data synchronization, responsible for creating <code>HttpSyncDataService</code> (responsible for the concrete implementation of <code>http</code> data synchronization) 、 <code>RestTemplate</code> and <code>AccessTokenManager</code> (responsible for the access token processing). It is annotated as follows.</p><ul><li><code>@Configuration</code>: indicates that this is a configuration class.</li><li><code>@ConditionalOnClass(HttpSyncDataService.class)</code>: conditional annotation indicating that the class <code>HttpSyncDataService</code> is to be present.</li><li><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</code>: conditional annotation to have the property <code>shenyu.sync.http.url</code> configured.</li><li><code>@EnableConfigurationProperties(value = HttpConfig.class)</code>: indicates that the annotation <code>@ConfigurationProperties(prefix = &quot;shenyu.sync.http&quot;)</code> on <code>HttpConfig</code> will take effect, and the configuration class <code>HttpConfig</code> will be injected into the Ioc container.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-property-initialization"></a>2.2 Property initialization<a class="hash-link" href="#22-property-initialization" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService</li></ul><p>In the constructor of <code>HttpSyncDataService</code>, complete the property initialization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // omitted attribute field ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpSyncDataService(final HttpConfig httpConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final RestTemplate restTemplate,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final List&lt;AuthDataSubscriber&gt; authDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final AccessTokenManager accessTokenManager) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 1. accessTokenManager</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.accessTokenManager = accessTokenManager;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 2. create data refresh factory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.factory = new DataRefreshFactory(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 3. shenyu-admin url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(httpConfig.getUrl()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 4. restTemplate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.restTemplate = restTemplate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 5. start a long polling task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Other functions and related fields are omitted from the above code, and the initialization of the properties is done in the constructor, mainly.</p><ul><li><p>the role of <code>accessTokenManager</code> is to request <code>admin</code> and update the <code>access token</code> regularly.</p></li><li><p>creating data processors for subsequent caching of various types of data (plugins, selectors, rules, metadata and authentication data).</p></li><li><p>obtaining the <code>admin</code> property configuration, mainly to obtain the <code>url</code> of the <code>admin</code>, <code>admin</code> with possible clusters, multiple split by a comma <code>(,)</code>.</p></li><li><p>using <code>RestTemplate</code>, for launching requests to <code>admin</code>.</p></li><li><p>Start the long polling task.</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-start-the-long-polling-task"></a>2.3 Start the long polling task.<a class="hash-link" href="#23-start-the-long-polling-task" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService#start()</li></ul><p>In the <code>start()</code> method, two things are done, one is to get the full amount of data, that is, to request the <code>admin</code> side to get all the data that needs to be synchronized, and then cache the acquired data into the gateway memory. The other is to open a multi-threaded execution of a long polling task.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It could be initialized multiple times, so you need to control that.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch all group configs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Initial startup, get full data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // one backend service, one thread</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ThreadPoolExecutor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // start long polling, each server creates a thread to listen for changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="231-fetch-data"></a>2.3.1 Fetch Data<a class="hash-link" href="#231-fetch-data" title="Direct link to heading">#</a></h5><ul><li>HttpSyncDataService#fetchGroupConfig()</li></ul><p><code>ShenYu</code> groups all the data that needs to be synchronized, there are 5 data types, namely plugins, selectors, rules, metadata and authentication data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum ConfigGroupEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    APP_AUTH, // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PLUGIN, // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RULE, // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECTOR, // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA; // meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>admin</code> may be a cluster, and here a request is made to each <code>admin</code> in a round-robin fashion, and if one succeeds, then the operation to get the full amount of data from the <code>admin</code> and cache it to the gateway is executed successfully. If there is an exception, the request is launched to the next <code>admin</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void fetchGroupConfig(final ConfigGroupEnum... groups) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It is possible that admins are clustered, and here requests are made to each admin by means of a loop.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int index = 0; index &lt; this.serverList.size(); index++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String server = serverList.get(index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // do execute</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.doFetchGroupConfig(server, groups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If you have a success, you are successful and can exit the loop</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // An exception occurs, try executing the next</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // The last one also failed to execute, throwing an exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no available server, throw exception.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (index &gt;= serverList.size() - 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw e;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.warn(&quot;fetch config fail, try another one: {}&quot;, serverList.get(index + 1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doFetchGroupConfig()</li></ul><p>In this method, the request parameters are first assembled, then the request is launched through <code>httpClient</code> to <code>admin</code> to get the data, and finally the obtained data is updated to the gateway memory.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Launch a request to the admin backend management system to get all synchronized data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doFetchGroupConfig(final String server, final ConfigGroupEnum... groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. build request parameters, all grouped enumeration types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuilder params = new StringBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum groupKey : groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            params.append(&quot;groupKeys&quot;).append(&quot;=&quot;).append(groupKey.name()).append(&quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin url:  /configs/fetch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_FETCH + &quot;?&quot; + StringUtils.removeEnd(params.toString(), &quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;request configs: [{}]&quot;, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpHeaders headers = new HttpHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // set accessToken</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpEntity&lt;String&gt; httpEntity = new HttpEntity&lt;&gt;(headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. get a request for change data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            json = this.restTemplate.exchange(url, HttpMethod.GET, httpEntity, String.class).getBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String message = String.format(&quot;fetch config fail from server[%s], %s&quot;, url, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.warn(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update local cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Update data in gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean updated = this.updateCacheWithJson(json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (updated) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.debug(&quot;get latest configs: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // not updated. it is likely that the current config server has not been updated yet. wait a moment.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;The config of the server[{}] has not been updated or is out of date. Wait for 30s to listen for changes again.&quot;, server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // No data update on the server side, just wait 30s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadUtils.sleep(TimeUnit.SECONDS, 30);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>From the code, we can see that the <code>admin</code> side provides the interface to get the full amount of data is <code>/configs/fetch</code>, so we will not go further here and put it in the later analysis.</p><p>If you get the result data from <code>admin</code> and update it successfully, then this method is finished. If there is no successful update, then it is possible that there is no data update on the server side, so wait <code>30s</code>.</p><p>Here you need to explain in advance, the gateway in determining whether the update is successful, there is a comparison of the data operation, immediately mentioned.</p><ul><li>HttpSyncDataService#updateCacheWithJson()</li></ul><p>Update the data in the gateway memory. Use <code>GSON</code> for deserialization, take the real data from the property <code>data</code> and give it to <code>DataRefreshFactory</code> to do the update.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean updateCacheWithJson(final String json) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Using GSON for deserialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject jsonObject = GSON.fromJson(json, JsonObject.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // if the config cache will be updated?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory.executor(jsonObject.getAsJsonObject(&quot;data&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataRefreshFactory#executor()</li></ul><p>Update the data according to different data types and return the updated result. The specific update logic is given to the <code>dataRefresh.refresh()</code> method. In the update result, one of the data types is updated, which means that the operation has been updated.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class DataRefreshFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean executor(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Boolean&gt; result = ENUM_MAP.values().parallelStream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(dataRefresh -&gt; dataRefresh.refresh(data))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // one of the data types is updated, which means that the operation has been updated.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.stream().anyMatch(Boolean.TRUE::equals);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#refresh()</li></ul><p>The data update logic uses the template method design pattern, where the generic operation is done in the abstract method and the different implementation logic is done by subclasses. 5 data types have some differences in the specific update logic, but there is also a common update logic, and the class diagram relationship is as follows.</p><p><img src="/assets/images/data-refresh-a5628c71ea221ffb0a7a45f4ed40ae0e.png"></p><p>In the generic <code>refresh()</code> method, it is responsible for data type conversion, determining whether an update is needed, and the actual data refresh operation.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataRefresh&lt;T&gt; implements DataRefresh {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean refresh(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // convert data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject jsonObject = convert(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(jsonObject)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean updated = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigData&lt;T&gt; result = fromJson(jsonObject);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // does it need to be updated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.updateCacheIfNeed(result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updated = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // real update logic, data refresh operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            refresh(result.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return updated;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#updateCacheIfNeed()</li></ul><p>The process of data conversion, which is based on different data types, we will not trace further to see if the data needs to be updated logically. The method name is <code>updateCacheIfNeed()</code>, which is implemented by method overloading.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataRefresh&lt;T&gt; implements DataRefresh {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // result is data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract boolean updateCacheIfNeed(ConfigData&lt;T&gt; result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // newVal is the latest value obtained</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // What kind of data type is groupEnum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean updateCacheIfNeed(final ConfigData&lt;T&gt; newVal, final ConfigGroupEnum groupEnum) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If it is the first time, then it is put directly into the cache and returns true, indicating that the update was made this time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (GROUP_CACHE.putIfAbsent(groupEnum, newVal) == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResultHolder holder = new ResultHolder(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        GROUP_CACHE.merge(groupEnum, newVal, (oldVal, value) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // md5 value is the same, no need to update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.equals(oldVal.getMd5(), newVal.getMd5())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;Get the same config, the [{}] config cache will not be updated, md5:{}&quot;, groupEnum, oldVal.getMd5());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The current cached data has been modified for a longer period than the new data and does not need to be updated.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // must compare the last update time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (oldVal.getLastModifyTime() &gt;= newVal.getLastModifyTime()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;Last update time earlier than the current configuration, the [{}] config cache will not be updated&quot;, groupEnum);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;update {} config: {}&quot;, groupEnum, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            holder.result = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return newVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return holder.result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see from the source code above, there are two cases where updates are not required.</p><ul><li>The <code>md5</code> values of both data are the same, so no update is needed;</li><li>The current cached data has been modified longer than the new data, so no update is needed.</li></ul><p>In other cases, the data needs to be updated.</p><p>At this point, we have finished analyzing the logic of the <code>start()</code> method to get the full amount of data for the first time, followed by the long polling operation. For convenience, I will paste the <code>start()</code> method once more.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It could be initialized multiple times, so you need to control that.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch all group configs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Initial startup, get full data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // one backend service, one thread</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ThreadPoolExecutor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // start long polling, each server creates a thread to listen for changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="232-execute-long-polling-task"></a>2.3.2 Execute Long Polling Task<a class="hash-link" href="#232-execute-long-polling-task" title="Direct link to heading">#</a></h5><ul><li>HttpLongPollingTask#run()</li></ul><p>The long polling task is <code>HttpLongPollingTask</code>, which implements the <code>Runnable</code> interface and the task logic is in the <code>run()</code> method. The task is executed continuously through a <code>while()</code> loop, i.e., long polling. There are three retries in each polling logic, one polling task fails, wait <code>5s</code> and continue, <code>3</code> times all fail, wait <code>5</code> minutes and try again.</p><p>Start long polling, an <code>admin</code> service, and create a thread for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class HttpLongPollingTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpLongPollingTask(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.server = server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // long polling</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (RUNNING.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Default retry 3 times</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int retryTimes = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int time = 1; time &lt;= retryTimes; time++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doLongPolling(server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (time &lt; retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.warn(&quot;Long polling failed, tried {} times, {} times left, will be suspended for a while! {}&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                time, retryTimes - time, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // long polling failed, wait 5s and continue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ThreadUtils.sleep(TimeUnit.SECONDS, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // print error, then suspended for a while.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Long polling failed, try again after 5 minutes!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 3 次都失败了，等 5 分钟再试</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ThreadUtils.sleep(TimeUnit.MINUTES, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.warn(&quot;Stop http long polling.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doLongPolling()</li></ul><p>Core logic for performing long polling tasks.</p><ul><li>Assembling request parameters based on data types: <code>md5</code> and <code>lastModifyTime</code>.</li><li>Assembling the request header and request body.</li><li>Launching a request to <code>admin</code> to determine if the group data has changed.</li><li>Based on the group that has changed, go back and get the data.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doLongPolling(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build request params: md5 and lastModifyTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;(8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;?&gt; cacheConfig = factory.cacheConfigData(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cacheConfig != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                String value = String.join(&quot;,&quot;, cacheConfig.getMd5(), String.valueOf(cacheConfig.getLastModifyTime()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                params.put(group.name(), Lists.newArrayList(value));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build request head and body</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpHeaders headers = new HttpHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set accessToken</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.set(Constants.X_ACCESS_TOKEN, this.accessTokenManager.getAccessToken());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(params, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String listenerUrl = server + Constants.SHENYU_ADMIN_PATH_CONFIGS_LISTENER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonArray groupJson;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Initiate a request to admin to determine if the group data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Here it just determines whether a group has changed or not</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String json = this.restTemplate.postForEntity(listenerUrl, httpEntity, String.class).getBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;listener result: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            JsonObject responseFromServer = GsonUtils.getGson().fromJson(json, JsonObject.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            groupJson = responseFromServer.getAsJsonArray(&quot;data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String message = String.format(&quot;listener configs fail, server:[%s], %s&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Depending on the group where the change occurred, go back and get the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * The official website explains here.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * After the gateway receives the response message, it only knows which Group has made the configuration change, and it still needs to request the configuration data of that Group again.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * There may be a question here: why not write out the changed data directly?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * We also discussed this issue in depth during development, because the http long polling mechanism can only guarantee quasi-real time, if the processing at the gateway layer is not timely, * or the administrator frequently updates the configuration, it is very difficult to get the information from the gateway layer.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If it is not processed in time at the gateway level, or if the administrator updates the configuration frequently, it is very likely to miss the push of a configuration change, so for security reasons, we only inform a group that the information has changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *For security reasons, we only notify a group of changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Personal understanding.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If the change data is written out directly, when the administrator frequently updates the configuration, the first update will remove the client from the blocking queue and return the response information to the gateway.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If a second update is made at this time, the current client is not in the blocking queue, so this time the change is missed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * The same is true for untimely processing by the gateway layer.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * This is a long polling, one gateway one synchronization thread, there may be time consuming process.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * If the admin has data changes, the current gateway client is not in the blocking queue and will not get the data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (groupJson != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch group configuration async.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigGroupEnum[] changedGroups = GSON.fromJson(groupJson, ConfigGroupEnum[].class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ArrayUtils.isNotEmpty(changedGroups)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;Group config changed: {}&quot;, Arrays.toString(changedGroups));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Proactively get the changed data from admin, depending on the grouping, and take the data in full</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.doFetchGroupConfig(server, changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(groupJson) &amp;&amp; groupJson.size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch group configuration async.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigGroupEnum[] changedGroups = GsonUtils.getGson().fromJson(groupJson, ConfigGroupEnum[].class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;Group config changed: {}&quot;, Arrays.toString(changedGroups));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Proactively get the changed data from admin, depending on the grouping, and take the data in full</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.doFetchGroupConfig(server, changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One special point needs to be explained here: In the long polling task, why don&#x27;t you get the changed data directly? Instead, we determine which group data has been changed, and then request <code>admin</code> again to get the changed data?</p><p>The official explanation here is.</p><blockquote><p>After the gateway receives the response information, it only knows which Group has changed its configuration, and it needs to request the configuration data of that Group again.
There may be a question here: Why not write out the changed data directly?
We have discussed this issue in depth during development, because the <code>http</code> long polling mechanism can only guarantee quasi-real time, and if it is not processed in time at the gateway layer, it will be very difficult to update the configuration data.
If the gateway layer is not processed in time, or the administrator updates the configuration frequently, it is likely to miss the push of a configuration change, so for security reasons, we only inform a group that the information has changed.</p></blockquote><p>My personal understanding is that.</p><blockquote><p>If the change data is written out directly, when the administrator updates the configuration frequently, the first update will remove the <code>client</code> from blocking queue and return the response information to the gateway. If a second update is made at this time, then the current <code>client</code> is not in the blocking queue, so this time the change is missed. The same is true for the gateway layer&#x27;s untimely processing. This is a long polling, one gateway one synchronization thread, there may be a time-consuming process. If <code>admin</code> has data changes, the current gateway client is not in the blocking queue and will not get the data.</p></blockquote><p>We have not yet analyzed the processing logic of the <code>admin</code> side, so let&#x27;s talk about it roughly. At the <code>admin</code> end, the gateway <code>client</code> will be put into the blocking queue, and when there is a data change, the gateway <code>client</code> will come out of the queue and send the change data. So, if the gateway <code>client</code> is not in the blocking queue when there is a data change, then the current changed data is not available.</p><p>When we know which grouping data has changed, we actively get the changed data from <code>admin</code> again, and get the data in full depending on the grouping. The call method is <code>doFetchGroupConfig()</code>, which has been analyzed in the previous section.</p><p>At this point of analysis, the data synchronization operation on the gateway side is complete. The long polling task is to keep making requests to <code>admin</code> to see if the data has changed, and if any group data has changed, then initiate another request to <code>admin</code> to get the changed data, and then update the data in the gateway&#x27;s memory.</p><p>Long polling task flow at the gateway side.</p><p><img src="/assets/images/http-long-polling-sequence-en-f767de4dee173a720d632db5c800e147.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-admin-data-sync"></a>3. Admin Data Sync<a class="hash-link" href="#3-admin-data-sync" title="Direct link to heading">#</a></h3><p>From the previous analysis, it can be seen that the gateway side mainly calls two interfaces of <code>admin</code>.</p><ul><li><code>/configs/listener</code>: determine whether the group data has changed.</li><li><code>/configs/fetch</code>: get the changed group data.</li></ul><p>If we analyze directly from these two interfaces, some parts may not be well understood, so let&#x27;s start analyzing the data synchronization process from the <code>admin</code> startup process.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-load-configuration"></a>3.1 Load Configuration<a class="hash-link" href="#31-load-configuration" title="Direct link to heading">#</a></h4><p>If the following configuration is done in the configuration file <code>application.yml</code>, it means that the data synchronization is done by <code>http long polling</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the program starts, the configuration of the data synchronization class is loaded through <code>springboot</code> conditional assembly. In this process, <code>HttpLongPollingDataChangedListener</code> is created to handle the implementation logic related to long polling.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronization configuration class</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Conditional assembly via springboot</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * http long polling.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;shenyu.sync.http.enabled&quot;, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(HttpSyncProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class HttpLongPollingListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public HttpLongPollingDataChangedListener httpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new HttpLongPollingDataChangedListener(httpSyncProperties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-data-change-listener-instantiation"></a>3.2 Data change listener instantiation<a class="hash-link" href="#32-data-change-listener-instantiation" title="Direct link to heading">#</a></h4><ul><li>HttpLongPollingDataChangedListener</li></ul><p>The data change listener is instantiated and initialized by means of a constructor. In the constructor, a blocking queue is created to hold clients, a thread pool is created to execute deferred tasks and periodic tasks, and information about the properties of long polling is stored.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // default client (here is the gateway) 1024</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.clients = new ArrayBlockingQueue&lt;&gt;(1024);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create thread pool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ScheduledThreadPoolExecutor can perform delayed tasks, periodic tasks, and normal tasks</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.scheduler = new ScheduledThreadPoolExecutor(1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuThreadFactory.create(&quot;long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // http sync properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.httpSyncProperties = httpSyncProperties;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In addition, it has the following class diagram relationships.</p><p><img src="/assets/images/data-changed-listener-1c8e4c0f4279cdb33b27c52cc933cac5.png"></p><p>The <code>InitializingBean</code> interface is implemented, so the <code>afterInitialize()</code> method is executed during the initialization of the <code>bean</code>. Execute periodic tasks via thread pool: updating the data in memory <code>(CACHE)</code> is executed every <code>5</code> minutes and starts after <code>5</code> minutes. Refreshing the local cache is reading data from the database to the local cache (in this case the memory), done by <code>refreshLocalCache()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * is called in the afterPropertiesSet() method of the InitializingBean interface, which is executed during the initialization of the bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void afterInitialize() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long syncInterval = httpSyncProperties.getRefreshInterval().toMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Periodically check the data for changes and update the cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Execution cycle task: Update data in memory (CACHE) is executed every 5 minutes and starts after 5 minutes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Prevent the admin from starting up first for a while and then generating data; then the gateway doesn&#x27;t get the full amount of data when it first connects</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.scheduleWithFixedDelay(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.info(&quot;http sync strategy refresh config start.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Read data from database to local cache (in this case, memory)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.refreshLocalCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.info(&quot;http sync strategy refresh config success.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;http sync strategy refresh config error!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, syncInterval, syncInterval, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;http sync strategy refresh interval: {}ms&quot;, syncInterval);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>refreshLocalCache()</li></ul><p>Update for each of the 5 data types.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Read data from database to local cache (in this case, memory)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void refreshLocalCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateAppAuthCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateRuleCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateSelectorCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //update meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateMetaDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of the 5 update methods is similar, call the <code>service</code> method to get the data and put it into the memory <code>CACHE</code>. Take the updateRuleData method <code>updateRuleCache()</code> for example, pass in the rule enumeration type and call <code>ruleService.listAll()</code> to get all the rule data from the database.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Update rule cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateRuleCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateCache(ConfigGroupEnum.RULE, ruleService.listAll());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>updateCache()</li></ul><p>Update the data in memory using the data in the database.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // cache Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static final ConcurrentMap&lt;String, ConfigDataCache&gt; CACHE = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * if md5 is not the same as the original, then update lcoal cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param group ConfigGroupEnum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt; the type of class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the new config data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected &lt;T&gt; void updateCache(final ConfigGroupEnum group, final List&lt;T&gt; data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // data serialization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // pass in md5 value and modification time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache newVal = new ConfigDataCache(group.name(), json, Md5Utils.md5(json), System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update group data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache oldVal = CACHE.put(newVal.getGroup(), newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;update config cache[{}], old: {}, updated: {}&quot;, group, oldVal, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The initialization process is to start periodic tasks to update the memory data by fetching data from the database at regular intervals.</p><p>Next, we start the analysis of two interfaces.</p><ul><li><code>/configs/listener</code>: determines if the group data has changed.</li><li><code>/configs/fetch</code>: fetching the changed group data.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33--data-change-polling-interface"></a>3.3  Data change polling interface<a class="hash-link" href="#33--data-change-polling-interface" title="Direct link to heading">#</a></h4><ul><li><code>/configs/listener</code>: determines if the group data has changed.</li></ul><p>The interface class is <code>ConfigController</code>, which only takes effect when using <code>http long polling</code> for data synchronization. The interface method <code>listener()</code> has no other logic and calls the <code>doLongPolling()</code> method directly.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * This Controller only when HttpLongPollingDataChangedListener exist, will take effect.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.longPollingListener = longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Omit other logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Listen for data changes and perform long polling</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request  the request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response the response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(value = &quot;/listener&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void listener(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        longPollingListener.doLongPolling(request, response);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#doLongPolling()</li></ul><p>Perform long polling tasks: If there are data changes, they will be responded to the client (in this case, the gateway side) immediately. Otherwise, the client will be blocked until there is a data change or a timeout.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpLongPollingDataChangedListener extends AbstractDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Execute long polling: If there is a data change, it will be responded to the client (here is the gateway side) immediately.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Otherwise, the client will otherwise remain blocked until there is a data change or a timeout.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doLongPolling(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // compare group md5</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Compare the md5, determine whether the data of the gateway and the data of the admin side are consistent, and get the data group that has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConfigGroupEnum&gt; changedGroup = compareChangedGroup(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String clientIp = getRemoteIp(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // response immediately.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Immediate response to the gateway if there is changed data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(changedGroup)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.generateResponse(response, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Log.info(&quot;send response with the changed group, ip={}, group={}&quot;, clientIp, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // No change, then the client (in this case the gateway) is put into the blocking queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // listen for configuration changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final AsyncContext asyncContext = request.startAsync();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // AsyncContext.settimeout() does not timeout properly, so you have to control it yourself</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncContext.setTimeout(0L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // block client&#x27;s thread.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.execute(new LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#compareChangedGroup()</li></ul><p>To determine whether the group data has changed, the judgment logic is to compare the <code>md5</code> value and <code>lastModifyTime</code> at the gateway side and the <code>admin</code> side.</p><ul><li>If the <code>md5</code> value is different, then it needs to be updated.</li><li>If the <code>lastModifyTime</code> on the <code>admin</code> side is greater than the <code>lastModifyTime</code> on the gateway side, then it needs to be updated.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Determine if the group data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;ConfigGroupEnum&gt; compareChangedGroup(final HttpServletRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConfigGroupEnum&gt; changedGroup = new ArrayList&lt;&gt;(ConfigGroupEnum.values().length);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The md5 value and lastModifyTime of the data on the gateway side</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] params = StringUtils.split(request.getParameter(group.name()), &#x27;,&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (params == null || params.length != 2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuException(&quot;group param invalid:&quot; + request.getParameter(group.name()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String clientMd5 = params[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long clientModifyTime = NumberUtils.toLong(params[1]);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigDataCache serverCache = CACHE.get(group.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // do check. determine if the group data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.checkCacheDelayAndUpdate(serverCache, clientMd5, clientModifyTime)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changedGroup.add(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return changedGroup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>LongPollingClient</li></ul><p>No change data, then the client (in this case the gateway) is put into the blocking queue. The blocking time is 60 seconds, i.e. after 60 seconds remove and respond to the client.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class LongPollingClient implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // omitted other logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Removal after 60 seconds and response to the client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.asyncTimeoutFuture = scheduler.schedule(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    clients.remove(LongPollingClient.this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;ConfigGroupEnum&gt; changedGroups = compareChangedGroup((HttpServletRequest) asyncContext.getRequest());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendResponse(changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, timeoutTime, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Add to blocking queue</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.add(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;add long polling client error&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Send response.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param changedGroups the changed groups</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        void sendResponse(final List&lt;ConfigGroupEnum&gt; changedGroups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // cancel scheduler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (null != asyncTimeoutFuture) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                asyncTimeoutFuture.cancel(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Groups responding to changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            generateResponse((HttpServletResponse) asyncContext.getResponse(), changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            asyncContext.complete();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34--get-change-data-interface"></a>3.4  Get Change Data Interface<a class="hash-link" href="#34--get-change-data-interface" title="Direct link to heading">#</a></h4><ul><li><code>/configs/fetch</code>: get change data;</li></ul><p>Get the grouped data and return the result according to the parameters passed in by the gateway. The main implementation method is <code>longPollingListener.fetchConfig()</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigController(final HttpLongPollingDataChangedListener longPollingListener) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.longPollingListener = longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Fetch configs shenyu result.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupKeys the group keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the shenyu result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/fetch&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult fetchConfigs(@NotNull final String[] groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ConfigData&lt;?&gt;&gt; result = Maps.newHashMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String groupKey : groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;?&gt; data = longPollingListener.fetchConfig(ConfigGroupEnum.valueOf(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.put(groupKey, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.SUCCESS, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Other interfaces are omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataChangedListener#fetchConfig()</li></ul><p>Data fetching is taken directly from <code>CACHE</code>, and then matched and encapsulated according to different grouping types.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataChangedListener implements DataChangedListener, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * fetch configuration from cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupKey the group key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the configuration data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigData&lt;?&gt; fetchConfig(final ConfigGroupEnum groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get data from CACHE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache config = CACHE.get(groupKey.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, AppAuthData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case PLUGIN: // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case RULE:   // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, RuleData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case SELECTOR:  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, SelectorData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case META_DATA: // meta data </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildConfigData(config, MetaData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:  // other data type, throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new IllegalStateException(&quot;Unexpected groupKey: &quot; + groupKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="35-data-change"></a>3.5 Data Change<a class="hash-link" href="#35-data-change" title="Direct link to heading">#</a></h4><p>In the previous <code>websocket</code> data synchronization and <code>zookeeper</code> data synchronization source code analysis article, we know that the <code>admin</code> side data synchronization design structure is as follows.</p><p><img src="/assets/images/data-changed-listener-admin-2f384e703652e9e28db8447b1cbdaea7.png"></p><p>Various data change listeners are subclasses of <code>DataChangedListener</code>.</p><p>When the data is modified on the <code>admin</code> side, event notifications are sent through the <code>Spring</code> event handling mechanism. The sending logic is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Event forwarders, which forward the changed events to each ConfigEventListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data change event distributor: synchronize the change data to ShenYu gateway when there is a data change in admin side</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data changes rely on Spring&#x27;s event-listening mechanism: ApplicationEventPublisher --&gt; ApplicationEvent --&gt; ApplicationListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // other logic omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Call this method when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listeners (it&#x27;s generally good to use a kind of data synchronization)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // pull and save API document on seletor changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other data type, throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Suppose, the plugin information is modified and the data is synchronized by <code>http long polling</code>, then the actual call to <code>listener.onPluginChanged()</code> is <code>org.apache.shenyu.admin.listener. AbstractDataChangedListener#onPluginChanged</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * In the operation of the admin, there is an update of the plugin occurred</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param changed   the changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param eventType the event type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(changed)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update CACHE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // execute change task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.afterPluginChanged(changed, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There are two processing operations, one is to update the memory <code>CACHE</code>, which was analyzed earlier, and the other is to execute the change task, which is executed in the thread pool.</p><ul><li>HttpLongPollingDataChangedListener#afterPluginChanged()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void afterPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // execute by thread pool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.execute(new DataChangeTask(ConfigGroupEnum.PLUGIN));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataChangeTask</li></ul><p>Data change task: remove the clients in the blocking queue in turn and send a response to notify the gateway that a group of data has changed.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class DataChangeTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //other logic omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If the client in the blocking queue exceeds the given value of 100, it is executed in batches</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clients.size() &gt; httpSyncProperties.getNotifyBatchSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;LongPollingClient&gt; targetClients = new ArrayList&lt;&gt;(clients.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.drainTo(targetClients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;List&lt;LongPollingClient&gt;&gt; partitionClients = Lists.partition(targetClients, httpSyncProperties.getNotifyBatchSize());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // batch execution</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                partitionClients.forEach(item -&gt; scheduler.execute(() -&gt; doRun(item)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // execute task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                doRun(clients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void doRun(final Collection&lt;LongPollingClient&gt; clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Notify all clients that a data change has occurred</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Iterator&lt;LongPollingClient&gt; iter = clients.iterator(); iter.hasNext();) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LongPollingClient client = iter.next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                iter.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // send response to client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.sendResponse(Collections.singletonList(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Log.info(&quot;send response with the changed group,ip={}, group={}, changeTime={}&quot;, client.ip, groupKey, changeTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, the data synchronization logic on the <code>admin</code> side is analyzed. In the <code>http long polling</code> based data synchronization is, it has three main functions.</p><ul><li>providing a data change listening interface.</li><li>providing the interface to get the changed data.</li><li>When there is a data change, remove the client in the blocking queue and respond to the result.</li></ul><p>Finally, three diagrams describe the long polling task flow on the <code>admin</code> side.</p><ul><li><code>/configs/listener</code> data change listener interface.</li></ul><p><img src="/assets/images/http-long-polling-listener-en-e979b81dc72024abd7ca3c2258bdaeec.png"></p><ul><li><code>/configs/fetch</code> fetch change data interface.</li></ul><p><img src="/assets/images/http-long-polling-fetch-en-85412d758bccd904e0f798b12d0d19de.png"></p><ul><li>Update data in the admin backend management system for data synchronization.</li></ul><p><img src="/assets/images/http-long-polling-admin-update-en-f0892e8f170561e4237d2d89b07a3bc5.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-summary"></a>4. Summary<a class="hash-link" href="#4-summary" title="Direct link to heading">#</a></h3><p>This article focuses on the source code analysis of <code>http long polling</code> data synchronization in the <code>ShenYu</code> gateway. The main knowledge points involved are as follows.</p><ul><li><code>http long polling</code> is initiated by the gateway side, which constantly requests the <code>admin</code> side.</li><li>change data at group granularity (authentication information, plugins, selectors, rules, metadata).</li><li><code>http long polling</code> results in getting only the change group, and another request needs to be initiated to get the group data.</li><li>Whether the data is updated or not is determined by the <code>md5</code> value and the modification time <code>lastModifyTime</code>.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/http">http</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Http Long Polling Data Synchronization Source Code Analysis" href="/blog/DataSync-SourceCode-Analysis-Http-Data-Sync"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/E2eTest-Analysis">E2e Test Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.307Z">September 28, 2024</time> · 8 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/HaiqiQin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/80969210?v=4" alt="Haiqi Qin"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/HaiqiQin" target="_blank" rel="noopener noreferrer">Haiqi Qin</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>This article will conduct an in-depth analysis of Apache ShenYu e2e module.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-is-e2e"></a>what is e2e<a class="hash-link" href="#what-is-e2e" title="Direct link to heading">#</a></h3><p>e2e (end to end), also known as end-to-end testing, is a method used to test whether the application flow performs as designed from the beginning to the end. The purpose of performing end-to-end testing is to identify system dependencies and ensure that the correct information is passed between various system components and systems. The purpose of end-to-end testing is to test the entire software for dependencies, data integrity, and communication with other systems, interfaces, and databases to simulate a complete production scenario.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="advantages-of-e2e"></a>Advantages of e2e<a class="hash-link" href="#advantages-of-e2e" title="Direct link to heading">#</a></h3><p>e2e testing can test the integrity and accuracy of software systems in simulated real user scenarios, and can verify whether the entire system works as expected and whether different components can work together. There are several benefits of e2e testing:</p><ol><li>Help ensure the correctness of system functions.e2e testing can simulate the interaction and operation in real user scenarios, verify whether the entire system can work as expected, and help discover potential problems and defects in the system.</li><li>Improve test coverage.e2e testing can cover the entire system, including front-end, back-end, database and other different levels and components, thereby improving test coverage and ensuring comprehensiveness and accuracy of testing.</li><li>Ensure the stability of the system.e2e testing can check the stability and robustness of the system in various situations, including system response time, error handling capabilities, concurrency, etc., to help ensure that the system is in the face of high load and abnormal conditions Still able to maintain stable operation.</li><li>Reduce testing cost.e2e testing can improve testing efficiency and accuracy, reduce testing cost and time, and thus help enterprises release and deliver high-quality software products more quickly.</li></ol><p>In short, e2e testing is a comprehensive testing method that can verify whether the entire system works as expected, improve test coverage and test efficiency, thereby ensuring the stability and correctness of the system, and reducing testing costs and time. And effective testing methods, so we need to improve e2e related codes.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-implement-automated-e2e-testing"></a>How to implement automated e2e testing<a class="hash-link" href="#how-to-implement-automated-e2e-testing" title="Direct link to heading">#</a></h3><p>In Apache ShenYu, the main steps of e2e testing are reflected in the script of the GitHub Action workflow, as shown below, the script is located at <a href="https://github.com/apache/incubator-shenyu/tree/master/.github/workflows" target="_blank" rel="noopener noreferrer">~/.github/workflows</a> directory in the e2e file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> e2e</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> master</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">changes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build-docker-images</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">e2e-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">e2e-case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">needs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">images</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> needs.changes.outputs.e2e == &#x27;true&#x27; </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matrix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-e2e-case-spring-cloud&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-e2e-case-apache-dubbo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-e2e-case-sofa&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Load ShenYu Docker Images</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          docker load --input /tmp/apache-shenyu-admin.tar</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          docker load --input /tmp/apache-shenyu-bootstrap.tar</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          docker image ls -a</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build examples with Maven</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pexample </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.javadoc.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.test.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples/pom.xml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run ShenYu E2E Tests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mysql</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          bash ./shenyu-e2e/script/storage_init.sh</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          ./mvnw -B -f ./shenyu-e2e/pom.xml -pl shenyu-e2e-case/${{ matrix.case }} -Dstorage=mysql test</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the workflow is triggered, use the dockerfile under the shenyu-dist module to build and upload the images of the admin and bootstrap projects. When the e2e test module is running, the admin and bootstrap images can be loaded. Then build the modules in the examples, and finally execute the test method of the corresponding test module.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-run-e2e-test-locally"></a>How to run e2e test locally<a class="hash-link" href="#how-to-run-e2e-test-locally" title="Direct link to heading">#</a></h3><p>If you need to write e2e test cases, you first need to code and debug locally. Currently e2e supports two startup methods, one is docker startup and the other is host startup. These two modes can be switched in the @ShenYuTest annotation in the test class. The host startup method directly starts the services that need to be started locally to run the test code. Before using docker to start, you need to build the corresponding image first. Because ShenYu currently needs to support e2e testing in the github workflow, it is recommended to use the docker startup method.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="analysis-of-e2e-startup-process"></a>Analysis of e2e startup process<a class="hash-link" href="#analysis-of-e2e-startup-process" title="Direct link to heading">#</a></h3><p>Currently, the e2e module is mainly divided into four parts: case, client, common and engine.</p><p><img alt="e2e-modules" src="/assets/images/e2e-modules-1ff1ff840f0fe5a53970e750624f61b6.png"></p><p>The case module stores the test cases of the plug-in, and the client module writes the clients of admin and gateway to request corresponding interfaces. Common stores some public classes, and the engine module is the core of the framework. Relying on the testcontainer framework, use java code to start the docker container and complete the configuration operations for admin and gatewat.</p><p>Next, I will analyze the e2e startup process based on the source code.</p><p>When we execute the test method in the case, the @ShenYuTest annotation will take effect and extend the test class. Through @ShenYuTest, we can choose the startup method, configure related parameters for admin and gateway, and choose the docker-compose file to be executed. For admin and gateway, you can configure the user name, password, data synchronization method and modify the content of yaml required for login.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@ShenYuTest(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mode = ShenYuEngineConfigure.Mode.DOCKER,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        services = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @ShenYuTest.ServiceConfigure(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        serviceName = &quot;admin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        port = 9095,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        baseUrl = &quot;http://{hostname:localhost}:9095&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        parameters = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @ShenYuTest.Parameter(key = &quot;username&quot;, value = &quot;admin&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @ShenYuTest.Parameter(key = &quot;password&quot;, value = &quot;123456&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @ShenYuTest.Parameter(key = &quot;dataSyn&quot;, value = &quot;admin_websocket&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @ShenYuTest.ServiceConfigure(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        serviceName = &quot;gateway&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        port = 9195,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        baseUrl = &quot;http://{hostname:localhost}:9195&quot;, </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        type = ShenYuEngineConfigure.ServiceType.SHENYU_GATEWAY,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        parameters = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          @ShenYuTest.Parameter(key = &quot;application&quot;, value =  &quot;spring.cloud.discovery.enabled:true,eureka.client.enabled:true&quot;), </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          @ShenYuTest.Parameter(key = &quot;dataSyn&quot;, value = &quot;gateway_websocket&quot;)})},           </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        dockerComposeFile = &quot;classpath:./docker-compose.mysql.yml&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>@ShenYuTest is extended through the ShenYuExtension class, and the configuration of admin and gateway takes effect in beforeAll in ShenYuExtension. The specific effective logic is implemented in the DockerServiceCompose class.</p><p><img alt="e2e-shenyutest" src="/assets/images/e2e-shenyutest-8ea26c9ea373d2c182be8d19c53cb021.png"></p><p><img alt="e2e-beforeall" src="/assets/images/e2e-beforeall-51fdb9d49dbc3eae99f77268b0e1a5c9.png"></p><p>@ShenYuTest configuration items take effect before docker starts, mainly by modifying the yaml file in the resource directory of the test module. Currently, e2e supports testing of different data synchronization methods. The principle is to use the chooseDataSyn method in the DockerServiceCompose class. In the DataSyncHandler, initialize the content that needs to be modified in various data synchronization methods, and finally start the container.</p><p><img alt="e2e-docer-service-compose" src="/assets/images/e2e-docer-service-compose-ac329d9290f48407e5c8310031913fb2.png"></p><p><img alt="e2e-datahandle-syn" src="/assets/images/e2e-datahandle-syn-92a7b3dc57bc8b46972128042b8281cb.png"></p><p>When docker is started, start testing the plug-in function. In the PluginsTest class, there are pre- and post-operations for testing.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @BeforeAll</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void setup(final AdminClient adminClient, final GatewayClient gatewayClient) throws InterruptedException, JsonProcessingException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        adminClient.login();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread.sleep(10000);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorDTO&gt; selectorDTOList = adminClient.listAllSelectors();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;MetaDataDTO&gt; metaDataDTOList = adminClient.listAllMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleDTO&gt; ruleDTOList = adminClient.listAllRules();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(2, selectorDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(13, metaDataDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(14, ruleDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorDTO selectorDTO : selectorDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (selectorDTO.getHandle() != null &amp;&amp; !&quot;&quot;.equals(selectorDTO.getHandle())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SpringCloudPluginCases.verifierUri(selectorDTO.getHandle());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;MetaData&gt; metaDataCacheList = gatewayClient.getMetaDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorCacheData&gt; selectorCacheList = gatewayClient.getSelectorCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleCacheData&gt; ruleCacheList = gatewayClient.getRuleCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(2, selectorCacheList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(13, metaDataCacheList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(14, ruleCacheList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MultiValueMap&lt;String, String&gt; formData = new LinkedMultiValueMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;id&quot;, &quot;8&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;name&quot;, &quot;springCloud&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;enabled&quot;, &quot;true&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;role&quot;, &quot;Proxy&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        formData.add(&quot;sort&quot;, &quot;200&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        adminClient.changePluginStatus(&quot;8&quot;, formData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String id = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorDTO selectorDTO : selectorDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!&quot;&quot;.equals(selectorDTO.getHandle())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                id = selectorDTO.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        adminClient.deleteSelectors(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTOList = adminClient.listAllSelectors();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(1, selectorDTOList.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Taking the springcloud plug-in as an example, you first need to test whether the registration center and data synchronization can work normally, then start the plug-in and delete the existing selector. To test whether the data is successfully registered into the registration center, you can call the interface of the admin client to test, and to test whether the data synchronization is successful, you can obtain the cache of the gateway for testing.</p><p>Then run the test case in the case file and get the use case through @ShenYuScenario.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenYuScenario(provider = SpringCloudPluginCases.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void testSpringCloud(GatewayClient gateway, CaseSpec spec) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec.getVerifiers().forEach(verifier -&gt; verifier.verify(gateway.getHttpRequesterSupplier().get()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For different plug-ins, we can build a Case class to store the rules to be tested. All test rules are stored in the list and tested in order. Build selectors and rules in beforeEachSpec, caseSpec stores test entities, if they meet the uri rules, they should exist, otherwise they don’t exist. We need to simulate users to add selectors and rules, because the handler rules of the selectors of each plug-in are not necessarily the same, so we need to write its handle class according to the plug-in requirements. And verify that it complies with the rules with the request. Specific test cases are mainly divided into two categories, one is to match uri rules, such as euqal, path_pattern, start_with, end_with, and the other is request types, such as get, put, post, delete.</p><p>When all eight matching conditions are tested, it can be judged that the plug-in function is normal. After the test, we need to restore the environment, delete all selectors, set the plug-in to unavailable, and finally close all containers.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;ScenarioSpec&gt; get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Lists.newArrayList(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithUriEquals(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithUriPathPattern(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithUriStartWith(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithEndWith(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodGet(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodPost(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodPut(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                testWithMethodDelete()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenYuScenarioSpec testWithUriEquals() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenYuScenarioSpec.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(&quot;single-spring-cloud uri =]&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .beforeEachSpec(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenYuBeforeEachSpec.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addSelectorAndRule(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        newSelectorBuilder(&quot;selector&quot;, Plugin.SPRING_CLOUD)                                               .handle(SpringCloudSelectorHandle.builder().serviceId(&quot;springCloud-test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        .gray(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        .divideUpstreams(DIVIDE_UPSTREAMS).build())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .conditionList(newConditions(Condition.ParamType.URI, Condition.Operator.EQUAL, TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .build(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        newRuleBuilder(&quot;rule&quot;)                               .handle(SpringCloudRuleHandle.builder().loadBalance(&quot;hash&quot;).timeout(3000).build())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .conditionList(newConditions(Condition.ParamType.URI, Condition.Operator.EQUAL, TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                )</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .checker(notExists(TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .waiting(exists(TEST))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .caseSpec(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenYuCaseSpec.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addExists(TEST)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addNotExists(&quot;/springcloud/te&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addNotExists(&quot;/put&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .addNotExists(&quot;/get&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .build()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                )</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .afterEachSpec(ShenYuAfterEachSpec.DEFAULT)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/e-2-e-test">E2e Test</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about E2e Test Analysis" href="/blog/E2eTest-Analysis"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeper Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.307Z">September 28, 2024</time> · 18 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>etcd</code> and <code>Consul</code>. The main content of this article is based on <code>WebSocket</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-zookeeper"></a>1. About ZooKeeper<a class="hash-link" href="#1-about-zookeeper" title="Direct link to heading">#</a></h3><p>Apache ZooKeeper is a software project of the Apache Software Foundation that provides open source distributed configuration services, synchronization services, and naming registries for large-scale distributed computing. ZooKeeper nodes store their data in a hierarchical namespace, much like a file system or a prefix tree structure. Clients can read and write on nodes and thus have a shared configuration service in this way.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>We traced the source code from a real case, such as updating a selector data in the <code>Divide</code> plugin to a weight of 90 in a background administration system:</p><p><img src="/assets/images/update-selector-en-4efb58e488bd424a54213d31929d7eb1.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-data"></a>2.1 Accept Data<a class="hash-link" href="#21-accept-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set the current selector data ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>：</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: <code>APP_AUTH</code>, <code>PLUGIN</code>, <code>RULE</code>, <code>SELECTOR</code> and <code>META_DATA</code>.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket;</li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper;</li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>：data synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>：data synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>：data synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>zookeeper</code> data synchronization source code analysis, so here to <code>ZookeeperDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data Sync Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * By springboot conditional assembly</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * zookeeper data sunc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Zookeeper listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)  // The condition property is loaded only when it is met</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(ZookeeperConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class ZookeeperListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener zookeeperDataChangedListener(final ZkClient zkClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataChangedListener(zkClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Zookeeper data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the zookeeper data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ZookeeperDataInit zookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataInit(zkClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // other code is omitted......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the SpringBoot conditional assembly class. The ZookeeperListener class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>ZooKeeper</code> is used for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     zookeeper:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          sessionTimeout: 5000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          connectionTimeout: 2000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(ZookeeperConfiguration.class)</code>：import <code>ZookeeperConfiguration</code>;</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  @EnableConfigurationProperties(ZookeeperProperties.class)  // enable zookeeper properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public class ZookeeperConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register zkClient in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zookeeperProp the zookeeper configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ZkClient {@linkplain ZkClient}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @ConditionalOnMissingBean(ZkClient.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      public ZkClient zkClient(final ZookeeperProperties zookeeperProp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ZkClient(zookeeperProp.getUrl(), zookeeperProp.getSessionTimeout(), zookeeperProp.getConnectionTimeout()); // 读取zk配置信息，并创建zkClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.zookeeper&quot;) // zookeeper properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When we take the initiative to configuration, use the <code>zookeeper</code> data synchronization, <code>zookeeperDataChangedListener</code> is generated. So in the event handler <code>onApplicationEvent()</code>, it goes to the corresponding <code>listener</code>. In our case, it is a selector data update, data synchronization is <code>zookeeper</code>, so, the code will enter the <code>ZookeeperDataChangedListener</code> selector data change process.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // what kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // other code logic is omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // In our case, will enter the ZookeeperDataChangedListener selector data change process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-zookeeper-data-changed-listener"></a>2.4 Zookeeper Data Changed Listener<a class="hash-link" href="#24-zookeeper-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>ZookeeperDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, determine the type of action, whether to refresh synchronization or update or create synchronization. Determine whether the node is in <code>zk</code> based on the current selector data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * use ZooKeeper to publish change data</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The selector information changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // refresh</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            deleteZkPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // changed data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // build selector real path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                deleteZkPath(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // selector parent path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(data.getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // create parent node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createZkNode(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert or update data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            insertZkNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create zk node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void createZkNode(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create only if it does not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(path, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // insert zk node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void insertZkNode(final String path, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create zk node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        createZkNode(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // write data by zkClient </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.writeData(path, null == data ? &quot;&quot; : GsonUtils.getInstance().toJson(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As long as the changed data is correctly written to the <code>zk</code> node, the <code>admin</code> side of the operation is complete. <code>ShenYu</code> uses <code>zk</code> for data synchronization, <code>zk</code> nodes are carefully designed.</p><p>In our current case, updating one of the selector data in the <code>Divide</code> plugin with a weight of 90 updates specific nodes in the graph.</p><p><img src="/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>We series the above update flow with a sequence diagram.</p><p><img src="/assets/images/zk-sync-sequence-admin-en-ae0fe50fed54ce6e1d66a9a0ca5ff6b7.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume that the ShenYu gateway is already running properly, and the data synchronization mode is also <code>Zookeeper</code>. How does the gateway receive and process the selector data after updating it on the admin side and sending the changed data to ZK? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-zkclient-accept-data"></a>3.1 ZkClient Accept Data<a class="hash-link" href="#31-zkclient-accept-data" title="Direct link to heading">#</a></h4><ul><li>ZkClient.subscribeDataChanges()</li></ul><p>There is a <code>ZookeeperSyncDataService</code> class on the gateway, which subscribing to the data node through <code>ZkClient</code> and can sense when the data changes.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ZookeeperSyncDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // zkClient subscribe data </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(path, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cacheSelectorData(GsonUtils.getInstance().fromJson(data.toString(), SelectorData.class)); // zk node data changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                unCacheSelectorData(dataPath);  // zk node data deleted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ZooKeeper&#x27;s  <code>Watch</code> mechanism notifies subscribing clients of node changes. In our case, updating the selector information goes to the <code>handleDataChange()</code> method. <code>cacheSelectorData()</code> is used to process data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-handle-data"></a>3.2 Handle Data<a class="hash-link" href="#32-handle-data" title="Direct link to heading">#</a></h4><ul><li>ZookeeperSyncDataService.cacheSelectorData()</li></ul><p>The data is not null, and caching the selector data is again handled by <code>PluginDataSubscriber</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code> is an interface, it is only a <code>CommonPluginDataSubscriber</code> implementation class, responsible for data processing plugin, selector and rules.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-common-plugin-data-subscriber"></a>3.3 Common Plugin Data Subscriber<a class="hash-link" href="#33-common-plugin-data-subscriber" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-data-cached-to-memory"></a>3.4 Data cached to Memory<a class="hash-link" href="#34-data-cached-to-memory" title="Direct link to heading">#</a></h4><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracking, and through a practical case, in the <code>admin</code> end to update a selector data, the <code>ZooKeeper</code> data synchronization process analysis is clear.</p><p>Let&#x27;s series the data synchronization process on the gateway side through the sequence diagram:</p><p><img src="/assets/images/zk-sync-sequence-gateway-en-b061b46cd625eef35e95dd0b3eb20a27.png"></p><p>The data synchronization process has been analyzed. In order to prevent the synchronization process from being interrupted, other logic is ignored during the analysis. We also need to analyze the process of Admin synchronization data initialization and gateway synchronization operation initialization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin-data-sync--initialization"></a>4. Admin Data Sync  initialization<a class="hash-link" href="#4-admin-data-sync--initialization" title="Direct link to heading">#</a></h3><p>When <code>admin</code> starts, the current data will be fully synchronized to <code>zk</code>, the implementation logic is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Zookeeper data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ZkClient zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine whether data exists in zk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath) &amp;&amp; !zkClient.exists(authPath) &amp;&amp; !zkClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check whether there is data in <code>zk</code>, if not, then synchronize.</p><p><code>ZookeeperDataInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>SpringBoot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> initializations and is often used for initialization operations in a project.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, and then perform full data synchronization, all authentication information, plugin information, selector information, rule information, and metadata information. Synchronous events are published primarily through <code>eventPublisher</code>. After publishing the event via <code>publishEvent()</code>, the <code>ApplicationListener</code> performs the event change operation. In <code>ShenYu</code> is mentioned in <code>DataChangedEventDispatcher</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * sync all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-gateway-data-sync-init"></a>5. Gateway Data Sync Init<a class="hash-link" href="#5-gateway-data-sync-init" title="Direct link to heading">#</a></h3><p>The initial operation of data synchronization on the gateway side is mainly the node in the subscription <code>zk</code>. When there is a data change, the changed data will be received. This relies on the <code>Watch</code> mechanism of <code>ZooKeeper</code>. In <code>ShenYu</code>, the one responsible for <code>zk</code> data synchronization is <code>ZookeeperSyncDataService</code>, also mentioned earlier.</p><p>The function logic of <code>ZookeeperSyncDataService</code> is completed in the process of instantiation: the subscription to <code>Shenyu</code> data synchronization node in <code>zk</code> is completed. Subscription here is divided into two kinds, one kind is existing node data updated above, through this <code>zkClient.subscribeDataChanges()</code> method; Another kind is under the current node, add or delete nodes change namely child nodes, it through <code>zkClient.subscribeChildChanges()</code> method.</p><p><code>ZookeeperSyncDataService</code> code is a bit too much, here we use plugin data read and subscribe to track, other types of data operation principle is the same.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *  zookeeper sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // At instantiation time, the data is read from the ZK and the node is subscribed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperSyncDataService(/* omit the construction argument */ ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch plugin, selector and rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin node path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // all plugin nodes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; pluginZKs = zkClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // watch plugin, selector, rule data node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //subscribing to child nodes (adding or removing a plugin)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeChildChanges(pluginParent, (parentPath, currentChildren) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isNotEmpty(currentChildren)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (String pluginName : currentChildren) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // you need to subscribe to all plugin, selector, and rule data for the child node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // watch rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create if not exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(pluginPath, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read the current node data on zk and deserialize it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = null == zkClient.readData(pluginPath) ? null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : GsonUtils.getInstance().fromJson((String) zkClient.readData(pluginPath), PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // cached into gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // subscribe plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private void cachePluginData(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //omit implementation logic, is actually the CommonPluginDataSubscriber operation, can connect with the front</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // subscribe data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(pluginPath, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {  // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                 //omit implementation logic, is actually the CommonPluginDataSubscriber operation, can connect with the front</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {   // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  // Omit implementation logic, is actually the CommonPluginDataSubscriber operation, can connect with the front</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above source code is given comments, I believe you can understand. The main logic for subscribing to plug-in data is as follows:</p><blockquote><ol><li>Create the current plugin path</li><li>Create a path if it does not exist</li><li>Read the current node data on zK and deserialize it</li><li>The plugin data is cached in the gateway memory</li><li>Subscribe to the plug-in node</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-summary"></a>6. Summary<a class="hash-link" href="#6-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, <code>Zookeeper</code> data synchronization principle source code analysis. The main knowledge points involved are as follows:</p><ul><li><p>Data synchronization based on <code>ZooKeeper</code> is mainly implemented through <code>watch</code> mechanism;</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of <code>SpringBoot</code> and <code>starter</code> loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/zookeeper">zookeeper</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about ZooKeeper Data Synchronization Source Code Analysis" href="/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/IntegrationTest-Analysis">Integration Test Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.307Z">September 28, 2024</time> · 7 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>This article will provide an in-depth analysis of Apache ShenYu&#x27;s integration tests.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-are-integration-tests"></a>What are integration tests?<a class="hash-link" href="#what-are-integration-tests" title="Direct link to heading">#</a></h3><p>Integration testing is also called E2E (End To End) testing in some projects. It is mainly used to test whether each module can meet expectations after being assembled into a system.</p><p>Apache ShenYu puts integration tests in continuous integration, using GitHub Actions to trigger each time a Pull Request or Merge is submitted to the main branch. This can greatly reduce the maintenance cost of the project and improve the stability of Apache ShenYu.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-automate-integration-testing"></a>How to automate integration testing?<a class="hash-link" href="#how-to-automate-integration-testing" title="Direct link to heading">#</a></h3><p>In Apache ShenYu, the main steps of integration testing are embodied in the script of the GitHub Action workflow, as shown below, which is located at <a href="https://github.com/apache/shenyu/tree/master/.github/workflows" target="_blank" rel="noopener noreferrer">~/.github/workflows</a> directory.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> it</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> master</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matrix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alibaba</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Next, I will start from this yaml file and take you to analyze the entire process of automated integration testing.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="triggering-the-workflow"></a>Triggering the workflow<a class="hash-link" href="#triggering-the-workflow" title="Direct link to heading">#</a></h3><p>Since we specified <code>pull_request</code> and <code>push.branch: master</code> in <code>on</code>, this workflow will be triggered when we submit pull_request or merge branch to master (push).</p><p>For more usage of GitHub Action, you can refer to the documentation of <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreferrer">GitHub Action</a>, which will not be introduced in detail here.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="initialize-the-environment"></a>Initialize the environment<a class="hash-link" href="#initialize-the-environment" title="Direct link to heading">#</a></h3><ul><li>pull code</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>set skip flag</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set Skip Env Var</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./.github/actions/skip</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ci</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When something unrelated to functionality occurs (such as changing documentation), integration tests are skipped to save resources.</p><ul><li>Cache maven repos, install Java</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cache Maven Repos</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="build-the-entire-project-while-building-the-docker-image"></a>Build the entire project while building the docker image<a class="hash-link" href="#build-the-entire-project-while-building-the-docker-image" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">./mvnw -B clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Prelease,docker -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Dmaven.test.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the above command, -P is followed by <code>release,docker</code>, which means that the relevant profile configuration in the pom file will be activated.</p><p>The two profiles, release and docker, currently only exist in several submodules under <code>shenyu-dist</code>. The following will take the <a href="https://github.com/apache/shenyu/tree/master/shenyu-dist/shenyu-admin-dist" target="_blank" rel="noopener noreferrer">shenyu-dist-admin</a> module as an example to introduce profiles as release and docker The specific content of the configuration. Also, integration tests only use the <code>shenyu-admin</code> image built in this step.</p><ul><li><p>First is release</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">release</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.maven.plugins</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven-assembly-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">package</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">single</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.basedir}/src/main/assembly/binary.xml</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">posix</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When -P is followed by release, the above <code>maven-assembly-plugin</code> plugin is activated. In executions, the execution timing of the plugin is bound to the maven life cycle package, which means that it will be triggered when we execute <code>mvn install</code>.</p><p>The <code>binary.xml</code> we wrote is specified in the configuration, and the <code>maven-assembly-plugin</code> plugin will copy the required files and package them according to this file. You can click the link to view the file: [shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml](<a href="https://github.com/apache/shenyu/blob/master/shenyu-" target="_blank" rel="noopener noreferrer">https://github.com/apache/shenyu/blob/master/shenyu-</a> dist/shenyu-admin-dist/src/main/assembly/binary.xml)</p><p>According to this file, the plugin will &quot;copy&quot; the packaged jar packages, configuration files, startup scripts, etc. under other modules, and finally make them into a compressed package in <code>tar.gz</code> format.</p></li><li><p>then docker</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">docker</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.spotify</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dockerfile-maven-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${dockerfile-maven-plugin.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-version</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache/shenyu-admin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}-admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Similar to the release above, here is the activation of the <code>dockerfile-maven-plugin</code> plugin. When <code>mvn install -Pdocker</code>, the plugin will use the dockerfile we wrote to build the docker image.</p></li></ul><p>It should be noted that the dockerfile-maven-plugin currently has limited support for aarch64 architecture devices, and the following error will occur when running the plugin on aarch64 architecture machines. And when I wrote this article, it has not been maintained for a long time, which means that the problem of aarch64 architecture devices using this plugin will not be solved in the short term.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Failed to execute goal com.spotify:dockerfile-maven-plugin:1.4.6:build </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tag-latest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> on project shenyu-admin-dist: Could not build image: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: java.lang.UnsatisfiedLinkError: could not load FFI provider jnr.ffi.provider.jffi.Provider: ExceptionInInitializerError: Can&#x27;t overwrite cause with java.lang.UnsatisfiedLinkError: java.lang.UnsatisfiedLinkError: /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: dlopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib, </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: no suitable image found.  Did find:</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here is a temporary solution:</p><ol><li><p>Open a new shell, enter the following command, and use socat to route the unix socket to the tcp port</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">socat TCP-LISTEN:2375,range</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1/32,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>Set environment variables</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">DOCKER_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tcp://127.0.0.1:2375</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="build-the-examples-module"></a>Build the examples module<a class="hash-link" href="#build-the-examples-module" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build examples</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pexample </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.javadoc.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.test.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Considering the need for release, the current pom file in the project root directory does not contain the example submodule, so the examples module is additionally built in the above step.</p><p>Similar to the above, this line of command will also use the maven plugin to build an image for our subsequent docker orchestration.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="build-custom-gateways"></a>Build custom gateways<a class="hash-link" href="#build-custom-gateways" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build integrated tests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">DskipTests </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In order to subdivide the integration tests of different functions of Apache ShenYu, we will build a gateway customized by the integration test module in this step. The so-called &quot;customization&quot; is to introduce the minimum required dependencies in the pom file, and then replace the default <code>shenyu-bootstrap</code>. Similar to the above two steps, this step will also build the docker image.</p><p>It is worth noting that the way of packaging and building here is slightly different from that of the <code>shenyu-dist</code> module, which you can find by comparing the pom file.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="run-docker-compose"></a>Run docker compose<a class="hash-link" href="#run-docker-compose" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Start docker compose</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose.yml up </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">d</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this step, docker will be arranged according to the different <code>docker-compose.yml</code> files written under the integration test module.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3.9&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-zk</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">6.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpine</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">redis</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-examples-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2048M</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-integrated-test-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">condition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service_healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">healthcheck</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CMD&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;wget&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://shenyu-integrated-test-http:9195/actuator/health&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">retries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example, the <code>docker-compose.yml</code> under the <code>shenyu-integrated-test-http</code> module starts zookeeper, redis, example, admin, gateway and other services in sequence. Among them, the mirrors of example, admin, and gateway are built by us before.</p><p>Among them, docker-compose uses depends_on to determine the topological relationship between services, and most services have corresponding health checks, and the next service will not be started until the health check passes.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="run-the-health-check-and-wait-for-docker-compose-to-start"></a>Run the health check and wait for docker-compose to start<a class="hash-link" href="#run-the-health-check-and-wait-for-docker-compose-to-start" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Wait for docker compose start up completely</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/script/healthcheck.sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this step, the host will run the <code>healthcheck.sh</code> script, and then use the curl command to access the health status interface <code>/actuator/health</code> of each service list (in the services.list file), until the service status is normal. will continue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="run-tests"></a>run tests<a class="hash-link" href="#run-tests" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw test </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/pom.xml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">continue-on-error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This step is to use the maven test command to execute the test classes in the <code>/src/test/</code> directory one by one.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="view-docker-compose-logs"></a>View Docker Compose logs<a class="hash-link" href="#view-docker-compose-logs" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Check test result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    docker-compose -f ./shenyu-integrated-test/${{ matrix.case }}/docker-compose.yml logs --tail=&quot;all&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    if [[ ${{steps.test.outcome}} == &quot;failure&quot; ]]; then</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Failed&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 1</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    else</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Successful&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 0</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    fi</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is an error in the workflow, the log of docker compose can help us to better troubleshoot the problem, so in this step, we will print the log of docker compose.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/integration-test">Integration Test</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Integration Test Analysis" href="/blog/IntegrationTest-Analysis"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync">Apollo Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.306Z">September 28, 2024</time> · 12 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/hql0312" target="_blank" rel="noopener noreferrer">hql0312</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>This article is based on the source code analysis of version &#x27;shenyu-2.6.1&#x27;. Please refer to the official website for an introduction <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a>.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="admin-management"></a>Admin management<a class="hash-link" href="#admin-management" title="Direct link to heading">#</a></h3><p>Understand the overall process through the process of adding plugins</p><p><img src="/assets/images/Apollo-Sync-b0720ba3b1fe0dfcb554b104a78ce2bd.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="receive-data"></a>Receive Data<a class="hash-link" href="#receive-data" title="Direct link to heading">#</a></h3><ul><li>PluginController.createPlugin()</li></ul><p>Enter the <code>createPlugin()</code> method in the <code>PluginController</code> class, which is responsible for data validation, adding or updating data, and returning result information.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/plugin&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @PostMapping(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @RequiresPermissions(&quot;system:plugin:add&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ShenyuAdminResult createPlugin(@Valid @ModelAttribute final PluginDTO pluginDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Call pluginService.createOrUpdate for processing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return ShenyuAdminResult.success(pluginService.createOrUpdate(pluginDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="processing-data"></a>Processing data<a class="hash-link" href="#processing-data" title="Direct link to heading">#</a></h3><ul><li>PluginServiceImpl.createOrUpdate() -&gt; PluginServiceImpl.create()</li></ul><p>Use the <code>create()</code> method in the <code>PluginServiceImpl</code> class to convert data, save it to the database, and publish events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Event publishing object pluginEventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PluginEventPublisher pluginEventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private String create(final PluginDTO pluginDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Check if there is a corresponding plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Assert.isNull(pluginMapper.nameExisted(pluginDTO.getName()), AdminConstants.PLUGIN_NAME_IS_EXIST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // check if Customized plugin jar</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!Objects.isNull(pluginDTO.getFile())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assert.isTrue(checkFile(Base64.decode(pluginDTO.getFile())), AdminConstants.THE_PLUGIN_JAR_FILE_IS_NOT_CORRECT_OR_EXCEEDS_16_MB);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Create plugin object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      PluginDO pluginDO = PluginDO.buildPluginDO(pluginDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Insert object into database</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (pluginMapper.insertSelective(pluginDO) &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish create event. init plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pluginEventPublisher.onCreated(pluginDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return ShenyuResultMessage.CREATE_SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Complete the data persistence operation in the <code>PluginServiceImpl</code> class, that is, save the data to the database and publish events through <code>pluginEventPublisher</code>.</p><p>The logic of the <code>pluginEventPublisher.onCreated</code> method is to publish the changed event:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public void onCreated(final PluginDO plugin) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish DataChangeEvent events: event grouping (plugins, selectors, rules), event types (create, delete, update), changed data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, DataEventTypeEnum.CREATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collections.singletonList(PluginTransfer.INSTANCE.mapToData(plugin))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Publish PluginCreatedEvent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publish(new PluginCreatedEvent(plugin, SessionUtil.visitorName()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Publishing change data is completed through <code>publisher.publishEvent()</code>, which is an &#x27;Application EventPublisher&#x27; object with the fully qualified name of &#x27;org. springframework. contentxt.&#x27; Application EventPublisher `. From here, we know that publishing data is accomplished through the Spring related features.</p><blockquote><p>About <code>ApplicationEventPublisher</code>：</p><p>When there is a state change, the publisher calls the <code>publishEvent</code> method of <code>ApplicationEventPublisher</code> to publish an event, the <code>Spring</code> container broadcasts the event to all observers, and calls the observer&#x27;s <code>onApplicationEvent</code> method to pass the event object to the observer. There are two ways to call the <code>publishEvent</code> method. One is to implement the interface, inject the <code>ApplicationEventPublisher</code> object into the container, and then call its method. The other is to call the container directly. There is not much difference between the two methods to publish events.</p><ul><li><code>ApplicationEventPublisher</code>：Publish events；</li><li><code>ApplicationEvent</code>：<code>Spring</code> events，Record the source, time, and data of the event;</li><li><code>ApplicationListener</code>：Event listeners, observers;</li></ul></blockquote><p>In the event publishing mechanism of Spring, there are three objects,</p><p>One is the <code>ApplicationEventPublisher</code> that publishes events, injecting an <code>publisher</code> through a constructor in <code>ShenYu</code>.</p><p>The other object is <code>ApplicationEvent</code>, which is inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last one is <code>ApplicationListener</code>, which is implemented in <code>ShenYu</code> through the <code>DataChangedEventDispatcher</code> class as a listener for events, responsible for handling event objects.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="distribute-data"></a>Distribute data<a class="hash-link" href="#distribute-data" title="Direct link to heading">#</a></h3><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>After the event is published, it will automatically enter the <code>onApplicationEvent()</code> method in the <code>DataChangedEventDispatcher</code> class for event processing.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * When there is a data change, call this method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Traverse data change listeners (only ApolloDataChangedListener will be registered here)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Forward according to different grouping types</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case APP_AUTH: // authentication information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case PLUGIN: // Plugin events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          // Calling the registered listener object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RULE: // Rule events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case SELECTOR: // Selector event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case META_DATA: // Metadata events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case PROXY_SELECTOR: // Proxy selector event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onProxySelectorChanged((List&lt;ProxySelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case DISCOVER_UPSTREAM: // Registration discovery of downstream list events</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          listener.onDiscoveryUpstreamChanged((List&lt;DiscoverySyncData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          applicationContext.getBean(LoadServiceDocEntry.class).loadDocOnUpstreamChanged((List&lt;DiscoverySyncData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, call the <code>onApplicationEvent</code> method, then traverse all data change listeners, determine which data type it is, and hand it over to the corresponding data listeners for processing.</p><p><code>ShenYu</code> has grouped all data into the following types: authentication information, plugin information, rule information, selector information, metadata, proxy selector, and downstream event discovery.</p><p>The Data Change Listener here is an abstraction of the data synchronization strategy, processed by specific implementations, and different listeners are processed by different implementations. Currently, Apollo is being analyzed
Listening, so here we only focus on <code>ApolloDataChangedListener</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Inheriting AbstractNodeDataChangedListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedListener extends AbstractNodeDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ApolloDataChangedListener</code> inherits the <code>AbstractNodeDataChangedListener</code> class, which mainly uses key as the base class for storage, such as Apollo, Nacos, etc., while others such as Zookeeper
Consul, etc. are searched in a hierarchical manner using a path.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Using key as the base class for finding storage methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractNodeDataChangedListener implements DataChangedListener { </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected AbstractNodeDataChangedListener(final ChangeData changeData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.changeData = changeData;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AbstractNodeDataChangedListener</code> receives ChangeData as a parameter, which defines the key names for each data stored in Apollo. The data stored in Apollo includes the following data:</p><ul><li>Plugin(plugin)</li><li>Selector(selector)</li><li>Rules(rule)</li><li>Authorization(auth)</li><li>Metadata(meta)</li><li>Proxy selector(proxy.selector)</li><li>Downstream List (discovery)</li></ul><p>These information are specified by the ApolloDataChangedListener constructor:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedListener extends AbstractNodeDataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ApolloDataChangedListener(final ApolloClient apolloClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Configure prefixes for several types of grouped data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.RULE_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.AUTH_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.META_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.PROXY_SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApolloPathConstants.DISCOVERY_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Manipulating objects of Apollo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.apolloClient = apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>DataChangedListener</code> defines the following methods:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Data Change Listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Call when authorization information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onAppAuthChanged(List&lt;AppAuthData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when plugin information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onPluginChanged(List&lt;PluginData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when selector information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onSelectorChanged(List&lt;SelectorData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // Called when metadata information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onMetaDataChanged(List&lt;MetaData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Call when rule information changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onRuleChanged(List&lt;RuleData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when proxy selector changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onProxySelectorChanged(List&lt;ProxySelectorData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Called when downstream information changes are discovered</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onDiscoveryUpstreamChanged(List&lt;DiscoverySyncData&gt; changed, DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the plugin is processed by <code>DataChangedEventDispatcher</code>, the method <code>listener.onPluginChanged</code> is called. Next, analyze the logic of the object and implement the processing by <code>AbstractNodeDataChangedListener</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractNodeDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Configure prefix as plugin.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String configKeyPrefix = changeData.getPluginDataId() + DefaultNodeConstants.JOIN_POINT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.onCommonChanged(configKeyPrefix, changed, eventType, PluginData::getName, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.debug(&quot;[DataChangedListener] PluginChanged {}&quot;, configKeyPrefix);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Firstly, the key prefix for constructing configuration data is: <code>plugin.</code>, Call <code>onCommonChanged</code> again for unified processing:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private &lt;T&gt; void onCommonChanged(final String configKeyPrefix, final List&lt;T&gt; changedList,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     final DataEventTypeEnum eventType, final Function&lt;? super T, ? extends String&gt; mapperToKey,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     final Class&lt;T&gt; tClass) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Avoiding concurrent operations on list nodes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock reentrantLock = listSaveLockMap.computeIfAbsent(configKeyPrefix, key -&gt; new ReentrantLock());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reentrantLock.lock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Current incoming plugin list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;String&gt; changeNames = changedList.stream().map(mapperToKey).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Delete Operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete plugin.${pluginName}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.stream().map(mapperToKey).forEach(removeKey -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        delConfig(configKeyPrefix + removeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Remove the corresponding plugin name from plugin. list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // The plugin.list records the currently enabled list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    delChangedData(configKeyPrefix, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Overload logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Get a list of all plugins in plugin.list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final List&lt;String&gt; configDataNames = this.getConfigDataNames(configKeyPrefix);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Update each currently adjusted plug-in in turn</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.forEach(changedData -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Publish Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If there is more data in the currently stored list than what is currently being passed in, delete the excess data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (configDataNames != null &amp;&amp; configDataNames.size() &gt; changedList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Kick out the currently loaded data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configDataNames.removeAll(changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // Delete cancelled data one by one</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        configDataNames.forEach(this::delConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Update list data again</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    publishConfig(configKeyPrefix + DefaultNodeConstants.LIST_STR, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Add or update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    changedList.forEach(changedData -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        publishConfig(configKeyPrefix + mapperToKey.apply(changedData), changedData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Update the newly added plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    putChangeData(configKeyPrefix, changeNames);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;AbstractNodeDataChangedListener onCommonMultiChanged error &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            reentrantLock.unlock();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the above logic, it actually includes the handling of full overloading (REFRESH, MYSELF) and increment (Delete, UPDATE, CREATE)</p><p>The plugin mainly includes two nodes:</p><ul><li><code>plugin.list</code> List of currently effective plugins</li><li><code>plugin.${plugin.name}</code> Detailed information on specific plugins
Finally, write the data corresponding to these two nodes into Apollo.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="data-initialization"></a>Data initialization<a class="hash-link" href="#data-initialization" title="Direct link to heading">#</a></h3><p>After starting <code>admin</code>, the current data information will be fully synchronized to <code>Apollo</code>, which is implemented by <code>ApolloDataChangedInit</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Inheriting AbstractDataChangedInit</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataChangedInit extends AbstractDataChangedInit {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Apollo operation object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApolloClient apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApolloDataChangedInit(final ApolloClient apolloClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.apolloClient = apolloClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean notExist() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if nodes such as plugin, auth, meta, proxy.selector exist</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // As long as one does not exist, it enters reload (these nodes will not be created, why check once?)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Stream.of(ApolloPathConstants.PLUGIN_DATA_ID, ApolloPathConstants.AUTH_DATA_ID, ApolloPathConstants.META_DATA_ID, ApolloPathConstants.PROXY_SELECTOR_DATA_ID).allMatch(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this::dataIdNotExist);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Data id not exist boolean.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataId the plugin data id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the boolean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.isNull(apolloClient.getItemValue(pluginDataId));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check if there is data in <code>apollo</code>, and if it does not exist, synchronize it.
There is a bug here because the key determined here will not be created during synchronization, which will cause data to be reloaded every time it is restarted. <a href="https://github.com/apache/shenyu/pull/5435" target="_blank" rel="noopener noreferrer">PR#5435</a></p><p><code>ApolloDataChangedInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>springboot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> are initialized. It is commonly used for initialization operations in projects.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, then perform full data synchronization, including all authentication information, plugin information, rule information, selector information, metadata, proxy selector, and discover downstream events. Mainly, synchronization events are published through <code>eventPublisher</code>. After publishing events through <code>publishEvent()</code>, <code>ApplicationListener</code> performs event change operations, which is referred to as <code>DataChangedEventDispatcher</code> in <code>ShenYu</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Event Publishing</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Full data synchronization</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronize auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronize plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //Notify subscribers through the Spring publish/subscribe mechanism (publishing DataChangedEvent)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //Unified monitoring by DataChangedEventDispatcher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         //DataChangedEvent comes with configuration grouping type, current operation type, and data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // synchronizing selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronization rules</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronization metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // Synchronization Downstream List</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         discoveryService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="bootstrap-synchronization-operation-initialization"></a>Bootstrap synchronization operation initialization<a class="hash-link" href="#bootstrap-synchronization-operation-initialization" title="Direct link to heading">#</a></h3><p>The data synchronization initialization operation on the gateway side mainly involves subscribing to nodes in <code>apollo</code>, and receiving changed data when there are changes. This depends on the <code>listener</code> mechanism of <code>apollo</code>. In <code>ShenYu</code>, the person responsible for <code>Apollo</code> data synchronization is <code>ApolloDataService</code>.
The functional logic of Apollo DataService is completed during the instantiation process: subscribe to the <code>shenyu</code> data synchronization node in Apollo. Implement through the <code>configService.addChangeListener()</code> method;</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ApolloDataService extends AbstractNodeDataSyncService implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ApolloDataService(final Config configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;AuthDataSubscriber&gt; authDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;ProxySelectorDataSubscriber&gt; proxySelectorDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             final List&lt;DiscoveryUpstreamDataSubscriber&gt; discoveryUpstreamDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configure the prefix for listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(new ChangeData(ApolloPathConstants.PLUGIN_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.RULE_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.AUTH_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.META_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.PROXY_SELECTOR_DATA_ID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ApolloPathConstants.DISCOVERY_DATA_ID),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                pluginDataSubscriber, metaDataSubscribers, authDataSubscribers, proxySelectorDataSubscribers, discoveryUpstreamDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Start listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Note: The Apollo method is only responsible for obtaining data from Apollo and adding it to the local cache, and does not handle listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        startWatch();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Configure listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        apolloWatchPrefixes();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Firstly, configure the key information that needs to be processed and synchronize it with the admin&#x27;s key. Next, call the <code>startWatch()</code> method to process data acquisition and listening. But in the implementation of Apollo, this method is only responsible for handling data retrieval and setting it to the local cache.
Listening is handled by the <code>apolloWatchPrefixes</code> method</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void apolloWatchPrefixes() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Defining Listeners</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConfigChangeListener listener = changeEvent -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            changeEvent.changedKeys().forEach(changeKey -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final ConfigChange configChange = changeEvent.getChange(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Skip if not changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (configChange == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;apollo watchPrefixes error configChange is null {}&quot;, changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final String newValue = configChange.getNewValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // skip last is &quot;list&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If it is a Key at the end of the list, such as plugin.list, skip it because it is only a list that records the effectiveness and will not be cached locally</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    final int lastListStrIndex = changeKey.length() - DefaultNodeConstants.LIST_STR.length();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (changeKey.lastIndexOf(DefaultNodeConstants.LIST_STR) == lastListStrIndex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If it starts with plugin. =&gt; Process plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (changeKey.indexOf(ApolloPathConstants.PLUGIN_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // clear cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCachePluginData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // update cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cachePluginData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with selector. =&gt; Process selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.SELECTOR_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheSelectorData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheSelectorData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with rule. =&gt; Process rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.RULE_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheRuleData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheRuleData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // If it starts with auth. =&gt; Process auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.AUTH_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheAuthData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheAuthData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with meta. =&gt; Process meta data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.META_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheMetaData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheMetaData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with proxy.selector. =&gt; Process proxy.selector meta</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.PROXY_SELECTOR_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheProxySelectorData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheProxySelectorData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If it starts with discovery. =&gt; Process discovery meta</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else if (changeKey.indexOf(ApolloPathConstants.DISCOVERY_DATA_ID) == 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (PropertyChangeType.DELETED.equals(configChange.getChangeType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            unCacheDiscoveryUpstreamData(changeKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            cacheDiscoveryUpstreamData(newValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;apollo sync listener change key handler error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchConfigChangeListener = listener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Add listening</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configService.addChangeListener(listener, Collections.emptySet(), ApolloPathConstants.pathKeySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic of loading data from the previous admin will only add two keys to the plugin: <code>plugin.list</code> and <code>plugin.${plugin.name}</code>, while <code>plugin.list</code> is a list of all enabled plugins, and the data for this key is in the
There is no data in the local cache, only `plugin${plugin.name} will be  focus.</p><p>At this point, the synchronization logic of bootstrap in <code>apollo</code> has been analyzed.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/apollo">apollo</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Apollo Data Synchronization Source Code Analysis" href="/blog/DataSync-SourceCode-Analysis-Apollo-Data-Sync"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcd Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-09-28T03:21:30.306Z">September 28, 2024</time> · 18 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>Etcd</code> and <code>Consul</code>. The main content of this article is based on <code>Etcd</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-etcd"></a>1. About Etcd<a class="hash-link" href="#1-about-etcd" title="Direct link to heading">#</a></h3><p><a href="https://etcd.io" target="_blank" rel="noopener noreferrer">Etcd</a> is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>We traced the source code from a real case, such as updating a selector data in the <code>Divide</code> plugin to a weight of 90 in a background administration system:</p><p><img src="/assets/images/update-selector-en-4efb58e488bd424a54213d31929d7eb1.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-data"></a>2.1 Accept Data<a class="hash-link" href="#21-accept-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set the current selector data ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>：</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: <code>APP_AUTH</code>, <code>PLUGIN</code>, <code>RULE</code>, <code>SELECTOR</code> and <code>META_DATA</code>.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket;</li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper;</li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>：data synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>：data synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>：data synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>Etcd</code> data synchronization source code analysis, so here to <code>EtcdDataDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data Sync Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * By springboot conditional assembly</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Etcd listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(EtcdProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class EtcdListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public EtcdClient etcdClient(final EtcdProperties etcdProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Client client = Client.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .endpoints(etcdProperties.getUrl())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdClient(client);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param etcdClient the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdDataDataChangedListener(etcdClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param etcdClient        the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the etcd data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(EtcdDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdDataInit(etcdClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // other code is omitted......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the SpringBoot conditional assembly class. The <code>EtcdListener</code> class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>etcd</code> is used for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     etcd:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties(EtcdProperties.class)</code>：import <code>EtcdProperties</code>; The properties in the class <code>EtcdProperties</code> is relative to the properties which is with <code>shenyu.sync.etcd</code> as prefix in the configuration file.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> @Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.etcd&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the <code>shenyu.sync.etcd.url</code> property is set in the configuration file, <code>Admin</code> would use the <code>etcd</code> data synchronization, <code>EtcdListener</code> is generated and the beans with type <code>EtcdClient</code>, <code>EtcdDataDataChangedListener</code> and <code>EtcdDataInit</code> would also be generated. </p><ul><li>The bean with the type <code>EtcdClient</code> would be generated, named <code>etcdClient</code>. This bean configues the connection properties of the <code>etcd</code> server based on the configuration file and can operate the <code>etcd</code>nodes directly.</li><li>The bean with the type <code>EtcdDataDataChangedListener</code> would be generated, named <code>etcdDataDataChangedListener</code>.  This bean use the bean <code>etcdClient</code> as a member variable and so when the event is listened, <code>etcdDataDataChangedListener</code> would call the callback method and use the <code>etcdClient</code>  to operate the <code>etcd</code> nodes.</li><li>The bean with the type <code>EtcdDataInit</code> would be generated, named <code>etcdDataInit</code>. This bean use the bean <code>etcdClient</code> and <code>syncDataService</code> as member variables, and use <code>etcdClient</code> to judge whether the data are initialized, if not, would use <code>syncDataService</code> to refresh data. We would dive into the details later.       </li></ul><p>So in the event handler <code>onApplicationEvent()</code>, it goes to the corresponding <code>listener</code>. In our case, it is a selector data update, data synchronization is <code>etcd</code>, so, the code will enter the <code>EtcdDataDataChangedListener</code> selector data change process.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // what kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // other code logic is omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // In our case, will enter the EtcdDataDataChangedListener selector data change process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-etcd-data-changed-listener"></a>2.4 Etcd Data Changed Listener<a class="hash-link" href="#24-etcd-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>EtcdDataDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, determine the type of action, whether to refresh synchronization or update or create synchronization. Determine whether the node is in <code>etcd</code> based on the current selector data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataDataChangedListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            etcdClient.deleteEtcdPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                etcdClient.delete(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //create or update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This part is very important. The variable <code>changed</code> represents the <code>SelectorData</code> list, the variable <code>eventType</code> reprents the event type. When the event type is <code>REFRESH</code> and the <code>SelectorData</code> has changed, all the <code>selector</code> nodes under this <code>plugin</code> would be deleted in <code>etcd</code>. We should notice that the condition that the <code>SelectorData</code> has changed is necessary, otherwise a bug would appear that all the selector nodes would be deleted when no <code>SelectorData</code> data has changed. </p><p>As long as the changed data is correctly written to the <code>etcd</code> node, the <code>admin</code> side of the operation is complete. </p><p>In our current case, updating one of the selector data in the <code>Divide</code> plugin with a weight of 90 updates specific nodes in the graph.</p><p><img src="/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>We series the above update flow with a sequence diagram.</p><p><img src="/assets/images/etcd-sync-sequence-admin-en-29e7ea74b69fcc2faa148fc0459fc16d.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume that the ShenYu gateway is already running properly, and the data synchronization mode is also <code>etcd</code>. How does the gateway receive and process the selector data after updating it on the admin side and sending the changed data to etcd? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-etcdclient-accept-data"></a>3.1 EtcdClient Accept Data<a class="hash-link" href="#31-etcdclient-accept-data" title="Direct link to heading">#</a></h4><ul><li>EtcdClient.watchDataChange()</li></ul><p>There is a <code>EtcdSyncDataService</code> class on the gateway, which subscribing to the data node through <code>etcdClient</code> and can sense when the data changes.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      etcdClient.watchDataChange(path, (updateNode, updateValue) -&gt; cacheSelectorData(updateValue),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              this::unCacheSelectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //other codes omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Etcd&#x27;s  <code>Watch</code> mechanism notifies subscribing clients of node changes. In our case, updating the selector information goes to the <code>watchDataChange()</code> method. <code>cacheSelectorData()</code> is used to process data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-handle-data"></a>3.2 Handle Data<a class="hash-link" href="#32-handle-data" title="Direct link to heading">#</a></h4><ul><li>EtcdSyncDataService.cacheSelectorData()</li></ul><p>The data is not null, and caching the selector data is again handled by <code>PluginDataSubscriber</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code> is an interface, it is only a <code>CommonPluginDataSubscriber</code> implementation class, responsible for data processing plugin, selector and rules.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-common-plugin-data-subscriber"></a>3.3 Common Plugin Data Subscriber<a class="hash-link" href="#33-common-plugin-data-subscriber" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-data-cached-to-memory"></a>3.4 Data cached to Memory<a class="hash-link" href="#34-data-cached-to-memory" title="Direct link to heading">#</a></h4><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracking, and through a practical case, in the <code>admin</code> end to update a selector data, the <code>ZooKeeper</code> data synchronization process analysis is clear.</p><p>Let&#x27;s series the data synchronization process on the gateway side through the sequence diagram:</p><p><img src="/assets/images/etcd-sync-sequence-gateway-en-4da1d7160168a3ee75741e84d7298e0d.png"></p><p>The data synchronization process has been analyzed. In order to prevent the synchronization process from being interrupted, other logic is ignored during the analysis. We also need to analyze the process of Admin synchronization data initialization and gateway synchronization operation initialization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin-data-sync--initialization"></a>4. Admin Data Sync  initialization<a class="hash-link" href="#4-admin-data-sync--initialization" title="Direct link to heading">#</a></h3><p>When <code>admin</code> starts, the current data will be fully synchronized to <code>etcd</code>, the implementation logic is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataInit.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void run(final String... args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!etcdClient.exists(pluginPath) &amp;&amp; !etcdClient.exists(authPath) &amp;&amp; !etcdClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.info(&quot;Init all data from database&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check whether there is data in <code>etcd</code>, if not, then synchronize.</p><p><code>EtcdDataInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>SpringBoot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> initializations and is often used for initialization operations in a project.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, and then perform full data synchronization, all authentication information, plugin information, selector information, rule information, and metadata information. Synchronous events are published primarily through <code>eventPublisher</code>. After publishing the event via <code>publishEvent()</code>, the <code>ApplicationListener</code> performs the event change operation. In <code>ShenYu</code> is mentioned in <code>DataChangedEventDispatcher</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * sync all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-gateway-data-sync-init"></a>5. Gateway Data Sync Init<a class="hash-link" href="#5-gateway-data-sync-init" title="Direct link to heading">#</a></h3><p>The initial operation of data synchronization on the gateway side is mainly the node in the subscription <code>etcd</code>. When there is a data change, the changed data will be received. This relies on the <code>Watch</code> mechanism of <code>etcd</code>. In <code>ShenYu</code>, the one responsible for <code>etcd</code> data synchronization is <code>EtcdSyncDataService</code>, also mentioned earlier.</p><p>The function logic of <code>EtcdSyncDataService</code> is completed in the process of instantiation: the subscription to <code>Shenyu</code> data synchronization node in <code>etcd</code> is completed. Subscription here is divided into two kinds, one kind is existing node data updated above, through this <code>etcdClient.subscribeDataChanges()</code> method; Another kind is under the current node, add or delete nodes change namely child nodes, it through <code>etcdClient.subscribeChildChanges()</code> method.</p><p><code>EtcdSyncDataService</code> code is a bit too much, here we use plugin data read and subscribe to track, other types of data operation principle is the same.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Zookeeper cache manager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient             the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdSyncDataService(final EtcdClient etcdClient, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.etcdClient = etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; pluginZKs = etcdClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!updateNode.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                watcherAll(updateNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePluginData(etcdClient.get(pluginPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void cachePluginData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(pluginData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(data -&gt; Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -&gt; e.onSubscribe(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataPath = buildRealPath(pluginPath, updatePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataStr = etcdClient.get(dataPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Optional.ofNullable(data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .ifPresent(d -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSubscribe(d)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, deleteNode -&gt; deletePlugin(pluginName));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above source code is given comments, I believe you can understand. The main logic for subscribing to plug-in data is as follows:</p><blockquote><ol><li>Create the current plugin path</li><li>Read the current node data on etcd and deserialize it</li><li>The plugin data is cached in the gateway memory</li><li>Subscribe to the plug-in node</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-summary"></a>6. Summary<a class="hash-link" href="#6-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, <code>etcd</code> data synchronization principle source code analysis. The main knowledge points involved are as follows:</p><ul><li><p>Data synchronization based on <code>etcd</code> is mainly implemented through <code>watch</code> mechanism;</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of <code>SpringBoot</code> and <code>starter</code> loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/etcd">etcd</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about Etcd Data Synchronization Source Code Analysis" href="/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-SPI">SPI Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-09-12T00:00:00.000Z">September 12, 2022</time> · 18 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zjcscut/" target="_blank" rel="noopener noreferrer">Throwable</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="background"></a>background<a class="hash-link" href="#background" title="Direct link to heading">#</a></h2><p>Recently,when I read the source code of open source project Apache Shenyu API gateway,I find and many core components of the gateway are loaded with the SPI module. Here I will analyzes the source code of <code>SPI</code> module in <code>Shenyu</code> gateway.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="what-is-spi"></a>what is SPI<a class="hash-link" href="#what-is-spi" title="Direct link to heading">#</a></h2><p><code>SPI</code> means &#x27;Service Provider Interface&#x27;, which is a dynamic Service discovery mechanism. We can dynamically load the implementation class of the Interface based on the runtime of the Interface (that is, a development mode of Interface programming + strategy  pattern + configuration file) with it. The most common is the built-in database Driver interface &#x27;java.sql.Driver&#x27; in JDK. Different vendors can implement this interface differently. For example, &#x27;MySQL&#x27; (&#x27;com.mysql.jdbc.Driver&#x27; in the &#x27;MySQL&#x27; Driver package),&#x27; PostgreSQL&#x27; (&#x27;org.postgresql.driver&#x27; in the &#x27;PostgreSQL&#x27; Driver package), etc.</p><p><img alt="spi-jdk-api-diagram" src="/assets/images/spi-jdk-api-diagram-en-a4e0940e14c7a579fafb7727894d905f.png"></p><p>The JDK&#x27;s built-in &#x27;SPI&#x27; can be used as follows:</p><ul><li><p>In the &#x27;META-INF/services&#x27; directory of the classpath, create a file named with the fully qualified name of the interface (essentially a &#x27;properties&#x27; file) whose implementation classes you want the SPI loader to load , for example if you want to load the SQL driver implementation classes mentioned above then create a file named &#x27;java.sql.Driver&#x27; since those classes implement the &#x27;java.sql.driver&#x27; interface.</p></li><li><p>In this file we can add entries for all the specific implementations of the interface . For example for the above driver class scenario we would add entries as shown in below code snippet in the file <code>META-INF/services/java.sql.Driver</code></p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># content of file META-INF/services/java.sql.Driver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">com.mysql.jdbc.Driver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">org.postgresql.Driver</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Finally load the file with &#x27;java.util.ServiceLoader&#x27; to instantiate the corresponding implementation class of the interface</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceLoader&lt;Driver&gt; loader = ServiceLoader.load(Driver.class)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The underlying implementation involves classloading, the parent delegate model, and so on, which I won&#x27;t expand here. Based on this design idea, many mainstream frameworks self-implemented a set of &#x27;SPI&#x27; extension, such as &#x27;Dubbo SPI&#x27; extension module, which would read the &#x27;META-INF/services/dubbo&#x27; directory file content in the classppath for class loading. The &#x27;shenyu-spi&#x27; module also follows this similar design idea.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="source-code-of-shenyu-spi"></a>source code of shenyu-spi<a class="hash-link" href="#source-code-of-shenyu-spi" title="Direct link to heading">#</a></h2><p>The &#x27;shenyu-spi&#x27; module is very concise, and the code structure is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">- shenyu-spi[module]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  - org.apache.shenyu.spi[package]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SpiExtensionFactory</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这些类功能如下：</p><ul><li>&#x27;ExtensionFactory&#x27; : &#x27;SPI&#x27; loader Factory, used to load an &#x27;ExtensionLoader&#x27; instance based on the &#x27;SPI&#x27; mechanism and to obtain the default &#x27;SPI&#x27; identity implementation based on the &#x27;ExtensionLoader&#x27; instance</li><li>&#x27;SpiExtensionFactory&#x27; : is an implementation of &#x27;ExtensionFactory&#x27;</li><li>&#x27;SPI&#x27; : identification annotation, used to identify &#x27;SPI&#x27;, used on the interface</li><li>&#x27;Join&#x27; : identification annotation, used on the implementation class, used to identify the class joining the SPI system</li><li>&#x27;ExtensionLoader&#x27; : &#x27;SPI&#x27; loader, analogous to &#x27;java.util.ServiceLoader&#x27;, used to load the implementation class of the interface in &#x27;SPI&#x27;</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi"></a>@SPI<a class="hash-link" href="#spi" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.SPI</code> is an identification annotation which is used for identifying an interface as a &#x27;SPI&#x27; interface.That is, only interfaces that use &#x27;@SPI&#x27; annotation can be loaded by &#x27;shenyu-spi&#x27;. The class&#x27;s annotation describes the implementation of Apache Dubbo, a reference to all the SPI systems (which makes sense, since the SPI extension is already a mature scheme with much the same implementation). This annotation has only one method:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface SPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Value string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the string</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The unique &#x27;value()&#x27; method is used to specify the default &#x27;SPI&#x27; implementation (optional), as will be shown later when analyzing &#x27;ExtensionLoader&#x27;.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="join"></a>@Join<a class="hash-link" href="#join" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.Join</code> is an identification annotation too. When this annotation is used on a class it specifies that  the class contains &#x27;SPI&#x27; implementation and to indicate that the class is added to the SPI system and can be loaded by ExtensionLoader. This annotation has two methods:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Indicates that the object joined by @Join is a singleton,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * otherwise a completely new instance is created each time.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true or false.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isSingleton() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The unique &#x27;order()&#x27; method is used to specify the specific sequence number. If a single interface that annotated with &#x27;@SPI&#x27; has multiple implementation classes that annotated with &#x27;@Join&#x27;, the sequence number determines the order of these implementation class instances (the smaller one comes first).</p><p>The isSingleton() method indicates whether the class that the implementation class is a singleton class or not. That is if it is a singleton class it will be instantiated only once else it will create a new instance everytime . </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionloader"></a>ExtensionLoader<a class="hash-link" href="#extensionloader" title="Direct link to heading">#</a></h3><p>&#x27;ExtensionLoader&#x27; is the core of the &#x27;SPI&#x27; module. Look at it&#x27;s attributes first:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ExtensionLoader&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SLF4J日志句柄</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(ExtensionLoader.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SPI配置文件基于类路径下的相对目录</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // @SPI标识接口类型 -&gt; ExtensionLoader实例的缓存 =&gt; 注意这个是一个全局的静态变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; LOADERS = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当前@SPI标识接口类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Class&lt;T&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 类加载器实例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ClassLoader classLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当前ExtensionLoader缓存的已加载的实现类信息，使用值持有器包装，是一个HashMap，映射关系：实现类别名 -&gt; 实现类信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Holder&lt;Map&lt;String, ClassEntity&gt;&gt; cachedClasses = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当前ExtensionLoader缓存的已加载的实现类实例的值包装器，使用值持有器包装，映射关系：实现类别名 -&gt; 值持有器包装的实现类实体</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当前ExtensionLoader缓存的已加载的实现类实例，使用值持有器包装，映射关系：实现类类型 -&gt; 实现类实体</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;Class&lt;?&gt;, Object&gt; joinInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 缓存默认名称，来源于@SPI注解的value()方法非空白返回值，用于加载默认的接口实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String cachedDefaultName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Holder比较器，按照Holder的order降序，也就是顺序号小的排在前面</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;Holder&lt;Object&gt;&gt; holderComparator = Comparator.comparing(Holder::getOrder);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ClassEntity比较器，按照ClassEntity的order降序，也就是顺序号小的排在前面</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;ClassEntity&gt; classEntityComparator = Comparator.comparing(ClassEntity::getOrder);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 暂时省略其他代码</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 值持有器，简单VO，用来存储泛型值和值加载顺序</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class Holder&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里的值引用是volatile修饰，便于某线程更变另一线程马上读到最新的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private volatile T value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean isSingleton;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 省略setter和getter代码</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 类实体，主要存放加载的实现类的信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final class ClassEntity {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 名称，这里是指SPI实现类的别名，不是类名</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 加载顺序号</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Boolean isSingleton;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // SPI实现类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Class&lt;?&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private ClassEntity(final String name, final Integer order, final Class&lt;?&gt; clazz, final boolean isSingleton) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.name = name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.order = order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.isSingleton = isSingleton;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 省略setter和getter代码</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After analyzing the attributes, it is not difficult to find the following points:</p><ul><li>&#x27;ExtensionLoader&#x27; There will be a global static cache &#x27;LOADERS&#x27; to cache already created instances of &#x27;ExtensionLoader&#x27; to prevent the performance overhead of repeated creation</li><li>Each &#x27;@SPI&#x27; interface that is loaded using &#x27;ExtensionLoader&#x27; generates a new instance of &#x27;ExtensionLoader&#x27;</li><li>&#x27;@SPI&#x27; interfaces that have multiple implementations are eventually acquired in order</li></ul><p>Then look at it&#x27;s constructors and static factory methods:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 私有构造函数，需要入参为@SPI标识的接口类型和类加载器实例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private ExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 成员变量clazz赋值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 成员变量classLoader赋值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.classLoader = cl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里对于非ExtensionFactory接口类型会懒加载一个用于加载ExtensionFactory的ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Objects.equals(clazz, ExtensionFactory.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getExtensionClassesEntity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 实例化getExtensionLoader，静态工厂方法，需要入参为@SPI标识的接口类型和类加载器实例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 前缀校验，接口类型必须非空并且必须存在@SPI注解，否则抛出异常中断</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Objects.requireNonNull(clazz, &quot;extension clazz is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isInterface()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) is not interface!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAnnotationPresent(SPI.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) without @&quot; + SPI.class + &quot; Annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 从缓存LOADERS中加载ExtensionLoader实例，不存在则创建，典型的懒加载模式</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExtensionLoader&lt;T&gt; extensionLoader = (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(extensionLoader)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extensionLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOADERS.putIfAbsent(clazz, new ExtensionLoader&lt;&gt;(clazz, cl));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 实例化getExtensionLoader，静态工厂方法，需要入参为@SPI标识的接口类型，使用ExtensionLoader类的类加载器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getExtensionLoader(clazz, ExtensionLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>&#x27;ExtensionLoader&#x27; uses a private constructor, static factory methods, and lazy loading mode. Class loading is not triggered after initializing &#x27;ExtensionLoader&#x27;. The actual scanning and loading is delayed until the &#x27;getJoin&#x27; series methods are called, where the code is swept and all the method call chains that implement class information are loaded:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 加载所有扩展类信息，这里采用了DCL（双重锁校验）防止并发加载</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; getExtensionClassesEntity() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 缓存不存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 加锁后再检查一次缓存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedClasses) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 最终确认缓存不存在，则进行加载，并且标记顺序号为0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                classes = loadExtensionClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setValue(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setOrder(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 加载当前ExtensionLoader中clazz的所有SPI系统内的实现类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; loadExtensionClass() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SPI annotation = clazz.getAnnotation(SPI.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(annotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里就是前面提到，如果@SPI注解的value()方法非空白返回值会作为默认实现的别名</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 也就是如果只使用了@SPI，那么就无法获取默认实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果使用了@SPI(&quot;foo&quot;)，可以通过别名foo去映射和获取默认实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String value = annotation.value();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cachedDefaultName = value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 初始化一个Hashmap容器用于存储加载的实现类信息，这个变量会透传到下一个方法链</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = new HashMap&lt;&gt;(16);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 加载目录中的属性文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadDirectory(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 加载目录中的属性文件，并且加载文件中的实现类，目标目录：META-INF/shenyu/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadDirectory(final Map&lt;String, ClassEntity&gt; classes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 文件名 =&gt; META-INF/shenyu/$className</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = SHENYU_DIRECTORY + clazz.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里使用类加载器加载文件资源，如果传入的类加载器为空会使用系统类加载器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;URL&gt; urls = Objects.nonNull(this.classLoader) ? classLoader.getResources(fileName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : ClassLoader.getSystemResources(fileName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历解析的文件URL集合</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(urls)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (urls.hasMoreElements()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                URL url = urls.nextElement();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 通过文件URL加载资源</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                loadResources(classes, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.error(&quot;load extension class error {}&quot;, fileName, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 加载文件资源，解析文件并且加载实现类存储到classes中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadResources(final Map&lt;String, ClassEntity&gt; classes, final URL url) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 读取URL文件资源，加载到Properties中，每行格式为name=classPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (InputStream inputStream = url.openStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.load(inputStream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.forEach((k, v) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String name = (String) k;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String classPath = (String) v;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(name) &amp;&amp; StringUtils.isNotBlank(classPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 基于name和classPath进行类加载</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    loadClass(classes, name, classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (ClassNotFoundException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 基于name（别名）和classPath（类全限定名称）进行类加载</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadClass(final Map&lt;String, ClassEntity&gt; classes,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String name, final String classPath) throws ClassNotFoundException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 类初始化，并且确定实现类必须是当前@SPI注解标识接口的子类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; subClass = Objects.nonNull(this.classLoader) ? Class.forName(classPath, true, this.classLoader) : Class.forName(classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAssignableFrom(subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; subtype is not of &quot; + clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 实现类必须存在注解@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!subClass.isAnnotationPresent(Join.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; without @&quot; + Join.class + &quot; annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果缓存中不存在同样别名的实现类才进行缓存，已经存在则校验旧的类型和当前实现类型是否一致</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity oldClassEntity = classes.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(oldClassEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建类信息实体保存别名、顺序号和实现类并且缓存，映射关系：别名 -&gt; 类信息实体</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Join joinAnnotation = subClass.getAnnotation(Join.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassEntity classEntity = new ClassEntity(name, joinAnnotation.order(), subClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classes.put(name, classEntity);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (!Objects.equals(oldClassEntity.getClazz(), subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,Duplicate class &quot; + clazz.getName() + &quot; name &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                + name + &quot; on &quot; + oldClassEntity.getClazz().getName() + &quot; or &quot; + subClass.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Processing with the chain of method &#x27;getExtensionClassesEntity - &gt; loadExtensionClass - &gt; loadDirectory - &gt; loadResources - &gt; LoadClass&#x27;,it will create a mapping of &#x27;alias&#x27; to &#x27;implementation class information&#x27; for subsequent instantiations, as shown in the &#x27;getJoin()&#x27; method:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 基于别名获取实现类实例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public T getJoin(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 别名必须为非空白字符串</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(name)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NullPointerException(&quot;get join name is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里也使用DCL去cachedInstances缓存中取别名对应的值持有器，值持有器为空则创建</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;Object&gt; objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(objectHolder)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedInstances.putIfAbsent(name, new Holder&lt;&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedInstances) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 加锁后再次判断值持有器中的值是否存在，不存在的时候则进行实现类实例化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Holder&lt;T&gt; pair = createExtension(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                value = pair.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                int order = pair.getOrder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 实例化完成后更新值持有器缓存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setValue(value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setOrder(order);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (T) value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 基于别名搜索已经加载的实现类信息，并且实例化对应的实现类进行值包装</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Holder&lt;T&gt; createExtension(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 加载该@SPI标识接口的所有实现类信息并且获取对应别名的实现类信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity classEntity = getExtensionClassesEntity().get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;name is error&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; aClass = classEntity.getClazz();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果实现类实例缓存中已经存在，则直接封装为值包装器返回，否则进行实例化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(o)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 反射实例化并且缓存该实现类实例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            joinInstances.putIfAbsent(aClass, aClass.newInstance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InstantiationException | IllegalAccessException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Extension instance(name: &quot; + name + &quot;, class: &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + aClass + &quot;)  could not be instantiated: &quot; + e.getMessage(), e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;T&gt; objectHolder = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setOrder(classEntity.getOrder());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setValue((T) o);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return objectHolder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see from the &#x27;createExtension()&#x27; method, we end up using reflection to instantiate the implementation class. The reflection method &#x27;newInstance()&#x27; requires that the class must provide a no-argument constructor because of an implicit convention: The &#x27;SPI&#x27; implementation class <strong>must provide a no-argument constructor</strong> or the instantiation will fail. The rest methods, such as &#x27;getDefaultJoin()&#x27; and &#x27;getJoins()&#x27; are uncomplicated extensions of &#x27;getJoin()&#x27;, so we won&#x27;t analyze them here. In addition, the &#x27;getJoin()&#x27; method uses a multilevel cache:</p><ul><li>&#x27;cachedInstances&#x27; : Search for the corresponding implementation class instance by alias</li><li>&#x27;joinInstances&#x27; : If the alias lookup fails, load all the implementation class information, locate the implementation class type by the alias, and update the&#x27; cachedInstances&#x27; cache by either finding the implementation class type or creating and caching the implementation class instance</li></ul><p>This completes the source code analysis of &#x27;ExtensionLoader&#x27;. Here&#x27;s another example of an &#x27;ExtensionLoader&#x27; instance member property memory layout diagram to help you understand:</p><p><img alt="spi-attr-memory-debug" src="/assets/images/spi-attr-memory-debug-fbcf742eb342ba1aa47e9395bf8ffc0c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionfactory"></a>ExtensionFactory<a class="hash-link" href="#extensionfactory" title="Direct link to heading">#</a></h3><p>&#x27;ExtensionFactory&#x27; is the factory interface inside the factory pattern, which defines a method to get an instance of the &#x27;SPI&#x27; implementation (the <strong>default implementation, or the only implementation</strong>) :</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI(&quot;spi&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets Extension.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt;   the type parameter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param key   此参数暂时没有使用，猜测是预留用于映射@SPI的value()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param clazz @SPI标识的接口类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the extension</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getExtension(String key, Class&lt;T&gt; clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s look the class &#x27;SpiExtensionFactory&#x27; :</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpiExtensionFactory implements ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; T getExtension(final String key, final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Optional.ofNullable(clazz)   // 入参clazz非空</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Class::isInterface)  // 入参clazz必须是接口</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(cls -&gt; cls.isAnnotationPresent(SPI.class))  // 入参clazz必须被@SPI标识</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getExtensionLoader)  // 基于clazz这个接口类型实例化ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getDefaultJoin)  // 获取该@SPI标识接口的默认实现，不存在则返回NULL</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It&#x27;s worth noting here that the &#x27;ExtensionFactory&#x27; itself is part of the &#x27;SPI&#x27; system. So when using &#x27;ExtensionFactory&#x27; you can instantiate it directly:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = new SpiExtensionFactory();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It can also be loaded based on an &#x27;ExtensionLoader&#x27;:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># the content of META-INF/services/shenyu/org.apache.shenyu.spi.ExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">spi=org.apache.shenyu.spi.SpiExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># then load it with ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getDefaultJoin();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Once you have an &#x27;ExtensionFactory&#x27; instance, you can load an instance of its default implementation class based on the &#x27;@SPI&#x27; interface.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="小结"></a>小结<a class="hash-link" href="#小结" title="Direct link to heading">#</a></h2><p>The &#x27;SPI&#x27; extension framework based on the design idea of &#x27;Java&#x27; native &#x27;SPI&#x27; has the characteristics of loose coupling, high usability and high scalability, a loading instance cache system, concurrency security and other features to fill some defects of &#x27;SPI&#x27; in the native &#x27;JDK&#x27;, Shenyu SPI module is the same. Base on this powerful &#x27;SPI&#x27; module, other modules in &#x27;Shenyu&#x27; such as the &#x27;Plugin&#x27; module can be configured quickly and pluggable, making it easier to load a newly developed Plugin instance.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about SPI Source Code Analysis" href="/blog/SPI-SourceCode-Analysis-SPI"><b>Read More</b></a></div></footer></article></main></div></div></div></div>
<script src="/assets/js/runtime~main.cbde5fcb.js"></script>
<script src="/assets/js/main.a121fc16.js"></script>
</body>
</html>