"use strict";(self.webpackChunkshenyu_website=self.webpackChunkshenyu_website||[]).push([[17869],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>C});var a=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=a.createContext({}),o=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},d=function(e){var n=o(e.components);return a.createElement(c.Provider,{value:n},e.children)},s="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,l=e.originalType,c=e.parentName,d=p(e,["components","mdxType","originalType","parentName"]),s=o(t),m=i,C=s["".concat(c,".").concat(m)]||s[m]||u[m]||l;return t?a.createElement(C,r(r({ref:n},d),{},{components:t})):a.createElement(C,r({ref:n},d))}));function C(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var l=t.length,r=new Array(l);r[0]=m;var p={};for(var c in n)hasOwnProperty.call(n,c)&&(p[c]=n[c]);p.originalType=e,p[s]="string"==typeof e?e:i,r[1]=p;for(var o=2;o<l;o++)r[o]=t[o];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},98295:(e,n,t)=>{t.r(n),t.d(n,{contentTitle:()=>r,default:()=>s,frontMatter:()=>l,metadata:()=>p,toc:()=>c});var a=t(87462),i=(t(67294),t(3905));const l={title:"Etcd\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790",author:"4zd",author_title:"Apache ShenYu Contributor",author_url:"https://github.com/4zd",tags:["etcd","data sync","Apache ShenYu"]},r=void 0,p={permalink:"/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync",editUrl:"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync.md",source:"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync.md",title:"Etcd\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790",description:"Apache ShenYu \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 API \u7f51\u5173\u3002",date:"2024-01-06T12:23:08.053Z",formattedDate:"2024\u5e741\u67086\u65e5",tags:[{label:"etcd",permalink:"/zh/blog/tags/etcd"},{label:"data sync",permalink:"/zh/blog/tags/data-sync"},{label:"Apache ShenYu",permalink:"/zh/blog/tags/apache-shen-yu"}],readingTime:25.105,truncated:!1,prevItem:{title:"RateLimiter SPI \u4ee3\u7801\u5206\u6790",permalink:"/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI"},nextItem:{title:"Http\u957f\u8f6e\u8be2\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790",permalink:"/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync"}},c=[{value:"1. \u5173\u4e8eEtcd",id:"1-\u5173\u4e8eetcd",children:[]},{value:"2. Admin\u6570\u636e\u540c\u6b65",id:"2-admin\u6570\u636e\u540c\u6b65",children:[]},{value:"3. \u7f51\u5173\u6570\u636e\u540c\u6b65",id:"3-\u7f51\u5173\u6570\u636e\u540c\u6b65",children:[]},{value:"4. Admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316",id:"4-admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316",children:[]},{value:"5. \u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316",id:"5-\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316",children:[]},{value:"6. \u603b\u7ed3",id:"6-\u603b\u7ed3",children:[]}],o={toc:c},d="wrapper";function s(e){let{components:n,...l}=e;return(0,i.kt)(d,(0,a.Z)({},o,l,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/zh/docs/index"},"Apache ShenYu")," \u662f\u4e00\u4e2a\u5f02\u6b65\u7684\uff0c\u9ad8\u6027\u80fd\u7684\uff0c\u8de8\u8bed\u8a00\u7684\uff0c\u54cd\u5e94\u5f0f\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"API")," \u7f51\u5173\u3002")),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002",(0,i.kt)("inlineCode",{parentName:"p"},"Apache ShenYu")," \u7f51\u5173\u5f53\u524d\u652f\u6301",(0,i.kt)("inlineCode",{parentName:"p"},"ZooKeeper"),"\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"WebSocket"),"\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"Http\u957f\u8f6e\u8be2"),"\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"Nacos")," \u3001",(0,i.kt)("inlineCode",{parentName:"p"},"Etcd")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"Consul")," \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"Etcd"),"\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u672c\u6587\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"shenyu-2.4.0"),"\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 ",(0,i.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/zh/docs/design/data-sync"},"\u6570\u636e\u540c\u6b65\u539f\u7406")," \u3002")),(0,i.kt)("h3",{id:"1-\u5173\u4e8eetcd"},"1. \u5173\u4e8eEtcd"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/etcd-io/etcd"},(0,i.kt)("inlineCode",{parentName:"a"},"Etcd")),"\u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u7684\u952e\u503c\u5bf9\u5b58\u50a8\u7cfb\u7edf\uff0c\u5b83\u4e3a\u5927\u578b\u5206\u5e03\u5f0f\u8ba1\u7b97\u63d0\u4f9b\u5206\u5e03\u5f0f\u914d\u7f6e\u670d\u52a1\u3001\u540c\u6b65\u670d\u52a1\u548c\u547d\u540d\u6ce8\u518c\u3002"),(0,i.kt)("h3",{id:"2-admin\u6570\u636e\u540c\u6b65"},"2. Admin\u6570\u636e\u540c\u6b65"),(0,i.kt)("p",null,"\u6211\u4eec\u4ece\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\u8fdb\u884c\u6e90\u7801\u8ffd\u8e2a\uff0c\u6bd4\u5982\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u5bf9",(0,i.kt)("inlineCode",{parentName:"p"},"Divide"),"\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff1a"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(15258).Z})),(0,i.kt)("h4",{id:"21-\u63a5\u6536\u6570\u636e"},"2.1 \u63a5\u6536\u6570\u636e"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"SelectorController.createSelector()")),(0,i.kt)("p",null,"\u8fdb\u5165",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorController"),"\u7c7b\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"updateSelector()"),"\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Validated\n@RequiredArgsConstructor\n@RestController\n@RequestMapping("/selector")\npublic class SelectorController {\n    \n    @PutMapping("/{id}")\n    public ShenyuAdminResult updateSelector(@PathVariable("id") final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {\n        // \u8bbe\u7f6e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636eid\n        selectorDTO.setId(id);\n        // \u521b\u5efa\u6216\u66f4\u65b0\u64cd\u4f5c\n        Integer updateCount = selectorService.createOrUpdate(selectorDTO);\n        // \u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\n        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);\n    }\n    \n    // ......\n}\n')),(0,i.kt)("h4",{id:"22-\u5904\u7406\u6570\u636e"},"2.2 \u5904\u7406\u6570\u636e"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"SelectorServiceImpl.createOrUpdate()")),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorServiceImpl"),"\u7c7b\u4e2d\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"createOrUpdate()"),"\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u66f4\u65b0",(0,i.kt)("inlineCode",{parentName:"p"},"upstream"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"@RequiredArgsConstructor\n@Service\npublic class SelectorServiceImpl implements SelectorService {\n    // \u8d1f\u8d23\u4e8b\u4ef6\u53d1\u5e03\u7684eventPublisher\n    private final ApplicationEventPublisher eventPublisher;\n    \n    @Override\n    @Transactional(rollbackFor = Exception.class)\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\n        int selectorCount;\n        // \u6784\u5efa\u6570\u636e DTO --\x3e DO\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\n        // \u5224\u65ad\u662f\u6dfb\u52a0\u8fd8\u662f\u66f4\u65b0\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\n            // \u63d2\u5165\u9009\u62e9\u5668\u6570\u636e\n            selectorCount = selectorMapper.insertSelective(selectorDO);\n            // \u63d2\u5165\u9009\u62e9\u5668\u4e2d\u7684\u6761\u4ef6\u6570\u636e\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\n            });\n            // check selector add\n            // \u6743\u9650\u68c0\u67e5\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\n                dataPermissionDTO.setDataId(selectorDO.getId());\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\n            }\n\n        } else {\n            // \u66f4\u65b0\u6570\u636e\uff0c\u5148\u5220\u9664\u518d\u65b0\u589e\n            selectorCount = selectorMapper.updateSelective(selectorDO);\n            //delete rule condition then add\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\n                selectorConditionMapper.insertSelective(selectorConditionDO);\n            });\n        }\n        // \u53d1\u5e03\u4e8b\u4ef6\n        publishEvent(selectorDO, selectorConditionDTOs);\n\n        // \u66f4\u65b0upstream\n        updateDivideUpstream(selectorDO);\n        return selectorCount;\n    }\n    \n    \n    // ......\n    \n}\n\n")),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"Service"),"\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u6df1\u5165\u8ffd\u8e2a\u4e86\u3002\u5173\u4e8e\u66f4\u65b0",(0,i.kt)("inlineCode",{parentName:"p"},"upstream"),"\u64cd\u4f5c\uff0c\u653e\u5230\u540e\u9762\u5bf9\u5e94\u7684\u7ae0\u8282\u4e2d\u8fdb\u884c\u5206\u6790\uff0c\u91cd\u70b9\u5173\u6ce8\u53d1\u5e03\u4e8b\u4ef6\u7684\u64cd\u4f5c\uff0c\u5b83\u4f1a\u6267\u884c\u6570\u636e\u540c\u6b65\u3002"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"publishEvent()"),"\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u6784\u5efa\u6761\u4ef6\u6570\u636e\uff0c\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"     private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\n        // \u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\n        // \u6784\u5efa\u6761\u4ef6\u6570\u636e\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\n        // \u53d1\u5e03\u53d8\u66f4\u6570\u636e\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\n    }\n")),(0,i.kt)("p",null,"\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher.publishEvent()"),"\u5b8c\u6210\uff0c\u8fd9\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher"),"\u5bf9\u8c61\u662f\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),"\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"org.springframework.context.ApplicationEventPublisher"),"\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"Spring"),"\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u5173\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),"\uff1a"),(0,i.kt)("p",{parentName:"blockquote"},"\u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"publishEvent")," \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"Spring"),"\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"onApplicationEvent")," \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"publishEvent"),"\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher")," \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002"),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ApplicationEventPublisher"),"\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ApplicationEvent"),"\uff1a",(0,i.kt)("inlineCode",{parentName:"li"},"Spring")," \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ApplicationListener"),"\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\uff1b"))),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"Spring"),"\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c"),(0,i.kt)("p",null,"\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),"\uff0c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher"),"\u3002"),(0,i.kt)("p",null,"\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationEvent"),"\uff0c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedEvent"),"\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public class DataChangedEvent extends ApplicationEvent {\n//......\n}\n")),(0,i.kt)("p",null,"\u6700\u540e\u4e00\u4e2a\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationListener"),"\uff0c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedEventDispatcher"),"\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n    //......\n    \n}\n")),(0,i.kt)("h4",{id:"23-\u5206\u53d1\u6570\u636e"},"2.3 \u5206\u53d1\u6570\u636e"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"DataChangedEventDispatcher.onApplicationEvent()")),(0,i.kt)("p",null,"\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedEventDispatcher"),"\u7c7b\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"onApplicationEvent()"),"\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n  /**\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\n     * @param event\n     */\n    @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\n        for (DataChangedListener listener : listeners) {\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\n            switch (event.getGroupKey()) {\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\n                    break;\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\n                    break;\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\n                    break;\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\n                    break;\n                case META_DATA:  // \u5143\u6570\u636e\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\n                    break;\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\n                    throw new IllegalStateException("Unexpected value: " + event.getGroupKey());\n            }\n        }\n    }\n    \n}\n')),(0,i.kt)("p",null,"\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"onApplicationEvent"),"\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u662f\u4e94\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u548c\u5143\u6570\u636e\u3002"),(0,i.kt)("p",null,"\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedListener"),"\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u5b83\u7684\u5177\u4f53\u5b9e\u73b0\u6709\uff1a"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(24668).Z})),(0,i.kt)("p",null,"\u8fd9\u51e0\u4e2a\u5b9e\u73b0\u7c7b\u5c31\u662f\u5f53\u524d",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u652f\u6301\u7684\u540c\u6b65\u7b56\u7565\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"WebsocketDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"li"},"websocket"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ZookeeperDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"li"},"zookeeper"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ConsulDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"li"},"consul"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EtcdDataDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"li"},"etcd"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"HttpLongPollingDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"li"},"http\u957f\u8f6e\u8be2"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"NacosDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"li"},"nacos"),"\u7684\u6570\u636e\u540c\u6b65\uff1b")),(0,i.kt)("p",null,"\u65e2\u7136\u6709\u8fd9\u4e48\u591a\u79cd\u5b9e\u73b0\u7b56\u7565\uff0c\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u5462\uff1f"),(0,i.kt)("p",null,"\u56e0\u4e3a\u672c\u6587\u662f\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"Etcd"),"\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ee5",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdDataDataChangedListener"),"\u4e3a\u4f8b\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u88ab\u52a0\u8f7d\u5e76\u5b9e\u73b0\u7684\u3002"),(0,i.kt)("p",null,"\u901a\u8fc7\u67e5\u770b\u5bf9",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdDataDataChangedListener"),"\u7c7b\u7684\u8c03\u7528\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u5b83\u662f\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"DataSyncConfiguration"),"\u7c7b\u8fdb\u884c\u914d\u7f6e\u7684\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\n * The type Data sync configuration.\n */\n@Configuration\npublic class DataSyncConfiguration {\n\n   //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\n  \n  /**\n   * The type Etcd listener.\n   */\n  @Configuration\n  @ConditionalOnProperty(prefix = "shenyu.sync.etcd", name = "url")\n  @EnableConfigurationProperties(EtcdProperties.class)\n  static class EtcdListener {\n\n    @Bean\n    public EtcdClient etcdClient(final EtcdProperties etcdProperties) {\n      Client client = Client.builder()\n              .endpoints(etcdProperties.getUrl())\n              .build();\n      return new EtcdClient(client);\n    }\n\n    /**\n     * Config event listener data changed listener.\n     * \u521b\u5efaEtcd\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\n     * @param etcdClient the etcd client\n     * @return the data changed listener\n     */\n    @Bean\n    @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)\n    public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {\n      return new EtcdDataDataChangedListener(etcdClient);\n    }\n\n    /**\n     * data init.\n     * \u521b\u5efaEtcd\u6570\u636e\u521d\u59cb\u5316\u7c7b\n     * @param etcdClient        the etcd client\n     * @param syncDataService the sync data service\n     * @return the etcd data init\n     */\n    @Bean\n    @ConditionalOnMissingBean(EtcdDataInit.class)\n    public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {\n      return new EtcdDataInit(etcdClient, syncDataService);\n    }\n  }\n    \n    //\u7701\u7565\u4e86\u5176\u4ed6\u4ee3\u7801......\n}\n\n')),(0,i.kt)("p",null,"\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u662f\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"SpringBoot"),"\u6761\u4ef6\u88c5\u914d\u7c7b\u5b9e\u73b0\u7684\u3002\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdListener"),"\u7c7b\u4e0a\u9762\u6709\u51e0\u4e2a\u6ce8\u89e3\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"@Configuration"),"\uff1a\u914d\u7f6e\u6587\u4ef6\uff0c\u5e94\u7528\u4e0a\u4e0b\u6587\uff1b")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},'@ConditionalOnProperty(prefix = "shenyu.sync.etcd", name = "url")'),"\uff1a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u91c7\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-properties"},"shenyu:  \n  sync:\n     etcd:\n          url: localhost:2181\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"@EnableConfigurationProperties(EtcdProperties.class)"),"\uff1a\u5bfc\u5165\u53e6\u4e00\u4e2a\u5c5e\u6027\u7c7b",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdProperties"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdProperties"),"\u4e2d\u5404\u5c5e\u6027\u5bf9\u5e94\u914d\u7f6e\u6587\u4ef6\u4e2d\u4ee5",(0,i.kt)("inlineCode",{parentName:"p"},"shenyu.sync.etcd"),"\u4f5c\u4e3a\u524d\u7f00\u7684\u5404\u5c5e\u6027\u3002"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Data\n@ConfigurationProperties(prefix = "shenyu.sync.etcd")\npublic class EtcdProperties {\n\n  private String url;\n\n  private Integer sessionTimeout;\n\n  private Integer connectionTimeout;\n\n  private String serializer;\n}\n')),(0,i.kt)("p",null,"\u5f53\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"shenyu.sync.etcd.url"),"\u5c5e\u6027\u65f6\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"Admin"),"\u5c06\u91c7\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u6b64\u65f6\u914d\u7f6e\u7c7b",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdListener"),"\u4f1a\u751f\u6548\uff0c\u5e76\u751f\u6210",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdClient"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdDataDataChangedListener"),"\u548c",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdDataInit"),"\u7c7b\u578b\u7684bean\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u751f\u6210",(0,i.kt)("inlineCode",{parentName:"li"},"EtcdClient"),"\u7c7b\u578b\u7684bean\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"etcdClient"),"\uff0c\u8fd9\u4e2abean\u6839\u636e\u914d\u7f6e\u6587\u4ef6\uff0c\u914d\u7f6e\u4e86\u4e0eetcd\u670d\u52a1\u5668\u7684\u8fde\u63a5\u4fe1\u606f\uff0c\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5cetcd\u8282\u70b9\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u751f\u6210",(0,i.kt)("inlineCode",{parentName:"li"},"EtcdDataDataChangedListener"),"\u7c7b\u578b\u7684bean\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"etcdDataDataChangedListener"),"\uff0c\u8fd9\u4e2abean\u5c06bean",(0,i.kt)("inlineCode",{parentName:"li"},"etcdClient"),"\u4f5c\u4e3a\u6210\u5458\u53d8\u91cf\uff0c\u5f53\u76d1\u542c\u5230\u4e8b\u4ef6\u65f6\uff0c\u8fdb\u884c\u56de\u8c03\u64cd\u4f5c\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8be5bean\u64cd\u4f5cetcd\u8282\u70b9\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u751f\u6210",(0,i.kt)("inlineCode",{parentName:"li"},"EtcdDataInit"),"\u7c7b\u578b\u7684bean\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"etcdDataInit"),"\uff0c\u8fd9\u4e2abean\u5c06bean",(0,i.kt)("inlineCode",{parentName:"li"},"etcdClient"),"\u548cbean",(0,i.kt)("inlineCode",{parentName:"li"},"syncDataService"),"\u4f5c\u4e3a\u6210\u5458\u53d8\u91cf\uff0c\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"li"},"etcdClient"),"\u6839\u636eetcd\u8def\u5f84\uff0c\u5224\u65ad\u6570\u636e\u662f\u5426\u672a\u521d\u59cb\u5316\uff0c\u5f53\u672a\u521d\u59cb\u5316\u65f6\uff0c\u5c06\u8c03\u7528syncDataService\u8fdb\u884c\u5237\u65b0\u64cd\u4f5c\uff0c\u5c06\u5728\u4e0b\u6587\u8be6\u8ff0\u3002\n\u6839\u636e\u4e0a\u6587\u6240\u8ff0\uff0c\u5728\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5",(0,i.kt)("inlineCode",{parentName:"li"},"onApplicationEvent()"),"\u4e2d\uff0c\u5c31\u4f1a\u5230\u76f8\u5e94\u7684",(0,i.kt)("inlineCode",{parentName:"li"},"listener"),"\u4e2d\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u662f\u5bf9\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u6570\u636e\u540c\u6b65\u91c7\u7528\u7684\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"etcd"),"\uff0c\u6240\u4ee5\uff0c\u4ee3\u7801\u4f1a\u8fdb\u5165\u5230",(0,i.kt)("inlineCode",{parentName:"li"},"EtcdDataDataChangedListener"),"\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'    //DataChangedEventDispatcher.java\n        @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\n        for (DataChangedListener listener : listeners) {\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\n            switch (event.getGroupKey()) {\n                    \n                // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\n                    \n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // \u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u4f1a\u8fdb\u5165\u5230EtcdDataDataChangedListener\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\n                    break;\n         }\n    }\n')),(0,i.kt)("h4",{id:"24-etcd\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668"},"2.4 Etcd\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"EtcdDataDataChangedListener.onSelectorChanged()"),(0,i.kt)("p",{parentName:"li"},"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"onSelectorChanged()"),"\u65b9\u6cd5\u4e2d\uff0c\u5224\u65ad\u64cd\u4f5c\u7c7b\u578b\uff0c\u662f\u5237\u65b0\u540c\u6b65\u8fd8\u662f\u66f4\u65b0\u6216\u521b\u5efa\u540c\u6b65\u3002\u6839\u636e\u5f53\u524d\u9009\u62e9\u5668\u6570\u636e\u4fe1\u606f\u5224\u65ad\u8282\u70b9\u662f\u5426\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u4e2d\u3002"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * EtcdDataDataChangedListener.\n */\n@Slf4j\npublic class EtcdDataDataChangedListener implements DataChangedListener {\n\n    private final EtcdClient etcdClient;\n\n    public EtcdDataDataChangedListener(final EtcdClient client) {\n        this.etcdClient = client;\n    }\n\n    // \u9009\u62e9\u5668\u4fe1\u606f\u53d1\u751f\u6539\u53d8\n    @Override\n    public void onSelectorChanged(final List<SelectorData> changed, final DataEventTypeEnum eventType) {\n      // \u5237\u65b0\u64cd\u4f5c\n      if (eventType == DataEventTypeEnum.REFRESH && !changed.isEmpty()) {\n        String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());\n        etcdClient.deleteEtcdPathRecursive(selectorParentPath);\n      }\n      // \u53d1\u751f\u53d8\u66f4\u7684\u6570\u636e\n      for (SelectorData data : changed) {\n        // \u6784\u5efa\u9009\u62e9\u5668\u6570\u636e\u7684\u771f\u5b9e\u8def\u5f84\n        String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());\n        //\u5220\u9664\u64cd\u4f5c\n        if (eventType == DataEventTypeEnum.DELETE) {\n          etcdClient.delete(selectorRealPath);\n          continue;\n        }\n        //create or update\uff0c\u521b\u5efa\u6216\u66f4\u65b0\u64cd\u4f5c\n        updateNode(selectorRealPath, data);\n      }\n    }\n    \n}\n")),(0,i.kt)("p",null,"\u8fd9\u90e8\u5206\u662f\u6838\u5fc3\u3002",(0,i.kt)("inlineCode",{parentName:"p"},"changed"),"\u8868\u793a\u9700\u66f4\u65b0\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorData"),"\u5217\u8868\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"eventType"),"\u8868\u793a\u4e8b\u4ef6\u7c7b\u578b\u3002\u5f53\u4e8b\u4ef6\u7c7b\u578b\u4e3a\u5237\u65b0",(0,i.kt)("inlineCode",{parentName:"p"},"REFRESH"),"\uff0c\u5e76\u4e14",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorData"),"\u6709\u6539\u52a8\u65f6\uff0c\u4f1a\u5148\u5c06etcd\u4e2d\u8be5plugin\u4e0b\u7684selector\u8282\u70b9\u90fd\u5148\u5220\u9664\u3002\u6ce8\u610f\u8fd9\u91cc\u7684\u6761\u4ef6",(0,i.kt)("inlineCode",{parentName:"p"},"SelectorData"),"\u6709\u6539\u52a8\u662f\u5fc5\u987b\u7684\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u6ca1\u6709\u6539\u52a8\u65f6\u8fdb\u884c\u5237\u65b0\uff0c\u5c06\u6240\u6709selector\u8282\u70b9\u90fd\u5220\u9664\u7684bug\u3002\n\u83b7\u53d6\u5230selector\u5bf9\u5e94\u8def\u5f84\u540e\uff0c\u4f1a\u5bf9\u8282\u70b9\u8fdb\u884c\u5220\u9664\u3001\u521b\u5efa\u6216\u66f4\u65b0\u3002"),(0,i.kt)("p",null,"\u53ea\u8981\u5c06\u53d8\u52a8\u7684\u6570\u636e\u6b63\u786e\u5199\u5165\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u7684\u8282\u70b9\u4e0a\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"admin"),"\u8fd9\u8fb9\u7684\u64cd\u4f5c\u5c31\u6267\u884c\u5b8c\u6210\u4e86\u3002"),(0,i.kt)("p",null,"\u5728\u6211\u4eec\u5f53\u524d\u7684\u6848\u4f8b\u4e2d\uff0c\u5bf9",(0,i.kt)("inlineCode",{parentName:"p"},"Divide"),"\u63d2\u4ef6\u4e2d\u7684\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u5c06\u6743\u91cd\u66f4\u65b0\u4e3a90\uff0c\u5c31\u4f1a\u5bf9\u56fe\u4e2d\u7684\u7279\u5b9a\u8282\u70b9\u66f4\u65b0\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(83780).Z})),(0,i.kt)("p",null,"\u6211\u4eec\u7528\u65f6\u5e8f\u56fe\u5c06\u4e0a\u9762\u7684\u66f4\u65b0\u6d41\u7a0b\u4e32\u8054\u8d77\u6765\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(42315).Z})),(0,i.kt)("h3",{id:"3-\u7f51\u5173\u6570\u636e\u540c\u6b65"},"3. \u7f51\u5173\u6570\u636e\u540c\u6b65"),(0,i.kt)("p",null,"\u5047\u8bbe",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u7f51\u5173\u5df2\u7ecf\u5728\u6b63\u5e38\u8fd0\u884c\uff0c\u4f7f\u7528\u7684\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e5f\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u3002\u90a3\u4e48\u5f53\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"admin"),"\u7aef\u66f4\u65b0\u9009\u62e9\u5668\u6570\u636e\u540e\uff0c\u5e76\u4e14\u5411",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u53d1\u9001\u4e86\u53d8\u66f4\u7684\u6570\u636e\uff0c\u90a3\u7f51\u5173\u662f\u5982\u4f55\u63a5\u6536\u5e76\u5904\u7406\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7ee7\u7eed\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u4e00\u63a2\u7a76\u7adf\u3002"),(0,i.kt)("h4",{id:"31-etcdclient\u63a5\u6536\u6570\u636e"},"3.1 EtcdClient\u63a5\u6536\u6570\u636e"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"EtcdClient.watchDataChange()")),(0,i.kt)("p",null,"\u5728\u7f51\u5173\u7aef\u6709\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdSyncDataService"),"\u7c7b\uff0c\u5b83\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"etcdClient"),"\u8ba2\u9605\u4e86\u6570\u636e\u8282\u70b9\uff0c\u5f53\u6570\u636e\u53d1\u751f\u53d8\u66f4\u65f6\uff0c\u53ef\u4ee5\u611f\u77e5\u5230\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * Data synchronize of etcd.\n */\n@Slf4j\npublic class EtcdSyncDataService implements SyncDataService, AutoCloseable {\n    //\u7701\u7565\u5176\u5b83\u4ee3\u7801\n    private void subscribeSelectorDataChanges(final String path) {\n      etcdClient.watchDataChange(path, (updateNode, updateValue) -> cacheSelectorData(updateValue),\n              this::unCacheSelectorData);\n    }\n  //\u7701\u7565\u5176\u5b83\u4ee3\u7801\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Etcd"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"Watch"),"\u673a\u5236\uff0c\u4f1a\u7ed9\u8ba2\u9605\u7684\u5ba2\u6237\u7aef\u53d1\u9001\u8282\u70b9\u53d8\u66f4\u901a\u77e5\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u66f4\u65b0\u9009\u62e9\u5668\u4fe1\u606f\uff0c\u5c31\u4f1a\u8fdb\u5165\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"watchDataChange()"),"\u65b9\u6cd5\u3002\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"cacheSelectorData()"),"\u53bb\u5904\u7406\u6570\u636e\u3002"),(0,i.kt)("h4",{id:"32-\u5904\u7406\u6570\u636e"},"3.2 \u5904\u7406\u6570\u636e"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"EtcdSyncDataService.cacheSelectorData()")),(0,i.kt)("p",null,"\u7ecf\u8fc7\u5224\u7a7a\u903b\u8f91\u4e4b\u540e\uff0c\u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684\u64cd\u4f5c\u53c8\u4ea4\u7ed9\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"PluginDataSubscriber"),"\u5904\u7406\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"    private void cacheSelectorData(final String dataString) {\n        final SelectorData selectorData = GsonUtils.getInstance().fromJson(dataString, SelectorData.class);\n        Optional.ofNullable(selectorData)\n            .ifPresent(data -> Optional.ofNullable(pluginDataSubscriber).ifPresent(e -> e.onSelectorSubscribe(data)));\n        }\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"PluginDataSubscriber"),"\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b83\u53ea\u6709\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"CommonPluginDataSubscriber"),"\u5b9e\u73b0\u7c7b\uff0c\u8d1f\u8d23\u5904\u7406\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\u3002"),(0,i.kt)("h4",{id:"33-\u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005"},"3.3 \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"PluginDataSubscriber.onSelectorSubscribe()")),(0,i.kt)("p",null,"\u5b83\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"subscribeDataHandler()"),"\u65b9\u6cd5\u3002\u5728\u65b9\u6cd5\u4e2d\uff0c\u66f4\u5177\u6570\u636e\u7c7b\u578b\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u6216\u89c4\u5219\uff09\uff0c\u64cd\u4f5c\u7c7b\u578b\uff08\u66f4\u65b0\u6216\u5220\u9664\uff09\uff0c\u53bb\u6267\u884c\u4e0d\u540c\u903b\u8f91\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\n * The type Common plugin data subscriber.\n */\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\n    //......\n     // \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\n    @Override\n    public void onSelectorSubscribe(final SelectorData selectorData) {\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\n    }    \n    \n    // \u8ba2\u9605\u6570\u636e\u5904\u7406\u5668\uff0c\u5904\u7406\u6570\u636e\u7684\u66f4\u65b0\u6216\u5220\u9664\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\n        Optional.ofNullable(classData).ifPresent(data -> {\n            // \u63d2\u4ef6\u6570\u636e\n            if (data instanceof PluginData) {\n                PluginData pluginData = (PluginData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cachePluginData(pluginData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removePluginData(pluginData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\n                }\n            } else if (data instanceof SelectorData) {  // \u9009\u62e9\u5668\u6570\u636e\n                SelectorData selectorData = (SelectorData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\n                }\n            } else if (data instanceof RuleData) {  // \u89c4\u5219\u6570\u636e\n                RuleData ruleData = (RuleData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\n                } else if (dataType == DataEventTypeEnum.DELETE) { // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\n                }\n            }\n        });\n    }\n    \n}\n")),(0,i.kt)("h4",{id:"34-\u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58"},"3.4 \u6570\u636e\u7f13\u5b58\u5230\u5185\u5b58"),(0,i.kt)("p",null,"\u90a3\u4e48\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684\u903b\u8f91\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"// \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\nBaseDataCache.getInstance().cacheSelectData(selectorData);\n// \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                    \nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n")),(0,i.kt)("p",null,"\u4e00\u662f\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u7684\u5185\u5b58\u4e2d\u3002",(0,i.kt)("inlineCode",{parentName:"p"},"BaseDataCache"),"\u662f\u6700\u7ec8\u7f13\u5b58\u6570\u636e\u7684\u7c7b\uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\u3002\u9009\u62e9\u5668\u6570\u636e\u5c31\u5b58\u5230\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"SELECTOR_MAP"),"\u8fd9\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"Map"),"\u4e2d\u3002\u5728\u540e\u7eed\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e5f\u662f\u4ece\u8fd9\u91cc\u62ff\u6570\u636e\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"public final class BaseDataCache {\n    // \u79c1\u6709\u53d8\u91cf\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\n    // \u79c1\u6709\u6784\u9020\u5668\n    private BaseDataCache() {\n    }\n    \n    /**\n     * Gets instance.\n     *  \u516c\u5f00\u65b9\u6cd5\n     * @return the instance\n     */\n    public static BaseDataCache getInstance() {\n        return INSTANCE;\n    }\n    \n    /**\n    *  \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684Map\n     * pluginName -> SelectorData.\n     */\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\n    \n    public void cacheSelectData(final SelectorData selectorData) {\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\n    }\n        \n   /**\n     * cache selector data.\n     * \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\n     * @param data the selector data\n     */\n    private void selectorAccept(final SelectorData data) {\n        String key = data.getPluginName();\n        if (SELECTOR_MAP.containsKey(key)) { // \u66f4\u65b0\u64cd\u4f5c\uff0c\u5148\u5220\u9664\u518d\u63d2\u5165\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\n            resultList.add(data);\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\n            SELECTOR_MAP.put(key, collect);\n        } else {  // \u65b0\u589e\u64cd\u4f5c\uff0c\u76f4\u63a5\u653e\u5230Map\u4e2d\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\n        }\n    }\n    \n}\n")),(0,i.kt)("p",null,"\u4e8c\u662f\u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\u3002  \u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"idea"),"\u7f16\u8f91\u5668\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u540e\uff0c\u6709\u5982\u4e0b\u7684\u63d2\u4ef6\u8fd8\u6709\u5904\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u5c55\u5f00\u4e86\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(59469).Z})),(0,i.kt)("p",null,"\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u6e90\u7801\u8ffd\u8e2a\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\uff0c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"admin"),"\u7aef\u65b0\u589e\u66f4\u65b0\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u5c31\u5c06",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5206\u6790\u6e05\u695a\u4e86\u3002"),(0,i.kt)("p",null,"\u6211\u4eec\u8fd8\u662f\u901a\u8fc7\u65f6\u5e8f\u56fe\u5c06\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u6d41\u7a0b\u4e32\u8054\u4e00\u4e0b\uff1a"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(86622).Z})),(0,i.kt)("p",null,"\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5df2\u7ecf\u5206\u6790\u5b8c\u4e86\uff0c\u4e3a\u4e86\u4e0d\u8ba9\u540c\u6b65\u6d41\u7a0b\u88ab\u6253\u65ad\uff0c\u5728\u5206\u6790\u8fc7\u7a0b\u4e2d\u5c31\u5ffd\u7565\u4e86\u5176\u4ed6\u903b\u8f91\u3002\u6211\u4eec\u8fd8\u9700\u8981\u5206\u6790",(0,i.kt)("inlineCode",{parentName:"p"},"Admin"),"\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316\u548c\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316\u7684\u6d41\u7a0b\u3002"),(0,i.kt)("h3",{id:"4-admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316"},"4. Admin\u540c\u6b65\u6570\u636e\u521d\u59cb\u5316"),(0,i.kt)("p",null,"\u5f53",(0,i.kt)("inlineCode",{parentName:"p"},"admin"),"\u542f\u52a8\u540e\uff0c\u4f1a\u5c06\u5f53\u524d\u7684\u6570\u636e\u4fe1\u606f\u5168\u91cf\u540c\u6b65\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u4e2d\uff0c\u5b9e\u73b0\u903b\u8f91\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'\n/**\n * EtcdDataInit.\n */\n@Slf4j\npublic class EtcdDataInit implements CommandLineRunner {\n\n  private final EtcdClient etcdClient;\n\n  private final SyncDataService syncDataService;\n\n  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {\n    this.etcdClient = client;\n    this.syncDataService = syncDataService;\n  }\n\n  @Override\n  public void run(final String... args) throws Exception {\n    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;\n    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;\n    final String metaDataPath = DefaultPathConstants.META_DATA;\n    if (!etcdClient.exists(pluginPath) && !etcdClient.exists(authPath) && !etcdClient.exists(metaDataPath)) {\n      log.info("Init all data from database");\n      syncDataService.syncAll(DataEventTypeEnum.REFRESH);\n    }\n  }\n}\n\n')),(0,i.kt)("p",null,"\u5224\u65ad",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u4e2d\u662f\u5426\u5b58\u5728\u6570\u636e\uff0c\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u8fdb\u884c\u540c\u6b65\u3002"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"EtcdDataInit"),"\u5b9e\u73b0\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"CommandLineRunner"),"\u63a5\u53e3\u3002\u5b83\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"springboot"),"\u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u4f1a\u5728\u6240\u6709 ",(0,i.kt)("inlineCode",{parentName:"p"},"Spring Beans"),"\u521d\u59cb\u5316\u4e4b\u540e\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"run()"),"\u65b9\u6cd5\uff0c\u5e38\u7528\u4e8e\u9879\u76ee\u4e2d\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"SyncDataService.syncAll()")),(0,i.kt)("p",null,"\u4ece\u6570\u636e\u5e93\u67e5\u8be2\u6570\u636e\uff0c\u7136\u540e\u8fdb\u884c\u5168\u91cf\u6570\u636e\u540c\u6b65\uff0c\u6240\u6709\u7684\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u548c\u5143\u6570\u636e\u4fe1\u606f\u3002\u4e3b\u8981\u662f\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher"),"\u53d1\u5e03\u540c\u6b65\u4e8b\u4ef6\u3002\u8fd9\u91cc\u5c31\u8ddf\u524d\u9762\u63d0\u5230\u7684\u540c\u6b65\u903b\u8f91\u5c31\u53c8\u8054\u7cfb\u8d77\u6765\u4e86\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"eventPublisher"),"\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"publishEvent()"),"\u53d1\u5e03\u5b8c\u4e8b\u4ef6\u540e\uff0c\u6709",(0,i.kt)("inlineCode",{parentName:"p"},"ApplicationListener"),"\u6267\u884c\u4e8b\u4ef6\u53d8\u66f4\u64cd\u4f5c\uff0c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"DataChangedEventDispatcher"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"@Service\npublic class SyncDataServiceImpl implements SyncDataService {\n    // \u4e8b\u4ef6\u53d1\u5e03\n    private final ApplicationEventPublisher eventPublisher;\n    \n     /***\n     * \u5168\u91cf\u6570\u636e\u540c\u6b65\n     * @param type the type\n     * @return\n     */\n    @Override\n    public boolean syncAll(final DataEventTypeEnum type) {\n        // \u540c\u6b65\u8ba4\u8bc1\u4fe1\u606f\n        appAuthService.syncData();\n        // \u540c\u6b65\u63d2\u4ef6\u4fe1\u606f\n        List<PluginData> pluginDataList = pluginService.listAll();\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));\n        // \u540c\u6b65\u9009\u62e9\u5668\u4fe1\u606f\n        List<SelectorData> selectorDataList = selectorService.listAll();\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));\n        // \u540c\u6b65\u89c4\u5219\u4fe1\u606f\n        List<RuleData> ruleDataList = ruleService.listAll();\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));\n        // \u540c\u6b65\u5143\u6570\u636e\u4fe1\u606f\n        metaDataService.syncData();\n        return true;\n    }\n    \n}\n")),(0,i.kt)("h3",{id:"5-\u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316"},"5. \u7f51\u5173\u540c\u6b65\u64cd\u4f5c\u521d\u59cb\u5316"),(0,i.kt)("p",null,"\u7f51\u5173\u8fd9\u8fb9\u7684\u6570\u636e\u540c\u6b65\u521d\u59cb\u5316\u64cd\u4f5c\u4e3b\u8981\u662f\u8ba2\u9605",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u4e2d\u7684\u8282\u70b9\uff0c\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u6536\u5230\u53d8\u66f4\u6570\u636e\u3002\u8fd9\u4f9d\u8d56\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"Etcd"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"Watch"),"\u673a\u5236\u3002\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\uff0c\u8d1f\u8d23",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u6570\u636e\u540c\u6b65\u7684\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"EtcdSyncDataService"),"\uff0c\u4e5f\u5728\u524d\u9762\u63d0\u5230\u8fc7\u3002"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"EtcdSyncDataService"),"\u7684\u529f\u80fd\u903b\u8f91\u662f\u5728\u5b9e\u4f8b\u5316\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\uff1a\u5bf9",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"shenyu"),"\u6570\u636e\u540c\u6b65\u8282\u70b9\u5b8c\u6210\u8ba2\u9605\u3002\u8fd9\u91cc\u7684\u8ba2\u9605\u5206\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u5df2\u7ecf\u5b58\u5728\u7684\u8282\u70b9\u4e0a\u9762\u6570\u636e\u53d1\u751f\u66f4\u65b0\uff0c\u8fd9\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"etcdClient.watchDataChange()"),"\u65b9\u6cd5\u5b9e\u73b0\uff1b\u53e6\u4e00\u7c7b\u662f\u5f53\u524d\u8282\u70b9\u4e0b\u6709\u65b0\u589e\u6216\u5220\u9664\u8282\u70b9\uff0c\u5373\u5b50\u8282\u70b9\u53d1\u751f\u53d8\u5316\uff0c\u8fd9\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"etcdClient.watchChildChange()"),"\u65b9\u6cd5\u5b9e\u73b0\u3002"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"EtcdSyncDataService"),"\u7684\u4ee3\u7801\u6709\u70b9\u591a\uff0c\u8fd9\u91cc\u6211\u4eec\u4ee5\u63d2\u4ef6\u6570\u636e\u7684\u8bfb\u53d6\u548c\u8ba2\u9605\u8fdb\u884c\u8ffd\u8e2a\uff0c\u5176\u4ed6\u7c7b\u578b\u7684\u6570\u636e\u64cd\u4f5c\u539f\u7406\u662f\u4e00\u6837\u7684\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * etcd \u6570\u636e\u540c\u6b65\u670d\u52a1\n */\n@Slf4j\npublic class EtcdSyncDataService implements SyncDataService, AutoCloseable {\n  // \u5728\u5b9e\u4f8b\u5316\u7684\u65f6\u5019\uff0c\u5b8c\u6210\u4eceetcd\u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u64cd\u4f5c\uff0c\u5e76\u8ba2\u9605\u8282\u70b9\n  public EtcdSyncDataService(/*\u7701\u7565\u6784\u9020\u53c2\u6570*/) {\n    this.etcdClient = etcdClient;\n    this.pluginDataSubscriber = pluginDataSubscriber;\n    this.metaDataSubscribers = metaDataSubscribers;\n    this.authDataSubscribers = authDataSubscribers;\n    // \u8ba2\u9605\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\n    watcherData();\n    // \u8ba2\u9605\u8ba4\u8bc1\u6570\u636e\n    watchAppAuth();\n    // \u8ba2\u9605\u5143\u6570\u636e\n    watchMetaData();\n  }\n\n  private void watcherData() {\n    // \u63d2\u4ef6\u8282\u70b9\u8def\u5f84\n    final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;\n    // \u6240\u6709\u63d2\u4ef6\u8282\u70b9\n    List<String> pluginZKs = etcdClientGetChildren(pluginParent);\n    for (String pluginName : pluginZKs) {\n      // \u8ba2\u9605\u5f53\u524d\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\n      watcherAll(pluginName);\n    }\n    // \u8ba2\u9605\u5b50\u8282\u70b9\uff08\u65b0\u589e\u6216\u5220\u9664\u4e00\u4e2a\u63d2\u4ef6\uff09\n    etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -> {\n      if (!updateNode.isEmpty()) {\n        // \u9700\u8981\u8ba2\u9605\u5b50\u8282\u70b9\u7684\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u6570\u636e\n        watcherAll(updateNode);\n      }\n    }, null);\n  }\n\n  private void watcherAll(final String pluginName) {\n    // \u8ba2\u9605\u63d2\u4ef6\u6570\u636e\n    watcherPlugin(pluginName);\n    // \u8ba2\u9605\u9009\u62e9\u5668\u6570\u636e\n    watcherSelector(pluginName);\n    // \u8ba2\u9605\u89c4\u5219\u6570\u636e\n    watcherRule(pluginName);\n  }\n\n  private void watcherPlugin(final String pluginName) {\n    // \u5f53\u524d\u63d2\u4ef6\u8def\u5f84\n    String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);\n    // \u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d\n    cachePluginData(etcdClient.get(pluginPath));\n    // \u8ba2\u9605\u63d2\u4ef6\u8282\u70b9\n    subscribePluginDataChanges(pluginPath, pluginName);\n  }\n  \n  private void cachePluginData(final String dataString) {\n    final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);\n    Optional.ofNullable(pluginData)\n      .flatMap(data -> Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -> e.onSubscribe(pluginData));\n  }  \n\n  private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {\n    // \u8ba2\u9605\u6570\u636e\u53d8\u66f4\uff1a\u66f4\u65b0\u6216\u5220\u9664\uff0c\u4e24\u4e2alambda\u8868\u8fbe\u5f0f\u5206\u522b\u4e3a\u66f4\u65b0\u548c\u5220\u9664\u64cd\u4f5c\n    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -> {\n      final String dataPath = buildRealPath(pluginPath, updatePath);\n      final String dataStr = etcdClient.get(dataPath);\n      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);\n      Optional.ofNullable(data)\n              .ifPresent(d -> Optional.ofNullable(pluginDataSubscriber).ifPresent(e -> e.onSubscribe(d)));\n    }, deleteNode -> deletePlugin(pluginName));\n  }\n\n}\n")),(0,i.kt)("p",null,"\u4e0a\u9762\u7684\u6e90\u4ee3\u7801\u4e2d\u90fd\u7ed9\u51fa\u4e86\u6ce8\u91ca\uff0c\u76f8\u4fe1\u5927\u5bb6\u53ef\u4ee5\u770b\u660e\u767d\u3002\u8ba2\u9605\u63d2\u4ef6\u6570\u636e\u7684\u4e3b\u8981\u903b\u8f91\u5982\u4e0b\uff1a"),(0,i.kt)("blockquote",null,(0,i.kt)("ol",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ol"},"\u6784\u9020\u5f53\u524d\u63d2\u4ef6\u8def\u5f84"),(0,i.kt)("li",{parentName:"ol"},"\u8bfb\u53d6etcd\u4e0a\u5f53\u524d\u8282\u70b9\u6570\u636e\uff0c\u5e76\u53cd\u5e8f\u5217\u5316"),(0,i.kt)("li",{parentName:"ol"},"\u63d2\u4ef6\u6570\u636e\u7f13\u5b58\u5230\u7f51\u5173\u5185\u5b58\u4e2d"),(0,i.kt)("li",{parentName:"ol"},"\u8ba2\u9605\u63d2\u4ef6\u8282\u70b9"))),(0,i.kt)("h3",{id:"6-\u603b\u7ed3"},"6. \u603b\u7ed3"),(0,i.kt)("p",null,"\u672c\u6587\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\uff0c\u5bf9",(0,i.kt)("inlineCode",{parentName:"p"},"etcd"),"\u7684\u6570\u636e\u540c\u6b65\u539f\u7406\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u57fa\u4e8e",(0,i.kt)("inlineCode",{parentName:"li"},"etcd"),"\u7684\u6570\u636e\u540c\u6b65\uff0c\u4e3b\u8981\u662f\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"li"},"watch"),"\u673a\u5236\u5b9e\u73b0\uff1b"),(0,i.kt)("li",{parentName:"ul"},"\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"li"},"Spring"),"\u5b8c\u6210\u4e8b\u4ef6\u53d1\u5e03\u548c\u76d1\u542c\uff1b"),(0,i.kt)("li",{parentName:"ul"},"\u901a\u8fc7\u62bd\u8c61",(0,i.kt)("inlineCode",{parentName:"li"},"DataChangedListener"),"\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u540c\u6b65\u7b56\u7565\uff0c\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff1b"),(0,i.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u5355\u4f8b\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0\u7f13\u5b58\u6570\u636e\u7c7b",(0,i.kt)("inlineCode",{parentName:"li"},"BaseDataCache"),"\uff1b"),(0,i.kt)("li",{parentName:"ul"},"\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"li"},"SpringBoot"),"\u7684\u6761\u4ef6\u88c5\u914d\u548c",(0,i.kt)("inlineCode",{parentName:"li"},"starter"),"\u52a0\u8f7d\u673a\u5236\u5b9e\u73b0\u914d\u7f6e\u7c7b\u7684\u52a0\u8f7d\u3002")))}s.isMDXComponent=!0},42315:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/etcd-sync-sequence-admin-zh-d9ccd2c6bd5f9b3f135c5420b60fd403.png"},86622:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/etcd-sync-sequence-gateway-zh-708de62d8fafbb80c133b20247674db6.png"},24668:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"},59469:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"},15258:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"},83780:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"}}]);