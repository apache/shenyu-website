<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-2.6.0 docs-doc-page docs-doc-id-design/data-sync" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Data Sync Design | Apache ShenYu</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://shenyu.apache.org/docs/2.6.0/design/data-sync"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="2.6.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-2.6.0"><meta data-rh="true" name="docsearch:version" content="2.6.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-2.6.0"><meta data-rh="true" property="og:title" content="Data Sync Design | Apache ShenYu"><meta data-rh="true" name="description" content="Data Synchronization Design"><meta data-rh="true" property="og:description" content="Data Synchronization Design"><meta data-rh="true" name="keywords" content="Apache ShenYu"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://shenyu.apache.org/docs/2.6.0/design/data-sync"><link data-rh="true" rel="alternate" href="https://shenyu.apache.org/docs/2.6.0/design/data-sync" hreflang="en"><link data-rh="true" rel="alternate" href="https://shenyu.apache.org/zh/docs/2.6.0/design/data-sync" hreflang="zh"><link data-rh="true" rel="alternate" href="https://shenyu.apache.org/docs/2.6.0/design/data-sync" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://DY1AXAPBQY-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/opensearch.xml">







<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu Atom Feed">

<script src="/js/error-suppression.js"></script><link rel="stylesheet" href="/assets/css/styles.61e4db2b.css">
<script src="/assets/js/runtime~main.622ea6e2.js" defer="defer"></script>
<script src="/assets/js/main.f84fcaf0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Apache ShenYu Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/document">Docs</a><a class="navbar__item navbar__link" href="/community/contributor-guide">Community</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/event">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/2.6.0/design/data-sync" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh/docs/2.6.0/design/data-sync" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/2.6.0/">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/2.6.0/design/database-design">Design</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/design/database-design">Admin Database Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2.6.0/design/data-sync">Data Sync Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/design/flow-control">Flow Control Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/design/register-center-design">Client Registry Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/design/spi-design">SPI Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/design/wasm-plugin-design">WASM plugin design</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.6.0/deployment/deployment-before">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.6.0/quick-start/quick-start-brpc">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.6.0/user-guide/admin-usage/api-document">User Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.6.0/plugin-center/http-process/contextpath-plugin">Plugin Center</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.6.0/developer/spi/custom-load-balance">Developer</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/2.6.0/benchmark-test/">Benchmark Test</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Apache ShenYu<!-- --> <b>2.6.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/design/data-sync">latest version</a></b> (<!-- -->2.7.0.3<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Design</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Data Sync Design</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 2.6.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Data Sync Design</h1></header><p>This document explains the principle of data synchronization. Data synchronization refers to the strategy used to synchronize data to ShenYu gateway after shenyu-admin background operation data. ShenYu gateway currently supports ZooKeeper, WebSocket, HTTP Long Polling, Nacos, Etcd and Consul for data synchronization.</p>
<p>See <a href="/docs/2.6.0/user-guide/property-config/use-data-sync">Data Synchronization Configuration</a>  for configuration information about data synchronization.</p>
<img src="/img/shenyu/dataSync/data-sync-dir-en.png" width="90%" height="80%">
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preface">Preface<a href="#preface" class="hash-link" aria-label="Direct link to Preface" title="Direct link to Preface">​</a></h2>
<p>Gateway is the entrance of request and it is a very important part in micro service architecture, therefore the importance of gateway high availability is self-evident. When we use gateway, we have to change configuration such as flow rule, route rule for satisfying business requirement. Therefore, the dynamic configuration of the gateway is an important factor to ensure the high availability of the gateway.</p>
<p>In the actual use of Apache ShenYu Gateway, users also feedback some problems:</p>
<ul>
<li>
<p>Apache ShenYu depends on ZooKeeper, how to use Etcd, Consul, Nacos and other registry center?</p>
</li>
<li>
<p>Apache ShenYu depends on Redis and InfluxDB, and do not use limiting plugins or monitoring plugins. Why need these?</p>
</li>
<li>
<p>Why not use configuration center for configuration synchronization?</p>
</li>
<li>
<p>Why can&#x27;t updates be configured dynamically?</p>
</li>
<li>
<p>Every time you want to query the database, Redis is a better way.</p>
</li>
</ul>
<p>According to the feedback of users, we have also partially reconstructed ShenYu. The current data synchronization features are as follows:</p>
<ul>
<li>
<p>All configuration is cached in ShenYu gateway memory, each request uses local cache, which is very fast.</p>
</li>
<li>
<p>Users can modify any data in the background of shenyu-admin, and immediately synchronize to the gateway memory.</p>
</li>
<li>
<p>Support ShenYu plugin, selector, rule data, metadata, signature data and other data synchronization.</p>
</li>
<li>
<p>All plugin selectors and rules are configured dynamically and take effect immediately, no service restart required.</p>
</li>
<li>
<p>Data synchronization mode supports Zookeeper, HTTP long polling, Websocket, Nacos, Etcd and Consul.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="principle-analysis">Principle Analysis<a href="#principle-analysis" class="hash-link" aria-label="Direct link to Principle Analysis" title="Direct link to Principle Analysis">​</a></h2>
<p>The following figure shows the process of data synchronization of ShenYu. ShenYu Gateway will synchronize configuration data from configuration service at startup, and support push-pull mode to get configuration change information, and then update local cache. The administrator can change the user permissions, rules, plugins and traffic configuration in the admin system(shenyu-admin), and synchronize the change information to ShenYu Gateway through the push-pull mode. Whether the mode is push or pull depends on the synchronization mode used.</p>
<img src="/img/shenyu/dataSync/shenyu-config-processor-en.png" width="90%" height="80%">
<p>In the original version, the configuration service relied on the Zookeeper implementation to manage the back-end push of changes to the gateway. Now, WebSocket, HTTP long polling, ZooKeeper, Nacos, Etcd, and Consul can now be supported by specifying the corresponding synchronization policy by setting <code>shenyu.sync.${strategy}</code> in the configuration file. The default WeboSocket synchronization policy can be used to achieve second level data synchronization. However, it is important to note that Apache ShenYu Gateway and shenyu-admin must use the same synchronization policy.</p>
<p>As showing picture below,<code>shenyu-admin</code> will issue a configuration change notification through <code>EventPublisher</code> after users change configuration,<code>EventDispatcher</code> will handle this modification and send configuration to corresponding event handler according to configured synchronization strategy.</p>
<ul>
<li>If it is a <code>websocket</code> synchronization strategy,it will push modified data to <code>shenyu-web</code>,and corresponding <code>WebsocketDataHandler</code> handler will handle <code>shenyu-admin</code> data push at the gateway layer</li>
<li>If it is a  <code>zookeeper</code> synchronization strategy,it will push modified data to <code>zookeeper</code>,and the <code>ZookeeperSyncCache</code> will monitor the data changes of <code>zookeeper</code> and process them</li>
<li>If it is a  <code>http</code> synchronization strategy,<code>shenyu-web</code> proactively initiates long polling requests,90 seconds timeout by default,if there is no modified data in <code>shenyu-admin</code>,http request will be blocked,if there is a data change, it will respond to the changed data information,if there is no data change after 60 seconds,then respond with empty data,gateway continue to make http request after getting response,this kind of request will repeat.</li>
</ul>
<img src="/img/shenyu/dataSync/config-strategy-processor-en.png" width="90%" height="80%">
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zookeeper-synchronization">Zookeeper Synchronization<a href="#zookeeper-synchronization" class="hash-link" aria-label="Direct link to Zookeeper Synchronization" title="Direct link to Zookeeper Synchronization">​</a></h3>
<p>The zookeeper-based synchronization principle is very simple,it mainly depends on <code>zookeeper</code> watch mechanism,<code>shenyu-web</code> will monitor the configured node,when <code>shenyu-admin</code> starts,all the data will be written to <code>zookeeper</code>,it will incrementally update the nodes of <code>zookeeper</code> when data changes,at the same time, <code>shenyu-web</code> will monitor the node for configuration information, and update the local cache once the information changes</p>
<p><img loading="lazy" alt="Zookeeper Node Design" src="/assets/images/shenyu-data-sync-zookeeper-46808f3374aaa2ba781e90261596adf0.png" width="910" height="1490" class="img_ev3q"></p>
<p><code>Apache ShenYu</code> writes the configuration information to the zookeeper node,and it is meticulously designed. If you want to learn more about the code implementation, refer to the source code <code>ZookeeperSyncDataService</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="websocket-synchronization">WebSocket Synchronization<a href="#websocket-synchronization" class="hash-link" aria-label="Direct link to WebSocket Synchronization" title="Direct link to WebSocket Synchronization">​</a></h3>
<p>The mechanism of <code>websocket</code> and <code>zookeeper</code> is similar,when the gateway and the <code>shenyu-admin</code> establish a <code>websocket</code> connection,<code>shenyu-admin</code> will push all data at once,it will automatically push incremental data to <code>shenyu-web</code> through <code>websocket</code> when configured data changes</p>
<p>When we use websocket synchronization,pay attention to reconnect after disconnection,which also called keep heartbeat.<code>Apache ShenYu</code> uses <code>java-websocket</code> ,a third-party library,to connect to <code>websocket</code>. If you want to learn more about the code implementation, refer to the source code <code>WebsocketSyncDataService</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="http-long-polling">Http Long Polling<a href="#http-long-polling" class="hash-link" aria-label="Direct link to Http Long Polling" title="Direct link to Http Long Polling">​</a></h3>
<p>The mechanism of zookeeper and websocket data synchronization is relatively simple,but http synchronization will be relatively complicated.ShenYu borrows the design ideas of <code>Apollo</code> and <code>Nacos</code> and realizes <code>http</code> long polling data synchronization using their advantages.Note that this is not traditional ajax long polling.</p>
<img src="/img/shenyu/dataSync/http-long-polling-en.png" width="90%" height="80%">
<p>http long polling mechanism as above,shenyu-web gateway requests shenyu-admin configuration services,timeout is 90 seconds,it means gateway layer request configuration service will wait at most 90 seconds,this is convenient for shenyu-admin configuration service to respond modified data in time,and therefore we realize near real-time push.</p>
<p>After the http request reaches shenyu-admin, it does not respond immediately,but uses the asynchronous mechanism of Servlet3.0 to asynchronously respond to the data.First of all,put long polling request task <code>LongPollingClient</code> into <code>BlocingQueue</code>,and then start scheduling task,execute after 60 seconds,this aims to remove the long polling request from the queue after 60 seconds,even there is no configured data change.Because even if there is no configuration change,gateway also need to know,otherwise it will wait,and there is a 90 seconds timeout when the gateway requests configuration services.</p>
<p>If the administrator changes the configuration data during this period,the long polling requests in the queue will be removed one by one, and respond which group’s data has changed(we distribute plugins, rules, flow configuration , user configuration data into different groups).After gateway receives response,it only knows which Group has changed its configuration,it need to request again to get group configuration data.Someone may ask,why don&#x27;t you write out the changed data directly?We also discussed this issue deeply during development, because the http long polling mechanism can only guarantee quasi real-time,if gateway layer does not handle it in time,or administrator updates configuration frequently,we probably missed some configuration change push.For security, we only inform that a certain Group information has changed.</p>
<p>When <code>shenyu-web</code> gateway layer receives the http response information,pull modified information(if exists),and then request <code>shenyu-admin</code> configuration service again,this will repeatedly execute.   If you want to learn more about the code implementation, refer to the source code <code>HttpSyncDataService</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-synchronization">Nacos Synchronization<a href="#nacos-synchronization" class="hash-link" aria-label="Direct link to Nacos Synchronization" title="Direct link to Nacos Synchronization">​</a></h3>
<p>The synchronization principle of Nacos is basically similar to that of ZooKeeper, and it mainly depends on the configuration management of Nacos. The path of each configuration node is similar to that of ZooKeeper.</p>
<p>ShenYu gateway will monitor the configured node. At startup, if there is no configuration node in Nacos, it will write the synchronous full amount of data into Nacos. When the sequential data send changes, it will update the configuration node in Nacos in full amount. The local cache is updated.</p>
<p>If you want to learn more about the code implementation, please refer to the source code <code>NacosSyncDataService</code> and the official documentation for <a href="https://nacos.io/zh-cn/docs/sdk.html" target="_blank" rel="noopener noreferrer">Nacos</a> .</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="etcd-synchronization">Etcd Synchronization<a href="#etcd-synchronization" class="hash-link" aria-label="Direct link to Etcd Synchronization" title="Direct link to Etcd Synchronization">​</a></h3>
<p>Etcd data synchronization principle is similar to Zookeeper, mainly relying on Etcd&#x27;s watch mechanism, and each configuration node path is the same as that of Zookeeper.</p>
<p>The native API for Etcd is a bit more complicated to use, so it&#x27;s somewhat encapsulated.</p>
<p>ShenYu gateway will listen to the configured node. When startup, if there is no configuration node in Etcd, it will write the synchronous full amount of data into Etcd. When the sequential data send changes, it will update the configuration node in Etcd incrementally.</p>
<p>If you want to learn more about the code implementation, refer to the source <code>EtcdSyncDataService</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consul-synchronization">Consul Synchronization<a href="#consul-synchronization" class="hash-link" aria-label="Direct link to Consul Synchronization" title="Direct link to Consul Synchronization">​</a></h3>
<p>Consul data synchronization principle is that the gateway regularly polls Consul&#x27;s configuration center to get the configuration version number for local comparison.</p>
<p>ShenYu gateway will poll the configured nodes regularly, and the default interval is 1s. When startup, if there is no configuration node in Consul, write the synchronous full amount of data into Consul, then incrementally update the configuration node in Consul when the subsequent data is sent to change. At the same time, Apache ShenYu Gateway will regularly polls the node of configuration information and pull the configuration version number for comparison with the local one. The local cache is updated when the version number is changed.</p>
<p>If you want to learn more about the code implementation, refer to the source <code>ConsulsyncDataService</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/shenyu-website/edit/main/versioned_docs/version-2.6.0/design/data-sync.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2.6.0/design/database-design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Admin Database Design</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2.6.0/design/flow-control"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Flow Control Design</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preface" class="table-of-contents__link toc-highlight">Preface</a></li><li><a href="#principle-analysis" class="table-of-contents__link toc-highlight">Principle Analysis</a><ul><li><a href="#zookeeper-synchronization" class="table-of-contents__link toc-highlight">Zookeeper Synchronization</a></li><li><a href="#websocket-synchronization" class="table-of-contents__link toc-highlight">WebSocket Synchronization</a></li><li><a href="#http-long-polling" class="table-of-contents__link toc-highlight">Http Long Polling</a></li><li><a href="#nacos-synchronization" class="table-of-contents__link toc-highlight">Nacos Synchronization</a></li><li><a href="#etcd-synchronization" class="table-of-contents__link toc-highlight">Etcd Synchronization</a></li><li><a href="#consul-synchronization" class="table-of-contents__link toc-highlight">Consul Synchronization</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>