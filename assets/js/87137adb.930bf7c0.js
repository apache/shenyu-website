"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[11018],{23123:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/param-mapping-structure-1d2b4243e835eeff74fc6ea114dcbee7.png"},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>s});var a=t(96540);const r={},o=a.createContext(r);function i(e){const n=a.useContext(o);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(o.Provider,{value:n},e.children)}},58398:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/param-mapping-getFormData-04b664908cd5f52d149eb1098d5648c9.png"},75550:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var a=t(74848),r=t(28453);const o={title:"Code Analysis For Param-Mapping Plugin",author:"Kunshuai Zhu",author_title:"Apache ShenYu Contributor",author_url:"https://github.com/JooKS-me",author_image_url:"https://avatars1.githubusercontent.com/u/62384022?v=4",tags:["Param-Mapping","Apache ShenYu"]},i=void 0,s={permalink:"/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin",editUrl:"https://github.com/apache/shenyu-website/edit/main/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin.md",source:"@site/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin.md",title:"Code Analysis For Param-Mapping Plugin",description:"Before starting, you can refer to this article to start the gateway",date:"2025-12-08T10:21:50.000Z",formattedDate:"December 8, 2025",tags:[{label:"Param-Mapping",permalink:"/blog/tags/param-mapping"},{label:"Apache ShenYu",permalink:"/blog/tags/apache-shen-yu"}],readingTime:4.72,hasTruncateMarker:!1,authors:[{name:"Kunshuai Zhu",title:"Apache ShenYu Contributor",url:"https://github.com/JooKS-me",imageURL:"https://avatars1.githubusercontent.com/u/62384022?v=4"}],frontMatter:{title:"Code Analysis For Param-Mapping Plugin",author:"Kunshuai Zhu",author_title:"Apache ShenYu Contributor",author_url:"https://github.com/JooKS-me",author_image_url:"https://avatars1.githubusercontent.com/u/62384022?v=4",tags:["Param-Mapping","Apache ShenYu"]},unlisted:!1,prevItem:{title:"McpServer Plugin Source Code Analysis",permalink:"/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"},nextItem:{title:"Register Center Source Code Analysis of Http Register",permalink:"/blog/RegisterCenter-SourceCode-Analysis-Http-Register"}},l={authorsImageUrls:[void 0]},d=[{value:"Body",id:"body",level:3},{value:"1. DefaultOperator",id:"1-defaultoperator",level:4},{value:"2. FormDataOperator",id:"2-formdataoperator",level:4},{value:"\u4e09\u3001JsonOperator",id:"\u4e09jsonoperator",level:4},{value:"Conclusion",id:"conclusion",level:3}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["Before starting, you can refer to ",(0,a.jsx)(n.a,{href:"./Start-SourceCode-Analysis-Start-Demo",children:"this article"})," to start the gateway"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"body",children:"Body"}),"\n",(0,a.jsx)(n.p,{children:"Let's take a look at the structure of this plugin first, as shown in the figure below."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"param-mapping-structure",src:t(23123).A+"",width:"416",height:"282"})}),"\n",(0,a.jsxs)(n.p,{children:["Guess: handler is used for data synchronization; strategy may be adapted to various request bodies, which should be the focus of this plugin; ",(0,a.jsx)(n.code,{children:"ParamMappingPlugin"})," should be the implementation of ",(0,a.jsx)(n.code,{children:"ShenyuPlugin"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["First, take a look at the ",(0,a.jsx)(n.code,{children:"ParamMappingPlugin"}),", the focus is on the override of the ",(0,a.jsx)(n.code,{children:"doExecute"})," method."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public Mono<Void> doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {\n    ... // judge whether paramMappingHandle is null\n    // Determine the request body type according to the contentType in the header line\n    HttpHeaders headers = exchange.getRequest().getHeaders();\n    MediaType contentType = headers.getContentType();\n  \t// *\n    return match(contentType).apply(exchange, chain, paramMappingHandle);\n}\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["The match method returns the corresponding ",(0,a.jsx)(n.code,{children:"Operator"})," according to contentType"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"private Operator match(final MediaType mediaType) {\n    if (MediaType.APPLICATION_JSON.isCompatibleWith(mediaType)) {\n        return operatorMap.get(MediaType.APPLICATION_JSON.toString());\n    } else if (MediaType.APPLICATION_FORM_URLENCODED.isCompatibleWith(mediaType)) {\n        return operatorMap.get(MediaType.APPLICATION_FORM_URLENCODED.toString());\n    } else {\n        return operatorMap.get(Constants.DEFAULT);\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["As can be seen from the code of the match method, there are currently three types of ",(0,a.jsx)(n.code,{children:"DefaultOperator"}),", ",(0,a.jsx)(n.code,{children:"FormDataOperator"}),", and ",(0,a.jsx)(n.code,{children:"JsonOperator"}),", which support the request body in two formats: ",(0,a.jsx)(n.code,{children:"x-www-form-urlencoded"})," and ",(0,a.jsx)(n.code,{children:"json"}),"."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"So let's take a look at what the above three operators are like."}),"\n",(0,a.jsx)(n.h4,{id:"1-defaultoperator",children:"1. DefaultOperator"}),"\n",(0,a.jsxs)(n.p,{children:["Nothing happens, its apply method just continues to execute the plug-in chain, and has no real function. When the request body does not match the Operator, it will be skipped by ",(0,a.jsx)(n.code,{children:"DefaultOperator"}),"."]}),"\n",(0,a.jsx)(n.h4,{id:"2-formdataoperator",children:"2. FormDataOperator"}),"\n",(0,a.jsxs)(n.p,{children:["This class is used to process the request body in the format of ",(0,a.jsx)(n.code,{children:"x-www-form-urlencoded"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Mainly depends on the ",(0,a.jsx)(n.code,{children:"apply"})," method, but it looks a bit strange."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public Mono<Void> apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {\n    return exchange.getFormData()\n            .switchIfEmpty(Mono.defer(() -> Mono.just(new LinkedMultiValueMap<>())))\n            .flatMap(multiValueMap -> {\n                ...\n            });\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"The code in the ellipsis is the processing of the request body, as follows."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// judge whether it is empty\nif (Objects.isNull(multiValueMap) || multiValueMap.isEmpty()) {\n    return shenyuPluginChain.execute(exchange);\n}\n// convert form-data to json\nString original = GsonUtils.getInstance().toJson(multiValueMap);\nLOG.info("get from data success data:{}", original);\n// *modify request body*\nString modify = operation(original, paramMappingHandle);\nif (StringUtils.isEmpty(modify)) {\n    return shenyuPluginChain.execute(exchange);\n}\n...\n// Convert the modified json into LinkedMultiValueMap. Pay attention to this line, it will be mentioned later!\nLinkedMultiValueMap<String, String> modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);\n...\nfinal BodyInserter bodyInserter = BodyInserters.fromValue(modifyMap);\n...\n// modify the request body in the exchange, and then continue to execute the plugin chain\nreturn bodyInserter.insert(cachedBodyOutputMessage, new BodyInserterContext())\n        .then(Mono.defer(() -> shenyuPluginChain.execute(exchange.mutate()\n                .request(new ModifyServerHttpRequestDecorator(httpHeaders, exchange.getRequest(), cachedBodyOutputMessage))\n                .build())\n        )).onErrorResume((Function<Throwable, Mono<Void>>) throwable -> release(cachedBodyOutputMessage, throwable));\n'})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"PS: The omitted part is to set the request first and other operations."}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The more important thing above should be the modification request body of the star, that is, the call of the ",(0,a.jsx)(n.code,{children:"operation"})," method. Here, because of the parameter type, the default method of the ",(0,a.jsx)(n.code,{children:"Operator"})," interface will be called first (instead of being overridden by the ",(0,a.jsx)(n.code,{children:"FormDataOperator"}),")."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"default String operation(final String jsonValue, final ParamMappingHandle paramMappingHandle) {\n    DocumentContext context = JsonPath.parse(jsonValue);\n    // call the override operation method and add addParameterKey\n    operation(context, paramMappingHandle);\n    // replace the related replacedParameterKey\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getReplaceParameterKeys())) {\n        paramMappingHandle.getReplaceParameterKeys().forEach(info -> {\n            context.renameKey(info.getPath(), info.getKey(), info.getValue());\n        });\n    }\n    // Delete the related removeParameterKey\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getRemoveParameterKeys())) {\n        paramMappingHandle.getRemoveParameterKeys().forEach(info -> {\n            context.delete(info);\n        });\n    }\n    return context.jsonString();\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["After sorting it out, we can find that the json tool ",(0,a.jsx)(n.a,{href:"https://github.com/json-path/JsonPath",children:"JsonPath"})," imported here makes the processing of the request body much simpler and clearer."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsxs)(n.strong,{children:["In addition, we can notice that the ",(0,a.jsx)(n.code,{children:"FormDataOperator"})," overrides the ",(0,a.jsx)(n.code,{children:"operation(DocumentContext, ParamMappingHandle)"})," method."]})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Why override it?"})," There is a default method for handling addParameterKey in the interface."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// Default method in Operator interface\ndefault void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {\n        paramMappingHandle.getAddParameterKeys().forEach(info -> {\n            context.put(info.getPath(), info.getKey(), info.getValue()); //\u4e0d\u540c\u4e4b\u5904\n        });\n    }\n}\n\n// method overridden by FormDataOperator\n@Override\npublic void operation(final DocumentContext context, final ParamMappingHandle paramMappingHandle) {\n    if (!CollectionUtils.isEmpty(paramMappingHandle.getAddParameterKeys())) {\n        paramMappingHandle.getAddParameterKeys().forEach(info -> {\n            context.put(info.getPath(), info.getKey(), Arrays.asList(info.getValue()));\n        });\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In fact, there is such a line in ",(0,a.jsx)(n.code,{children:"FormDataOperator#apply"})," (mentioned earlier):\n",(0,a.jsx)(n.code,{children:"LinkedMultiValueMap<String, String> modifyMap = GsonUtils.getInstance().toLinkedMultiValueMap(modify);"})]}),"\n",(0,a.jsxs)(n.p,{children:["This line converts the modified json into ",(0,a.jsx)(n.code,{children:"LinkedMultiValueMap"}),", ",(0,a.jsx)(n.code,{children:"GsonUtils#toLinkedMultiValueMap"})," is as follows."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public LinkedMultiValueMap<String, String> toLinkedMultiValueMap(final String json) {\n    return GSON.fromJson(json, new TypeToken<LinkedMultiValueMap<String, String>>() {\n    }.getType());\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The attribute ",(0,a.jsx)(n.code,{children:"targetMap"})," in the ",(0,a.jsx)(n.code,{children:"LinkedMultiValueMap"})," class is defined as: ",(0,a.jsx)(n.code,{children:"private final Map<K, List<V>> targetMap"})]}),"\n",(0,a.jsxs)(n.p,{children:["Therefore, the value in the json string must be in the form of a list, otherwise Gson will throw a conversion error exception, which is why the ",(0,a.jsx)(n.code,{children:"FormDataOperator"})," must override the operator method."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsxs)(n.strong,{children:["But why use ",(0,a.jsx)(n.code,{children:"LinkedMultiValueMap"}),"?"]})}),"\n",(0,a.jsxs)(n.p,{children:["Go back to the first line ",(0,a.jsx)(n.code,{children:"exchange.getFormData"})," of the ",(0,a.jsx)(n.code,{children:"FormDataOperator#apply"})," method. In SpringMVC, the return value type of ",(0,a.jsx)(n.code,{children:"DefaultServerWebExchange#getFormData"})," is ",(0,a.jsx)(n.code,{children:"Mono<MultiValueMap<String, String>>"}),", and ",(0,a.jsx)(n.code,{children:"LinkedMultiValueMap"})," is a subclass of ",(0,a.jsx)(n.code,{children:"MultiValueMap"}),". And, the ",(0,a.jsx)(n.code,{children:"getFormData"})," method is for the request body in the format of ",(0,a.jsx)(n.code,{children:"x-www-form-urlencoded"}),"."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"param-mapping-getFormData",src:t(58398).A+"",width:"667",height:"134"})}),"\n",(0,a.jsx)(n.h4,{id:"\u4e09jsonoperator",children:"\u4e09\u3001JsonOperator"}),"\n",(0,a.jsx)(n.p,{children:"Obviously, this class is used to process the request body in Json format."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public Mono<Void> apply(final ServerWebExchange exchange, final ShenyuPluginChain shenyuPluginChain, final ParamMappingHandle paramMappingHandle) {\n    ServerRequest serverRequest = ServerRequest.create(exchange, MESSAGE_READERS);\n    Mono<String> mono = serverRequest.bodyToMono(String.class).switchIfEmpty(Mono.defer(() -> Mono.just(""))).flatMap(originalBody -> {\n        LOG.info("get body data success data:{}", originalBody);\n        // call the default operation method to modify the request body\n        String modify = operation(originalBody, paramMappingHandle);\n        return Mono.just(modify);\n    });\n    BodyInserter bodyInserter = BodyInserters.fromPublisher(mono, String.class);\n    ... //process the header line\n    CachedBodyOutputMessage outputMessage = new CachedBodyOutputMessage(exchange, headers);\n    // modify the request body in the exchange, and then continue to execute the plugin chain\n    return bodyInserter.insert(outputMessage, new BodyInserterContext())\n            .then(Mono.defer(() -> {\n                ServerHttpRequestDecorator decorator = new ModifyServerHttpRequestDecorator(headers, exchange.getRequest(), outputMessage);\n                return shenyuPluginChain.execute(exchange.mutate().request(decorator).build());\n            })).onErrorResume((Function<Throwable, Mono<Void>>) throwable -> release(outputMessage, throwable));\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The processing flow of ",(0,a.jsx)(n.code,{children:"JsonOperator"})," is roughly similar to that of ",(0,a.jsx)(n.code,{children:"FormDataOperator"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsx)(n.p,{children:"Finally, use a picture to briefly summarize."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"param-mapping-summary",src:t(83072).A+"",width:"930",height:"771"})})]})}function c(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},83072:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/param-mapping-summary-490cf9ee499bf9efc03d0c963b39118c.jpg"}}]);