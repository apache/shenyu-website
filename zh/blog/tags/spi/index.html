<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">One post tagged with &quot;spi&quot; | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;spi&quot; | Apache ShenYu"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/tags/spi"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/tags/spi"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/spi" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/tags/spi" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/spi" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.f861abb4.css">
<link rel="preload" href="/zh/assets/js/runtime~main.66a00d09.js" as="script">
<link rel="preload" href="/zh/assets/js/main.178cbf1d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/spi" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/tags/spi" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><header class="margin-bottom--xl"><h1>One post tagged with &quot;spi&quot;</h1><a href="/zh/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy--åŸºäºSPIçš„ä»£ç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-12-07T02:16:01.580Z">2022å¹´12æœˆ7æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p><code>Apache Shenyu</code> ç½‘å…³çš„å„ä¸ª<code>Plugin</code>ï¼ˆåŒ…æ‹¬<code>Dubbo</code>, <code>gRPC</code>,<code>Spring-cloud</code>ç­‰) ä¸­ï¼Œ<code>routing</code>å‚æ•°å‡è®¾è®¡ä¸ºå¯ä»¥æ¥å—å¤šä¸ªæ¡ä»¶çš„ç»„åˆã€‚ ä¸ºäº†å®ç°è¿™æ ·çš„ç›®çš„ï¼Œéµå¾ªå…¶<code>SPI</code>çš„æœºåˆ¶è¿›è¡Œå°†å‚æ•°åŠè¡Œä¸ºæŠ½è±¡ä¸ºå¦‚ä¸‹ä¸‰éƒ¨åˆ†ï¼Œè¿™äº›<code>SPI</code> åœ¨<strong><em>shenyu-plugin-base</em></strong>æ¨¡ç»„ä¸­å®ç°</p><ul><li><code>ParameterData</code>-å‚æ•°èµ„æ–™</li><li><code>PredictJudge</code>-æ–­è¨€</li><li><code>MatchStrategy</code>-åŒ¹é…ç­–ç•¥</li></ul><p>ç›¸å¯¹è€Œè¨€ï¼ŒåŒ¹é…ç­–ç•¥æ˜¯éœ€è¦æ‰©å±•ç‚¹æœ€å°‘çš„éƒ¨åˆ†ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¯¹å¤šä¸ªæ¡ä»¶çš„ç»„åˆåˆ¤æ–­ï¼Œæœ€å¸¸è§çš„å‡ ç§è§„åˆ™æ˜¯ï¼šå…¨éƒ¨éƒ½æ»¡è¶³ã€è‡³å°‘æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ã€è‡³å°‘æ»¡è¶³ç¬¬ä¸€ä¸ªï¼Œæˆ–è€…å¤§éƒ¨åˆ†æ»¡è¶³ç­‰ç­‰ã€‚ å¹¶ä¸”è¦åšåˆ°å¯¹å„ç§<code>plugin</code>çš„ä¸åŒç±»å‹çš„å‚æ•°ï¼Œå¦‚<code>IP</code>, <code>header</code>, <code>uri</code>ç­‰ã€‚é’ˆå¯¹è¿™äº›éœ€æ±‚ï¼Œå¦‚ä½•å°†<code>MatchStrategy</code>è®¾è®¡å¾—ç®€å•æ˜“ç”¨ä¸”å®¹æ˜“æ‰©å±•ï¼Ÿ</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy"></a>MatchStrategy<a class="hash-link" href="#matchstrategy" title="Direct link to heading">#</a></h2><p><code>MatchStrategy</code>çš„å®ç°ä»£ç åœ¨<strong><em>shenyu-plugin-base</em></strong>æ¨¡ç»„ä¸­ï¼ŒåŸºäº<code>Apache Shenyu</code>çš„<code>SPI</code>åˆ›å»ºæœºåˆ¶ï¼Œ è®¾è®¡ä¸Šç»“åˆäº†å·¥å‚æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼ï¼Œæ•´ä½“<code>MatchStrategy</code>çš„è®¾è®¡ç±»å›¾å¦‚ä¸‹ä¸‹ï¼š</p><p><img alt="MatchStrategy-class-diagram" src="/zh/assets/images/MatchStrategy-class-diagram-ac006eef5089ce92a972e039b431100b.PNG"></p><p>ä»¥æ¥å£<code>MatchStrategy</code>ä¸ºåŸºç¡€ï¼Œè®¾è®¡å®ç°ç±»ï¼Œå¹¶ç”±æŠ½è±¡ç±»<code>AbstractMatchStrategy</code>å®ç°å…¬å…±æ–¹æ³•ï¼Œç”±å·¥å‚ç±»<code>MatchStrategyFactory</code>æä¾›åˆ›å»ºå’Œå¤–éƒ¨è°ƒç”¨åŠŸèƒ½ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy-interface"></a>MatchStrategy Interface<a class="hash-link" href="#matchstrategy-interface" title="Direct link to heading">#</a></h2><p>é¦–å…ˆæ¥çœ‹<code>MatchStrategy</code> <code>SPI</code>æ¥å£çš„å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean match(List&lt;ConditionData&gt; conditionDataList, ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>@<code>SPI</code> <code>annotation</code>ä»£è¡¨è¿™æ˜¯ä¸€ä¸ª<code>SPI</code>æ¥å£ã€‚<code>ServerWebExchange</code> æ˜¯ <code>org.springframework.web.server.ServerWebExchange</code> ,ä»£è¡¨<code>HTTP</code>çš„ <code>request-response</code>  çš„äº¤äº’å†…å®¹ã€‚<code>ConditionData</code>çš„ä»£ç å¦‚ä¸‹ï¼Œæ›´å¤šè¯´æ˜å¯ä»¥å‚è€ƒ<code>PredicateJudge</code><a href="http://shenyu.apache.org/blog/PredicateJudge-SPI" target="_blank" rel="noopener noreferrer">ä»£ç åˆ†æ</a>ä¸­çš„è¯´æ˜ï¼Œ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionData {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String operator;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramValue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractmatchstrategy"></a>AbstractMatchStrategy<a class="hash-link" href="#abstractmatchstrategy" title="Direct link to heading">#</a></h2><p>åœ¨æŠ½è±¡ç±»<code>AbstractMatchStrategy</code>ä¸­ï¼Œå®šä¹‰<code>MatchStrategy</code>çš„å…¬å…±æ–¹æ³•ï¼Œ ç”¨<code>buildRealData</code>æ–¹æ³•ä¸­ï¼Œç”¨<code>ParameterData</code>å·¥å‚ç±»<code>ParameterDataFactory</code>ï¼Œå°†å¤šç§å‚æ•°å¦‚  <code>Ip</code>, <code>Cookie</code>, <code>Header</code>,<code>uri</code>ç­‰èµ„æ–™éƒ½ä»¥ç»Ÿä¸€çš„æ¥å£æ–¹æ³•æ¥å‘ˆç°ã€‚è¿™äº›å‚æ•°æ ¼å¼åŠè§„åˆ™çš„ä¿®æ”¹ï¼Œä¸ä¼šå½±å“åˆ°å¯¹å‚æ•°è§„åˆ™åŒ¹é…<code>MatchStrategy</code>çš„è°ƒç”¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractMatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String buildRealData(final ConditionData condition, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ParameterDataFactory.builderData(condition.getParamType(), condition.getParamName(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å®ç°ç±»åŠprofile"></a>å®ç°ç±»åŠProfile<a class="hash-link" href="#å®ç°ç±»åŠprofile" title="Direct link to heading">#</a></h2><p>åŸºäºä¸Šè¿°æ¥å£å®šä¹‰, <strong><em>shenyu-plugin-base</em></strong> æ¨¡ç»„æä¾›äº†ä¸¤ä¸ª<code>MatchStrategy</code>å®ç°ç±»</p><ul><li><p><code>AndMatchStrategy</code>-å¤šä¸ªæ¡ä»¶ AND</p></li><li><p><code>OrMatchStrategy</code>- å¤šä¸ªæ¡ä»¶ OR</p><p>å¹¶åœ¨<code>SHENYU_DIRECTORY</code>ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®ä½œç±»åšäº†é…ç½®ã€‚åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šç”±é¡¶å±‚<code>SPI</code>ä»¥<code>key-value</code>å½¢å¼åŠ è½½å¹¶<code>cache</code>èµ·æ¥ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">and=org.apache.shenyu.plugin.base.condition.strategy.AndMatchStrategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">or=org.apache.shenyu.plugin.base.condition.strategy.OrMatchStrategy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p> ä¸¤ä¸ªå®ç°ç±»<code>AndMatchStrategy</code> ç»§æ‰¿<code>AbstractMatchStrategy</code> å¹¶å®åšäº†<code>MatchStrategy</code>ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="andmatchstrategy---ä¸çš„å…³ç³»"></a>AndMatchStrategy-  â€œä¸â€çš„å…³ç³»<a class="hash-link" href="#andmatchstrategy---ä¸çš„å…³ç³»" title="Direct link to heading">#</a></h3><p>  ç”±äº<code>PredicateJudge</code>å°è£…äº†æ¡ä»¶åˆ¤æ–­çš„å¤šæ ·æ€§ï¼Œ<code>ConditionData</code>å’Œ<code>ParameData</code>å°è£…äº†å¤šç§å‚æ•°ã€‚é‚£ä¹ˆå¯¹äºå¤šä¸ªæ¡ä»¶çš„åŒ¹é…æ¥è¯´ï¼Œé‡‡ç”¨<code>Stream</code>æµå¤„ç†åŠ<code>lamda</code>è¡¨è¾¾å¼ï¼Œéå¸¸ç®€æ´é«˜æ•ˆè¾¾æˆäº†ï¼šå…¨éƒ¨æ¡ä»¶éƒ½æ»¡è¶³ï¼Œå³&quot;AND&quot;çš„é€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AndMatchStrategy extends AbstractMatchStrategy implements MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean match(final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return conditionDataList</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .allMatch(condition -&gt; PredicateJudgeFactory.judge(condition, buildRealData(condition, exchange)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>OrMatchStrategy</code>æ˜¯åŒæ ·çš„å®ç°æ–¹å¼ï¼Œå®ç°: è‡³å°‘æ»¡è¶³ä¸€ä¸ªæ¡ä»¶&quot;OR&quot;çš„è§„åˆ™ï¼Œåœ¨æ­¤ä¸åšèµ˜è¿°ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategyfactory"></a>MatchStrategyFactory<a class="hash-link" href="#matchstrategyfactory" title="Direct link to heading">#</a></h2><p>è¿™æ˜¯<code>MatchStrategy</code>çš„å·¥å‚ç±»ï¼Œå®ç°äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯<code>newInstance()</code>æ–¹æ³•æ ¹æ®ç­–ç•¥ä»£ç å’Œåç§°ï¼Œè¿”å›ç”±<code>SPI</code> <code>ExtensionLoader</code>æŒ‰keyæ¥åŠ è½½å¯¹åº”çš„<code>MatchStrategy</code>å®ç°ç±»ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static MatchStrategy newInstance(final Integer strategy) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String matchMode = MatchModeEnum.getMatchModeByCode(strategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(MatchStrategy.class).getJoin(matchMode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>MatchModeEnum</code> ä¸­å®šä¹‰äº†matchç­–ç•¥çš„codeå’Œnameã€‚ è°ƒç”¨æ—¶ç”±ç­–ç•¥åç§°ï¼Œå¦‚&quot;and&quot;,&quot;or&quot;ï¼Œæ ¹æ®å¯åŠ¨æ—¶SPIåŠ è½½çš„key-valueèµ„æ–™ï¼Œæ‰¾åˆ°å¯¹åº”çš„å®ç°ç±»ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">AND(0, &quot;and&quot;),  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">OR(1, &quot;or&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦ä¸€ä¸ªæ˜¯<code>match()</code>æ–¹æ³•ï¼Œè°ƒç”¨å®ä½œç±»çš„<code>match</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean match(final Integer strategy, final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(strategy).match(conditionDataList, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è°ƒç”¨æ–¹å¼"></a>è°ƒç”¨æ–¹å¼<a class="hash-link" href="#è°ƒç”¨æ–¹å¼" title="Direct link to heading">#</a></h2><p>åœ¨<code>shenyu-plugin</code>æ¨¡ç»„çš„å„ä¸ª<code>plugin</code>çš„åŸºç±»<code>AbstractShenyuPlugin</code> ä¸­ï¼Œå®šä¹‰äº†ä¸¤ä¸ªé€‰æ‹©çš„æ–¹æ³•ï¼š<code>filterSelector</code> å’Œ<code>filterRule</code> å®ƒä»¬éƒ½è°ƒç”¨äº†<code>MatchStrategyFactory</code> æ–¹æ³•ï¼Œä¸‹é¢æ˜¯<code>AbstractShenyuPlugin</code>ä¸­<code>filterSelector</code>æ–¹æ³•çš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterSelector(final SelectorData selector, final ServerWebExchange exchange) {        if (selector.getType() == SelectorTypeEnum.CUSTOM_FLOW.getCode()) {            if (CollectionUtils.isEmpty(selector.getConditionList())) {                return false;            }            return MatchStrategyFactory.match(selector.getMatchMode(), selector.getConditionList(), exchange);        }        return true;    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™æ®µä»£ç ä¸­ï¼Œå…ˆæ£€æµ‹å‚æ•°åŒ¹é…æ¡ä»¶<code>SelectorData</code>æ˜¯å¦ä¸ºç©ºï¼Œä¹‹åè°ƒç”¨<code>MatchStrategyFactory</code>çš„<code>match</code>æ–¹æ³•ï¼Œå·¥å‚æ–¹æ³•å°†è°ƒç”¨å¯¹åº”çš„å®ä½œç±»çš„<code>match</code>æ–¹æ³•ã€‚åŒç†ï¼Œå¦‚ä¸‹æ˜¯<code>AbstractShenyuPlugin</code>ä¸­ <code>filterRule</code> æ–¹æ³•</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterRule(final RuleData ruleData, final ServerWebExchange exchange) {        return ruleData.getEnabled() &amp;&amp; MatchStrategyFactory.match(ruleData.getMatchMode(), ruleData.getConditionDataList(), exchange);    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¹ŸåŒæ ·æ˜¯è°ƒç”¨<code>MatchStrategyFactory</code>çš„<code>match</code>æ–¹æ³•ï¼Œçœ‹ä¸Šå»æ˜¯ä¸æ˜¯ç‰¹åˆ«çš„ç®€æ´ç”šè‡³æ˜¯ç®€å•ï¼Ÿ åœ¨<code>PredicteJudge</code>çš„<a href="http://shenyu.apache.org/blog/PredicateJudge-SPI" target="_blank" rel="noopener noreferrer">ä»£ç åˆ†æ</a>æ–‡ä¸­ï¼Œå¯¹<code>shenyu-plugin</code>å¦‚ä½•åšå‚æ•°è°ƒç”¨æ–¹é¢åšäº†æ›´è¿›ä¸€æ­¥çš„æè¿°ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>ç”±äºåº”ç”¨äº†<code>Apache shenyu</code>çš„<code>SPI</code>æ¡†æ¶ï¼Œä½¿å¾—æ•´ä½“ä¸Šå…·æœ‰æ¾è€¦åˆã€æ˜“äºæ‰©å±•çš„ç‰¹ç‚¹ã€‚åœ¨å¤šä¸ªå‚æ•°è§„åˆ™ç­–ç•¥æ–¹é¢ï¼Œ<code>MatchStrategy</code>æä¾›äº†è‰¯å¥½çš„è®¾è®¡ï¼Œè™½ç„¶ç›®å‰åªæä¾›äº†ä¸¤ä¸ªAND å’ŒORçš„å®ç°ç±»ï¼Œä½†æœªæ¥å¯ä»¥å¾ˆè½»æ¾åœ°æ‰©å±•ä¸ºæ›´å¤š<code>MatchStrategy</code>è§„åˆ™ï¼Œä¾‹å¦‚ <code>firstOf</code>ï¼šå³å¿…é¡»æ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œæˆ–<code>mostOf</code>-æ»¡è¶³å¤§éƒ¨åˆ†æ¡ä»¶ç­‰æ›´å¤šå¤æ‚ç­–ç•¥ï¼Œè€Œå…¶ä»–è°ƒç”¨éƒ¨åˆ†çš„ä»£ç å®Œå…¨ä¸å—å½±å“ã€‚ </p><p>æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»é˜…è¯»<code>Shenyu plugin</code>çš„æºç äº†è§£æ›´å¤šå†…å®¹ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about MatchStrategy--åŸºäºSPIçš„ä»£ç åˆ†æ" href="/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge-- åŸºäºSPIçš„è®¾è®¡å®ç°åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-12-07T02:16:01.580Z">2022å¹´12æœˆ7æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>çµæ´»çš„æ’ä»¶å’Œè§„åˆ™å®šä¹‰ï¼Œæ˜¯<a href="http://shenyu.apache.org/" target="_blank" rel="noopener noreferrer">Shenyuç½‘å…³</a>çš„ä¸€å¤§ç‰¹è‰²ã€‚å®ƒä»¥æ’ä»¶å½¢å¼æ”¯æŒå¤šç§ç½‘ç»œåè®®å’Œå¤šç§æµè¡Œçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå¦‚Dubbo, gRPCå’Œ Spring-Cloud ç­‰ã€‚ ä¸ºäº†å®ç°å¯¹å„ç§åè®®åŠæ’ä»¶çš„é…ç½®è§„åˆ™çš„è§£æï¼Œç½‘å…³åœ¨è§„åˆ™ç­–ç•¥è§£ææ–¹é¢ï¼Œé‡‡ç”¨äº†ä¼˜é›…çš„<code>SPI</code>(Service Provider Interface)å®ç°ï¼Œå½“æ·»åŠ æ–°çš„æ’ä»¶æ—¶ï¼Œè§„åˆ™è§£æéƒ¨åˆ†å¯ä»¥æ²¿ç”¨ç°æœ‰å®ç°æˆ–é‡‡ç”¨<code>SPI</code>æœºåˆ¶å¿«é€Ÿå®ç°ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi-çš„é¡¶å±‚è®¾è®¡"></a><code>SPI</code> çš„é¡¶å±‚è®¾è®¡<a class="hash-link" href="#spi-çš„é¡¶å±‚è®¾è®¡" title="Direct link to heading">#</a></h2><p>Shenyuçš„<code>SPI</code>é‡‡ç”¨æ¥å£+ å·¥å‚æ¨¡å¼+é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œæ¥å®ç°æ¨¡ç»„çš„åŠ¨æ€åŠ è½½ã€‚åœ¨å…¶<strong><em>shen-<code>SPI</code></em></strong>-æ¨¡ç»„ï¼Œåšäº†<code>SPI</code>çš„é¡¶å±‚è®¾è®¡ã€‚å®šä¹‰äº†@ Join ï¼Œ@<code>SPI</code> ä¸¤ä¸ªannotationã€‚ å…¶ä¸­@Join  ä»£è¡¨æ­¤ç±»ä¼šåŠ å…¥æ‰©å±•æœºåˆ¶ï¼Œç›¸å½“äºæ˜¯åšç”³è¯·æ³¨å†Œã€‚ @<code>SPI</code> æ ‡æ˜å½“å‰ç±»ä¸º<code>SPI</code>åŠŸèƒ½æ‰©å±•ç±»ã€‚</p><p>Fig 1 classes in the <strong><em>shenyu-spi</em></strong></p><p><img alt="toplevel-SPI" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASkAAACeCAYAAABuIfz7AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAABX0SURBVHhe7Z39kxXVmcf5l1L70/y2STbRaLTKJEQoeTFBBtYkG8iS2ggoiChCcBCFlEQriElF0RWoiplaYGCDMRiRXQEtglNmABdKN1izI+iaicBJP6fP6T4vz+nue29f7pnu78c65b3d5637nudzTx/udM8SAAAQMZAUACBqICkAQNRAUgCAqBmYpM5f/FCcfu+slcbPvi8uf/KpygEAAAOU1KvHTog9+3/npX0HjkhZge4ZHZ4lZg2Pqnc3hkG0GRvyHAyNiHH1HtQDK6kXXnhB7N69W0xMTKgtNpOTk2LPnj0yH6VuCElKpzN/Pqdygk6BpAbBuBgZgqT6ASspElRIVK6g+iWpKonqAD6QFGgSrKRITJyoXEG98cYbMnUDJNU/ICnQJIJrUq6oTp065Qnq+vXrMnVD3yU1PiKGZiWBYyQ3hmRgJdPz0ZGhNI85VR8dtsoOjYym0/nCQFRT/qzcsDBz6/bG3b55dRbXkzIqhs06jL5rYYzr4wrV4faj9FLFbtPsdj1tquMuqCc7h+q9Rm9/V/VxaMTOESqXU3JsVLbkcytvA3RD4cK5KSozaUH1giup3xx+TZy78IH4+Mon8v+vHP6DtZ9LQUkpwVhjSA0wc/DKQcUMNh0g3kBl8pqMjwyLvHp/jSKrwxzIeuAb9ZbVo4/PCsSknsSjEt1Ovl8FoFfHUHE7Fn7wj474x9Zbm+o9V48+P14dRJonzeL3k5D96/HYrPLM51bcBuiWQkkRrqjqEBThSuri/15Se1IufvgXaz+XeEnxg5RI5eN8K3vf9qHyKoAKJOUhA6qsPb9fHlY95f3ggsVuI63Dq0IGnisAhQrKULP1tKmOrUI91udjnZ8uJFXl2LL6c9jxBEnVTqmkCC2qugRFuJL6/OpVtSfl88+vWvu5xEqqaMA538LsoAqWL5cDkQ5oM1UYxMzsIFhPSUARsqyTwQooVYddf574utXxUx7mGOppkz/Hrgzk+6wPrrS6mUlVOLYKn1txG6BbKkmqH7iSmpz6WO1Joffmfi7FJak0OMxgStvL31cb7CX11CipojqCmLIxjqWeNqtJKq1LnS/ztaQbSSmKjq30c6vYBuiYaCQ19oc3xZVP/1/uo//Te3M/l1hJBQYp4Q52flCFyit5hKLMGbAE254ZbAqrH6X1hI9PI+srDPTyOkqR/cylU0+bFSWl8lFdcp/1GfJ18J91AO7Yyj435j2oh2gkpRMtoHPbucRLSg9q51vbGXhEaFClg9IWRbotSVkFjrTc+rNv5Xxw+3UkuOUq1BM6Pv1etmPt1GVK6qC2sg3O8SX7hu0TkpR3ZhE9t1lVUgnU/lByzEl+J3vaFzO/Oqf5Z93FsZn5CVWnvclsA9RFdJLqJIUkJdEDM0u2dIiiQZUNTJWGR90A8gNKB6FMVK/sQx4sur3sJw9Z3SqDoqweiXt8RiWyHadSLtCtdihZ58I/PvucMBLvQ5sEV0/SYioabzuh6tFtJPXpc5+21cWxVfjc7DZAXTRXUrXDB1AnYBDXSe+fR1XwuQ2WgUlq6vIn4tLk//WUqI4bhrrs6iUmMNhrRH4e/uy4H+BzGywDk1TM0OWFvcCrLi16HKgY7PUhz+UNmEUR+NwGCyQVQA5MY/2hjoDAYO+dbE3rBp5HfG6DBZICAEQNJAUAiBpICgAQNZAUACBqICkAQNRAUgCAqIGkAABRA0kBAKKmdZL627VpcXbqjDh64aA4dH6fTPSattE+AEBctEZS15P/3rn0pnj+9Hax6+0RNtE+ykN5AQBx0ApJTV/9q9g/8RIrJi5RXirTVCbunyWemjsiJtV7AGKm8ZKiWVEngtKJyhTNqCZ3Dokd/zDLS2NHVIZoGRfH5/ZPUjP3vIBYabyk6PKNk1CVRGVDUDD2FuijYuwLzQteeV6+MCz4B/TXQTPPGwjTaEnRQnhoDWrJ2rvEwhXflIlec3mobGgxHZLigaRA3TRaUmen3mXlQ2nL/gfEvGV3yESvuTyUqA6OIknRPv8SJw2up+4fzfab6aWdxo1Azo6Il5K8ep/djrpcc+rxxZC2p/ebfWHXpJw23TJV25XnpVBSaT2h8il233VfOz1vlFyZ6WOfUHXR65OBNTqs3cVBoyX1+sUxVjw63bt+gUzcPp2oDg4ZjAUD2B7geYDnBGYER4aTwB0Sx8+q994aUh7keYDmAjTfmwE8sTPvqxd8SZteQKuAz+uo0m65pCZ3DhccW4Lqiyuf41nfwuet/BjSY6d81mfhnXMi0A644TRaUofO7WPFo1MVSVEdHNy3uh2cuSj4wOWCIA1aLzBksOkgYgI7wWpDBWcowGxJ5f10sftdoV31vvi8OEhBOG1YMnfhzlvVY1DH7vUnbdcqb/ULDBJIqgdJuQHroWThf0sTTLCp/G6Q65Tm5QOZEwqV4fpoSapIaNYMo0q7/nsOPZvRKctfIteU8HkrPwZX0Dn258lICwwMXO6VSKrbyz1Jl5IqDtJqspCo+lxZDU5S6TFb+80ZS6Xj74+k0jpUPvM1GDitXTh//MCabOGcXnN5KHWzcJ6SfxvzeZlgU9uKv8E7kJQmCVQSlW7LDtRwm3adNUjKEQZh569y/J2dN7c/QUmVfl5gUDRaUoP8CYIdDFyA84FF9ZpCkdA3e1a2giyS/GNmvSWzCbZNR2x1ScqqU82A3PJcX/L3HZw37xiKJJVA52lu0lZynFY9YKA0WlJEP3/MSQHgJgpiGQju5YIOSDPIVRBRMoPOrdsOqmqyoD5k5Z2+sIFq9IUrU4ukEsxjk30gMbj53b44bYbOW/kxlEhKCbCo/+DG03hJ9evPYkAT4UUMBkvjJUXgD4xBJbBgHiWtkBRBsyK6fAutUVGifZQHM6h2Ii8FMYuKjtZISkML4bjpHTDR62ThtSowSFonKQDAzAKSAgBEDSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKhpvKQuf/KpOHz0uNj18m/Fq8feUlsBADOFRkvqg798JJ7bMyp+/vw+mXa/clBMX7su/jQ1LQ5cuCL2nr8sE72mbbQPABAXjZUUzaBMQVHad/SE2HZ6Umx++yM20b5jlz7DH8UAEBGNlRRd4pmCembvfvHYiQ9ZObnpxYmPxWdXr6mamkfx7UpmMriLQRNprKR2vZzPop7Zs19s+a//EVv++OeORFU0ozLvi2Sm+G+WpgK5T5Iqu59Uf4GkmkhjJfXqsRNi9ytj8hKPxESC+vmLvxFPHvpvVkpcoku/EDIYewp07ja4Mx9ICtRNoxfOaSFcr0GRqEhQO/79P+Tr5b/eLxasf0LMXrFWfGfTDrHm8DuepKhsaDEdkuKBpEDdNFpSZ6amPfE89tYHYtFDj4ub5i8Wdz/6M7HkyV+KOSsfEbct/ZHYyFwKUh0cRZKiff6ln7o1bRJAer+ZrNvgqlsN6312O3kgmvX4Ykjb0/vNvrBrUk6bbpmq7crzUiap0raItL1QOxLvNsMjvKQKz2d+PsynGnf/5QPqptGSOnjxiiedZb8aFTcvXCLWH33P2r4pkZf5Xieqg0MGY8FgtkXAfcMHZlLynt/m3SFVWacuCqZcbLkAzfem+GJ5gnG1tqieak86Nuuh46Jt1nkuPZ+BciAaGi2pvecue9KZ/+AWOYNyt4cS1cFhziZ0soMzFwUfuJyk0gDyxCWDWAcaE7AJVhsq6L16FLakfKFp7H5XaJd5b1O1LQYpG70/VI/qYyabKudTnY+itsFAaaekNmz3todSkaTcgPVQsuCeWsJKSuV35adTmtcNxBROKFSG66MlqSKhWbOQKu2WyKZyWyl6hqNTVm+wHqePlc6nK20QG+283FswLNb9ftzavmbspPVep24v9yQqSDqVFBvEGdVkITGC1Oxr/JJKz41VjzmTCtbDS6r4fEJSsdO6hfPNpy6JOas2iJvm3SNoRjW8dZf4xvLV4ub5i8WGY+97+btZOE9JAya73PPyMpIKXsaYdCApTRLg4ZlDuE27zhokVbUtZlZl1xuqJ92e97HK+YSkYqfRkjJ/gmClRFQ0o5q3dkTMue9hsXjrs+Kh1+yZFaVefoJgD3wuwPkAonpNoUhoRpCVrSCLJH+UTzBOqNSW+17NiMx65TE4IqNtVM7sI9uedT4hqdhptKQI+kGmK5+qqezHnDT43UQBwgVQFmhmkKtgpGTKyq3bDqBqstABK8szwewFpdEXrkwnkjLryeoLHLfc57Vl1yP7mpRx5WceI6WxI+E+mvncY4ek4qbxkqJ5EP2JCyeholT2ZzEAgBtD4yVF0B8LdyKqpv+BMQAziVZIiqBZEV2+sWtUKtE+3KoFgLhojaQ0tBCOm94BMHNonaQAADMLSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCiBpICAERN6yT1t2vT4uzUGXH0wkFx6Pw+meg1baN9AIC4aI2krif/vXPpTfH86e1i19sjbKJ9lIfyAgDioBWSmr76V7F/4iVWTFyivFSmn+D2IABUo/GSollRJ4LSicqUz6j4+xeVo8pBUgCU0nhJ0eWbKZ9nT42INc8tEwtWfEvcftc/iVvnfEl8e+nXxfKRe8TTxx618lLZYrqVFACgKo2WFC2Em2tQO08+JhatvFPMufc28dDuFeIXb22W27f9bp249+GFYvbiW8VTr2/I8lPZ4sV0SAqAftNoSZ2dejcTDqVVz3xfzF5yq3jmzY3JrGmjWL3zX8SKbUvEfTvuFTuOPiLuWT1X/GDj3VYZqiNMQFLqVsHmLWute2wn2GtSeT3WbXML7hUOQFtotKRevzhmCeeuZXdIUe1441HxzUVfE8s2f1ds2PMTccudXxI/fWWlfE3bzTJURxhGUu5DBAglLfM+5pykqFyex33yCQDtpNGSOnRunyWc2+d/VWz+7Sqx5rkfijv/+Ta5jS4Bb/n2F8XI/gfE4wfWSGGZZaiOMK6kwo9Qch9YwM6knIV0twwAbaRdkpr3FSmjnySXdwtXfEtu2/bqevG12f8onvjPdWLd8//qzaQ6kpSaMbmXdhL5tJP8qSihyz0TSAqAll3uzf3e7eL+XT+UM6avz/2yvPRbtGqOuH3BV8XSdfPE7OFbxY+fXGKVqXK5l82cICkAaqdVC+ckoHnL75A/Q6AZ1Y+3LxWPvPxvciF9ZSIs+hc/2meWKV44Ty/vcin1eLkHSQHg0WhJuT9BePr4JrkWtfj+uWLr4QflNlqTeiJ5TQvnOp9OZT9B4CRC27yFc2YxHZICoBqNlhTh/pjz6WTWtOyxRfIHnLQWdcudX5SXgat/8QMrHyX+x5ypUNKfCPhP3pUoKenE5YOkAKhG4yXV3z+LAQD0m8ZLiojxD4wBANVohaQImhXR5Zu5RuUm2kd5MIMCIB5aIykNLYTjpncAzBxaJykAwMwCkgIARA0kBQCIGkgKABA1kBQAIGogKQBA1EBSAICogaQAAFEDSQEAoqZ1ksIvzgGYWbRGUvjbPQBmJq2QFO6CAMDMpfGSollRJ4LSicqUzqjcm9tlN7FL0XfpLMpj3/wOAODSeEnR5Zspn7oes87eNTORlnl/c5nHEpC6A6exDZICoJhGS4oWws01qPoesx5+4IKJL6kE54kykBQAxTRaUv17zHq1pwuzknKeMANJAVBMoyXVz8esk1zkGlOBqMIzqdDz9wAALo2WVL8fs04SyhbEGVn5kvJnYJAUAMW0S1K1P2Y9JZtVOY+uMiWmk7uOBUkBUEyrLvfqf8y6ifqXO+Nf/Pg1KRtICoBiWrVwXv9j1h2ODENSANRMoyXl/gShvses09qS+1Ri/ynEkBQAvdNoSRHujzl7f8y6Jl0EL1pvgqQA6J3GS6qvfxYDAOg7jZcUgT8wBmDm0gpJETQross3c43KTbSP8mAGBUA8tEZSGloIx03vAJg5tE5SAICZBSQFAIgaSAoAEDWQFAAgaiApAEDUQFIAgKiBpAAAUQNJAQCipnWSmr52XfxpalocuHBF7D1/WSZ6TdtoHwAgLlojKdLPsUufiW2nJ8Xmtz9iE+2jPFAVAPHQCkl9dvWaeHHiY1ZMXKK8VOZG0aTbteDWM6BuGi8pmhV1IiidqEzpjKrkCcbV8B8Yyt0bnZJ+DFa8+MdSJzP3vIBeaLyk6PKNk1CVRGVDyBvalTzBuFuq3CyvGPvZfk2BPee10szzNtNptKRoITy0BrX81/vFgvVPiNkr1orvbNoh1hx+x8tDZakOn3Qw1yEkDkiKB5JqJ42W1JmpaU88m09dEnc98FNx0/zF4u5HfyaWPPlLMWflI+K2pT8SG0986OWnOnzSwVz2BONsfUY9Wl1fnrjl3HWcIknRPv8SJ++P3m8mS6ZuX6x28vu0m/X4Ykjb0/vNvrBrUk6bbpmq7crzUiiptJ5Q+RS777qvnZ43Sq7M9LFPqLro9cnAGh3W7qrTaEkdvHjFk86yX42KmxcuEeuPvmdt3/TWB9Z7nagODhpkciAWiCrLYw5GNdjNcu6AlcFYMIDt/HmA5wRmBPJpNuYDJNw1pDzI8wB1hZy+NwN4YmfeVy/41Lqd1Rd1DvI6qrRbLqnJncMFx5ag+uLK53jWt/B5Kz8G4/M2PwvvnBOBdgBLoyW199xlTzrzH9wiZ1Du9lCiOkJY3/qWJFJkwDJB5QYbJyldb1a/VU8uCj5wuSBIg9YLDBlsOoiYwE6w2lDBGQow+1jyfrrY/a7QrnpffF4cpCCcNpjPKYc7b1WPIfR5p+1a5a1+gTLaKakN273toVQkKU32Dep8Y7ryyXC+XTlJseVMlCz8b2mCCTaV3w1yndK8fCBzQqEyXB+tYykSmnUOqrTrv+fQn4VOWf4SuaaEz1v5MYQ/b/vzZKQFCmnn5d6CYbHu9+PW9jVjJ633OoUu93xUoBlBFKOkioO0miwkqj5XVoOTVHrM1n7Zhnpf6fj7I6m0DpXPfA0q0cqF8zmrNoib5t0jaEY1vHWX+Mby1eLm+YvFhmPve/n5hfMAZlAkyEHLBJU7mDuXVP5tzOdlgk1tK/4G70BSmuSYSVS6LftYwm3addYgKUcYhJ2/yvF3dt7c/gQlVfp5gSIaLangTxASUdGMat7aETHnvofF4q3Piodes2dWlIp/guB+G/qBRoNWzjTM4HOCmuhUUnZ+LsD5wKJ63bblN3tWtoIskvxjZr0lswm2Te8c1CMpq041A3LLc33J33dw3ip8jhZ0nuYmbSXHadUDSmm0pIh+/ZhTD2gaqDq5g1sPWv1P0jq5gzQU2G6iIJZ5XUHqgDSDXAURJbNfbt12UFWTBfUhK+/0hQ1Uoy9cmVoklWAem+wDicHN7/bFaTN03sqPoURSarwU9R/wNF5Sff2zmBKKBy1oF7yIQTmNlxQxqD8whqRABhbMu6YVkiJoVkSXb6E/k6FE+yhPrzMoDSQFNHIsYBbVFa2RlIYWwm/UTe8gKaDXyTAOuqd1kgIAzCwgKQBA1EBSAICogaQAAFEDSQEAogaSAgBEjBB/B3o1C04w+m2JAAAAAElFTkSuQmCC"></p><p>é…ç½®æ–‡ä»¶æ–¹é¢ï¼Œå®šä¹‰<code>SPI</code>åŠ è½½çš„ç›®å½•ä¸º <code>META-INF/shenyu/</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šæ‰«æ <code>SHENYU_DIRECTORY</code> ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ç”± <code>ExtensionLoader</code> ç±»æ¥åŠ è½½æ‰€é…ç½®çš„<code>SPI</code>æ‰©å±•ç±»ï¼Œå¹¶cacheåˆ°å†…å­˜ä¸­ã€‚  é…ç½®æ–‡ä»¶å†…å®¹ä¸º key=classçš„å½¢å¼ã€‚ åœ¨ç³»ç»Ÿæ‰§è¡ŒæœŸé—´ï¼Œ ç”±<code>ExtensionFactory</code>çš„å®ç°ç±»ï¼Œè¿”å›keyæ‰€å¯¹åº”çš„<code>SPI</code>å®ç°ç±»ã€‚ </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-pluginçš„spi-å®ç°"></a>shenyu-pluginçš„<code>SPI</code> å®ç°<a class="hash-link" href="#shenyu-pluginçš„spi-å®ç°" title="Direct link to heading">#</a></h2><p>åœ¨<strong><em>shenyu-plugin</em></strong>æ¨¡ç»„ä¸­ï¼ŒæŒ‰ç…§æ’ä»¶æœºåˆ¶ï¼Œå®ç°äº†å„ç§è¯·æ±‚è½¬å‘åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ”¯æŒrequest, redirect, response, rewriteç­‰httpåè®®åŠŸèƒ½ï¼ŒåŠ gRPC, dubbo, hystrixç­‰å¾®æœåŠ¡æ¡†æ¶ï¼Œ å¹¶ä¸”æ’ä»¶åŠŸèƒ½è¿˜åœ¨ä¸æ–­å¢åŠ ä¸­ã€‚å¦‚æœåœ¨å„è‡ªçš„åŠŸèƒ½æ’ä»¶å®åšç±»ä¸­ï¼Œè¿˜è¦åšå¯¹routing å‚æ•°çš„è§£æç­‰å¤„ç†ï¼Œä¸ä»…ä¼šé€ æˆç¨‹åºçš„å†—ä½™ï¼Œè€Œä¸”å½“è¦æ”¯æŒå„è‡ªåŒ¹é…è§„åˆ™ï¼Œå¦‚é€šé…ç¬¦ã€æ­£åˆ™è¡¨è¾¾å¼ã€SpELè§£æç­‰ï¼Œä¼šé€ æˆé¢‘ç¹å¯¹æ’ä»¶æ ¸å¿ƒä»£ç çš„ä¿®æ”¹ã€‚å› æ­¤ï¼Œåœ¨<strong><em>shenyu-plugin</em></strong>æ¨¡ç»„ä¸­ï¼Œå°†routingå‚æ•°è§£æåšäº†æ›´é«˜ä¸€å±‚çš„æŠ½è±¡ï¼Œå¹¶æŒ‰ç…§<code>SPI</code>æœºåˆ¶åšäº†è§„åˆ™è§£æçš„å®ç°ã€‚è§£æç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ul><li><p><code>ParameterData</code>-å‚æ•°èµ„æ–™,  </p></li><li><p><code>PredictJudge</code>-æ–­è¨€</p></li><li><p><code>MatchStrategy</code>-åŒ¹é…ç­–ç•¥ä¸‰ä¸ª<code>SPI</code>å®ç°ã€‚</p><p>è¿™äº›æ‰©å±•ç±»å®šä¹‰åœ¨ <strong><em>shenyu-plugin-base</em></strong> moduleä¸­ï¼Œç»è¿‡è¿™æ ·æŠ½è±¡åï¼Œæ¯ä¸ªæ’ä»¶å®ç°ä¸­ï¼Œrouting å‚æ•°è§£æçš„åŠŸèƒ½å…¨éƒ¨ç”±AbstractShenyuPlugin æ¥è°ƒç”¨ä¸Šè¿°ä¸‰ä¸ª<code>SPI</code>å·¥å‚ç±»æ¥å®šä¹‰å’Œå®ç°ã€‚åšåˆ°äº†åŠŸèƒ½çš„ä¸“ä¸€ï¼Œå¹¶æ˜“äºæ‰©å±•ï¼Œç¬¦åˆSOLIDåŸåˆ™ã€‚</p></li></ul><p>æœ¬èŠ‚å°±å…¶ä¸­çš„<code>PredictJudge</code>-æ–­è¨€åšè¯¦ç»†è§£æã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªmoduleä¸­çš„pomæ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº†å¯¹<strong><em>shenyu-<code>SPI</code></em></strong>çš„ä¾èµ–</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge-spi-è®¾è®¡"></a>PredicateJudge <code>SPI</code> è®¾è®¡<a class="hash-link" href="#predicatejudge-spi-è®¾è®¡" title="Direct link to heading">#</a></h3><p>PredicateJudge <code>SPI</code> å®ç°ç”¨æ¥è§£æåˆ¤æ–­å„ç±»è§„åˆ™ï¼Œå½“ç½‘å…³ä¸­é…ç½®çš„ã€‚è¿™ä¸ªç±»å‘½åå’ŒåŠŸèƒ½éƒ½ç±»ä¼¼äºjava çš„<a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener noreferrer">Predicate</a>  ï¼Œä½†å¯¹æ¥å—è¡Œä¸ºåšäº†æ›´è¿›ä¸€æ­¥çš„æŠ½è±¡ã€‚è¿™ä¸ª<code>SPI</code>é€šè¿‡ä¸€ä¸ªå·¥å‚å’Œç­–ç•¥æ¨¡å¼å®ç°ï¼Œé¦–å…ˆæ¥çœ‹<code>PredicateJudge</code> <code>SPI</code>æ¥å£çš„å®šä¹‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@FunctionalInterface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PredicateJudge {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * judge conditionData and realData is match.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param conditionData {@linkplain ConditionData}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param realData       realData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true is pass  false is not pass.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean judge(ConditionData conditionData, String realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™éƒ¨åˆ†çš„ç±»å›¾å¦‚ä¸‹ï¼š</p><p>Fig 2-Predicate class diagram</p><p><img alt="predicate-class-diagram" src="/zh/assets/images/predicate-class-diagram-67a93b8c3e49800b23fe717c22027c54.png"></p><p><code>PredicateJudgeFactory</code>çš„é‡è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static PredicateJudge newInstance(final String operator) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(PredicateJudge.class).getJoin(processSpecialOperator(operator));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static Boolean judge(final ConditionData conditionData, final String realData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(conditionData) || StringUtils.isBlank(realData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(conditionData.getOperator()).judge(conditionData, realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œ<code>ConditionData</code>å®šä¹‰å¦‚ä¸‹åŒ…å«å±æ€§å››ä¸ªStringç±»å‹çš„å±æ€§ï¼š <code>paramType, operator,paramName,paramValue</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="paramtypeenum"></a>ParamTypeEnum<a class="hash-link" href="#paramtypeenum" title="Direct link to heading">#</a></h4><p>å‚æ•° <code>paramType</code>å¿…é¡»ä¸ºç³»ç»Ÿä¸­æšä¸¾ç±»å‹ <code>ParamTypeEnum</code>ï¼Œé»˜è®¤æ”¯æŒçš„<code>paramType</code>æœ‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">post, uri,query, host, ip,header, cookie,req_method</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="operatorenum"></a>OperatorEnum<a class="hash-link" href="#operatorenum" title="Direct link to heading">#</a></h4><p> <code>operator</code> å¿…é¡»ä¸ºæšä¸¾ç±»å‹ <code>OperatorEnum</code> ï¼Œç›®å‰æ”¯æŒçš„æ“ä½œç¬¦æœ‰ï¼šï¼ˆæ³¨æ„ï¼Œä¸¥æ ¼åŒºåˆ†å¤§å°å†™)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   match, =,regex, &gt;,&lt;, contains, SpEL,  Groovy, TimeBefore,TimeAfter</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŸºäºä»¥ä¸Šçš„è§„åˆ™, plugin æ¨¡ç»„å®ç°äº†å¦‚ä¸‹8ä¸ª <code>PredicateJudge</code> å®ç°ç±»ï¼Œåˆ†åˆ«å®ç°ä¸Šè¿°operatorçš„é€»è¾‘åŒ¹é…è§„åˆ™.</p><table><thead><tr><th>Implementation class</th><th>Rule denotes è§„åˆ™è¯´æ˜</th><th>corespondece operator</th></tr></thead><tbody><tr><td><code>ContainsPredicateJudge</code></td><td>åŒ…å«å…³ç³» &quot;contains&quot;ï¼Œ å®é™…ç»“æœï¼Œéœ€è¦åŒ…å«æ‰€å®šè§„åˆ™çš„å€¼</td><td>contains</td></tr><tr><td><code>EqualsPredicateJudge</code></td><td>ç›¸ç­‰&quot;=&quot;ï¼Œ</td><td>=</td></tr><tr><td><code>MatchPredicateJudge</code></td><td>ç”¨äºURI è·¯å¾„åŒ¹é…çš„å¤„ç†</td><td>match</td></tr><tr><td><code>TimerAfterPredicateJudge</code></td><td>å½“å‰localæ—¶é—´æ˜¯å¦æ™šäºè®¾å®šçš„æ—¶é—´</td><td>TimeAfter</td></tr><tr><td><code>TimerBeforePredicateJudge</code></td><td>å½“å‰localæ—¶é—´æ˜¯å¦æ—©äºè®¾å®šçš„æ—¶é—´</td><td>TimeBefore</td></tr><tr><td><code>GroovyPredicateJudge</code></td><td>Groovy,è®¾å®šParamNameçš„å€¼ï¼Œä¸è®¾å®šParamValueç›¸åŒ</td><td>Groovy</td></tr><tr><td><code>RegexPredicateJudge</code></td><td>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…èµ„æ–™</td><td>regex</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="è°ƒç”¨æ–¹æ³•"></a>è°ƒç”¨æ–¹æ³•<a class="hash-link" href="#è°ƒç”¨æ–¹æ³•" title="Direct link to heading">#</a></h3><p>å½“è¦åšä¸€ç»„å‚æ•°çš„è§£ææ—¶ï¼Œåªéœ€è¦è°ƒç”¨<code>PredicateJudgeFactory</code>çš„judgeæ–¹æ³•å³å¯ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">PredicateJudgeFactory.judge(final ConditionData conditionData, final String realData);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spié…ç½®æ–‡ä»¶"></a><code>SPI</code>é…ç½®æ–‡ä»¶<a class="hash-link" href="#spié…ç½®æ–‡ä»¶" title="Direct link to heading">#</a></h3><p>è¿™äº›<code>PredicateJudge</code>å®ç°ç±»åœ¨  <code>SHENYU_DIRECTORY</code> ä¸­çš„configæ–‡ä»¶ä¸­åšäº†é…ç½®ï¼Œåœ¨å¯åŠ¨æ—¶ä¼šåŠ åŠ è½½å¹¶cacheåˆ°å†…å­˜ä¸­ã€‚</p><p><code>PredicateJudge</code>æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸ºkey=classå½¢å¼ï¼Œå·¦è¾¹çš„operatorè¦å’Œ<code>ParamEnum</code>ä¸­çš„å®šä¹‰ä¸€è‡´ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">equals=org.apache.shenyu.plugin.base.condition.judge.EqualsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">contains=org.apache.shenyu.plugin.base.condition.judge.ContainsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Groovy=org.apache.shenyu.plugin.base.condition.judge.GroovyPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">match=org.apache.shenyu.plugin.base.condition.judge.MatchPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">regex=org.apache.shenyu.plugin.base.condition.judge.RegexPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SpEL=org.apache.shenyu.plugin.base.condition.judge.SpELPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeAfter=org.apache.shenyu.plugin.base.condition.judge.TimerAfterPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeBefore=org.apache.shenyu.plugin.base.condition.judge.TimerBeforePredicateJudge</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge-spiåœ¨ç½‘å…³pluginä¸­çš„ä½¿ç”¨"></a>PredicateJudge <code>SPI</code>åœ¨ç½‘å…³Pluginä¸­çš„ä½¿ç”¨<a class="hash-link" href="#predicatejudge-spiåœ¨ç½‘å…³pluginä¸­çš„ä½¿ç”¨" title="Direct link to heading">#</a></h2><p>ç½‘å…³ç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨åˆ†çš„Plugin éƒ½ç»§æ‰¿è‡ª<code>AbstractShenyuPlugin</code>ï¼Œè¿™ä¸ªæŠ½è±¡ç±»ä¸­ï¼Œåœ¨åšé€‰æ‹©å’Œè§„åˆ™è§£ææ—¶ï¼Œè°ƒç”¨äº†ä¸Šè¿°<code>SPI</code>ä¸­çš„<code>MatchStrategy</code>ï¼Œç»§è€Œåœ¨ç­–ç•¥åˆ¤æ–­æ—¶è°ƒç”¨<code>PredicateJudge</code> çš„å„ä¸ªæ–­è¨€ç±»æ¥å¤„ç†ã€‚</p><p>Pluginä¸<code>SPI</code> çš„ç±»å›¾å¦‚ä¸‹:</p><p>Fig 3- class diagram of plugins with PredicateJudge and <code>MatchStrategy</code> <code>SPI</code></p><p><img alt="plugin-SPI-class-diagram" src="/zh/assets/images/plugin-SPI-class-diagram-fa432591b833ff178cb662ce352f5b23.png"></p><p>ä»å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ï¼Œåœ¨ç³»ç»Ÿä¸­è°ƒç”¨è§„åˆ™éƒ¨åˆ†çš„<code>SPI</code>çš„æµç¨‹å¦‚ä¸‹ï¼š</p><p>Fig 4- flow chart for Shenyu gateway filter  with parameter processing</p><p><img alt="SPI-flow-diagram" src="/zh/assets/images/SPI-flow-diagram-590f2cd298ae7655330a62a2010b006e.png"></p><ul><li>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šåŠ è½½ç›®å½•ä¸‹é…ç½®çš„<code>SPI</code>èµ„æ–™åˆ°å†…å­˜ä¸­</li><li>å½“clientæœ‰æ–°çš„è¯·æ±‚å‘åˆ°Apache shenyu ç½‘å…³ç³»ç»Ÿæ—¶ï¼Œåœ¨ç½‘å…³å†…éƒ¨ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„plugin</li><li>å¯¹å®é™…è¯·æ±‚èµ„æ–™åšè§„åˆ™åŒ¹é…æ—¶ï¼Œä¼šæ ¹æ®æ‰€åŒ…å«çš„operator,è°ƒç”¨çš„å¯¹åº”çš„PredicateJudgeå®ç°ç±»</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å…¶ä»–"></a>å…¶ä»–<a class="hash-link" href="#å…¶ä»–" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="predicatejudge--åˆ¤æ–­ç»“æœä¸¾ä¾‹"></a>PredicateJudge  åˆ¤æ–­ç»“æœä¸¾ä¾‹<a class="hash-link" href="#predicatejudge--åˆ¤æ–­ç»“æœä¸¾ä¾‹" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="containspredicatejudge---contains-rule"></a>ContainsPredicateJudge- &quot; containsâ€œ rule<a class="hash-link" href="#containspredicatejudge---contains-rule" title="Direct link to heading">#</a></h4><p> ä¸¾ä¾‹ï¼šç»™å®šä¸€ç»„å‚æ•°ï¼ˆConditionData ï¼‰ï¼Œ paramType=&quot;uri&quot;, paramValue æ˜¯ &quot;/http/**&quot;</p><p>å½“åº”ç”¨ ContainsPredicateJudgeåŒ…å«å…³ç³»æ—¶ï¼Œåˆ¤æ–­ç»“æœå¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>ConditionData  (operator=&quot;contains&quot;)</th><th>real data</th><th>judge result</th></tr></thead><tbody><tr><td>paramType=&quot;uri&quot;,    &quot;/http/**&quot;</td><td>&quot;/http/**/test&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/test/http/**/other&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/http1/**&quot;</td><td>false</td></tr></tbody></table><p>å…¶ä»–çš„å‡ ä¸ªPredicateJudgeçš„å…·ä½“åŠŸèƒ½å¯å‚è€ƒå…¶ä»£ç å’Œæµ‹è¯•ç±».</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about PredicateJudge-- åŸºäºSPIçš„è®¾è®¡å®ç°åˆ†æ" href="/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI ä»£ç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-12-07T02:16:01.580Z">2022å¹´12æœˆ7æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>é™æµæ˜¯ç½‘å…³å¿…å¤‡çš„åŠŸèƒ½ï¼Œç”¨æ¥åº”å¯¹é«˜å¹¶å‘è¯·æ±‚çš„åœºæ™¯ã€‚å½“ç³»ç»Ÿå—åˆ°å¼‚å¸¸æ”»å‡»ï¼ŒçŸ­æœŸå†…èšé›†äº†å¤§é‡çš„æµé‡ï¼›å½“æœ‰å¤§é‡ä½çº§åˆ«çš„è¯·æ±‚ï¼Œå¤„ç†è¿™äº›è¯·æ±‚ä¼šå½±å“å…³é”®ä¸šåŠ¡çš„å¤„ç†ï¼Œéœ€è¦é™åˆ¶è¿™äº›è¯·æ±‚çš„è®¿é—®é€Ÿåº¦; æˆ–è€…ç³»ç»Ÿå†…éƒ¨å‡ºç°ä¸€äº›å¼‚å¸¸ï¼Œä¸èƒ½æ»¡è´Ÿè·çš„æœåŠ¡æ•´ä¸ªåº”ç”¨è¯·æ±‚ç­‰ç­‰ã€‚è¿™äº›æƒ…å†µä¸‹ï¼Œéƒ½éœ€è¦å¯ç”¨é™æµæ¥ä¿æŠ¤ç³»ç»Ÿã€‚å¯ä»¥æ‹’ç»æœåŠ¡ã€ç­‰å¾…æˆ–é™çº§å¤„ç†ï¼Œå°†æµé‡é™åˆ¶åˆ°ç³»ç»Ÿå¯æ¥å—çš„é‡ï¼Œæˆ–è€…åªå…è®¸æŸäº›åŸŸå(æˆ–æŸäº›ä¸šåŠ¡)çš„è¯·æ±‚ä¼˜å…ˆå¤„ç†ã€‚</p><p>   é’ˆå¯¹ä»¥ä¸Šçš„åœºæ™¯éœ€æ±‚ï¼Œåœ¨è®¾è®¡ä¸€ä¸ª<code>API</code>ç½‘å…³çš„é™æµåŠŸèƒ½æ—¶ï¼Œå°±éœ€è¦è€ƒè™‘å¦‚ä¸‹çš„æ‰©å±•ç‚¹ï¼š</p><ol><li><p>å¯ä»¥æ”¯æŒå¤šç§é™æµçš„ç®—æ³•ï¼Œå¹¶æ˜“äºæ‰©å±•ã€‚</p></li><li><p>è¦å¯ä»¥æ”¯æŒå¤šç§é™æµçš„æ–¹å¼ï¼Œèƒ½åŒºåˆ†ç”¨æˆ·ç¾¤ã€é«˜ä½ä¼˜å…ˆçº§çš„è¯·æ±‚ã€‚</p></li><li><p>è¦æ”¯æŒé«˜å¹¶å‘ï¼Œèƒ½å¿«é€Ÿçš„åšå‡ºé™åˆ¶æˆ–é€šè¿‡çš„å†³ç­–ã€‚</p></li><li><p>è¦æœ‰å®¹é”™å¤„ç†ï¼Œå¦‚æœé™æµç¨‹åºå‡ºé”™ï¼Œç½‘å…³ç³»ç»Ÿèƒ½ç»§ç»­æ‰§è¡Œã€‚</p><p>æœ¬æ–‡ä¼šå…ˆä»‹ç»shenyuç½‘å…³é™æµéƒ¨åˆ†çš„æ€»ä½“æŠ€æœ¯æ¶æ„ï¼Œä¹‹åé‡ç‚¹åˆ†æ<code>RateLimiter</code> SPIæ‰©å±•å®ç°çš„ä»£ç ã€‚</p></li></ol><blockquote><p>This article based on <code>shenyu-2.4.0</code> version of the source code analysis.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiter--æ€»ä½“è®¾è®¡è¯´æ˜"></a>RateLimiter  æ€»ä½“è®¾è®¡è¯´æ˜<a class="hash-link" href="#ratelimiter--æ€»ä½“è®¾è®¡è¯´æ˜" title="Direct link to heading">#</a></h2><p>â€‹        WebFluxæ˜¯Spring æä¾›çš„åŸºäºReactoræ¨¡å‹çš„å¼‚æ­¥éé˜»å¡æ¡†æ¶ï¼Œèƒ½æå‡ååé‡ï¼Œä½¿ç³»ç»Ÿæœ‰æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ã€‚Apache Shenyuç½‘å…³çš„æ’ä»¶åŠŸèƒ½åŸºäºWebFluxæ¡†æ¶å®ç°çš„ã€‚RateLimiteråŠŸèƒ½æ˜¯åœ¨<code>ratelimiter-plugin</code>ä¸­å®ç°ã€‚åœ¨é™æµè¿‡ç¨‹ä¸­ï¼Œå¸¸ç”¨çš„ç®—æ³•æœ‰ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ç­‰ç®—æ³•ï¼Œè¿™äº›ç®—æ³•æ‰§è¡Œä¸­ï¼Œéœ€è¦æ£€æ ¸è¯·æ±‚çš„æ¥æºï¼Œå¯¹å·²ä½¿ç”¨çš„æµé‡åšè®¡æ•°åŠé€»è¾‘è®¡ç®—ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸é€šè¿‡ã€‚ä¸ºäº†æé«˜å¹¶å‘åŠæ€§èƒ½ï¼Œ å°†è®¡æ•°å’Œç®—æ³•é€»è¾‘å¤„ç†ï¼Œéƒ½æ”¾åˆ°redisä¸­ã€‚Javaä»£ç è´Ÿè´£åšæ•°æ®å‚æ•°çš„ä¼ é€’ã€‚åœ¨è°ƒç”¨redisæ—¶ï¼Œ<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">lua</a>è„šæœ¬å¯ä»¥å¸¸é©»åœ¨rediså†…å­˜ä¸­ï¼Œèƒ½å‡å°‘ç½‘ç»œå¼€é”€ï¼Œå¹¶å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œï¼Œå…·æœ‰åŸå­æ€§ã€‚<a href="https://spring.io/projects/spring-data-redis" target="_blank" rel="noopener noreferrer">Spring Data Redis</a> æä¾›äº†å¯¹<a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer">rediså‘½ä»¤</a>æ‰§è¡Œçš„æŠ½è±¡ï¼Œæ‰§è¡Œåºåˆ—åŒ–ï¼ŒåŠè‡ªåŠ¨ä½¿ç”¨redis è„šæœ¬ç¼“å­˜ã€‚åœ¨è¿™ä¸ªpluginä¸­ï¼Œç”±äºé‡‡ç”¨äº†reactor éé˜»å¡æ¡†æ¶ï¼Œæ‰€ä»¥é‡‡ç”¨Spring Redis Reactiveç±»åº“å®ç°å¯¹redisçš„åŠŸèƒ½è°ƒç”¨ã€‚</p><p>â€‹        è¿™ä¸ªpluginä¸­çš„ç±»åŒ…å›¾å¦‚ä¸‹ï¼Œé‡ç‚¹æ ‡å‡ºäº†ä¸<code>RateLimiter</code> <code>SPI</code>ç›¸å…³çš„ä¸¤ä¸ªpackage: resolver å’Œalgorithm.</p><p><img alt="ratelimiter-package-diagram" src="/zh/assets/images/ratelimiter-package-diagram-b041571cdf2f8592c23ab33bf07fbc71.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiter-spiçš„è®¾è®¡"></a>RateLimiter SPIçš„è®¾è®¡<a class="hash-link" href="#ratelimiter-spiçš„è®¾è®¡" title="Direct link to heading">#</a></h2><p>ç”±äºé‡‡ç”¨äº†Spring data+ Redis +luaæ¶æ„å®ç°äº†é«˜å¹¶å‘çš„éœ€æ±‚ã€‚ å¦‚ä½•åšåˆ°å¯¹ç®—æ³•å’Œé™æµæ–¹å¼çš„æ‰©å±•å‘¢ï¼Ÿ Shenyu ratelimiter  pluginä¸­è®¾è®¡äº†ä¸¤ä¸ªSPIæ¥å®ç°è¿™ä¸¤ä¸ªéœ€æ±‚ï¼š</p><ul><li><code>RateLimiterAlgorithm</code>ï¼šç”¨æ¥æ‰©å±•ä¸åŒçš„é™æµç®—æ³•ã€‚</li><li><code>RateLimiterKeyResolver</code>ï¼š ç”¨äºæ‰©å±•è·å–è¯·æ±‚çš„å…³é”®ä¿¡æ¯ï¼Œç”¨äºåŒºåˆ†æµé‡ï¼Œä¾‹å¦‚æŒ‰IP åœ°å€ã€æŒ‰æŸä¸€æ®µåŸŸåç­‰æ¥åŒºåˆ†è®¿é—®çš„è¯·æ±‚ã€‚</li></ul><p>SPIçš„å…·ä½“å®ä½œç±»ä¸é…ç½®ä¿¡æ¯ä½äºï¼š<code>SHENYU_DIRECTORY</code>ç›®å½•ä¸‹ (é»˜è®¤åœ¨<code>/META-INF/shenyu</code>)ä¸‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiterkeyresolver"></a>RateLimiterKeyResolver<a class="hash-link" href="#ratelimiterkeyresolver" title="Direct link to heading">#</a></h3><p>è·å–è¯·æ±‚çš„å…³é”®ä¿¡æ¯ï¼Œç”¨äºåˆ†ç»„é™æµï¼Œä¾‹å¦‚æŒ‰URL/ ç”¨æˆ· / IP ç­‰ï¼Œ <code>RateLimiterKeyResolver</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterKeyResolver {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get Key resolver&#x27;s name.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return Key resolver&#x27;s name</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getKeyResolverName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * resolve.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param exchange exchange the current server exchange {@linkplain ServerWebExchange}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return rate limiter key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolve(ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code>å°†å½“å‰interface æ³¨å†Œä¸ºShenyu SPI æ¥å£ã€‚resolve(ServerWebExchange exchange)æ–¹æ³•ç”¨æ¥æä¾›è§£ææ–¹å¼ã€‚</p><p>RateLimiterKeyResolver  SPI æä¾›äº†ä¸¤ç§key resolver, <code>WholeKeyResolve</code>å’Œ <code>RemoteAddrKeyResolver</code>ï¼Œå…¶ä¸­<code>RemoteAddrKeyResolver</code>ä¸­çš„<code>resolve</code>æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String resolve(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…¶keyå€¼ä¸ºè¯·æ±‚çš„IPåœ°å€ã€‚ åŸºäºSPIåŠå·¥å‚ç±»çš„å®ç°ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„æ‰©å±•å®ç°æ–°çš„key resolverï¼Œå¦‚URL,ç”¨æˆ·ç­‰ç­‰ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ratelimiteralgorithm-spi"></a>RateLimiterAlgorithm SPI<a class="hash-link" href="#ratelimiteralgorithm-spi" title="Direct link to heading">#</a></h3><p><code>RateLimiterAlgorithm</code> SPI ç”¨æ¥å®ç°å¯¹ä¸åŒé™æµç®—æ³•çš„è¯†åˆ«ã€åŠ è½½å’Œå®šä¹‰ï¼Œå…¶ç±»å›¾å¦‚ä¸‹ï¼š</p><p><img alt="ratelimiteral-class-diagram" src="/zh/assets/images/ratelimiteral-class-diagram-24df4785848602bdc5b321cf609d5cda.png"></p><p>æœ¬æ¨¡ç»„ä½¿ç”¨äº†å·¥å‚æ¨¡å¼ï¼Œæä¾›äº†æ¥å£ç±»ã€æŠ½è±¡ç±»å’Œå·¥å‚ç±»ï¼Œæä¾›äº†4ä¸ªå®ç°ç±»ï¼Œå…¶ä¸­å®ç°ç±»å¯¹åº”çš„Luaè„šæœ¬åœ¨ <code>RateLimitEnum</code> ä¸­åšäº†å®šä¹‰ï¼Œæ”¾ç½®åœ¨ <code>/META-INF/scripts</code> ç›®å½•ä¸‹ã€‚æ¥å£<code>RateLimiterAlgorithm</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RateLimiterAlgorithm&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisScript&lt;T&gt; getScript();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; getKeys(String id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param script the script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param keys the keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param scriptArgs the script args</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>@SPI</code> å°†è¿™ä¸ªæ¥å£æ³¨å†Œä¸ºshenyu SPI, å…¶ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>getScript()</code> æ–¹æ³•è¿”å›ä¸€ä¸ª <code>RedisScript</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°†ä¼ é€’ç»™Redisã€‚</li><li><code>getKeys(String id)</code> è¿”å›ä¸€ä¸ªé”®å€¼çš„List.</li><li><code>callback()</code>å›è°ƒå‡½æ•°ç”¨äºå¼‚æ­¥å¤„ç†ä¸€äº›éœ€è¦åœ¨è¿”å›ååšçš„å¤„ç†ï¼Œç¼ºçœæ˜¯ç©ºæ–¹æ³•ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æŠ½è±¡ç±»-abstractratelimiteralgorithm"></a>æŠ½è±¡ç±» AbstractRateLimiterAlgorithm<a class="hash-link" href="#æŠ½è±¡ç±»-abstractratelimiteralgorithm" title="Direct link to heading">#</a></h4><p>åœ¨è¿™ä¸ªç±»ä¸­ï¼Œå®ç°äº†æ¥å£çš„æ¨¡æ¿æ–¹æ³•ï¼Œä½¿ç”¨å‚æ•°ç±»å‹ä¸º<code>List&lt;Long&gt;</code>,  æŠ½è±¡æ–¹æ³•getScriptName() å’ŒgetKeyName() ç•™ç»™å„ä¸ªå®ä½œç±»æ¥å®ç°ã€‚å¦‚ä¸‹çš„getScript() æ˜¯è¿™ä¸ªç±»ä¸­è¯»å–luaè„šæœ¬çš„å¤„ç†ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public RedisScript&lt;List&lt;Long&gt;&gt; getScript() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.initialized.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultRedisScript redisScript = new DefaultRedisScript&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String scriptPath = &quot;/META-INF/scripts/&quot; + getScriptName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(scriptPath)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            redisScript.setResultType(List.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.script = redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialized.compareAndSet(false, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return redisScript;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return script;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AtomicBoolean</code>ç±»å‹çš„å˜é‡<code>initialized</code> ç”¨æ¥æ ‡è®°luaè„šæœ¬æ˜¯å¦æœ‰è¢«åŠ è½½ã€‚ å¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼Œå°±ä»/META-INF/scripts/ç›®å½•ä¸‹ï¼Œè¯»å–<code>scriptName</code>æŒ‡å®šçš„Luaæ–‡ä»¶ï¼ŒåŠ è½½æˆ<code>RedisScript</code>å¯¹è±¡ã€‚æŒ‡å®šç»“æœä¸º<code>List</code>ç±»å‹ï¼Œ è®¾å®šé‡<code>initialized</code>ä¸ºtrue,é¿å…é‡å¤åŠ è½½ã€‚ è¿”å› <code>RedisScript</code>å¯¹è±¡ã€‚</p><p><code>AbstractRateLimiterAlgorithm</code>ä¸­<code>getKeys()</code>çš„ä»£ç å¦‚ä¸‹ï¼Œ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String prefix = getKeyName() + &quot;.{&quot; + id;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = prefix + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String timestampKey = prefix + &quot;}.timestamp&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, timestampKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ¨¡æ¿æ–¹æ³•ä¸­ï¼Œäº§ç”Ÿäº†ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­ï¼Œ<code>tokenKey</code>ä¼šä½œä¸ºKeyä¼ é€’ç»™<code>redis</code>, æŒ‡å‘ä¸€ä¸ªæœ‰åºé›†åˆã€‚ <code>timestampKey</code>æ˜¯ä¸€ä¸ªä»¥ä¼ å…¥id ä¸ºè¯†åˆ«çš„å­—ç¬¦ä¸²ã€‚</p><p>å¯ä»¥ä»ä¸Šé¢çš„ç±»å›¾ä¸­çœ‹åˆ°ï¼Œ<code>ConcurrentRateLimiterAlgorithm</code> å’Œ<code>SlidingWindowRateLimiterAlgorithm</code> æœ‰è¦†å†™<code>getKeys(String id)</code>æ–¹æ³•ï¼Œè€Œä¸¤å¤–ä¸¤ä¸ªç®—æ³•ç¨‹åºï¼Œåˆ™é‡‡ç”¨çš„æ˜¯æŠ½è±¡ç±»ä¸­çš„å®ç°ã€‚ä¹Ÿåªæœ‰ <code>ConcurrentRateLimiterAlgorithm</code> é‡å†™äº†<code>callback()</code>æ–¹æ³•ã€‚ä¸‹æ–‡ä¸­æˆ‘ä»¬ä¼šå¯¹æ­¤åšè¿›ä¸€æ­¥çš„åˆ†æã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å·¥å‚ç±»ratelimiteralgorithmfactory"></a>å·¥å‚ç±»RateLimiterAlgorithmFactory<a class="hash-link" href="#å·¥å‚ç±»ratelimiteralgorithmfactory" title="Direct link to heading">#</a></h4><p><code>RateLimiterAlgorithmFactory</code> ä¸­ä¾æ®ç®—æ³•åç§°ï¼Œè·å–RateLimiterAlgorithmå®ä¾‹çš„æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static RateLimiterAlgorithm&lt;?&gt; newInstance(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Optional.ofNullable(ExtensionLoader.getExtensionLoader(RateLimiterAlgorithm.class).getJoin(name)).orElse(new TokenBucketRateLimiterAlgorithm());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æŒ‰ç…§Apache shenyu SPIçš„è§„åˆ™ï¼Œç”±åŠ è½½å™¨<code>ExtensionLoader</code>è·å¾—å®ä½œç±»ï¼Œå½“æ‰¾ä¸åˆ°ç®—æ³•æ—¶ï¼Œé»˜è®¤è¿”å›ä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ç±»ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä¸redisåšèµ„æ–™äº¤äº’"></a>ä¸Redisåšèµ„æ–™äº¤äº’<a class="hash-link" href="#ä¸redisåšèµ„æ–™äº¤äº’" title="Direct link to heading">#</a></h3><p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬äº†è§£åˆ°Apache Shenyuç½‘å…³ä¸­ï¼ŒRateLimiter SPI çš„åŸºæœ¬æ‰©å±•ç‚¹ï¼Œåœ¨Shenyuç½‘å…³è¿è¡Œä¸­ï¼Œåº”ç”¨ReactiveRedisTemplate æ¥å¼‚æ­¥æ‰§è¡Œå¯¹redisçš„è°ƒç”¨å¤„ç†ã€‚å®ç°ä»£ç åœ¨RedisRateLimiterç±»çš„isAllowed()æ–¹æ³•ä¸­ï¼Œå…¶éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;RateLimiterResponse&gt; isAllowed(final String id, final RateLimiterHandle limiterHandle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get parameters that will pass to redis from RateLimiterHandle Object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double replenishRate = limiterHandle.getReplenishRate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double burstCapacity = limiterHandle.getBurstCapacity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        double requestCount = limiterHandle.getRequestCount();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get the current used RateLimiterAlgorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RateLimiterAlgorithm&lt;?&gt; rateLimiterAlgorithm = RateLimiterAlgorithmFactory.newInstance(limiterHandle.getAlgorithmName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ........</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flux&lt;List&lt;Long&gt;&gt; resultFlux = Singleton.INST.get(ReactiveRedisTemplate.class).execute(script, keys, scriptArgs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultFlux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(1L, -1L)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .reduce(new ArrayList&lt;Long&gt;(), (longs, l) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    longs.addAll(l);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return longs;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).map(results -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean allowed = results.get(0) == 1L;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Long tokensLeft = results.get(1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new RateLimiterResponse(allowed, tokensLeft);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnError(throwable -&gt; log.error(&quot;Error occurred while judging if user is allowed by RedisRateLimiter:{}&quot;, throwable.getMessage()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doFinally(signalType -&gt; rateLimiterAlgorithm.callback(script, keys, scriptArgs));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>POJO å¯¹è±¡RateLimiterHandle ä¸­ï¼Œå®šä¹‰äº†é™æµæ‰€éœ€çš„å±æ€§ç®—æ³•åç§°, é€Ÿå½•ï¼Œå®¹é‡ï¼Œè¯·æ±‚çš„æ•°é‡ ã€‚é¦–å…ˆ ä»limiterHandle åŒ…è£…ç±»ä¸­å–å¾—éœ€è¦ä¼ å…¥redisçš„å‡ ä¸ªå‚æ•°ã€‚ä¹‹åä»RateLimiterAlgorithmFactory ä»å·¥å‚ç±»å–å¾—å½“å‰é…ç½®çš„é™æµç®—æ³•ã€‚ ä¹‹ååšKeyå€¼å’Œå‚æ•°çš„ä¼ é€’ã€‚</p><p>ä¸ºäº†æ›´æ–¹ä¾¿é˜…è¯»ï¼Œä¸‹å›¾ç»™å‡ºäº†javaä»£ç ä¸redisæ‰§è¡Œå‚æ•°è¾“å…¥ã€è¾“å‡ºçš„ä¼ é€’è¿‡ç¨‹ã€‚å·¦è¾¹æ˜¯<code>isAllowed</code>() å‡½æ•°çš„ååŠéƒ¨åˆ†ä»£ç ï¼Œå³è¾¹æ˜¯ä¸€ä¸ªLuaè„šæœ¬çš„è¾“å…¥è¾“å‡ºä»£ç ã€‚</p><p>ä¸‹é¢è¯´æ˜Javaä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ol><li><p>ä»<code>getKeys()</code>æ–¹æ³•è·å¾—ä¸¤ä¸ªé”®å€¼<code>List&lt;String&gt;</code>. å…¶ä¸­ç¬¬ä¸€ä¸ªKeyä¼šæ˜ å°„ä¸ºRedisä¸­çš„æœ‰åºé›†åˆã€‚</p></li><li><p>è®¾å®š4ä¸ªå‚æ•°ï¼šé€Ÿç‡ replenishRate ,å®¹é‡ burstCapacity, æ—¶é—´æˆ³ï¼Œ è¿”å›å½“å‰java çºªå…ƒç§’æ•°(é•¿æ•´æ•°)EpochSecond, è¯·æ±‚çš„æ•°é‡ requestcount.</p></li><li><p>æŒ‰æ‰€è®¾å®šçš„è„šæœ¬ã€Keyå€¼ã€å‚æ•°è°ƒç”¨<code>ReactiveRedisTemplate</code>åŠŸèƒ½ï¼Œæ‰§è¡Œrediså¤„ç†ã€‚è¿”å›å‚æ•°æ˜¯<code>Flux&lt;List&lt;Long&gt;&gt;</code>ç±»å‹</p></li><li><p>é€šè¿‡reduceæ–¹æ³•å°†å…¶è¿”å›å€¼ä»<code>Flux&lt;ArrayList&lt;Long&gt;&gt;</code> ç±»å‹è½¬æ¢ä¸º<code>Mono&lt;ArrayList&lt;Long&gt;&gt;</code>ï¼Œå†ç»è¿‡mapæ–¹æ³•ï¼Œè½¬æ¢ä¸º<code>Mono&lt;RateLimiterResponse&gt;</code>è¿”å›ã€‚</p><p> è¿”å›ç»“æœæœ‰ä¸¤ä¸ªèµ„æ–™ï¼Œallowed =1, ä»£è¡¨å…è®¸é€šè¿‡ï¼Œ0-ä¸é€šè¿‡ï¼›è€Œç¬¬äºŒä¸ªè¿”å›å‚æ•°tokensLeftï¼Œæ˜¯å¯ç”¨çš„å‰©ä½™è¯·æ±‚æ•°é‡ã€‚</p></li></ol><p>5.å®¹é”™æ€§æ–¹é¢ï¼Œç”±äºä½¿ç”¨çš„æ˜¯reactor çš„éé˜»å¡é€šè®¯æ¨¡å‹ï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä¼šæ‰§è¡ŒonErrorResume()è¯­å¥ï¼ŒFlux.justäº§ç”Ÿè¿”å›èµ„æ–™ï¼Œ é»˜è®¤ä¸º<code>allowed</code>=1, ä»£è¡¨å…è®¸é€šè¿‡ï¼Œ å¹¶ä¸¢å‡ºé”™è¯¯æ—¥å¿—ã€‚</p><p>6.ä¹‹åæ‰§è¡ŒdoFinally()æ–¹æ³•,æ‰§è¡Œç®—æ³•å®ç°ç±»çš„callbackæ–¹æ³•ã€‚</p><p><img alt="io-with-lua" src="/zh/assets/images/io-with-lua-eefcd28d4b59a8bd0e69e29400018c50.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4ç§é™æµç®—æ³•"></a>4ç§é™æµç®—æ³•<a class="hash-link" href="#4ç§é™æµç®—æ³•" title="Direct link to heading">#</a></h2><p>ä¸Šé¢æˆ‘ä»¬äº†è§£äº†ç½‘å…³ä¸­å¦‚ä½•é€šè¿‡Javaä»£ç å¦‚ä½•ä¸Redis åšé€šè®¯ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬é€šè¿‡ç®€è¦åˆ†æç½‘å…³ä¸­æä¾›çš„4ç§é™æµç®—æ³•ä¸­çš„ä¸€äº›ä»£ç ï¼Œæ¥ç†è§£å¦‚ä½•å¼€å‘ä½¿ç”¨<code>RateLimiter SPI</code>çš„æ¥å£æ–¹æ³•,å¹¶ä¸Redisæœ‰æ•ˆåä½œã€‚</p><p><code>Ratelimiter SPI</code>ç›®å‰æä¾›äº†4ç§é™æµç®—æ³•:</p><table><thead><tr><th>Algorithm name</th><th>Java class</th><th>Lua script file</th></tr></thead><tbody><tr><td>Request rate limiter</td><td><code>TokenBucketRateLimiterAlgorithm</code></td><td>request_rate_limiter.lua</td></tr><tr><td>Slide window rate limiter</td><td><code>SlidingWindowRateLimiterAlgorithm</code></td><td>liding_window_request_rate_limiter.lua</td></tr><tr><td>Concurrent rate limiter</td><td><code>ConcurrentRateLimiterAlgorithm</code></td><td>concurrent_request_rate_limiter.lua</td></tr><tr><td>Leaky bucket algorithm</td><td><code>LeakyBucketRateLimiterAlgorithm</code></td><td>request_leaky_rate_limiter.lua</td></tr></tbody></table><ol><li>ä»¤ç‰Œæ¡¶é™æµï¼šæŒ‰è¯·æ±‚æ•°é‡é™æµï¼Œè®¾ç½®æ¯ç§’Nä¸ªè¯·æ±‚ï¼Œè¶…è¿‡Nçš„è¯·æ±‚ä¼šæ‹’ç»æœåŠ¡ã€‚ç®—æ³•å®ç°æ—¶ï¼Œä»¥æ—¶é—´é—´éš”è®¡ç®—åŒ€é€Ÿäº§ç”Ÿä»¤ç‰Œçš„æ•°é‡ã€‚è‹¥æ¯æ¬¡è¯·æ±‚çš„æ•°é‡ï¼Œå°äºæ¡¶å†…ä»¤ç‰Œçš„æ•°é‡ï¼Œåˆ™å…è®¸é€šè¿‡ã€‚ æ—¶é—´çª—å£ä¸º 2*å®¹ç§¯/é€Ÿç‡ã€‚</li><li>æ»‘åŠ¨çª—å£é™æµï¼šä¸ä»¤ç‰Œæ¡¶é™æµä¸åŒåœ¨äºï¼Œå…¶çª—å£å¤§å°æ¯”ä»¤ç‰Œæ¡¶çš„çª—å£å°ï¼Œä¸ºä¸€ä¸ªå®¹ç§¯/é€Ÿç‡ã€‚å¹¶ä¸”æ¯æ¬¡ç§»åŠ¨å‘åä¸€ä¸ªæ—¶é—´æ—¶é—´çª—å£ã€‚å…¶ä»–é™æµåŸç†ä¸ä»¤ç‰Œæ¡¶ç±»ä¼¼ã€‚</li><li>å¹¶å‘çš„è¯·æ±‚é€Ÿç‡é™æµï¼šä¸¥æ ¼é™åˆ¶å¹¶å‘è®¿é—®é‡ä¸ºNä¸ªè¯·æ±‚ï¼Œå¤§äºNçš„è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚æ¯æ¬¡å½“æœ‰æ–°è¯·æ±‚ï¼ŒæŸ¥çœ‹è®¡æ•°æ˜¯å¦å¤§äºN, è‹¥å°äºNåˆ™å…è®¸é€šè¿‡ï¼Œè®¡æ•°åŠ 1ã€‚ å½“è¿™ä¸ªè¯·æ±‚è°ƒç”¨ç»“æŸæ—¶ï¼Œä¼šé‡Šæ”¾è¿™ä¸ªä¿¡å·ï¼ˆè®¡æ•°å‡1ï¼‰</li><li>æ¼æ¡¶ç®—æ³•:  ç›¸å¯¹äºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¼æ¡¶ç®—æ³•æœ‰åŠ©äºå‡å°‘æµé‡èšé›†ï¼Œå®ç°æ›´ä¸ºå¹³æ»‘çš„é™æµå¤„ç†ã€‚ æ¼æ¡¶ç®—æ³•å¼ºåˆ¶ä»¥å¸¸æ•°Nçš„é€Ÿç‡è¾“å‡ºæµé‡ï¼Œå…¶ä»¥æ¼æ¡¶ä¸ºæ¨¡å‹ï¼Œå¯æ¼æ°´çš„é‡ä¸ºæ—¶é—´é—´éš” *é€Ÿç‡ã€‚è‹¥å¯æ¼æ°´é‡&gt;å·²ä½¿ç”¨é‡ï¼Œåˆ™å·²ä½¿ç”¨é‡è®¾ä¸º0( æ¸…ç©ºæ¼æ¡¶)ï¼Œå¦åˆ™å·²ä½¿ç”¨é‡è¦å‡å»å¯æ¼æ°´é‡ã€‚  è‹¥è¯·æ±‚æ•°é‡+ å·²ä½¿ç”¨é‡&lt; æ€»å®¹é‡ï¼Œåˆ™å…è®¸è¯·æ±‚é€šè¿‡ã€‚</li></ol><p>ä¸‹é¢ä»¥ å¹¶è¡Œé™æµç®—æ³•ä¸ºä¾‹ï¼Œè§£è¯»Luaå’ŒJavaä»£ç ï¼ŒæŸ¥çœ‹callback æ–¹æ³•çš„ä½¿ç”¨ã€‚ é€šè¿‡è§£è¯»ä»¤ç‰Œæ¡¶å’Œæ»‘åŠ¨çª—å£ç®—æ³•ä»£ç ï¼Œäº†è§£getKey()æ–¹æ³•çš„ä½¿ç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•"></a>å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•<a class="hash-link" href="#å¹¶å‘è¯·æ±‚æ•°é™æµä¸­ä½¿ç”¨callbackæ–¹æ³•" title="Direct link to heading">#</a></h3><p>é¦–å…ˆ<code>ConcurrentRateLimiterAlgorithm</code> çš„<code>getKeys()</code> æ–¹æ³•è¦†å†™äº†æŠ½è±¡ç±»ä¸­çš„æ¨¡æ¿æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;String&gt; getKeys(final String id) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String tokenKey = getKeyName() + &quot;.{&quot; + id + &quot;}.tokens&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String requestKey = UUIDUtils.getInstance().generateShortUuid();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.asList(tokenKey, requestKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç¬¬äºŒä¸ªå…ƒç´  requestKey æ˜¯ä¸€ä¸ªlongå‹ä¸é‡å¤å€¼(ç”±ä¸€ä¸ªåˆ†å¸ƒå¼IDäº§ç”Ÿå™¨äº§ç”Ÿçš„ï¼Œé€’å¢ï¼Œæ¯”å½“å‰æ—¶é—´EpochSecondå°)ï¼Œ ç›¸åº”çš„concurrent_request_rate_limiter.luaçš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local capacity = tonumber(ARGV[2])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp = tonumber(ARGV[3])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local id = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œid å³æ˜¯å–å¾—ä¸Šé¢çš„getKeys()æ–¹æ³•äº§ç”Ÿçš„requestKeyï¼Œ ä¸€ä¸ªuuid.  åç»­çš„å¤„ç†å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local count = redis.call(&quot;zcard&quot;, key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if count &lt; capacity then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis.call(&quot;zadd&quot;, key, timestamp, id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count = count + 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed, count }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å…ˆç”¨zcardå‘½ä»¤ç»Ÿè®¡redisä¸­keyå€¼æ‰€å¯¹åº”çš„æœ‰åºé›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œè‹¥å…ƒç´ æ€»æ•°countå°äºå®¹é‡ï¼Œåˆ™å…è®¸é€šè¿‡ï¼Œå¹¶ç”¨zadd key score memberæ–¹æ³•ï¼Œå‘keyæ‰€åœ¨çš„æœ‰åºé›†åˆä¸­ï¼Œæ·»åŠ ä¸€ä¸ªå…ƒç´ id, å…¶scoreä¸ºtimestamp.  åˆ™æ­¤æ—¶å…ƒç´ çš„æ€»ä¸ªæ•°countå®é™…ä¸ºcount+1.  </p><p>ä»¥ä¸Šçš„ä»£ç éƒ½æ˜¯åœ¨redisä¸­ä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œæ¥æ‰§è¡Œçš„ã€‚å½“åŒä¸€ä¸ªkey (ä¾‹å¦‚Ipä¸‹)æœ‰å¤§é‡å¹¶å‘è¯·æ±‚æ—¶ï¼Œredisè®°å½•çš„è¯¥ipçš„æœ‰åºé›†åˆçš„æ•°é‡countä¹Ÿåœ¨ä¸æ–­ç´¯åŠ ä¸­ã€‚å½“è¶…è¿‡å®¹é‡é™åˆ¶ï¼Œåˆ™ä¼šæ‹’ç»æœåŠ¡ã€‚</p><p>å¹¶å‘è¯·æ±‚æ•°é™æµç®—æ³•ä¸­ï¼Œè¦æ±‚å½“è¯·æ±‚è°ƒç”¨ç»“æŸæ—¶ï¼Œè¦é‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ï¼Œluaä»£ç ä¸­å¹¶æ²¡æœ‰åšè¿™ä¸ªå¤„ç†ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>ConcurrentRateLimiterAlgorithm</code>ç±»ä¸­çš„å›è°ƒå‡½æ•°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void callback(final RedisScript&lt;?&gt; script, final List&lt;String&gt; keys, final List&lt;String&gt; scriptArgs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Singleton.INST.get(ReactiveRedisTemplate.class).opsForZSet().remove(keys.get(0), keys.get(1)).subscribe();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œåšäº†ä¸€ä¸ªå¼‚æ­¥çš„è®¢é˜…å¤„ç†ï¼Œé€šè¿‡<code>ReactiveRedisTemplate</code>åˆ é™¤redisä¸­(key, id)çš„å…ƒç´ ï¼Œç­‰å¾…è°ƒç”¨ç»“æŸåï¼Œé‡Šæ”¾è¿™ä¸ªä¿¡å·ã€‚è¿™ä¸ªremoveçš„å¤„ç†ä¸èƒ½æ”¾åˆ°luaè„šæœ¬ä¸­æ‰§è¡Œï¼Œå¦åˆ™é€»è¾‘å°±æ˜¯é”™è¯¯çš„ã€‚è¿™ä¹Ÿæ­£æ˜¯<code>RateLimiterAlgorithm</code> SPI è®¾è®¡<code>callback</code>æ–¹æ³•çš„ç”¨æ„ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getkeys"></a>ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getKeys()<a class="hash-link" href="#ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ä½¿ç”¨getkeys" title="Direct link to heading">#</a></h3><p>å¯¹åº”çš„Lua ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local tokens_key = KEYS[1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>çœç•¥è·å–å‚æ•°çš„ä»£ç </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local fill_time = capacity/rate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local ttl = math.floor(fill_time*2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ—¶é—´çª—å£ttl å¤§æ¦‚æ˜¯ 2* å®¹é‡/é€Ÿç‡.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_tokens = tonumber(redis.call(&quot;get&quot;, tokens_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_tokens == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_tokens = capacity</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»æœ‰åºé›†åˆä¸­å–å¾—ä¸Šæ¬¡ä½¿ç”¨çš„token,å¦‚æœæ²¡æœ‰åˆ™last_tokens = å®¹é‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_refreshed = tonumber(redis.call(&quot;get&quot;, timestamp_key))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if last_refreshed == nil then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_refreshed = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»¥timestamp_keyä¸ºkey,ä»æœ‰åºé›†åˆä¸­å–å¾—ä¸Šæ¬¡åˆ·æ–°æ—¶é—´ï¼Œé»˜è®¤ä¸º0.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local delta = math.max(0, now-last_refreshed)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local filled_tokens = math.min(capacity, last_tokens+(delta*rate))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed = filled_tokens &gt;= requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if allowed then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  new_tokens = filled_tokens - requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ—¶é—´é—´éš”*é€Ÿç‡åŒ€é€Ÿäº§ç”Ÿä»¤ç‰Œï¼Œè‹¥ä»¤ç‰Œæ•°é‡&gt;è¯·æ±‚æ•°é‡ï¼Œåˆ™allowed=1, å¹¶ä¸”æ›´æ–°ä»¤ç‰Œæ•°é‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, tokens_key, ttl, new_tokens)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&quot;setex&quot;, timestamp_key, ttl, now)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, new_tokens }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œnowæ˜¯ä¼ å…¥çš„å½“å‰æ—¶é—´(EpochSecond)ï¼Œè®¾ç½®<code>tokens_key</code>æ‰€å¯¹åº”çš„æœ‰åºé›†åˆçš„å€¼ä¸º <code>new_tokens</code>ï¼ˆå³æ–°ä»¤ç‰Œæ•°é‡) ï¼Œ è¿‡æœŸæ—¶é—´ä¸º<code>ttl</code>ã€‚ æ›´æ–°é›†åˆä¸­ï¼Œ<code>timestamp_key</code>çš„å€¼ä¸ºå½“å‰æ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´ä¸º<code>ttl</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨getkeysæ–¹æ³•"></a>æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨<code>getKeys</code>æ–¹æ³•<a class="hash-link" href="#æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ä½¿ç”¨getkeysæ–¹æ³•" title="Direct link to heading">#</a></h3><p>åœ¨<code>SlidingWindowRateLimiterAlgorithm</code> çš„<code>getKeys()</code>åŒæ ·è¦†å†™äº†çˆ¶ç±»ï¼Œä»£ç ä¸<code>ConcurrentRateLimiterAlgorithm</code> æ–¹æ³•ä»£ç ä¸€è‡´ã€‚</p><p>å¦‚ä¸‹ä¸ºæ»‘åŠ¨çª—å£ç®—æ³•çš„Luaä»£ç ï¼Œçœç•¥äº†å…¶ä»–å‚æ•°çš„æ¥æ”¶ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local timestamp_key = KEYS[2]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_size = tonumber(capacity / rate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local window_time = 1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è®¾å®šçª—å£å¤§å°ä¸ºå®¹ç§¯/é€Ÿç‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local last_requested = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local exists_key = redis.call(&#x27;exists&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (exists_key == 1) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_requested = redis.call(&#x27;zcard&#x27;, tokens_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è·å–å½“å‰key çš„åŸºæ•°</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">local remain_request = capacity - last_requested</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local allowed_num = 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (last_requested &lt; capacity) then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowed_num = 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;zadd&#x27;, tokens_key, now, timestamp_key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è®¡ç®—å‰©ä½™å¯ç”¨é‡ = å®¹é‡ å‡å»å·²ä½¿ç”¨é‡ï¼Œè‹¥<code>last_requested</code> &lt; capacity ,åˆ™å…è®¸é€šè¿‡ï¼Œå¹¶ä¸”åœ¨<code>tokens_key</code>ä¸ºkeyçš„æœ‰åºé›†åˆä¸­ï¼Œå¢åŠ ä¸€ä¸ª å…ƒç´ ï¼ˆkey =<code>timestam_key</code>,value= <code>now</code>)</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI lua"><pre tabindex="0" class="prism-code language-lua codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;zremrangebyscore&#x27;, tokens_key, 0, now - window_size / window_time)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">redis.call(&#x27;expire&#x27;, tokens_key, window_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return { allowed_num, remain_request }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‰é¢å·²ç»è®¾å®š<code>window_time</code>=1, ç”¨Redisçš„ <code>zremrangebyscore</code>å‘½ä»¤ï¼Œç§»é™¤æœ‰åºé›†åˆä¸­ï¼Œscoreä¸º[0- å½“å‰æ—¶é—´-çª—å£å¤§å°]çš„å…ƒç´ ï¼Œå³ç§»åŠ¨ä¸€ä¸ªçª—å£å¤§å°ã€‚è®¾å®štokens_keyçš„è¿‡æœŸæ—¶é—´ä¸ºçª—å£å¤§å°ã€‚</p><p>åœ¨<code>AbstractRateLimiterAlgorithm</code>çš„æ¨¡æ¿æ–¹æ³•ä¸­ï¼Œ<code>getKeys(final String id)</code> ç»™å‡ºçš„ç¬¬äºŒä¸ªå€¼(ä»¥<code>secondKey</code>æŒ‡ä»£)ï¼Œæ˜¯æ‹¼æ¥äº†{id} (å³resolve key)çš„ä¸€ä¸ªå›ºå®šå­—ç¬¦ä¸²ã€‚ä»ä¸Šé¢ä¸‰ä¸ªç®—æ³•ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä»¤ç‰Œæ¡¶ç®—æ³•ä¸­ï¼Œ<code>secondKey</code>åœ¨Luaä»£ç æ‰§è¡Œä¸­ä¼šæ›´æ–°ä¸ºæœ€æ–°çš„æ—¶é—´ï¼Œæ‰€ä»¥æ— æ‰€è°“ä¼ å…¥çš„å€¼ã€‚è€Œåœ¨å¹¶å‘é™æµç®—æ³•ä¸­ï¼Œä¼šä»¥æ­¤<code>secondKey</code>ä¸ºæ¡ä»¶ï¼Œåœ¨java <code>callback</code>æ–¹æ³•ä¸­ç§»é™¤å¯¹åº”çš„å…ƒç´ ã€‚è€Œåœ¨æ»‘åŠ¨çª—å£ç®—æ³•ä¸­ï¼Œè¿™ä¸ª<code>secondKey</code>çš„å€¼ï¼Œä¼šä½œä¸ºä¸€ä¸ªæ–°å…ƒç´ çš„key, å¢åŠ åˆ°å½“å‰æœ‰åºé›†åˆä¸­ï¼Œå¹¶åœ¨åšçª—å£æ»‘åŠ¨ä¸­ï¼Œè¿‡æœŸçš„èµ„æ–™ä¼šè¢«åˆ é™¤æ‰ã€‚</p><p>æ€»ä¹‹ï¼Œå½“è®¾è®¡æ–°çš„é™æµç®—æ³•æ—¶ï¼Œè¦æ ¹æ®ç®—æ³•éœ€è¦ä»”ç»†è®¾è®¡<code>getKey()</code>æ–¹æ³•ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¦‚ä½•è°ƒç”¨-ratelimiter-spi"></a>å¦‚ä½•è°ƒç”¨ RateLimiter SPI<a class="hash-link" href="#å¦‚ä½•è°ƒç”¨-ratelimiter-spi" title="Direct link to heading">#</a></h2><p>åœ¨<code>RateLimiter</code> Plugä¸­çš„<code>doExecute()</code>æ–¹æ³•ä¸­ï¼Œä¼ å…¥çš„ä¸‰ä¸ªå‚æ•° exchange ä¸ºè¯·æ±‚çš„è¿æ¥ï¼Œ chain ä¸ºshenyuæ’ä»¶çš„è°ƒç”¨é“¾ï¼Œselector æ˜¯é€‰æ‹©å™¨ï¼Œruleæ˜¯ç³»ç»Ÿä¸­é…ç½®çš„è§„åˆ™å‚æ•°èµ„æ–™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RateLimiterHandle limiterHandle = RatelimiterRuleHandleCache.getInstance()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolverKey = Optional.ofNullable(limiterHandle.getKeyResolverName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(name -&gt; Optional.of(&quot;-&quot; + RateLimiterKeyResolverFactory.newInstance(name).resolve(exchange)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return redisRateLimiter.isAllowed(rule.getId() + resolverKey, limiterHandle)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(response -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!response.isAllowed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object error = ShenyuResultWrap.error(ShenyuResultEnum.TOO_MANY_REQUESTS.getCode(), ShenyuResultEnum.TOO_MANY_REQUESTS.getMsg(), null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return WebFluxResultUtils.result(exchange, error);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>1.é¦–å…ˆï¼Œä»ç¼“å­˜ä¸­ï¼Œå–å¾—ç³»ç»Ÿè®¾å®šçš„é™æµå‚æ•°<code>RateLimiterHandle</code>å®ä¾‹ <code>limiterHandle</code>.
2.æ ¹æ®nameæŒ‡å®šçš„Resolver è·å¾—è¯·æ±‚çš„è¿æ¥Keyä¿¡æ¯ï¼ˆå¦‚åœ°å€ç­‰).
3.è°ƒç”¨ RedisRateLimiterçš„ isAllowedæ–¹æ³•, è·å–è¿”å›å€¼åï¼Œ
4.è‹¥<code>isAllowd</code>=false,åšé”™è¯¯å¤„ç†
5.å¦‚æœ <code>isAllowed</code>=trueï¼Œreturn chain.execute(exchange)ï¼Œ å¯¹è¯¥è¯·æ±‚åšåç»­å¤„ç†ï¼Œä¼ é€’åˆ°è°ƒç”¨é“¾çš„ä¸‹ä¸€å…³ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>æ•´ä¸ª<code>RateLimiter</code> pluginæ¡†æ¶åŸºäºSpring WebFluxå¼€å‘ï¼Œç”¨redis å’Œluaè„šæœ¬åšé™æµè®¡æ•°åŠæ ¸å¿ƒé€»è¾‘å¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘åŠå¼¹æ€§æ‰©å±•ã€‚</p><ol><li><p><code>RateLimiter</code> <code>SPI</code> æä¾›äº†ä¸¤ä¸ª<code>SPI</code> æ¥å£ï¼Œé€šè¿‡åº”ç”¨é¢å‘æ¥å£è®¾è®¡åŠå„ç§è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥æ–¹ä¾¿çš„å¢åŠ æ–°çš„é™æµç®—æ³•ï¼Œä»¥åŠå„ç§æµé‡è§£æè§„åˆ™ã€‚</p></li><li><p>æä¾›äº†ä»¤ç‰Œæ¡¶ã€å¹¶å‘é€Ÿç‡é™æµã€æ»‘åŠ¨çª—å£ã€æ¼æ¡¶4ç§é™æµç®—æ³•ã€‚åœ¨è®¾è®¡ç®—æ³•å®ç°æ—¶ï¼Œéœ€è¦æ ¹æ®ç®—æ³•ç‰¹å¾è®¾è®¡KEYå€¼ï¼Œç”¨Luaè„šæœ¬å®ç°åœ¨redisä¸­è¦å¤„ç†çš„é€»è¾‘ï¼Œè®¾è®¡<code>callback()</code>æ–¹æ³•åšåç»­çš„æ•°æ®å¤„ç†ã€‚</p></li><li><p>å“åº”å¼ç¼–ç¨‹ï¼Œå®ç°è¿‡ç¨‹ç®€æ´é«˜æ•ˆã€‚</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/rate-limiter">rate limiter</a><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about RateLimiter SPI ä»£ç åˆ†æ" href="/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalance SPI ä»£ç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-12-07T02:16:01.576Z">2022å¹´12æœˆ7æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>â€‹        ç½‘å…³åº”ç”¨éœ€è¦æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡çš„æ–¹æ¡ˆï¼ŒåŒ…æ‹¬éšæœºé€‰æ‹©ã€Hashã€è½®è¯¢ç­‰æ–¹å¼ã€‚<code>Apache Shenyu</code>ç½‘å…³ä¸­ä¸ä»…å®ç°äº†ä¼ ç»Ÿç½‘å…³çš„è¿™äº›å‡è¡¡ç­–ç•¥ï¼Œè¿˜é€šè¿‡æµé‡é¢„çƒ­(warmup)ç­‰ç»†èŠ‚å¤„ç†ï¼Œå¯¹æœåŠ¡å™¨èŠ‚ç‚¹çš„åŠ å…¥ï¼Œåšäº†æ›´å¹³æ»‘çš„æµé‡å¤„ç†ï¼Œè·å¾—äº†æ›´å¥½çš„æ•´ä½“ç¨³å®šæ€§ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹Shenyuæ˜¯æ˜¯å¦‚ä½•è®¾è®¡å’Œå®ç°è¿™éƒ¨åˆ†åŠŸèƒ½çš„ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æ.</p></blockquote><p>[TOC]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalance-spi"></a>LoadBalance <code>SPI</code><a class="hash-link" href="#loadbalance-spi" title="Direct link to heading">#</a></h2><p><code>LoadBalance</code> SPI å®šä¹‰åœ¨<strong><em>shenyu-plugin-divide</em></strong>æ¨¡ç»„ä¸­ï¼Œä»¥ä¸‹æ˜¯è¿™ä¸ªæ ¸å¿ƒæ¥å£çš„ä»£ç ï¼Œè¿™ä¸ªæ¥å£å¾ˆå¥½çš„è¯ é‡Šäº†è¿™æ ·ä¸€ä¸ªç†å¿µï¼šè´Ÿè½½å‡è¡¡æ˜¯åœ¨ä¸€ç³»åˆ—æœåŠ¡å™¨èŠ‚ç‚¹ä¸­é€‰å‡ºæœ€åˆé€‚çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯é€‰æ‹©ç­–ç•¥ã€‚åšæµé‡è½¬å‘ã€è·¯ç”±å’Œè´Ÿè½½å‡è¡¡æ˜¯<code>LoadBalance SPI</code>çš„åŸºæœ¬åŠŸèƒ½</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface LoadBalance {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DivideUpstream select(List&lt;DivideUpstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥å£ä¸­ï¼ŒupstreamListæ˜¯å¯é€‰è·¯ç”±çš„ä¸€ç»„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œ<code>DivideUpstream</code>  æ˜¯æœåŠ¡å™¨èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…æ‹¬çš„é‡è¦å…ƒç´ æœ‰ï¼šåè®®ã€upstreamUrl ã€æƒé‡ã€æ—¶é—´æˆ³ï¼Œwarmupç­‰ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DivideUpstream implements Serializable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String upstreamHost;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * this is http protocol.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String upstreamUrl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * false close/ true open.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Builder.Default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean status = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int warmup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-loadbalance-module"></a>Design of LoadBalance module<a class="hash-link" href="#design-of-loadbalance-module" title="Direct link to heading">#</a></h2><p>å›¾1æ˜¯<code>LoadBalance</code>æ¨¡ç»„çš„ç±»å›¾ï¼š</p><p><img alt="loadbalance-class-diagram" src="/zh/assets/images/loadbalance-class-diagram-9bfc1b2f9cb359702481d7f739ae21f7.png"></p><p>ä»ç±»å›¾ä¸Šå¯ä»¥çœ‹å‡º<code>LoadBalance</code>çš„è®¾è®¡æ¦‚è¦ï¼š</p><ol><li><p>æŠ½è±¡ç±»<code>AbstractLoadBalance</code>ç»§æ‰¿è‡ª<code>LoadBalance</code> SPIæ¥å£ï¼Œå¹¶æä¾›é€‰æ‹©çš„æ¨¡æ¿æ–¹æ³•ï¼ŒåŠæƒé‡è®¡ç®—ã€‚</p></li><li><p>ä¸‰ä¸ªå®åšç±»ç»§æ‰¿<code>AbstractLoadBalance</code>ï¼Œ å®ç°å„è‡ªçš„é€»è¾‘å¤„ç†ã€‚</p><ul><li><code>RandomLoadBalance</code> -åŠ æƒéšæœºé€‰æ‹© Weight Random</li><li><code>HashLoadBalance</code>  - ä¸€è‡´æ€§Hash</li><li><code>RoundRobinLoadBalance</code> -åŠ æƒè½®è¯¢ï¼ˆWeight Round Robin per-packet)</li></ul></li><li><p>ç”±Utilç±»<code>LoadBalanceUtil</code> å®ç°å¯¹å¤–çš„é™æ€è°ƒç”¨æ–¹æ³•ã€‚</p><p>å¦å¤–æ ¹æ®<code>Apache Sheny SPI</code>è§„èŒƒï¼Œåœ¨<code>SHENYU_DIERECTORY</code>ä¸­çš„æ·»åŠ profileï¼Œé…ç½®<code>LoadBalance</code>çš„å®ç°ç±»ï¼Œé…ç½®key=classå½¢å¼ï¼Œå·¦è¾¹çš„operatorè¦å’Œ<code>LoadBalanceEnum</code>ä¸­çš„å®šä¹‰ä¸€è‡´ã€‚</p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">random=org.apache.shenyu.plugin.divide.balance.spi.RandomLoadBalance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">roundRobin=org.apache.shenyu.plugin.divide.balance.spi.RoundRobinLoadBalance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hash=org.apache.shenyu.plugin.divide.balance.spi.HashLoadBalance</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>LoadBalanceEnum</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum LoadBalanceEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Hash load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HASH(1, &quot;hash&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Random load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RANDOM(2, &quot;random&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Round robin load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ROUND_ROBIN(3, &quot;roundRobin&quot;, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int code;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final boolean support;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractloadbalance"></a>AbstractLoadBalance<a class="hash-link" href="#abstractloadbalance" title="Direct link to heading">#</a></h2><p>è¿™ä¸ªæŠ½è±¡ç±»å®åšäº†<code>LoadBalance</code>æ¥å£, å®šä¹‰äº†æŠ½è±¡æ–¹æ³•<code>doSelect()</code>ç•™ç»™å®ä½œç±»å¤„ç†ï¼Œåœ¨æ¨¡æ¿æ–¹æ³•<code>select()</code> ä¸­å…ˆè¿›è¡Œæ ¡éªŒï¼Œä¹‹åè°ƒç”¨ç”±å®ä½œç±»å®ç°çš„<code>doSelect()</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do select divide upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract DivideUpstream doSelect(List&lt;DivideUpstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DivideUpstream select(final List&lt;DivideUpstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (upstreamList.size() == 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doSelect(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æƒé‡çš„å¤„ç†æ–¹æ³•<code>getWeight()</code>çš„é€»è¾‘æ˜¯ï¼šå½“æœ‰æ—¶é—´æˆ³ï¼Œå¹¶ä¸”å½“å‰æ—¶é—´ä¸æ—¶é—´æˆ³é—´éš”åœ¨æµé‡é¢„çƒ­warmupæ—¶é—´å†…ï¼Œæƒé‡è®¡ç®—çš„å…¬å¼ä¸ºï¼š
$$ {1-1}
ww = min(1,uptime/(warmup/weight))
$$
ä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œæœ€ç»ˆçš„æƒå€¼ï¼Œä¸è®¾ç½®çš„weigthæˆæ­£æ¯”ï¼Œæ—¶é—´é—´éš”è¶Šæ¥è¿‘warmupæ—¶é—´ï¼Œæƒé‡å°±è¶Šå¤§ã€‚ä¹Ÿå°±æ˜¯è¯´ç­‰å¾…çš„æ—¶é—´è¶Šé•¿ï¼Œè¢«åˆ†æ´¾çš„æƒé‡è¶Šé«˜ã€‚æ²¡æœ‰æ—¶é—´æˆ³æ—¶ç­‰å…¶ä»–æƒ…å†µä¸‹ï¼Œè¿”å›<code>DivideUpstream</code>è®¾ç½®çš„<code>weight</code>å€¼ã€‚</p><p>è€ƒè™‘æµé‡é¢„çƒ­(warmup)çš„æ ¸å¿ƒæ€æƒ³æ˜¯é¿å…åœ¨æ·»åŠ æ–°æœåŠ¡å™¨å’Œå¯åŠ¨æ–°JVMæ—¶ç½‘å…³æ€§èƒ½ä¸ä½³ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‰ä¸ªå®åšç±»çš„å®ç°ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="randomloadbalance"></a>RandomLoadBalance<a class="hash-link" href="#randomloadbalance" title="Direct link to heading">#</a></h2><p>è¿™é‡Œéšæœº<code>LoadBalance</code> å¯ä»¥å¤„ç†ä¸¤ç§æƒ…å†µï¼š</p><ol><li>æ²¡æœ‰æƒé‡ï¼šæ‰€æœ‰æœåŠ¡å™¨éƒ½æ²¡æœ‰è®¾å®šæƒé‡ï¼Œæˆ–è€…æƒé‡éƒ½ä¸€æ ·ï¼Œ ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªã€‚</li><li>æœ‰æƒé‡ï¼šæœåŠ¡å™¨è®¾å®šæœ‰ä¸åŒçš„æƒé‡ï¼Œä¼šæ ¹æ®æƒé‡ï¼Œè¿›è¡Œéšæœºé€‰æ‹©ã€‚</li></ol><p>ä¸‹é¢æ˜¯æœ‰æƒé‡æ—¶çš„éšæœºé€‰æ‹©ä»£ç <code>random()</code>ï¼š éå†æœåŠ¡å™¨åˆ—è¡¨ï¼Œå½“äº§ç”Ÿçš„éšæœºå€¼å°äºæŸä¸ªæœåŠ¡å™¨æƒé‡æ—¶ï¼Œè¿™ä¸ªæœåŠ¡å™¨è¢«é€‰ä¸­ã€‚ è‹¥éå†åæ²¡æœ‰æ»¡è¶³æ¡ä»¶ï¼Œå°±è¿”å›æœåŠ¡å™¨åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªã€‚è¿™é‡Œ<code>getWeight(DivideUpstream upstream)</code> æ–¹æ³•æ˜¯åœ¨<code>AbstractLoadBalance</code> ä¸­å®šä¹‰çš„ï¼ŒæŒ‰å…¬å¼è®¡ç®—æƒé‡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private DivideUpstream random(final int totalWeight, final List&lt;DivideUpstream&gt; upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the weights are not the same and the weights are greater than 0, then random by the total number of weights</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int offset = RANDOM.nextInt(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine which segment the random value falls on</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DivideUpstream divideUpstream : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset -= getWeight(divideUpstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (offset &lt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return divideUpstream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å› æ­¤ï¼Œå½“é‡‡ç”¨<code>RandomLoadBalance</code>æ—¶ï¼Œæ˜¯æŒ‰æƒé‡éšæœºåˆ†æ´¾æœåŠ¡å™¨çš„ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="hashloadbalance"></a>HashLoadBalance<a class="hash-link" href="#hashloadbalance" title="Direct link to heading">#</a></h2><p><code>Apache Shenyu</code>çš„<code>HashLoadBalance</code> ä¸­é‡‡ç”¨äº†ä¸€è‡´æ€§hashç®—æ³•ï¼Œä½¿ç”¨æœ‰åºhashç¯ï¼Œå°†keyä¸æœåŠ¡å™¨èŠ‚ç‚¹çš„hashæ˜ å°„ç¼“å­˜èµ·æ¥ã€‚å¯¹äºè¯·æ±‚çš„ipåœ°å€ï¼Œè®¡ç®—å‡ºå…¶<code>hash</code>å€¼ï¼Œ åœ¨hashç¯ä¸Šé¡ºæ—¶é’ˆæŸ¥æ‰¾è·ç¦»è¿™ä¸ªkeyçš„hashå€¼æœ€è¿‘çš„èŠ‚ç‚¹ï¼Œå°†å…¶ä½œä¸ºè¦è·¯ç”±çš„èŠ‚ç‚¹ã€‚ä¸€è‡´æ€§hashè§£å†³äº†ä¼ ç»Ÿå–ä½™hashç®—æ³•çš„å¯ä¼¸ç¼©æ€§å·®çš„é—®é¢˜ã€‚</p><p><code>HashLoadBalance</code>ä¸­çš„é‡‡ç”¨çš„æ˜¯åŠ å¯†çš„å•å‘MD5æ•£åˆ—å‡½æ•°ï¼Œè¿™ä¸ªhashå‡½æ•°ä¼šhashåäº§ç”Ÿä¸å¯é¢„æœŸä½†ç¡®å®šæ€§çš„()çš„ç»“æœï¼Œè¾“å‡ºä¸º32-bitçš„é•¿æ•´æ•°ã€‚<code>hash</code>ä»£ç å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private static long hash(final String key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // md5 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MessageDigest md5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5 = MessageDigest.getInstance(&quot;MD5&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (NoSuchAlgorithmException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShenyuException(&quot;MD5 not supported&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] keyBytes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyBytes = key.getBytes(StandardCharsets.UTF_8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.update(keyBytes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] digest = md5.digest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // hash code, Truncate to 32-bits</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long hashCode = (long) (digest[3] &amp; 0xFF) &lt;&lt; 24</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[2] &amp; 0xFF) &lt;&lt; 16)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[1] &amp; 0xFF) &lt;&lt; 8)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | (digest[0] &amp; 0xFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return hashCode &amp; 0xffffffffL;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å†çœ‹ä¸€ä¸‹<code>HashLoadBalance</code>çš„é€‰æ‹©å‡½æ•°<code>doSelect()</code>çš„å®ç°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int VIRTUAL_NODE_NUM = 5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DivideUpstream doSelect(final List&lt;DivideUpstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConcurrentSkipListMap&lt;Long, DivideUpstream&gt; treeMap = new ConcurrentSkipListMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DivideUpstream address : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; VIRTUAL_NODE_NUM; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                long addressHash = hash(&quot;SOUL-&quot; + address.getUpstreamUrl() + &quot;-HASH-&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                treeMap.put(addressHash, address);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hash = hash(String.valueOf(ip));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SortedMap&lt;Long, DivideUpstream&gt; lastRing = treeMap.tailMap(hash);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!lastRing.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return lastRing.get(lastRing.firstKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return treeMap.firstEntry().getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œç”Ÿæˆå¸¦è™šæ‹ŸæœåŠ¡å™¨èŠ‚ç‚¹çš„hashç¯ï¼Œ ä¸€ä¸ªå®é™…èŠ‚ç‚¹ä¼šç”Ÿæˆ5ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå› æ­¤æ•´ä¸ªhashç¯çš„å‡åŒ€æ€§å¤§å¤§å¢åŠ ï¼Œé™ä½æ•°æ®å€¾æ–œçš„å‘ç”Ÿã€‚</p><p>ä¸ºäº†å®ç°hashç¯çš„æœ‰åºæ€§åŠé¡ºæ—¶é’ˆæŸ¥æ‰¾åŠŸèƒ½ï¼Œä»£ç ä¸­ä½¿ç”¨Java çš„<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html" target="_blank" rel="noopener noreferrer">ConcurrentSkipListMap</a> æ¥å­˜å‚¨å¸¦è™šæ‹ŸèŠ‚ç‚¹çš„æœåŠ¡å™¨èŠ‚ç‚¹åŠå…¶hashå€¼ï¼Œ å®ƒæ—¢èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåˆèƒ½ä¿è¯æ•°æ®çš„æœ‰åºæ€§ï¼Œæ”¯æŒé«˜å¹¶å‘ã€‚ å¦å¤–ï¼Œ<code>ConcurrentSkipListMap</code>æä¾›äº†ä¸€ä¸ª<code>tailMap(K fromKey)</code>æ–¹æ³•ï¼Œå¯ä»<code>map</code>ä¸­æŸ¥æ‰¾æ¯”<code>fromKey</code>å¤§çš„å€¼çš„é›†åˆï¼Œä½†å¹¶ä¸éœ€è¦éå†æ•´ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œç”Ÿæˆhashç¯ä¹‹åï¼Œå°±æ˜¯è°ƒç”¨<code>ConcurrentSkipListMap</code>çš„<code>tailMap()</code>æ–¹æ³•ï¼Œæ‰¾åˆ°å¤§äºç­‰äºè¯·æ±‚çš„ipçš„hashå€¼çš„å­é›†ï¼Œè¿™ä¸ªå­é›†çš„ç¬¬ä¸€ä¸ªå°±æ˜¯è¦è·¯ç”±çš„æœåŠ¡å™¨èŠ‚ç‚¹ã€‚é‡‡ç”¨äº†åˆé€‚çš„æ•°æ®ç»“æ„ï¼Œè¿™é‡Œçš„ä»£ç çœ‹ä¸Šå»æ˜¯ä¸æ˜¯ç‰¹åˆ«çš„ç®€æ´æµç•…ï¼Ÿ</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="roundrobinloadbalance"></a>RoundRobinLoadBalance<a class="hash-link" href="#roundrobinloadbalance" title="Direct link to heading">#</a></h2><p>Round-robinè½®è¯¢æ–¹æ³•çš„åŸå§‹å®šä¹‰æ˜¯é¡ºåºå¾ªç¯å°†è¯·æ±‚ä¾æ¬¡å¾ªç¯åœ°è¿æ¥åˆ°æ¯ä¸ªæœåŠ¡å™¨ã€‚å½“æŸä¸ªæœåŠ¡å™¨å‘ç”Ÿæ•…éšœï¼ˆä¾‹å¦‚ï¼šä¸€åˆ†é’Ÿè¿æ¥ä¸ä¸Šçš„æœåŠ¡å™¨)ï¼Œä»å€™é€‰é˜Ÿåˆ—ä¸­å–å‡ºï¼Œä¸å‚ä¸ä¸‹ä¸€æ¬¡çš„è½®è¯¢ï¼Œç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚åœ¨ <code>RoundRobinLoadBalance</code>ä¸­å®ç°çš„æ˜¯ç»„å†…åŠ æƒè½®è¯¢ï¼ˆ<code>Weight Round Robin per-packet</code>)æ–¹æ³•ï¼š</p><p>ä¸ºäº†è®¡ç®—å’Œå­˜å‚¨æ¯ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹çš„è½®è¯¢æ¬¡æ•°ï¼Œåœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±»<code>WeigthRoundRobin</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å®ƒçš„ä¸»è¦ä»£ç ï¼ˆå»æ‰äº†æ³¨é‡Šï¼‰ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected static class WeightedRoundRobin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicLong current = new AtomicLong(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setWeight(final int weight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.weight = weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.set(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long increaseCurrent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return current.addAndGet(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void sel(final int total) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.addAndGet(-1 * total);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setLastUpdate(final long lastUpdate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.lastUpdate = lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯·é‡ç‚¹å…³æ³¨è¿™å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li><p><code>setWeight(final int weight)</code> ï¼Œä¸ºå¯¹è±¡è®¾å®šæƒé‡ï¼Œå¹¶å°†currenté‡ç½®ä¸º0.</p></li><li><p><code>increaseCurrent()</code> : å¯¹<code>AtomicLong</code>ç±»å‹çš„å¯¹è±¡<code>current</code>ï¼Œç´¯åŠ å…¶æƒé‡å€¼ã€‚</p></li><li><p><code>sel(final int total)</code>:   <code>current</code>å‡å»ä¼ å…¥çš„ <code>total</code>å€¼ã€‚</p></li></ul><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹å¸¦æƒé‡çš„è½®è¯¢è¿‡ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ã€‚
é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<code>ConcurrentMap</code>ç±»å‹å¯¹è±¡<code>methodWeightMap</code> ä¸¤å±‚å¯¹è±¡æ¥å­˜å‚¨æœåŠ¡å™¨åˆ—è¡¨ä¸å…¶å„ä¸ªæ˜ç»†èŠ‚ç‚¹çš„è½®è¯¢èµ„æ–™ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt; methodWeightMap = new ConcurrentHashMap&lt;&gt;(16);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªmapå¯¹è±¡ç¬¬ä¸€å±‚çš„keyä¸ºå½“å‰æœåŠ¡å™¨åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„<code>upstreamUrl</code>,  ç¬¬äºŒä¸ªå¯¹è±¡<code>ConcurrentMap&lt;String, WeightedRoundRobin&gt;</code>å­˜å‚¨äº†ç»„å†…å„ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹çš„è½®è¯¢æƒ…å†µï¼Œå†…å±‚Mapçš„keyä¸ºç»„å†…æ¯ä¸ªæœåŠ¡å™¨çš„<code>upstreamUrl</code>ã€‚<code>Map</code>å¯¹è±¡ä½¿ç”¨<code>JUC</code>çš„<code>ConcurrentHashMap</code>ï¼Œä¸ä»…å­˜å–é«˜æ•ˆï¼Œè€Œä¸”çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒé«˜å¹¶å‘ã€‚</p><p>å†…å±‚mapçš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„<code>WeighedRoundRobin</code>ä½œä¸ºé™æ€å†…éƒ¨ç±»èƒ½ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œå¹¶å®ç°ç»„å†…çš„åŠ æƒè½®è¯¢é€‰æ‹©åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªç±»çš„<code>doSelect()</code>æ–¹æ³•çš„ä»£ç ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public DivideUpstream doSelect(final List&lt;DivideUpstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String key = upstreamList.get(0).getUpstreamUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (map == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodWeightMap.putIfAbsent(key, new ConcurrentHashMap&lt;&gt;(16));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int totalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long maxCurrent = Long.MIN_VALUE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long now = System.currentTimeMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DivideUpstream selectedInvoker = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WeightedRoundRobin selectedWRR = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (DivideUpstream upstream : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rKey = upstream.getUpstreamUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WeightedRoundRobin weightedRoundRobin = map.get(rKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int weight = getWeight(upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (weightedRoundRobin == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin = new WeightedRoundRobin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.putIfAbsent(rKey, weightedRoundRobin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (weight != weightedRoundRobin.getWeight()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //weight changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long cur = weightedRoundRobin.increaseCurrent();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weightedRoundRobin.setLastUpdate(now);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cur &gt; maxCurrent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            maxCurrent = cur;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedInvoker = upstream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedWRR = weightedRoundRobin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalWeight += weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......  //erase the section which handles the time-out upstreams. </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (selectedInvoker != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWRR.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸¾ä¾‹ï¼Œè‹¥æœåŠ¡å™¨ç»„<code>upstreamUrl</code> åˆ†åˆ«ä¸ºï¼š LIST = [upstream-20, upstream-50, upstream-30]æ—¶ï¼Œç»è¿‡ä¸€è½®æ‰§è¡Œåï¼Œå»ºç«‹çš„<code>methodWeightMap</code> èµ„æ–™å¦‚ä¸‹ï¼š</p><p><img alt="methodWeightMap" src="/zh/assets/images/methodWeightMap-90b4a77aedffd8cd88bc12b9551739ad.png"></p><p>å‡è®¾ä¸Šè¿°çš„LISTä¸­ï¼Œå„ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹çš„æƒé‡æ•°ç»„ä¸º: [20,50,30], ä¸‹å›¾æ˜¯å†…éƒ¨ç±»current å€¼å˜åŒ–å’Œè½®è¯¢é€‰æ‹©è¿‡ç¨‹ï¼š</p><p><img alt="weighted-roundrobin-demo" src="/zh/assets/images/weighted-roundrobin-demo-cec02fd422fb01ef73e882e0966a8cec.png"></p><p>æ¯ä¸€è½®ï¼Œé€‰æ‹©å€¼currentæœ€å¤§çš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼š</p><ul><li>Round1:<ul><li>å¯¹å½“å‰æœåŠ¡å™¨LISTåšéå†ï¼Œå½“æœåŠ¡å™¨èŠ‚ç‚¹çš„weightedRoundRobin ä¸ºnullæ—¶ï¼Œcurrentè¢«ç½®ä¸ºå„è‡ªçš„æƒé‡ï¼› ä¸ä¸ºnullæ—¶ï¼Œç´¯åŠ å„è‡ªçš„æƒé‡ã€‚</li><li>å³ï¼šéå†åcurrent åˆ†åˆ«ä¸º [20, 50,30] ï¼Œ ä¼šé€‰æ‹©Stream-50, Stream-50å¯¹åº”çš„WeightRoundRobiné™æ€ç±»åš sel(-total)å¤„ç†ï¼Œcurrent æ›´æ–°ä¸º[20,-50, 30].</li></ul></li><li>Round 2  éå†åçš„currentæ˜¯[40,0,60],  ä¼šé€‰æ‹©Stream-30ï¼Œ currentåˆ†åˆ«æ›´æ–°ä¸º[40,0,-40].</li><li>Round 3  éå†åçš„currentæ˜¯[60,50,-10],  ä¼šé€‰æ‹©Stream-20ï¼Œcurrentåˆ†åˆ«æ›´æ–°ä¸º[-40,50,-10].</li></ul><p>ä¸­é—´è¿›è¡Œäº†å®¹é”™å¤„ç†ï¼Œ å½“æœåŠ¡å™¨çš„ä¸ªæ•°ä¸mapä¸ªæ•°ä¸ä¸€æ ·ï¼Œå°±å¯¹methodWeightMap åŠ é”åšå¤„ç†ã€‚ ç”¨å…ˆcopy åmodifyçš„æ–¹å¼ï¼Œ æŠŠè¶…æ—¶çš„æœåŠ¡å™¨removeæ‰ï¼Œå³ç§»é™¤æ‰å‘ç”Ÿæ•…éšœçš„æœåŠ¡å™¨ï¼Œå¹¶æ›´æ–°Mapèµ„æ–™ã€‚å¦‚ä¸‹æ˜¯å¼‚å¸¸æ—¶çš„å¤„ç†ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Java"><pre tabindex="0" class="prism-code language-Java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    if (!updateLock.get() &amp;&amp; upstreamList.size() != map.size() &amp;&amp; updateLock.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // copy -&gt; modify -&gt; update reference</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = new ConcurrentHashMap&lt;&gt;(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; recyclePeriod);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodWeightMap.put(key, newMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateLock.set(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (selectedInvoker != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWRR.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalanceutils"></a>LoadBalanceUtils<a class="hash-link" href="#loadbalanceutils" title="Direct link to heading">#</a></h2><p>åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæä¾›äº†è°ƒç”¨<code>LoadBalance</code>çš„é™æ€æ–¹æ³•, å…¶ä¸­<code>ExtensionLoader</code> æ˜¯<code>Apache Shenyu</code>çš„<code>SPI</code>æ‰§è¡Œå…¥å£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLoadBalanceæ¨¡ç»„æ˜¯å¯é…ç½®ã€å¯æ‰©å±•çš„ã€‚è¿™ä¸ªé™æ€æ–¹æ³•ä¸­çš„<code>algorithm</code>å˜é‡æ˜¯<code>LoadBalanceEnum</code>ä¸­å®šä¹‰<code>name</code>æšä¸¾ç±»å‹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Selector divide upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param algorithm    the loadBalance algorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static DivideUpstream selector(final List&lt;DivideUpstream&gt; upstreamList, final String algorithm, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LoadBalance loadBalance = ExtensionLoader.getExtensionLoader(LoadBalance.class).getJoin(algorithm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return loadBalance.select(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="using-of-loadbalance-module"></a>Using of LoadBalance module<a class="hash-link" href="#using-of-loadbalance-module" title="Direct link to heading">#</a></h2><p>ä¸Šé¢è¯´æ˜äº†<code>LoadBalance</code> SPIæ¥å£åŠä¸‰ä¸ªå®ä½œç±»ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹<code>LoadBalance</code>åœ¨<code>Apache Shenyu</code>ä¸­æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚<code>DividePlugin</code>æ˜¯è·¯ç”±é€‰æ‹©æ’ä»¶ï¼Œæ‰€æœ‰çš„Httpè¯·æ±‚éƒ½ç”±è¯¥æ’ä»¶è¿›è¡Œè´Ÿè½½å‡è¡¡å¤„ç†ã€‚å½“è¯·æ±‚å¤´rpcType = http, ä¸”å¼€å¯è¯¥æ’ä»¶æ—¶ï¼Œå®ƒå°†æ ¹æ®è¯·æ±‚å‚æ•°åŒ¹é…è§„åˆ™ï¼Œæœ€ç»ˆäº¤ç”±ä¸‹æ¸¸æ’ä»¶è¿›è¡Œå“åº”å¼ä»£ç†è°ƒç”¨ã€‚</p><p>åœ¨<code>DividePlugin</code>çš„<code>doExecute</code>æ–¹æ³•ä¸­ï¼Œå…ˆå¯¹è¦è½¬å‘çš„è¯·æ±‚çš„Headerå¤§å°ã€contenté•¿åº¦ç­‰åšæ ¡éªŒï¼Œ</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SneakyThrows</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥å£æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>ShenyuPluginChain</code> ç±»å‹ï¼Œä»£è¡¨<code>plugin</code>çš„è°ƒç”¨é“¾ï¼Œå…·ä½“å¯å‚è§<code>Apache Sheyu</code> çš„<code>plugin</code>çš„è°ƒç”¨æœºåˆ¶ã€‚ç¬¬ä¸‰ä¸ª<code>SelectorData</code>ç±»å‹çš„å‚æ•°æ˜¯é€‰æ‹©å™¨ï¼Œ ç¬¬å››ä¸ªæ˜¯<code>RuldData</code>ç±»å‹ï¼Œä»£è¡¨è§„åˆ™ã€‚åˆ†åˆ«è¯·æŸ¥çœ‹å¯¹åº”çš„ä»£ç ã€‚</p><p> ä¸‹é¢ç»™å‡ºäº†<code>doExecute</code>()æ–¹æ³•ä¸­ï¼Œæœ‰å…³<code>LoadBalance</code>è°ƒç”¨çš„ä»£ç ç‰‡æ®µï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   //å–åˆ°è¦è·¯ç”±çš„æœåŠ¡å™¨èŠ‚ç‚¹åˆ—è¡¨ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   List&lt;DivideUpstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å–åˆ°è¯·æ±‚çš„ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ip =   Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è°ƒç”¨Utilæ–¹æ³•ï¼Œæ‰§è¡ŒLoadBalanceå¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DivideUpstream divideUpstream = LoadBalanceUtils.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  è¿™é‡Œ<code>UpstreamCacheManager</code> æ˜¯ç¼“å­˜çš„è¦è·¯ç”±çš„æœåŠ¡å™¨èŠ‚ç‚¹ ï¼Œ <code>ruleHandle.getLoadBalance()</code>å–åˆ°çš„æ˜¯<code>LoadBalanceEnum</code>å®šä¹‰çš„æšä¸¾name, å¦‚<code>random, hash, roundRobin</code>ç­‰.</p><p>  ç»è¿‡å°è£…ï¼Œè°ƒç”¨è´Ÿè½½å‡è¡¡åŠŸèƒ½éå¸¸çš„æ–¹ä¾¿ã€‚  æœªæ¥å¢åŠ æ–°çš„<code>LoadBalance</code>ç±»ï¼Œè¿™äº›è°ƒç”¨çš„<code>Plugin</code>ä»£ç å®Œå…¨ä¸éœ€è¦å˜æ›´ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>ç»è¿‡ä¸Šé¢çš„ä»£ç è§£è¯»ï¼Œä»è®¾è®¡è§’åº¦æ€»ç»“<code>LoadBalance</code> æ¨¡ç»„å…·æœ‰å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š</p><ol><li><p>å¯æ‰©å±•æ€§ï¼šé¢å‘æ¥å£çš„è®¾è®¡ï¼ŒåŠåŸºäºApache Shenyu SPIçš„å®ç°ï¼Œä½¿å¾—ç³»ç»Ÿå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚å¯ä»¥æ–¹ä¾¿çš„æ‰©å±•ä¸ºå…¶ä»–çš„åŠ¨æ€çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¦‚æœ€å°‘è¿æ¥æ–¹å¼(least connection)ã€æœ€å¿«æ¨¡å¼( fastest)ã€‚å¹¶æ”¯æŒé›†ç¾¤å¤„ç†ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚</p></li><li><p>å¯ä¼¸ç¼©æ€§ï¼š é‡‡ç”¨çš„ä¸€è‡´æ€§hash <code>LoadBalance</code>ã€æƒé‡éšæœºå’Œæƒé‡è½®è¯¢ï¼Œéƒ½å¯ä»¥æ— ç¼æ”¯æŒé›†ç¾¤æ‰©å®¹æˆ–ç¼©å®¹ã€‚</p></li><li><p>æµé‡é¢„çƒ­ç­‰æ›´ç»†è‡´çš„è®¾è®¡ï¼Œèƒ½å¸¦æ¥æ•´ä½“ä¸Šæ›´ä¸ºå¹³æ»‘çš„è´Ÿè½½å‡è¡¡ã€‚</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/load-balance">load balance</a><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about LoadBalance SPI ä»£ç åˆ†æ" href="/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/SPI-SourceCode-Analysis-SPI">SPIè®¾è®¡å®ç°æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-09-12T00:00:00.000Z">2022å¹´9æœˆ12æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/zjcscut/" target="_blank" rel="noopener noreferrer">Throwable</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="èƒŒæ™¯"></a>èƒŒæ™¯<a class="hash-link" href="#èƒŒæ™¯" title="Direct link to heading">#</a></h2><p>æœ€è¿‘ç ”è¯»<code>Apache</code>å¼€æºé¡¹ç›®<code>Shenyu</code>ç½‘å…³çš„æºç ï¼Œç½‘å…³çš„å¤šä¸ªæ ¸å¿ƒç»„ä»¶åŠ è½½éƒ½ç”¨åˆ°äº†<code>SPI</code>æ¨¡å—ã€‚æœ¬æ–‡å°±<code>Shenyu</code>ä¸­çš„<code>SPI</code>è®¾è®¡å’Œæºç å®ç°è¿›è¡Œåˆ†æã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä»€ä¹ˆæ˜¯spi"></a>ä»€ä¹ˆæ˜¯SPI<a class="hash-link" href="#ä»€ä¹ˆæ˜¯spi" title="Direct link to heading">#</a></h2><p><code>SPI</code>å°±æ˜¯<code>Service Provider Interface</code>ï¼Œç›´è¯‘&quot;æœåŠ¡æä¾›æ–¹æ¥å£&quot;ï¼Œæ˜¯ä¸€ç§åŠ¨æ€çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå¯ä»¥åŸºäºæ¥å£è¿è¡Œæ—¶åŠ¨æ€åŠ è½½æ¥å£çš„å®ç°ç±»ï¼ˆä¹Ÿå°±æ˜¯æ¥å£ç¼–ç¨‹ + ç­–ç•¥æ¨¡å¼ + é…ç½®æ–‡ä»¶çš„ä¸€ç§å¼€å‘æ¨¡å¼ï¼‰ã€‚æœ€å¸¸è§çš„å°±æ˜¯<code>JDK</code>å†…ç½®çš„æ•°æ®åº“é©±åŠ¨æ¥å£<code>java.sql.Driver</code>ï¼Œä¸åŒçš„å‚å•†å¯ä»¥å¯¹è¯¥æ¥å£å®Œæˆä¸åŒçš„å®ç°ï¼Œä¾‹å¦‚<code>MySQL</code>ï¼ˆ<code>MySQL</code>é©±åŠ¨åŒ…ä¸­çš„<code>com.mysql.jdbc.Driver</code>ï¼‰ã€<code>PostgreSQL</code>ï¼ˆ<code>PostgreSQL</code>é©±åŠ¨åŒ…ä¸­çš„<code>org.postgresql.Driver</code>ï¼‰ç­‰ç­‰ã€‚</p><p><img alt="spi-jdk-api-diagram" src="/zh/assets/images/spi-jdk-api-diagram-667a15fab78f5b565111dd15c2abb352.png"></p><p><code>JDK</code>å†…ç½®çš„<code>SPI</code>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>åœ¨ç±»è·¯å¾„çš„<code>META-INF/services</code>ç›®å½•åˆ›å»ºä¸€ä¸ªä»¥æ¥å£å…¨é™å®šåç§°å‘½åçš„æ–‡ä»¶ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ª<code>properties</code>ï¼‰æ–‡ä»¶ï¼Œä¾‹å¦‚å‘½åä¸º<code>java.sql.Driver</code></li><li>è¯¥æ–‡ä»¶ä¸­å¯ä»¥æŒ‡å®šå…·ä½“çš„å®ç°ç±»ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªå®ç°ç±»çš„å…¨ç±»å‹é™å®šåä¸ºå•ç‹¬ä¸€è¡Œï¼Œä¾‹å¦‚<code>META-INF/services/java.sql.Driver</code>ä¸­ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># META-INF/services/java.sql.Driveræ–‡ä»¶å†…å®¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">com.mysql.jdbc.Driver</span></span><span class="token-line" style="color:#393A34"><span class="token plain">org.postgresql.Driver</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æœ€åé€šè¿‡<code>java.util.ServiceLoader</code>å¯¹è¯¥æ–‡ä»¶è¿›è¡ŒåŠ è½½ï¼Œå®ä¾‹åŒ–æ¥å£çš„å¯¹åº”å®ç°ç±»ï¼ˆè¿™é‡Œéšå«äº†ä¸€ä¸ªçº¦å®šï¼Œ<strong>æ‰€æœ‰å®ç°ç±»å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°</strong>ï¼‰</li></ul><p>åº•å±‚çš„å®ç°æ¶‰åŠåˆ°ç±»åŠ è½½ã€åŒäº²å§”æ‰˜æ¨¡å‹ç­‰å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ã€‚åŸºäºè¿™ç§è®¾è®¡æ€è·¯ï¼Œå¾ˆå¤šä¸»æµæ¡†æ¶äº†è‡ªå®ç°äº†ä¸€å¥—<code>SPI</code>æ‰©å±•ï¼Œä¾‹å¦‚<code>Dubbo</code>çš„<code>SPI</code>æ‰©å±•æ¨¡å—ï¼Œå°±æ˜¯è¯»å–ç±»è·¯å¾„ä¸‹<code>META-INF/services/dubbo</code>ç›®å½•çš„æ–‡ä»¶å†…å®¹è¿›è¡Œç±»åŠ è½½ã€‚<code>Shenyu-SPI</code>æ¨¡å—ä¹Ÿæ˜¯æ²¿ç”¨ç±»ä¼¼çš„è®¾è®¡æ€è·¯ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="shenyu-spiæºç åˆ†æ"></a>shenyu-spiæºç åˆ†æ<a class="hash-link" href="#shenyu-spiæºç åˆ†æ" title="Direct link to heading">#</a></h2><p><code>shenyu-spi</code>æ¨¡å—ååˆ†ç²¾ç‚¼ï¼Œä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">- shenyu-spi[module]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  - org.apache.shenyu.spi[package]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- SpiExtensionFactory</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™äº›ç±»åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li><code>ExtensionFactory</code>ï¼š<code>SPI</code>åŠ è½½å™¨å·¥å‚ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª<code>SPI</code>ï¼Œç”¨äºåŸºäº<code>SPI</code>æœºåˆ¶åŠ è½½<code>ExtensionLoader</code>å®ä¾‹åŒæ—¶åŸºäº<code>ExtensionLoader</code>å®ä¾‹è·å–é»˜è®¤çš„<code>SPI</code>æ ‡è¯†æ¥å£å®ç°</li><li><code>SpiExtensionFactory</code>ï¼šå…¶å®å°±æ˜¯<code>ExtensionFactory</code>çš„ä¸€ä¸ªå®ç°ç±»</li><li><code>SPI</code>ï¼šæ ‡è¯†æ³¨è§£ï¼Œç”¨äºæ ‡è¯†<code>SPI</code>ï¼Œç”¨äºæ¥å£ä¸Š</li><li><code>Join</code>ï¼šæ ‡è¯†æ³¨è§£ï¼Œç”¨äºå®ç°ç±»ä¸Šï¼Œç”¨äºæ ‡è¯†è¯¥ç±»åŠ å…¥<code>SPI</code>ç³»ç»Ÿ</li><li><code>ExtensionLoader</code>ï¼š<code>SPI</code>åŠ è½½å™¨ï¼Œç±»æ¯”<code>java.util.ServiceLoader</code>ï¼Œç”¨äºåŠ è½½<code>SPI</code>ä¸­æ¥å£çš„å®ç°ç±»</li></ul><p>æ¥ä¸‹æ¥ç»†çœ‹æ¯ä¸ªç±»çš„æºç å®ç°ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi"></a>@SPI<a class="hash-link" href="#spi" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.SPI</code>ä½œä¸ºä¸€ä¸ªæ ‡è¯†æ³¨è§£ï¼Œä¸»è¦ç”¨äº<strong>æ¥å£</strong>ä¸Šï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä½¿ç”¨äº†<code>@SPI</code>çš„æ¥å£æ‰èƒ½è¢«<code>shenyu-spi</code>åŠ è½½ã€‚è¿™ä¸ªç±»çš„æ³¨é‡Šä¸­æè¿°åˆ°ï¼šæ‰€æœ‰<code>SPI</code>ç³»ç»Ÿç›¸å…³å‚è€ƒ<code>Apache Dubbo</code>çš„å®ç°ï¼ˆè¿™ä¸€ç‚¹æ¯”è¾ƒåˆæƒ…ç†ï¼Œå…¶å®<code>SPI</code>æ‰©å±•å·²ç»æ˜¯ä¸€ç§æˆç†Ÿçš„æ–¹æ¡ˆï¼Œå®ç°ä¸Šå¤§åŒå°å¼‚ï¼‰ã€‚è¯¥æ³¨è§£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface SPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Value string.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the string</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å”¯ä¸€çš„<code>value()</code>æ–¹æ³•ç”¨äºæŒ‡å®šé»˜è®¤çš„<code>SPI</code>å®ç°ï¼ˆå¯é€‰çš„ï¼‰ï¼Œåæ–‡åœ¨å±•å¼€<code>ExtensionLoader</code>æ—¶å€™ä¼šè¯´æ˜ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="join"></a>@Join<a class="hash-link" href="#join" title="Direct link to heading">#</a></h3><p><code>org.apache.shenyu.spi.Join</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ ‡è¯†æ³¨è§£ï¼Œä¸»è¦ç”¨åœ¨ä½¿ç”¨äº†<code>@SPI</code>æ³¨è§£çš„æ¥å£çš„<strong>å®ç°ç±»</strong>ä¸Šï¼Œç”¨äºæ ‡è¯†è¯¥ç±»åŠ å…¥<code>SPI</code>ç³»ç»Ÿä¸­è€Œåå¯ä»¥è¢«<code>ExtensionLoader</code>åŠ è½½ã€‚è¯¥æ³¨è§£ä¹Ÿåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å”¯ä¸€çš„<code>order()</code>æ–¹æ³•ç”¨äºæŒ‡å®šå…·ä½“çš„é¡ºåºå·ï¼Œå•ä¸ªä½¿ç”¨äº†<code>@SPI</code>çš„æ¥å£å­˜åœ¨å¤šä¸ªä½¿ç”¨äº†<code>@Join</code>çš„å®ç°ç±»çš„æ—¶å€™ï¼Œè¿™ä¸ªé¡ºåºå·å°±ç¡®å®šäº†è¿™äº›å®ç°ç±»å®ä¾‹çš„æ’åºï¼ˆé¡ºåºå·å°çš„æ’åœ¨å‰é¢ï¼‰ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionloader"></a>ExtensionLoader<a class="hash-link" href="#extensionloader" title="Direct link to heading">#</a></h3><p><code>ExtensionLoader</code>å°±æ˜¯&quot;ç±»å‹æ‰©å±•åŠ è½½å™¨&quot;ï¼Œå°±æ˜¯æ•´ä¸ª<code>SPI</code>æ¨¡å—çš„æ ¸å¿ƒã€‚å…ˆçœ‹å…¶æˆå‘˜å±æ€§ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ExtensionLoader&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SLF4Jæ—¥å¿—å¥æŸ„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(ExtensionLoader.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SPIé…ç½®æ–‡ä»¶åŸºäºç±»è·¯å¾„ä¸‹çš„ç›¸å¯¹ç›®å½•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // @SPIæ ‡è¯†æ¥å£ç±»å‹ -&gt; ExtensionLoaderå®ä¾‹çš„ç¼“å­˜ =&gt; æ³¨æ„è¿™ä¸ªæ˜¯ä¸€ä¸ªå…¨å±€çš„é™æ€å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; LOADERS = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰@SPIæ ‡è¯†æ¥å£ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Class&lt;T&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ClassLoader classLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜¯ä¸€ä¸ªHashMapï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»åˆ«å -&gt; å®ç°ç±»ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Holder&lt;Map&lt;String, ClassEntity&gt;&gt; cachedClasses = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»å®ä¾‹çš„å€¼åŒ…è£…å™¨ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»åˆ«å -&gt; å€¼æŒæœ‰å™¨åŒ…è£…çš„å®ç°ç±»å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“å‰ExtensionLoaderç¼“å­˜çš„å·²åŠ è½½çš„å®ç°ç±»å®ä¾‹ï¼Œä½¿ç”¨å€¼æŒæœ‰å™¨åŒ…è£…ï¼Œæ˜ å°„å…³ç³»ï¼šå®ç°ç±»ç±»å‹ -&gt; å®ç°ç±»å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;Class&lt;?&gt;, Object&gt; joinInstances = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜é»˜è®¤åç§°ï¼Œæ¥æºäº@SPIæ³¨è§£çš„value()æ–¹æ³•éç©ºç™½è¿”å›å€¼ï¼Œç”¨äºåŠ è½½é»˜è®¤çš„æ¥å£å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String cachedDefaultName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Holderæ¯”è¾ƒå™¨ï¼ŒæŒ‰ç…§Holderçš„orderé™åºï¼Œä¹Ÿå°±æ˜¯é¡ºåºå·å°çš„æ’åœ¨å‰é¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;Holder&lt;Object&gt;&gt; holderComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ClassEntityæ¯”è¾ƒå™¨ï¼ŒæŒ‰ç…§ClassEntityçš„orderé™åºï¼Œä¹Ÿå°±æ˜¯é¡ºåºå·å°çš„æ’åœ¨å‰é¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Comparator&lt;ClassEntity&gt; classEntityComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æš‚æ—¶çœç•¥å…¶ä»–ä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å€¼æŒæœ‰å™¨ï¼Œç®€å•VOï¼Œç”¨æ¥å­˜å‚¨æ³›å‹å€¼å’Œå€¼åŠ è½½é¡ºåº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class Holder&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œçš„å€¼å¼•ç”¨æ˜¯volatileä¿®é¥°ï¼Œä¾¿äºæŸçº¿ç¨‹æ›´å˜å¦ä¸€çº¿ç¨‹é©¬ä¸Šè¯»åˆ°æœ€æ–°çš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private volatile T value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // çœç•¥setterå’Œgetterä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»å®ä½“ï¼Œä¸»è¦å­˜æ”¾åŠ è½½çš„å®ç°ç±»çš„ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final class ClassEntity {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åç§°ï¼Œè¿™é‡Œæ˜¯æŒ‡SPIå®ç°ç±»çš„åˆ«åï¼Œä¸æ˜¯ç±»å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŠ è½½é¡ºåºå·</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Integer order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // SPIå®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Class&lt;?&gt; clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private ClassEntity(final String name, final Integer order, final Class&lt;?&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.name = name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.order = order;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // çœç•¥setterå’Œgetterä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ†æå®Œæˆå‘˜å±æ€§ï¼Œä¸éš¾å‘ç°ä¸‹é¢å‡ ç‚¹ï¼š</p><ul><li><code>ExtensionLoader</code>ä¼šå­˜åœ¨ä¸€ä¸ªå…¨å±€çš„é™æ€ç¼“å­˜<code>LOADERS</code>ï¼Œç¼“å­˜å·²ç»åˆ›å»ºçš„<code>ExtensionLoader</code>å®ä¾‹ä»¥é˜²æ­¢é‡å¤åˆ›å»ºçš„æ€§èƒ½å¼€é”€</li><li>æ¯ä¸ª<code>@SPI</code>æ ‡è®°çš„æ¥å£å¦‚æœä½¿ç”¨<code>ExtensionLoader</code>è¿›è¡ŒåŠ è½½ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„<code>ExtensionLoader</code>å®ä¾‹</li><li><code>@SPI</code>æ ‡è®°çš„æ¥å£å¦‚æœæœ‰å¤šä¸ªå®ç°ï¼Œé‚£ä¹ˆæœ€ç»ˆè·å–åˆ°è¿™äº›å®ç°å®ä¾‹çš„æ—¶å€™æ˜¯æœ‰åºçš„</li></ul><p>æ¥ç€çœ‹å…¶æ„é€ å‡½æ•°å’Œé™æ€å·¥å‚æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ç§æœ‰æ„é€ å‡½æ•°ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private ExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆå‘˜å˜é‡clazzèµ‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.clazz = clazz;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æˆå‘˜å˜é‡classLoaderèµ‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.classLoader = cl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œå¯¹äºéExtensionFactoryæ¥å£ç±»å‹ä¼šæ‡’åŠ è½½ä¸€ä¸ªç”¨äºåŠ è½½ExtensionFactoryçš„ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Objects.equals(clazz, ExtensionFactory.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getExtensionClassesEntity();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®ä¾‹åŒ–getExtensionLoaderï¼Œé™æ€å·¥å‚æ–¹æ³•ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz, final ClassLoader cl) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‰ç¼€æ ¡éªŒï¼Œæ¥å£ç±»å‹å¿…é¡»éç©ºå¹¶ä¸”å¿…é¡»å­˜åœ¨@SPIæ³¨è§£ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ä¸­æ–­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Objects.requireNonNull(clazz, &quot;extension clazz is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isInterface()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) is not interface!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAnnotationPresent(SPI.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;extension clazz (&quot; + clazz + &quot;) without @&quot; + SPI.class + &quot; Annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»ç¼“å­˜LOADERSä¸­åŠ è½½ExtensionLoaderå®ä¾‹ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå…¸å‹çš„æ‡’åŠ è½½æ¨¡å¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExtensionLoader&lt;T&gt; extensionLoader = (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(extensionLoader)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extensionLoader;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOADERS.putIfAbsent(clazz, new ExtensionLoader&lt;&gt;(clazz, cl));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (ExtensionLoader&lt;T&gt;) LOADERS.get(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®ä¾‹åŒ–getExtensionLoaderï¼Œé™æ€å·¥å‚æ–¹æ³•ï¼Œéœ€è¦å…¥å‚ä¸º@SPIæ ‡è¯†çš„æ¥å£ç±»å‹ï¼Œä½¿ç”¨ExtensionLoaderç±»çš„ç±»åŠ è½½å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getExtensionLoader(clazz, ExtensionLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ExtensionLoader</code>ä½¿ç”¨äº†ç§æœ‰æ„é€ å™¨ï¼Œä½¿ç”¨äº†é™æ€å·¥å‚æ–¹æ³•å’Œæ‡’åŠ è½½æ¨¡å¼ã€‚åˆå§‹åŒ–<code>ExtensionLoader</code>å®Œæˆåå¹¶ä¸ä¼šè§¦å‘ç±»åŠ è½½å·¥ä½œï¼ŒçœŸæ­£çš„æ‰«æå’ŒåŠ è½½è¡Œä¸ºå»¶è¿Ÿåˆ°è°ƒç”¨<code>getJoin</code>ç³»åˆ—æ–¹æ³•æ‰§è¡Œï¼Œè¿™é‡Œæ‰«ç å’ŒåŠ è½½æ‰€æœ‰å®ç°ç±»ä¿¡æ¯çš„æ–¹æ³•è°ƒç”¨é“¾ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½æ‰€æœ‰æ‰©å±•ç±»ä¿¡æ¯ï¼Œè¿™é‡Œé‡‡ç”¨äº†DCLï¼ˆåŒé‡é”æ ¡éªŒï¼‰é˜²æ­¢å¹¶å‘åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; getExtensionClassesEntity() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç¼“å­˜ä¸å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŠ é”åå†æ£€æŸ¥ä¸€æ¬¡ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedClasses) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            classes = cachedClasses.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(classes)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æœ€ç»ˆç¡®è®¤ç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŠ è½½ï¼Œå¹¶ä¸”æ ‡è®°é¡ºåºå·ä¸º0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                classes = loadExtensionClass();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setValue(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cachedClasses.setOrder(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½å½“å‰ExtensionLoaderä¸­clazzçš„æ‰€æœ‰SPIç³»ç»Ÿå†…çš„å®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Map&lt;String, ClassEntity&gt; loadExtensionClass() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SPI annotation = clazz.getAnnotation(SPI.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.nonNull(annotation)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œå°±æ˜¯å‰é¢æåˆ°ï¼Œå¦‚æœ@SPIæ³¨è§£çš„value()æ–¹æ³•éç©ºç™½è¿”å›å€¼ä¼šä½œä¸ºé»˜è®¤å®ç°çš„åˆ«å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä¹Ÿå°±æ˜¯å¦‚æœåªä½¿ç”¨äº†@SPIï¼Œé‚£ä¹ˆå°±æ— æ³•è·å–é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœä½¿ç”¨äº†@SPI(&quot;foo&quot;)ï¼Œå¯ä»¥é€šè¿‡åˆ«åfooå»æ˜ å°„å’Œè·å–é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String value = annotation.value();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            cachedDefaultName = value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆå§‹åŒ–ä¸€ä¸ªHashmapå®¹å™¨ç”¨äºå­˜å‚¨åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œè¿™ä¸ªå˜é‡ä¼šé€ä¼ åˆ°ä¸‹ä¸€ä¸ªæ–¹æ³•é“¾</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, ClassEntity&gt; classes = new HashMap&lt;&gt;(16);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åŠ è½½ç›®å½•ä¸­çš„å±æ€§æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadDirectory(classes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return classes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½ç›®å½•ä¸­çš„å±æ€§æ–‡ä»¶ï¼Œå¹¶ä¸”åŠ è½½æ–‡ä»¶ä¸­çš„å®ç°ç±»ï¼Œç›®æ ‡ç›®å½•ï¼šMETA-INF/shenyu/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadDirectory(final Map&lt;String, ClassEntity&gt; classes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ–‡ä»¶å =&gt; META-INF/shenyu/$className</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = SHENYU_DIRECTORY + clazz.getName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿™é‡Œä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½æ–‡ä»¶èµ„æºï¼Œå¦‚æœä¼ å…¥çš„ç±»åŠ è½½å™¨ä¸ºç©ºä¼šä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Enumeration&lt;URL&gt; urls = Objects.nonNull(this.classLoader) ? classLoader.getResources(fileName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : ClassLoader.getSystemResources(fileName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†è§£æçš„æ–‡ä»¶URLé›†åˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(urls)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (urls.hasMoreElements()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                URL url = urls.nextElement();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // é€šè¿‡æ–‡ä»¶URLåŠ è½½èµ„æº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                loadResources(classes, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.error(&quot;load extension class error {}&quot;, fileName, t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŠ è½½æ–‡ä»¶èµ„æºï¼Œè§£ææ–‡ä»¶å¹¶ä¸”åŠ è½½å®ç°ç±»å­˜å‚¨åˆ°classesä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadResources(final Map&lt;String, ClassEntity&gt; classes, final URL url) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¯»å–URLæ–‡ä»¶èµ„æºï¼ŒåŠ è½½åˆ°Propertiesä¸­ï¼Œæ¯è¡Œæ ¼å¼ä¸ºname=classPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (InputStream inputStream = url.openStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.load(inputStream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.forEach((k, v) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String name = (String) k;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String classPath = (String) v;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(name) &amp;&amp; StringUtils.isNotBlank(classPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // åŸºäºnameå’ŒclassPathè¿›è¡Œç±»åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    loadClass(classes, name, classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (ClassNotFoundException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºnameï¼ˆåˆ«åï¼‰å’ŒclassPathï¼ˆç±»å…¨é™å®šåç§°ï¼‰è¿›è¡Œç±»åŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadClass(final Map&lt;String, ClassEntity&gt; classes,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String name, final String classPath) throws ClassNotFoundException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç±»åˆå§‹åŒ–ï¼Œå¹¶ä¸”ç¡®å®šå®ç°ç±»å¿…é¡»æ˜¯å½“å‰@SPIæ³¨è§£æ ‡è¯†æ¥å£çš„å­ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; subClass = Objects.nonNull(this.classLoader) ? Class.forName(classPath, true, this.classLoader) : Class.forName(classPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!clazz.isAssignableFrom(subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; subtype is not of &quot; + clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å®ç°ç±»å¿…é¡»å­˜åœ¨æ³¨è§£@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!subClass.isAnnotationPresent(Join.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,&quot; + subClass + &quot; without @&quot; + Join.class + &quot; annotation&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨åŒæ ·åˆ«åçš„å®ç°ç±»æ‰è¿›è¡Œç¼“å­˜ï¼Œå·²ç»å­˜åœ¨åˆ™æ ¡éªŒæ—§çš„ç±»å‹å’Œå½“å‰å®ç°ç±»å‹æ˜¯å¦ä¸€è‡´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity oldClassEntity = classes.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(oldClassEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºç±»ä¿¡æ¯å®ä½“ä¿å­˜åˆ«åã€é¡ºåºå·å’Œå®ç°ç±»å¹¶ä¸”ç¼“å­˜ï¼Œæ˜ å°„å…³ç³»ï¼šåˆ«å -&gt; ç±»ä¿¡æ¯å®ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Join joinAnnotation = subClass.getAnnotation(Join.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassEntity classEntity = new ClassEntity(name, joinAnnotation.order(), subClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classes.put(name, classEntity);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (!Objects.equals(oldClassEntity.getClazz(), subClass)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;load extension resources error,Duplicate class &quot; + clazz.getName() + &quot; name &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                + name + &quot; on &quot; + oldClassEntity.getClazz().getName() + &quot; or &quot; + subClass.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡æ–¹æ³•é“¾<code>getExtensionClassesEntity -&gt; loadExtensionClass -&gt; loadDirectory -&gt; loadResources -&gt; loadClass</code>æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªåˆ«å<code>-&gt;</code>å®ç°ç±»ä¿¡æ¯çš„æ˜ å°„ï¼Œç”¨äºåç»­çš„å®ä¾‹åŒ–ï¼Œè§<code>getJoin()</code>æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºåˆ«åè·å–å®ç°ç±»å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public T getJoin(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ«åå¿…é¡»ä¸ºéç©ºç™½å­—ç¬¦ä¸²</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(name)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NullPointerException(&quot;get join name is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œä¹Ÿä½¿ç”¨DCLå»cachedInstancesç¼“å­˜ä¸­å–åˆ«åå¯¹åº”çš„å€¼æŒæœ‰å™¨ï¼Œå€¼æŒæœ‰å™¨ä¸ºç©ºåˆ™åˆ›å»º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;Object&gt; objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(objectHolder)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachedInstances.putIfAbsent(name, new Holder&lt;&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        objectHolder = cachedInstances.get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (cachedInstances) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŠ é”åå†æ¬¡åˆ¤æ–­å€¼æŒæœ‰å™¨ä¸­çš„å€¼æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„æ—¶å€™åˆ™è¿›è¡Œå®ç°ç±»å®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            value = objectHolder.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.isNull(value)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Holder&lt;T&gt; pair = createExtension(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                value = pair.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                int order = pair.getOrder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å®ä¾‹åŒ–å®Œæˆåæ›´æ–°å€¼æŒæœ‰å™¨ç¼“å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setValue(value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                objectHolder.setOrder(order);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (T) value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// åŸºäºåˆ«åæœç´¢å·²ç»åŠ è½½çš„å®ç°ç±»ä¿¡æ¯ï¼Œå¹¶ä¸”å®ä¾‹åŒ–å¯¹åº”çš„å®ç°ç±»è¿›è¡Œå€¼åŒ…è£…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private Holder&lt;T&gt; createExtension(final String name) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åŠ è½½è¯¥@SPIæ ‡è¯†æ¥å£çš„æ‰€æœ‰å®ç°ç±»ä¿¡æ¯å¹¶ä¸”è·å–å¯¹åº”åˆ«åçš„å®ç°ç±»ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassEntity classEntity = getExtensionClassesEntity().get(name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(classEntity)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;name is error&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; aClass = classEntity.getClazz();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¦‚æœå®ç°ç±»å®ä¾‹ç¼“å­˜ä¸­å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥å°è£…ä¸ºå€¼åŒ…è£…å™¨è¿”å›ï¼Œå¦åˆ™è¿›è¡Œå®ä¾‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (Objects.isNull(o)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åå°„å®ä¾‹åŒ–å¹¶ä¸”ç¼“å­˜è¯¥å®ç°ç±»å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            joinInstances.putIfAbsent(aClass, aClass.newInstance());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            o = joinInstances.get(aClass);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InstantiationException | IllegalAccessException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Extension instance(name: &quot; + name + &quot;, class: &quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + aClass + &quot;)  could not be instantiated: &quot; + e.getMessage(), e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Holder&lt;T&gt; objectHolder = new Holder&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setOrder(classEntity.getOrder());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    objectHolder.setValue((T) o);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return objectHolder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»<code>createExtension()</code>æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯ä½¿ç”¨åå°„æ–¹å¼å®ä¾‹åŒ–å®ç°ç±»ï¼Œåå°„æ–¹æ³•<code>newInstance()</code>è¦æ±‚è¯¥ç±»å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°ï¼Œå› ä¸ºè¿™é‡Œæœ‰ä¸€ç‚¹éšå«çš„çº¦å®šï¼š<code>SPI</code>å®ç°ç±»<strong>å¿…é¡»æä¾›æ— å‚æ„é€ å‡½æ•°</strong>ï¼Œå¦åˆ™ä¼šå®ä¾‹åŒ–å¤±è´¥ã€‚å‰©ä½™çš„<code>getDefaultJoin()</code>å’Œ<code>getJoins()</code>æ˜¯åŸºäº<code>getJoin()</code>æ–¹æ³•è¿›è¡Œæ‰©å±•ï¼ŒåŠŸèƒ½å¹¶ä¸å¤æ‚ï¼Œè¿™é‡Œå°±ä¸å±•å¼€åˆ†æäº†ã€‚å¦å¤–ï¼Œåœ¨<code>getJoin()</code>æ–¹æ³•ç”¨åˆ°äº†å¤šçº§ç¼“å­˜ï¼š</p><ul><li><code>cachedInstances</code>ï¼šé€šè¿‡åˆ«åå°±å¯ä»¥æœç´¢åˆ°å¯¹åº”çš„å®ç°ç±»å®ä¾‹</li><li><code>joinInstances</code>ï¼šåˆ«åæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™åŠ è½½æ‰€æœ‰å®ç°ç±»ä¿¡æ¯ï¼Œç„¶åé€šè¿‡åˆ«åå®šä½å®ç°ç±»ç±»å‹ï¼Œå†é€šè¿‡å®ç°ç±»ç±»å‹æŸ¥æ‰¾æˆ–è€…åˆ›å»ºå¹¶ç¼“å­˜å®ç°ç±»å®ä¾‹åæ›´æ–°<code>cachedInstances</code>ç¼“å­˜</li></ul><p>åˆ°æ­¤ï¼Œ<code>ExtensionLoader</code>çš„æºç åˆ†æå®Œæ¯•ã€‚è¿™é‡Œå†é€šè¿‡ä¸€ä¸ª<code>ExtensionLoader</code>å®ä¾‹æˆå‘˜å±æ€§å†…å­˜å¸ƒå±€å›¾å¯ä»¥åŠ æ·±ç†è§£ï¼š</p><p><img alt="spi-attr-memory-debug" src="/zh/assets/images/spi-attr-memory-debug-fbcf742eb342ba1aa47e9395bf8ffc0c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="extensionfactory"></a>ExtensionFactory<a class="hash-link" href="#extensionfactory" title="Direct link to heading">#</a></h3><p><code>ExtensionFactory</code>æ˜¯å·¥å‚æ¨¡å¼é‡Œé¢çš„å·¥å‚æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸€ä¸ªè·å–<code>SPI</code>å®ç°ï¼ˆ<strong>é»˜è®¤å®ç°ï¼Œå”¯ä¸€</strong>ï¼‰å®ä¾‹çš„æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI(&quot;spi&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets Extension.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt;   the type parameter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param key   æ­¤å‚æ•°æš‚æ—¶æ²¡æœ‰ä½¿ç”¨ï¼ŒçŒœæµ‹æ˜¯é¢„ç•™ç”¨äºæ˜ å°„@SPIçš„value()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param clazz @SPIæ ‡è¯†çš„æ¥å£ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the extension</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getExtension(String key, Class&lt;T&gt; clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¥ç€çœ‹å…¶å®ç°ç±»<code>SpiExtensionFactory</code>çš„ä»£ç ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpiExtensionFactory implements ExtensionFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; T getExtension(final String key, final Class&lt;T&gt; clazz) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Optional.ofNullable(clazz)   // å…¥å‚clazzéç©º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Class::isInterface)  // å…¥å‚clazzå¿…é¡»æ˜¯æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(cls -&gt; cls.isAnnotationPresent(SPI.class))  // å…¥å‚clazzå¿…é¡»è¢«@SPIæ ‡è¯†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getExtensionLoader)  // åŸºäºclazzè¿™ä¸ªæ¥å£ç±»å‹å®ä¾‹åŒ–ExtensionLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ExtensionLoader::getDefaultJoin)  // è·å–è¯¥@SPIæ ‡è¯†æ¥å£çš„é»˜è®¤å®ç°ï¼Œä¸å­˜åœ¨åˆ™è¿”å›NULL</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š<code>ExtensionFactory</code>æœ¬èº«ä¹Ÿæ˜¯<code>SPI</code>ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ä½¿ç”¨<code>ExtensionFactory</code>çš„æ—¶å€™å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = new SpiExtensionFactory();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¹Ÿå¯ä»¥åŸºäº<code>ExtensionLoader</code>è¿›è¡ŒåŠ è½½ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># åœ¨ç±»è·¯å¾„META-INF/services/shenyuç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªå±æ€§æ–‡ä»¶org.apache.shenyu.spi.ExtensionFactoryï¼Œå†…å®¹æ˜¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">spi=org.apache.shenyu.spi.SpiExtensionFactory</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># ç„¶ååŸºäºExtensionLoaderè¿›è¡ŒåŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ExtensionFactory extensionFactory = ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getDefaultJoin();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¾—åˆ°<code>ExtensionFactory</code>å®ä¾‹åå°±å¯ä»¥åŸºäº<code>@SPI</code>æ¥å£åŠ è½½å…¶é»˜è®¤å®ç°ç±»çš„å®ä¾‹ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‰©å±•å’Œå»ºè®®"></a>æ‰©å±•å’Œå»ºè®®<a class="hash-link" href="#æ‰©å±•å’Œå»ºè®®" title="Direct link to heading">#</a></h2><p>ä¸‹é¢æ˜¯ä¸ªäººçš„ä¸€äº›è§è§£ã€‚ç›®å‰æ¥çœ‹ï¼Œ<code>Shenyu</code>ä¸­çš„<code>SPI</code>æ¨¡å—åŠŸèƒ½æ˜¯å®Œå¤‡çš„ï¼Œå»ºè®®è€ƒè™‘å¼•å…¥ä¸¤ä¸ªå¸¸ç”¨çš„åŠŸèƒ½ï¼š</p><ul><li>å¯ä»¥åœ¨<code>Join</code>æ³¨è§£ä¸­æ·»åŠ å±æ€§æ ‡è®°<code>SPI</code>æ¥å£å®ç°ç±»ç”Ÿæˆçš„å®ä¾‹æ˜¯å•ä¾‹è¿˜æ˜¯å…¨æ–°å®ä¾‹ï¼Œç±»ä¼¼äº<code>Spring</code>ä¸­çš„<code>Scope</code>å£°æ˜ï¼ˆ<code>singleton</code>æˆ–è€…<code>prototype</code>ï¼‰é‚£æ ·ï¼Œä¾‹å¦‚ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Join {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * It will be sorted according to the current serial number..</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return int.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The join class instance should be singleton or not</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true or false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isSingleton() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>å¯é€‰åœ°</strong>è®©<code>SPI</code>çš„å®ç°ç±»å®ç°ä¸€ä¸ªåˆå§‹åŒ–å™¨æ¥å£ï¼Œåœ¨è¯¥å®ç°ç±»å®ä¾‹åŒ–åå›è°ƒåˆå§‹åŒ–å™¨æ¥å£æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ExtensionInitializer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void init();  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * demo</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface JdbcSPI {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getClassName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MysqlSPI implements JdbcSPI, ExtensionInitializer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // callback when MysqlSPI instance init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getClassName() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;mysql&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦‚æœæ·»åŠ äº†è¿™ä¸¤ç‚¹ï¼Œèƒ½å¤Ÿæ»¡è¶³å¾ˆå¤šç°å®åœºæ™¯çš„éœ€æ±‚ã€‚å¦å¤–ï¼Œ<code>ExtensionLoader</code>ä¸­çš„ä¸¤å¤„æ¯”è¾ƒå™¨æˆå‘˜å˜é‡å¯ä»¥è¿›è¡Œä»£ç ç²¾ç®€ï¼Œä¾‹å¦‚å¯¹<code>classEntityComparator</code>è€Œè¨€ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final Comparator&lt;ClassEntity&gt; classEntityComparator = (o1, o2) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (o1.getOrder() &gt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (o1.getOrder() &lt; o2.getOrder()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¯ä»¥ç²¾ç®€ä¸ºComparatoræä¾›çš„é™æ€å·¥å‚æ–¹æ³•å’Œæ–¹æ³•å¼•ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private final Comparator&lt;ClassEntity&gt; classEntityComparator = Comparator.comparing(ClassEntity::getOrder);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å°ç»“"></a>å°ç»“<a class="hash-link" href="#å°ç»“" title="Direct link to heading">#</a></h2><p>åŸºäº<code>Java</code>åŸç”Ÿ<code>SPI</code>è®¾è®¡æ€è·¯ä¸Šè®¾è®¡å‡ºæ¥çš„<code>SPI</code>æ¡†æ¶å…·å¤‡äº†æ¾è€¦åˆã€é«˜æ˜“ç”¨æ€§å’Œé«˜æ‰©å±•æ€§çš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”æ·»åŠ äº†åŠ è½½å®ä¾‹ç¼“å­˜ã€å¹¶å‘å®‰å…¨ç­‰ç‰¹æ€§ï¼Œå¡«è¡¥äº†åŸç”Ÿ<code>JDK</code>ä¸­<code>SPI</code>çš„ä¸€äº›ç¼ºé™·ï¼Œ<code>Shenyu</code>çš„<code>SPI</code>æ¨¡å—ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ­£æ˜¯ç”±äºæ­¤å¼ºå¤§çš„<code>SPI</code>æ¨¡å—çš„å­˜åœ¨ï¼Œ<code>Shenyu</code>ä¸­çš„å…¶ä»–æ¨¡å—å¦‚<code>Plugin</code>æ¨¡å—å¯ä»¥å®ç°å¿«é€Ÿæ’æ‹”å¼é…ç½®ï¼Œè®©åŠ è½½ä¸€ä¸ªå…¨æ–°å¼€å‘çš„æ’ä»¶å®ä¾‹å˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about SPIè®¾è®¡å®ç°æºç åˆ†æ" href="/zh/blog/SPI-SourceCode-Analysis-SPI"><b>Read More</b></a></div></footer></article></main></div></div></div></div>
<script src="/zh/assets/js/runtime~main.66a00d09.js"></script>
<script src="/zh/assets/js/main.178cbf1d.js"></script>
</body>
</html>