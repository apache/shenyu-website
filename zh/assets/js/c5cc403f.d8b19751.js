"use strict";(self.webpackChunkshenyu_website=self.webpackChunkshenyu_website||[]).push([[97442],{15680:(e,n,a)=>{a.d(n,{xA:()=>p,yg:()=>y});var t=a(96540);function i(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function l(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function r(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?l(Object(a),!0).forEach((function(n){i(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function o(e,n){if(null==e)return{};var a,t,i=function(e,n){if(null==e)return{};var a,t,i={},l=Object.keys(e);for(t=0;t<l.length;t++)a=l[t],n.indexOf(a)>=0||(i[a]=e[a]);return i}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(t=0;t<l.length;t++)a=l[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=t.createContext({}),c=function(e){var n=t.useContext(s),a=n;return e&&(a="function"==typeof e?e(n):r(r({},n),e)),a},p=function(e){var n=c(e.components);return t.createElement(s.Provider,{value:n},e.children)},g="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},d=t.forwardRef((function(e,n){var a=e.components,i=e.mdxType,l=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),g=c(a),d=i,y=g["".concat(s,".").concat(d)]||g[d]||u[d]||l;return a?t.createElement(y,r(r({ref:n},p),{},{components:a})):t.createElement(y,r({ref:n},p))}));function y(e,n){var a=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var l=a.length,r=new Array(l);r[0]=d;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o[g]="string"==typeof e?e:i,r[1]=o;for(var c=2;c<l;c++)r[c]=a[c];return t.createElement.apply(null,r)}return t.createElement.apply(null,a)}d.displayName="MDXCreateElement"},10374:(e,n,a)=>{a.r(n),a.d(n,{contentTitle:()=>r,default:()=>g,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var t=a(58168),i=(a(96540),a(15680));const l={title:"WebSocket\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790",author:"midnight2104",author_title:"Apache ShenYu Committer",author_url:"https://github.com/midnight2104",tags:["websocket","data sync","Apache ShenYu"]},r=void 0,o={permalink:"/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync",editUrl:"https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync.md",source:"@site/i18n/zh/docusaurus-plugin-content-blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync.md",title:"WebSocket\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790",description:"\u5728ShenYu\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002Apache ShenYu \u7f51\u5173\u5f53\u524d\u652f\u6301ZooKeeper\u3001WebSocket\u3001Http\u957f\u8f6e\u8be2\u3001Nacos \u3001etcd \u548c Consul \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8eWebSocket\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002",date:"2025-01-16T02:44:53.378Z",formattedDate:"2025\u5e741\u670816\u65e5",tags:[{label:"websocket",permalink:"/zh/blog/tags/websocket"},{label:"data sync",permalink:"/zh/blog/tags/data-sync"},{label:"Apache ShenYu",permalink:"/zh/blog/tags/apache-shen-yu"}],readingTime:29.18,truncated:!1,prevItem:{title:"Nacos\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790",permalink:"/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync"},nextItem:{title:"\u6269\u5c55\u63d2\u4ef6\u52a0\u8f7d\u903b\u8f91",permalink:"/zh/blog/Loader-SourceCode-Analysis-ExtLoader"}},s=[{value:"1. \u5173\u4e8eWebSocket\u901a\u4fe1",id:"1-\u5173\u4e8ewebsocket\u901a\u4fe1",children:[]},{value:"2. Admin\u6570\u636e\u540c\u6b65",id:"2-admin\u6570\u636e\u540c\u6b65",children:[]},{value:"3. \u7f51\u5173\u6570\u636e\u540c\u6b65",id:"3-\u7f51\u5173\u6570\u636e\u540c\u6b65",children:[]},{value:"4. \u7f51\u5173\u548cadmin\u5efa\u7acbwebsocket\u8fde\u63a5",id:"4-\u7f51\u5173\u548cadmin\u5efa\u7acbwebsocket\u8fde\u63a5",children:[]},{value:"5. \u603b\u7ed3",id:"5-\u603b\u7ed3",children:[]}],c={toc:s},p="wrapper";function g(e){let{components:n,...l}=e;return(0,i.yg)(p,(0,t.A)({},c,l,{components:n,mdxType:"MDXLayout"}),(0,i.yg)("p",null,"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u7f51\u5173\u4e2d\uff0c\u6570\u636e\u540c\u6b65\u662f\u6307\uff0c\u5f53\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u6570\u636e\u53d1\u9001\u4e86\u66f4\u65b0\u540e\uff0c\u5982\u4f55\u5c06\u66f4\u65b0\u7684\u6570\u636e\u540c\u6b65\u5230\u7f51\u5173\u4e2d\u3002",(0,i.yg)("inlineCode",{parentName:"p"},"Apache ShenYu")," \u7f51\u5173\u5f53\u524d\u652f\u6301",(0,i.yg)("inlineCode",{parentName:"p"},"ZooKeeper"),"\u3001",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u3001",(0,i.yg)("inlineCode",{parentName:"p"},"Http\u957f\u8f6e\u8be2"),"\u3001",(0,i.yg)("inlineCode",{parentName:"p"},"Nacos")," \u3001",(0,i.yg)("inlineCode",{parentName:"p"},"etcd")," \u548c ",(0,i.yg)("inlineCode",{parentName:"p"},"Consul")," \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u672c\u6587\u7684\u4e3b\u8981\u5185\u5bb9\u662f\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\u3002"),(0,i.yg)("blockquote",null,(0,i.yg)("p",{parentName:"blockquote"},"\u672c\u6587\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"p"},"shenyu-2.4.0"),"\u7248\u672c\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u5b98\u7f51\u7684\u4ecb\u7ecd\u8bf7\u53c2\u8003 ",(0,i.yg)("a",{parentName:"p",href:"https://shenyu.apache.org/zh/docs/design/data-sync"},"\u6570\u636e\u540c\u6b65\u539f\u7406")," \u3002")),(0,i.yg)("h3",{id:"1-\u5173\u4e8ewebsocket\u901a\u4fe1"},"1. \u5173\u4e8eWebSocket\u901a\u4fe1"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u534f\u8bae\u8bde\u751f\u4e8e",(0,i.yg)("inlineCode",{parentName:"p"},"2008"),"\u5e74\uff0c\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"2011"),"\u5e74\u6210\u4e3a\u56fd\u9645\u6807\u51c6\u3002\u5b83\u53ef\u4ee5\u53cc\u5411\u901a\u4fe1\uff0c\u670d\u52a1\u5668\u53ef\u4ee5\u4e3b\u52a8\u5411\u5ba2\u6237\u7aef\u63a8\u9001\u4fe1\u606f\uff0c\u5ba2\u6237\u7aef\u4e5f\u53ef\u4ee5\u4e3b\u52a8\u5411\u670d\u52a1\u5668\u53d1\u9001\u4fe1\u606f\u3002",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u534f\u8bae\u5efa\u7acb\u5728 ",(0,i.yg)("inlineCode",{parentName:"p"},"TCP")," \u534f\u8bae\u4e4b\u4e0a\uff0c\u5c5e\u4e8e\u5e94\u7528\u5c42\uff0c\u6027\u80fd\u5f00\u9500\u5c0f\uff0c\u901a\u4fe1\u9ad8\u6548\uff0c\u534f\u8bae\u6807\u8bc6\u7b26\u662f",(0,i.yg)("inlineCode",{parentName:"p"},"ws"),"\u3002"),(0,i.yg)("h3",{id:"2-admin\u6570\u636e\u540c\u6b65"},"2. Admin\u6570\u636e\u540c\u6b65"),(0,i.yg)("p",null,"\u6211\u4eec\u4ece\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\u8fdb\u884c\u6e90\u7801\u8ffd\u8e2a\uff0c\u6bd4\u5982\u5728\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\u4e2d\uff0c\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff1a"),(0,i.yg)("p",null,(0,i.yg)("img",{src:a(75377).A})),(0,i.yg)("h4",{id:"21-\u63a5\u6536\u6570\u636e"},"2.1 \u63a5\u6536\u6570\u636e"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"SelectorController.createSelector()")),(0,i.yg)("p",null,"\u8fdb\u5165",(0,i.yg)("inlineCode",{parentName:"p"},"SelectorController"),"\u7c7b\u4e2d\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"createSelector()"),"\u65b9\u6cd5\uff0c\u5b83\u8d1f\u8d23\u6570\u636e\u7684\u6821\u9a8c\uff0c\u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\uff0c\u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'@Validated\n@RequiredArgsConstructor\n@RestController\n@RequestMapping("/selector")\npublic class SelectorController {\n    \n    @PostMapping("")\n    public ShenyuAdminResult createSelector(@Valid @RequestBody final SelectorDTO selectorDTO) { // @Valid \u6570\u6821\u9a8c\n        // \u6dfb\u52a0\u6216\u66f4\u65b0\u6570\u636e\n        Integer createCount = selectorService.createOrUpdate(selectorDTO);\n        // \u8fd4\u56de\u7ed3\u679c\u4fe1\u606f\n        return ShenyuAdminResult.success(ShenyuResultMessage.CREATE_SUCCESS, createCount);\n    }\n    \n    // ......\n}\n')),(0,i.yg)("h4",{id:"22-\u5904\u7406\u6570\u636e"},"2.2 \u5904\u7406\u6570\u636e"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"SelectorServiceImpl.createOrUpdate()")),(0,i.yg)("p",null,"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"SelectorServiceImpl"),"\u7c7b\u4e2d\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"createOrUpdate()"),"\u65b9\u6cd5\u5b8c\u6210\u6570\u636e\u7684\u8f6c\u6362\uff0c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\uff0c\u53d1\u5e03\u4e8b\u4ef6\uff0c\u66f4\u65b0",(0,i.yg)("inlineCode",{parentName:"p"},"upstream"),"\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"@RequiredArgsConstructor\n@Service\npublic class SelectorServiceImpl implements SelectorService {\n    // \u8d1f\u8d23\u4e8b\u4ef6\u53d1\u5e03\u7684eventPublisher\n    private final ApplicationEventPublisher eventPublisher;\n    \n    @Override\n    @Transactional(rollbackFor = Exception.class)\n    public int createOrUpdate(final SelectorDTO selectorDTO) {\n        int selectorCount;\n        // \u6784\u5efa\u6570\u636e DTO --\x3e DO\n        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);\n        List<SelectorConditionDTO> selectorConditionDTOs = selectorDTO.getSelectorConditions();\n        // \u5224\u65ad\u662f\u6dfb\u52a0\u8fd8\u662f\u66f4\u65b0\n        if (StringUtils.isEmpty(selectorDTO.getId())) {\n            // \u63d2\u5165\u9009\u62e9\u5668\u6570\u636e\n            selectorCount = selectorMapper.insertSelective(selectorDO);\n            // \u63d2\u5165\u9009\u62e9\u5668\u4e2d\u7684\u6761\u4ef6\u6570\u636e\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));\n            });\n            // check selector add\n            // \u6743\u9650\u68c0\u67e5\n            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() > 0) {\n                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();\n                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());\n                dataPermissionDTO.setDataId(selectorDO.getId());\n                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);\n                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));\n            }\n\n        } else {\n            // \u66f4\u65b0\u6570\u636e\uff0c\u5148\u5220\u9664\u518d\u65b0\u589e\n            selectorCount = selectorMapper.updateSelective(selectorDO);\n            //delete rule condition then add\n            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));\n            selectorConditionDTOs.forEach(selectorConditionDTO -> {\n                selectorConditionDTO.setSelectorId(selectorDO.getId());\n                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);\n                selectorConditionMapper.insertSelective(selectorConditionDO);\n            });\n        }\n        // \u53d1\u5e03\u4e8b\u4ef6\n        publishEvent(selectorDO, selectorConditionDTOs);\n\n        // \u66f4\u65b0upstream\n        updateDivideUpstream(selectorDO);\n        return selectorCount;\n    }\n    \n    \n    // ......\n    \n}\n\n")),(0,i.yg)("p",null,"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"Service"),"\u7c7b\u5b8c\u6210\u6570\u636e\u7684\u6301\u4e45\u5316\u64cd\u4f5c\uff0c\u5373\u4fdd\u5b58\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u5927\u5bb6\u5e94\u8be5\u5f88\u719f\u6089\u4e86\uff0c\u5c31\u4e0d\u5c55\u5f00\u3002\u5173\u4e8e\u66f4\u65b0",(0,i.yg)("inlineCode",{parentName:"p"},"upstream"),"\u64cd\u4f5c\uff0c\u653e\u5230\u540e\u9762\u5bf9\u5e94\u7684\u7ae0\u8282\u4e2d\u8fdb\u884c\u5206\u6790\uff0c\u91cd\u70b9\u5173\u6ce8\u53d1\u5e03\u4e8b\u4ef6\u7684\u64cd\u4f5c\uff0c\u5b83\u4f1a\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"publishEvent()"),"\u65b9\u6cd5\u7684\u903b\u8f91\u662f\uff1a\u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\uff0c\u6784\u5efa\u6761\u4ef6\u6570\u636e\uff0c\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"       private void publishEvent(final SelectorDO selectorDO, final List<SelectorConditionDTO> selectorConditionDTOs) {\n        // \u627e\u5230\u9009\u62e9\u5668\u5bf9\u5e94\u7684\u63d2\u4ef6\n        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());\n        // \u6784\u5efa\u6761\u4ef6\u6570\u636e\n        List<ConditionData> conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());\n        // \u53d1\u5e03\u53d8\u66f4\u6570\u636e\n        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,\n                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));\n    }\n")),(0,i.yg)("p",null,"\u53d1\u5e03\u53d8\u66f4\u6570\u636e\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"eventPublisher.publishEvent()"),"\u5b8c\u6210\uff0c\u8fd9\u4e2a",(0,i.yg)("inlineCode",{parentName:"p"},"eventPublisher"),"\u5bf9\u8c61\u662f\u4e00\u4e2a",(0,i.yg)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),"\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u7684\u5168\u9650\u5b9a\u540d\u662f",(0,i.yg)("inlineCode",{parentName:"p"},"org.springframework.context.ApplicationEventPublisher"),"\u3002\u770b\u5230\u8fd9\u513f\uff0c\u6211\u4eec\u77e5\u9053\u4e86\u53d1\u5e03\u6570\u636e\u662f\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"Spring"),"\u76f8\u5173\u7684\u529f\u80fd\u6765\u5b8c\u6210\u7684\u3002"),(0,i.yg)("blockquote",null,(0,i.yg)("p",{parentName:"blockquote"},"\u5173\u4e8e",(0,i.yg)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),"\uff1a"),(0,i.yg)("p",{parentName:"blockquote"},"\u5f53\u6709\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u53d1\u5e03\u8005\u8c03\u7528 ",(0,i.yg)("inlineCode",{parentName:"p"},"ApplicationEventPublisher")," \u7684 ",(0,i.yg)("inlineCode",{parentName:"p"},"publishEvent")," \u65b9\u6cd5\u53d1\u5e03\u4e00\u4e2a\u4e8b\u4ef6\uff0c",(0,i.yg)("inlineCode",{parentName:"p"},"Spring"),"\u5bb9\u5668\u5e7f\u64ad\u4e8b\u4ef6\u7ed9\u6240\u6709\u89c2\u5bdf\u8005\uff0c\u8c03\u7528\u89c2\u5bdf\u8005\u7684 ",(0,i.yg)("inlineCode",{parentName:"p"},"onApplicationEvent")," \u65b9\u6cd5\u628a\u4e8b\u4ef6\u5bf9\u8c61\u4f20\u9012\u7ed9\u89c2\u5bdf\u8005\u3002\u8c03\u7528 ",(0,i.yg)("inlineCode",{parentName:"p"},"publishEvent"),"\u65b9\u6cd5\u6709\u4e24\u79cd\u9014\u5f84\uff0c\u4e00\u79cd\u662f\u5b9e\u73b0\u63a5\u53e3\u7531\u5bb9\u5668\u6ce8\u5165 ",(0,i.yg)("inlineCode",{parentName:"p"},"ApplicationEventPublisher")," \u5bf9\u8c61\u7136\u540e\u8c03\u7528\u5176\u65b9\u6cd5\uff0c\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u7684\u65b9\u6cd5\uff0c\u4e24\u79cd\u65b9\u6cd5\u53d1\u5e03\u4e8b\u4ef6\u6ca1\u6709\u592a\u5927\u533a\u522b\u3002"),(0,i.yg)("ul",{parentName:"blockquote"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"ApplicationEventPublisher"),"\uff1a\u53d1\u5e03\u4e8b\u4ef6\uff1b"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"ApplicationEvent"),"\uff1a",(0,i.yg)("inlineCode",{parentName:"li"},"Spring")," \u4e8b\u4ef6\uff0c\u8bb0\u5f55\u4e8b\u4ef6\u6e90\u3001\u65f6\u95f4\u548c\u6570\u636e\uff1b"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"ApplicationListener"),"\uff1a\u4e8b\u4ef6\u76d1\u542c\u8005\uff0c\u89c2\u5bdf\u8005\u3002"))),(0,i.yg)("p",null,"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"Spring"),"\u7684\u4e8b\u4ef6\u53d1\u5e03\u673a\u5236\u4e2d\uff0c\u6709\u4e09\u4e2a\u5bf9\u8c61\uff0c"),(0,i.yg)("p",null,"\u4e00\u4e2a\u662f\u53d1\u5e03\u4e8b\u4ef6\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"ApplicationEventPublisher"),"\uff0c\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u901a\u8fc7\u6784\u9020\u5668\u6ce8\u5165\u4e86\u4e00\u4e2a",(0,i.yg)("inlineCode",{parentName:"p"},"eventPublisher"),"\u3002"),(0,i.yg)("p",null,"\u53e6\u4e00\u4e2a\u5bf9\u8c61\u662f",(0,i.yg)("inlineCode",{parentName:"p"},"ApplicationEvent"),"\uff0c\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"DataChangedEvent"),"\u7ee7\u627f\u4e86\u5b83\uff0c\u8868\u793a\u4e8b\u4ef6\u5bf9\u8c61\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"public class DataChangedEvent extends ApplicationEvent {\n//......\n}\n")),(0,i.yg)("p",null,"\u6700\u540e\u4e00\u4e2a\u662f ",(0,i.yg)("inlineCode",{parentName:"p"},"ApplicationListener"),"\uff0c\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"DataChangedEventDispatcher"),"\u7c7b\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\uff0c\u4f5c\u4e3a\u4e8b\u4ef6\u7684\u76d1\u542c\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u4e8b\u4ef6\u5bf9\u8c61\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n    //......\n    \n}\n")),(0,i.yg)("h4",{id:"23-\u5206\u53d1\u6570\u636e"},"2.3 \u5206\u53d1\u6570\u636e"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"DataChangedEventDispatcher.onApplicationEvent()")),(0,i.yg)("p",null,"\u5f53\u4e8b\u4ef6\u53d1\u5e03\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u8fdb\u5165\u5230",(0,i.yg)("inlineCode",{parentName:"p"},"DataChangedEventDispatcher"),"\u7c7b\u4e2d\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"onApplicationEvent()"),"\u65b9\u6cd5\uff0c\u8fdb\u884c\u4e8b\u4ef6\u5904\u7406\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'@Component\npublic class DataChangedEventDispatcher implements ApplicationListener<DataChangedEvent>, InitializingBean {\n\n  /**\n     * \u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\n     * @param event\n     */\n    @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\n        for (DataChangedListener listener : listeners) {\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\n            switch (event.getGroupKey()) {\n                case APP_AUTH: // \u8ba4\u8bc1\u4fe1\u606f\n                    listener.onAppAuthChanged((List<AppAuthData>) event.getSource(), event.getEventType());\n                    break;\n                case PLUGIN:  // \u63d2\u4ef6\u4fe1\u606f\n                    listener.onPluginChanged((List<PluginData>) event.getSource(), event.getEventType());\n                    break;\n                case RULE:    // \u89c4\u5219\u4fe1\u606f\n                    listener.onRuleChanged((List<RuleData>) event.getSource(), event.getEventType());\n                    break;\n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());\n                    break;\n                case META_DATA:  // \u5143\u6570\u636e\n                    listener.onMetaDataChanged((List<MetaData>) event.getSource(), event.getEventType());\n                    break;\n                default:  // \u5176\u4ed6\u7c7b\u578b\uff0c\u629b\u51fa\u5f02\u5e38\n                    throw new IllegalStateException("Unexpected value: " + event.getGroupKey());\n            }\n        }\n    }\n    \n}\n')),(0,i.yg)("p",null,"\u5f53\u6709\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u8c03\u7528",(0,i.yg)("inlineCode",{parentName:"p"},"onApplicationEvent"),"\u65b9\u6cd5\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff0c\u5224\u65ad\u662f\u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u4ea4\u7ed9\u76f8\u5e94\u7684\u6570\u636e\u76d1\u542c\u5668\u8fdb\u884c\u5904\u7406\u3002"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u5c06\u6240\u6709\u6570\u636e\u8fdb\u884c\u4e86\u5206\u7ec4\uff0c\u4e00\u5171\u662f\u4e94\u79cd\uff1a\u8ba4\u8bc1\u4fe1\u606f\u3001\u63d2\u4ef6\u4fe1\u606f\u3001\u89c4\u5219\u4fe1\u606f\u3001\u9009\u62e9\u5668\u4fe1\u606f\u548c\u5143\u6570\u636e\u3002"),(0,i.yg)("p",null,"\u8fd9\u91cc\u7684\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\uff08",(0,i.yg)("inlineCode",{parentName:"p"},"DataChangedListener"),"\uff09\uff0c\u5c31\u662f\u6570\u636e\u540c\u6b65\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u5b83\u7684\u5177\u4f53\u5b9e\u73b0\u6709\uff1a"),(0,i.yg)("p",null,(0,i.yg)("img",{src:a(34830).A})),(0,i.yg)("p",null,"\u8fd9\u51e0\u4e2a\u5b9e\u73b0\u7c7b\u5c31\u662f\u5f53\u524d",(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u652f\u6301\u7684\u540c\u6b65\u7b56\u7565\uff1a"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"WebsocketDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"li"},"websocket"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"ZookeeperDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"li"},"zookeeper"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"ConsulDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"li"},"consul"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"EtcdDataDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"li"},"etcd"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"HttpLongPollingDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"li"},"http\u957f\u8f6e\u8be2"),"\u7684\u6570\u636e\u540c\u6b65\uff1b"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"NacosDataChangedListener"),"\uff1a\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"li"},"nacos"),"\u7684\u6570\u636e\u540c\u6b65\uff1b")),(0,i.yg)("p",null,"\u65e2\u7136\u6709\u8fd9\u4e48\u591a\u79cd\u5b9e\u73b0\u7b56\u7565\uff0c\u90a3\u4e48\u5982\u4f55\u786e\u5b9a\u4f7f\u7528\u54ea\u4e00\u79cd\u5462\uff1f"),(0,i.yg)("p",null,"\u56e0\u4e3a\u672c\u6587\u662f\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u7684\u6570\u636e\u540c\u6b65\u6e90\u7801\u5206\u6790\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ee5",(0,i.yg)("inlineCode",{parentName:"p"},"WebsocketDataChangedListener"),"\u4e3a\u4f8b\uff0c\u5206\u6790\u5b83\u662f\u5982\u4f55\u88ab\u52a0\u8f7d\u5e76\u5b9e\u73b0\u7684\u3002"),(0,i.yg)("p",null,"\u901a\u8fc7\u5728\u6e90\u7801\u5de5\u7a0b\u4e2d\u8fdb\u884c\u5168\u5c40\u641c\u7d22\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u7684\u5b9e\u73b0\u662f\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"DataSyncConfiguration"),"\u7c7b\u5b8c\u6210\u7684\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'/**\n * \u6570\u636e\u540c\u6b65\u914d\u7f6e\u7c7b\n * \u901a\u8fc7springboot\u6761\u4ef6\u88c5\u914d\u5b9e\u73b0\n * The type Data sync configuration.\n */\n@Configuration\npublic class DataSyncConfiguration {\n    \n /**\n     * websocket\u6570\u636e\u540c\u6b65\uff08\u9ed8\u8ba4\u7b56\u7565\uff09\n     * The WebsocketListener(default strategy).\n     */\n    @Configuration\n    @ConditionalOnProperty(name = "shenyu.sync.websocket.enabled", havingValue = "true", matchIfMissing = true)\n    @EnableConfigurationProperties(WebsocketSyncProperties.class)\n    static class WebsocketListener {\n\n        /**\n         * Config event listener data changed listener.\n         * \u914d\u7f6ewebsocket\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668\n         * @return the data changed listener\n         */\n        @Bean\n        @ConditionalOnMissingBean(WebsocketDataChangedListener.class)\n        public DataChangedListener websocketDataChangedListener() {\n            return new WebsocketDataChangedListener();\n        }\n\n        /**\n         * Websocket collector.\n         * Websocket\u5904\u7406\u7c7b\uff1a\u5efa\u7acb\u8fde\u63a5\uff0c\u53d1\u9001\u6d88\u606f\uff0c\u5173\u95ed\u8fde\u63a5\u7b49\u64cd\u4f5c\n         * @return the websocket collector\n         */\n        @Bean\n        @ConditionalOnMissingBean(WebsocketCollector.class)\n        public WebsocketCollector websocketCollector() {\n            return new WebsocketCollector();\n        }\n\n        /**\n         * Server endpoint exporter \n         *\n         * @return the server endpoint exporter\n         */\n        @Bean\n        @ConditionalOnMissingBean(ServerEndpointExporter.class)\n        public ServerEndpointExporter serverEndpointExporter() {\n            return new ServerEndpointExporter();\n        }\n    }\n    \n    //......\n}\n\n')),(0,i.yg)("p",null,"\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u662f\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"SpringBoot"),"\u6761\u4ef6\u88c5\u914d\u7c7b\u5b9e\u73b0\u7684\u3002\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"WebsocketListener"),"\u7c7b\u4e0a\u9762\u6709\u51e0\u4e2a\u6ce8\u89e3\uff1a"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("inlineCode",{parentName:"p"},"@Configuration"),"\uff1a\u914d\u7f6e\u6587\u4ef6\uff0c\u5e94\u7528\u4e0a\u4e0b\u6587\uff1b")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("inlineCode",{parentName:"p"},'@ConditionalOnProperty(name = "shenyu.sync.websocket.enabled", havingValue = "true", matchIfMissing = true)'),"\uff1a\u5c5e\u6027\u6761\u4ef6\u5224\u65ad\uff0c\u6ee1\u8db3\u6761\u4ef6\uff0c\u8be5\u914d\u7f6e\u7c7b\u624d\u4f1a\u751f\u6548\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u6211\u4eec\u6709\u5982\u4e0b\u914d\u7f6e\u65f6\uff0c\u5c31\u4f1a\u91c7\u7528",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002\u4e0d\u8fc7\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e0b",(0,i.yg)("inlineCode",{parentName:"p"},"matchIfMissing = true"),"\u8fd9\u4e2a\u5c5e\u6027\uff0c\u5b83\u8868\u793a\uff0c\u5982\u679c\u4f60\u6ca1\u6709\u5982\u4e0b\u7684\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u7c7b\u4e5f\u4f1a\u751f\u6548\u3002\u57fa\u4e8e",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u7684\u6570\u636e\u540c\u6b65\u65f6\u5b98\u65b9\u63a8\u8350\u7684\u65b9\u5f0f\uff0c\u4e5f\u662f\u9ed8\u8ba4\u91c7\u7528\u7684\u65b9\u5f0f\u3002"),(0,i.yg)("pre",{parentName:"li"},(0,i.yg)("code",{parentName:"pre",className:"language-properties"},"shenyu:  \n  sync:\n    websocket:\n      enabled: true\n"))),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("inlineCode",{parentName:"p"},"@EnableConfigurationProperties"),"\uff1a\u542f\u7528\u914d\u7f6e\u5c5e\u6027\uff1b"))),(0,i.yg)("p",null,"\u5f53\u6211\u4eec\u4e3b\u52a8\u914d\u7f6e\uff0c\u91c7\u7528",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u8fdb\u884c\u6570\u636e\u540c\u6b65\u65f6\uff0c",(0,i.yg)("inlineCode",{parentName:"p"},"WebsocketDataChangedListener"),"\u5c31\u4f1a\u751f\u6210\u3002\u6240\u4ee5\u5728\u4e8b\u4ef6\u5904\u7406\u65b9\u6cd5",(0,i.yg)("inlineCode",{parentName:"p"},"onApplicationEvent()"),"\u4e2d\uff0c\u5c31\u4f1a\u5230\u76f8\u5e94\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"listener"),"\u4e2d\u3002\u5728\u6211\u4eec\u7684\u6848\u4f8b\u4e2d\uff0c\u662f\u65b0\u589e\u52a0\u4e86\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u6570\u636e\u901a\u8fc7\u91c7\u7528\u7684\u662f",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\uff0c\u6240\u4ee5\uff0c\u4ee3\u7801\u4f1a\u8fdb\u5165\u5230",(0,i.yg)("inlineCode",{parentName:"p"},"WebsocketDataChangedListener"),"\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'    @Override\n    @SuppressWarnings("unchecked")\n    public void onApplicationEvent(final DataChangedEvent event) {\n        // \u904d\u5386\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668(\u4e00\u822c\u4f7f\u7528\u4e00\u79cd\u6570\u636e\u540c\u6b65\u7684\u65b9\u5f0f\u5c31\u597d\u4e86)\n        for (DataChangedListener listener : listeners) {\n            // \u54ea\u79cd\u6570\u636e\u53d1\u751f\u53d8\u66f4\n            switch (event.getGroupKey()) {\n                    \n                // \u7701\u7565\u4e86\u5176\u4ed6\u903b\u8f91\n                    \n                case SELECTOR:   // \u9009\u62e9\u5668\u4fe1\u606f\n                    listener.onSelectorChanged((List<SelectorData>) event.getSource(), event.getEventType());   // WebsocketDataChangedListener\u8fdb\u884c\u9009\u62e9\u5668\u6570\u636e\u53d8\u66f4\u5904\u7406\n                    break;\n         }\n    }\n')),(0,i.yg)("h4",{id:"24-websocket\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668"},"2.4 Websocket\u6570\u636e\u53d8\u66f4\u76d1\u542c\u5668"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},"WebsocketDataChangedListener.onSelectorChanged()"),(0,i.yg)("p",{parentName:"li"},"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"onSelectorChanged()"),"\u65b9\u6cd5\u4e2d\uff0c\u5c06\u6570\u636e\u8fdb\u884c\u4e86\u5c01\u88c5\uff0c\u8f6c\u6210",(0,i.yg)("inlineCode",{parentName:"p"},"WebsocketData"),"\uff0c\u7136\u540e\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"WebsocketCollector.send()"),"\u53d1\u9001\u6570\u636e\u3002"))),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"    // \u9009\u62e9\u5668\u6570\u636e\u6709\u66f4\u65b0\n    @Override\n    public void onSelectorChanged(final List<SelectorData> selectorDataList, final DataEventTypeEnum eventType) {\n        // \u6784\u9020 WebsocketData \u6570\u636e\n        WebsocketData<SelectorData> websocketData =\n                new WebsocketData<>(ConfigGroupEnum.SELECTOR.name(), eventType.name(), selectorDataList);\n        // \u901a\u8fc7websocket\u53d1\u9001\u6570\u636e\n        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);\n    }\n")),(0,i.yg)("h4",{id:"25-websocket\u53d1\u9001\u6570\u636e"},"2.5 Websocket\u53d1\u9001\u6570\u636e"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"WebsocketCollector.send()")),(0,i.yg)("p",null,"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"send()"),"\u65b9\u6cd5\u4e2d\uff0c\u5224\u65ad\u4e86\u4e00\u4e0b\u540c\u6b65\u7684\u7c7b\u578b\uff0c\u6839\u636e\u4e0d\u540c\u7684\u7c7b\u578b\uff0c\u8fdb\u884c\u5904\u7406\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'@Slf4j\n@ServerEndpoint(value = "/websocket", configurator = WebsocketConfigurator.class)\npublic class WebsocketCollector {\n    \n/**\n     * Send.\n     *\n     * @param message the message\n     * @param type    the type\n     */\n    public static void send(final String message, final DataEventTypeEnum type) {\n        if (StringUtils.isNotBlank(message)) {\n            // \u5982\u679c\u662fMYSELF\uff08\u7b2c\u4e00\u6b21\u7684\u5168\u91cf\u540c\u6b65\uff09\n            if (DataEventTypeEnum.MYSELF == type) {\n                // \u4ecethreadlocal\u4e2d\u83b7\u53d6session\n                Session session = (Session) ThreadLocalUtil.get(SESSION_KEY);\n                if (session != null) {\n                    // \u5411\u8be5session\u53d1\u9001\u5168\u91cf\u6570\u636e\n                    sendMessageBySession(session, message);\n                }\n            } else {\n                // \u540e\u7eed\u7684\u589e\u91cf\u540c\u6b65\n                // \u5411\u6240\u6709\u7684session\u4e2d\u540c\u6b65\u53d8\u66f4\u6570\u636e\n                SESSION_SET.forEach(session -> sendMessageBySession(session, message));\n            }\n        }\n    }\n\n    private static void sendMessageBySession(final Session session, final String message) {\n        try {\n            // \u901a\u8fc7websocket\u7684session\u628a\u6d88\u606f\u53d1\u9001\u51fa\u53bb\n            session.getBasicRemote().sendText(message);\n        } catch (IOException e) {\n            log.error("websocket send result is exception: ", e);\n        }\n    }\n}\n')),(0,i.yg)("p",null,"\u6211\u4eec\u7ed9\u7684\u6848\u4f8b\u662f\u4e00\u4e2a\u65b0\u589e\u64cd\u4f5c \uff0c\u662f\u4e00\u4e2a\u589e\u91cf\u540c\u6b65\uff0c\u6240\u4ee5\u4f1a\u8d70"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"SESSION_SET.forEach(session -> sendMessageBySession(session, message));")),(0,i.yg)("p",null,"\u8fd9\u4e2a\u903b\u8f91\u3002"),(0,i.yg)("p",null,"\u518d\u901a\u8fc7"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"session.getBasicRemote().sendText(message);")),(0,i.yg)("p",null,"\u5c06\u6570\u636e\u53d1\u9001\u4e86\u51fa\u53bb\u3002"),(0,i.yg)("p",null,"\u81f3\u6b64\uff0c\u5f53",(0,i.yg)("inlineCode",{parentName:"p"},"admin"),"\u7aef\u53d1\u751f\u6570\u636e\u53d8\u66f4\u65f6\uff0c\u5c31\u5c06\u53d8\u66f4\u7684\u6570\u636e\u4ee5\u589e\u91cf\u5f62\u5f0f\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u53d1\u7ed9\u4e86\u7f51\u5173\u3002"),(0,i.yg)("p",null,"\u5206\u6790\u5230\u8fd9\u91cc\uff0c\u4e0d\u77e5\u9053\u5927\u5bb6\u6709\u6ca1\u6709\u7591\u95ee\u5462\uff1f\u6bd4\u5982",(0,i.yg)("inlineCode",{parentName:"p"},"session"),"\u662f\u600e\u4e48\u6765\u7684\uff1f\u7f51\u5173\u5982\u4f55\u548c",(0,i.yg)("inlineCode",{parentName:"p"},"admin"),"\u5efa\u7acb\u8fde\u63a5\u7684\uff1f"),(0,i.yg)("p",null,"\u4e0d\u8981\u7740\u6025\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u5c31\u8fdb\u884c\u7f51\u5173\u7aef\u7684\u540c\u6b65\u5206\u6790\u3002"),(0,i.yg)("p",null,"\u4e0d\u8fc7\uff0c\u5728\u7ee7\u7eed\u6e90\u7801\u5206\u6790\u524d\uff0c\u6211\u4eec\u7528\u4e00\u5f20\u56fe\u5c06\u4e0a\u9762\u7684\u5206\u6790\u8fc7\u7a0b\u4e32\u8054\u8d77\u6765\u3002"),(0,i.yg)("p",null,(0,i.yg)("img",{src:a(10674).A})),(0,i.yg)("h3",{id:"3-\u7f51\u5173\u6570\u636e\u540c\u6b65"},"3. \u7f51\u5173\u6570\u636e\u540c\u6b65"),(0,i.yg)("p",null,"\u5047\u8bbe",(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u7f51\u5173\u5df2\u7ecf\u5728\u6b63\u5e38\u8fd0\u884c\u4e86\uff0c\u4f7f\u7528\u7684\u6570\u636e\u540c\u6b65\u65b9\u5f0f\u4e5f\u662f",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u3002\u90a3\u4e48\u5f53\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"admin"),"\u7aef\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\u540e\uff0c\u5e76\u4e14\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u53d1\u9001\u5230\u7f51\u5173\uff0c\u90a3\u7f51\u5173\u662f\u5982\u4f55\u63a5\u6536\u5e76\u5904\u7406\u6570\u636e\u7684\u5462\uff1f\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7ee7\u7eed\u8fdb\u884c\u6e90\u7801\u5206\u6790\uff0c\u4e00\u63a2\u7a76\u7adf\u3002"),(0,i.yg)("h4",{id:"31-websocketclient\u63a5\u6536\u6570\u636e"},"3.1 WebsocketClient\u63a5\u6536\u6570\u636e"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"ShenyuWebsocketClient.onMessage()")),(0,i.yg)("p",null,"\u5728\u7f51\u5173\u7aef\u6709\u4e00\u4e2a",(0,i.yg)("inlineCode",{parentName:"p"},"ShenyuWebsocketClient"),"\u7c7b\uff0c\u5b83\u7ee7\u627f\u4e86",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocketClient"),"\uff0c\u53ef\u4ee5\u548c",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u5efa\u7acb\u8fde\u63a5\u5e76\u901a\u4fe1\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"public final class ShenyuWebsocketClient extends WebSocketClient {\n  // ......\n}\n")),(0,i.yg)("p",null,"\u5f53\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"admin"),"\u7aef\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u53d1\u9001\u6570\u636e\u540e\uff0c",(0,i.yg)("inlineCode",{parentName:"p"},"ShenyuWebsocketClient"),"\u5c31\u53ef\u4ee5\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"onMessage()"),"\u63a5\u6536\u5230\u6570\u636e\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u81ea\u5df1\u8fdb\u884c\u5904\u7406\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"public final class ShenyuWebsocketClient extends WebSocketClient {\n      // \u63a5\u53d7\u5230\u6d88\u606f\u540e\u6267\u884c\n    @Override\n    public void onMessage(final String result) {\n        // \u5904\u7406\u63a5\u6536\u5230\u7684\u6570\u636e\n        handleResult(result);\n    }\n    \n    private void handleResult(final String result) {\n        // \u6570\u636e\u53cd\u5e8f\u5217\u5316\n        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);\n        // \u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219...\n        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());\n        // \u54ea\u79cd\u64cd\u4f5c\u7c7b\u578b\uff0c\u66f4\u65b0\u3001\u5220\u9664...\n        String eventType = websocketData.getEventType();\n        String json = GsonUtils.getInstance().toJson(websocketData.getData());\n\n        // \u5904\u7406\u6570\u636e\n        websocketDataHandler.executor(groupEnum, json, eventType);\n    }\n}\n")),(0,i.yg)("p",null,"\u63a5\u6536\u5230\u6570\u636e\u540e\uff0c\u9996\u5148\u8fdb\u884c\u4e86\u53cd\u5e8f\u5217\u5316\u64cd\u4f5c\uff0c\u8bfb\u53d6\u6570\u636e\u7c7b\u578b\u548c\u64cd\u4f5c\u7c7b\u578b\uff0c\u7d27\u63a5\u7740\uff0c\u5c31\u4ea4\u7ed9",(0,i.yg)("inlineCode",{parentName:"p"},"websocketDataHandler.executor()"),"\u8fdb\u884c\u5904\u7406\u3002"),(0,i.yg)("h4",{id:"32-\u6267\u884cwebsocket\u4e8b\u4ef6\u5904\u7406\u5668"},"3.2 \u6267\u884cWebsocket\u4e8b\u4ef6\u5904\u7406\u5668"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"WebsocketDataHandler.executor()")),(0,i.yg)("p",null,"\u901a\u8fc7\u5de5\u5382\u6a21\u5f0f\u521b\u5efa\u4e86",(0,i.yg)("inlineCode",{parentName:"p"},"Websocket"),"\u6570\u636e\u5904\u7406\u5668\uff0c\u6bcf\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u90fd\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5904\u7406\u5668\uff1a"),(0,i.yg)("blockquote",null,(0,i.yg)("p",{parentName:"blockquote"},"\u63d2\u4ef6 --\x3e \u63d2\u4ef6\u6570\u636e\u5904\u7406\u5668;"),(0,i.yg)("p",{parentName:"blockquote"},"\u9009\u62e9\u5668 --\x3e \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\uff1b"),(0,i.yg)("p",{parentName:"blockquote"},"\u89c4\u5219 --\x3e \u89c4\u5219\u6570\u636e\u5904\u7406\u5668\uff1b"),(0,i.yg)("p",{parentName:"blockquote"},"\u8ba4\u8bc1\u4fe1\u606f --\x3e \u8ba4\u8bc1\u6570\u636e\u5904\u7406\u5668\uff1b"),(0,i.yg)("p",{parentName:"blockquote"},"\u5143\u6570\u636e --\x3e \u5143\u6570\u636e\u5904\u7406\u5668\u3002")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"\n/**\n * \u901a\u8fc7\u5de5\u5382\u6a21\u5f0f\u521b\u5efa Websocket\u6570\u636e\u5904\u7406\u5668\n * The type Websocket cache handler.\n */\npublic class WebsocketDataHandler {\n\n    private static final EnumMap<ConfigGroupEnum, DataHandler> ENUM_MAP = new EnumMap<>(ConfigGroupEnum.class);\n\n    /**\n     * Instantiates a new Websocket data handler.\n     * \u6bcf\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u63d0\u4f9b\u4e00\u4e2a\u5904\u7406\u5668\n     * @param pluginDataSubscriber the plugin data subscriber\n     * @param metaDataSubscribers  the meta data subscribers\n     * @param authDataSubscribers  the auth data subscribers\n     */\n    public WebsocketDataHandler(final PluginDataSubscriber pluginDataSubscriber,\n                                final List<MetaDataSubscriber> metaDataSubscribers,\n                                final List<AuthDataSubscriber> authDataSubscribers) {\n        // \u63d2\u4ef6 --\x3e \u63d2\u4ef6\u6570\u636e\u5904\u7406\u5668\n        ENUM_MAP.put(ConfigGroupEnum.PLUGIN, new PluginDataHandler(pluginDataSubscriber));\n        // \u9009\u62e9\u5668 --\x3e \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\n        ENUM_MAP.put(ConfigGroupEnum.SELECTOR, new SelectorDataHandler(pluginDataSubscriber));\n        // \u89c4\u5219 --\x3e \u89c4\u5219\u6570\u636e\u5904\u7406\u5668\n        ENUM_MAP.put(ConfigGroupEnum.RULE, new RuleDataHandler(pluginDataSubscriber));\n        // \u8ba4\u8bc1\u4fe1\u606f --\x3e \u8ba4\u8bc1\u6570\u636e\u5904\u7406\u5668\n        ENUM_MAP.put(ConfigGroupEnum.APP_AUTH, new AuthDataHandler(authDataSubscribers));\n        // \u5143\u6570\u636e --\x3e \u5143\u6570\u636e\u5904\u7406\u5668\n        ENUM_MAP.put(ConfigGroupEnum.META_DATA, new MetaDataHandler(metaDataSubscribers));\n    }\n\n    /**\n     * Executor.\n     *\n     * @param type      the type\n     * @param json      the json\n     * @param eventType the event type\n     */\n    public void executor(final ConfigGroupEnum type, final String json, final String eventType) {\n        // \u6839\u636e\u6570\u636e\u7c7b\u578b\uff0c\u627e\u5230\u5bf9\u5e94\u7684\u6570\u636e\u5904\u7406\u5668\n        ENUM_MAP.get(type).handle(json, eventType);\n    }\n}\n\n")),(0,i.yg)("p",null,"\u4e0d\u540c\u7684\u6570\u636e\u7c7b\u578b\uff0c\u6709\u4e0d\u540c\u7684\u6570\u636e\u5904\u7406\u65b9\u5f0f\uff0c\u6240\u4ee5\u6709\u4e0d\u540c\u7684\u5b9e\u73b0\u7c7b\u3002\u4f46\u662f\u5b83\u4eec\u4e4b\u95f4\u4e5f\u6709\u76f8\u540c\u7684\u5904\u7406\u903b\u8f91\uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7\u6a21\u677f\u65b9\u6cd5\u8bbe\u8ba1\u6a21\u5f0f\u6765\u5b9e\u73b0\u3002\u76f8\u540c\u7684\u903b\u8f91\u653e\u5728\u62bd\u8c61\u7c7b\u4e2d\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"handle()"),"\u65b9\u6cd5\u4e2d\uff0c\u4e0d\u540c\u903b\u8f91\u5c31\u4ea4\u7ed9\u5404\u81ea\u7684\u5b9e\u73b0\u7c7b\u3002"),(0,i.yg)("p",null,(0,i.yg)("img",{src:a(48851).A})),(0,i.yg)("p",null,"\u6211\u4eec\u7684\u6848\u4f8b\u662f\u65b0\u589e\u4e86\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u6240\u4ee5\u4f1a\u4ea4\u7ed9",(0,i.yg)("inlineCode",{parentName:"p"},"SelectorDataHandler"),"\uff08 \u9009\u62e9\u5668 --\x3e \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\uff09\u8fdb\u884c\u6570\u636e\u5904\u7406\u3002"),(0,i.yg)("h4",{id:"33-\u5224\u65ad\u4e8b\u4ef6\u7c7b\u578b"},"3.3 \u5224\u65ad\u4e8b\u4ef6\u7c7b\u578b"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"AbstractDataHandler.handle()")),(0,i.yg)("p",null,"\u5b9e\u73b0\u6570\u636e\u53d8\u66f4\u7684\u901a\u7528\u903b\u8f91\u5904\u7406\uff1a\u6839\u636e\u4e0d\u540c\u7684\u64cd\u4f5c\u7c7b\u578b\u8c03\u7528\u4e0d\u540c\u65b9\u6cd5\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"\npublic abstract class AbstractDataHandler<T> implements DataHandler {\n\n    /**\n     * Convert list.\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\n     * @param json the json\n     * @return the list\n     */\n    protected abstract List<T> convert(String json);\n\n    /**\n     * Do refresh.\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\n     * @param dataList the data list\n     */\n    protected abstract void doRefresh(List<T> dataList);\n\n    /**\n     * Do update.\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\n     * @param dataList the data list\n     */\n    protected abstract void doUpdate(List<T> dataList);\n\n    /**\n     * Do delete.\n     * \u4e0d\u540c\u7684\u903b\u8f91\u7531\u5404\u81ea\u5b9e\u73b0\u7c7b\u53bb\u5b9e\u73b0\n     * @param dataList the data list\n     */\n    protected abstract void doDelete(List<T> dataList);\n\n    // \u901a\u7528\u903b\u8f91\uff0c\u62bd\u8c61\u7c7b\u5b9e\u73b0\n    @Override\n    public void handle(final String json, final String eventType) {\n        List<T> dataList = convert(json);\n        if (CollectionUtils.isNotEmpty(dataList)) {\n            DataEventTypeEnum eventTypeEnum = DataEventTypeEnum.acquireByName(eventType);\n            switch (eventTypeEnum) {\n                case REFRESH:\n                case MYSELF:\n                    doRefresh(dataList);  //\u5237\u65b0\u6570\u636e\uff0c\u5168\u91cf\u540c\u6b65\n                    break;\n                case UPDATE:\n                case CREATE:\n                    doUpdate(dataList); // \u66f4\u65b0\u6216\u521b\u5efa\u6570\u636e\uff0c\u589e\u91cf\u540c\u6b65\n                    break;\n                case DELETE:\n                    doDelete(dataList);  // \u5220\u9664\u6570\u636e\n                    break;\n                default:\n                    break;\n            }\n        }\n    }\n}\n")),(0,i.yg)("p",null,"\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u662f\u65b0\u589e\u64cd\u4f5c\uff0c\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"switch-case"),"\u8fdb\u5165\u5230",(0,i.yg)("inlineCode",{parentName:"p"},"doUpdate()"),"\u65b9\u6cd5\u4e2d\u3002"),(0,i.yg)("h4",{id:"34-\u8fdb\u5165\u5177\u4f53\u7684\u6570\u636e\u5904\u7406\u5668"},"3.4 \u8fdb\u5165\u5177\u4f53\u7684\u6570\u636e\u5904\u7406\u5668"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"SelectorDataHandler.doUpdate()")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"\n/**\n * \u9009\u62e9\u5668\u6570\u636e\u5904\u7406\u5668\n * The type Selector data handler.\n */\n@RequiredArgsConstructor\npublic class SelectorDataHandler extends AbstractDataHandler<SelectorData> {\n\n    private final PluginDataSubscriber pluginDataSubscriber;\n\n    //......\n\n    // \u66f4\u65b0\u64cd\u4f5c\n    @Override\n    protected void doUpdate(final List<SelectorData> dataList) {\n        dataList.forEach(pluginDataSubscriber::onSelectorSubscribe);\n    }\n}\n")),(0,i.yg)("p",null,"\u904d\u5386\u6570\u636e\uff0c\u8fdb\u5165",(0,i.yg)("inlineCode",{parentName:"p"},"onSelectorSubscribe()"),"\u65b9\u6cd5\u3002"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"PluginDataSubscriber.onSelectorSubscribe()")),(0,i.yg)("p",null,"\u5b83\u6ca1\u6709\u5176\u4ed6\u903b\u8f91\uff0c\u76f4\u63a5\u8c03\u7528",(0,i.yg)("inlineCode",{parentName:"p"},"subscribeDataHandler()"),"\u65b9\u6cd5\u3002\u5728\u65b9\u6cd5\u4e2d\uff0c\u66f4\u5177\u6570\u636e\u7c7b\u578b\uff08\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u6216\u89c4\u5219\uff09\uff0c\u64cd\u4f5c\u7c7b\u578b\uff08\u66f4\u65b0\u6216\u5220\u9664\uff09\uff0c\u53bb\u6267\u884c\u4e0d\u540c\u903b\u8f91\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"/**\n * \u901a\u7528\u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u8005\uff0c\u8d1f\u8d23\u5904\u7406\u6240\u6709\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u548c\u89c4\u5219\u4fe1\u606f\n * The type Common plugin data subscriber.\n */\npublic class CommonPluginDataSubscriber implements PluginDataSubscriber {\n    //......\n     // \u5904\u7406\u9009\u62e9\u5668\u6570\u636e\n    @Override\n    public void onSelectorSubscribe(final SelectorData selectorData) {\n        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);\n    }    \n    \n    // \u8ba2\u9605\u6570\u636e\u5904\u7406\u5668\uff0c\u5904\u7406\u6570\u636e\u7684\u66f4\u65b0\u6216\u5220\u9664\n    private <T> void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {\n        Optional.ofNullable(classData).ifPresent(data -> {\n            // \u63d2\u4ef6\u6570\u636e\n            if (data instanceof PluginData) {\n                PluginData pluginData = (PluginData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cachePluginData(pluginData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.handlerPlugin(pluginData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removePluginData(pluginData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -> handler.removePlugin(pluginData));\n                }\n            } else if (data instanceof SelectorData) {  // \u9009\u62e9\u5668\u6570\u636e\n                SelectorData selectorData = (SelectorData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cacheSelectData(selectorData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406 \n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n                } else if (dataType == DataEventTypeEnum.DELETE) {  // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removeSelectData(selectorData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.removeSelector(selectorData));\n                }\n            } else if (data instanceof RuleData) {  // \u89c4\u5219\u6570\u636e\n                RuleData ruleData = (RuleData) data;\n                if (dataType == DataEventTypeEnum.UPDATE) { // \u66f4\u65b0\u64cd\u4f5c\n                    // \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\n                    BaseDataCache.getInstance().cacheRuleData(ruleData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.handlerRule(ruleData));\n                } else if (dataType == DataEventTypeEnum.DELETE) { // \u5220\u9664\u64cd\u4f5c\n                    // \u4ece\u7f51\u5173\u5185\u5b58\u79fb\u9664\u6570\u636e\n                    BaseDataCache.getInstance().removeRuleData(ruleData);\n                    // \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\n                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -> handler.removeRule(ruleData));\n                }\n            }\n        });\n    }\n    \n}\n")),(0,i.yg)("p",null,"\u90a3\u4e48\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u4f1a\u8fdb\u5165\u4e0b\u9762\u7684\u903b\u8f91\uff1a"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"// \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u5185\u5b58\nBaseDataCache.getInstance().cacheSelectData(selectorData);\n// \u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406                  \nOptional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -> handler.handlerSelector(selectorData));\n")),(0,i.yg)("p",null,"\u4e00\u662f\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u7f51\u5173\u7684\u5185\u5b58\u4e2d\u3002",(0,i.yg)("inlineCode",{parentName:"p"},"BaseDataCache"),"\u662f\u6700\u7ec8\u7f13\u5b58\u6570\u636e\u7684\u7c7b\uff0c\u901a\u8fc7\u5355\u4f8b\u6a21\u5f0f\u5b9e\u73b0\u3002\u9009\u62e9\u5668\u6570\u636e\u5c31\u5b58\u5230\u4e86",(0,i.yg)("inlineCode",{parentName:"p"},"SELECTOR_MAP"),"\u8fd9\u4e2a",(0,i.yg)("inlineCode",{parentName:"p"},"Map"),"\u4e2d\u3002\u5728\u540e\u7eed\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u4e5f\u662f\u4ece\u8fd9\u91cc\u62ff\u6570\u636e\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"public final class BaseDataCache {\n    // \u79c1\u6709\u53d8\u91cf\n    private static final BaseDataCache INSTANCE = new BaseDataCache();\n    // \u79c1\u6709\u6784\u9020\u5668\n    private BaseDataCache() {\n    }\n    \n    /**\n     * Gets instance.\n     *  \u516c\u5f00\u65b9\u6cd5\n     * @return the instance\n     */\n    public static BaseDataCache getInstance() {\n        return INSTANCE;\n    }\n    \n    /**\n    *  \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\u7684Map\n     * pluginName -> SelectorData.\n     */\n    private static final ConcurrentMap<String, List<SelectorData>> SELECTOR_MAP = Maps.newConcurrentMap();\n    \n    public void cacheSelectData(final SelectorData selectorData) {\n        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);\n    }\n        \n   /**\n     * cache selector data.\n     * \u7f13\u5b58\u9009\u62e9\u5668\u6570\u636e\n     * @param data the selector data\n     */\n    private void selectorAccept(final SelectorData data) {\n        String key = data.getPluginName();\n        if (SELECTOR_MAP.containsKey(key)) { // \u66f4\u65b0\u64cd\u4f5c\uff0c\u5148\u5220\u9664\u518d\u63d2\u5165\n            List<SelectorData> existList = SELECTOR_MAP.get(key);\n            final List<SelectorData> resultList = existList.stream().filter(r -> !r.getId().equals(data.getId())).collect(Collectors.toList());\n            resultList.add(data);\n            final List<SelectorData> collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());\n            SELECTOR_MAP.put(key, collect);\n        } else {  // \u65b0\u589e\u64cd\u4f5c\uff0c\u76f4\u63a5\u653e\u5230Map\u4e2d\n            SELECTOR_MAP.put(key, Lists.newArrayList(data));\n        }\n    }\n    \n}\n")),(0,i.yg)("p",null,"\u4e8c\u662f\u5982\u679c\u6bcf\u4e2a\u63d2\u4ef6\u8fd8\u6709\u81ea\u5df1\u7684\u5904\u7406\u903b\u8f91\uff0c\u90a3\u4e48\u5c31\u53bb\u5904\u7406\u3002  \u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"idea"),"\u7f16\u8f91\u5668\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u540e\uff0c\u6709\u5982\u4e0b\u7684\u63d2\u4ef6\u8fd8\u6709\u5904\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u4e0d\u518d\u5c55\u5f00\u4e86\u3002"),(0,i.yg)("p",null,(0,i.yg)("img",{src:a(98610).A})),(0,i.yg)("p",null,"\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u6e90\u7801\u8ffd\u8e2a\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u7684\u6848\u4f8b\uff0c\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"admin"),"\u7aef\u65b0\u589e\u4e00\u6761\u9009\u62e9\u5668\u6570\u636e\uff0c\u5c31\u5c06",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5206\u6790\u6e05\u695a\u4e86\u3002"),(0,i.yg)("p",null,"\u6211\u4eec\u8fd8\u662f\u7528\u4e0b\u9762\u7684\u4e00\u5f20\u56fe\u5c06\u7f51\u5173\u7aef\u7684\u6570\u636e\u540c\u6b65\u6d41\u7a0b\u4e32\u8054\u4e00\u4e0b\uff1a"),(0,i.yg)("p",null,(0,i.yg)("img",{src:a(33085).A})),(0,i.yg)("p",null,"\u6570\u636e\u540c\u6b65\u7684\u6d41\u7a0b\u5df2\u7ecf\u5206\u6790\u5b8c\u4e86\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e9b\u95ee\u9898\u6ca1\u6709\u5206\u6790\u5230\uff0c\u5c31\u662f\u7f51\u5173\u662f\u5982\u4f55\u8ddf",(0,i.yg)("inlineCode",{parentName:"p"},"admin"),"\u5efa\u7acb\u8fde\u63a5\u7684\uff1f"),(0,i.yg)("h3",{id:"4-\u7f51\u5173\u548cadmin\u5efa\u7acbwebsocket\u8fde\u63a5"},"4. \u7f51\u5173\u548cadmin\u5efa\u7acbwebsocket\u8fde\u63a5"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"websocket\u914d\u7f6e")),(0,i.yg)("p",null,"\u5728\u7f51\u5173\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6709\u5982\u4e0b\u914d\u7f6e\uff0c\u5e76\u4e14\u5f15\u5165\u4e86\u76f8\u5173\u4f9d\u8d56\uff0c\u5c31\u4f1a\u542f\u52a8",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u76f8\u5173\u670d\u52a1\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"shenyu:\n    file:\n      enabled: true\n    cross:\n      enabled: true\n    dubbo :\n      parameter: multi\n    sync:\n      websocket :  # \u4f7f\u7528websocket\u8fdb\u884c\u6570\u636e\u540c\u6b65\n        urls: ws://localhost:9095/websocket   # admin\u7aef\u7684websocket\u5730\u5740\n        allowOrigin: ws://localhost:9195\n")),(0,i.yg)("p",null,"\u5728\u7f51\u5173\u4e2d\u5f15\u5165",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u7684\u4f9d\u8d56\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-xml"},"\x3c!--shenyu data sync start use websocket--\x3e\n<dependency>\n    <groupId>org.apache.shenyu</groupId>\n    <artifactId>shenyu-spring-boot-starter-sync-data-websocket</artifactId>\n    <version>${project.version}</version>\n</dependency>\n")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Websocket\u6570\u636e\u540c\u6b65\u914d\u7f6e")),(0,i.yg)("p",null,"\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"springboot"),"\u7684\u6761\u4ef6\u88c5\u914d\uff0c\u521b\u5efa\u76f8\u5173\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"bean"),"\u3002\u5728\u7f51\u5173\u542f\u52a8\u7684\u65f6\u5019\uff0c\u5982\u679c\u6211\u4eec\u914d\u7f6e\u4e86",(0,i.yg)("inlineCode",{parentName:"p"},"shenyu.sync.websocket.urls"),"\uff0c\u90a3\u4e48",(0,i.yg)("inlineCode",{parentName:"p"},"Websocket"),"\u6570\u636e\u540c\u6b65\u914d\u7f6e\u5c31\u4f1a\u88ab\u52a0\u8f7d\u3002\u8fd9\u91cc\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"p"},"spring boot starter"),"\u5b8c\u6210\u4f9d\u8d56\u7684\u52a0\u8f7d\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'\n/**\n * Websocket\u6570\u636e\u540c\u6b65\u914d\u7f6e\n * \u901a\u8fc7springboot\u5b9e\u73b0\u6761\u4ef6\u6ce8\u5165\n * Websocket sync data configuration for spring boot.\n */\n@Configuration\n@ConditionalOnClass(WebsocketSyncDataService.class)\n@ConditionalOnProperty(prefix = "shenyu.sync.websocket", name = "urls")\n@Slf4j\npublic class WebsocketSyncDataConfiguration {\n\n    /**\n     * Websocket sync data service.\n     * Websocket\u6570\u636e\u540c\u6b65\u670d\u52a1\n     * @param websocketConfig   the websocket config\n     * @param pluginSubscriber the plugin subscriber\n     * @param metaSubscribers   the meta subscribers\n     * @param authSubscribers   the auth subscribers\n     * @return the sync data service\n     */\n    // \u521b\u5efawebsocketSyncDataService\n    @Bean\n    public SyncDataService websocketSyncDataService(final ObjectProvider<WebsocketConfig> websocketConfig, final ObjectProvider<PluginDataSubscriber> pluginSubscriber,\n                                           final ObjectProvider<List<MetaDataSubscriber>> metaSubscribers, final ObjectProvider<List<AuthDataSubscriber>> authSubscribers) {\n        log.info("you use websocket sync shenyu data.......");\n        return new WebsocketSyncDataService(websocketConfig.getIfAvailable(WebsocketConfig::new), pluginSubscriber.getIfAvailable(),\n                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));\n    }\n\n    /**\n     * Config websocket config.\n     *\n     * @return the websocket config\n     */\n    @Bean\n    @ConfigurationProperties(prefix = "shenyu.sync.websocket")\n    public WebsocketConfig websocketConfig() {\n        return new WebsocketConfig();  // \u521b\u5efaWebsocketConfig\n    }\n}\n')),(0,i.yg)("p",null,"\u5728\u9879\u76ee\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"resources/META-INF"),"\u76ee\u5f55\u5148\u65b0\u5efa",(0,i.yg)("inlineCode",{parentName:"p"},"spring.factories"),"\u6587\u4ef6\uff0c\u5728\u6587\u4ef6\u4e2d\u6307\u660e\u914d\u7f6e\u7c7b\u3002"),(0,i.yg)("p",null,(0,i.yg)("img",{src:a(55107).A})),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Websocket\u6570\u636e\u540c\u6b65\u670d\u52a1")),(0,i.yg)("p",null,"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"WebsocketSyncDataService"),"\u4e2d\u505a\u4e86\u5982\u4e0b\u51e0\u4ef6\u4e8b\u60c5\uff1a"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"\u8bfb\u53d6\u914d\u7f6e\u4e2d\u7684",(0,i.yg)("inlineCode",{parentName:"li"},"urls"),"\uff0c\u8fd9\u4e2a\u8868\u793a",(0,i.yg)("inlineCode",{parentName:"li"},"admin"),'\u7aef\u7684\u540c\u6b65\u5730\u5740\uff0c\u6709\u591a\u4e2a\u7684\u8bdd\uff0c\u4f7f\u7528","\u5206\u5272\uff1b'),(0,i.yg)("li",{parentName:"ul"},"\u521b\u5efa\u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff0c\u4e00\u4e2a",(0,i.yg)("inlineCode",{parentName:"li"},"admin"),"\u5206\u914d\u4e00\u4e2a\uff0c\u7528\u4e8e\u6267\u884c\u5b9a\u65f6\u4efb\u52a1\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u521b\u5efa",(0,i.yg)("inlineCode",{parentName:"li"},"ShenyuWebsocketClient"),"\uff0c\u4e00\u4e2a",(0,i.yg)("inlineCode",{parentName:"li"},"admin"),"\u5206\u914d\u4e00\u4e2a\uff0c\u7528\u4e8e\u548c",(0,i.yg)("inlineCode",{parentName:"li"},"admin"),"\u5efa\u7acb",(0,i.yg)("inlineCode",{parentName:"li"},"websocket"),"\u901a\u4fe1\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u5f00\u59cb\u548c",(0,i.yg)("inlineCode",{parentName:"li"},"admin"),"\u7aef\u7684",(0,i.yg)("inlineCode",{parentName:"li"},"websocket")," \u5efa\u7acb\u8fde\u63a5\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u6267\u884c\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf\u969410\u79d2\u6267\u884c\u4e00\u6b21\u3002\u4e3b\u8981\u4f5c\u7528\u662f\u5224\u65ad",(0,i.yg)("inlineCode",{parentName:"li"},"websocket"),"\u8fde\u63a5\u662f\u5426\u5df2\u7ecf\u65ad\u5f00\uff0c\u5982\u679c\u5df2\u7ecf\u65ad\u5f00\uff0c\u5219\u5c1d\u8bd5\u91cd\u8fde\u3002\u5982\u679c\u6ca1\u6709\u65ad\u5f00\uff0c\u5c31\u8fdb\u884c ",(0,i.yg)("inlineCode",{parentName:"li"},"ping-pong")," \u68c0\u6d4b\u3002")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'\n/**\n * Websocket\u6570\u636e\u540c\u6b65\u670d\u52a1\n * Websocket sync data service.\n */\n@Slf4j\npublic class WebsocketSyncDataService implements SyncDataService, AutoCloseable {\n\n    private final List<WebSocketClient> clients = new ArrayList<>();\n\n    private final ScheduledThreadPoolExecutor executor;\n\n    /**\n     * Instantiates a new Websocket sync cache.\n     * \u521b\u5efaWebsocket\u6570\u636e\u540c\u6b65\u670d\u52a1\n     * @param websocketConfig      the websocket config\n     * @param pluginDataSubscriber the plugin data subscriber\n     * @param metaDataSubscribers  the meta data subscribers\n     * @param authDataSubscribers  the auth data subscribers\n     */\n    public WebsocketSyncDataService(final WebsocketConfig websocketConfig,\n                                    final PluginDataSubscriber pluginDataSubscriber,\n                                    final List<MetaDataSubscriber> metaDataSubscribers,\n                                    final List<AuthDataSubscriber> authDataSubscribers) {\n        // admin\u7aef\u7684\u540c\u6b65\u5730\u5740\uff0c\u6709\u591a\u4e2a\u7684\u8bdd\uff0c\u4f7f\u7528","\u5206\u5272\n        String[] urls = StringUtils.split(websocketConfig.getUrls(), ",");\n        // \u521b\u5efa\u8c03\u5ea6\u7ebf\u7a0b\u6c60\uff0c\u4e00\u4e2aadmin\u5206\u914d\u4e00\u4e2a\n        executor = new ScheduledThreadPoolExecutor(urls.length, ShenyuThreadFactory.create("websocket-connect", true));\n        for (String url : urls) {\n            try {\n                //\u521b\u5efaWebsocketClient\uff0c\u4e00\u4e2aadmin\u5206\u914d\u4e00\u4e2a\n                clients.add(new ShenyuWebsocketClient(new URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));\n            } catch (URISyntaxException e) {\n                log.error("websocket url({}) is error", url, e);\n            }\n        }\n        try {\n            for (WebSocketClient client : clients) {\n                // \u548cwebsocket server\u5efa\u7acb\u8fde\u63a5\n                boolean success = client.connectBlocking(3000, TimeUnit.MILLISECONDS);\n                if (success) {\n                    log.info("websocket connection is successful.....");\n                } else {\n                    log.error("websocket connection is error.....");\n                }\n\n                // \u6267\u884c\u5b9a\u65f6\u4efb\u52a1\uff0c\u6bcf\u969410\u79d2\u6267\u884c\u4e00\u6b21\n                // \u4e3b\u8981\u4f5c\u7528\u662f\u5224\u65adwebsocket\u8fde\u63a5\u662f\u5426\u5df2\u7ecf\u65ad\u5f00\uff0c\u5982\u679c\u5df2\u7ecf\u65ad\u5f00\uff0c\u5219\u5c1d\u8bd5\u91cd\u8fde\u3002\n                // \u5982\u679c\u6ca1\u6709\u65ad\u5f00\uff0c\u5c31\u8fdb\u884c ping-pong \u68c0\u6d4b\n                executor.scheduleAtFixedRate(() -> {\n                    try {\n                        if (client.isClosed()) {\n                            boolean reconnectSuccess = client.reconnectBlocking();\n                            if (reconnectSuccess) {\n                                log.info("websocket reconnect server[{}] is successful.....", client.getURI().toString());\n                            } else {\n                                log.error("websocket reconnection server[{}] is error.....", client.getURI().toString());\n                            }\n                        } else {\n                            client.sendPing();\n                            log.debug("websocket send to [{}] ping message successful", client.getURI().toString());\n                        }\n                    } catch (InterruptedException e) {\n                        log.error("websocket connect is error :{}", e.getMessage());\n                    }\n                }, 10, 10, TimeUnit.SECONDS);\n            }\n            /* client.setProxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress("proxyaddress", 80)));*/\n        } catch (InterruptedException e) {\n            log.info("websocket connection...exception....", e);\n        }\n\n    }\n\n    @Override\n    public void close() {\n        // \u5173\u95ed websocket client\n        for (WebSocketClient client : clients) {\n            if (!client.isClosed()) {\n                client.close();\n            }\n        }\n        // \u5173\u95ed\u7ebf\u7a0b\u6c60\n        if (Objects.nonNull(executor)) {\n            executor.shutdown();\n        }\n    }\n}\n')),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"ShenyuWebsocketClient")),(0,i.yg)("p",null,"\u5728",(0,i.yg)("inlineCode",{parentName:"p"},"ShenYu"),"\u4e2d\u521b\u5efa\u7684",(0,i.yg)("inlineCode",{parentName:"p"},"WebSocket"),"\u5ba2\u6237\u7aef\uff0c\u7528\u4e8e\u548c",(0,i.yg)("inlineCode",{parentName:"p"},"admin"),"\u7aef\u901a\u4fe1\u3002\u7b2c\u4e00\u6b21\u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\uff0c\u540c\u6b65\u5168\u91cf\u6570\u636e\uff0c\u540e\u7eed\u8fdb\u884c\u589e\u91cf\u540c\u6b65\u3002"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'\n/**\n * \u5728ShenYu\u4e2d\u81ea\u5b9a\u4e49\u7684WebSocket\u5ba2\u6237\u7aef\n * The type shenyu websocket client.\n */\n@Slf4j\npublic final class ShenyuWebsocketClient extends WebSocketClient {\n    \n    private volatile boolean alreadySync = Boolean.FALSE;\n    \n    private final WebsocketDataHandler websocketDataHandler;\n    \n    /**\n     * Instantiates a new shenyu websocket client.\n     * \u521b\u5efaShenyuWebsocketClient\n     * @param serverUri             the server uri  \u670d\u52a1\u7aefuri\n     * @param pluginDataSubscriber the plugin data subscriber \u63d2\u4ef6\u6570\u636e\u8ba2\u9605\u5668\n     * @param metaDataSubscribers   the meta data subscribers \u5143\u6570\u636e\u8ba2\u9605\u5668\n     * @param authDataSubscribers   the auth data subscribers \u8ba4\u8bc1\u6570\u636e\u8ba2\u9605\u5668\n     */\n    public ShenyuWebsocketClient(final URI serverUri, final PluginDataSubscriber pluginDataSubscriber,final List<MetaDataSubscriber> metaDataSubscribers, final List<AuthDataSubscriber> authDataSubscribers) {\n        super(serverUri);\n        this.websocketDataHandler = new WebsocketDataHandler(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);\n    }\n\n    // \u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\u6267\u884c\n    @Override\n    public void onOpen(final ServerHandshake serverHandshake) {\n        // \u9632\u6b62\u91cd\u65b0\u5efa\u7acb\u8fde\u63a5\u65f6\uff0c\u518d\u6b21\u6267\u884c\uff0c\u6240\u4ee5\u7528alreadySync\u8fdb\u884c\u5224\u65ad\n        if (!alreadySync) {\n            // \u540c\u6b65\u6240\u6709\u6570\u636e\uff0cMYSELF \u7c7b\u578b\n            send(DataEventTypeEnum.MYSELF.name());\n            alreadySync = true;\n        }\n    }\n\n    // \u63a5\u6536\u5230\u6d88\u606f\u540e\u6267\u884c\n    @Override\n    public void onMessage(final String result) {\n        // \u5904\u7406\u63a5\u6536\u5230\u7684\u6570\u636e\n        handleResult(result);\n    }\n    \n    // \u5173\u95ed\u540e\u6267\u884c\n    @Override\n    public void onClose(final int i, final String s, final boolean b) {\n        this.close();\n    }\n    \n    // \u5931\u8d25\u540e\u6267\u884c\n    @Override\n    public void onError(final Exception e) {\n        this.close();\n    }\n    \n    @SuppressWarnings("ALL")\n    private void handleResult(final String result) {\n        // \u6570\u636e\u53cd\u5e8f\u5217\u5316\n        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);\n        // \u54ea\u79cd\u6570\u636e\u7c7b\u578b\uff0c\u63d2\u4ef6\u3001\u9009\u62e9\u5668\u3001\u89c4\u5219...\n        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());\n        // \u54ea\u79cd\u64cd\u4f5c\u7c7b\u578b\uff0c\u66f4\u65b0\u3001\u5220\u9664...\n        String eventType = websocketData.getEventType();\n        String json = GsonUtils.getInstance().toJson(websocketData.getData());\n\n        // \u5904\u7406\u6570\u636e\n        websocketDataHandler.executor(groupEnum, json, eventType);\n    }\n}\n\n')),(0,i.yg)("h3",{id:"5-\u603b\u7ed3"},"5. \u603b\u7ed3"),(0,i.yg)("p",null,"\u672c\u6587\u901a\u8fc7\u4e00\u4e2a\u5b9e\u9645\u6848\u4f8b\uff0c\u5bf9",(0,i.yg)("inlineCode",{parentName:"p"},"websocket"),"\u7684\u6570\u636e\u540c\u6b65\u539f\u7406\u8fdb\u884c\u4e86\u6e90\u7801\u5206\u6790\u3002\u6d89\u53ca\u5230\u7684\u4e3b\u8981\u77e5\u8bc6\u70b9\u5982\u4e0b\uff1a"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"websocket"),"\u652f\u6301\u53cc\u5411\u901a\u4fe1\uff0c\u6027\u80fd\u597d\uff0c\u63a8\u8350\u4f7f\u7528\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"li"},"Spring"),"\u5b8c\u6210\u4e8b\u4ef6\u53d1\u5e03\u548c\u76d1\u542c\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u901a\u8fc7\u62bd\u8c61",(0,i.yg)("inlineCode",{parentName:"li"},"DataChangedListener"),"\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u540c\u6b65\u7b56\u7565\uff0c\u9762\u5411\u63a5\u53e3\u7f16\u7a0b\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u4f7f\u7528\u5de5\u5382\u6a21\u5f0f\u521b\u5efa ",(0,i.yg)("inlineCode",{parentName:"li"},"WebsocketDataHandler"),"\uff0c\u5b9e\u73b0\u4e0d\u540c\u6570\u636e\u7c7b\u578b\u7684\u5904\u7406\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u4f7f\u7528\u6a21\u677f\u65b9\u6cd5\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0",(0,i.yg)("inlineCode",{parentName:"li"},"AbstractDataHandler"),"\uff0c\u5904\u7406\u901a\u7528\u7684\u64cd\u4f5c\u7c7b\u578b\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u4f7f\u7528\u5355\u4f8b\u8bbe\u8ba1\u6a21\u5f0f\u5b9e\u73b0\u7f13\u5b58\u6570\u636e\u7c7b",(0,i.yg)("inlineCode",{parentName:"li"},"BaseDataCache"),"\uff1b"),(0,i.yg)("li",{parentName:"ul"},"\u901a\u8fc7",(0,i.yg)("inlineCode",{parentName:"li"},"SpringBoot"),"\u7684\u6761\u4ef6\u88c5\u914d\u548c",(0,i.yg)("inlineCode",{parentName:"li"},"starter"),"\u52a0\u8f7d\u673a\u5236\u5b9e\u73b0\u914d\u7f6e\u7c7b\u7684\u52a0\u8f7d\u3002")))}g.isMDXComponent=!0},75377:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/add-selector-93ff1008c1b0b4627dd3329abc92a7bd.png"},34830:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"},48851:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/data-handler-313ae788eadfdabf405cdc55c74dbb21.png"},98610:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"},10674:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/websocket-data-sync-admin-56f75ad149ca3cd1ec07fd24c6194c5b.png"},33085:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/websocket-data-sync-gateway-181e89c69dc9b9d2569e858eb82431bf.png"},55107:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/websocket-springboot-starter-2cfd149ba2fb69ab514241e061fc22c9.png"}}]);