<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">æ³¨å†Œä¸­å¿ƒå®ç°åŸç†ä¹‹Httpæ³¨å†Œ | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="æ³¨å†Œä¸­å¿ƒå®ç°åŸç†ä¹‹Httpæ³¨å†Œ | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Apache ShenYu æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚"><meta data-react-helmet="true" property="og:description" content="Apache ShenYu æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/RegisterCenter-SourceCode-Analysis-Http-Register" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/RegisterCenter-SourceCode-Analysis-Http-Register" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.4db9224e.css">
<link rel="preload" href="/zh/assets/js/runtime~main.9173d839.js" as="script">
<link rel="preload" href="/zh/assets/js/main.92374309.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/document">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><a class="navbar__item navbar__link" href="/zh/event">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/RegisterCenter-SourceCode-Analysis-Http-Register" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="blogPostTitle_d4p0">æ³¨å†Œä¸­å¿ƒå®ç°åŸç†ä¹‹Httpæ³¨å†Œ</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-05-05T02:59:09.126Z">2023å¹´5æœˆ5æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ³¨å†Œä¸­å¿ƒæ˜¯ç”¨äºå°†å®¢æˆ·ç«¯ä¿¡æ¯æ³¨å†Œåˆ°<code>shenyu-admin</code>ï¼Œ<code>admin</code>å†é€šè¿‡æ•°æ®åŒæ­¥å°†è¿™äº›ä¿¡æ¯åŒæ­¥åˆ°ç½‘å…³ï¼Œç½‘å…³é€šè¿‡è¿™äº›æ•°æ®å®Œæˆæµé‡ç­›é€‰ã€‚å®¢æˆ·ç«¯ä¿¡æ¯ä¸»è¦åŒ…æ‹¬<code>æ¥å£ä¿¡æ¯</code>å’Œ<code>URIä¿¡æ¯</code>ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.5.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/register-center-design" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-æ³¨å†Œä¸­å¿ƒåŸç†"></a>1. æ³¨å†Œä¸­å¿ƒåŸç†<a class="hash-link" href="#1-æ³¨å†Œä¸­å¿ƒåŸç†" title="Direct link to heading">#</a></h3><p>å½“å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œè¯»å–æ¥å£ä¿¡æ¯å’Œ<code>uriä¿¡æ¯</code>ï¼Œé€šè¿‡æŒ‡å®šçš„æ³¨å†Œç±»å‹ï¼Œå°†æ•°æ®å‘é€åˆ°<code>shenyu-admin</code>ã€‚</p><p><img src="/zh/assets/images/register-center-6df3139bde6babdb3360f928f93bf737.png"></p><p>å›¾ä¸­çš„æ³¨å†Œä¸­å¿ƒéœ€è¦ç”¨æˆ·æŒ‡å®šä½¿ç”¨å“ªç§æ³¨å†Œç±»å‹ï¼Œ<code>ShenYu</code>å½“å‰æ”¯æŒ<code>Http</code>ã€<code>Zookeeper</code>ã€<code>Etcd</code>ã€<code>Consul</code>å’Œ<code>Nacos</code>è¿›è¡Œæ³¨å†Œã€‚å…·ä½“å¦‚ä½•é…ç½®è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><p><code>ShenYu</code>åœ¨æ³¨å†Œä¸­å¿ƒçš„åŸç†è®¾è®¡ä¸Šå¼•å…¥äº†<code>Disruptor</code>ï¼Œ<code>Disruptor</code>é˜Ÿåˆ—åœ¨å…¶ä¸­èµ·åˆ°æ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œåˆ©äºæ‰©å±•ã€‚å¦‚æœæ³¨å†Œè¯·æ±‚è¿‡å¤šï¼Œå¯¼è‡´æ³¨å†Œå¼‚å¸¸ï¼Œä¹Ÿæœ‰æ•°æ®ç¼“å†²ä½œç”¨ã€‚</p><p><img src="/zh/assets/images/shenyu-register-center-679a8ce3a7173b5f7a29f312448efa47.png"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ³¨å†Œä¸­å¿ƒåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€æ˜¯æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯<code>register-client</code>ï¼Œè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯æ•°æ®è¯»å–ã€‚å¦ä¸€ä¸ªæ˜¯æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯<code>register-server</code>ï¼Œè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ï¼ˆå°±æ˜¯<code>shenyu-admin</code>ï¼‰æ•°æ®å†™å…¥ã€‚é€šè¿‡æŒ‡å®šæ³¨å†Œç±»å‹è¿›è¡Œæ•°æ®å‘é€å’Œæ¥æ”¶ã€‚</p><ul><li>å®¢æˆ·ç«¯ï¼šé€šå¸¸æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå¯ä»¥æ˜¯<code>springmvc</code>ï¼Œ<code>spring-cloud</code>ï¼Œ<code>dubbo</code>ï¼Œ<code>grpc</code>ç­‰ã€‚</li><li><code>register-client</code>ï¼šæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯ï¼Œè¯»å–å®¢æˆ·æ¥å£å’Œ<code>uri</code>ä¿¡æ¯ã€‚</li><li><code>Disruptor</code>ï¼šæ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œæ•°æ®ç¼“å†²ä½œç”¨ã€‚</li><li><code>register-server</code>ï¼šæ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯ï¼Œè¿™é‡Œå°±æ˜¯<code>shenyu-admin</code>ï¼Œæ¥æ”¶æ•°æ®ï¼Œå†™å…¥æ•°æ®åº“ï¼Œå‘æ•°æ®åŒæ­¥äº‹ä»¶ã€‚</li><li>æ³¨å†Œç±»å‹ï¼šæŒ‡å®šæ³¨å†Œç±»å‹ï¼Œå®Œæˆæ•°æ®æ³¨å†Œï¼Œå½“å‰æ”¯æŒ<code>Http</code>ã€<code>Zookeeper</code>ã€<code>Etcd</code>ã€<code>Consul</code>å’Œ<code>Nacos</code>ã€‚</li></ul><p>æœ¬æ–‡åˆ†æçš„æ˜¯ä½¿ç”¨<code>Http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥å…·ä½“çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/shenyu-register-center-http-540b66ff202c41000b463cfae8403699.png"></p><p>åœ¨å®¢æˆ·ç«¯ï¼Œæ•°æ®å‡ºé˜Ÿåˆ—åï¼Œé€šè¿‡<code>http</code>ä¼ è¾“æ•°æ®ï¼Œåœ¨æœåŠ¡ç«¯ï¼Œæä¾›ç›¸åº”çš„æ¥å£ï¼Œæ¥æ”¶æ•°æ®ï¼Œç„¶åå†™å…¥é˜Ÿåˆ—ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹"></a>2. å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹<a class="hash-link" href="#2-å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹" title="Direct link to heading">#</a></h3><p>å½“å®¢æˆ·ç«¯å¯åŠ¨åï¼Œæ ¹æ®ç›¸å…³é…ç½®ï¼Œè¯»å–å±æ€§ä¿¡æ¯ï¼Œç„¶åå†™å…¥é˜Ÿåˆ—ã€‚ä»¥å®˜æ–¹æä¾›çš„ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> ä¸ºä¾‹ï¼Œå¼€å§‹æºç åˆ†æã€‚å®˜æ–¹æä¾›çš„ä¾‹å­æ˜¯ä¸€ä¸ªç”±<code>springboot</code>æ„å»ºçš„å¾®æœåŠ¡ã€‚æ³¨å†Œä¸­å¿ƒçš„ç›¸å…³é…ç½®å¯ä»¥å‚è€ƒå®˜ç½‘  <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-åŠ è½½é…ç½®è¯»å–å±æ€§"></a>2.1 åŠ è½½é…ç½®ï¼Œè¯»å–å±æ€§<a class="hash-link" href="#21-åŠ è½½é…ç½®è¯»å–å±æ€§" title="Direct link to heading">#</a></h4><p>å…ˆç”¨ä¸€å¼ å›¾ä¸²è”ä¸‹æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯åˆå§‹åŒ–æµç¨‹ï¼š</p><p><img src="/zh/assets/images/client-register-init-zh-40a0219a500b6637453b6ad0daf1bf87.png"></p><p>æˆ‘ä»¬åˆ†æçš„æ˜¯é€šè¿‡<code>http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ¯ä¸ªå±æ€§è¡¨ç¤ºçš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>registerType</code>: æœåŠ¡æ³¨å†Œç±»å‹ï¼Œå¡«å†™ <code>http</code>ã€‚</li><li><code>serverList</code>: ä¸º<code>http</code>æ³¨å†Œç±»å‹æ—¶ï¼Œå¡«å†™<code>Shenyu-Admin</code>é¡¹ç›®çš„åœ°å€ï¼Œæ³¨æ„åŠ ä¸Š<code>http://</code>ï¼Œå¤šä¸ªåœ°å€ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚</li><li><code>username</code>: <code>Shenyu-Admin</code>ç”¨æˆ·å</li><li><code>password</code>: <code>Shenyu-Admin</code>ç”¨æˆ·å¯¹åº”çš„å¯†ç </li><li><code>port</code>: ä½ æœ¬é¡¹ç›®çš„å¯åŠ¨ç«¯å£ï¼Œç›®å‰<code>springmvc/tars/grpc</code>éœ€è¦è¿›è¡Œå¡«å†™ã€‚</li><li><code>contextPath</code>: ä¸ºä½ çš„è¿™ä¸ª<code>mvc</code>é¡¹ç›®åœ¨<code>shenyu</code>ç½‘å…³çš„è·¯ç”±å‰ç¼€ï¼Œ æ¯”å¦‚<code>/order</code> ï¼Œ<code>/product</code> ç­‰ç­‰ï¼Œç½‘å…³ä¼šæ ¹æ®ä½ çš„è¿™ä¸ªå‰ç¼€æ¥è¿›è¡Œè·¯ç”±ã€‚</li><li><code>appName</code>ï¼šä½ çš„åº”ç”¨åç§°ï¼Œä¸é…ç½®çš„è¯ï¼Œä¼šé»˜è®¤å– <code>spring.application.name</code> çš„å€¼ã€‚</li><li><code>isFull</code>: è®¾ç½® <code>true</code> ä»£è¡¨ä»£ç†ä½ çš„æ•´ä¸ªæœåŠ¡ï¼Œ<code>false</code>è¡¨ç¤ºä»£ç†ä½ å…¶ä¸­æŸå‡ ä¸ª<code>controller</code>ï¼›ç›®å‰é€‚ç”¨äº<code>springmvc/springcloud</code>ã€‚</li></ul><p>é¡¹ç›®å¯åŠ¨åï¼Œä¼šå…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œè¯»å–å±æ€§ä¿¡æ¯ï¼Œç”Ÿæˆç›¸åº”çš„<code>Bean</code>ã€‚</p><p>é¦–å…ˆè¯»å–åˆ°çš„é…ç½®æ–‡ä»¶æ˜¯ <code>ShenyuSpringMvcClientConfiguration</code>ï¼Œå®ƒæ˜¯<code>shenyu</code> å®¢æˆ·ç«¯<code>http</code>æ³¨å†Œé…ç½®ç±»ï¼Œé€šè¿‡<code>@Configuration</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œé€šè¿‡<code>@ImportAutoConfiguration</code>å¼•å…¥å…¶ä»–é…ç½®ç±»ã€‚åˆ›å»º<code>SpringMvcClientEventListener</code>ï¼Œä¸»è¦å¤„ç†å…ƒæ•°æ®å’Œ <code>URI</code> ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyu å®¢æˆ·ç«¯httpæ³¨å†Œé…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // åˆ›å»ºSpringMvcClientEventListenerï¼Œä¸»è¦å¤„ç†å…ƒæ•°æ®å’ŒURIä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                     final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuClientCommonBeanConfiguration</code>æ˜¯<code>shenyu</code>å®¢æˆ·ç«¯é€šç”¨é…ç½®ç±»ï¼Œä¼šåˆ›å»ºæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯é€šç”¨çš„<code>bean</code>ã€‚</p><ul><li>åˆ›å»º<code>ShenyuClientRegisterRepository</code>ï¼Œé€šè¿‡å·¥å‚ç±»åˆ›å»ºè€Œæˆã€‚</li><li>åˆ›å»º<code>ShenyuRegisterCenterConfig</code>ï¼Œè¯»å–<code>shenyu.register</code>å±æ€§é…ç½®ã€‚</li><li>åˆ›å»º<code>ShenyuClientConfig</code>ï¼Œè¯»å–<code>shenyu.client</code>å±æ€§é…ç½®ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyuå®¢æˆ·ç«¯é€šç”¨é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientCommonBeanConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // åˆ›å»ºShenyuClientRegisterRepositoryï¼Œé€šè¿‡å·¥å‚ç±»åˆ›å»ºè€Œæˆã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientRegisterRepository shenyuClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuClientRegisterRepositoryFactory.newInstance(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºShenyuRegisterCenterConfigï¼Œè¯»å–shenyu.registerå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // åˆ›å»ºShenyuClientConfigï¼Œè¯»å–shenyu.clientå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuClientConfig shenyuClientConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuClientConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-ç”¨äºæ³¨å†Œçš„-httpclientregisterrepository"></a>2.2 ç”¨äºæ³¨å†Œçš„ HttpClientRegisterRepository<a class="hash-link" href="#22-ç”¨äºæ³¨å†Œçš„-httpclientregisterrepository" title="Direct link to heading">#</a></h4><p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¸­ç”Ÿæˆçš„<code>ShenyuClientRegisterRepository</code>æ˜¯å®¢æˆ·ç«¯æ³¨å†Œçš„å…·ä½“å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒçš„å®ç°ç±»å¦‚ä¸‹ã€‚</p><p><img src="/zh/assets/images/shenyu-client-register-repository-dba8edf50af1be31d8b53c9573b1e015.png"></p><ul><li><code>HttpClientRegisterRepository</code>ï¼šé€šè¿‡<code>http</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>ConsulClientRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>EtcdClientRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>NacosClientRegisterRepository</code>ï¼šé€šè¿‡<code>nacos</code>è¿›è¡Œæ³¨å†Œï¼›</li><li><code>ZookeeperClientRegisterRepository</code>é€šè¿‡<code>Zookeeper</code>è¿›è¡Œæ³¨å†Œã€‚</li></ul><p>å…·ä½“æ˜¯å“ªä¸€ç§æ–¹å¼ï¼Œæ˜¯é€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½å®ç°çš„ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * åŠ è½½ ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»º ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡SPIçš„æ–¹å¼è¿›è¡ŒåŠ è½½ï¼Œç±»å‹ç”±registerTypeå†³å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŠ è½½ç±»å‹é€šè¿‡<code>registerType</code>æŒ‡å®šï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ç±»å‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">serverLists</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆ‘ä»¬æŒ‡å®šçš„æ˜¯<code>http</code>ï¼Œæ‰€ä»¥ä¼šå»åŠ è½½<code>HttpClientRegisterRepository</code>ã€‚å¯¹è±¡åˆ›å»ºæˆåŠŸåï¼Œæ‰§è¡Œçš„åˆå§‹åŒ–æ–¹æ³•<code>init()</code>å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository implements ShenyuClientRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // æš‚æ—¶çœç•¥å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„<code>username</code>ã€<code>password</code>å’Œ<code>serverLists</code>ï¼Œå³<code>sheenyu-admin</code>çš„è®¿é—®è´¦å·ã€å¯†ç å’Œåœ°å€ä¿¡æ¯ï¼Œä¸ºåç»­æ•°æ®å‘é€åšå‡†å¤‡ã€‚ç±»æ³¨è§£<code>@Join</code>ç”¨äº<code>SPI</code>çš„åŠ è½½ã€‚</p><blockquote><p><code>SPI</code> å…¨ç§°ä¸º <code>Service Provider Interface</code>, æ˜¯ <code>JDK</code> å†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°åŠŸèƒ½, ä¸€ç§åŠ¨æ€æ›¿æ¢å‘ç°çš„æœºåˆ¶ã€‚</p><p><a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-spi" target="_blank" rel="noopener noreferrer">shenyu-spi</a> æ˜¯<code>Apache ShenYu</code>ç½‘å…³è‡ªå®šä¹‰çš„<code>SPI</code>æ‰©å±•å®ç°ï¼Œè®¾è®¡å’Œå®ç°åŸç†å‚è€ƒäº†<code>Dubbo</code>çš„ <a href="https://dubbo.apache.org/zh/docs/v2.7/dev/impls/" target="_blank" rel="noopener noreferrer">SPIæ‰©å±•å®ç°</a> ã€‚</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23--æ„å»º-å…ƒæ•°æ®-å’Œ-uriä¿¡æ¯-çš„-springmvcclienteventlistener"></a>2.3  æ„å»º å…ƒæ•°æ® å’Œ URIä¿¡æ¯ çš„ SpringMvcClientEventListener<a class="hash-link" href="#23--æ„å»º-å…ƒæ•°æ®-å’Œ-uriä¿¡æ¯-çš„-springmvcclienteventlistener" title="Direct link to heading">#</a></h4><p>åˆ›å»º <code>SpringMvcClientEventListener</code>ï¼Œè´Ÿè´£å®¢æˆ·ç«¯ <code>å…ƒæ•°æ®</code> å’Œ <code>URI</code> æ•°æ®çš„æ„å»ºå’Œæ³¨å†Œï¼Œå®ƒçš„åˆ›å»ºæ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®Œæˆã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ImportAutoConfiguration(ShenyuClientCommonBeanConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(value = &quot;shenyu.register.enabled&quot;, matchIfMissing = true, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSpringMvcClientConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  åˆ›å»º SpringMvcClientEventListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener springHttpClientEventListener(final ShenyuClientConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                      final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SpringMvcClientEventListener(clientConfig.getClient().get(RpcTypeEnum.HTTP.getName()), shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>SpringMvcClientEventListener</code>ç»§æ‰¿äº†<code>AbstractContextRefreshedEventListener</code></li></ul><p><img src="/zh/assets/images/shenyu-client-event-listener-0cd56409c59f2546a285a6426f9c8fee.png"></p><p><code>AbstractContextRefreshedEventListener</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº†<code>ApplicationListener</code>æ¥å£ï¼Œå¹¶é‡å†™äº†<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œå½“æœ‰Springäº‹ä»¶å‘ç”Ÿåï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œã€‚å®ƒçš„å®ç°ç›®å‰æœ‰å…«ç§ï¼Œæ¯ä¸€ç§è¡¨ç¤ºå¯¹åº”çš„RPCè°ƒç”¨åè®®çš„ <code>å…ƒæ•°æ®</code> å’Œ<code>URI</code> ä¿¡æ¯çš„æ³¨å†Œã€‚</p><ul><li><code>AlibabaDubboServiceBeanListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Alibaba Dubbo</code>åè®®ï¼›</li><li><code>ApacheDubboServiceBeanListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Apacge Dubbo</code>åè®®ï¼›</li><li><code>GrpcClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>grpc</code>åè®®ï¼›</li><li><code>MotanServiceEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Mortan</code>åè®®ï¼›</li><li><code>SofaServiceEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Sofa</code>åè®®ï¼›</li><li><code>SpringMvcClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>http</code>åè®®ï¼›</li><li><code>SpringWebSocketClientEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>websocket</code>åè®®ï¼›</li><li><code>TarsServiceBeanEventListener</code>ï¼šå¤„ç†ä½¿ç”¨<code>Tars</code>æ³¨å†Œç±»å‹ï¼›</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å®ç°äº†ApplicationListeneræ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractContextRefreshedEventListener&lt;T, A extends Annotation&gt; implements ApplicationListener&lt;ContextRefreshedEvent&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //æ„é€ å‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractContextRefreshedEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯»å– shenyu.client.http é…ç½®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // appName åº”ç”¨åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.appName = props.getProperty(ShenyuClientConstants.APP_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // contextPathä¸Šä¸‹æ–‡è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.contextPath = Optional.ofNullable(props.getProperty(ShenyuClientConstants.CONTEXT_PATH)).map(UriUtils::repairData).orElse(&quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(appName) &amp;&amp; StringUtils.isBlank(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String errorMsg = &quot;client register param must config the appName or contextPath&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuClientIllegalArgumentException(errorMsg);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.ipAndPort = props.getProperty(ShenyuClientConstants.IP_PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // hostä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = props.getProperty(ShenyuClientConstants.HOST);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // port å®¢æˆ·ç«¯ç«¯å£ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = props.getProperty(ShenyuClientConstants.PORT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¼€å§‹äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å½“æœ‰ä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ContextRefreshedEventå‘ç”Ÿæ—¶ï¼Œè¯¥æ–¹æ³•ä¼šæ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(@NonNull final ContextRefreshedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¿è¯è¯¥æ–¹æ³•çš„å†…å®¹åªæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!registered.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ApplicationContext context = event.getApplicationContext();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å£°æ˜RPCè°ƒç”¨çš„ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, T&gt; beans = getBeans(context);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (MapUtils.isEmpty(beans)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºURIæ•°æ®å¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildURIRegisterDTO(context, beans));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºå…ƒæ•°æ®å¹¶æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        beans.forEach(this::handle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº¤ç»™ä¸åŒçš„å­ç±»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;all&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract URIRegisterDTO buildURIRegisterDTO(ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                          Map&lt;String, T&gt; beans);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handle(final String beanName, final T bean) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = getCorrectedClass(bean);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„å¯¹åº”shenyuå®¢æˆ·ç«¯çš„æ³¨è§£ï¼ˆå¯¹åº”ä¸åŒçš„RPCè°ƒç”¨æ³¨è§£ä¸ä¸€æ ·ï¼Œåƒhttpçš„å°±æ˜¯@ShenyuSpringMvcClient,è€ŒåƒSpringCloudçš„åˆ™æ˜¯@ShenyuSpringCloudClientï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final A beanShenyuClient = AnnotatedElementUtils.findMergedAnnotation(clazz, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®beanè·å–å¯¹åº”çš„pathï¼ˆä¸åŒå­ç±»å®ç°ä¸ä¸€æ ·ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String superPath = buildApiSuperPath(clazz, beanShenyuClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœåŒ…å«Shenyuå®¢æˆ·ç«¯æ³¨è§£æˆ–è€…pathä¸­åŒ…æ‹¬&#x27;*&#x27;ï¼Œè¡¨ç¤ºæ³¨å†Œæ•´ä¸ªç±»çš„æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; superPath.contains(&quot;*&quot;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºç±»çš„å…ƒæ•°æ®ï¼Œå‘é€æ³¨å†Œäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleClass(clazz, bean, beanShenyuClient, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„æ‰€æœ‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(clazz);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Method method : methods) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†Œç¬¦åˆæ¡ä»¶çš„æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleMethod(bean, clazz, beanShenyuClient, method, superPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºç±»å…ƒæ•°æ®å¹¶æ³¨å†Œçš„é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleClass(final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               @NonNull final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                               final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publishEvent(buildMetaDataDTO(bean, beanShenyuClient, pathJoin(contextPath, superPath), clazz, null));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„å»ºæ–¹æ³•å…ƒæ•°æ®å¹¶æ³¨å†Œçš„é»˜è®¤å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final A beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ–¹æ³•ä¸Šæœ‰Shenyuå®¢æˆ·ç«¯æ³¨è§£ï¼Œå°±è¡¨ç¤ºè¯¥æ–¹æ³•éœ€è¦æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        A methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, getAnnotationType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ„å»ºå…ƒæ•°æ®ï¼Œå‘é€æ³¨å†Œäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            publisher.publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº¤ç»™ä¸åŒå­ç±»å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract MetaDataRegisterDTO buildMetaDataDTO(T bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            @NonNull A shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            String path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                            Method method);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨æ„é€ å‡½æ•°ä¸­ä¸»è¦æ˜¯è¯»å–å±æ€§é…ç½®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">contextPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8189</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">isFull</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åï¼Œæ‰§è¡Œäº†<code>publisher.start()</code>ï¼Œå¼€å§‹äº‹ä»¶å‘å¸ƒï¼Œä¸ºæ³¨å†Œåšå‡†å¤‡ã€‚</p><ul><li>ShenyuClientRegisterEventPublisher</li></ul><p><code>ShenyuClientRegisterEventPublisher</code>é€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ï¼Œä¸»è¦æ˜¯ç”Ÿæˆå…ƒæ•°æ®å’Œ<code>URI</code>è®¢é˜…å™¨ï¼ˆåç»­ç”¨äºæ•°æ®å‘å¸ƒï¼‰ï¼Œç„¶åå¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚æä¾›äº†ä¸€ä¸ªå…±æœ‰æ–¹æ³•<code>publishEvent()</code>ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œå‘Disruptoré˜Ÿåˆ—å‘æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientRegisterEventPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuClientRegisterEventPublisher INSTANCE = new ShenyuClientRegisterEventPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;DataTypeParent&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¬å¼€é™æ€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ShenyuClientRegisterEventPublisher instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterEventPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Startæ–¹æ³•æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param shenyuClientRegisterRepository shenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºå®¢æˆ·ç«¯æ³¨å†Œå·¥å‚ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientExecutorFactory factory = new RegisterClientExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ·»åŠ å…ƒæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientMetadataExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //  æ·»åŠ URIè®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new ShenyuClientURIExecutorSubscriber(shenyuClientRegisterRepository));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯åŠ¨Disruptoré˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å‘å¸ƒäº‹ä»¶ï¼Œå‘Disruptoré˜Ÿåˆ—å‘æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; void publishEvent(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;DataTypeParent&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AbstractContextRefreshedEventListener</code>çš„æ„é€ å‡½æ•°é€»è¾‘åˆ†æå®Œæˆäº†ï¼Œä¸»è¦æ˜¯è¯»å–å±æ€§é…ç½®ï¼Œåˆ›å»º<code>å…ƒæ•°æ®</code>å’Œ<code>URI</code>è®¢é˜…å™¨ï¼Œå¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚</p><p><code>onApplicationEvent()</code>æ–¹æ³•æ˜¯æœ‰<code>Spring</code>äº‹ä»¶å‘ç”Ÿæ—¶ä¼šæ‰§è¡Œï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯<code>ContextRefreshedEvent</code>ï¼Œè¡¨ç¤ºä¸Šä¸‹æ–‡åˆ·æ–°äº‹ä»¶ã€‚å½“<code>Spring</code>å®¹å™¨å°±ç»ªåæ‰§è¡Œæ­¤å¤„é€»è¾‘ï¼šå…ˆæ„å»º<code>URI</code>æ•°æ®å¹¶æ³¨å†Œï¼Œå†æ„å»ºå…ƒæ•°æ®å¹¶æ³¨å†Œï¼Œ</p><blockquote><p><code>ContextRefreshedEvent</code>æ˜¯<code>Spring</code>å†…ç½®äº‹ä»¶ã€‚<code>ApplicationContext</code>è¢«åˆå§‹åŒ–æˆ–åˆ·æ–°æ—¶ï¼Œè¯¥äº‹ä»¶è¢«è§¦å‘ã€‚è¿™ä¹Ÿå¯ä»¥åœ¨ <code>ConfigurableApplicationContext</code>æ¥å£ä¸­ä½¿ç”¨ <code>refresh()</code> æ–¹æ³•æ¥å‘ç”Ÿã€‚æ­¤å¤„çš„åˆå§‹åŒ–æ˜¯æŒ‡ï¼šæ‰€æœ‰çš„<code>Bean</code>è¢«æˆåŠŸè£…è½½ï¼Œåå¤„ç†<code>Bean</code>è¢«æ£€æµ‹å¹¶æ¿€æ´»ï¼Œæ‰€æœ‰<code>Singleton Bean</code> è¢«é¢„å®ä¾‹åŒ–ï¼Œ<code>ApplicationContext</code>å®¹å™¨å·²å°±ç»ªå¯ç”¨ã€‚</p></blockquote><p>å†æ¥çœ‹<code>AbstractContextRefreshedEventListener</code>çš„httpå®ç°<code>SpringMvcClientEventListener</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcClientEventListener extends AbstractContextRefreshedEventListener&lt;Object, ShenyuSpringMvcClient&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;Class&lt;? extends Annotation&gt;&gt; mappingAnnotation = new ArrayList&lt;&gt;(3);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Boolean isFull;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ å‡½æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SpringMvcClientEventListener(final PropertiesConfig clientConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuClientRegisterRepository shenyuClientRegisterRepository) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(clientConfig, shenyuClientRegisterRepository);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = clientConfig.getProps();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å– isFull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isFull = Boolean.parseBoolean(props.getProperty(ShenyuClientConstants.IS_FULL, Boolean.FALSE.toString()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¡¨ç¤ºæ˜¯httpåè®®çš„å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.protocol = props.getProperty(ShenyuClientConstants.PROTOCOL, ShenyuClientConstants.HTTP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        mappingAnnotation.add(RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Map&lt;String, Object&gt; getBeans(final ApplicationContext context) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é…ç½®å±æ€§ï¼Œå¦‚æœ isFull=true çš„è¯ï¼Œè¡¨ç¤ºæ³¨å†Œæ•´ä¸ªå¾®æœåŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(isFull)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(MetaDataRegisterDTO.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .contextPath(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .appName(getAppName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .path(PathUtils.decoratorPathWithSlash(getContextPath()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .rpcType(RpcTypeEnum.HTTP.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .enabled(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ruleName(getContextPath())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦åˆ™è·å–å¸¦Controlleræ³¨è§£çš„bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context.getBeansWithAnnotation(Controller.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ URIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected URIRegisterDTO buildURIRegisterDTO(final ApplicationContext context,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 final Map&lt;String, Object&gt; beans) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String buildApiSuperPath(final Class&lt;?&gt; clazz, @Nullable final ShenyuSpringMvcClient beanShenyuClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰å¸¦ä¸ŠShenyuå®¢æˆ·ç«¯æ³¨è§£ï¼Œåˆ™ä¼˜å…ˆå–æ³¨è§£ä¸­çš„ä¸ä¸ºç©ºçš„pathå±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(beanShenyuClient) &amp;&amp; StringUtils.isNotBlank(beanShenyuClient.path())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return beanShenyuClient.path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæœ‰å¸¦ä¸ŠRequestMappingæ³¨è§£ï¼Œä¸”pathå±æ€§ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›pathæ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(clazz, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(requestMapping) &amp;&amp; ArrayUtils.isNotEmpty(requestMapping.path()) &amp;&amp; StringUtils.isNotBlank(requestMapping.path()[0])) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return requestMapping.path()[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å£°æ˜httpå®ç°çš„å®¢æˆ·ç«¯æ³¨è§£æ˜¯ShenyuSpringMvcClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Class&lt;ShenyuSpringMvcClient&gt; getAnnotationType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuSpringMvcClient.class;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void handleMethod(final Object bean, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @Nullable final ShenyuSpringMvcClient beanShenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final Method method, final String superPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„RequestMappingæ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(method, RequestMapping.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰beançš„ ShenyuSpringMvcClient æ³¨è§£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSpringMvcClient methodShenyuClient = AnnotatedElementUtils.findMergedAnnotation(method, ShenyuSpringMvcClient.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodShenyuClient = Objects.isNull(methodShenyuClient) ? beanShenyuClient : methodShenyuClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœæœ‰ ShenyuSpringMvcClient æ³¨è§£å¹¶ä¸”åŒ…å«RequestMappingæ³¨è§£ï¼ˆè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ¥å£ï¼‰ï¼Œåˆ™è¿›è¡Œæ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(methodShenyuClient) &amp;&amp; Objects.nonNull(requestMapping)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            getPublisher().publishEvent(buildMetaDataDTO(bean, methodShenyuClient, buildApiPath(method, superPath, methodShenyuClient), clazz, method));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ„é€ å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected MetaDataRegisterDTO buildMetaDataDTO(final Object bean,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   @NonNull final ShenyuSpringMvcClient shenyuClient,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final String path, final Class&lt;?&gt; clazz,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   final Method method) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ³¨å†Œé€»è¾‘éƒ½æ˜¯é€šè¿‡ <code>publisher.publishEvent()</code>å®Œæˆã€‚</p><p><code>Controller</code>æ³¨è§£å’Œ<code>RequestMapping</code>æ³¨è§£æ˜¯ç”±<code>Spring</code>æä¾›çš„ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚<code>ShenyuSpringMvcClient</code> æ³¨è§£æ˜¯ç”±<code>Apache ShenYu</code>æä¾›çš„ï¼Œç”¨äºæ³¨å†Œ<code>SpringMvc</code>å®¢æˆ·ç«¯ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * shenyu å®¢æˆ·ç«¯æ¥å£ï¼Œç”¨äºæ–¹æ³•ä¸Šæˆ–ç±»ä¸Š</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ShenyuSpringMvcClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;path&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String value() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path æ³¨å†Œè·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AliasFor(attribute = &quot;value&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String path();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ruleName è§„åˆ™åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ruleName() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // desc æè¿°ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String desc() default &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // enabledæ˜¯å¦å¯ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enabled() default true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // registerMetaData æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean  registerMetaData() default false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å®ƒçš„ä½¿ç”¨å¦‚ä¸‹ï¼š</p><ul><li>æ³¨å†Œæ•´ä¸ªæ¥å£</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/test/**&quot;)  // è¡¨ç¤ºæ•´ä¸ªæ¥å£æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpTestController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>æ³¨å†Œå½“å‰æ–¹æ³•</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShenyuSpringMvcClient(path = &quot;/order&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Save order dto.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param orderDTO the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the order dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/save&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ShenyuSpringMvcClient(path = &quot;/save&quot;, desc = &quot;Save order&quot;) // æ³¨å†Œå½“å‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderDTO save(@RequestBody final OrderDTO orderDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderDTO.setName(&quot;hello world save order&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>publisher.publishEvent() å‘å¸ƒæ³¨å†Œäº‹ä»¶</li></ul><p>è¯¥æ–¹æ³•ä¼šå°†æ•°æ®å‘é€åˆ°<code>Disruptor</code>é˜Ÿåˆ—ä¸­ï¼Œå…³äº<code>Disruptor</code>é˜Ÿåˆ—æ›´å¤šç»†èŠ‚è¿™é‡Œä¸åšæ›´å¤šä»‹ç»ï¼Œè¿™ä¸å½±å“åˆ†ææ³¨å†Œçš„æµç¨‹ã€‚</p><p>å½“æ•°æ®å‘é€åï¼Œ<code>Disruptor</code>é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ä¼šå¤„ç†æ•°æ®ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚</p><ul><li>QueueConsumer æ¶ˆè´¹æ•°æ®</li></ul><p><code>QueueConsumer</code>æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå®ç°äº†<code>WorkHandler</code>æ¥å£ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹åœ¨<code>providerManage.startup()</code>é€»è¾‘ä¸­ã€‚<code>WorkHandler</code>æ¥å£æ˜¯<code>disruptor</code>çš„æ•°æ®æ¶ˆè´¹æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯<code>onEvent()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumer</code>é‡å†™äº†<code>onEvent()</code>æ–¹æ³•ï¼Œä¸»è¦é€»è¾‘æ˜¯ç”Ÿæˆæ¶ˆè´¹ä»»åŠ¡ï¼Œç„¶ååœ¨çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é˜Ÿåˆ—æ¶ˆè´¹è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®äº‹ä»¶ç±»å‹ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡å·¥å‚åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¿å­˜æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ”¾åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code>æ˜¯åœ¨çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå…·ä½“çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼š</p><ul><li><code>RegisterClientConsumerExecutor</code>ï¼šå®¢æˆ·ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼›</li><li><code>RegisterServerConsumerExecutor</code>ï¼šæœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ã€‚</li></ul><p>é¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯ä»»åŠ¡ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ä»»åŠ¡ï¼ˆæœåŠ¡ç«¯å°±æ˜¯<code>admin</code>ï¼Œåœ¨ä¸‹æ–‡è¿›è¡Œåˆ†æï¼‰ã€‚</p><p><img src="/zh/assets/images/consumer-executor-f7ad67d35abaa5a2fac94ef913445a19.png"></p><ul><li>RegisterClientConsumerExecutor æ¶ˆè´¹è€…æ‰§è¡Œå™¨</li></ul><p>é‡å†™çš„<code>run()</code>é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterClientConsumerExecutor&lt;T extends DataTypeParent&gt; extends QueueConsumerExecutor&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final T data = getData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®æ•°æ®ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†å™¨è¿›è¡Œå¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribers.get(data.getType()).executor(Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹è°ƒç”¨ä¸åŒçš„å¤„ç†å™¨å»æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ã€‚æ•°æ®ç±»å‹æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯å…ƒæ•°æ®ï¼Œè®°å½•å®¢æˆ·ç«¯æ³¨å†Œä¿¡æ¯ã€‚ä¸€ä¸ªæ˜¯<code>URI</code>æ•°æ®ï¼Œè®°å½•å®¢æˆ·ç«¯æœåŠ¡ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//æ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public enum DataType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // URIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    URI,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor() æ‰§è¡Œå™¨è®¢é˜…è€…</li></ul><p>æ‰§è¡Œå™¨è®¢é˜…è€…ä¹Ÿåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯å¤„ç†å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ˜¯å¤„ç†<code>URI</code>ã€‚åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥ä¸€å…±æ˜¯å››ä¸ªã€‚</p><p><img src="/zh/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><p>å…ˆçœ‹å…ƒæ•°æ®å¤„ç†</p><ul><li>ShenyuClientMetadataExecutorSubscriber#executor()</li></ul><p>å®¢æˆ·ç«¯è¿™è¾¹å¯¹å…ƒæ•°æ®å¤„ç†é€»è¾‘æ˜¯ï¼šéå†å…ƒæ•°æ®ä¿¡æ¯ï¼Œè°ƒç”¨æ¥å£æ–¹æ³•<code>persistInterface()</code>å®Œæˆæ•°æ®çš„å‘å¸ƒã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientMetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA; // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (MetaDataRegisterDTO metaDataRegisterDTO : metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è°ƒç”¨æ¥å£æ–¹æ³•persistInterface()å®Œæˆæ•°æ®çš„å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistInterface(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterRepository#persistInterface()</li></ul><p><code>ShenyuClientRegisterRepository</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºè¡¨ç¤ºå®¢æˆ·ç«¯æ•°æ®æ³¨å†Œï¼Œå®ƒçš„å®ç°ç±»ç›®å‰æœ‰äº”ç§ï¼Œæ¯ä¸€ç§å°±è¡¨ç¤ºä¸€ç§æ³¨å†Œæ–¹æ³•ã€‚</p><ul><li><code>ConsulClientRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>EtcdClientRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>HttpClientRegisterRepository</code>ï¼šé€šè¿‡<code>Http</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>NacosClientRegisterRepository</code>ï¼šé€šè¿‡<code>Nacos</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li><li><code>ZookeeperClientRegisterRepository</code>ï¼šé€šè¿‡<code>Zookeeper</code>å®ç°å®¢æˆ·ç«¯æ³¨å†Œï¼›</li></ul><p><img src="/zh/assets/images/client-register-repository-61756e3284c1d3a27083b25d393edf9c.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ³¨å†Œä¸­å¿ƒçš„åŠ è½½æ˜¯é€šè¿‡<code>SPI</code>çš„æ–¹å¼å®Œæˆçš„ã€‚è¿™ä¸ªåœ¨å‰é¢æåˆ°è¿‡äº†ï¼Œåœ¨å®¢æˆ·ç«¯é€šç”¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æŒ‡å®šé…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å®Œæˆå…·ä½“çš„ç±»åŠ è½½ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * åŠ è½½ ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuClientRegisterRepositoryFactory {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Map&lt;String, ShenyuClientRegisterRepository&gt; REPOSITORY_MAP = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»º ShenyuClientRegisterRepository</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuClientRegisterRepository newInstance(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!REPOSITORY_MAP.containsKey(shenyuRegisterCenterConfig.getRegisterType())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡SPIçš„æ–¹å¼è¿›è¡ŒåŠ è½½ï¼Œç±»å‹ç”±registerTypeå†³å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientRegisterRepository result = ExtensionLoader.getExtensionLoader(ShenyuClientRegisterRepository.class).getJoin(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.init(shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.set(result, shenyuRegisterCenterConfig.getProps());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            REPOSITORY_MAP.put(shenyuRegisterCenterConfig.getRegisterType(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return REPOSITORY_MAP.get(shenyuRegisterCenterConfig.getRegisterType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ¬æ–‡çš„æºç åˆ†ææ˜¯åŸºäº<code>Http</code>çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ†æ<code>HttpClientRegisterRepository</code>ï¼Œå…¶ä»–çš„æ³¨å†Œæ–¹å¼åç»­å†åˆ†æã€‚<code>HttpClientRegisterRepository</code>ç»§æ‰¿äº†<code>FailbackRegistryRepository</code>ï¼Œè€Œ<code>FailbackRegistryRepository</code>æœ¬èº«ä¸»è¦ç”¨äºå¯¹<code>Http</code>æ³¨å†Œè¿‡ç¨‹ä¸­çš„å¤±è´¥å¼‚å¸¸çš„å¤„ç†ï¼Œè¿™é‡Œå°±çœç•¥äº†ã€‚</p><p>é€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œå¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨å·¥å…·ç±»å‘é€<code>http</code>è¯·æ±‚ã€‚æ³¨å†Œå…ƒæ•°æ®å’ŒURIéƒ½æ˜¯è°ƒç”¨çš„åŒä¸€ä¸ªæ–¹æ³•<code>doRegister()</code>ï¼ŒæŒ‡å®šæ¥å£å’Œç±»å‹å°±å¥½ã€‚</p><ul><li><code>Constants.URI_PATH</code>çš„å€¼<code>/shenyu-client/register-metadata</code>ï¼šæœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†Œå…ƒæ•°æ®ã€‚</li><li><code>Constants.META_PATH</code>çš„å€¼<code>/shenyu-client/register-uri</code>ï¼š    æœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†ŒURIã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpClientRegisterRepository extends FailbackRegistryRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientRegisterRepository.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static URIRegisterDTO uriRegisterDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;String&gt; serverList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpClientRegisterRepository(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        init(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminçš„ç”¨æˆ·å</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = config.getProps().getProperty(Constants.USER_NAME);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminçš„ç”¨æˆ·åå¯¹åº”çš„å¯†ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = config.getProps().getProperty(Constants.PASS_WORD);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // adminæœåŠ¡åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(config.getServerLists()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®è®¿é—®çš„token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Persist uri.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param registerDTO the register dto</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistURI(final URIRegisterDTO registerDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RuntimeUtils.listenByOther(registerDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(registerDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uriRegisterDTO = registerDTO;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doPersistInterface(final MetaDataRegisterDTO metadata) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegister(metadata, Constants.META_PATH, Constants.META_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uriRegisterDTO != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            uriRegisterDTO.setEventType(EventType.DELETED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            doRegister(uriRegisterDTO, Constants.URI_PATH, Constants.URI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setAccessToken() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Optional&lt;?&gt; login = RegisterUtils.doLogin(username, password, server.concat(Constants.LOGIN_PATH));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                login.ifPresent(v -&gt; this.accessToken = String.valueOf(v));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Login admin url :{} is fail, will retry. cause: {} &quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void doRegister(final T t, final String path, final String type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†adminæœåŠ¡åˆ—è¡¨ï¼ˆadminå¯èƒ½æ˜¯é›†ç¾¤ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String server : serverList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            i++;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String concat = server.concat(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è®¾ç½®è®¿é—®token</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.setAccessToken();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (StringUtils.isBlank(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new NullPointerException(&quot;accessToken is null&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è°ƒç”¨å·¥å…·ç±»å‘é€ http è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RegisterUtils.doRegister(GsonUtils.getInstance().toJson(t), concat, type, accessToken);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Register admin url :{} is fail, will retry. cause:{}&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (i == serverList.size()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException(e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å°†æ•°æ®åºåˆ—åŒ–åï¼Œé€šè¿‡<code>OkHttp</code>å‘é€æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //...... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€šè¿‡OkHttpå‘é€æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void doRegister(final String json, final String url, final String type) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasLength(accessToken)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error accessToken is null, please check the config : {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Headers headers = new Headers.Builder().add(Constants.X_ACCESS_TOKEN, accessToken).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String result = OkHttpTools.getInstance().post(url, json, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.equals(SUCCESS, result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;{} client register success: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;{} client register error: {} &quot;, type, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ï¼Œå®¢æˆ·ç«¯é€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œå…ƒæ•°æ®çš„é€»è¾‘å°±åˆ†æå®Œäº†ã€‚å°ç»“ä¸€ä¸‹ï¼šé€šè¿‡è¯»å–è‡ªå®šä¹‰çš„æ³¨è§£ä¿¡æ¯æ„é€ å…ƒæ•°æ®ï¼Œå°†æ•°æ®å‘åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œç„¶åä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ•°æ®ï¼Œå°†æ¶ˆè´¹è€…æ”¾åˆ°çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œï¼Œæœ€ç»ˆé€šè¿‡å‘é€<code>http</code>è¯·æ±‚åˆ°<code>admin</code>ã€‚</p><p>å†æ¥çœ‹çœ‹ <code>URI</code> æ•°æ®çš„å¤„ç†</p><ul><li>ShenyuClientURIExecutorSubscriber#executor()</li></ul><p>ä¸»è¦é€»è¾‘æ˜¯éå†URIæ•°æ®é›†åˆï¼Œé€šè¿‡<code>persistURI()</code>æ–¹æ³•å®ç°æ•°æ®æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientURIExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; //æ•°æ®ç±»å‹æ˜¯URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨å†ŒURIæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (URIRegisterDTO uriRegisterDTO : dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Stopwatch stopwatch = Stopwatch.createStarted();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (true) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (Socket ignored = new Socket(uriRegisterDTO.getHost(), uriRegisterDTO.getPort())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long sleepTime = 1000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // maybe the port is delay exposed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 5) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOG.error(&quot;host:{}, port:{} connection failed, will retry&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                uriRegisterDTO.getHost(), uriRegisterDTO.getPort());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // If the connection fails for a long time, Increase sleep time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (stopwatch.elapsed(TimeUnit.SECONDS) &gt; 180) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sleepTime = 10000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TimeUnit.MILLISECONDS.sleep(sleepTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ex.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æ·»åŠ hookï¼Œä¼˜é›…åœæ­¢å®¢æˆ·ç«¯ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuClientShutdownHook.delayOtherHooks();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            shenyuClientRegisterRepository.persistURI(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»£ç ä¸­çš„<code>while(true)</code>å¾ªç¯æ˜¯ä¸ºäº†ä¿è¯å®¢æˆ·ç«¯å·²ç»æˆåŠŸå¯åŠ¨äº†ï¼Œé€šè¿‡<code>host</code>å’Œ<code>port</code>å¯ä»¥è¿æ¥ä¸Šã€‚</p><p>åé¢çš„é€»è¾‘æ˜¯ï¼šæ·»åŠ <code>hook</code>å‡½æ•°ï¼Œç”¨äºä¼˜é›…åœæ­¢å®¢æˆ·ç«¯ ã€‚</p><p>é€šè¿‡<code>persistURI()</code>æ–¹æ³•å®ç°æ•°æ®æ³¨å†Œã€‚æ•´ä¸ªé€»è¾‘ä¹Ÿåœ¨å‰é¢åˆ†æè¿‡äº†ï¼Œæœ€ç»ˆå°±æ˜¯é€šè¿‡<code>OkHttp</code>å®¢æˆ·ç«¯å‘<code>shenyu-admin</code>å‘èµ·<code>http</code>ï¼Œé€šè¿‡<code>http</code>çš„æ–¹å¼æ³¨å†Œ<code>URI</code>ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œå°±å°†å®¢æˆ·ç«¯çš„æ³¨å†Œé€»è¾‘åˆ†æå®Œäº†ï¼Œå°†æ„å»ºçš„å…ƒæ•°æ®å’ŒURIæ•°æ®å‘é€åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œå†ä»ä¸­æ¶ˆè´¹ï¼Œè¯»å–æ•°æ®ï¼Œé€šè¿‡<code>http</code>å‘<code>admin</code>å‘é€æ•°æ®ã€‚</p><p>å®¢æˆ·ç«¯<code>å…ƒæ•°æ®</code>å’Œ<code>URI</code>æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œæˆäº†ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/client-metadata-uri-register-zh-a7094099a530101dee93b172a1bc0254.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-æœåŠ¡ç«¯æ³¨å†Œæµç¨‹"></a>3. æœåŠ¡ç«¯æ³¨å†Œæµç¨‹<a class="hash-link" href="#3-æœåŠ¡ç«¯æ³¨å†Œæµç¨‹" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-æ³¨å†Œæ¥å£shenyuclienthttpregistrycontroller"></a>3.1 æ³¨å†Œæ¥å£ShenyuClientHttpRegistryController<a class="hash-link" href="#31-æ³¨å†Œæ¥å£shenyuclienthttpregistrycontroller" title="Direct link to heading">#</a></h4><p>ä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼ŒæœåŠ¡ç«¯æä¾›äº†æ³¨å†Œçš„ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li><code>/shenyu-client/register-metadata</code>ï¼šæœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†Œå…ƒæ•°æ®ã€‚</li><li><code>/shenyu-client/register-uri</code>ï¼š    æœåŠ¡ç«¯æä¾›çš„æ¥å£ç”¨äºæ³¨å†ŒURIã€‚</li></ul><p>è¿™ä¸¤ä¸ªæ¥å£ä½äº<code>ShenyuClientHttpRegistryController</code>ä¸­ï¼Œå®ƒå®ç°äº†<code>ShenyuClientServerRegisterRepository</code>æ¥å£ï¼Œæ˜¯æœåŠ¡ç«¯æ³¨å†Œçš„å®ç°ç±»ã€‚å®ƒç”¨<code>@Join</code>æ ‡è®°ï¼Œè¡¨ç¤ºé€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// shenuyuå®¢æˆ·ç«¯æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/shenyu-client&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuClientHttpRegistryController implements ShenyuClientServerRegisterRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuClientServerRegisterPublisher publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(final ShenyuClientServerRegisterPublisher publisher, final ShenyuRegisterCenterConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.publisher = publisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ³¨å†Œå…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-metadata&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerMetadata(@RequestBody final MetaDataRegisterDTO metaDataRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(metaDataRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // æ³¨å†ŒURI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register-uri&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseBody</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String registerURI(@RequestBody final URIRegisterDTO uriRegisterDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.publish(uriRegisterDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸¤ä¸ªæ³¨å†Œæ¥å£è·å–åˆ°æ•°æ®å¥½ï¼Œå°±è°ƒç”¨äº†<code>publisher.publish()</code>æ–¹æ³•ï¼ŒæŠŠæ•°æ®å‘å¸ƒåˆ°<code>Disruptor</code>é˜Ÿåˆ—ä¸­ã€‚</p><ul><li><code>ShenyuClientServerRegisterRepository</code>æ¥å£</li></ul><p><code>ShenyuClientServerRegisterRepository</code>æ¥å£æ˜¯æœåŠ¡æ³¨å†Œæ¥å£ï¼Œå®ƒæœ‰äº”ä¸ªå®ç°ç±»ï¼Œè¡¨ç¤ºæœ‰äº”ç§æ³¨å†Œæ–¹å¼ï¼š</p><ul><li><code>ConsulClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Consul</code>å®ç°æ³¨å†Œ;</li><li><code>EtcdClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Etcd</code>å®ç°æ³¨å†Œï¼›</li><li><code>NacosClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Nacos</code>å®ç°æ³¨å†Œï¼›</li><li><code>ShenyuClientHttpRegistryController</code>ï¼šé€šè¿‡<code>Http</code>å®ç°æ³¨å†Œï¼›</li><li><code>ZookeeperClientServerRegisterRepository</code>ï¼šé€šè¿‡<code>Zookeeper</code>å®ç°æ³¨å†Œã€‚</li></ul><p>å…·ä½“ç”¨å“ªä¸€ç§æ–¹å¼ï¼Œæ˜¯é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šçš„ï¼Œç„¶åé€šè¿‡<code>SPI</code>è¿›è¡ŒåŠ è½½ã€‚</p><p>åœ¨<code>shenyu-admin</code>ä¸­çš„<code>application.yml</code>æ–‡ä»¶ä¸­é…ç½®æ³¨å†Œæ–¹å¼ï¼Œ<code>registerType</code>æŒ‡å®šæ³¨å†Œç±»å‹ï¼Œå½“ç”¨<code>http</code>è¿›è¡Œæ³¨å†Œæ—¶ï¼Œ<code>serverLists</code>ä¸éœ€è¦å¡«å†™ï¼Œæ›´å¤šé…ç½®è¯´æ˜å¯ä»¥å‚è€ƒå®˜ç½‘  <a href="https://shenyu.apache.org/zh/docs/user-guide/property-config/register-center-access" target="_blank" rel="noopener noreferrer">å®¢æˆ·ç«¯æ¥å…¥é…ç½®</a> ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">register</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registerType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverLists</span><span class="token punctuation" style="color:#393A34">:</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>RegisterCenterConfiguration åŠ è½½é…ç½®</li></ul><p>åœ¨å¼•å…¥ç›¸å…³ä¾èµ–å’Œå±æ€§é…ç½®åï¼Œå¯åŠ¨<code>shenyu-admin</code>æ—¶ï¼Œä¼šå…ˆåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå’Œæ³¨å†Œä¸­å¿ƒç›¸å…³çš„é…ç½®æ–‡ä»¶ç±»æ˜¯<code>RegisterCenterConfiguration</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// æ³¨å†Œä¸­å¿ƒé…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterCenterConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¯»å–é…ç½®å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.register&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuRegisterCenterConfig shenyuRegisterCenterConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuRegisterCenterConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åˆ›å»ºShenyuServerRegisterRepositoryï¼Œç”¨äºæœåŠ¡ç«¯æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuServerRegisterRepository shenyuServerRegisterRepository(final ShenyuRegisterCenterConfig shenyuRegisterCenterConfig, final List&lt;ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.ä»é…ç½®å±æ€§ä¸­è·å–æ³¨å†Œç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String registerType = shenyuRegisterCenterConfig.getRegisterType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.é€šè¿‡æ³¨å†Œç±»å‹ï¼Œä»¥SPIçš„æ–¹æ³•åŠ è½½å®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuClientServerRegisterRepository registerRepository = ExtensionLoader.getExtensionLoader(ShenyuClientServerRegisterRepository.class).getJoin(registerType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.è·å–publisherï¼Œå‘Disruptoré˜Ÿåˆ—ä¸­å†™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterClientServerDisruptorPublisher publisher = RegisterClientServerDisruptorPublisher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.æ³¨å†ŒServiceï¼Œ rpcType -&gt; registerService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuClientRegisterService&gt; registerServiceMap = shenyuClientRegisterService.stream().collect(Collectors.toMap(ShenyuClientRegisterService::rpcType, e -&gt; e));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5.äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.start(registerServiceMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6.æ³¨å†Œçš„åˆå§‹åŒ–æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRepository.init(publisher, shenyuRegisterCenterConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerRepository;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨é…ç½®ç±»ä¸­ç”Ÿæˆäº†ä¸¤ä¸ª<code>bean</code>ï¼š</p><ul><li><p><code>shenyuRegisterCenterConfig</code>ï¼šè¯»å–å±æ€§é…ç½®ï¼›</p></li><li><p><code>shenyuClientServerRegisterRepository</code>ï¼šç”¨äºæœåŠ¡ç«¯æ³¨å†Œã€‚</p></li></ul><p>åœ¨åˆ›å»º<code>shenyuClientServerRegisterRepository</code>çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè¿›è¡Œäº†ä¸€ç³»åˆ—çš„å‡†å¤‡å·¥ä½œï¼š</p><ul><li>1.ä»é…ç½®å±æ€§ä¸­è·å–æ³¨å†Œç±»å‹ã€‚</li><li>2.é€šè¿‡æ³¨å†Œç±»å‹ï¼Œä»¥<code>SPI</code>çš„æ–¹æ³•åŠ è½½å®ç°ç±»ï¼šæ¯”å¦‚æŒ‡å®šçš„ç±»å‹æ˜¯<code>http</code>ï¼Œå°±ä¼šåŠ è½½<code>ShenyuClientHttpRegistryController</code>ã€‚</li><li>3.è·å–<code>publisher</code>ï¼Œå‘<code>Disruptor</code>é˜Ÿåˆ—ä¸­å†™æ•°æ®ã€‚</li><li>4.æ³¨å†Œ<code>Service</code>ï¼Œ <code>rpcType -&gt; registerService</code>ï¼šè·å–æ³¨å†Œçš„<code>Service</code>ï¼Œæ¯ç§<code>rpc</code>éƒ½æœ‰å¯¹åº”çš„<code>Service</code>ã€‚æœ¬æ–‡çš„å®¢æˆ·ç«¯æ„å»ºæ˜¯é€šè¿‡<code>springboot</code>ï¼Œå±äº<code>http</code>ç±»å‹ï¼Œè¿˜æœ‰å…¶ä»–å®¢æˆ·ç«¯ç±»å‹ï¼š<code>dubbo</code>ï¼Œ<code>Spring Cloud</code>ï¼Œ<code>gRPC</code>ç­‰ã€‚</li><li>5.äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œï¼šæ·»åŠ æœåŠ¡ç«¯å…ƒæ•°æ®å’Œ<code>URI</code>è®¢é˜…å™¨ï¼Œå¤„ç†æ•°æ®ã€‚å¹¶ä¸”å¯åŠ¨<code>Disruptor</code>é˜Ÿåˆ—ã€‚</li><li>6.æ³¨å†Œçš„åˆå§‹åŒ–æ“ä½œï¼š<code>http</code>ç±»å‹çš„æ³¨å†Œåˆå§‹åŒ–æ“ä½œå°±æ˜¯ä¿å­˜<code>publisher</code>ã€‚</li></ul><ul><li>RegisterServerDisruptorPublisher#publish()</li></ul><p>æœåŠ¡ç«¯å‘<code>Disruptor</code>é˜Ÿåˆ—å†™å…¥æ•°æ®çš„å‘å¸ƒè€… ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼æ„å»ºã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterClientServerDisruptorPublisher implements ShenyuClientServerRegisterPublisher {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ç§æœ‰å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final RegisterClientServerDisruptorPublisher INSTANCE = new RegisterClientServerDisruptorPublisher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DisruptorProviderManage&lt;Collection&lt;DataTypeParent&gt;&gt; providerManage;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //å…¬å¼€é™æ€æ–¹æ³•è·å–å®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static RegisterServerDisruptorPublisher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //äº‹ä»¶å‘å¸ƒçš„å‡†å¤‡å·¥ä½œï¼Œæ·»åŠ æœåŠ¡ç«¯å…ƒæ•°æ®å’ŒURIè®¢é˜…å™¨ï¼Œå¤„ç†æ•°æ®ã€‚å¹¶ä¸”å¯åŠ¨Disruptoré˜Ÿåˆ—ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void start(final Map&lt;String, ShenyuClientRegisterService&gt; shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æœåŠ¡ç«¯æ³¨å†Œå·¥å‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterServerExecutorFactory factory = new RegisterServerExecutorFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ·»åŠ URIæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new URIRegisterExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ·»åŠ å…ƒæ•°æ®è®¢é˜…å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.addSubscribers(new MetadataExecutorSubscriber(shenyuClientRegisterService));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¯åŠ¨Disruptoré˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage = new DisruptorProviderManage(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.startup();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final DataTypeParent data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(Collections.singleton(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰¹é‡å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void publish(final Collection&lt;? extends DataTypeParent&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisruptorProvider&lt;Collection&lt;DataTypeParent&gt;&gt; provider = providerManage.getProvider();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        provider.onData(dataList.stream().map(DataTypeParent.class::cast).collect(Collectors.toList()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        providerManage.getProvider().shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é…ç½®æ–‡ä»¶çš„åŠ è½½ï¼Œå¯çœ‹ä½œæ˜¯æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯åˆå§‹åŒ–æµç¨‹ï¼Œç”¨å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-register-init-zh-f459729f048f19f89b7eaa023ae4b4e8.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-æ¶ˆè´¹æ•°æ®queueconsumer"></a>3.2 æ¶ˆè´¹æ•°æ®QueueConsumer<a class="hash-link" href="#32-æ¶ˆè´¹æ•°æ®queueconsumer" title="Direct link to heading">#</a></h4><p>åœ¨å‰é¢åˆ†æäº†å®¢æˆ·ç«¯<code>disruptor</code>é˜Ÿåˆ—æ¶ˆè´¹æ•°æ®çš„è¿‡ã€‚æœåŠ¡ç«¯ä¹Ÿæ˜¯ä¸€æ ·çš„é€»è¾‘ï¼Œåªæ˜¯å…¶ä¸­æ‰§è¡Œä»»åŠ¡çš„æ‰§è¡Œè€…å˜äº†ã€‚</p><p><code>QueueConsumer</code>æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒå®ç°äº†<code>WorkHandler</code>æ¥å£ï¼Œå®ƒçš„åˆ›å»ºè¿‡ç¨‹åœ¨<code>providerManage.startup()</code>é€»è¾‘ä¸­ã€‚<code>WorkHandler</code>æ¥å£æ˜¯<code>disruptor</code>çš„æ•°æ®æ¶ˆè´¹æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯<code>onEvent()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">package com.lmax.disruptor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface WorkHandler&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onEvent(T event) throws Exception;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumer</code>é‡å†™äº†<code>onEvent()</code>æ–¹æ³•ï¼Œä¸»è¦é€»è¾‘æ˜¯ç”Ÿæˆæ¶ˆè´¹ä»»åŠ¡ï¼Œç„¶ååœ¨çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é˜Ÿåˆ—æ¶ˆè´¹è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class QueueConsumer&lt;T&gt; implements WorkHandler&lt;DataEvent&lt;T&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onEvent(final DataEvent&lt;T&gt; t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (t != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®äº‹ä»¶ç±»å‹è·å–ç›¸åº”çš„çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadPoolExecutor executor = orderly(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šè¿‡å·¥å‚åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            QueueConsumerExecutor&lt;T&gt; queueConsumerExecutor = factory.create();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¿å­˜æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueConsumerExecutor.setData(t.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // help gc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setData(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ”¾åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ æ¶ˆè´¹ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.execute(queueConsumerExecutor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>QueueConsumerExecutor</code>æ˜¯åœ¨çº¿ç¨‹æ± ä¸­è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå…·ä½“çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼š</p><ul><li><code>RegisterClientConsumerExecutor</code>ï¼šå®¢æˆ·ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼›</li><li><code>RegisterServerConsumerExecutor</code>ï¼šæœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ã€‚</li></ul><p>é¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯ä»»åŠ¡ï¼Œä¸€ä¸ªè´Ÿè´£å¤„ç†æœåŠ¡ç«¯ä»»åŠ¡ã€‚</p><ul><li><code>RegisterServerConsumerExecutor#run()</code></li></ul><p><code>RegisterServerConsumerExecutor</code>æ˜¯æœåŠ¡ç«¯æ¶ˆè´¹è€…æ‰§è¡Œå™¨ï¼Œå®ƒé€šè¿‡<code>QueueConsumerExecutor</code>é—´æ¥å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œå¹¶é‡å†™äº†<code>run()</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RegisterServerConsumerExecutor extends QueueConsumerExecutor&lt;Collection&lt;DataTypeParent&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   // ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è·å–ä»disruptoré˜Ÿåˆ—ä¸­æ‹¿åˆ°çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;DataTypeParent&gt; results = getData()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(this::isValidData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(results)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ ¹æ®ç±»å‹æ‰§è¡Œæ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectExecutor(results).executor(results);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ ¹æ®ç±»å‹è·å–è®¢é˜…è€…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ExecutorSubscriber&lt;DataTypeParent&gt; selectExecutor(final Collection&lt;DataTypeParent&gt; list) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Optional&lt;DataTypeParent&gt; first = list.stream().findFirst();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return subscribers.get(first.orElseThrow(() -&gt; new RuntimeException(&quot;the data type is not found&quot;)).getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ExecutorSubscriber#executor()</li></ul><p>æ‰§è¡Œå™¨è®¢é˜…è€…åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯å¤„ç†å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ˜¯å¤„ç†<code>URI</code>ã€‚åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥ä¸€å…±æ˜¯å››ä¸ªã€‚</p><p><img src="/zh/assets/images/executor-subscriber-86d5645d204ad1d05fe12dd30992c8d1.png"></p><ul><li>MetadataExecutorSubscriber#executor()</li></ul><p>å¦‚æœæ˜¯æ³¨å†Œå…ƒæ•°æ®ï¼Œåˆ™é€šè¿‡<code>MetadataExecutorSubscriber#executor()</code>å®ç°ï¼šæ ¹æ®ç±»å‹è·å–æ³¨å†Œ<code>Service</code>ï¼Œè°ƒç”¨<code>register()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class MetadataExecutorSubscriber implements ExecutorTypeSubscriber&lt;MetaDataRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.META_DATA;  // å…ƒæ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;MetaDataRegisterDTO&gt; metaDataRegisterDTOList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†å…ƒæ•°æ®åˆ—è¡¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataRegisterDTOList.forEach(meta -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(this.shenyuClientRegisterService.get(meta.getRpcType())) // æ ¹æ®ç±»å‹è·å–æ³¨å†ŒService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(shenyuClientRegisterService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // å¯¹å…ƒæ•°æ®è¿›è¡Œæ³¨å†Œï¼ŒåŠ é”ç¡®ä¿é¡ºåºæ‰§è¡Œï¼Œé˜²æ­¢å¹¶å‘é”™è¯¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        synchronized (shenyuClientRegisterService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            shenyuClientRegisterService.register(meta);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>URIRegisterExecutorSubscriber#executor()</li></ul><p>å¦‚æœæ˜¯æ³¨å†Œå…ƒæ•°æ®ï¼Œåˆ™é€šè¿‡<code>URIRegisterExecutorSubscriber#executor()</code>å®ç°ï¼šæ„å»º<code>URI</code>æ•°æ®ï¼Œæ ¹æ®æ³¨å†Œç±»å‹æŸ¥æ‰¾<code>Serviceï¼Œ</code>é€šè¿‡<code>registerURI</code>æ–¹æ³•å®ç°æ³¨å†Œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class URIRegisterExecutorSubscriber implements ExecutorTypeSubscriber&lt;URIRegisterDTO&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataType getType() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataType.URI; // URIæ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final Collection&lt;URIRegisterDTO&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®rpcè°ƒç”¨ç±»å‹èšé›†æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; groupByRpcType = dataList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(data -&gt; StringUtils.isNotBlank(data.getRpcType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.groupingBy(URIRegisterDTO::getRpcType));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Map.Entry&lt;String, List&lt;URIRegisterDTO&gt;&gt; entry : groupByRpcType.entrySet()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final String rpcType = entry.getKey();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®ç±»å‹æŸ¥æ‰¾Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Optional.ofNullable(shenyuClientRegisterService.get(rpcType))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .ifPresent(service -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final List&lt;URIRegisterDTO&gt; list = entry.getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // æ„å»ºURIæ•°æ®ç±»å‹ï¼Œé€šè¿‡registerURIæ–¹æ³•å®ç°æ³¨å†Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Map&lt;String, List&lt;URIRegisterDTO&gt;&gt; listMap = buildData(list);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        listMap.forEach(service::registerURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuClientRegisterService#register()</li></ul><p><code>ShenyuClientRegisterService</code>æ˜¯æ³¨å†Œæ–¹æ³•æ¥å£ï¼Œå®ƒæœ‰å¤šä¸ªå®ç°ç±»ï¼š</p><p><img src="/zh/assets/images/client-register-service-949e3110cb57db2f250dafdc41446eb4.png"></p><ul><li><code>AbstractContextPathRegisterService</code>ï¼šæŠ½è±¡ç±»ï¼Œå¤„ç†éƒ¨åˆ†å…¬å…±é€»è¾‘ï¼›</li><li><code>AbstractShenyuClientRegisterServiceImpl</code>ï¼šï¼šæŠ½è±¡ç±»ï¼Œå¤„ç†éƒ¨åˆ†å…¬å…±é€»è¾‘ï¼›</li><li><code>ShenyuClientRegisterDivideServiceImpl</code>ï¼š<code>divide</code>ç±»ï¼Œå¤„ç†<code>http</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterDubboServiceImpl</code>ï¼š<code>dubbo</code>ç±»ï¼Œå¤„ç†<code>dubbo</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterGrpcServiceImpl</code>ï¼š<code>gRPC</code>ç±»ï¼Œå¤„ç†<code>gRPC</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterMotanServiceImpl</code>ï¼š<code>Motan</code>ç±»ï¼Œå¤„ç†<code>Motan</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterSofaServiceImpl</code>ï¼š<code>Sofa</code>ç±»ï¼Œå¤„ç†<code>Sofa</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterSpringCloudServiceImpl</code>ï¼š<code>SpringCloud</code>ç±»ï¼Œå¤„ç†<code>SpringCloud</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterTarsServiceImpl</code>ï¼š<code>Tars</code>ç±»ï¼Œå¤„ç†<code>Tars</code>æ³¨å†Œç±»å‹ï¼›</li><li><code>ShenyuClientRegisterWebSocketServiceImpl</code>ï¼š<code>Websocket</code>ç±»ï¼Œå¤„ç†<code>Websocket</code>æ³¨å†Œç±»å‹ï¼›</li></ul><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¯ç§å¾®æœåŠ¡éƒ½æœ‰å¯¹åº”çš„æ³¨å†Œå®ç°ç±»ï¼Œæœ¬æ–‡çš„æºç åˆ†ææ˜¯ ä»¥å®˜æ–¹æä¾›çš„ <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-examples/shenyu-examples-http" target="_blank" rel="noopener noreferrer">shenyu-examples-http</a> ä¸ºä¾‹ï¼Œæ˜¯å±<code>http</code>æ³¨å†Œç±»å‹ï¼Œæ‰€ä»¥å…ƒæ•°æ®å’ŒURIæ•°æ®çš„æ³¨å†Œå®ç°ç±»æ˜¯ <code>ShenyuClientRegisterDivideServiceImpl</code>ï¼š</p><ul><li>register(): æ³¨å†Œå…ƒæ•°æ®</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String register(final MetaDataRegisterDTO dto) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.æ³¨å†Œé€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorHandler = selectorHandler(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorId = selectorService.registerDefault(dto, PluginNameAdapter.rpcTypeAdapter(rpcType()), selectorHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.æ³¨å†Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String ruleHandler = ruleHandler();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RuleDTO ruleDTO = buildRpcDefaultRuleDTO(selectorId, dto, ruleHandler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ruleService.registerDefault(ruleDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.æ³¨å†Œå…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerMetadata(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.æ³¨å†ŒcontextPath</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String contextPath = dto.getContextPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotEmpty(contextPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerContextPath(dto);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ•´ä¸ªæ³¨å†Œé€»è¾‘å¯ä»¥åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼š</p><ul><li>1.æ³¨å†Œé€‰æ‹©å™¨ä¿¡æ¯</li><li>2.æ³¨å†Œè§„åˆ™ä¿¡æ¯</li><li>3.æ³¨å†Œå…ƒæ•°æ®ä¿¡æ¯</li><li>4.æ³¨å†Œ<code>contextPath</code></li></ul><p>åœ¨<code>admin</code>è¿™ä¸€ä¾§é€šè¿‡å®¢æˆ·ç«¯çš„å…ƒæ•°æ®ä¿¡æ¯éœ€è¦æ„å»ºé€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œ<code>ContextPath</code>ã€‚å…·ä½“çš„æ³¨å†Œè¿‡ç¨‹å’Œç»†èŠ‚å¤„ç†è·Ÿ<code>rpc</code>ç±»å‹æœ‰å…³ã€‚æˆ‘ä»¬å°±ä¸å†ç»§ç»­å‘ä¸‹è¿½è¸ªäº†ï¼Œå¯¹äºæ³¨å†Œä¸­å¿ƒçš„é€»è¾‘åˆ†æï¼Œè·Ÿè¸ªåˆ°è¿™é‡Œå°±å¤Ÿäº†ã€‚</p><p>æœåŠ¡ç«¯å…ƒæ•°æ®æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œäº†ï¼Œæµç¨‹å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-metadata-register-zh-1b1d9d30b0f3c8fedc59d9a82ab24896.png"></p><ul><li>registerURI(): æ³¨å†Œ<code>URI</code>æ•°æ®</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractShenyuClientRegisterServiceImpl extends FallbackShenyuClientRegisterService implements ShenyuClientRegisterService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String doRegisterURI(final String selectorName, final List&lt;URIRegisterDTO&gt; uriList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(uriList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¯¹åº”çš„é€‰æ‹©å™¨æ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = selectorService.findByNameAndPluginName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(selectorDO)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(&quot;doRegister Failed to execute,wait to retry.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;URIRegisterDTO&gt; validUriList = uriList.stream().filter(dto -&gt; Objects.nonNull(dto.getPort()) &amp;&amp; StringUtils.isNotBlank(dto.getHost())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¤„ç†é€‰æ‹©å™¨ä¸­çš„handlerä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String handler = buildHandle(validUriList, selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDO.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SelectorData selectorData = selectorService.buildByName(selectorName, PluginNameAdapter.rpcTypeAdapter(rpcType()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorData.setHandle(handler);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®åº“ä¸­çš„è®°å½•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorService.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE, Collections.singletonList(selectorData)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuResultMessage.SUCCESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>admin</code>æ‹¿åˆ°<code>URI</code>æ•°æ®åï¼Œä¸»è¦æ˜¯æ›´æ–°é€‰æ‹©å™¨ä¸­çš„<code>handler</code>ä¿¡æ¯ï¼Œç„¶åå†™å…¥åˆ°æ•°æ®åº“ï¼Œæœ€åå‘å¸ƒäº‹ä»¶é€šçŸ¥ç½‘å…³ã€‚é€šçŸ¥ç½‘å…³çš„é€»è¾‘æ˜¯ç”±æ•°æ®åŒæ­¥æ“ä½œå®Œæˆï¼Œè¿™åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å·²ç»åˆ†æè¿‡äº†ï¼Œå°±ä¸å†èµ˜è¿°ã€‚</p><p>æœåŠ¡ç«¯<code>URI</code>æ³¨å†Œæµç¨‹çš„æºç åˆ†æå®Œæˆäº†ï¼Œç”¨å›¾æè¿°å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/server-uri-register-zh-4d956ca81d252f021f22e8a28d15bf2d.png"></p><p>è‡³æ­¤ï¼ŒæœåŠ¡ç«¯æ³¨å†Œæµç¨‹ä¹Ÿå°±åˆ†æå®Œäº†ï¼Œä¸»è¦é€šè¿‡å¯¹å¤–æä¾›çš„æ¥å£ï¼Œæ¥å—å®¢æˆ·ç«¯çš„æ³¨å†Œä¿¡æ¯ï¼Œç„¶åå†™å…¥åˆ°<code>Disruptor</code>é˜Ÿåˆ—ï¼Œå†ä»ä¸­æ¶ˆè´¹æ•°æ®ï¼Œæ ¹æ®æ¥æ”¶åˆ°çš„å…ƒæ•°æ®å’Œ<code>URI</code>æ•°æ®æ›´æ–°<code>admin</code>çš„é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œé€‰æ‹©å™¨çš„<code>handler</code>ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-æ€»ç»“"></a>4. æ€»ç»“<a class="hash-link" href="#4-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡ä¸»è¦å¯¹<code>Apache ShenYu</code>ç½‘å…³ä¸­çš„<code>httpæ³¨å†Œ</code>æ¨¡å—è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼Œå½’çº³å¦‚ä¸‹ï¼š</p><ul><li>æ³¨å†Œä¸­å¿ƒæ˜¯ä¸ºäº†å°†å®¢æˆ·ç«¯ä¿¡æ¯æ³¨å†Œåˆ°<code>admin</code>ï¼Œæ–¹ä¾¿æµé‡ç­›é€‰ï¼›</li><li><code>http</code>æ³¨å†Œæ˜¯å°†å®¢æˆ·ç«¯å…ƒæ•°æ®ä¿¡æ¯å’Œ<code>URI</code>ä¿¡æ¯æ³¨å†Œåˆ°<code>admin</code>ï¼›</li><li><code>http</code>æœåŠ¡çš„æ¥å…¥é€šè¿‡æ³¨è§£<code>@ShenyuSpringMvcClient</code>æ ‡è¯†ï¼›</li><li>æ³¨å†Œä¿¡æ¯çš„æ„å»ºä¸»è¦é€šè¿‡<code>Spring</code>åº”ç”¨ç›‘å¬å™¨<code>ApplicationListener</code>ï¼›</li><li>æ³¨å†Œç±»å‹çš„åŠ è½½é€šè¿‡<code>SPI</code>å®Œæˆï¼›</li><li>å¼•å…¥<code>Disruptor</code>é˜Ÿåˆ—æ˜¯ä¸ºäº†æ•°æ®ä¸æ“ä½œè§£è€¦ï¼Œä»¥åŠæ•°æ®ç¼“å†²ã€‚</li><li>æ³¨å†Œä¸­å¿ƒçš„å®ç°é‡‡ç”¨äº†é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä½¿ç”¨æ¨¡æ¿æ–¹æ³•ã€å•ä¾‹ã€è§‚å¯Ÿè€…ç­‰è®¾è®¡æ¨¡å¼ã€‚</li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/http">http</a><a class="margin-horiz--sm" href="/zh/blog/tags/register-center">register center</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/RegisterCenter-SourceCode-Analysis-Http-Register.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æœ¬æ–‡æ¡£</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/Plugin-SourceCode-Analysis-Dubbo-Plugin"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Dubboæ’ä»¶æºç åˆ†æ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/SPI-SourceCode-Analysis-SPI"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">SPIè®¾è®¡å®ç°æºç åˆ†æ Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-æ³¨å†Œä¸­å¿ƒåŸç†" class="table-of-contents__link">1. æ³¨å†Œä¸­å¿ƒåŸç†</a></li><li><a href="#2-å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹" class="table-of-contents__link">2. å®¢æˆ·ç«¯æ³¨å†Œæµç¨‹</a></li><li><a href="#3-æœåŠ¡ç«¯æ³¨å†Œæµç¨‹" class="table-of-contents__link">3. æœåŠ¡ç«¯æ³¨å†Œæµç¨‹</a></li><li><a href="#4-æ€»ç»“" class="table-of-contents__link">4. æ€»ç»“</a></li></ul></div></div></div></div></div></div>
<script src="/zh/assets/js/runtime~main.9173d839.js"></script>
<script src="/zh/assets/js/main.92374309.js"></script>
</body>
</html>