<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">McpServer 插件源码分析 | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="McpServer 插件源码分析 | Apache ShenYu"><meta data-react-helmet="true" name="description" content="在 shenyu 网关中，启动该插件，shenyu 将成为一个功能丰富的 mcpServer,"><meta data-react-helmet="true" property="og:description" content="在 shenyu 网关中，启动该插件，shenyu 将成为一个功能丰富的 mcpServer,"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.cc2d0c98.css">
<link rel="preload" href="/zh/assets/js/runtime~main.2072a8f8.js" as="script">
<link rel="preload" href="/zh/assets/js/main.3e76caf5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">下载</a><a class="navbar__item navbar__link" href="/zh/document">文档</a><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">社区</a><a class="navbar__item navbar__link" href="/zh/team">团队</a><a class="navbar__item navbar__link" href="/zh/event">事件</a><a class="navbar__item navbar__link" href="/zh/news">新闻</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a><a class="navbar__item navbar__link" href="/zh/users">用户</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">基金会</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">许可</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">活动</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">安全</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">赞助</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">隐私</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">致谢</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="blogPostTitle_d4p0">McpServer 插件源码分析</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2025-10-22T15:10:50.215Z">2025年10月22日</time> · One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/478320" target="_blank" rel="noopener noreferrer">yusiheng</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>在 shenyu 网关中，启动该插件，shenyu 将成为一个功能丰富的 mcpServer,
你可以通过简单配置来将一个服务作为 tool 注册到 shenyu 网关中，并使用网关提供的扩展功能。</p><blockquote><p>本文基于<code>shenyu-2.7.0.2</code>版本进行源码分析， 在本篇中我将追踪 Shenyu Mcp 插件链路，对 Mcp 插件的 sse 通信方式进行源码分析</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="前言"></a>前言<a class="hash-link" href="#前言" title="Direct link to heading">#</a></h3><blockquote><p>shenyu 网关的 mcp 插件基于 spring-ai-mcp 扩展而来，为了更好的了解 mcp 插件的工作原理
，我将简单介绍 mcp 官方提供的 jdk 中各个 java 类是如何协同运作的</p></blockquote><p>我想先简单介绍三个 Mcp 官方提供的 java 类</p><blockquote><ol><li><code>McpServer</code></li></ol><p>该类负责管理，tool，Resource，promote 等资源</p><ol start="2"><li><code>TransportProvider</code></li></ol><p>根据客户端和服务端之间通信协议，提供之相对应的通讯方法</p><ol start="3"><li><code>Session</code></li></ol><p>处理请求数据、响应数据和通知数据，提供一些基本方法和其对应的处理器，查询工具，调用工具都在此处执行</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-服务注册"></a>1. 服务注册<a class="hash-link" href="#1-服务注册" title="Direct link to heading">#</a></h3><p>在 shenyu admin 的 McpServer 中插件填写 endpoint 和 tool 信息后，这些信息将自动注册到 shenyu bootstrap 中，
数据同步源码可以参考官网<a href="https://shenyu.incubator.apache.org/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync" target="_blank" rel="noopener noreferrer">websocket数据同步</a></p><p>shenyu bootstrap 将在 <code>McpServerPluginDataHandler</code> 的 <code>handler()</code> 方法中接收到 admin 同步来的数据。</p><p><code>handlerSelector()</code> 方法接收 url 数据创建 McpServer</p><p><code>handlerRule()</code> 方法接收 tool 信息，注册 tool</p><p>这两个方法共同组成了 Shenyu Mcp 插件的服务注册部分，下面我将对这个两个方法，详细展开分析</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11-transportmcpserver注册"></a>1.1 Transport，McpServer注册<a class="hash-link" href="#11-transportmcpserver注册" title="Direct link to heading">#</a></h4><p>我们先来分析 <code>handlerSelector()</code> 方法，也就是 McpServer 的注册</p><ul><li><code>handlerSelector()</code> 方法 工作内容如下</li></ul><ol><li>捕捉用户在 Selector 上的填写的 url，这个 url 将作为一个 key 存储 McpServer TransportProvider 等信息</li><li>序列化创建 <code>ShenyuMcpServer</code>，<code>ShenyuMcpServer</code> 将 SelectorId 和这些 url 也就是这些 key 绑定，以此来实现 selectorId 和 key 的绑定。</li></ol><blockquote><p>注意 <code>ShenyuMcpServer</code> 是 Shenyu 用于绑定 SelectorId 和 url 的对象，和 <code>McpServer</code> 没有继承关系，功能也完全不同</p></blockquote><ol start="3"><li>调用 <code>ShenyuMcpServerManager</code> 的 <code>getOrCreateMcpServerTransport()</code> 方法注册 McpServer TransportProvider</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerSelector(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取URI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String uri = selectorData.getConditionList().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(condition -&gt; Constants.URI.equals(condition.getParamType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(ConditionData::getParamValue)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .findFirst()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建McpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuMcpServer shenyuMcpServer = GsonUtils.getInstance().fromJson(Objects.isNull(selectorData.getHandle()) ? DEFAULT_MESSAGE_ENDPOINT : selectorData.getHandle(), ShenyuMcpServer.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuMcpServer.setPath(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 缓存shenyuMcpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        CACHED_SERVER.get().cachedHandle(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorData.getId(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                shenyuMcpServer);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String messageEndpoint = shenyuMcpServer.getMessageEndpoint();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 尝试获取或者注册transportProvider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        shenyuMcpServerManager.getOrCreateMcpServerTransport(uri, messageEndpoint);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p><code>ShenyuMcpServerManager</code> 该类是 ShenYu 中 McpServer 的管理中心，不仅储存了 <code>McpAsyncServer</code> <code>CompositeTransportProvider</code> 等内容，注册 Transport 和 McpServer
的方法也在其中</p><ul><li><code>getOrCreateMcpServerTransport()</code> 方法工作内容具体如下</li></ul></blockquote><ol><li>处理传递来的 url 去除/streamablehttp 以及 /message后缀 使其恢复为原始的 url</li><li>尝试获取 <code>CompositeTransportProvider</code> 对象，该对象是 Transport 的复合对象，包含了多种协议对应的 Transport</li><li>如果没有获取到，则调用 <code>createSseTransport()</code> 方法创建 <code>CompositeTransportProvider</code> 对象</li><li>创建 <code>McpAsyncServer</code> 对象，保存 Transport 对象到 Map 中，将 Transport 注册到 <code>McpAsyncServer</code> 中</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuMcpServerManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuSseServerTransportProvider getOrCreateMcpServerTransport(final String uri, final String messageEndPoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 去除/streamablehttp 以及 /message后缀</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String normalizedPath = processPath(uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getOrCreateTransport(normalizedPath, SSE_PROTOCOL,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                () -&gt; createSseTransport(normalizedPath, messageEndPoint));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; T getOrCreateTransport(final String normalizedPath, final String protocol,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final java.util.function.Supplier&lt;T&gt; transportFactory) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取复合Transport实例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        CompositeTransportProvider compositeTransport = getOrCreateCompositeTransport(normalizedPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        T transport = switch (protocol) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case SSE_PROTOCOL -&gt; (T) compositeTransport.getSseTransport();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case STREAMABLE_HTTP_PROTOCOL -&gt; (T) compositeTransport.getStreamableHttpTransport();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default -&gt; null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果缓存中没有该实例，则需要重新创建</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(transport)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 调用createSseTransport()方法，创建一个新的transport并存储</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            transport = transportFactory.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 创建McpAsyncServer，并注册transport</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            addTransportToSharedServer(normalizedPath, protocol, transport);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return transport;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="111-transport注册"></a>1.1.1 Transport注册<a class="hash-link" href="#111-transport注册" title="Direct link to heading">#</a></h5><ul><li><code>createSseTransport()</code> 方法<blockquote><p>该方法在 <code>getOrCreateMcpServerTransport()</code> 方法被调用，用于创建 Transport</p></blockquote></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuMcpServerManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuSseServerTransportProvider createSseTransport(final String normalizedPath, final String messageEndPoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String messageEndpoint = normalizedPath + messageEndPoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSseServerTransportProvider transportProvider = ShenyuSseServerTransportProvider.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .objectMapper(objectMapper)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sseEndpoint(normalizedPath)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .messageEndpoint(messageEndpoint)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 向Manager的routeMap中注册transportProvider的两个函数</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerRoutes(normalizedPath, messageEndpoint, transportProvider::handleSseConnection, transportProvider::handleMessage);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return transportProvider;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="112-mcpserver注册"></a>1.1.2 mcpServer注册<a class="hash-link" href="#112-mcpserver注册" title="Direct link to heading">#</a></h5><ul><li><code>addTransportToSharedServer()</code> 方法<blockquote><p>该方法在 <code>getOrCreateMcpServerTransport()</code> 方法被调用，用于创建 McpServer 并保存</p></blockquote></li></ul><p>该方法创建了一个新的 McpServer并存储到 <code>sharedServerMap</code> 中，并将上一步得到的 TransportProvider 存入 <code>compositeTransportMap</code> 中</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuMcpServerManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void addTransportToSharedServer(final String normalizedPath, final String protocol, final Object transportProvider) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取或者创建并注册 McpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        getOrCreateSharedServer(normalizedPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将新增的传输协议存进compositeTransportMap中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        compositeTransport.addTransport(protocol, transportProvider);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private McpAsyncServer getOrCreateSharedServer(final String normalizedPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sharedServerMap.computeIfAbsent(normalizedPath, path -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取传输协议</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            CompositeTransportProvider compositeTransport = getOrCreateCompositeTransport(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 选择Server拥有的能力</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            var capabilities = McpSchema.ServerCapabilities.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .tools(true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .logging()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 创建McpServer并存储</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            McpAsyncServer server = McpServer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .async(compositeTransport)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .serverInfo(&quot;MCP Shenyu Server (Multi-Protocol)&quot;, &quot;1.0.0&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .capabilities(capabilities)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .tools(Lists.newArrayList())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-tools注册"></a>1.2 Tools注册<a class="hash-link" href="#12-tools注册" title="Direct link to heading">#</a></h4><ul><li><code>handlerRule()</code> 方法 工作内容如下</li></ul><ol><li>捕捉用户在 Tool 上的填写的 tool 配置信息，这些信息将全部用于 tool 的构建</li><li>序列化创建 <code>ShenyuMcpServerTool</code> 获取 tool 信息</li></ol><blockquote><p>注意 <code>ShenyuMcpServerTool</code> 也是 Shenyu 存储 tool 信息的工具，和 <code>McpServerTool</code> 没有继承关系</p></blockquote><ol start="3"><li>调用 <code>addTool()</code> 方法， 利用该 tool 信息创建 tool，并根据 SelectorId 将 tool 注册到与之匹配的 McpServer 中</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handlerRule(final RuleData ruleData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(ruleData.getHandle()).ifPresent(s -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 序列化一个新的 ShenyuMcpServerTool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuMcpServerTool mcpServerTool = GsonUtils.getInstance().fromJson(s, ShenyuMcpServerTool.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 缓存mcpServerTool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            CACHED_TOOL.get().cachedHandle(CacheKeyUtils.INST.getKey(ruleData), mcpServerTool);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取并构建 mcp schema</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;McpServerToolParameter&gt; parameters = mcpServerTool.getParameters();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String inputSchema = JsonSchemaUtil.createParameterSchema(parameters);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ShenyuMcpServer server = CACHED_SERVER.get().obtainHandle(ruleData.getSelectorId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.nonNull(server)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 向Manager的sharedServerMap中存储Tool信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                shenyuMcpServerManager.addTool(server.getPath(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        StringUtils.isBlank(mcpServerTool.getName()) ? ruleData.getName()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                : mcpServerTool.getName(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mcpServerTool.getDescription(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        mcpServerTool.getRequestConfig(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        inputSchema);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>addTool()</code>方法<blockquote><p>该方法被 <code>handlerRule()</code> 方法调用，用于新增工具</p></blockquote></li></ul><p>该方法做了下述工作</p><ol><li><p>将上一步传来的 tool 信息转换为 <code>shenyuToolDefinition</code> 对象</p></li><li><p>利用转换来的 <code>shenyuToolDefinition</code> 对象创建 <code>ShenyuToolCallback</code> 对象</p><blockquote><p><code>ShenyuToolCallback</code> 重写了 <code>ToolCallBack</code> 的 <code>call()</code> 方法，并将该 <code>call()</code> 方法注册到了 <code>AsyncToolSpecification</code> 中，
此后调用 tool 的 <code>call()</code> 方法，则实际会调用这个重写的 <code>call()</code> 方法</p></blockquote></li><li><p>将 <code>ShenyuToolCallback</code> 转换为 <code>AsyncToolSpecification</code> 并注册到相关的 mcpServer 中</p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPluginDataHandler implements PluginDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void addTool(final String serverPath, final String name, final String description,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        final String requestTemplate, final String inputSchema) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String normalizedPath = normalizeServerPath(serverPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建Definition对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ToolDefinition shenyuToolDefinition = ShenyuToolDefinition.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .name(name)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .description(description)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .requestConfig(requestTemplate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .inputSchema(inputSchema)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuToolCallback shenyuToolCallback = new ShenyuToolCallback(shenyuToolDefinition);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取到先前注册的 McpServer， 并向其中注册Tool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        McpAsyncServer sharedServer = sharedServerMap.get(normalizedPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AsyncToolSpecification asyncToolSpecification : McpToolUtils.toAsyncToolSpecifications(shenyuToolCallback)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            sharedServer.addTool(asyncToolSpecification).block();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>到此为止，服务注册分析完毕</p><p>服务注册一图览
<img src="/zh/assets/images/Mcp-server-register-zh-87a3e3bf2133de216e36e9609dcd5aad.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-插件调用"></a>2. 插件调用<a class="hash-link" href="#2-插件调用" title="Direct link to heading">#</a></h3><p>客户端先后会发送后缀为 <code>/sse</code> 和 <code>/message</code> 的两种消息，这两种消息都会被 <code>Shenyu McpServer plugin</code> 捕捉，<code>Shenyu McpServer plugin</code>
会对 <code>/sse</code> 消息和 <code>/message</code> 消息做不同处理。收到 <code>/sse</code> 消息时 plugin 会创建 session 对象并保存，最后返回 session id
供 message 消息使用。收到 <code>/message</code> 消息时，会根据 <code>/message</code> 消息携带的 method 信息，选择执行的方法
如：获取工作列表，工具调用，获取资源列表等等</p><ul><li><code>doExecute()</code> 方法 工作内容如下</li></ul><ol><li>路径匹配，判断 mcp plugin 是否注册该路径</li><li>调用 <code>routeByProtocol()</code> 方法，根据请求协议选择合适的处理方案</li></ol><blockquote><p>本篇是对 sse 请求方式的解析，因此接着进入 <code>handleSseRequest()</code> 方法</p></blockquote><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String uri = exchange.getRequest().getURI().getRawPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断 Mcp 插件是否注册了该路由规则，没有则不执行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!shenyuMcpServerManager.canRoute(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServerRequest request = ServerRequest.create(exchange, messageReaders);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 根据 uri 判断路由协议，选择对应的处理方案</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return routeByProtocol(exchange, chain, request, selector, uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; routeByProtocol(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final ServerRequest request,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final String uri) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isStreamableHttpProtocol(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleStreamableHttpRequest(exchange, chain, request, uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (isSseProtocol(uri)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 处理sse请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleSseRequest(exchange, chain, request, selector, uri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>handlerSseRequest()</code> 方法</p><blockquote><p>该方法由 <code>routeByProtocol()</code> 方法调用，根据请求后缀判断客户端是要创建 session 还是调用工具</p></blockquote><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; handleSseRequest(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final ServerRequest request,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final SelectorData selector,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        final String uri) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuMcpServer server = McpServerPluginDataHandler.CACHED_SERVER.get().obtainHandle(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String messageEndpoint = server.getMessageEndpoint();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取传输者</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuSseServerTransportProvider transportProvider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                = shenyuMcpServerManager.getOrCreateMcpServerTransport(uri, messageEndpoint);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 根据请求的后缀判断是 sse 连接请求还是 message 调用请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (uri.endsWith(messageEndpoint)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            setupSessionContext(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleMessageEndpoint(exchange, transportProvider, request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handleSseEndpoint(exchange, transportProvider, request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-客户端发送-sse-请求"></a>2.1 客户端发送 sse 请求<a class="hash-link" href="#21-客户端发送-sse-请求" title="Direct link to heading">#</a></h4><blockquote><p>如果我们客户端发送的是后缀为 <code>/sse</code> 的请求，那么将会执行 <code>handleSseEndpoint()</code> 方法</p></blockquote><ul><li><code>handleSseEndpoint()</code> 方法主要做了如下工作</li></ul><ol><li>配置 sse 请求头</li><li>调用 <code>ShenyuSseServerTransportProvider</code> 的 <code>createSseFlux()</code> 创建 sse 流</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; handleSseEndpoint(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         final ShenyuSseServerTransportProvider transportProvider,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 配置 sse 请求头</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configureSseHeaders(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建 sse 流</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return exchange.getResponse()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .writeWith(transportProvider</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .createSseFlux(request));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>createSseFlux()</code> 方法<blockquote><p>该方法被 <code>handleSseEndpoint()</code>调用 主要用于创建并保存 session</p></blockquote></li></ul><ol><li>创建 session ，创建 session 的工厂在创建 session 时会将一系列 handler 注册到 session 中，这些 handler 是真正执行
callTool 的对象</li><li>将 session 保存，session复用</li><li>将 session id 作为 endpoint 的请求参数返回给客户端，在调用 message 方法时会使用该 endpoint</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSseServerTransportProvider implements McpServerTransportProvider {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Flux&lt;ServerSentEvent&lt;?&gt;&gt; createSseFlux(final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Flux.&lt;ServerSentEvent&lt;?&gt;&gt;create(sink -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    WebFluxMcpSessionTransport sessionTransport = new WebFluxMcpSessionTransport(sink);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 创建 McpServerSession 并暂存插件链信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    McpServerSession session = sessionFactory.create(sessionTransport);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String sessionId = session.getId();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sessions.put(sessionId, session);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将 session id等信息传递回客户端</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String endpointUrl = this.baseUrl + this.messageEndpoint + &quot;?sessionId=&quot; + sessionId;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ServerSentEvent&lt;String&gt; endpointEvent = ServerSentEvent.&lt;String&gt;builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .event(ENDPOINT_EVENT_TYPE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .data(endpointUrl)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).doOnSubscribe(subscription -&gt; LOGGER.info(&quot;SSE Flux subscribed&quot;))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .doOnRequest(n -&gt; LOGGER.debug(&quot;SSE Flux requested {} items&quot;, n));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-客户端发送-message-请求"></a>2.2 客户端发送 message 请求<a class="hash-link" href="#22-客户端发送-message-请求" title="Direct link to heading">#</a></h4><blockquote><p>如果我们客户端发送的是后缀为 <code>/message</code> 的请求，那么将会执行 把当前 <code>ShenyuPluginChain</code> 信息存入 session 中，并调用 <code>handleMessageEndpoint()</code> 方法，
后续工具调用时会继续执行该插件链，因此 mcp plugin 后的插件会对进入 tool 的请求造成影响</p></blockquote><ul><li><code>handleMessageEndpoint()</code> 方法，调用 <code>ShenyuSseServerTransportProvider</code> 的 <code>handleMessageEndpoint()</code> 方法</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">if (uri.endsWith(messageEndpoint)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       setupSessionContext(exchange, chain);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       return handleMessageEndpoint(exchange, transportProvider, request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class McpServerPlugin extends AbstractShenyuPlugin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Mono&lt;Void&gt; handleMessageEndpoint(final ServerWebExchange exchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ShenyuSseServerTransportProvider transportProvider,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理message请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return transportProvider.handleMessageEndpoint(request)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(result -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return exchange.getResponse()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .writeWith(Mono.just(exchange.getResponse().bufferFactory().wrap(responseBody.getBytes())));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>handleMessageEndpoint()</code> 方法<blockquote><p>该方法由 <code>McpServerPlugin.handleMessageEndpoint()</code> 调用，将请求交给 session 处理</p></blockquote></li></ul><p>session 的 <code>handler()</code> 方法会对 message 的不同，而进行对应的操作
例如 ： 当 message 中 method 是 &quot;tools/call&quot; 时，则会使用工具调用的 handler() 执行 <code>call()</code> 方法调用工具
相关源码在此不过多赘述</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuSseServerTransportProvider implements McpServerTransportProvider {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;MessageHandlingResult&gt; handleMessageEndpoint(final ServerRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取到session</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sessionId = request.queryParam(&quot;sessionId&quot;).get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        McpServerSession session = sessions.get(sessionId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return request.bodyToMono(String.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(body -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    McpSchema.JSONRPCMessage message = McpSchema.deserializeJsonRpcMessage(objectMapper, body);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return session.handle(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>至此 <code>Shenyu Mcp Plugin</code> 服务调用源码分析完毕</p><p>流程图一览
<img src="/zh/assets/images/Mcp-server-execute-zh-9cf2daaf68b9189ce0d70536f72f73b8.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-工具调用"></a>3. 工具调用<a class="hash-link" href="#3-工具调用" title="Direct link to heading">#</a></h3><blockquote><p>如果客户端传递的消息是调用工具的消息，那么 session 将使用工具调用的 handler() 并执行 tool 的 <code>call()</code> 方法，
在服务注册中，我们说明了 tool 在被调用时，实际执行的是 <code>ShenyuToolCallback()</code> 的 <code>call()</code> 方法</p></blockquote><p>因此执行工具调用时会执行以下方法</p><ul><li><code>call()</code> 主要工作内容如下</li></ul><ol><li>获取 session id</li><li>获取 <code>requestTemplate</code> 即 shenyu 提供的额外功能的配置信息</li><li>获取上一步暂存的 shenyu 插件链，并将工具调用的信息交给插件链继续执行</li><li>异步等待工具响应</li></ol><p>插件链执行完成后，会将调用 tool 请求真正的发送到 tool 所在的服务之中</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuToolCallback implements ToolCallback {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NonNull</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String call(@NonNull final String input, final ToolContext toolContext) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 从 mcp 请求中提取 sessionId</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final McpSyncServerExchange mcpExchange = extractMcpExchange(toolContext);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String sessionId = extractSessionId(mcpExchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 提取requestTemplate信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String configStr = extractRequestConfig(shenyuTool);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 利用sessionId 获取到先前暂存的插件执行链</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServerWebExchange originExchange = getOriginExchange(sessionId);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ShenyuPluginChain chain = getPluginChain(originExchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行工具调用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return executeToolCall(originExchange, chain, sessionId, configStr, input);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String executeToolCall(final ServerWebExchange originExchange,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final ShenyuPluginChain chain,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final String sessionId,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final String configStr,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   final String input) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CompletableFuture&lt;String&gt; responseFuture = new CompletableFuture&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ServerWebExchange decoratedExchange = buildDecoratedExchange(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                originExchange, responseFuture, sessionId, configStr, input);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行插件链，调用实际工具</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        chain.execute(decoratedExchange)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .subscribe();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 等待响应</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String result = responseFuture.get(DEFAULT_TIMEOUT_SECONDS, TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>至此Shenyu MCP Plugin 工具调用分析完毕</p><p><img src="data:image/png;base64,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"></p><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-小结"></a>4. 小结<a class="hash-link" href="#4-小结" title="Direct link to heading">#</a></h3><p>本文源码分析从 mcp 服务注册开始，到 mcp 插件的服务调用，再到 tool 的调用。
mcpServer 插件让 shenyu 成为一个功能强大，集中管理的 mcpServer。</p><hr></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/plugin">plugin</a><a class="margin-horiz--sm" href="/zh/blog/tags/mcp">mcp</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Plugin-SourceCode-Analysis-Mcp-Server-Plugin.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑本文档</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/Start-SourceCode-Analysis-Start-Demo"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Apache ShenYu 启动示例</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Param-Mapping插件源码分析 »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link">前言</a></li><li><a href="#1-服务注册" class="table-of-contents__link">1. 服务注册</a></li><li><a href="#2-插件调用" class="table-of-contents__link">2. 插件调用</a></li><li><a href="#3-工具调用" class="table-of-contents__link">3. 工具调用</a></li><li><a href="#4-小结" class="table-of-contents__link">4. 小结</a></li></ul></div></div></div></div></div></div>
<script src="/zh/assets/js/runtime~main.2072a8f8.js"></script>
<script src="/zh/assets/js/main.3e76caf5.js"></script>
</body>
</html>