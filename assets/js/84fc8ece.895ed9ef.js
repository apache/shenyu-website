"use strict";(globalThis.webpackChunkshenyu_website=globalThis.webpackChunkshenyu_website||[]).push([[15219],{28453(e,t,n){n.d(t,{R:()=>l,x:()=>s});var a=n(96540);const o={},i=a.createContext(o);function l(e){const t=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),a.createElement(i.Provider,{value:t},e.children)}},58619(e){e.exports=JSON.parse('{"permalink":"/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin","editUrl":"https://github.com/apache/shenyu-website/edit/main/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin.md","source":"@site/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin.md","title":"Code Analysis For Context-Path Plugin","description":"Before starting, you can refer to this article to start the gateway","date":"2025-12-17T02:20:20.000Z","tags":[{"inline":true,"label":"Context-Path","permalink":"/blog/tags/context-path"},{"inline":true,"label":"Apache ShenYu","permalink":"/blog/tags/apache-shen-yu"}],"readingTime":2.02,"hasTruncateMarker":false,"authors":[{"name":"Kunshuai Zhu","title":"Apache ShenYu Contributor","url":"https://github.com/JooKS-me","imageURL":"https://avatars1.githubusercontent.com/u/62384022?v=4","key":null,"page":null}],"frontMatter":{"title":"Code Analysis For Context-Path Plugin","author":"Kunshuai Zhu","author_title":"Apache ShenYu Contributor","author_url":"https://github.com/JooKS-me","author_image_url":"https://avatars1.githubusercontent.com/u/62384022?v=4","tags":["Context-Path","Apache ShenYu"]},"unlisted":false,"prevItem":{"title":"Extension plugin loading logic","permalink":"/blog/Loader-SourceCode-Analysis-ExtLoader"},"nextItem":{"title":"Code Analysis For Divide Plugin","permalink":"/blog/Plugin-SourceCode-Analysis-Divide-Plugin"}}')},93355(e,t,n){n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>s,default:()=>d,frontMatter:()=>l,metadata:()=>a,toc:()=>r});var a=n(58619),o=n(74848),i=n(28453);const l={title:"Code Analysis For Context-Path Plugin",author:"Kunshuai Zhu",author_title:"Apache ShenYu Contributor",author_url:"https://github.com/JooKS-me",author_image_url:"https://avatars1.githubusercontent.com/u/62384022?v=4",tags:["Context-Path","Apache ShenYu"]},s=void 0,h={authorsImageUrls:[void 0]},r=[{value:"Body",id:"body",level:3}];function c(e){const t={a:"a",blockquote:"blockquote",code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.blockquote,{children:["\n",(0,o.jsxs)(t.p,{children:["Before starting, you can refer to ",(0,o.jsx)(t.a,{href:"./start-demo",children:"this article"})," to start the gateway"]}),"\n"]}),"\n",(0,o.jsx)(t.h3,{id:"body",children:"Body"}),"\n",(0,o.jsxs)(t.p,{children:["First, look at the ",(0,o.jsx)(t.code,{children:"ContextPathPlugin#doExecute"})," method, which is the core of this plugin."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:"protected Mono<Void> doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {\n    ...\n    // 1. get the contextMappingHandle from the JVM cache\n    ContextMappingHandle contextMappingHandle = ContextPathPluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));\n    ...\n    // 2. set shenyu context according to contextMappingHandle\n    buildContextPath(shenyuContext, contextMappingHandle);\n    return chain.execute(exchange);\n}\n"})}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Get the ",(0,o.jsx)(t.code,{children:"contextMappingHandle"})," from the JVM cache"]}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.code,{children:"contextMappingHandle"})," here is an instance of the ",(0,o.jsx)(t.code,{children:"ContextMappingHandle"})," class, which has two member variables: ",(0,o.jsx)(t.code,{children:"contextPath"})," and ",(0,o.jsx)(t.code,{children:"addPrefix"})]}),"\n",(0,o.jsx)(t.p,{children:"These two variables have appeared in the Rules form in the Admin before, and they are updated when the data is synchronized."}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsx)(t.p,{children:"Set shenyu context according to contextMappingHandle"}),"\n",(0,o.jsxs)(t.p,{children:["Below is the source code of the ",(0,o.jsx)(t.code,{children:"ContextPathPlugin#buildContextPath"})," method"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:'private void buildContextPath(final ShenyuContext context, final ContextMappingHandle handle) {\n    String realURI = "";\n    // 1. set the context path of shenyu, remove the prefix of the real URI according to the length of the contextPath\n    if (StringUtils.isNoneBlank(handle.getContextPath())) {\n        context.setContextPath(handle.getContextPath());\n        context.setModule(handle.getContextPath());\n        realURI = context.getPath().substring(handle.getContextPath().length());\n    }\n    // add prefix\n    if (StringUtils.isNoneBlank(handle.getAddPrefix())) {\n        if (StringUtils.isNotBlank(realURI)) {\n            realURI = handle.getAddPrefix() + realURI;\n        } else {\n            realURI = handle.getAddPrefix() + context.getPath();\n        }\n    }\n    context.setRealUrl(realURI);\n}\n'})}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Set the context path of shenyu, ",(0,o.jsx)(t.strong,{children:"remove the prefix of the real URI according to the length of the contextPath"})]}),"\n",(0,o.jsxs)(t.p,{children:["You may be wondering whether ",(0,o.jsx)(t.strong,{children:'there is a problem with the so-called "according to the length of the contextPath" here'}),"?"]}),"\n",(0,o.jsx)(t.p,{children:"In fact, such a judgment is not a problem, because the request will be processed by the plugin only after it is matched by the Selector and Rules. Therefore, under the premise of setting up Selector and Rules, it is completely possible to meet the needs of converting a specific contextPath."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["Then, the ",(0,o.jsx)(t.code,{children:"ContextPathPlugin"})," class has a more important method ",(0,o.jsx)(t.code,{children:"skip"}),", part of the code is shown below. We can find: ",(0,o.jsx)(t.strong,{children:"If it is a call to the RPC service, the context_path plugin will be skipped directly."})]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:"public Boolean skip(final ServerWebExchange exchange) {\n    ...\n    return Objects.equals(rpcType, RpcTypeEnum.DUBBO.getName())\n            || Objects.equals(rpcType, RpcTypeEnum.GRPC.getName())\n            || Objects.equals(rpcType, RpcTypeEnum.TARS.getName())\n            || Objects.equals(rpcType, RpcTypeEnum.MOTAN.getName())\n            || Objects.equals(rpcType, RpcTypeEnum.SOFA.getName());\n}\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Finally, the context-path plugin has another class ",(0,o.jsx)(t.code,{children:"ContextPathPluginDataHandler"}),". The function of this class is to subscribe to the data of the plug-in. When the plugin configuration is modified, deleted, or added, the data is modified, deleted, or added to the JVM cache."]})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}}}]);